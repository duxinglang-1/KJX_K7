/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE.
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/
/*****************************************************************************
 *
 * Filename:
 * ---------
 *
 *
 * Project:
 * --------
 *  MAUI
 *
 * Description:
 * ------------
 *
 *
 * Author:
 * -------
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#define _FMGR_INTERNAL_SOURCE_C_
/****************************************************************************
* Include Files                                                                
*****************************************************************************/
#include "MMI_features.h"
#if defined(__MMI_FILE_MANAGER__)
#include "FileMgrSrvIProt.h"
#include "FileMgrGProt.h"
#include "FileMgrProt.h"
#include "FileMgrInstance.h"
#include "FileMgrGUI.h"
#include "FileMgrFSData.h"
#include "FileMgrMain.h"

#include "FileMgrResDef.h"

#include "FileMgrCuiGProt.h"

#ifdef __DRM_SUPPORT__                
#include "RightsMgrGProt.h"
#endif

/* For audio preview function */
#include "ProfilesSrvGprot.h"
#include "mdi_audio.h"  
/* For audio preview function - end*/

#include "FSEditorCuiGProt.h"

#ifdef __FMGR_USE_MENU_CUI__
#include "MenuCuiGProt.h"
#endif

#include "kal_general_types.h"
#include "MMIDataType.h"
#include "mmi_frm_scenario_gprot.h"
#include "mmi_frm_events_gprot.h"
#include "mmi_rp_app_usbmmi_def.h"
#include "mmi_frm_history_gprot.h"
#include "MMI_common_app_trc.h"
#include "DebugInitDef_Int.h"
#include "kal_trace.h"
#include "mmi_common_app_trc.h"
#include "string.h"
#include "fs_errcode.h"
#include "Unicodexdcl.h"
#include "fs_type.h"
#include "FileMgrSrvGProt.h"
#include "wgui_categories_util.h"
#include "GlobalResDef.h"
#include "mmi_rp_srv_filemanager_def.h"
#include "mmi_rp_app_filemanager_def.h"
#include "mmi_rp_file_type_def.h"
#include "FileMgrType.h"
#include "kal_public_api.h"
#include "device.h"
#include "TimerEvents.h"
#include "mmi_frm_timer_gprot.h"
#include "wgui_categories_fmgr.h"
#include "CustMenuRes.h"
#include "fmt_def.h"
#include "fs_func.h"
#include "gui_typedef.h"
#include "custom_mmi_default_value.h"
#include "GlobalConstants.h"
#include "mmi_frm_mem_gprot.h"
#include "AlertScreen.h"
#include "CustDataRes.h"
#include "gui_data_types.h"
#include "ImeGprot.h"
#include "wgui_categories_inputs.h"

#include "USBSrvGprot.h"

/****************************************************************************
* Define
*****************************************************************************/

/****************************************************************************
* Global Variable
*****************************************************************************/

/****************************************************************************
* Static Variable
*****************************************************************************/

MMI_BOOL g_fmgr_cui_audio_state = MMI_FALSE;

#ifdef __FMGR_STORAGE_SELECTOR_CUI__
#define T_STORAGE_SELECTOR

static mmi_ret fmgr_storage_selector_key_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type);
static void fmgr_storage_selector_highlight_hdlr(mmi_fmgr_instance_struct *instance, S32 idx);
static MMI_BOOL fmgr_storage_selector_error_hdlr(mmi_fmgr_instance_struct *instance, S32 error);

const mmi_fmgri_instance_callback_table_struct cui_storage_selector_handler_table = 
{
    fmgr_storage_selector_key_event_hdlr,
    NULL,
    fmgr_storage_selector_highlight_hdlr,
    fmgr_storage_selector_error_hdlr,
#ifdef __FMGR_HYPERLINK_SUPPORT__
    NULL,
#endif /* __FMGR_HYPERLINK_SUPPORT__ */
    NULL,
    NULL
};
#endif

#define T_FILE_SELECTOR
static mmi_ret fmgr_file_selector_key_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type);
static void fmgr_file_selector_notify_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type, U32 data);
static void fmgr_file_selector_highlight_hdlr(mmi_fmgr_instance_struct *instance, S32 idx);
static MMI_BOOL fmgr_file_selector_error_hdlr(mmi_fmgr_instance_struct *instance, S32 error);

const mmi_fmgri_instance_callback_table_struct cui_file_selector_handler_table = 
{
    fmgr_file_selector_key_event_hdlr,
    fmgr_file_selector_notify_event_hdlr,
    fmgr_file_selector_highlight_hdlr,
    fmgr_file_selector_error_hdlr,
#ifdef __FMGR_HYPERLINK_SUPPORT__
    NULL,
#endif /* __FMGR_HYPERLINK_SUPPORT__ */
    NULL,
    NULL
};

#define T_FOLDER_SELECTOR
static mmi_ret fmgr_folder_selector_key_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type);
static void fmgr_folder_selector_notify_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type, U32 data);
static void fmgr_folder_selector_highlight_hdlr(mmi_fmgr_instance_struct *instance, S32 idx);
static MMI_BOOL fmgr_folder_selector_error_hdlr(mmi_fmgr_instance_struct *instance, S32 error);
static S32  fmgr_folder_selector_command_hdlr(mmi_fmgr_instance_struct *instance, S32 cmd, S32 para, void* data);
static mmi_ret fmgr_folder_selector_event_proc_handler(mmi_fmgr_instance_struct *instance, mmi_event_struct *param);

const mmi_fmgri_instance_callback_table_struct cui_folder_selector_handler_table = 
{
    fmgr_folder_selector_key_event_hdlr,
    fmgr_folder_selector_notify_event_hdlr,
    fmgr_folder_selector_highlight_hdlr,
    fmgr_folder_selector_error_hdlr,
#ifdef __FMGR_HYPERLINK_SUPPORT__
    NULL,
#endif /* __FMGR_HYPERLINK_SUPPORT__ */
    fmgr_folder_selector_command_hdlr,
    fmgr_folder_selector_event_proc_handler 
};

#define T_FOLDER_BROWSER

static mmi_ret fmgr_folder_browser_key_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type);
static void fmgr_folder_browser_notify_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type, U32 data);
static void fmgr_folder_browser_highlight_hdlr(mmi_fmgr_instance_struct *instance, S32 idx);
static MMI_BOOL fmgr_folder_browser_error_hdlr(mmi_fmgr_instance_struct *instance, S32 error);
static mmi_ret fmgr_folder_browser_event_proc_handler(mmi_fmgr_instance_struct *instance, mmi_event_struct *param);
static S32  fmgr_folder_browser_command_hdlr(mmi_fmgr_instance_struct *instance, S32 cmd, S32 para, void* data);

const mmi_fmgri_instance_callback_table_struct cui_folder_browser_handler_table = 
{
    fmgr_folder_browser_key_event_hdlr,
    fmgr_folder_browser_notify_event_hdlr,
    fmgr_folder_browser_highlight_hdlr,
    fmgr_folder_browser_error_hdlr,
#ifdef __FMGR_HYPERLINK_SUPPORT__
    NULL,
#endif /* __FMGR_HYPERLINK_SUPPORT__ */
    fmgr_folder_browser_command_hdlr,
    fmgr_folder_browser_event_proc_handler
};

#define T_FILE_OPTION

#ifdef __FMGR_FILE_OPTION_CUI__
static void fmgr_file_option_notify_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type, U32 data);

const mmi_fmgri_instance_callback_table_struct cui_file_option_handler_table = 
{
    NULL,
    fmgr_file_option_notify_event_hdlr,
    NULL,
    NULL,
#ifdef __FMGR_HYPERLINK_SUPPORT__
    NULL,
#endif /* __FMGR_HYPERLINK_SUPPORT__ */
    NULL,
    NULL
};
#endif
/****************************************************************************
* Function Forward Declaration
*****************************************************************************/

#define END_OF_FUNCTION_DECLARATION

/****************************************************************************
* Function Body
*****************************************************************************/
#define CUI_COMMON

static MMI_BOOL fmgr_cui_is_in_create_state(mmi_id grp_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_frm_group_get_state(grp_id) & MMI_SCENARIO_STATE_CREATE)
    {
        return MMI_TRUE;
    }
    return MMI_FALSE;
}

static mmi_fmgr_instance_struct* fmgr_cui_basic_check(mmi_id cui_id, mmi_fmgri_type_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Check validation */
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return NULL;
    }

    /* Check for type */
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);
    if (!instance || instance->type != type)
    {
        return NULL;
    }
    return instance;
}

static S32 fmgr_cui_run(mmi_id cui_id, mmi_fmgri_type_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    S32 ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    ret = 0;
    do {
        instance = fmgr_cui_basic_check(cui_id, type);
        if (!instance)
        {
            ret = MMI_FMGR_ERROR_INVALID_PARAM;
            break;
        }

    #ifdef __USB_IN_NORMAL_MODE__
        /* Check if in mass storage mode */
        if (srv_usb_is_in_mass_storage_mode())
        {
            FMGR3_DisplayPopup(GRP_ID_ROOT, STR_GLOBAL_NOT_AVAILABLE_IN_MASS_STORAGE_MODE, MMI_EVENT_FAILURE);
            ret = MMI_FMGR_ERROR_USB_MODE;
            break;
        }
    #endif /* __USB_IN_NORMAL_MODE__ */

        /* Small screen!? */
        if (mmi_is_redrawing_bk_screens())
        {
            ret = MMI_FMGR_ERROR_INVALID_PARAM;
            break;
        }
        
        /* Ok */
        mmi_fmgri_instance_general_entry_explorer(instance, NULL);
        
    } while(0);

    FMGR_TRACE2(TRC_MMI_FMGR_COMMON_2,
        "[MMIFMGR] > %d > %d\n", __LINE__, ret);

    if (ret == MMI_FMGR_ERROR_INVALID_PARAM)
    {
        ret = 0;
    }

    return ret;
}

static void fmgr_cui_close(mmi_id cui_id, mmi_fmgri_type_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    do {
        if (!fmgr_cui_basic_check(cui_id, type))
        {
            ret = MMI_FMGR_ERROR_INVALID_PARAM;
            break;
        }
        
        ret = mmi_frm_group_close(cui_id);
    } while(0);

    FMGR_TRACE2(TRC_MMI_FMGR_COMMON_2,
        "[MMIFMGR] > %d > %d\n", __LINE__, ret);

}

static void fmgr_cui_set_title(mmi_id cui_id, mmi_fmgri_type_enum type, U16 string, U16 icon)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_cui_basic_check(cui_id, type);
    if (!instance)
    {
        return;
    }

    instance->title_icon_id = icon;
    instance->title_str_id = string;
    
    if (!fmgr_cui_is_in_create_state(cui_id))
    {
        mmi_fmgri_instance_general_refresh(instance);
    }
}

static const WCHAR* fmgr_cui_get_folder(mmi_id cui_id, mmi_fmgri_type_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_cui_basic_check(cui_id, type);
    if (!instance)
    {
        return NULL;
    }

    return (WCHAR*)instance->file_path;
}

#ifndef __MMI_ULTRA_SLIM_FILE_MANAGER__
static S32    fmgr_cui_get_selected_filepath_old(mmi_id cui_id, mmi_fmgri_type_enum type, FMGR_FILE_INFO_STRUCT* info, WCHAR* path_buffer, S32 path_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    S32 result;
    FMGR_FILE_INFO_STRUCT file_info;
    fmgr_drive_info_struct *drv_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_cui_basic_check(cui_id, type);
    if(!instance)
        return MMI_FMGR_ERROR_INVALID_PARAM;

    if(!info)
        info = &file_info;

    memset(info, 0, sizeof(FMGR_FILE_INFO_STRUCT));
    if(instance->cur_index < 0)
        return FS_NO_MORE_FILES;

    result = mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, info);

    if(result < 0)
        return result;

    if(path_buffer)
    {
        if(mmi_ucs2cmp(instance->file_path, (S8*)FMGR_PATH_ROOT)==0)
        {
            drv_info = (fmgr_drive_info_struct*)info;
            mmi_ucs2cpy((S8*)path_buffer, (S8*)drv_info->drv_path);
        }
        else
        {
            if(!mmi_fmgri_filepath_compose((S8*)path_buffer, path_size/ENCODING_LENGTH,
                                           instance->file_path, info, (MMI_BOOL)(info->attribute & FS_ATTR_DIR)))
            {
                return FS_PATH_OVER_LEN_ERROR;
            }
        }
    }
    
    return 0;
}
#endif

static S32    fmgr_cui_get_selected_filepath(mmi_id cui_id, mmi_fmgri_type_enum type, srv_fmgr_fileinfo_struct* info, WCHAR* path_buffer, S32 path_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    S32 result;
    FMGR_FILE_INFO_STRUCT fileinfo;
    fmgr_drive_info_struct *drv_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_cui_basic_check(cui_id, type);
    if (!instance)
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }

    memset(&fileinfo, 0, sizeof(FMGR_FILE_INFO_STRUCT));
    if (instance->cur_index < 0)
    {
        return FS_NO_MORE_FILES;
    }
    result = mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, &fileinfo);

    if (result < 0)
    {
        if (result == SRV_FMGR_FILELIST_ERROR_BUSY)
        {
            result = FS_DEVICE_BUSY;
        }
        return result;
    }

    if (path_buffer)
    {
        if (mmi_ucs2cmp(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
        {
            drv_info = (fmgr_drive_info_struct*)&fileinfo;
            mmi_ucs2cpy((S8*)path_buffer, (S8*)drv_info->drv_path);
        }
        else
        {
            if (!mmi_fmgri_filepath_compose((S8*)path_buffer, path_size/ENCODING_LENGTH,
                                           instance->file_path, &fileinfo, (MMI_BOOL)(fileinfo.attribute & FS_ATTR_DIR)))
            {
                return FS_PATH_OVER_LEN_ERROR;
            }
        }
    }

    if (info)
    {
        info->attribute = fileinfo.attribute;
        info->datetime = fileinfo.time;
        info->size = fileinfo.file_size;
        info->type = srv_fmgr_types_get_main_type(&fileinfo.file_type);
    }
    
    return 0;
}

static void   fmgr_cui_set_userdata(mmi_id cui_id, mmi_fmgri_type_enum type, U32 userdata)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_cui_basic_check(cui_id, type);
    if (!instance)
    {
        return;
    }
    instance->user_data = userdata;
}

static U32    fmgr_cui_get_userdata(mmi_id cui_id, mmi_fmgri_type_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_cui_basic_check(cui_id, type);
    if (!instance)
    {
        return 0;
    }

    return instance->user_data;
}

static void   fmgr_cui_set_ui_style(mmi_id cui_id, mmi_fmgri_type_enum type, cui_fmgr_ui_style_enum style)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    fmgr_display_type_enum new_type;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_cui_basic_check(cui_id, type);
    if (!instance)
    {
        return;
    }

    switch (style)
    {
        case CUI_FMGR_UI_STYLE_BANNER_LIST:
            new_type = FMGR_DISPLAY_TYPE_BANNER_LIST;
            break;
        case CUI_FMGR_UI_STYLE_ICON_LIST:
            new_type = FMGR_DISPLAY_TYPE_ICON_LIST;
            break;
        case CUI_FMGR_UI_STYLE_EXPAND_LIST:
            new_type = (fmgr_display_type_enum)FMGRI_DISPLAY_TYPE_EXPAND_LIST;
            break;
        case CUI_FMGR_UI_STYLE_SIMPLE_LIST:
            new_type = FMGR_DISPLAY_TYPE_SIMPLE_LIST;
            break;
        case CUI_FMGR_UI_STYLE_MATRIX:
            new_type = FMGR_DISPLAY_TYPE_MATRIX;
            break;
        default:
            return;
    }

    if (instance->display_type == new_type)
    {
        return;
    }
    instance->display_type = new_type;
    
    if (!fmgr_cui_is_in_create_state(cui_id))
    {
        mmi_fmgri_instance_general_refresh(instance);
    }
}

static MMI_BOOL fmgr_cui_set_option(mmi_id cui_id, mmi_fmgri_type_enum type, U32 option_mask, U32 option_value, MMI_BOOL check_create)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    U32 new_value;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_cui_basic_check(cui_id, type);
    if (!instance)
    {
        return MMI_FALSE;
    }

    /* Option can only set before entry */
    if (check_create && !fmgr_cui_is_in_create_state(cui_id))
    {
        return MMI_FALSE;
    }

    new_value = (instance->flag & ~option_mask) | option_value;
    if (new_value == instance->flag)
    {
        return MMI_FALSE;
    }

    instance->flag = new_value;
    return MMI_TRUE;
}

#define CUI_STORAGE_SELECTOR
#ifdef __FMGR_STORAGE_SELECTOR_CUI__
static void fmgr_storage_selector_callback_app(mmi_fmgr_instance_struct* instance, S32 drv)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id cui_id;
    cui_storage_selector_result_event_struct evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Dead, skip the event */
    if (instance->flag & FMGR_IFLAG_DEAD)
    {
        FMGR_TRACE2(TRC_MMI_FMGR_5C377CEA4AAD41D793471C0965495ADC, 
            "Fmgr > General > Error > id=%d, err=%d\n", instance->id, __LINE__);
        return;
    }
    
    if (drv <= 0)
    {
        instance->flag |= FMGR_IFLAG_DEAD;
    }

    cui_id = mmi_fmgri_instance_get_screen_id(instance->id);

    evt.evt_id = EVT_ID_CUI_STORAGE_SELECTOR_RESULT;
    evt.size = sizeof(evt);
    evt.user_data = NULL;
    evt.sender_id = cui_id;
    evt.result = drv;

    mmi_fmgri_instance_post_event(instance, (mmi_event_struct*)&evt);

}


static void fmgr_storage_selector_highlight_hdlr(mmi_fmgr_instance_struct *instance, S32 idx)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    ChangeLeftSoftkey(STR_GLOBAL_OK, 0);
#ifndef __MMI_WGUI_DISABLE_CSK__
#ifdef __FMGR_KEY_RULE__
    ChangeCenterSoftkey(0, IMG_GLOBAL_COMMON_CSK);
#endif /* __FMGR_KEY_RULE__ */
#endif
}

static mmi_ret fmgr_storage_selector_key_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_drive_info_struct drv_info;
    S32 ret;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch (event_type)
    {
        case FMGRI_EVENT_RSK:
            /* Callback APP with NULL */
            fmgr_storage_selector_callback_app(instance, 0);
            break;

        case FMGRI_EVENT_TOUCH_CLICK:
        case FMGRI_EVENT_DEF_CMD:
        case FMGRI_EVENT_LSK:
            ret = mmi_fmgri_fsdata_instance_get_drive_info(instance->id, instance->cur_index, &drv_info);
            if (ret < 0)
            {
                FMGR2_DisplayPopup(instance, FMGR_FS_DRIVE_NOT_FOUND_TEXT, MMI_EVENT_FAILURE);
                break;
            }
        #ifdef __FS_CARD_SUPPORT__
            else if (srv_fmgr_drv_is_accessible((U8)drv_info.drv_path[0]) == MMI_FALSE)
            {
                FMGR2_DisplayPopup(instance, STR_GLOBAL_MC_REMOVED, MMI_EVENT_FAILURE);
                break;
            }
        #endif /* __FS_CARD_SUPPORT__ */

            fmgr_storage_selector_callback_app(instance, drv_info.drv_path[0]);
            break;
    }

    return MMI_RET_OK;
}

static MMI_BOOL fmgr_storage_selector_error_hdlr(mmi_fmgr_instance_struct *instance, S32 error)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (error)
    {
        case MMI_FMGR_ERROR_EMPTY:
        #ifdef __FS_CARD_SUPPORT__
            FMGR2_DisplayPopupCB(instance, STR_GLOBAL_INSERT_MEMORY_CARD, MMI_EVENT_FAILURE);
        #else /* __FS_CARD_SUPPORT__ */
            FMGR2_DisplayPopupCB(instance, STR_ID_FMGR_NO_AVAILABLE_STORAGE, MMI_EVENT_FAILURE);
        #endif /* __FS_CARD_SUPPORT__ */
            break;

    #ifdef __USB_IN_NORMAL_MODE__
        case MMI_FMGR_ERROR_USB_MODE:
            FMGR2_DisplayPopupCB(instance, STR_GLOBAL_NOT_AVAILABLE_IN_MASS_STORAGE_MODE, MMI_EVENT_FAILURE);
            break;
    #endif /* __USB_IN_NORMAL_MODE__ */

        default:
            FMGR2_DisplayPopupCB(instance, srv_fmgr_fs_error_get_string(error), MMI_EVENT_FAILURE);
            break;
    }

    fmgr_storage_selector_callback_app(instance, error);
    return MMI_FALSE;
}


mmi_id cui_storage_selector_create(mmi_id caller, U8 default_drive_letter, U32 flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    SRV_FMGR_DRVLIST_HANDLE drvlist_hdl;
    S32 index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    instance = mmi_fmgri_instance_create(caller, MMI_FMGR2_TYPE_STORAGE_SELECTOR);

    if (!instance)
    {
        return 0;
    }

    /* Save releated information */
    instance->cust_data = default_drive_letter;
    instance->title_icon_id = 0;
    instance->title_str_id = 0;

    /* Fsdata */
    mmi_ucs2cpy(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT);
    FMGR_FILTER_INIT(&instance->filter_type);

    if (flag == CUI_STORAGE_SELECTOR_DRV_TYPE_ACCESIBLE_ONLY)
    {
        instance->drv_type = SRV_FMGR_DRIVELIST_TYPE_ACCESSIBLE_ONLY;
    }
    else
    {
        instance->drv_type = SRV_FMGR_DRIVELIST_TYPE_ACCESSIBLE;
    }

    /* GUI */
    instance->display_type = FMGR_GUI_OTHER_SEL_STYLE;
    instance->key_binding = MMI_FMGRI_KEY_ALL | MMI_FMGRI_KEY_TOUCH;

    /* Highlight on default storage */
    drvlist_hdl = srv_fmgr_drivelist_create((srv_fmgr_drivelist_type_enum)(instance->drv_type));
    index = srv_fmgr_drivelist_get_index_by_drv_letter(drvlist_hdl, (U8)default_drive_letter);
    if (index != -1)
    {
        instance->cur_index = index;
    }
    srv_fmgr_drivelist_destroy(drvlist_hdl);

    return mmi_fmgri_instance_get_screen_id(instance->id);
    
}

void   cui_storage_selector_run(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    result = fmgr_cui_run(cui_id, MMI_FMGR2_TYPE_STORAGE_SELECTOR);
    if (result < 0)
    {
        /* Error, post result event */
        fmgr_storage_selector_callback_app((mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id), result);
    }
}

void   cui_storage_selector_close(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_close(cui_id, MMI_FMGR2_TYPE_STORAGE_SELECTOR);
}

void   cui_storage_selector_set_title(mmi_id cui_id, U16 string, U16 icon)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_title(cui_id, MMI_FMGR2_TYPE_STORAGE_SELECTOR, string, icon);
}

void   cui_storage_selector_set_ui_style(mmi_id cui_id, cui_fmgr_ui_style_enum style)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_ui_style(cui_id, MMI_FMGR2_TYPE_STORAGE_SELECTOR, style);
}

void   cui_storage_selector_set_userdata(mmi_id cui_id, U32 userdata)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_userdata(cui_id, MMI_FMGR2_TYPE_STORAGE_SELECTOR, userdata);
}
    
U32    cui_storage_selector_get_userdata(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_cui_get_userdata(cui_id, MMI_FMGR2_TYPE_STORAGE_SELECTOR);
}

WCHAR  cui_storage_selector_get_selected_drive_letter(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    fmgr_drive_info_struct drv_info;
    S32 fs_ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_cui_basic_check(cui_id, MMI_FMGR2_TYPE_STORAGE_SELECTOR);
    if (!instance)
    {
        return 0;
    }

    fs_ret = mmi_fmgri_fsdata_instance_get_drive_info(instance->id, instance->cur_index, &drv_info);
    if (fs_ret < 0)
    {
        return 0;
    }

    return drv_info.drv_path[0];
}


void cui_storage_selector_set_is_disable_ncenter(mmi_id cui_id, MMI_BOOL value)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = fmgr_cui_basic_check(cui_id, MMI_FMGR2_TYPE_STORAGE_SELECTOR);
    if (!instance)
    {
        return;
    }
    instance->is_disable_ncenter = value;
}
#else
static void fmgr_storage_selector_callback_app(mmi_fmgr_instance_struct* instance, S32 drv)
{
}


static void fmgr_storage_selector_highlight_hdlr(mmi_fmgr_instance_struct *instance, S32 idx)
{
}

static MMI_BOOL fmgr_storage_selector_error_hdlr(mmi_fmgr_instance_struct *instance, S32 error)
{
    return MMI_FALSE;
}


mmi_id cui_storage_selector_create(mmi_id caller, U8 default_drive_letter, U32 flag)
{
    return GRP_ID_INVALID;
    
}

void   cui_storage_selector_run(mmi_id cui_id)
{
}

void   cui_storage_selector_close(mmi_id cui_id)
{
}

void   cui_storage_selector_set_title(mmi_id cui_id, U16 string, U16 icon)
{
}

void   cui_storage_selector_set_ui_style(mmi_id cui_id, cui_fmgr_ui_style_enum style)
{
}

void   cui_storage_selector_set_userdata(mmi_id cui_id, U32 userdata)
{
}
    
U32    cui_storage_selector_get_userdata(mmi_id cui_id)
{
    return 0;
}

WCHAR  cui_storage_selector_get_selected_drive_letter(mmi_id cui_id)
{
    return NULL;
}

void cui_storage_selector_set_is_disable_ncenter(mmi_id cui_id, MMI_BOOL value)
{
}
#endif
#define CUI_FILE_SELECTOR
typedef enum
{
    CUI_FILE_SELECTOR_OPT_STYLE_MASK            = 0x00F00000,
    CUI_FILE_SELECTOR_OPT_STYLE_FILE_ONLY       = 0x00000000,
    CUI_FILE_SELECTOR_OPT_STYLE_FILE_FOLDER     = 0x00100000

} cui_file_selector_option_internal_enum;

static void fmgr_file_selector_audio_preview_timer_handler(void* arg)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct    *instance;
    FMGR_FILE_INFO_STRUCT       file_info;
    S32                         ret;
    BOOL                        can_play = TRUE;
    S8                          *buffer;

#if defined(__DRM_SUPPORT__)
    S32 fwd_rule;
#endif

#ifdef __GAIN_TABLE_SUPPORT__
    mmi_id cui_id;
    cui_file_selector_preview_struct preview_evt;
#endif /*"gain table for lge project"*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifdef __MMI_SILENT_MEETING_PROFILE__
    if ((srv_prof_is_profile_activated(SRV_PROF_SILENT_MODE) == SRV_PROF_RET_PROFILE_ACTIVATED) || 
        (srv_prof_is_profile_activated(SRV_PROF_MEETING_MODE) == SRV_PROF_RET_PROFILE_ACTIVATED))
    {
        return;
    }
#else /* __MMI_SILENT_MEETING_PROFILE__ */
    if (srv_prof_is_profile_activated(SRV_PROF_SILENT_MODE) == SRV_PROF_RET_PROFILE_ACTIVATED)
    {
        return;
    }
#endif /* __MMI_SILENT_MEETING_PROFILE__ */

    if(!mmi_fmgri_is_instance_id_valid((U8)((U32)arg)))
        return;

    instance = mmi_fmgri_get_instance_by_id((U8)((U32)arg));

    /* if not active screen, skip the preview */
    if(MMI_SCENARIO_STATE_ACTIVE != mmi_frm_scrn_get_state(mmi_fmgri_instance_get_screen_id(instance->id), mmi_fmgri_instance_get_screen_id(instance->id)))
        return;

    ret = mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, &file_info);
    if(ret < 0)
        return;
    
    if(!FMGR_FILTER_IS_SET_AUDIO(&file_info.file_type))
        return;
    
    /* check DRM */
    buffer = mmi_fmgri_get_and_lock_buffer();
    if( mmi_fmgri_filepath_compose(buffer, FMGR_MAX_PATH_LEN,
                                   instance->file_path, &file_info, MMI_FALSE))
    {
#if defined(__DRM_SUPPORT__)
        fwd_rule = mmi_rmgr_check_forward((U16*)buffer);
        if(fwd_rule < 0 || !(fwd_rule & MMI_RMGR_USAGE_SET))
            can_play = FALSE;
#endif
    }
    else
    {
        can_play = FALSE;
    }
    
    if(can_play)
    {
        FMGR_ASSERT(!g_fmgr_cui_audio_state);
        g_fmgr_cui_audio_state = MMI_TRUE;
		
#ifdef __GAIN_TABLE_SUPPORT__
		cui_id = mmi_fmgri_instance_get_screen_id(instance->id);
		MMI_FRM_INIT_EVENT(&preview_evt, EVT_ID_CUI_FILE_SELECTOR_PREVIEW_START);
		mmi_frm_group_send_to_caller(mmi_fmgri_instance_get_screen_id(instance->id), (mmi_group_event_struct*)&preview_evt);
#endif/*"gain table" for lge project*/

        mdi_audio_play_file((PU16) buffer, DEVICE_AUDIO_PLAY_INFINITE, NULL, NULL, NULL);
    }

    mmi_fmgri_free_and_unlock_buffer(buffer);

}

static void fmgr_file_selector_audio_preview_stop(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifdef __GAIN_TABLE_SUPPORT__
	mmi_id cui_id;
    cui_file_selector_preview_struct preview_evt;
	mmi_fmgr_instance_struct* instance;
#endif/*gain table for lge project*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    StopTimer(FMGR_AUDIO_TIMER);

    if (g_fmgr_cui_audio_state == MMI_TRUE)
    {
        g_fmgr_cui_audio_state = MMI_FALSE;
        mdi_audio_stop_file();

#ifdef __GAIN_TABLE_SUPPORT__
		instance = mmi_fmgri_get_active_instance();
	    cui_id = mmi_fmgri_instance_get_screen_id(instance->id);
        MMI_FRM_INIT_EVENT(&preview_evt, EVT_ID_CUI_FILE_SELECTOR_PREVIEW_STOP);
        mmi_frm_group_send_to_caller(mmi_fmgri_instance_get_screen_id(instance->id), (mmi_group_event_struct*)&preview_evt);
#endif
    }
}

static void fmgr_file_selector_audio_preview(mmi_fmgr_instance_struct* instance, FMGR_FILE_INFO_STRUCT *file_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8  can_play;
    S8  *buffer;
#ifdef __DRM_SUPPORT__
    S32 fwd_rule;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_SILENT_MEETING_PROFILE__
    if ((srv_prof_is_profile_activated(SRV_PROF_SILENT_MODE) == SRV_PROF_RET_PROFILE_ACTIVATED) || 
        (srv_prof_is_profile_activated(SRV_PROF_MEETING_MODE) == SRV_PROF_RET_PROFILE_ACTIVATED))
    {
        return;
    }
#else /* __MMI_SILENT_MEETING_PROFILE__ */
    if (srv_prof_is_profile_activated(SRV_PROF_SILENT_MODE) == SRV_PROF_RET_PROFILE_ACTIVATED)
    {
        return;
    }
#endif /* __MMI_SILENT_MEETING_PROFILE__ */
    
    if((instance->flag & CUI_FILE_SELECTOR_OPT_AUDIO_PREVIEW_ON) &&
        FMGR_FILTER_IS_SET_AUDIO(&file_info->file_type))
    {
        can_play = TRUE;

        /* check path */
        buffer = mmi_fmgri_get_and_lock_buffer();
        if( !mmi_fmgri_filepath_compose(buffer, FMGR_MAX_PATH_LEN,
                                       instance->file_path, file_info, MMI_FALSE))
        {
            mmi_fmgri_free_and_unlock_buffer(buffer);
            return;
        }
        
#if defined(__DRM_SUPPORT__)
        /* check DRM */
        fwd_rule = mmi_rmgr_check_forward((U16*)buffer);
        if(fwd_rule < 0 || !(fwd_rule & MMI_RMGR_USAGE_SET))
            can_play = FALSE;
#endif
        mmi_fmgri_free_and_unlock_buffer(buffer);
        
        if(can_play)
        {
            fmgr_file_selector_audio_preview_stop();
            StartTimerEx(FMGR_AUDIO_TIMER, 1000, fmgr_file_selector_audio_preview_timer_handler, (void*)instance->id);
        }
    }
}

static void fmgr_file_selector_callback_app(mmi_fmgr_instance_struct* instance, FMGR_FILE_INFO_STRUCT *file_info, S32 result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id cui_id;
    cui_file_selector_result_event_struct evt;
    S8  *buffer;
#ifdef __DRM_SUPPORT__
    S32 fwd_flag;
#endif /* __DRM_SUPPORT__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifdef FMGR_USING_CACHE
    /* Before callback to Application, stop GUI decoder, in case the file is locked */
    wgui_fmgr_cache_stop_decoder();
#endif /* FMGR_USING_CACHE */

    fmgr_file_selector_audio_preview_stop();
    
    if (file_info && mmi_ucs2cmp((S8*)SRV_FMGR_PATH_ROOT, instance->file_path))
    {
        buffer = mmi_fmgri_get_and_lock_buffer();

        /* Check max path */
        if (!mmi_fmgri_filepath_compose(buffer, (SRV_FMGR_PATH_MAX_LEN + 1),
            instance->file_path, file_info, MMI_FALSE))
        {
            FMGR2_DisplayPopup(instance, FMGR_FS_PATH_OVER_LEN_ERROR_TEXT, MMI_EVENT_FAILURE);
            mmi_fmgri_free_and_unlock_buffer(buffer);
            return;
        }

#ifdef __DRM_SUPPORT__
        /* Check the file's forward status */
        if (!(file_info->attribute & FS_ATTR_DIR) &&
            (instance->flag & (CUI_FILE_SELECTOR_OPT_DRM_CHECK_SEND_ON|CUI_FILE_SELECTOR_OPT_DRM_CHECK_SET_ON)))
        {
            fwd_flag = mmi_rmgr_check_forward((U16*)buffer);
            if (fwd_flag < 0)
            {
                FMGR2_DisplayPopup(instance, srv_fmgr_fs_error_get_string(fwd_flag), MMI_EVENT_FAILURE);
                mmi_fmgri_free_and_unlock_buffer(buffer);
                return;
            }
            if (((instance->flag & CUI_FILE_SELECTOR_OPT_DRM_CHECK_SET_ON) && !(fwd_flag & MMI_RMGR_USAGE_SET)) ||
                ((instance->flag & CUI_FILE_SELECTOR_OPT_DRM_CHECK_SEND_ON) && !(fwd_flag & MMI_RMGR_USAGE_SEND)))
            {
                FMGR2_DisplayPopup(instance, STR_GLOBAL_DRM_PROHIBITED, MMI_EVENT_FAILURE);
                mmi_fmgri_free_and_unlock_buffer(buffer);
                return;
            }
        }
#endif /* __DRM_SUPPORT__ */
        mmi_fmgri_free_and_unlock_buffer(buffer);
    }

    /* Dead, skip the event */
    if (instance->flag & FMGR_IFLAG_DEAD)
    {
        FMGR_TRACE2(TRC_MMI_FMGR_5C377CEA4AAD41D793471C0965495ADC, 
            "Fmgr > General > Error > id=%d, err=%d\n", instance->id, __LINE__);
        return;
    }

    if (!file_info)
    {
        instance->flag |= FMGR_IFLAG_DEAD;
    }

    cui_id = mmi_fmgri_instance_get_screen_id(instance->id);

    evt.evt_id = EVT_ID_CUI_FILE_SELECTOR_RESULT;
    evt.size = sizeof(evt);
    evt.user_data = NULL;
    evt.sender_id = cui_id;
    evt.result = result;

    mmi_fmgri_instance_post_event(instance, (mmi_event_struct*)&evt);

}

static void fmgr_file_selector_leave_folder(mmi_fmgr_instance_struct* instance, S32 result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* callback when
     *  0: already at root
     *  1: file only
     *  2: traverse = none
     *  3: traverse = sub, and path = start_path
     */
    if (!mmi_ucs2cmp((S8*)instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) ||
        !FMGR_FILTER_IS_SET(&instance->filter_type, FMGR_TYPE_FOLDER) ||
        (instance->flag & CUI_FILE_SELECTOR_OPT_FOLDER_TRAVERSE_NONE) ||
        ((instance->flag & CUI_FILE_SELECTOR_OPT_FOLDER_TRAVERSE_SUB) && mmi_ucs2strlen(instance->file_path) <= (S32)instance->cust_data))
    {
        fmgr_file_selector_callback_app(instance, NULL, result);
    }
    else
    {
        mmi_fmgri_instance_general_leave_folder(instance);
    }

}

static U16 fmgr_file_selector_options_handler(U16 opt_menu_id, U16 menu_id, U32 data, U16 keyCode)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;
    FMGR_FILE_INFO_STRUCT file_info;
#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    fmgr_drive_info_struct  *drv_info;
    S32 fs_ret;
#endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (!menu_id)
    {
        return 0;
    }

    instance = mmi_fmgri_get_instance_by_id((U8)data);
    mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, &file_info);
    
#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    if(mmi_ucs2cmp((S8*)SRV_FMGR_PATH_ROOT, instance->file_path) == 0)
    {
        drv_info = (fmgr_drive_info_struct*)(&file_info);
        if (drv_info->drv_type == FMGR_LINK_FOLDER)
        {
            fs_ret = srv_fmgr_fs_create_folder((WCHAR*)drv_info->drv_path);
            if (fs_ret < 0)
            {
                FMGR2_DisplayPopup(instance, srv_fmgr_fs_error_get_string(fs_ret), MMI_EVENT_FAILURE);
                mmi_fmgri_close_option(opt_menu_id, data);
                return 0;
            }
        }
    }
#endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */
    
    switch(menu_id)
    {
        case MENU_ID_FMGR_DRIVE_SELECT_DONE:
        case MENU_ID_FMGR_FOLDER_SELECT_DONE:            
            fmgr_file_selector_callback_app(instance, &file_info, 1);
            break;

        case MENU_ID_FMGR_DRIVE_OPEN:
        case MENU_ID_FMGR_FOLDER_OPEN:
            mmi_fmgri_instance_general_enter_folder(instance);
            break;
    }
    mmi_fmgri_close_option(opt_menu_id, data);

    return 0;
}

static mmi_ret fmgr_file_selector_key_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FMGR_FILE_INFO_STRUCT file_info;
#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    fmgr_drive_info_struct *drv_info;
#endif
    U16 icon_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, &file_info);

    switch (event_type)
    {
        case FMGRI_EVENT_RSK:
            fmgr_file_selector_leave_folder(instance, 0);
            break;

        case FMGRI_EVENT_TOUCH_CLICK:
        case FMGRI_EVENT_LSK:
            if (instance->cur_index < 0)
            {
                break;
            }
	
            if (mmi_ucs2cmp((S8*)instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
            {
                if (instance->flag & CUI_FILE_SELECTOR_OPT_STYLE_FILE_FOLDER)
                {
                    mmi_fmgri_instance_get_title_info(instance->id, NULL, &icon_id);
                #ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
                    drv_info = (fmgr_drive_info_struct*)&file_info;
                    if (drv_info->drv_type < 0)  /* Link folder */
                    {
                        /* Display link folder option */
                        mmi_fmgr_reset_menu_set(MENU_ID_FMGR_APP_FOLDER_OPTIONS);
                        mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_RENAME);
                        mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_DELETE);
                        mmi_frm_hide_menu_item(MENU_ID_FMGR_FOLDER_CREATE);
                        mmi_fmgri_show_option(mmi_fmgri_instance_get_screen_id(instance->id),
                            MENU_ID_FMGR_APP_FOLDER_OPTIONS, fmgr_file_selector_options_handler, instance->id, icon_id);
                    }
                    else
                #endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */
                    {
                        /* Display drive option */
                        mmi_fmgr_reset_menu_set(MENU_ID_FMGR_APP_DRIVE_OPTIONS);
                        mmi_frm_hide_menu_item(MENU_ID_FMGR_FOLDER_CREATE);
                        mmi_fmgri_show_option(mmi_fmgri_instance_get_screen_id(instance->id),
                            MENU_ID_FMGR_APP_DRIVE_OPTIONS, fmgr_file_selector_options_handler, instance->id, icon_id);
                    }
                }
                else
                {
                     /* Enter folder */
                    mmi_fmgri_instance_general_enter_folder(instance);
                }
            }
            else if (file_info.attribute & FS_ATTR_DIR)
            {
                if (instance->flag & CUI_FILE_SELECTOR_OPT_STYLE_FILE_FOLDER)
                {
                    /* Check if path is too long before entering option screen. */
                    if (mmi_ucs2strlen(instance->file_path) + mmi_ucs2strlen(file_info.file_name) >= SRV_FMGR_PATH_MAX_LEN)
                    {
                        FMGR2_DisplayPopup(instance, FMGR_FS_PATH_OVER_LEN_ERROR_TEXT, MMI_EVENT_FAILURE);
                        break;
                    }
                
                    /* Display folder option */
                    mmi_fmgri_instance_get_title_info(instance->id, NULL, &icon_id);
                    mmi_fmgr_reset_menu_set(MENU_ID_FMGR_APP_FOLDER_OPTIONS);
                    mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_RENAME);
                    mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_DELETE);
                    mmi_frm_hide_menu_item(MENU_ID_FMGR_FOLDER_CREATE);
                    mmi_fmgri_show_option(mmi_fmgri_instance_get_screen_id(instance->id),
                        MENU_ID_FMGR_APP_FOLDER_OPTIONS, fmgr_file_selector_options_handler, instance->id, icon_id);
                }
                else
                {
                    /* Enter folder */
                    mmi_fmgri_instance_general_enter_folder(instance);
                }
            }
            else /* Is file */
            {
                /* Callback APP with file */
                fmgr_file_selector_callback_app(instance, &file_info, 1);
            }
            break;
        
        case FMGRI_EVENT_DEF_CMD:
            if (instance->cur_index < 0)
            {
                break;
            }

            if (mmi_ucs2cmp((S8*)instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0 ||
                file_info.attribute & FS_ATTR_DIR)
            {
                mmi_fmgri_instance_general_enter_folder(instance);
            }
            else
            {
                fmgr_file_selector_callback_app(instance, &file_info, 1);
            }
            break;
    }

    return MMI_RET_OK;
}

static void fmgr_file_selector_notify_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type, U32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_drive_info_struct drv_info;
#ifdef FMGR_TAB_SUPPORT
	S32 i;
	srv_fmgr_notification_dev_plug_event_struct *card_plug;
#endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch (event_type)
    {
        case FMGRI_EVENT_SCREEN_DELETING:
            break;
        
        case FMGRI_EVENT_INSTANCE_CREATING:			
            mmi_fmgri_main_cancel_operation(instance);
            break;
#ifdef FMGR_TAB_SUPPORT
        case FMGRI_EVENT_DRIVE_MOUNT:
            card_plug = (srv_fmgr_notification_dev_plug_event_struct*)data;
         
            for (i = 0; i < FMT_MAX_DRIVE; i++)
            {
                if (card_plug->drv_letters[i] == (U8)instance->file_path[0])
                {
                    mmi_fmgri_fsdata_instance_release_load(instance->id);    
                }
            }
            break;
#endif
        case FMGRI_EVENT_DRIVE_UNMOUNT:
            if (mmi_ucs2cmp((S8*)instance->file_path, (S8*)SRV_FMGR_PATH_ROOT)==0)
            {
                mmi_fmgri_fsdata_instance_get_drive_info(instance->id, instance->cur_index, &drv_info);
                if (drv_info.drv_type < 0 ||
                    FS_GetDevStatus(drv_info.drv_path[0], FS_MOUNT_STATE_ENUM) == FS_NO_ERROR)
                {
                    break;
                }
            }
            else if (FS_GetDevStatus(instance->file_path[0], FS_MOUNT_STATE_ENUM) == FS_NO_ERROR)
            {
                break;
            }

            /* Cancel new folder/delete operation */
            mmi_fmgri_main_cancel_operation(instance);
        
            /* Close option */
            mmi_fmgri_close_options(instance->id);
        
        #ifdef FMGR_TAB_SUPPORT
            /* Stay if there is other tab can switch */
            if (instance->tab_id && mmi_fmgri_table_tab_get_count(instance->tab_id) > 1)
            {
                mmi_fmgri_table_tab_switch(instance->tab_id, (WCHAR*)instance->file_path, sizeof(instance->file_path), 0);
                break;
            }
        #endif /* FMGR_TAB_SUPPORT */

            /* Back to Root */
            if (instance->flag & CUI_FILE_SELECTOR_OPT_FOLDER_TRAVERSE_NONE)
            {
                fmgr_file_selector_callback_app(instance, NULL, 0);
            }
            else
            {
                mmi_fmgri_instance_general_update_path(instance, (S8*)SRV_FMGR_PATH_ROOT);
            }
            break;

        case FMGRI_EVENT_SCREEN_EXIT:
            fmgr_file_selector_audio_preview_stop();
            break;
    }
}

static void fmgr_file_selector_highlight_hdlr(mmi_fmgr_instance_struct *instance, S32 idx)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FMGR_FILE_INFO_STRUCT file_info;
    S32 ret;
#ifdef __DRM_V02__
    S8 *buffer;
    MMI_BOOL is_multipart;
#endif /* __DRM_V02__ */
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Audio preview */
    fmgr_file_selector_audio_preview_stop();

    if (idx < 0)
    {
        ChangeLeftSoftkey(0, 0);
        return;
    }
    
    ret = mmi_fmgri_fsdata_instance_get_file_info_ex(instance->id, idx, &file_info);
    if (ret < 0)
    {
        ChangeLeftSoftkey(0, 0);
        return;
    }
    
#ifdef __DRM_V02__
    is_multipart = MMI_FALSE;

    /* only check file */
    if (mmi_ucs2cmp((S8*)instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) &&
        !(file_info.attribute & FS_ATTR_DIR) &&
        FMGR_FILTER_IS_SET(&file_info.file_type, FMGR_TYPE_ODF))
    {
        buffer = mmi_fmgri_get_and_lock_buffer();
        if (mmi_fmgri_filepath_compose(buffer, (SRV_FMGR_PATH_MAX_LEN + 1), instance->file_path, &file_info, MMI_FALSE))
        {
            is_multipart = DRM_is_archive(0, (kal_wchar*)buffer);
        }
        mmi_fmgri_free_and_unlock_buffer(buffer);
    }
#endif /* __DRM_V02__ */

    if (mmi_ucs2cmp((S8*)instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0 ||
        file_info.attribute & FS_ATTR_DIR)
    {
        /* highlight on DRIVE / FOLDER */
        if(instance->flag & CUI_FILE_SELECTOR_OPT_STYLE_FILE_FOLDER)
        {
            /* Options */
            ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, 0);
        }
        else
        {
            /* Open */
            ChangeLeftSoftkey(STR_GLOBAL_OPEN, 0);
        }
    }
    else
    {
        /* Highlight on FILE */
    #ifdef __DRM_V02__
        if (FMGR_FILTER_IS_SET(&file_info.file_type, FMGR_TYPE_ODF))
        {
            if (!is_multipart)
            {
                /* Treat as a single file */
                if (FMGR_FILTER_IS_SET(&instance->filter_type, srv_fmgr_types_get_main_type(&file_info.file_type)))
                {
                    ChangeLeftSoftkey(STR_GLOBAL_OK, 0);
                }
                else
                {
                    ChangeLeftSoftkey(0, 0);
                }
                return;
            }

            /* Multi part archive */
            if (instance->flag & CUI_FILE_SELECTOR_OPT_ARCHIVE_AS_FOLDER)
            {
                /* Open */
                ChangeLeftSoftkey(STR_GLOBAL_OPEN, 0);
            }
            else if(instance->flag & CUI_FILE_SELECTOR_OPT_ARCHIVE_AS_FILE)
            {
                ChangeLeftSoftkey(STR_GLOBAL_OK, 0);
            }
            else
            {
                ChangeLeftSoftkey(0, 0);
            }
        }
        else
    #endif /* __DRM_V02__ */
        {
            ChangeLeftSoftkey(STR_GLOBAL_OK, 0);
        }

        /* Audio preview */
        fmgr_file_selector_audio_preview(instance, &file_info);
    }
}

static MMI_BOOL fmgr_file_selector_error_hdlr(mmi_fmgr_instance_struct *instance, S32 error)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch (error)
    {
        case FS_MEDIA_CHANGED:
        case MMI_FMGR_ERROR_EMPTY:
        case FS_DRIVE_NOT_FOUND:
            if (mmi_ucs2cmp(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
            {
                /* Popup error */
            #ifdef __FS_CARD_SUPPORT__
                FMGR2_DisplayPopupCB(instance, STR_GLOBAL_INSERT_MEMORY_CARD, MMI_EVENT_FAILURE);
            #else /* __FS_CARD_SUPPORT__ */
                FMGR2_DisplayPopupCB(instance, STR_ID_FMGR_NO_AVAILABLE_STORAGE, MMI_EVENT_FAILURE);
            #endif /* __FS_CARD_SUPPORT__ */

                fmgr_file_selector_callback_app(instance, NULL, error);
        }
        else
        {
            if (mmi_fmgri_instance_accept_empty_folder() == MMI_TRUE)
            {
                return MMI_TRUE;
            }
            /* Popup error */
            FMGR2_DisplayPopupCB(instance, STR_GLOBAL_EMPTY, MMI_EVENT_FAILURE);
            fmgr_file_selector_leave_folder(instance, error);
        }
        break;

#ifdef __USB_IN_NORMAL_MODE__
    case MMI_FMGR_ERROR_USB_MODE:
        FMGR2_DisplayPopupCB(instance, STR_GLOBAL_NOT_AVAILABLE_IN_MASS_STORAGE_MODE, MMI_EVENT_FAILURE);

        fmgr_file_selector_callback_app(instance, NULL, MMI_FMGR_ERROR_USB_MODE);
        break;
#endif /* __USB_IN_NORMAL_MODE__ */

    case MMI_FMGR_ERROR_LOADING_CANCEL:
        fmgr_file_selector_leave_folder(instance, 0);
        break;

    default:
        /* Popup error */
        FMGR2_DisplayPopupCB(instance, srv_fmgr_fs_error_get_string(error), MMI_EVENT_FAILURE);
        if (mmi_ucs2cmp(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
        {
            fmgr_file_selector_callback_app(instance, NULL, error);
        }
        else
        {
            switch(error)
            {
                case FS_PATH_OVER_LEN_ERROR:
                case FS_PATH_NOT_FOUND:
                    fmgr_file_selector_leave_folder(instance, error);
                    break;
                default:
                    /* Move to Root */
                    if (instance->flag & CUI_FILE_SELECTOR_OPT_FOLDER_TRAVERSE_NONE)
                    {
                        fmgr_file_selector_callback_app(instance, NULL, error);
                    }
                    else
                    {
                        mmi_fmgri_instance_general_update_path(instance, (S8*)SRV_FMGR_PATH_ROOT);
                    }
                    break;
            }
        }
        break;
    }
    return MMI_FALSE;
}

mmi_id cui_file_selector_create(mmi_id caller, const WCHAR* start_path, const FMGR_FILTER* filter, 
                                cui_file_selector_style_enum style, U32 option_flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (option_flag & FMGR_IFLAG_INTERNAL)
    {
        instance = mmi_fmgri_instance_create_ex(caller, MMI_FMGR2_TYPE_FILE_SELECTOR);
#ifdef __FS_CARD2_SUPPORT__         
        instance->drv_type = SRV_FMGR_DRIVELIST_TYPE_ACCESSIBLE_ONLY|SRV_FMGR_DRIVELIST_ITYPE_FLAG_2ND_CARD;
#else
        instance->drv_type = SRV_FMGR_DRIVELIST_TYPE_ACCESSIBLE_ONLY;
#endif
    }
    else
    {
        instance = mmi_fmgri_instance_create(caller, MMI_FMGR2_TYPE_FILE_SELECTOR);
        instance->drv_type = SRV_FMGR_DRIVELIST_TYPE_ACCESSIBLE_ONLY;
    }

    if (!instance)
    {
        return 0;
    }
    
    /* Save releated information */
    instance->flag = option_flag;
    instance->cust_data = mmi_ucs2strlen((S8*)start_path);

    /* FSData */
    mmi_ucs2ncpy((S8*)instance->file_path, (S8*)start_path, SRV_FMGR_PATH_MAX_LEN);
    instance->filter_type = *filter;

#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    if ((option_flag & CUI_FILE_SELECTOR_OPT_FIXED_PATH_MASK) != CUI_FILE_SELECTOR_OPT_FIXED_PATH_ON)
    {
        instance->flag |= FMGR_IFLAG_CUSTOM_ROOT;
        mmi_ucs2cpy(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT);
        instance->cust_data = 0;
    }
#endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */    
 
    /* GUI */
    instance->display_type = FMGR_GUI_OTHER_SEL_STYLE;

    /* Other setting */
    instance->arrow_type = CAT213_ARROW_UP | CAT213_ARROW_DOWN;
    if (FMGR_FILTER_IS_SET(filter, FMGR_TYPE_FOLDER))
    {
        instance->arrow_type = CAT213_ARROW_ALL;
    }
    instance->key_binding = MMI_FMGRI_KEY_ALL;

    /* Perform setting check */
    if (style == CUI_FILE_SELECTOR_STYLE_FILE_AND_PATH)
    {
        FMGR_FILTER_SET(&(instance->filter_type), FMGR_TYPE_FOLDER);
        instance->flag |= CUI_FILE_SELECTOR_OPT_STYLE_FILE_FOLDER;
    }
    else if (style == CUI_FILE_SELECTOR_STYLE_FILE_ONLY)
    {
        if (!FMGR_FILTER_IS_SET(filter, FMGR_TYPE_FOLDER))
        {
            instance->flag |= CUI_FILE_SELECTOR_OPT_FOLDER_TRAVERSE_NONE;
        }
    }
    
    if (instance->flag & CUI_FILE_SELECTOR_OPT_FOLDER_TRAVERSE_NONE)
    {
        FMGR_FILTER_CLEAR(&(instance->filter_type), FMGR_TYPE_FOLDER);
    }

    if (!(instance->flag & CUI_FILE_SELECTOR_OPT_STYLE_FILE_FOLDER))
    {
        instance->key_binding |= MMI_FMGRI_KEY_TOUCH;
    }
    return mmi_fmgri_instance_get_screen_id(instance->id);
}    

void   cui_file_selector_run(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    result = fmgr_cui_run(cui_id, MMI_FMGR2_TYPE_FILE_SELECTOR);
    if (result < 0)
    {
        /* Error, post result event */
        fmgr_file_selector_callback_app((mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id), NULL, result);
    }
}

void   cui_file_selector_close(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_close(cui_id, MMI_FMGR2_TYPE_FILE_SELECTOR);
}

void   cui_file_selector_set_title(mmi_id cui_id, U16 string, U16 icon)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_title(cui_id, MMI_FMGR2_TYPE_FILE_SELECTOR, string, icon);
}

#ifndef __MMI_SLIM_FILE_MANAGER__
void   cui_file_selector_set_option(mmi_id cui_id, U32 option_mask, U32 option_value)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_option(cui_id, MMI_FMGR2_TYPE_FILE_SELECTOR, option_mask, option_value, MMI_TRUE);
}
#endif

void   cui_file_selector_set_ui_style(mmi_id cui_id, cui_fmgr_ui_style_enum style)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_ui_style(cui_id, MMI_FMGR2_TYPE_FILE_SELECTOR, style);
}

void   cui_file_selector_set_userdata(mmi_id cui_id, U32 userdata)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_userdata(cui_id, MMI_FMGR2_TYPE_FILE_SELECTOR, userdata);
}

U32    cui_file_selector_get_userdata(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_cui_get_userdata(cui_id, MMI_FMGR2_TYPE_FILE_SELECTOR);
}

const WCHAR* cui_file_selector_get_folder(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_cui_get_folder(cui_id, MMI_FMGR2_TYPE_FILE_SELECTOR);
}

#ifndef __MMI_ULTRA_SLIM_FILE_MANAGER__
S32    cui_file_selector_get_selected_filepath_old(mmi_id cui_id, FMGR_FILE_INFO_STRUCT* info, WCHAR* path_buffer, S32 path_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_cui_get_selected_filepath_old(cui_id, MMI_FMGR2_TYPE_FILE_SELECTOR, info, path_buffer, path_size);
}
#endif

S32    cui_file_selector_get_selected_filepath(mmi_id cui_id, srv_fmgr_fileinfo_struct* info, WCHAR* path_buffer, S32 path_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_cui_get_selected_filepath(cui_id, MMI_FMGR2_TYPE_FILE_SELECTOR, info, path_buffer, path_size);
}


#define CUI_FOLDER_SELECTOR
static mmi_ret fmgr_folder_selector_send_caller_error_handle(mmi_fmgr_instance_struct* instance)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id cui_id;
    cui_folder_selector_result_event_struct evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    cui_id = mmi_fmgri_instance_get_screen_id(instance->id);

    evt.evt_id = EVT_ID_CUI_FOLDER_SELECTOR_BEFORE_ERROR_HANDLE;
    evt.size = sizeof(evt);
    evt.user_data = NULL;
    evt.sender_id = cui_id;

    return mmi_frm_group_send_to_caller(cui_id, (mmi_group_event_struct*)&evt);
}

static void fmgr_folder_selector_callback_app(mmi_fmgr_instance_struct* instance, FMGR_FILE_INFO_STRUCT *file_info, S32 result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id cui_id;
    cui_folder_selector_result_event_struct evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifdef FMGR_USING_CACHE
    /* Before callback to Application, stop GUI decoder, in case the file is locked */
    wgui_fmgr_cache_stop_decoder();
#endif /* FMGR_USING_CACHE */

    if (file_info && mmi_ucs2cmp((S8*)SRV_FMGR_PATH_ROOT, instance->file_path))
    {
        ASSERT(file_info->attribute & FS_ATTR_DIR);
        
        /* Check max path */
        if(!mmi_fmgri_filepath_compose(NULL, (SRV_FMGR_PATH_MAX_LEN + 1),
                                       instance->file_path, file_info, MMI_TRUE))
        {
            FMGR2_DisplayPopup(instance, FMGR_FS_PATH_OVER_LEN_ERROR_TEXT, MMI_EVENT_FAILURE);
            return;
        }
    }

#ifdef FMGR_TAB_SUPPORT
    if (file_info)
    {
        if (mmi_ucs2cmp((S8*)SRV_FMGR_PATH_ROOT, instance->file_path) == 0)
        {
            mmi_fmgri_query_result_tab_setup(((fmgr_drive_info_struct*)file_info)->tab_id);
        }
        else if (instance->tab_id)
        {
            mmi_fmgri_query_result_tab_setup(instance->tab_id);
        }
    }
#endif /* FMGR_TAB_SUPPORT */

    /* Dead, skip the event */
    if(instance->flag & FMGR_IFLAG_DEAD)
    {
        FMGR_TRACE2(TRC_MMI_FMGR_5C377CEA4AAD41D793471C0965495ADC, 
            "Fmgr > General > Error > id=%d, err=%d\n", instance->id, __LINE__);
        return;
    }

    if (!file_info)
    {
        instance->flag |= FMGR_IFLAG_DEAD;
    }

    cui_id = mmi_fmgri_instance_get_screen_id(instance->id);

    evt.evt_id = EVT_ID_CUI_FOLDER_SELECTOR_RESULT;
    evt.size = sizeof(evt);
    evt.user_data = NULL;
    evt.sender_id = cui_id;

    evt.result = result;

    mmi_fmgri_instance_post_event(instance, (mmi_event_struct*)&evt);
}

static void fmgr_folder_selector_leave_folder(mmi_fmgr_instance_struct* instance, S32 result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* callback when
     *  0: already at root
     *  1: traverse = none
     *  2: traverse = sub, and path = start_path
     */
    if (!mmi_ucs2cmp((S8*)instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) ||
        (instance->flag & CUI_FOLDER_SELECTOR_OPT_FOLDER_TRAVERSE_NONE) ||
        ((instance->flag & CUI_FOLDER_SELECTOR_OPT_FOLDER_TRAVERSE_SUB) && mmi_ucs2strlen(instance->file_path) <= (S32)instance->cust_data))
    {
        fmgr_folder_selector_callback_app(instance, NULL, result);
    }
    else
    {
        mmi_fmgri_instance_general_leave_folder(instance);
    }

}

static U16 fmgr_folder_selector_options_handler(U16 opt_menu_id, U16 menu_id, U32 data, U16 keyCode)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;
    FMGR_FILE_INFO_STRUCT file_info;
#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    fmgr_drive_info_struct *drv_info;
    S32 fs_ret;
#endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (menu_id == 0)
    {
        return 0;
    }

    instance = mmi_fmgri_get_instance_by_id((U8)data);
    mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, &file_info);
    
#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    if (mmi_ucs2cmp((S8*)SRV_FMGR_PATH_ROOT, instance->file_path) == 0)
    {
        drv_info = (fmgr_drive_info_struct*)(&file_info);
        if (drv_info->drv_type == FMGR_LINK_FOLDER)
        {
            fs_ret = srv_fmgr_fs_create_folder((WCHAR*)drv_info->drv_path);
            if (fs_ret < 0)
            {
                FMGR2_DisplayPopup(instance, srv_fmgr_fs_error_get_string(fs_ret), MMI_EVENT_FAILURE);
                mmi_fmgri_close_option(opt_menu_id, data);
                return 0;
            }
        }
    }
#endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */
    
    switch (menu_id)
    {
        case MENU_ID_FMGR_DRIVE_SELECT_DONE:
        case MENU_ID_FMGR_FOLDER_SELECT_DONE:           
            fmgr_folder_selector_callback_app(instance, &file_info, 1);
            break;

        case MENU_ID_FMGR_DRIVE_OPEN:
        case MENU_ID_FMGR_FOLDER_OPEN:
            mmi_fmgri_instance_general_enter_folder(instance);
            break;

        case MENU_ID_FMGR_FOLDER_CREATE:
            mmi_fmgri_main_create_folder(instance);
            break;

        case MENU_ID_FMGR_GEN_OPTION_RENAME:
            mmi_fmgri_main_rename(instance);
            break;
        
        case MENU_ID_FMGR_GEN_OPTION_DELETE:
            mmi_fmgri_main_delete_single(instance);
            break;
    }

    mmi_fmgri_close_option(opt_menu_id, data);
    return 0;
}

static mmi_ret fmgr_folder_selector_key_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FMGR_FILE_INFO_STRUCT file_info;
#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    fmgr_drive_info_struct *drv_info;
#endif
    U16 icon_id;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, &file_info);

    switch (event_type)
    {
        case FMGRI_EVENT_RSK:
            fmgr_folder_selector_leave_folder(instance, 0);
            break;
        
        case FMGRI_EVENT_LSK:
            if (instance->cur_index < 0)
            {
                mmi_fmgri_main_create_folder(instance);
                break;
            }

            if (mmi_ucs2cmp((S8*)instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
            {
                mmi_fmgri_instance_get_title_info(instance->id, NULL, &icon_id);
            #ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
                drv_info = (fmgr_drive_info_struct*)&file_info;
                /* Link folder */
                if (drv_info->drv_type < 0)
                {
                    /* Display link folder option */
                    mmi_fmgr_reset_menu_set(MENU_ID_FMGR_APP_FOLDER_OPTIONS);
                    mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_RENAME);
                    mmi_frm_hide_menu_item(MENU_ID_FMGR_GEN_OPTION_DELETE);
                    mmi_frm_hide_menu_item(MENU_ID_FMGR_FOLDER_CREATE);
                    mmi_fmgri_show_option(mmi_fmgri_instance_get_screen_id(instance->id),
                        MENU_ID_FMGR_APP_FOLDER_OPTIONS,
                        fmgr_folder_selector_options_handler,
                        instance->id,
                        icon_id);
                }
                else
           #endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */
                {
                    /* Display drive option */
                    mmi_fmgr_reset_menu_set(MENU_ID_FMGR_APP_DRIVE_OPTIONS);
                    mmi_frm_hide_menu_item(MENU_ID_FMGR_FOLDER_CREATE);
                    mmi_fmgri_show_option(mmi_fmgri_instance_get_screen_id(instance->id),
                        MENU_ID_FMGR_APP_DRIVE_OPTIONS,
                        fmgr_folder_selector_options_handler,
                        instance->id,
                        icon_id);
                }
        }
        else
        {
            FMGR_ASSERT(file_info.attribute & FS_ATTR_DIR);

            /* Check if path is too long before entering option screen */
            if (mmi_ucs2strlen(instance->file_path) + mmi_ucs2strlen(file_info.file_name) > SRV_FMGR_PATH_MAX_LEN)
            {
                FMGR2_DisplayPopup(instance, FMGR_FS_PATH_OVER_LEN_ERROR_TEXT, MMI_EVENT_FAILURE);
                break;
            }
            
            /* Display folder option */
            mmi_fmgri_instance_get_title_info(instance->id, NULL, &icon_id);
            mmi_fmgr_reset_menu_set(MENU_ID_FMGR_APP_FOLDER_OPTIONS);
            mmi_fmgri_show_option(mmi_fmgri_instance_get_screen_id(instance->id),
                MENU_ID_FMGR_APP_FOLDER_OPTIONS,
                fmgr_folder_selector_options_handler,
                instance->id,
                icon_id);
        }
        break;

    case FMGRI_EVENT_DEF_CMD:
        if (instance->cur_index < 0)
        {
            return MMI_RET_ERR;
        }
        mmi_fmgri_instance_general_enter_folder(instance);
        break;
    }
    return MMI_RET_OK;
}

static void fmgr_folder_selector_notify_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type, U32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_drive_info_struct drv_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch (event_type)
    {
        case FMGRI_EVENT_SCREEN_DELETING:
            break;

        case FMGRI_EVENT_INSTANCE_CREATING:			
            mmi_fmgri_main_cancel_operation(instance);
            break;

        case FMGRI_EVENT_DRIVE_UNMOUNT:
            if (mmi_ucs2cmp((S8*)instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
            {
                mmi_fmgri_fsdata_instance_get_drive_info(instance->id, instance->cur_index, &drv_info);
                if (drv_info.drv_type < 0 || FS_GetDevStatus(drv_info.drv_path[0], FS_MOUNT_STATE_ENUM) == FS_NO_ERROR)
                {
                    break;
                }
            }
            else if (FS_GetDevStatus(instance->file_path[0], FS_MOUNT_STATE_ENUM) == FS_NO_ERROR)
            {
                break;
            }

            /* Cancel new folder/delete operation */
            mmi_fmgri_main_cancel_operation(instance);
        
            /* Close option */
            mmi_fmgri_close_options(instance->id);
        
        #ifdef FMGR_TAB_SUPPORT
            /* Stay if there is other tab can switch */
            if (instance->tab_id && mmi_fmgri_table_tab_get_count(instance->tab_id) > 1)
            {
                mmi_fmgri_table_tab_switch(instance->tab_id, (WCHAR*)instance->file_path, sizeof(instance->file_path), 0);
                break;
            }
       #endif /* FMGR_TAB_SUPPORT */

        /* Back to Root */
        mmi_fmgri_instance_general_update_path(instance, (S8*)SRV_FMGR_PATH_ROOT);
        break;
    }
}

static void fmgr_folder_selector_highlight_hdlr(mmi_fmgr_instance_struct *instance, S32 idx)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FMGR_FILE_INFO_STRUCT file_info;
    S32 ret;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (idx < 0)
    {
        if (FS_GetDevStatus(instance->file_path[0], FS_MOUNT_STATE_ENUM) == FS_NO_ERROR)
        {
            ChangeLeftSoftkey(STR_ID_FMGR_NEW_FOLDER_LSK, 0);
        }
        else
        {
            ChangeLeftSoftkey(0, 0);
        }
        return;
    }
    
    ret = mmi_fmgri_fsdata_instance_get_file_info_ex(instance->id, idx, &file_info);
    if (ret < 0)
    {
        ChangeLeftSoftkey(0, 0);
        return;
    }
    
    /* Options */
    ChangeLeftSoftkey(STR_GLOBAL_OPTIONS, 0);
}

static MMI_BOOL fmgr_folder_selector_error_hdlr(mmi_fmgr_instance_struct *instance, S32 error)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_ret ret = MMI_RET_OK;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ret = fmgr_folder_selector_send_caller_error_handle(instance);
    
    switch (error)
    {
        case FS_MEDIA_CHANGED:
        case MMI_FMGR_ERROR_EMPTY:
        case FS_DRIVE_NOT_FOUND:
            if (mmi_ucs2cmp(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
            {
                /* Popup error */
                if (ret == MMI_RET_OK)
                {
                #ifdef __FS_CARD_SUPPORT__
                    FMGR2_DisplayPopupCB(instance, STR_GLOBAL_INSERT_MEMORY_CARD, MMI_EVENT_FAILURE);
                #else /* __FS_CARD_SUPPORT__ */
                    FMGR2_DisplayPopupCB(instance, STR_ID_FMGR_NO_AVAILABLE_STORAGE, MMI_EVENT_FAILURE);
                #endif /* __FS_CARD_SUPPORT__ */
                }
                fmgr_folder_selector_callback_app(instance, NULL, error);
            }
            else
            {
                if (mmi_fmgri_instance_accept_empty_folder())
                {
                    return MMI_TRUE;
                }

                /* Popup error */
                if (ret == MMI_RET_OK)
                {
                    FMGR2_DisplayPopupCB(instance, STR_GLOBAL_EMPTY, MMI_EVENT_FAILURE);
                }
                /* Move upward */
                fmgr_folder_selector_leave_folder(instance, error);
            }
            break;

    #ifdef __USB_IN_NORMAL_MODE__
        case MMI_FMGR_ERROR_USB_MODE:
            if (ret == MMI_RET_OK)
            {
                FMGR2_DisplayPopupCB(instance, STR_GLOBAL_NOT_AVAILABLE_IN_MASS_STORAGE_MODE, MMI_EVENT_FAILURE);
            }

            fmgr_folder_selector_callback_app(instance, NULL, error);
            break;
    #endif /* __USB_IN_NORMAL_MODE__ */

        case MMI_FMGR_ERROR_LOADING_CANCEL:
            fmgr_folder_selector_leave_folder(instance, 0);
            break;

        default:
            /* Popup error */
            if (ret == MMI_RET_OK)
            {
                FMGR2_DisplayPopupCB(instance, srv_fmgr_fs_error_get_string(error), MMI_EVENT_FAILURE);
            }
            
            if (mmi_ucs2cmp(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
            {
                fmgr_folder_selector_callback_app(instance, NULL, error);
            }
            else
            {
                switch (error)
                {
                    case FS_PATH_OVER_LEN_ERROR:
                    case FS_PATH_NOT_FOUND:
                        fmgr_folder_selector_leave_folder(instance, error);
                        break;

                    default:
                        /* Move to Root */
                        mmi_fmgri_instance_general_update_path(instance, (S8*)SRV_FMGR_PATH_ROOT);
                        break;
                }
            }
            break;
    }

    return MMI_FALSE;
}

static S32  fmgr_folder_selector_command_hdlr(mmi_fmgr_instance_struct *instance, S32 cmd, S32 para, void* data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (cmd)
    {
        case FMGRI_CMD_GET_EMPTY_STR:
            *((U16*)data) = STR_ID_FMGR_NO_FOLDERS;
            return MMI_TRUE;
    }
    return MMI_FALSE;
}

static mmi_ret fmgr_folder_selector_event_proc_handler(mmi_fmgr_instance_struct *instance, mmi_event_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch (param->evt_id)
    {
    #ifdef __FMGR_USE_EDITOR_CUI__
        case EVT_ID_CUI_FILENAME_EDITOR_RESULT:
            mmi_fmgri_main_handle_editor_event(instance, param);
            break;
    #endif /* __FMGR_USE_EDITOR_CUI__ */
    }

    return MMI_RET_OK;
}

mmi_id cui_folder_selector_create(mmi_id caller, const WCHAR* start_path, 
                                  cui_folder_selector_style_enum style, U32 option_flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (option_flag & FMGR_IFLAG_INTERNAL)
    {
        instance = mmi_fmgri_instance_create_ex(caller, MMI_FMGR2_TYPE_FOLDER_SELECTOR);
        /* Set drv type, don't display unmounted memory card */
#ifdef __FS_CARD2_SUPPORT__         
        instance->drv_type = SRV_FMGR_DRIVELIST_TYPE_ACCESSIBLE_ONLY|SRV_FMGR_DRIVELIST_ITYPE_FLAG_2ND_CARD;
#else
        instance->drv_type = SRV_FMGR_DRIVELIST_TYPE_ACCESSIBLE_ONLY;
#endif
    }
    else
    {
        instance = mmi_fmgri_instance_create(caller, MMI_FMGR2_TYPE_FOLDER_SELECTOR);
        /* Set drv type, don't display unmounted memory card */
        instance->drv_type = SRV_FMGR_DRIVELIST_TYPE_ACCESSIBLE_ONLY;
    }

    if (!instance)
    {
        return 0;
    }
    
    /* Save releated information */
    instance->flag = option_flag;
    instance->cust_data = mmi_ucs2strlen((S8*)start_path);

    /* FSData */
    mmi_ucs2ncpy((S8*)instance->file_path, (S8*)start_path, SRV_FMGR_PATH_MAX_LEN);
    FMGR_FILTER_INIT(&instance->filter_type);
    FMGR_FILTER_SET(&instance->filter_type, FMGR_TYPE_FOLDER);

#ifdef __FMGR_CUSTOM_ROOT_SUPPORT__
    if ((option_flag & CUI_FOLDER_SELECTOR_OPT_FIXED_PATH_MASK) != CUI_FOLDER_SELECTOR_OPT_FIXED_PATH_ON)
    {
        instance->flag |= FMGR_IFLAG_CUSTOM_ROOT;
        mmi_ucs2cpy(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT);
        instance->cust_data = 0;
    }
#endif /* __FMGR_CUSTOM_ROOT_SUPPORT__ */    

    /* GUI */
    instance->display_type = FMGR_GUI_OTHER_SEL_STYLE;

    /* Other setting */
    instance->arrow_type = CAT213_ARROW_ALL;
    instance->key_binding = MMI_FMGRI_KEY_ALL;

    /* Perform setting check */
    return mmi_fmgri_instance_get_screen_id(instance->id);

}

void   cui_folder_selector_run(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    result = fmgr_cui_run(cui_id, MMI_FMGR2_TYPE_FOLDER_SELECTOR);
    if (result < 0)
    {
        /* Error, post result event */
        fmgr_folder_selector_callback_app((mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id), NULL, result);
    }
}

void   cui_folder_selector_close(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_close(cui_id, MMI_FMGR2_TYPE_FOLDER_SELECTOR);
}

void   cui_folder_selector_set_title(mmi_id cui_id, U16 string, U16 icon)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_title(cui_id, MMI_FMGR2_TYPE_FOLDER_SELECTOR, string, icon);
}

void   cui_folder_selector_set_option(mmi_id cui_id, U32 option_mask, U32 option_value)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_option(cui_id, MMI_FMGR2_TYPE_FOLDER_SELECTOR, option_mask, option_value, MMI_TRUE);
}

void   cui_folder_selector_set_ui_style(mmi_id cui_id, cui_fmgr_ui_style_enum style)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_ui_style(cui_id, MMI_FMGR2_TYPE_FOLDER_SELECTOR, style);
}

void cui_folder_selector_set_userdata(mmi_id cui_id, U32 userdata)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_userdata(cui_id, MMI_FMGR2_TYPE_FOLDER_SELECTOR, userdata);
}

U32    cui_folder_selector_get_userdata(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_cui_get_userdata(cui_id, MMI_FMGR2_TYPE_FOLDER_SELECTOR);
}

const WCHAR* cui_folder_selector_get_folder(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_cui_get_folder(cui_id, MMI_FMGR2_TYPE_FOLDER_SELECTOR);
}

#ifndef __MMI_ULTRA_SLIM_FILE_MANAGER__
S32    cui_folder_selector_get_selected_filepath_old(mmi_id cui_id, FMGR_FILE_INFO_STRUCT* info, WCHAR* path_buffer, S32 path_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_cui_get_selected_filepath_old(cui_id, MMI_FMGR2_TYPE_FOLDER_SELECTOR, info, path_buffer, path_size);
}
#endif

S32    cui_folder_selector_get_selected_filepath(mmi_id cui_id, srv_fmgr_fileinfo_struct* info, WCHAR* path_buffer, S32 path_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_cui_get_selected_filepath(cui_id, MMI_FMGR2_TYPE_FOLDER_SELECTOR, info, path_buffer, path_size);
}

#define CUI_FOLDER_BROWSER

static U16 fmgr_folder_browser_options_handler_cont(U16 opt_menu_id, U16 menu_id, U32 data, U16 keyCode);

typedef struct _fmgr_folder_browser_struct
{
    U16 option_menu;
    U16 option_menu_empty;

    U16 empty_lsk_str;
    U16 empty_lsk_icon;

    //fmgr_filelist_handle fl;

#ifdef __FMGR_FTE_TOOLBAR_SUPPORT__
    U16 tb_btn_count;
    U16 tb_btn_menus[FMGR_FTE_TB_MAX_COUNT];
    gui_icon_bar_item_resource_struct tb_btn_resources[FMGR_FTE_TB_MAX_COUNT];
#endif
    
} fmgr_folder_browser_struct;

typedef struct 
{
    cui_folder_browser_on_menu_event_struct base;
    U16     opt_menu_id;
    U16     keyCode;
} cui_folder_browser_on_menu_ex_event_struct;

static void fmgr_folder_browser_post_event(mmi_fmgr_instance_struct *instance, cui_folder_browser_event_enum event, S32 param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    union {
        cui_folder_browser_on_entry_event_struct    on_entry;
        cui_folder_browser_on_exit_event_struct     on_exit;
        cui_folder_browser_on_empty_event_struct    on_empty;
        cui_folder_browser_on_quit_event_struct     on_quit;
    } evt;
    mmi_id cui_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Dead, skip the event */
    if(instance->flag & FMGR_IFLAG_DEAD)
    {
        FMGR_TRACE2(TRC_MMI_FMGR_5C377CEA4AAD41D793471C0965495ADC, 
            "Fmgr > General > Error > id=%d, err=%d\n", instance->id, __LINE__);
        return;
    }

    cui_id = mmi_fmgri_instance_get_screen_id(instance->id);
    
    evt.on_entry.evt_id = event;
    evt.on_entry.size = sizeof(evt);
    evt.on_entry.user_data = NULL;
    evt.on_entry.sender_id = cui_id;

    switch(event)
    {
    case EVT_ID_CUI_FOLDER_BROWSER_ON_ENTRY:
    case EVT_ID_CUI_FOLDER_BROWSER_ON_EXIT:
    case EVT_ID_CUI_FOLDER_BROWSER_ON_EMPTY:
    case EVT_ID_CUI_FOLDER_BROWSER_ON_CSK:
        break;
        
    case EVT_ID_CUI_FOLDER_BROWSER_ON_QUIT:
        evt.on_quit.quit_reason = (S32)param;
        instance->flag |= FMGR_IFLAG_DEAD;
        break;

    default:
        FMGR_ASSERT(0);
        break;
    }

    mmi_fmgri_instance_post_event(instance, (mmi_event_struct*)&evt);

}

static S32 fmgr_folder_browser_prepare_option(mmi_fmgr_instance_struct *instance, FMGR_FILE_INFO_STRUCT *file_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8 *buffer;
    fmgr_folder_browser_struct *info;
    mmi_fmgr_filetype_enum file_type;
    U16 opt_menu_id;
    srv_fmgr_fileinfo_struct f_info;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    info = (fmgr_folder_browser_struct*)instance->cust_data;

    opt_menu_id = info->option_menu;
    if (!opt_menu_id)
    {
        /* If no AP's option, use file type's */
        file_type = srv_fmgr_types_get_main_type(&file_info->file_type);
		buffer = mmi_fmgri_get_and_lock_buffer();
		if (!mmi_fmgri_filepath_compose(buffer, (SRV_FMGR_PATH_MAX_LEN + 1),
                                  instance->file_path, file_info, MMI_FALSE))
		{
			mmi_fmgri_free_and_unlock_buffer(buffer);
			return FS_PATH_OVER_LEN_ERROR;
		}
        opt_menu_id = srv_fmgr_types_get_option_menu(file_type, (const WCHAR*)buffer, 0);
		mmi_fmgri_free_and_unlock_buffer(buffer);
        if (!opt_menu_id)
        {
            return 0;
        }
    }

    buffer = mmi_fmgri_get_and_lock_buffer();
    if (!mmi_fmgri_filepath_compose(buffer, (SRV_FMGR_PATH_MAX_LEN + 1),
                                  instance->file_path, file_info, MMI_FALSE))
    {
        mmi_fmgri_free_and_unlock_buffer(buffer);
        return FS_PATH_OVER_LEN_ERROR;
    }

    f_info.type = srv_fmgr_types_get_main_type(&file_info->file_type);
    f_info.attribute = file_info->attribute;
    f_info.size = file_info->file_size;
    memcpy(&f_info.datetime, &file_info->time, sizeof(MYTIME));
    srv_fmgr_prepare_option_menu(opt_menu_id, (WCHAR *)buffer, &f_info);
    mmi_fmgri_prepare_option(instance, opt_menu_id, file_info);
    mmi_fmgri_free_and_unlock_buffer(buffer);

    return opt_menu_id;
}

static S32 fmgr_folder_browser_options_entry_handler(U16 opt_menu_id, U32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    FMGR_FILE_INFO_STRUCT file_info;
    S8 *buffer;
    S32 ret;
    srv_fmgr_fileinfo_struct f_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!opt_menu_id || !mmi_fmgri_is_instance_id_valid((U8)data))
    {
        return 0;
    }
    memset(&file_info, 0, sizeof(FMGR_FILE_INFO_STRUCT));
    
    instance = mmi_fmgri_get_instance_by_id((U8)data);
    if (instance->cur_index >= 0)
    {
        ret = mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, &file_info);
        if (ret < 0)
        {
            return 0;
        }
    }
    
    /* Run option enabler check */
    buffer = mmi_fmgri_get_and_lock_buffer();
    if (!mmi_fmgri_filepath_compose(buffer, (SRV_FMGR_PATH_MAX_LEN + 1),
                                  instance->file_path, &file_info, MMI_FALSE))
    {
        mmi_fmgri_free_and_unlock_buffer(buffer);
        return 0;
    }

    f_info.type = srv_fmgr_types_get_main_type(&file_info.file_type);
    f_info.attribute = file_info.attribute;
    f_info.size = file_info.file_size;
    memcpy(&f_info.datetime, &file_info.time, sizeof(MYTIME));
    srv_fmgr_prepare_option_menu(opt_menu_id, (WCHAR *)buffer, &f_info);
    mmi_fmgri_prepare_option(instance, opt_menu_id, &file_info);
    mmi_fmgri_free_and_unlock_buffer(buffer);
    return 0;
}

static U16 fmgr_folder_browser_options_handler(U16 opt_menu_id, U16 menu_id, U32 data, U16 keyCode)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    cui_folder_browser_on_menu_ex_event_struct on_menu_ex;
    mmi_id cui_id;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (!menu_id)
    {
        return 0;
    }
    instance = mmi_fmgri_get_instance_by_id((U8)data);

    /* Post event to caller */
    cui_id = mmi_fmgri_instance_get_screen_id(instance->id);
    
    on_menu_ex.base.evt_id = EVT_ID_CUI_FOLDER_BROWSER_ON_MENU;
    on_menu_ex.base.size = sizeof(on_menu_ex);
    on_menu_ex.base.user_data = NULL;
    on_menu_ex.base.sender_id = cui_id;
    
    on_menu_ex.base.menuitem_id = menu_id;
    
    on_menu_ex.opt_menu_id = opt_menu_id;
    on_menu_ex.keyCode = keyCode;

    if (MMI_RET_OK != mmi_frm_group_send_to_caller(cui_id, (mmi_group_event_struct*)&on_menu_ex))
    {
        return 0;
    }
    return fmgr_folder_browser_options_handler_cont(opt_menu_id, menu_id, data, keyCode);
}

#ifdef __FS_SORT_SUPPORT__
extern void fmgr_main_set_sort(U16 menu_id, mmi_fmgr_instance_struct *instance);
#endif /* __FS_SORT_SUPPORT__ */
static U16 fmgr_folder_browser_options_handler_cont(U16 opt_menu_id, U16 menu_id, U32 data, U16 keyCode)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    FMGR_FILE_INFO_STRUCT *file_info = NULL;
    S32 result;
    S8* buffer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (!menu_id)
    {
        return 0;
    }

    file_info = OslMalloc(sizeof(FMGR_FILE_INFO_STRUCT));
    memset(file_info, 0, sizeof(FMGR_FILE_INFO_STRUCT));
    
    instance = mmi_fmgri_get_instance_by_id((U8)data);
    mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, file_info);

    /* Do general option first */
    result = mmi_fmgri_instance_general_option_handler(opt_menu_id, menu_id, data, keyCode);
    if (result >= 0)
    {
        if (file_info != NULL)
        {
            OslMfree(file_info);
        }
        return (U16)result;
    }

    switch (menu_id)
    {
    #ifdef __DRM_V02__
        case MENU_ID_FMGR_DRM_OPTION_MUL_ODF_OPEN:
            mmi_fmgri_instance_general_enter_folder(instance);
            mmi_fmgri_close_option(opt_menu_id, data);
            break;
    #endif /* __DRM_V02__ */
    #ifdef __FS_SORT_SUPPORT__
        case MENU_ID_FMGR_SORT_BY_NAME:
        case MENU_ID_FMGR_SORT_BY_TYPE:
        case MENU_ID_FMGR_SORT_BY_TIME:
        case MENU_ID_FMGR_SORT_BY_SIZE:
            fmgr_main_set_sort(menu_id, instance);  
            /* Since last screen is list screen, it should be closed when LSK be done. */ 
            mmi_fmgri_close_options(data);
            break;
    #endif /* __FS_SORT_SUPPORT__ */
        default:
            buffer = mmi_fmgri_get_and_lock_buffer();
            do {
                if (!mmi_fmgri_filepath_compose(buffer, (SRV_FMGR_PATH_MAX_LEN + 1), instance->file_path, file_info, MMI_FALSE))
                {
                    FMGR2_DisplayPopup(instance, FMGR_FS_PATH_OVER_LEN_ERROR_TEXT, MMI_EVENT_FAILURE);
                    break;
                }

                if (instance->cur_index == -1)
                {
                    /* Check if the parent path is existing or not */
                    result = mmi_fmgr_get_file_info_by_path(buffer, file_info);
                    if (result < 0)
                    {
                        if (mmi_ucs2cmp(buffer, (S8*)SRV_FMGR_PATH_ROOT) == 0)
						{
							;
						}
						else if (mmi_ucs2strlen(buffer) == 3)
						{
							/* Drive -> Root */
							mmi_ucs2cpy(buffer, (S8*)SRV_FMGR_PATH_ROOT);
						}
						else
						{
							/* Update buffer. Only keep drive name */
							buffer[6] = 0;							
						}
                    }                
                }

                result = srv_fmgr_types_launch_option((WCHAR *)buffer, menu_id);
                if (GetNumOfChild(menu_id) == 0)
											mmi_fmgri_close_options(data);
            } while(0);
            mmi_fmgri_free_and_unlock_buffer(buffer);
            break;
    }

    if (file_info != NULL)
    {
        OslMfree(file_info);
    }
    return 0;
}


static mmi_ret fmgr_folder_browser_key_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FMGR_FILE_INFO_STRUCT *file_info = NULL;
    fmgr_folder_browser_struct *info;
    U16 opt_menu, icon_id;
    mmi_fmgr_filetype_enum file_type;
    S32 fs_ret;
	S8 *buffer;
#ifdef __FMGR_CSK_FORWARD__   
    S32 fwd_menu_id;
#endif /* __FMGR_CSK_FORWARD__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    file_info = OslMalloc(sizeof(FMGR_FILE_INFO_STRUCT));
    memset(file_info, 0, sizeof(FMGR_FILE_INFO_STRUCT));

    if (instance->cur_index >= 0)
    {
        fs_ret = mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, file_info);
        if (fs_ret < 0 && event_type != FMGRI_EVENT_RSK)
        {
            FMGR2_DisplayPopup(instance, srv_fmgr_fs_error_get_string(fs_ret), MMI_EVENT_FAILURE);
            if (file_info != NULL)
            {
                OslMfree(file_info);
            }
            return MMI_RET_OK;
        }
    }
    info = (fmgr_folder_browser_struct*)instance->cust_data;

    switch (event_type)
    {
        case FMGRI_EVENT_RSK:
            fmgr_folder_browser_post_event(instance, EVT_ID_CUI_FOLDER_BROWSER_ON_QUIT, 0);
            break;
        
        case FMGRI_EVENT_LSK:
            if (instance->cur_index >= 0)        /* Non-empty */
            {
                opt_menu = info->option_menu;
                if (!opt_menu)
                {
                    /* if no AP's option, use file type's */
                    file_type = srv_fmgr_types_get_main_type(&file_info->file_type);
                    buffer = mmi_fmgri_get_and_lock_buffer();
                    if (!mmi_fmgri_filepath_compose(buffer, (SRV_FMGR_PATH_MAX_LEN + 1), instance->file_path, file_info, MMI_FALSE))
                    {
                        FMGR2_DisplayPopup(instance, FMGR_FS_PATH_OVER_LEN_ERROR_TEXT, MMI_EVENT_FAILURE);
                        mmi_fmgri_free_and_unlock_buffer(buffer);
                        break;
                    }
                    opt_menu = srv_fmgr_types_get_option_menu(file_type, (const WCHAR*)buffer, 0);
                    mmi_fmgri_free_and_unlock_buffer(buffer);
                }
            }
            else /* Empty */
            {
                if (info->empty_lsk_str)
                {
                    fmgr_folder_browser_post_event(instance, EVT_ID_CUI_FOLDER_BROWSER_ON_EMPTY, 0);
                    break;
                }
                opt_menu = info->option_menu_empty;
            }

            if (!opt_menu)
            {
                break;
            }

            /* Check path */
            if (!mmi_fmgri_filepath_compose(NULL, (SRV_FMGR_PATH_MAX_LEN + 1), instance->file_path, file_info, MMI_FALSE))
            {
                FMGR2_DisplayPopup(instance, FMGR_FS_PATH_OVER_LEN_ERROR_TEXT, MMI_EVENT_FAILURE);
                break;
            }

            fs_ret = fmgr_folder_browser_prepare_option(instance, file_info);
            if (fs_ret <= 0)
            {
                FMGR2_DisplayPopup(instance, srv_fmgr_fs_error_get_string(fs_ret), MMI_EVENT_FAILURE);
                break;
            }
		
            /* Display option from setting */
            mmi_fmgri_instance_get_title_info(instance->id, NULL, &icon_id);
            mmi_fmgri_show_option_ex(mmi_fmgri_instance_get_screen_id(instance->id),
                opt_menu, 
                fmgr_folder_browser_options_handler, 
                instance->id, icon_id, 0, 
                fmgr_folder_browser_options_entry_handler, 
                MMI_FMGR_OPTION_TYPE_NORMAL, 0);
            break;

        case FMGRI_EVENT_DEF_CMD:
            if (instance->cur_index < 0)
            {
                if (file_info != NULL)
                {
                    OslMfree(file_info);
                }
                return MMI_RET_ERR;
            }

            fs_ret = fmgr_folder_browser_prepare_option(instance, file_info);
            if (fs_ret <= 0)
            {
                FMGR2_DisplayPopup(instance, srv_fmgr_fs_error_get_string(fs_ret), MMI_EVENT_FAILURE);
                break;
            }

            opt_menu = (U16)fs_ret;

            if (!GetNumOfChild(opt_menu))
            {
                FMGR2_DisplayPopup(instance, STR_GLOBAL_ERROR, MMI_EVENT_FAILURE);
                break;
            }        
            opt_menu = GetSeqItemId(opt_menu, 0);
            if (mmi_frm_test_menu_item_hide(opt_menu))
            {
                if (file_info != NULL)
                {
                    OslMfree(file_info);
                }
                return MMI_RET_ERR; /* Disabled */
            }

            /* Run it */
            opt_menu = fmgr_folder_browser_options_handler(0, opt_menu, instance->id, KEY_LSK);
            if (opt_menu)
            {
                /* If there is sub-option, stop */
                if (file_info != NULL)
                {
                    OslMfree(file_info);
                }
                return MMI_RET_ERR;
            }
            break;

        case FMGRI_EVENT_CSK:
            fmgr_folder_browser_post_event(instance, EVT_ID_CUI_FOLDER_BROWSER_ON_CSK, 0);
            break;
        
    #ifdef __FMGR_CSK_FORWARD__
        case FMGRI_EVENT_SEND_KEY:
            if ((instance->flag & CUI_FOLDER_BROWSER_OPT_FAST_FORWARD_MASK) == CUI_FOLDER_BROWSER_OPT_FAST_FORWARD_OFF)
            {
                break;
            }

            /* Check forward */
            buffer = mmi_fmgri_get_and_lock_buffer();
            if (!mmi_fmgri_filepath_compose(buffer, (SRV_FMGR_PATH_MAX_LEN + 1), instance->file_path, file_info, MMI_FALSE))
            {
                FMGR2_DisplayPopup(instance, FMGR_FS_PATH_OVER_LEN_ERROR_TEXT, MMI_EVENT_FAILURE);
                mmi_fmgri_free_and_unlock_buffer(buffer);
                break;
            }
        
            fwd_menu_id = mmi_fmgri_get_forward_option(buffer, file_info, instance->app_id, MMI_TRUE);
            mmi_fmgri_free_and_unlock_buffer(buffer);
        
            if (fwd_menu_id == 0)
            {
                FMGR2_DisplayPopup(instance, STR_ID_FMGR_NO_FORWARD_OPTION, MMI_EVENT_FAILURE);
                break;
            }
            else if(fwd_menu_id < 0)
            {
                FMGR2_DisplayPopup(instance, srv_fmgr_fs_error_get_string(fwd_menu_id), MMI_EVENT_FAILURE);
                break;
            }
        
            /* Display option from setting */
            mmi_fmgri_instance_get_title_info(instance->id, NULL, &icon_id);
            mmi_fmgri_show_option_ex(mmi_fmgri_instance_get_screen_id(instance->id),
                (U16)fwd_menu_id, fmgr_folder_browser_options_handler, 
                instance->id, icon_id, STR_GLOBAL_SEND, NULL, 0, 0);
            break;
    #endif /* __FMGR_CSK_FORWARD__ */
    }

    if (file_info != NULL)
    {
        OslMfree(file_info);
    }
    return MMI_RET_OK;
}

static void fmgr_folder_browser_notify_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type, U32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;
#ifdef __FMGR_FTE_TOOLBAR_SUPPORT__
    fmgr_folder_browser_struct  *info;
#endif /* __FMGR_FTE_TOOLBAR_SUPPORT__ */
    srv_fmgr_notification_dev_plug_event_struct *card_plug;
	
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch (event_type)
    {
        case FMGRI_EVENT_SCREEN_DELETING:
            FMGR_ASSERT(instance->cust_data);
            OslMfree((void*)instance->cust_data);
            break;

        case FMGRI_EVENT_SCREEN_ENTRY:
        #ifdef __FMGR_FTE_TOOLBAR_SUPPORT__
            if (data > 0)
            {
                info = (fmgr_folder_browser_struct*)instance->cust_data;
                mmi_fmgri_gui_toolbar_init(info->tb_btn_menus, info->tb_btn_resources, info->tb_btn_count);
            }
        #endif /* __FMGR_FTE_TOOLBAR_SUPPORT__ */
            fmgr_folder_browser_post_event(instance, EVT_ID_CUI_FOLDER_BROWSER_ON_ENTRY, 0);
            break;

        case FMGRI_EVENT_SCREEN_EXIT:
            fmgr_folder_browser_post_event(instance, EVT_ID_CUI_FOLDER_BROWSER_ON_EXIT, 0);
            break;

        case FMGRI_EVENT_INSTANCE_CREATING:			
            mmi_fmgri_main_cancel_operation(instance);
            break;

        case FMGRI_EVENT_DRIVE_UNMOUNT:
            if (FS_GetDevStatus(instance->file_path[0], FS_MOUNT_STATE_ENUM) == FS_NO_ERROR)
            {
                break;
            }
            /* Cancel operation */
            mmi_fmgri_main_cancel_operation(instance);
            /* Close option */
            mmi_fmgri_close_options(instance->id);

            /* Quit */
            fmgr_folder_browser_post_event(instance, EVT_ID_CUI_FOLDER_BROWSER_ON_QUIT, 0);
            break;

        case FMGRI_EVENT_DRIVE_MOUNT:
            card_plug = (srv_fmgr_notification_dev_plug_event_struct*)data;
         
            for (i = 0; i < FMT_MAX_DRIVE; i++)
            {
                if (card_plug->drv_letters[i] == (U8)instance->file_path[0])
                {
                    mmi_fmgri_fsdata_instance_release_load(instance->id);    
                }
            }
            break;
    }
}

static void fmgr_folder_browser_highlight_hdlr(mmi_fmgr_instance_struct *instance, S32 idx)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FMGR_FILE_INFO_STRUCT file_info;
    fmgr_folder_browser_struct *info;
    S32 ret;
    U16 lsk_icon, lsk_id;
#ifndef __MMI_WGUI_DISABLE_CSK__
    U16 csk_icon;
#endif
#ifdef __DRM_V02__
    U16 real_type;
    MMI_BOOL is_multipart;
#endif /* __DRM_V02__ */
#ifdef __FMGR_FTE_TOOLBAR_SUPPORT__ 
    S8* buffer;
    mmi_fmgr_filetype_enum file_type;
    S32 option_menu_id;
    S32 i;
    srv_fmgr_fileinfo_struct f_info;
#endif /* __FMGR_FTE_TOOLBAR_SUPPORT__ */
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    info = (fmgr_folder_browser_struct*)instance->cust_data;

    lsk_id = 0;
    lsk_icon = 0;
#ifndef __MMI_WGUI_DISABLE_CSK__
    csk_icon = 0;
#ifdef __FMGR_KEY_RULE__
    csk_icon = IMG_GLOBAL_COMMON_CSK;
#endif /* __FMGR_KEY_RULE__ */
#endif

    do {
        if (idx == -1) /* Empty case */
        {
            if (info->empty_lsk_str)
            {
                lsk_icon = info->empty_lsk_icon;
                lsk_id = info->empty_lsk_str;
            }
            else if (info->option_menu_empty)
            {
				/* Check menu item status. 
				   Because there are several menu item hidden after called enabler */
                fmgr_folder_browser_options_entry_handler(info->option_menu_empty, instance->id);

                if (GetNumOfChild_Ext(info->option_menu_empty))
                {
                    /* Options */
                    lsk_id = STR_GLOBAL_OPTIONS;  
                #ifndef __MMI_WGUI_DISABLE_CSK__
					csk_icon = IMG_GLOBAL_OPTION_CSK;
                #endif
                }
            }
            break;
        }

        ret = mmi_fmgri_fsdata_instance_get_file_info_ex(instance->id, idx, &file_info);
        if (ret < 0)
        {
        #ifdef __FMGR_FTE_TOOLBAR_SUPPORT__ 
            mmi_fmgri_gui_toolbar_update(FMGR_FTE_TB_UPDATE_DISABLE_ALL);
        #endif /* __FMGR_FTE_TOOLBAR_SUPPORT__ */
            break;
        }

        if (file_info.attribute & FS_ATTR_DIR)
        {
            /* Highlight on FOLDER */
        #ifdef __FMGR_FTE_TOOLBAR_SUPPORT__ 
            mmi_fmgri_gui_toolbar_update(FMGR_FTE_TB_UPDATE_DISABLE_ALL);
        #endif /* __FMGR_FTE_TOOLBAR_SUPPORT__ */
            break;
        }

        /* Highlight on FILE */
    #ifdef __DRM_V02__
        if (FMGR_FILTER_IS_SET(&file_info.file_type, FMGR_TYPE_ODF))
        {
            is_multipart = FMGR_FLAG_IS_SET(file_info.flag, MMI_FMGR_FILEINFO_FLAG_IS_ARCHIEVE) ? MMI_TRUE : MMI_FALSE;

            if (!is_multipart)
            {
                /* Treat as a single file */
                if (FMGR_FILTER_IS_SET(&instance->filter_type, srv_fmgr_types_get_main_type(&file_info.file_type)))
                {
                    /* Options */
                    lsk_id = STR_GLOBAL_OPTIONS;
                }
                break;
            }

            /* Multi part archive */
            if (instance->flag & CUI_FILE_SELECTOR_OPT_ARCHIVE_AS_FOLDER)
            {
                /* Options */
                lsk_id = STR_GLOBAL_OPTIONS;
            }
        }
        else
    #endif /* __DRM_V02__ */
        {
            /* Normal file */
            /* Options */
            lsk_id = STR_GLOBAL_OPTIONS;
 
        #ifdef __FMGR_FTE_TOOLBAR_SUPPORT__ 
            if (info->tb_btn_count)
            {
                /* check if menu is available */
                buffer = mmi_fmgri_get_and_lock_buffer();
                if (mmi_fmgri_filepath_compose(buffer, (SRV_FMGR_PATH_MAX_LEN + 1),
                         instance->file_path, &file_info, MMI_FALSE))
                {
                    /* Enable all */
                    for (i = 0; i < info->tb_btn_count; i++)
                    {
                        mmi_frm_unhide_menu_item(info->tb_btn_menus[i]);
                    }
                    file_type = srv_fmgr_types_get_main_type(&file_info.file_type);                    
                    option_menu_id = srv_fmgr_types_get_option_menu(file_type, NULL, 0);
                    f_info.type = srv_fmgr_types_get_main_type(&file_info.file_type);
                    f_info.attribute = file_info.attribute;
                    f_info.size = file_info.file_size;
                    memcpy(&f_info.datetime, &file_info.time, sizeof(MYTIME));
                    srv_fmgr_prepare_option_menu(option_menu_id, (WCHAR *)buffer, &f_info);
                    mmi_fmgri_prepare_option(instance, option_menu_id, &file_info);
                }
                mmi_fmgri_free_and_unlock_buffer(buffer);
                mmi_fmgri_gui_toolbar_update(FMGR_FTE_TB_UPDATE_BY_MENU_STATE);
            }
        #endif /* __FMGR_FTE_TOOLBAR_SUPPORT__ */
        #ifdef __FMGR_KEY_RULE__
            ret = fmgr_folder_browser_prepare_option(instance, &file_info);
        #ifndef __MMI_WGUI_DISABLE_CSK__
            if ( ret > 0 && GetNumOfChild((U16)ret))
            {
                ret = GetSeqItemId((U16)ret, 0);
                if (mmi_frm_test_menu_item_hide((U16)ret) ||
                    GetNumOfChild(mmi_fmgri_get_menu_link((U16)ret)))
                {
                    csk_icon = IMG_GLOBAL_OPTION_CSK;
                }
            }
        #endif
        #endif /* __FMGR_KEY_RULE__ */
        }
    }while(0);
#ifndef __MMI_WGUI_DISABLE_CSK__
    if (lsk_id == 0)
    {
        csk_icon = 0;
    }
#endif
    mmi_fmgri_gui_set_softkeys(MMI_FMGRI_KEY_LSK, lsk_id, lsk_icon);
#ifndef __MMI_WGUI_DISABLE_CSK__
    mmi_fmgri_gui_set_softkeys(MMI_FMGRI_KEY_CSK, 0, csk_icon);
#endif
    return;
}

static MMI_BOOL fmgr_folder_browser_error_hdlr(mmi_fmgr_instance_struct *instance, S32 error)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch(error)
    {
        case FS_MEDIA_CHANGED:  /* Treat no card & no path as empty case */
        case FS_PATH_NOT_FOUND:
        case FS_FILE_NOT_FOUND:
        case FS_DRIVE_NOT_FOUND:
        case MMI_FMGR_ERROR_EMPTY:
            return MMI_TRUE;

        case MMI_FMGR_ERROR_LOADING_CANCEL:
            fmgr_folder_browser_post_event(instance, EVT_ID_CUI_FOLDER_BROWSER_ON_QUIT, 0);
            break;

    #ifdef __USB_IN_NORMAL_MODE__
        case MMI_FMGR_ERROR_USB_MODE:
            FMGR2_DisplayPopupCB(instance, STR_GLOBAL_NOT_AVAILABLE_IN_MASS_STORAGE_MODE, MMI_EVENT_FAILURE);
            fmgr_folder_browser_post_event(instance, EVT_ID_CUI_FOLDER_BROWSER_ON_QUIT, error);
            break;
    #endif

        default:
            /* If fs error, quit browse */
            FMGR2_DisplayPopupCB(instance, srv_fmgr_fs_error_get_string(error), MMI_EVENT_FAILURE);
            fmgr_folder_browser_post_event(instance, EVT_ID_CUI_FOLDER_BROWSER_ON_QUIT, error);
            break;
        
    }
    return MMI_FALSE;
}

static S32  fmgr_folder_browser_command_hdlr(mmi_fmgr_instance_struct *instance, S32 cmd, S32 para, void* data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 key_binding;
#ifdef __FMGR_FTE_TOOLBAR_SUPPORT__
    U16 menu_id;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch (cmd)
    {
        case FMGRI_CMD_EXECUTE_MENU:
            key_binding = (U8)(para >> 16);
        #ifdef __FMGR_FTE_TOOLBAR_SUPPORT__
            menu_id = (U16)(para & 0xFFFF);
        #endif
        
            switch (key_binding)
            {
                case MMI_FMGRI_KEY_TOUCH:
                #ifdef __FMGR_FTE_TOOLBAR_SUPPORT__
                    fmgr_folder_browser_options_handler(0, menu_id, instance->id, KEY_LSK);
                #endif /* __FMGR_FTE_TOOLBAR_SUPPORT__ */
                break;
            }
            break;
    }
    return 0;
}

#ifdef __FMGR_USE_MENU_CUI__
static void mmi_fmgri_folder_browser_send_to_caller(mmi_fmgr_instance_struct *instance, cui_menu_event_struct *menu_cui_event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	S8 *filename = NULL;
    S32 ret = -1;
    U32 group_id = GRP_ID_INVALID;
    FMGR_FILE_INFO_STRUCT* file_info = NULL;
    cui_folder_browser_on_option_event_struct evt;
    srv_fmgr_fileinfo_struct srv_file_info;
        
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    file_info = OslMalloc(sizeof(FMGR_FILE_INFO_STRUCT));
    memset(file_info, 0, sizeof(FMGR_FILE_INFO_STRUCT));
    memset(&srv_file_info, 0, sizeof(srv_fmgr_fileinfo_struct));
    
    ret = mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, file_info);
    if (ret < 0)
    {
        /* free file_info */
        OslMfree(file_info);
        file_info = NULL;
    }
    else
    {
        srv_file_info.attribute = file_info->attribute;
        srv_file_info.datetime = file_info->time;
        srv_file_info.size = file_info->file_size;
        srv_file_info.type = srv_fmgr_types_get_main_type(&file_info->file_type);
		filename = file_info->file_name;
    }
                                                     
    group_id = mmi_fmgri_instance_get_screen_id(instance->id);
    MMI_FRM_INIT_GROUP_EVENT(&evt, sizeof(cui_folder_browser_on_option_event_struct), group_id);
    evt.evt_id = EVT_ID_CUI_FOLDER_BROWSER_ON_OPTION;
    evt.file_path = (const WCHAR*)instance->file_path;
    evt.file_name = (const WCHAR*)filename;
    evt.file_info = &srv_file_info;
    evt.menu_cui_id = menu_cui_event->sender_id;
    evt.menu_cui_evt = menu_cui_event;
    mmi_frm_group_send_to_caller(group_id, (mmi_group_event_struct*)&evt);

    if (file_info != NULL)
    {
        OslMfree(file_info);
        file_info = NULL;
    }
}
#endif

static mmi_ret fmgr_folder_browser_event_proc_handler(mmi_fmgr_instance_struct *instance, mmi_event_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_post_result_event_struct *result_evt;
    union {
        mmi_event_struct *base;
        cui_folder_browser_on_menu_ex_event_struct *on_menu_ex;
    } evt;
#ifdef __FMGR_USE_MENU_CUI__
    cui_menu_event_struct *menu_cui_event;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch(param->evt_id)
    {
#ifdef __FMGR_USE_MENU_CUI__    
        case EVT_ID_CUI_MENU_LIST_ENTRY:
            menu_cui_event = (cui_menu_event_struct *)param;
            mmi_fmgri_folder_browser_send_to_caller(instance, menu_cui_event);
            break;
#endif            
        case EVT_ID_POST_CB_RST:
            result_evt = (mmi_post_result_event_struct*)param;

            /* If caller want to stop the event */
            if (result_evt->result != MMI_RET_OK)
            {
                return MMI_RET_OK;
            }

            /* Continue */
            evt.base = result_evt->evt_p;
            switch (evt.base->evt_id)
            {
                case EVT_ID_CUI_FOLDER_BROWSER_ON_MENU:
                    evt.on_menu_ex = (cui_folder_browser_on_menu_ex_event_struct*)result_evt->evt_p;
                    fmgr_folder_browser_options_handler_cont(
                        evt.on_menu_ex->opt_menu_id, 
                        evt.on_menu_ex->base.menuitem_id, 
                        instance->id, 
                        evt.on_menu_ex->keyCode);
                break;
            }
            break;
        
    #ifdef __FMGR_USE_EDITOR_CUI__
        case EVT_ID_CUI_FILENAME_EDITOR_RESULT:
            mmi_fmgri_main_handle_editor_event(instance, param);
            break;
    #endif /* __FMGR_USE_EDITOR_CUI__ */
    }

    return MMI_RET_OK;
}

static mmi_ret fmgr_folder_browser_launch_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    cui_folder_browser_on_quit_event_struct *quit_evt = NULL;
    mmi_id cui_id = GRP_ID_INVALID;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    switch(evt->evt_id)
    {
    case EVT_ID_GROUP_INACTIVE:        
        break;
    case EVT_ID_GROUP_DEINIT:
        break;

    case EVT_ID_CUI_FOLDER_BROWSER_ON_QUIT:
        quit_evt = (cui_folder_browser_on_quit_event_struct*)evt;

        cui_id = quit_evt->sender_id;
        
        cui_folder_browser_close(cui_id);
        break;
    }
    return MMI_RET_OK;
}

MMI_BOOL cui_folder_browser_launch(mmi_id parent_id, const WCHAR* base_path, const FMGR_FILTER* filter, U32 option_flag,
                                 U16 title_str_id, U16 title_icon_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id cui_grp, adp_grp;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    if (parent_id != GRP_ID_INVALID)
    {
        adp_grp = mmi_frm_group_create(parent_id, GRP_ID_AUTO_GEN, fmgr_folder_browser_launch_proc, NULL);
    }
    else
    {
        adp_grp = mmi_frm_group_create(GRP_ID_ROOT, GRP_ID_AUTO_GEN, fmgr_folder_browser_launch_proc, NULL);
    }
    mmi_frm_group_enter(adp_grp, MMI_FRM_NODE_SMART_CLOSE_FLAG);

    cui_grp = cui_folder_browser_create(adp_grp, (WCHAR*)base_path, filter, 0, 
                0, 0);
    if(!cui_grp)
    {
        FMGR_DisplayPopup(STR_GLOBAL_ERROR, MMI_EVENT_FAILURE);
        mmi_frm_group_close(adp_grp);
        return MMI_FALSE;
    }
    
    cui_folder_browser_set_title(cui_grp, title_str_id, title_icon_id);

    return cui_folder_browser_run(cui_grp);    
}

mmi_id cui_folder_browser_create(mmi_id caller, const WCHAR* folder_path, const FMGR_FILTER* filter, 
                                  U32 option_flag, U16 opt_menu, U16 opt_menu_empty)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    fmgr_folder_browser_struct *setting;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Eequest/create a FMGR instance*/
    if (option_flag & FMGR_IFLAG_INTERNAL)
    {
        instance = mmi_fmgri_instance_create_ex(caller, MMI_FMGR2_TYPE_FOLDER_BROWSER);
    }
    else
    {
        instance = mmi_fmgri_instance_create(caller, MMI_FMGR2_TYPE_FOLDER_BROWSER);
    }

    if (!instance)
    {
        return 0;
    }

    setting = OslMalloc(sizeof(fmgr_folder_browser_struct));
    memset(setting, 0, sizeof(fmgr_folder_browser_struct));
    setting->option_menu = opt_menu;
    setting->option_menu_empty = opt_menu_empty;

    /* Save releated information */
    instance->flag = option_flag | FMGR_IFLAG_HIDE_LOADING_PATH;
    instance->cust_data = (U32)setting;

    /* Path, must not ROOT*/
    FMGR_ASSERT(mmi_ucs2cmp((S8*)folder_path, (S8*)SRV_FMGR_PATH_ROOT));

    mmi_ucs2ncpy(instance->file_path, (S8*)folder_path, SRV_FMGR_PATH_MAX_LEN);
    instance->filter_type = *filter;

    /* Set drv type, don't display unmounted memory card */
    instance->drv_type = SRV_FMGR_DRIVELIST_TYPE_ACCESSIBLE_ONLY;

    /* GUI */
    instance->display_type = FMGR_GUI_OTHER_SEL_STYLE;
    instance->arrow_type = CAT213_ARROW_UP | CAT213_ARROW_DOWN;
    instance->key_binding = MMI_FMGRI_KEY_ALL;

#ifdef __FMGR_CSK_FORWARD__
    if(instance->flag & CUI_FOLDER_BROWSER_OPT_FAST_FORWARD_ON)
    {
        instance->key_binding |= MMI_FMGRI_KEY_SEND;
    }
#endif /* __FMGR_CSK_FORWARD__ */

    if (instance->flag & CUI_FOLDER_BROWSER_OPT_USE_CSK_ON)
    {
        instance->key_binding |= MMI_FMGRI_KEY_CSK;
    }

    return mmi_fmgri_instance_get_screen_id(instance->id);
}

MMI_BOOL  cui_folder_browser_run(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    result = fmgr_cui_run(cui_id, MMI_FMGR2_TYPE_FOLDER_BROWSER);
    if (result < 0)
    {
        /* Error, post result event */
        fmgr_folder_browser_post_event((mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id), EVT_ID_CUI_FOLDER_BROWSER_ON_QUIT, result);
        return MMI_FALSE;
    }
    return MMI_TRUE;
}

void   cui_folder_browser_close(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_close(cui_id, MMI_FMGR2_TYPE_FOLDER_BROWSER);
}

void   cui_folder_browser_set_title(mmi_id cui_id, U16 string, U16 icon)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_title(cui_id, MMI_FMGR2_TYPE_FOLDER_BROWSER, string, icon);
}

void   cui_folder_browser_set_option(mmi_id cui_id, U32 option_mask, U32 option_value)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    MMI_BOOL check_create;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    check_create = MMI_TRUE;
    if (option_mask == CUI_FOLDER_BROWSER_OPT_USE_CSK_MASK)
    {
        check_create = MMI_FALSE;
    }
    if (!fmgr_cui_set_option(cui_id, MMI_FMGR2_TYPE_FOLDER_BROWSER, option_mask, option_value, check_create))
    {
        return;
    }

    instance = fmgr_cui_basic_check(cui_id, MMI_FMGR2_TYPE_FOLDER_BROWSER);
    if (option_mask & CUI_FOLDER_BROWSER_OPT_USE_CSK_MASK)
    {
        if(instance->flag & CUI_FOLDER_BROWSER_OPT_USE_CSK_ON)
        {
            instance->key_binding |= MMI_FMGRI_KEY_CSK;
        }
        else
        {
            instance->key_binding &= ~MMI_FMGRI_KEY_CSK;
        }
    }
}

void   cui_folder_browser_set_ui_style(mmi_id cui_id, cui_fmgr_ui_style_enum style)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_ui_style(cui_id, MMI_FMGR2_TYPE_FOLDER_BROWSER, style);
}

#ifndef __MMI_SLIM_FILE_MANAGER__
void   cui_folder_browser_set_userdata(mmi_id cui_id, U32 userdata)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_userdata(cui_id, MMI_FMGR2_TYPE_FOLDER_BROWSER, userdata);
}

U32    cui_folder_browser_get_userdata(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_cui_get_userdata(cui_id, MMI_FMGR2_TYPE_FOLDER_BROWSER);
}
#endif

void   cui_folder_browser_set_folder_path(mmi_id cui_id, const WCHAR* new_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return;
    }
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);

    mmi_fmgri_instance_general_update_path(instance, (S8*)new_path);
    mmi_fmgri_fsdata_instance_release_load(instance->id);
    mmi_fmgri_instance_general_refresh(instance);
    mmi_fmgri_main_cancel_operation(instance);
}

void   cui_folder_browser_set_highlight_index(mmi_id cui_id, S32 new_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return;
    }
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);

    if (new_index >= 0)
    {
        mmi_fmgri_instance_general_refresh_by_id(instance->id, new_index);
        mmi_fmgri_main_cancel_operation(instance);
    }
}

void   cui_folder_browser_set_empty_lsk(mmi_id cui_id, U16 string, U16 icon)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct        *instance;
    fmgr_folder_browser_struct      *info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return;
    }
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);
    info = (fmgr_folder_browser_struct*)instance->cust_data;

    info->empty_lsk_icon = icon;
    info->empty_lsk_str = string;

    if (instance->cur_index < 0)
    {
        mmi_fmgri_instance_general_refresh(instance);
    }
}

S32    cui_folder_browser_get_highlight_index(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct        *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);

    return instance->cur_index;
}

#ifndef __MMI_SLIM_FILE_MANAGER__
S32    cui_folder_browser_get_total_count(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct        *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);

    return mmi_fmgri_fsdata_instance_get_total_count(instance->id);
}

S32    cui_folder_browser_get_file_info_old(mmi_id cui_id, S32 index, FMGR_FILE_INFO_STRUCT* info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct        *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if(!mmi_fmgri_is_screen_id_valid(cui_id))
        return MMI_FMGR_ERROR_INVALID_PARAM;

    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);

    return mmi_fmgri_fsdata_instance_get_file_info(instance->id, index, info);
}
#endif

S32    cui_folder_browser_get_filepath(mmi_id cui_id, S32 index, srv_fmgr_fileinfo_struct* info, WCHAR* path_buffer, S32 path_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    S32 result;
    FMGR_FILE_INFO_STRUCT fileinfo;
    fmgr_drive_info_struct *drv_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);

    result = mmi_fmgri_fsdata_instance_get_file_info(instance->id, instance->cur_index, &fileinfo);

    if (result < 0)
    {
        return result;
    }

    if (path_buffer)
    {
        if (mmi_ucs2cmp(instance->file_path, (S8*)SRV_FMGR_PATH_ROOT) == 0)
        {
            drv_info = (fmgr_drive_info_struct*)&fileinfo;
            mmi_ucs2cpy((S8*)path_buffer, (S8*)drv_info->drv_path);
        }
        else
        {
            if (!mmi_fmgri_filepath_compose((S8*)path_buffer, path_size/ENCODING_LENGTH,
                                           instance->file_path, &fileinfo, (MMI_BOOL)(fileinfo.attribute & FS_ATTR_DIR)))
            {
                return FS_PATH_OVER_LEN_ERROR;
            }
        }
    }

    if (info)
    {
        info->attribute = fileinfo.attribute;
        info->datetime = fileinfo.time;
        info->size = fileinfo.file_size;
        info->type = srv_fmgr_types_get_main_type(&fileinfo.file_type);
    }
    
    return 0;
}

S32 cui_folder_browser_lock_filelist(mmi_id cui_id, SRV_FMGR_FILELIST_HANDLE *fl_hdl, S32* cur_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);

    if (instance->type != MMI_FMGR2_TYPE_FOLDER_BROWSER)
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }

  
    if (mmi_fmgri_fsdata_is_file_list_locked() == MMI_TRUE)
    {
        /* File list is already locked */
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }
    else
    {
        *fl_hdl = mmi_fmgri_fsdata_lock_file_list();
        *cur_index = instance->cur_index;
    }

    return 0;
}

S32 cui_folder_browser_unlock_filelist(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    SRV_FMGR_FILELIST_HANDLE file_hdl;
    srv_fmgr_filelist_state_enum state;
        
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);

    if (instance->type != MMI_FMGR2_TYPE_FOLDER_BROWSER)
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }

    if (mmi_fmgri_fsdata_is_file_list_locked() == MMI_FALSE)
    {
        /* File list is not locked */
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }

    file_hdl = mmi_fmgri_fsdata_get_current_file_list_hdl();
    state = srv_fmgr_filelist_get_state(file_hdl);    
    if (state == SRV_FMGR_FILELIST_STATE_REFRESHING ||
        state == SRV_FMGR_FILELIST_STATE_LOADING)
    {        
        mmi_fmgri_fsdata_instance_release_load(instance->id);
    }
    
    mmi_fmgri_fsdata_unlock_file_list();
    return 0;
}

MMI_BOOL cui_folder_browser_is_filelist_locked(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return MMI_FALSE; /*MMI_FMGR_ERROR_INVALID_PARAM */
    }
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);

    if (instance->type != MMI_FMGR2_TYPE_FOLDER_BROWSER)
    {
        return MMI_FALSE; /*MMI_FMGR_ERROR_INVALID_PARAM */
    }

    return mmi_fmgri_fsdata_is_file_list_locked();
}

S32  cui_folder_browser_set_toolbar(mmi_id cui_id, const mmi_menu_id* btn_menus, const gui_icon_bar_item_resource_struct* btn_resources, U16 btn_count)
{
#if defined(__FMGR_FTE_TOOLBAR_SUPPORT__) && !defined(__MMI_ULTRA_SLIM_FILE_MANAGER__)
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;
    fmgr_folder_browser_struct *info;
    S32 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }
    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);

    if (instance->type != MMI_FMGR2_TYPE_FOLDER_BROWSER)
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }

    if (btn_count > FMGR_FTE_TB_MAX_COUNT)
    {
        return MMI_FMGR_ERROR_INVALID_PARAM;
    }
    info = (fmgr_folder_browser_struct*)instance->cust_data;

    info->tb_btn_count = btn_count;
    for (i=0; i<info->tb_btn_count; i++)
    {
        info->tb_btn_menus[i] = btn_menus[i];
        info->tb_btn_resources[i] = btn_resources[i];
    }

    if (!fmgr_cui_is_in_create_state(cui_id))
    {
        mmi_fmgri_instance_general_refresh(instance);
    }
    return 0;
#else /* __FMGR_FTE_TOOLBAR_SUPPORT__ */
    return MMI_FMGR_ERROR_INVALID_PARAM;
#endif /* __FMGR_FTE_TOOLBAR_SUPPORT__ */
}

#ifdef __FMGR_FILE_OPTION_CUI__
#define CUI_FILE_OPTION

static void fmgr_file_option_post_event(mmi_fmgr_instance_struct *instance, S32 param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_id cui_id;
    cui_file_option_on_quit_event_struct evt;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Dead, skip the event */
    if(instance->flag & FMGR_IFLAG_DEAD)
    {
        FMGR_TRACE2(TRC_MMI_FMGR_5C377CEA4AAD41D793471C0965495ADC, 
            "Fmgr > General > Error > id=%d, err=%d\n", instance->id, __LINE__);
        return;
    }

    instance->flag |= FMGR_IFLAG_DEAD;

    cui_id = mmi_fmgri_instance_get_screen_id(instance->id);

    evt.evt_id = EVT_ID_CUI_FILE_OPTION_ON_QUIT;
    evt.size = sizeof(evt);
    evt.user_data = NULL;
    evt.sender_id = cui_id;

    evt.result = param;

    mmi_fmgri_instance_post_event(instance, (mmi_event_struct*)&evt);
}

static U16 fmgr_file_option_options_handler(U16 opt_menu_id, U16 menu_id, U32 data, U16 keyCode)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct* instance;
    FMGR_FILE_INFO_STRUCT *file_info = NULL;
    filetypes_file_type_enum file_type;
    S32 fs_ret;
    S32 fwd_menu_id;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    instance = mmi_fmgri_get_instance_by_id((U8)data);
    
    if (!menu_id)
    {
        /* Clean up */
        fmgr_file_option_post_event(instance, 0);
        return 0;
    }

    file_info = OslMalloc(sizeof(FMGR_FILE_INFO_STRUCT));
    memset(file_info, 0, sizeof(FMGR_FILE_INFO_STRUCT));
    
    /* Setup file_info */
    fs_ret = mmi_fmgr_get_file_info_by_path(instance->file_path, file_info);
    if (fs_ret < FS_NO_ERROR)
    {
        FMGR2_DisplayPopupCB(instance, srv_fmgr_fs_error_get_string(fs_ret), MMI_EVENT_FAILURE);
        fmgr_file_option_post_event(instance, fs_ret);
        if (file_info != NULL)
        {
            OslMfree(file_info);
        }
        return 0;
    }

    switch (menu_id)
    {
        case MENU_ID_FMGR_GEN_OPTION_FORWARD_USE:
        case MENU_ID_FMGR_GEN_OPTION_FORWARD_SEND:

            file_type = srv_fmgr_types_get_main_type(&file_info->file_type);

            if (menu_id == MENU_ID_FMGR_GEN_OPTION_FORWARD_USE)
            {
                fwd_menu_id = srv_fmgr_types_get_use_option_menu(file_type, (WCHAR *)instance->file_path);
            }
            else
            {
                fwd_menu_id = srv_fmgr_types_get_send_option_menu(file_type, (WCHAR *)instance->file_path);
            }

            if (fwd_menu_id == 0)
            {
                FMGR2_DisplayPopup(instance, STR_ID_FMGR_NO_FORWARD_OPTION, MMI_EVENT_FAILURE);
                break;
            }
            else if (fwd_menu_id < 0)
            {
                FMGR2_DisplayPopup(instance, srv_fmgr_fs_error_get_string(fwd_menu_id), MMI_EVENT_FAILURE);
                break;
            }
            if (file_info != NULL)
            {
                OslMfree(file_info);
            }
            return fwd_menu_id;

    #ifdef __DRM_V02__
        case MENU_ID_FMGR_DRM_OPTION_MUL_ODF_OPEN:
            /* Create another instance */
            instance->cust_data = mmi_fmgri_open_archive(mmi_fmgri_instance_get_screen_id(instance->id), APP_FILEMANAGER, instance->file_path);
            break;
    #endif /* __DRM_V02__ */

        default:
            if (srv_fmgr_types_launch_option((WCHAR *)instance->file_path, menu_id) <= 0)
            {
                FMGR_ASSERT(0);
            }
            break;
    }
    if (file_info != NULL)
    {
        OslMfree(file_info);
    }
    return 0;
}

static S32 fmgr_file_option_entry_handler(U16 menu_id, U32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    instance = mmi_fmgri_get_instance_by_id((U8)data);
    if (mmi_fmgri_get_file_option(instance->file_path, MMI_FALSE, instance->flag, instance->app_id) <= 0)
    {
        mmi_frm_scrn_enter(mmi_fmgri_instance_get_screen_id(instance->id), SCR_ID_FMGR_GENERAL_DUMMY, NULL, (FuncPtr)mmi_frm_display_dummy_screen_ex, MMI_FRM_FG_ONLY_SCRN);
        fmgr_file_option_post_event(instance, FS_FILE_NOT_FOUND);
        return -1;
    }
    return 0;
}

static void fmgr_file_option_notify_event_hdlr(mmi_fmgr_instance_struct *instance, S32 event_type, U32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    switch (event_type)
    {
        case FMGRI_EVENT_SCREEN_DELETING:
            break;

        case FMGRI_EVENT_INSTANCE_CREATING:
        #ifdef __DRM_V02__
            if (instance->cust_data)
            {
                mmi_fmgri_close_archive(instance->cust_data);
                instance->cust_data = 0;
            }
        #endif /* __DRM_V02__ */
            break;

        case FMGRI_EVENT_DRIVE_UNMOUNT:
             if (FS_GetDevStatus(instance->file_path[0], FS_MOUNT_STATE_ENUM) == FS_NO_ERROR)
             {
                break;
             }
            fmgr_file_option_post_event(instance, 0);
            break;
    }
}

mmi_id cui_file_option_create(mmi_id caller, const WCHAR* file_path, U32 option_flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct    *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    /* Request/create a FMGR instance */
    if (option_flag & FMGR_IFLAG_INTERNAL)
    {
        instance = mmi_fmgri_instance_create_ex(caller, MMI_FMGR2_TYPE_FILE_OPTION);
    }
    else
    {
        instance = mmi_fmgri_instance_create(caller, MMI_FMGR2_TYPE_FILE_OPTION);
    }

    if (!instance)
    {
        return 0;
    }

    /* Save releated information */
    instance->type = MMI_FMGR2_TYPE_FILE_OPTION;
    instance->flag = option_flag;
    instance->cust_data = 0;

    mmi_ucs2ncpy(instance->file_path, (S8*)file_path, SRV_FMGR_PATH_MAX_LEN);
    FMGR_FILTER_INIT(&instance->filter_type);

    /* Set drv type, don't display unmounted memory card */
    instance->drv_type = SRV_FMGR_DRIVELIST_TYPE_ACCESSIBLE_ONLY;

    /* GUI */
    instance->display_type = FMGRI_DISPLAY_TYPE_NO_LIST;
    instance->dirty_level = 0;
    instance->cur_index = 0;
    instance->arrow_type = CAT213_ARROW_UP | CAT213_ARROW_DOWN;
    instance->key_binding = MMI_FMGRI_KEY_ALL;

    return mmi_fmgri_instance_get_screen_id(instance->id);
}

void cui_file_option_run(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/    
    SRV_FMGR_FILEINFO_HANDLE file_handle;
    mmi_fmgr_instance_struct *instance;
    mmi_fmgr_filetype_enum file_type;
    U16 opt_menu;
    S32 fs_ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);

    fs_ret = 0;
    do {
        if (mmi_fmgri_main_get_async_fs_state() != FMGR_ACTION_NONE)
        {
            FMGR2_DisplayPopupCB(instance, srv_fmgr_fs_error_get_string(FS_DEVICE_BUSY), MMI_EVENT_FAILURE);
            fs_ret = FS_DEVICE_BUSY;
            break;
        }

    #ifdef __USB_IN_NORMAL_MODE__
        if (srv_usb_is_in_mass_storage_mode())   /* Check is in mass storage mode */
        {
            FMGR3_DisplayPopup(GRP_ID_ROOT, STR_GLOBAL_NOT_AVAILABLE_IN_MASS_STORAGE_MODE, MMI_EVENT_FAILURE);
            fs_ret = MMI_FMGR_ERROR_USB_MODE;
            break;
        }
    #endif /* __USB_IN_NORMAL_MODE__ */

        /* Small screen!? */
        ASSERT(!mmi_is_redrawing_bk_screens());

        srv_fmgr_fileinfo_create((WCHAR *)instance->file_path, &file_handle);
        file_type = srv_fmgr_fileinfo_get_type(file_handle);
        opt_menu = srv_fmgr_types_get_option_menu(file_type, (WCHAR *)instance->file_path, instance->flag);
        srv_fmgr_fileinfo_destroy(file_handle);
        if (!opt_menu)
        {
            fs_ret = MMI_FMGR_ERROR_INVALID_PARAM;
            break;
        }

        mmi_fmgri_instance_general_entry_explorer(instance, NULL);
        
        /* Display option */
        mmi_fmgri_show_option_for_file_option_cui(mmi_fmgri_instance_get_screen_id(instance->id),
            opt_menu, fmgr_file_option_options_handler, 
            instance->id, instance->title_icon_id, 0, fmgr_file_option_entry_handler,
            MMI_FMGR_OPTION_TYPE_FULL_SCREEN, 0, srv_fmgr_path_get_filename_ptr((WCHAR *)instance->file_path));
    
    }while(0);

    if (fs_ret < 0)
    {
        fmgr_file_option_post_event(instance, fs_ret);
    }

}

void   cui_file_option_close(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_close(cui_id, MMI_FMGR2_TYPE_FILE_OPTION);
}

void   cui_file_option_set_title(mmi_id cui_id, U16 string, U16 icon)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_title(cui_id, MMI_FMGR2_TYPE_FILE_OPTION, string, icon);
}

void   cui_file_option_set_userdata(mmi_id cui_id, U32 userdata)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fmgr_cui_set_userdata(cui_id, MMI_FMGR2_TYPE_FILE_OPTION, userdata);
}
    
U32    cui_file_option_get_userdata(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return fmgr_cui_get_userdata(cui_id, MMI_FMGR2_TYPE_FILE_OPTION);
}

void   cui_file_option_set_app(mmi_id cui_id, U16 app_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_fmgr_instance_struct        *instance;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_fmgri_is_screen_id_valid(cui_id))
    {
        return;
    }

    instance = (mmi_fmgr_instance_struct*)mmi_frm_group_get_user_data(cui_id);
    instance->app_id = app_id;
    mmi_fmgri_instance_general_refresh(instance);
}

MMI_BOOL   cui_file_option_is_any_option(const WCHAR* file_path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_fmgri_get_file_option((S8*)file_path, TRUE, 0, 0) > 0)
    {
        return MMI_TRUE;
    }
    else
    {
        return MMI_FALSE;
    }
}
#endif

#define CUI_FILENAME_EDITOR

typedef struct _fmgr_filename_editor_struct
{
    mmi_id group_id;
    mmi_id editor_id;
    WCHAR* buffer;
    S32 buffer_size;
    S32 max_char_length;
    WCHAR* path;
    WCHAR* extension;
    U32 parent_data;
    U16 title_str, title_icon;
    MMI_BOOL encoding_base_length;

	//just for file manager call file name editor.
	S32 rename_type;   
} fmgr_filename_editor_struct;

static mmi_ret fmgr_filename_editor_proc(mmi_event_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_filename_editor_struct *context = (fmgr_filename_editor_struct*)param->user_data;
    cui_filename_editor_result_event_struct evt;
    mmi_popup_property_struct arg;
    WCHAR *ptr_src, *ptr_trg, *input_buffer = NULL;
    S32 ret, i = 0, len = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    

    switch (param->evt_id)
    {
        case EVT_ID_GROUP_DEINIT:
            if (context->path)
            {
                OslMfree(context->path);
            }
            if (context->extension)
            {
                OslMfree(context->extension);
            }
            OslMfree(context);
            break;
        
        case EVT_ID_CUI_FSEDITOR_SUBMMIT:
        case EVT_ID_CUI_FSEDITOR_ABORT:
            memset(&evt, 0, sizeof(evt));
            evt.evt_id = EVT_ID_CUI_FILENAME_EDITOR_RESULT;
            evt.size = sizeof(evt);
            evt.user_data = NULL;
            evt.sender_id = context->group_id;
            evt.filename = context->buffer;

            if (param->evt_id == EVT_ID_CUI_FSEDITOR_SUBMMIT)
            {
                input_buffer = OslMalloc(context->buffer_size);
                memset(input_buffer, 0, context->buffer_size);
                
                cui_fseditor_get_text(context->editor_id, input_buffer, context->buffer_size);

                /* Remove trailing space */
                if (context->extension == NULL)
                {
                    i = len = mmi_ucs2strlen((const CHAR *)input_buffer);
                    while (i > 0 && (input_buffer[(i-1)] == ' ' || input_buffer[(i-1)] == '.'))
                    {
                        i--;
                    }

                    if (i != len && i >= 0)
                    {
                        input_buffer[i] = 0;                    

                        if (context->buffer != NULL)
						    memcpy(context->buffer, input_buffer, context->buffer_size);
                        cui_fseditor_set_buffer(context->editor_id, (U8*)context->buffer, context->buffer_size, context->max_char_length);
                        if (!input_buffer[0])
                        {
                            /* The filename is invalid */
					        mmi_popup_property_init(&arg);
					        arg.parent_id = context->group_id;
					        mmi_popup_display((WCHAR*)GetString(STR_GLOBAL_INVALID_FILENAME), MMI_EVENT_FAILURE, &arg);
                            break;
                        }
                    }
                }
                /* Remove starting space */                
                /* Check for "." and ".." */
                ptr_src = NULL;				
				len = mmi_ucs2strlen((const CHAR *)input_buffer);
				i = 0;
				if (context->rename_type == FMGR_ACTION_RENAME_DRIVE)
				{
					while (i < len && input_buffer[i] == '.') i++;													
				}
				else 
				{
					while (i < len &&
						  (input_buffer[i] == '.' ||
						   input_buffer[i] == ' '))
					{
						i++;
					}					
				}

								
				if (i > 0)
				{
					if (i == len)
					{
						input_buffer[0]	= 0;
					}
					else
					{
						ptr_trg = input_buffer;
						ptr_src = input_buffer + i;
						/* Update the buffer */
						while (*ptr_src)
						{
							*ptr_trg = *ptr_src;
							ptr_trg++;
							ptr_src++;
						}
						*ptr_trg = 0;
					}					
					if (context->buffer != NULL)
						memcpy(context->buffer, input_buffer, context->buffer_size);
                    cui_fseditor_set_buffer(context->editor_id, (U8*)context->buffer, context->buffer_size, context->max_char_length);			
					/* The filename is invalid */
					mmi_popup_property_init(&arg);
					arg.parent_id = context->group_id;
					mmi_popup_display((WCHAR*)GetString(STR_GLOBAL_INVALID_FILENAME), MMI_EVENT_FAILURE, &arg);
					break;
				}
    
                /* Check for empty */
                if (!input_buffer[0])
                {
                    mmi_popup_property_init(&arg);
                    arg.parent_id = context->group_id;
                    mmi_popup_display((WCHAR*)GetString(STR_GLOBAL_PLEASE_INPUT_THE_FILENAME), MMI_EVENT_FAILURE, &arg);
                    break;
                }

                /* Check for file name validation */
                if (context->extension != NULL && (context->buffer_size-(len+1)*ENCODING_LENGTH) > ENCODING_LENGTH)
                {
                    mmi_wcscat(input_buffer, L" ");
                }

                if (srv_fmgr_path_is_filename_valid((const WCHAR*)input_buffer) == MMI_FALSE 
					&& !(context->rename_type == FMGR_ACTION_RENAME_DRIVE))
                {
                    mmi_popup_property_init(&arg);
                    arg.parent_id = context->group_id;
                    mmi_popup_display((WCHAR*)GetString(STR_GLOBAL_INVALID_FILENAME), MMI_EVENT_FAILURE, &arg);
                    break;
                }

                evt.result = 1;

                /* Check for path exist */
                if (context->path)
                {
                    ptr_src = (WCHAR*)mmi_fmgri_get_and_lock_buffer();

                    ret = cui_filename_editor_get_fullpath(context->group_id, ptr_src, SRV_FMGR_PATH_BUFFER_SIZE);
                    if (ret == FS_PATH_OVER_LEN_ERROR)
                    {
                        evt.result = FS_PATH_OVER_LEN_ERROR;
                    }
                    else if (ret == 0 && FS_GetAttributes(ptr_src) >= 0)
                    {
                        evt.result = FS_FILE_EXISTS;
                    }

                    mmi_fmgri_free_and_unlock_buffer((S8*)ptr_src);
                }
            
            }
            else
            {
                evt.result = 0;
            }

            if (evt.result == 1)
            {
                cui_fseditor_get_text(context->editor_id, context->buffer, context->buffer_size);
            }

            mmi_frm_group_post_to_caller(context->group_id, (mmi_group_event_struct*)&evt);
            break;
    }

    if (input_buffer != NULL)
    {
        OslMfree(input_buffer);
    }
    return MMI_RET_OK;
}

mmi_id cui_filename_editor_create(mmi_id parent, WCHAR* name_buf, S32 name_buf_size, S32 max_char_length, 
                                   const WCHAR* path, const WCHAR* extension)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_filename_editor_struct *context;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    context = OslMalloc(sizeof(fmgr_filename_editor_struct));
    memset(context, 0, sizeof(fmgr_filename_editor_struct));

    context->buffer = name_buf;
    context->buffer_size = name_buf_size;
    context->max_char_length = max_char_length;
	context->rename_type = NULL;
    if (path)
    {
        context->path = OslMalloc((mmi_wcslen(path)+1)*ENCODING_LENGTH);
        mmi_wcscpy(context->path, path);
    }
    if (extension)
    {
        context->extension= OslMalloc((mmi_wcslen(extension)+1)*ENCODING_LENGTH);
        mmi_wcscpy(context->extension, extension);
    }
    context->group_id = mmi_frm_group_create(parent, GRP_ID_AUTO_GEN, fmgr_filename_editor_proc, context);

    return context->group_id;
}

void cui_filename_editor_run(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_filename_editor_struct *context;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_group_enter(cui_id, MMI_FRM_NODE_NONE_FLAG);
    
    context = (fmgr_filename_editor_struct *)mmi_frm_group_get_user_data(cui_id);
    context->editor_id = cui_fseditor_create(cui_id);

    cui_fseditor_set_buffer(context->editor_id, (U8*)context->buffer, context->buffer_size, context->max_char_length);
    if (context->title_str || context->title_icon)
    {
        cui_fseditor_set_title(context->editor_id, context->title_str, context->title_icon);
    }
    if(context->rename_type == FMGR_ACTION_RENAME_DRIVE)
    {
        cui_fseditor_set_characters_filter(context->editor_id, MMI_FALSE, (const UI_character_type *)srv_fmgr_drv_get_invalid_chars());
    }
    else
    {
        cui_fseditor_set_characters_filter(context->editor_id, MMI_FALSE, (const UI_character_type *)srv_fmgr_path_get_invalid_chars());
    }
    if (context->encoding_base_length)
    {
        cui_fseditor_set_input_method(context->editor_id, IMM_INPUT_TYPE_SENTENCE|INPUT_TYPE_USE_ENCODING_BASED_LENGTH, NULL, INPUT_TYPE_EXT_NO_SHOW_NEW_LINE_SYMBOL|INPUT_TYPE_EXT_ASCII_ENCODING_BASE_LENGTH);
    }
    else
    {
        cui_fseditor_set_input_method(context->editor_id, IMM_INPUT_TYPE_SENTENCE, NULL, INPUT_TYPE_EXT_NO_SHOW_NEW_LINE_SYMBOL);
    }
    cui_fseditor_run(context->editor_id);
}

void    cui_filename_editor_close(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_frm_group_close(cui_id);
}

void    cui_filename_editor_set_title(mmi_id cui_id, U16 string, U16 icon)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_filename_editor_struct *context;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    context = (fmgr_filename_editor_struct *)mmi_frm_group_get_user_data(cui_id);

    context->title_str = string;
#ifndef __MMI_MAINLCD_96X64__
    context->title_icon = icon;
#else
    context->title_icon = 0;
#endif /* __MMI_MAINLCD_96X64__ */
    
    if(context->editor_id)
    {
        cui_fseditor_set_title(context->editor_id, string, icon);
    }
}

void    cui_filename_editor_set_encoding_base_length(mmi_id cui_id, MMI_BOOL encoding_base_length)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_filename_editor_struct *context;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    context = (fmgr_filename_editor_struct *)mmi_frm_group_get_user_data(cui_id);

    context->encoding_base_length = encoding_base_length;
    
    if(encoding_base_length && context->editor_id)
    {
        cui_fseditor_set_input_method(context->editor_id, IMM_INPUT_TYPE_SENTENCE|INPUT_TYPE_USE_ENCODING_BASED_LENGTH, NULL, INPUT_TYPE_EXT_NO_SHOW_NEW_LINE_SYMBOL);
    }
}

void    cui_filename_editor_set_parent_data(mmi_id cui_id, U32 data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_filename_editor_struct *context;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    context = (fmgr_filename_editor_struct *)mmi_frm_group_get_user_data(cui_id);
    context->parent_data = data;
}

U32     cui_filename_editor_get_parent_data(mmi_id cui_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_filename_editor_struct *context;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    context = (fmgr_filename_editor_struct *)mmi_frm_group_get_user_data(cui_id);
    return context->parent_data;
}

S32     cui_filename_editor_get_fullpath(mmi_id cui_id, WCHAR* path_buf, S32 path_buf_size)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_filename_editor_struct *context;
    S32 len;
    WCHAR *buffer;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    context = (fmgr_filename_editor_struct *)mmi_frm_group_get_user_data(cui_id);

    buffer = OslMalloc(context->buffer_size);
    memset(buffer, 0, context->buffer_size);
    cui_fseditor_get_text(context->editor_id, buffer, context->buffer_size);
    len = mmi_wcslen(buffer);

    if (context->path)
    {
        len += mmi_wcslen(context->path);
    }

    if (context->extension)
    {
        len += mmi_wcslen(context->extension)+1;
    }

    if (len*ENCODING_LENGTH >= path_buf_size)
    {
        OslMfree(buffer);
        return FS_PATH_OVER_LEN_ERROR;
    }

    if (context->path)
    {
        mmi_wcscpy(path_buf, context->path);
        mmi_wcscat(path_buf, buffer);
    }
    else
    {
        mmi_wcscpy(path_buf, buffer);
    }

    if (context->extension)
    {
        mmi_wcscat(path_buf, L".");
        mmi_wcscat(path_buf, context->extension);
    }

    OslMfree(buffer);
    return 0;
}

//add by shuo
void cui_filename_editor_set_rename_type(mmi_id cui_id, S32 type)
{
	/*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    fmgr_filename_editor_struct *context;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    context = (fmgr_filename_editor_struct *)mmi_frm_group_get_user_data(cui_id);
	context->rename_type = type;
}
#endif  /* __MMI_FILE_MANAGER__ */

