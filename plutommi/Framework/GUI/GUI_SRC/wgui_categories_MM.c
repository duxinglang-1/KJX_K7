/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 *   wgui_categories_MM.c
 *
 * Project:
 * --------
 *   Maui_Software
 *
 * Description:
 * ------------
 *  Main Menu related categories.
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#include "MMI_features.h"
#include "CustDataProts.h"
#include "CustMenuRes.h"
#include "CustThemesRes.h"
#include "MainMenuDef.h"
#ifdef __MMI_TOUCH_SCREEN__
#endif 
#include "SATGProts.h"
#include "app_mem.h"

#include "wgui_fixed_menuitems.h"

#include "gui_font_size.h"

#include "mmi_rp_app_mainmenu_def.h"

#include "MMIDataType.h"
#include "kal_general_types.h"
#include "gui_data_types.h"
#include "wgui_categories_MM.h"
#include "gui_buttons.h"
#include "gdi_datatype.h"
#include "gui_effect_oem.h"
#include "gui_config.h"
#include "gui.h"
#include "gdi_const.h"
#include "gdi_include.h"
#include "gui_typedef.h"
#include "wgui.h"
#include "wgui_categories_util.h"
#include "wgui_inputs.h"
#include "gui_themes.h"
#include "wgui_include.h"
#include "wgui_title.h"
#include "gui_title_pre_oem.h"
#include "gui_menu_shortcut.h"
#include "mmi_frm_events_gprot.h"
#include "gui_windows.h"
#include "wgui_fixed_menus.h"
#include "gui_fixed_menus.h"
#include "wgui_draw_manager.h"
#include "gui_theme_struct.h"
#include "gui_fixed_menuitems.h"
#include "gui_title.h"
#include "wgui_categories_enum.h"
#include "GlobalConstants.h"
#include "mmi_frm_input_gprot.h"
#include "gui_switch.h"
#include "kal_public_api.h"
#include "DebugInitDef_Int.h"
#include "globalresdef.h"

#include "wgui_asyncdynamic_menus.h"
#if defined(__MMI_MAINMENU_SPREAD_SUPPORT__)
#include "AppMgrSrvGprot.h"
#endif

/************ Global Variables *************/
extern S32 wgui_current_pop_up_description_index;
extern MMI_BOOL g_wgui_use_thick;

#ifdef __MMI_UI_TITLE_TRANSITION__
extern void set_title_transition(wgui_transition_styles style);
extern void reset_title_transition(void);
#endif /* __MMI_UI_TITLE_TRANSITION__ */ 
#ifdef __MMI_UI_MM_HORIZONTAL_PAGE_STYLE__
extern void register_horizontal_fixed_list_keys(void);
#endif 
extern void standard_animated_matrix_highlight_handler_type2(S32 item_index);

UI_string_type MMI_bg_string;
PU8 MMI_bg_image;
PU8 MMI_bg_animation;
S32 main_menu_index = -1;

#if (ENABLE_DIRECT_MAIN_MENU_IMPLEMENTATION)

/* Direct main menu implementation                                */
/* Matrix main menu: Fixed number of items with all items being visible */
#define MAIN_MENU_TEXT_AREA_HEIGHT                  22
#define MAIN_MENU_TEXT_GAP                          5

extern U16 title_bg_id;
extern icontext_button MMI_softkeys[];

extern void _show_bitmap(S32 x1, S32 y1, bitmap *b);
extern void _get_bitmap(S32 x1, S32 y1, S32 x2, S32 y2, bitmap *b);
extern void (*MMI_matrix_highlight_handler) (S32 index);

/* structure of matrix menu */
/* Store current main menu type..matrix,list,circular */
S32 MMI_main_menu_type = MATRIX_MENU;
U16 gMainMenuAnimation[MAX_MAIN_MENU_ITEMS];
U16 gMainMenuTitleIcon[MAX_MAIN_MENU_ITEMS];

#if defined(__MMI_MAINLCD_240X400__)
U16 gMainMenuControlAreaImg[MAX_MAIN_MENU_ITEMS];
#endif

/* 082806 240x320 matrix Start */
#if defined (__MMI_WALLPAPER_ON_BOTTOM__)
static MMI_ID_TYPE mm_bg_ID;
static S8 *mm_bg_filename;
static S32 mm_bg_x, mm_bg_y;
static U8 mm_bg_opacity;
static S32 mm_bg_flags;
#endif /* defined (__MMI_WALLPAPER_ON_BOTTOM__) */ 
/* 082806 240x320 matrix End */

#endif /* (ENABLE_DIRECT_MAIN_MENU_IMPLEMENTATION) */ 

/* For 3D circular main menu */
extern gdi_handle animation_handle;
extern gdi_handle wgui_base_layer;

#ifdef __MMI_SCREEN_SWITCH_EFFECT__
extern gui_image_text_rect matrix_mm_rect[];

/* LSK key up handler for matrix main menu SSE */
static FuncPtr g_wgui_category_sse_matrix_main_menu_old_lsk_hdlr;
/* old matrix main menu highlight handler */
static void (*g_wgui_category_sse_matrix_main_menu_old_highlight_hdlr)(S32 i);
static void wgui_category_sse_matrix_main_menu_highlight_hdlr(S32 index);
/* custom SSE effect handler for main menu */
static gui_screen_switch_effect_custom_return_code_enum
    wgui_category_sse_main_menu_custom_handler(
        gui_screen_switch_effect_stage_enum stage_type,
        gui_screen_switch_effect_custom_param_struct *param);
#endif /* __MMI_SCREEN_SWITCH_EFFECT__ */


/*****************************************************************************
 * FUNCTION
 *  draw_bg_animation
 * DESCRIPTION
 *  Displays the background image for new mainmenu category
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void draw_bg_animation(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 iw, ih;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_measure_image(MMI_bg_animation, &iw, &ih);
    if (animation_handle != GDI_ERROR_HANDLE)
    {
        gdi_image_stop_animation(animation_handle);
    }
    wgui_set_animation_image(MMI_content_width - iw, UI_device_height - MMI_button_bar_height - ih, MMI_bg_animation);
    gui_set_clip(
        MMI_content_width - iw,
        UI_device_height - MMI_button_bar_height - ih,
        MMI_content_width - 1,
        UI_device_height - MMI_button_bar_height);
    gdi_image_draw_animation(
        MMI_content_width - iw,
        UI_device_height - MMI_button_bar_height - ih,
        MMI_bg_animation,
        &animation_handle);
}


/*****************************************************************************
 * FUNCTION
 *  draw_bg
 * DESCRIPTION
 *  Displays the background image for new mainmenu category
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void draw_bg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 iwidth, iheight, character_height, tx, w;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();
    gdi_layer_push_clip();
    gdi_layer_push_text_clip();
    gui_set_clip(0, 0, UI_device_width - 1, UI_device_height - 1);
    gdi_layer_set_text_clip(
        MMI_title_x,
        MMI_title_y,
        MMI_title_x + MMI_title_width - 1,
        MMI_title_y + MMI_title_height - 1);
    if (MMI_bg_image != NULL)
    {
        gui_measure_image(MMI_bg_image, &iwidth, &iheight);
        gui_show_image(0, 0, MMI_bg_image);
    }

    if (!mmi_fe_get_r2l_state())//kavin_modify_for_slim_category
    {
        tx = 2;
    }
    else
    {
        tx = MMI_title_width - 2;
    }

    if (MMI_bg_string != NULL)  /* Fix for long titles  */
    {
        S32 tw;

        if (! mmi_fe_get_r2l_state())
        {
            tw = MMI_title_width - tx;
        }
        else
        {
            tw = tx;
        }

        gui_set_font((UI_font_type)gui_font_get_type(GUI_FONT_SIZE_TITLE));
        gui_measure_string(MMI_bg_string, &w, &character_height);
        gui_set_text_color(*current_MMI_theme->title_text_color);
        gui_set_text_border_color(*current_MMI_theme->title_text_border_color);
        if (mmi_fe_get_r2l_state())
        {
            gui_move_text_cursor(
                MMI_title_x + tx + w,
                MMI_title_y + ((MMI_title_height >> 1) - (character_height >> 1)));
        }
        else
        {
            gui_move_text_cursor(MMI_title_x + tx, MMI_title_y + ((MMI_title_height >> 1) - (character_height >> 1)));
        }
#ifndef __MMI_TITLE_BAR_NO_ICON_SHCT__
        if (!wgui_title_is_disable_shortcut_display() && wgui_title_get_menu_shortcut_number() >= 0)
        {
            tw -= MMI_menu_shortcut_box.width;
            if (w < tw)
            {
                S32 _tx = tx;

                if (!mmi_fe_get_r2l_state())
                {
                    tx = tx + (tw >> 1) - (w >> 1); /* Centers the title */
                    if (tx < _tx)
                    {
                        tx = _tx;
                    }
                }
                else
                {
                    tx = (MMI_title_width >> 1) - (w >> 1);
                    tx += w;
                    if (tx > _tx)
                    {
                        tx = _tx;
                    }
                }
            }
        }
        else
#endif /*__MMI_TITLE_BAR_NO_ICON_SHCT__*/			
        {
            if (w < tw)
            {
                S32 _tx = tx;

                if (!mmi_fe_get_r2l_state())
                {
                    tx = (MMI_title_width >> 1) - (w >> 1);
                    if (tx < _tx)
                    {
                        tx = _tx;
                    }
                }
                else
                {
                    tx = (MMI_title_width >> 1) - (w >> 1);
                    tx += w;
                    if (tx > _tx)
                    {
                        tx = _tx;
                    }
                }
            }
        }
    #if defined(__MMI_DEFAULT_THEME_3__) || defined(__MMI_DEFAULT_THEME_1__)
        gui_print_truncated_borderd_text(
            MMI_title_x + tx,
            MMI_title_y + ((MMI_title_height >> 1) - (character_height >> 1)),
            tw,
            MMI_bg_string);
    #else /* defined(__MMI_DEFAULT_THEME_3__) || defined(__MMI_DEFAULT_THEME_1__) */ 
        gui_print_truncated_text(
            MMI_title_x + tx,
            MMI_title_y + ((MMI_title_height >> 1) - (character_height >> 1)),
            tw,
            MMI_bg_string);
    #endif /* defined(__MMI_DEFAULT_THEME_3__) || defined(__MMI_DEFAULT_THEME_1__) */ 
    }
    gdi_layer_unlock_frame_buffer();
    show_menu_shortcut();
    gdi_layer_blt_previous(
        MMI_title_x,
        MMI_title_y,
        MMI_title_x + MMI_title_width - 1,
        MMI_title_y + MMI_title_height - 1);
}

/*****************************************************************************
 * FUNCTION
 *  hide_main_menu_animation_frame
 * DESCRIPTION
 *  Hides the animating icon in a menu
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void hide_main_menu_animation_frame(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (MMI_main_menu_type)
    {
        case LIST_MENU:
            break;
        case MATRIX_MENU:
        case MATRIX_PAGE_MENU:
		#ifndef __MMI_UI_MENU_SLIM__
            gui_hide_fixed_matrix_menu_highlighted_item(&MMI_fixed_matrix_menu);
		#endif
            break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  draw_main_menu_list_type_title
 * DESCRIPTION
 *  Redraw the title in category14 screen.
 *  Do not redraw status bar because that will let integrated title status icons gone.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void draw_main_menu_list_type_title(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    draw_title();
}


/*****************************************************************************
 * FUNCTION
 *  category14_main_menu_list_highlight_handler
 * DESCRIPTION
 *  highlight handler for main menu lsit of category 14
 * PARAMETERS
 *  item_index      [IN]        Index of current highlighted item
 * RETURNS
 *  void
 *****************************************************************************/
void category14_main_menu_list_highlight_handler(S32 item_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if(TITLE_TRANSITION_STYLE_NON_BLOCKING)
    if (MMI_main_menu_type == PAGE_MENU)
    {
        wgui_stop_transition_title_non_blocking();
        reset_title_transition();
    }
#ifndef TITLE_TRANSITION_WITH_PREVIOUS_TITLE_MOVEMENT
    set_previous_title_shortcut(wgui_title_get_menu_shortcut_number());
#endif 
#endif /* (TITLE_TRANSITION_STYLE_NON_BLOCKING) */ 
    wgui_title_set_menu_shortcut_number(item_index + 1);

    MMI_highlighted_item_text = get_item_text(item_index);
    MMI_title_string = MMI_highlighted_item_text;
    gdi_layer_lock_frame_buffer();
	MMI_user_highlight_handler_Ext((U8)eListhighlight, item_index);

#ifndef __MMI_TITLE_BAR_NO_ICON_SHCT__
    if (!wgui_title_get_menu_shortcut_handler_display())
    {
        draw_main_menu_list_type_title();
    }
#endif/*__MMI_TITLE_BAR_NO_ICON_SHCT__*/
    gui_hide_animations();

#ifdef __MMI_MAINLCD_320X240__
    /* change page background images */
    if (MMI_current_menu_type == PAGE_MENU)
    {
        dm_set_scr_bg_image(gMainMenuAnimation[item_index], NULL, -1, -1, 255);       
        /* check GDI_ERROR_HANDLE to prevent the goto item before the SCR BG layer is created. */
        /*if (dm_get_scr_bg_layer() != GDI_ERROR_HANDLE)
        {
            dm_draw_scr_bg_image();
        }*/
    }
#endif /* __MMI_MAINLCD_320X240__ */

    MMI_fixed_list_menu.item_display_function(
                            MMI_fixed_list_menu.items[MMI_fixed_list_menu.highlighted_item],
                            MMI_fixed_list_menu.common_item_data,
                            MMI_fixed_list_menu.x,
                            MMI_fixed_list_menu.y);

    gdi_layer_unlock_frame_buffer();
#ifdef __MMI_UI_TITLE_TRANSITION__
    if (MMI_main_menu_type == PAGE_MENU && is_mmi_title_transition_on_keys() == 0)
    {
        U16 keyCode, keyType;

        GetkeyInfo(&keyCode, &keyType);
    #ifdef __MMI_UI_MM_HORIZONTAL_PAGE_STYLE__
        if (keyCode == KEY_RIGHT_ARROW)
    #else 
        if (keyCode == KEY_DOWN_ARROW || keyCode == KEY_VOL_DOWN)
    #endif 
        {
            set_title_transition(WGUI_TRANSITION_L2R);
            draw_title();
        #if(!TITLE_TRANSITION_STYLE_NON_BLOCKING)
            reset_title_transition();
        #endif 
        }
        else
    #ifdef __MMI_UI_MM_HORIZONTAL_PAGE_STYLE__
        if (keyCode == KEY_LEFT_ARROW)
    #else 
        if (keyCode == KEY_UP_ARROW || keyCode == KEY_VOL_UP)
    #endif 
        {

            set_title_transition(WGUI_TRANSITION_R2L);
            draw_title();
        #if(!TITLE_TRANSITION_STYLE_NON_BLOCKING)
            reset_title_transition();
        #endif 
        }

    }
    else if (MMI_main_menu_type == PAGE_MENU && is_mmi_title_transition_on_keys() == 1)
    {
        draw_title();
    #if(!TITLE_TRANSITION_STYLE_NON_BLOCKING)
        reset_title_transition();
    #endif 
    }
#endif /* __MMI_UI_TITLE_TRANSITION__ */ 
    gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);
}


/*****************************************************************************
 * FUNCTION
 *  initialize_mainmenu_title_icons
 * DESCRIPTION
 *  Called once during bootup to initialize category screens
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void initialize_mainmenu_title_icons(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if !defined(__MMI_VUI_3D_MAINMENU__)
    S32 i = 0;
    MMI_MENU_ID mmi_menuitem_list[MAX_MAIN_MENU_ITEMS];
    S32 n_items;

    n_items = GetNumOfChild_Ext(IDLE_SCREEN_MENU_ID);
    GetSequenceItemIds_Ext(IDLE_SCREEN_MENU_ID, mmi_menuitem_list);
    for (i = 0; i < n_items; i++)
    {
        gMainMenuTitleIcon[i] = mmi_res_get_mainmenu_img(mmi_menuitem_list[i], MMI_RG_MM_IMG_TITLE);
    }
#endif
}

#if defined(__MMI_MAINLCD_240X400__)
/*****************************************************************************
 * FUNCTION
 *  initialize_mainmenu_controlarea_image
 * DESCRIPTION
 *  Called once during bootup to initialize category screens
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void initialize_mainmenu_controlarea_image(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i = 0;
    MMI_MENU_ID mmi_menuitem_list[MAX_MAIN_MENU_ITEMS];
    S32 n_items;

#if !defined(__MMI_VUI_MAINMENU__) 
    n_items = GetNumOfChild_Ext(IDLE_SCREEN_MENU_ID);
    GetSequenceItemIds_Ext(IDLE_SCREEN_MENU_ID, mmi_menuitem_list);
    for (i = 0; i < n_items; i++)
    {
        gMainMenuControlAreaImg[i] = mmi_res_get_mainmenu_img(mmi_menuitem_list[i], MMI_RG_MM_IMG_MATRIX_CTRL_AREA);
    }
#endif
}
#endif


#if defined (__MMI_MAINLCD_240X400__) 
/*****************************************************************************
 * FUNCTION
 *  main_menu_custom_highlight_handler
 * DESCRIPTION
 *  
 * PARAMETERS
 *  index       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void category14_redraw_controlarea_callback(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 w, h, x1, x2, y1, y2, x, y;
    stFontAttribute title_font;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (MMI_main_menu_type == MATRIX_PAGE_MENU)
    {        
        gui_measure_image(get_image(gMainMenuControlAreaImg[main_menu_index]), &w, &h);
        
        x1 = coordinate->s16X;
        y1 = coordinate->s16Y;
        x2 = x1 + coordinate->s16Width - 1;
        y2 = y1 + coordinate->s16Height - 1;
        gui_push_clip();
        gui_set_clip(x1, y1, x2, y2);
        gdi_draw_solid_rect(x1, y1, x2, y2, GDI_COLOR_TRANSPARENT);
        x = x1 + coordinate->s16Width - w;
        y = y1 + coordinate->s16Height - h;
        gui_show_image(x, y, get_image(gMainMenuControlAreaImg[main_menu_index]));

        title_font = *g_wgui_title_bar.normal_font;
        title_font.size = LARGE_FONT;
        title_font.bold = 2;
        gui_set_font(&title_font);        
        gui_measure_string((UI_string_type)get_item_text(main_menu_index), &w, &h);
        gui_set_text_color(*current_MMI_theme->main_menu_title_color);
        gui_set_text_border_color(*current_MMI_theme->main_menu_title_border_color);
        gui_set_line_height(h);
        if (!mmi_fe_get_r2l_state())
        {
            if (coordinate->s16Width > MAIN_MENU_CONTROL_AREA_X_GAP + w)
            {
                gui_move_text_cursor(coordinate->s16Width - MAIN_MENU_CONTROL_AREA_X_GAP - w, MAIN_MENU_CONTROL_AREA_Y_GAP);
                gui_print_bordered_text(get_item_text(main_menu_index));
            }
            else
            {
                gui_move_text_cursor(MAIN_MENU_CONTROL_AREA_X_GAP, MAIN_MENU_CONTROL_AREA_Y_GAP);            
                gui_print_truncated_borderd_text(MAIN_MENU_CONTROL_AREA_X_GAP, MAIN_MENU_CONTROL_AREA_Y_GAP, 
                    coordinate->s16Width - MAIN_MENU_CONTROL_AREA_X_GAP * 2 - 1, (UI_string_type)get_item_text(main_menu_index));
            }
        }
        else
        {   
            if (coordinate->s16Width > MAIN_MENU_CONTROL_AREA_X_GAP + w)
            {
                gui_move_text_cursor(MAIN_MENU_CONTROL_AREA_X_GAP + w, MAIN_MENU_CONTROL_AREA_Y_GAP);
                gui_print_bordered_text(get_item_text(main_menu_index));
            }
            else
            {
                gui_move_text_cursor(MAIN_MENU_CONTROL_AREA_X_GAP + w, MAIN_MENU_CONTROL_AREA_Y_GAP);
                gui_print_truncated_borderd_text(MAIN_MENU_CONTROL_AREA_X_GAP + w, MAIN_MENU_CONTROL_AREA_Y_GAP, 
                    coordinate->s16Width - MAIN_MENU_CONTROL_AREA_X_GAP * 2 - 1, (UI_string_type)get_item_text(main_menu_index));            
            }
        }
        
        gui_pop_clip();
        gdi_layer_blt_previous(x1, y1, x2, y2);
    }
}
#endif


#if defined(__MMI_MAINMENU_SPREAD_SUPPORT__)

#if defined(__MMI_MAINLCD_176X220__)
#define WUGI_MM_MATRIX_ITEM_NUM_X          (3)
#define WUGI_MM_MATRIX_ITEM_NUM_Y          (3)
#elif defined(__MMI_MAINLCD_240X320__)
#define WUGI_MM_MATRIX_ITEM_NUM_X          (3)
#define WUGI_MM_MATRIX_ITEM_NUM_Y          (4)
#elif defined(__MMI_MAINLCD_240X400__)
#define WUGI_MM_MATRIX_ITEM_NUM_X          (3)
#define WUGI_MM_MATRIX_ITEM_NUM_Y          (4)
#elif defined(__MMI_MAINLCD_320X480__)
#define WUGI_MM_MATRIX_ITEM_NUM_X          (3)
#define WUGI_MM_MATRIX_ITEM_NUM_Y          (4)
#else
#define WUGI_MM_MATRIX_ITEM_NUM_X          (3)
#define WUGI_MM_MATRIX_ITEM_NUM_Y          (4)
#endif /* __MMI_MAINLCD_176X220__ */

#define WUGI_MM_MATRIX_ITEM_BADGE_GAP      (2)

static srv_app_info_struct* wgui_cat9015_app_package_info = NULL;


void wgui_cat9015_post_display_callback(void *item, void *common_item_data, S32 x, S32 y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 badge_w, badge_h, image_w, image_h, item_w, item_h;
    S32 item_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    fixed_icontext_menuitem *m = (fixed_icontext_menuitem*) common_item_data;
    item_w = m->width - 10;
    item_h = m->height - 10;
    if (item_w > item_h)
    {
        item_w = item_h;
    }
    else
    {
        item_h = item_w;
    }

    item_index = MMI_fixed_matrix_menu.current_display_item;
    if (item_index == -1)
    {
        item_index = MMI_fixed_matrix_menu.highlighted_item;
    }

    if (wgui_cat9015_app_package_info[item_index].image.type ==  MMI_IMAGE_SRC_TYPE_PATH)
    {
        gdi_image_get_dimension_file((CHAR*)wgui_cat9015_app_package_info[item_index].image.data.path, &image_w, &image_h);
        gui_push_clip();

        if ((image_w > item_w) || (image_h > item_h))
        {
            gui_set_clip(
                x + ((m->width - item_w)>>1), 
                y + ((m->height - item_h)>>1), 
                x + ((m->width - item_w)>>1) + item_w, 
                y + ((m->height - item_h)>>1) + item_h);

            gdi_image_draw_resized_file(
                x + ((m->width - item_w)>>1), 
                y + ((m->height - item_h)>>1), 
                item_w - 1, 
                item_h - 1, 
                wgui_cat9015_app_package_info[item_index].image.data.path);
        }
        else
        {
            gui_set_clip(
                x + ((m->width - image_w)>>1), 
                y + ((m->height - image_h)>>1), 
                x + ((m->width - image_w)>>1) + image_w, 
                y + ((m->height - image_h)>>1) + image_h);

            gdi_image_draw_file(
                x + ((m->width - image_w) >> 1), 
                y + ((m->height - image_h) >> 1), 
                wgui_cat9015_app_package_info[item_index].image.data.path);
        }

        gui_pop_clip();
    }
    else if (wgui_cat9015_app_package_info[item_index].image.type ==  MMI_IMAGE_SRC_TYPE_ROM_MEMORY)
    {
        U16 image_type = gdi_image_get_type_from_mem(wgui_cat9015_app_package_info[item_index].image.data.image.image_ptr);
        gdi_image_get_dimension_mem(
            (U8)image_type,
            wgui_cat9015_app_package_info[item_index].image.data.image.image_ptr,
            (S32)wgui_cat9015_app_package_info[item_index].image.data.image.image_len, 
            &image_w, 
            &image_h);

        gui_push_clip();

        if ((image_w > item_w) || (image_h > item_h))
        {
            gui_set_clip(
                x + ((m->width - item_w)>>1), 
                y + ((m->height - item_h)>>1), 
                x + ((m->width - item_w)>>1) + item_w, 
                y + ((m->height - item_h)>>1) + item_h);

            gdi_image_draw_resized_mem(
                x + ((m->width - item_w)>>1), 
                y + ((m->height - item_h)>>1),
                item_w - 1, 
                item_h - 1, 
                wgui_cat9015_app_package_info[item_index].image.data.image.image_ptr,
                (U8)image_type,
                (S32)wgui_cat9015_app_package_info[item_index].image.data.image.image_len);
        }
        else
        {
            gui_set_clip(
                x + ((m->width - image_w)>>1), 
                y + ((m->height - image_h)>>1), 
                x + ((m->width - image_w)>>1) + image_w, 
                y + ((m->height - image_h)>>1) + image_h);

            gdi_image_draw_mem(
                x + ((m->width - image_w) >> 1), 
                y + ((m->height - image_h) >> 1), 
                wgui_cat9015_app_package_info[item_index].image.data.image.image_ptr,
                (U8)image_type,
                (S32)wgui_cat9015_app_package_info[item_index].image.data.image.image_len);
        }

        gui_pop_clip();
    }

    gui_set_font(&MMI_small_font);
    gui_measure_string((UI_string_type)wgui_cat9015_app_package_info[item_index].badge, &badge_w, &badge_h);

    if (badge_w > 0)
    {
        badge_w += WUGI_MM_MATRIX_ITEM_BADGE_GAP*2;
        badge_h += WUGI_MM_MATRIX_ITEM_BADGE_GAP*2;

        gui_push_clip();
        gui_set_clip(x + item_w - 1 - badge_w, y, x + item_w - 1, y + badge_h);

        gdi_image_draw_resized(x + item_w - 1 - badge_w, y, badge_w, badge_h, get_image(MAIN_MENU_BADGE_BG_IMAGE));

        gui_set_text_color(gui_color(255, 255, 255));
        gui_move_text_cursor(x + item_w - 1 - badge_w + WUGI_MM_MATRIX_ITEM_BADGE_GAP, y + WUGI_MM_MATRIX_ITEM_BADGE_GAP + 1);
	    gui_print_text(wgui_cat9015_app_package_info[item_index].badge);

        gui_pop_clip();
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat9015_show
 * DESCRIPTION
 *  Displays the category9015 screen . this is a scrren to show main menu
 * PARAMETERS
 *  title                   [IN]        Title for the screen
 *  title_icon              [IN]        Icon displayed with the title
 *  left_softkey            [IN]        Left softkey label
 *  left_softkey_icon       [IN]        Left softkey icon
 *  right_softkey           [IN]        Right softkey label
 *  right_softkey_icon      [IN]        Right softkey icon
 *  number_of_items         [IN]        Number of items in the menu
 *  list_of_items_info      [IN]        Array of items
 *  highlighted_item        [IN]        Default item to be highlighted (if there is no history)
 *  history_buffer          [IN]        History buffer
 * RETURNS
 *  void
 *****************************************************************************/
void wgui_cat9015_show(
        U16 title,
        U16 title_icon,
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        S32 number_of_items,
        srv_app_info_struct *list_of_items_info,
        S32 highlighted_item,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;
    S32 i, shortcut_width;
    U8 h_flag;
    S32 ixsize, iysize;
    UI_window_title_theme matrix_title_theme;
    S32 cat_id = -1;
    //MMI_MENU_ID mmi_menuitem_list[MAX_MAIN_MENU_ITEMS];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_UI_LIST_HIGHLIGHT_EFFECTS__
    gui_block_list_effect();
#endif 
    gdi_layer_lock_frame_buffer();
    UI_disable_alignment_timers();
    wgui_title_set_menu_shortcut_number(-1);
    dm_add_softkey_id(left_softkey, right_softkey);
    MMI_main_menu_type = MATRIX_MENU & 0xf;
    MMI_current_menu_type = MATRIX_MENU & 0x0f;
    dm_add_title_id(title, title_icon);
    matrix_title_theme.active_text_color = *current_MMI_theme->main_menu_title_color;
    matrix_title_theme.text_border_color = *current_MMI_theme->main_menu_title_border_color;
    //GetSequenceItemIds_Ext(IDLE_SCREEN_MENU_ID, mmi_menuitem_list);
    if (g_wgui_use_thick)
    {
        matrix_title_theme.shortcut_text_color = current_thick_title_theme->shortcut_text_color;
        matrix_title_theme.text_font = current_thick_title_theme->text_font;
        matrix_title_theme.active_filler = current_thick_title_theme->active_filler;
    }
    else
    {
        matrix_title_theme.shortcut_text_color = current_window_title_theme->shortcut_text_color;
        matrix_title_theme.text_font = current_window_title_theme->text_font;
        matrix_title_theme.active_filler = current_window_title_theme->active_filler;
    }
    
    gui_title_set_theme(&g_wgui_title_bar, &matrix_title_theme);

    wgui_fixed_matrix_create_menu(
            number_of_items, 
            -1, 
            UI_MATRIX_MENU_DISABLE_SCROLLBAR, 
            0, 
            NULL);

        wgui_fixed_matrix_begin_add_one_item();
        for (i = 0; i < number_of_items; i++)
        {
            if (list_of_items_info[i].image.type == MMI_IMAGE_SRC_TYPE_RES_ID)
            {
                wgui_fixed_matrix_add_one_item(
                    i, 
                    (U8*)list_of_items_info[i].string, 
                    (U8*)get_image(list_of_items_info[i].image.data.res_id));
            }
            else if (list_of_items_info[i].image.type == MMI_IMAGE_SRC_TYPE_PATH)
            {
                wgui_fixed_matrix_add_one_item(
                    i, 
                    (U8*)list_of_items_info[i].string, 
                    (U8*)get_image(IMG_GLOBAL_L1));
            }else if (list_of_items_info[i].image.type == MMI_IMAGE_SRC_TYPE_ROM_MEMORY)
            {
                wgui_fixed_matrix_add_one_item(
                    i, 
                    (U8*)list_of_items_info[i].string, 
                    (U8*)get_image(IMG_GLOBAL_L2));
            }
            else
            {
                wgui_fixed_matrix_add_one_item(
                    i, 
                    (U8*)list_of_items_info[i].string, 
                    (U8*)get_image(IMG_GLOBAL_L3));
            }
        }
        MMI_fixed_matrix_menu.flags |= UI_MATRIX_MENU_LOOP | UI_MATRIX_MENU_FOR_MAINMENU | UI_MATRIX_MENU_DISABLE_SCROLLBAR;
    #if defined(__MMI_MAINMENU_MATRIX_LOOP__)
        MMI_fixed_matrix_menu.flags |= UI_MATRIX_MENU_VERTICAL_LOOP;
    #else
        MMI_fixed_matrix_menu.flags &= ~UI_MATRIX_MENU_VERTICAL_LOOP;
    #endif /* defined(__MMI_MAINMENU_MATRIX_LOOP__) */ 
        MMI_current_menu_type = MATRIX_MENU;

        set_MMI_matrix_main_menu_theme();
        gui_set_fixed_matrix_menu_theme(&MMI_fixed_matrix_menu, current_UI_theme->fixed_matrix_menu_theme);
        fixed_icontext_menuitem_apply_theme(current_UI_theme->fixed_icontext_menuitem_theme);
        register_fixed_matrix_highlight_handler(standard_animated_matrix_highlight_handler_type2);
        wgui_cat9015_app_package_info = list_of_items_info;
        set_fixed_icontext_menuitems_post_display(wgui_cat9015_post_display_callback);

    #ifdef __MMI_SCREEN_SWITCH_EFFECT__
        /* register the custom SSE effect handler */
        #if !defined(__MMI_OP11_HOMESCREEN_0301__) && !defined(__MMI_OP11_HOMESCREEN_0302__)
        gui_screen_switch_effect_register_custom_callback(wgui_category_sse_main_menu_custom_handler);
        #endif
        /* save the old matrix menu highlight handler */
        g_wgui_category_sse_matrix_main_menu_old_highlight_hdlr = MMI_fixed_matrix_menu.item_highlighted;
        /* override the matrix menu highlight handler to hook lsk handler */
        register_fixed_matrix_highlight_handler(wgui_category_sse_matrix_main_menu_highlight_hdlr);
    #endif /* __MMI_SCREEN_SWITCH_EFFECT__ */

#ifndef __MMI_MATRIX_MAIN_MENU_NO_TITLEBAR__
        wgui_fixed_matrix_move_menu(0, (MMI_title_y + MMI_title_height));
        wgui_fixed_matrix_resize_menu(MMI_content_width, MMI_content_height);
#endif

        ixsize = MMI_CONTENT_WIDTH / WUGI_MM_MATRIX_ITEM_NUM_X;
        iysize = MMI_CONTENT_HEIGHT /WUGI_MM_MATRIX_ITEM_NUM_Y;

    #ifdef __MMI_MAINLCD_320X240__
        configure_fixed_matrix(ixsize, iysize, 4, 0);
    #else /* __MMI_MAINLCD_320X240__ */
        configure_fixed_matrix(ixsize, iysize, 3, 0);
    #endif /* __MMI_MAINLCD_320X240__ */            
        wgui_fixed_matrix_end_add_one_item();
#ifndef __MMI_TITLE_BAR_NO_ICON_SHCT__	
        shortcut_width = set_menu_item_count(number_of_items) + 7;
#else
		shortcut_width = 7;
#endif/*__MMI_TITLE_BAR_NO_ICON_SHCT__*/
        resize_menu_shortcut_handler(shortcut_width, MMI_title_height);
        move_menu_shortcut_handler(UI_device_width - MMI_menu_shortcut_box.width, MMI_title_y);
#ifdef __MMI_MATRIX_MAIN_MENU_NO_TITLEBAR__
        set_fixed_icontext_positions(1, iysize - MAIN_MENU_TEXT_AREA_HEIGHT + MAIN_MENU_TEXT_GAP, 0, 0);
        MMI_fixed_icontext_menuitem.flags &= ~UI_MENUITEM_CENTER_ICON_Y;
        MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_CENTER_TEXT_X;
#else
        set_fixed_icontext_positions(0, 0, 0, 0);
        MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_DISABLE_TEXT_DISPLAY;
#endif
        wgui_title_disable_menu_shortcut_display(MMI_FALSE);
    #ifdef __MMI_WALLPAPER_ON_BOTTOM__ 
        dm_get_scr_bg_flag(&mm_bg_flags);
        dm_set_scr_bg_flag(mm_bg_flags | DM_SCR_BG_FORCE_SHOW);
    #endif

        h_flag = set_matrix_menu_category_history(MMI_CATEGORY14_MATRIX_ID, history_buffer);
        if (h_flag)
    #ifdef __MMI_WGUI_MINI_TAB_BAR__
            if (wgui_if_mini_tab_bar_in_parent() == MMI_TRUE)
            {
                S32 idx = (S32) wgui_mini_tab_bar_get_index();

                fixed_matrix_goto_item_no_redraw(idx);
            }
            else
    #endif /* __MMI_WGUI_MINI_TAB_BAR__ */ 
                fixed_matrix_goto_item_no_redraw(MMI_fixed_matrix_menu.highlighted_item);
        else
        {
            if (history_buffer != NULL && main_menu_index != -1)
            {
                highlighted_item = main_menu_index;
            }
            fixed_matrix_goto_item_no_redraw(highlighted_item);
        }
        MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_FOCUSSED_ANIMATE;
        SetKeyHandler(fixed_matrix_goto_previous_item, KEY_VOL_UP, KEY_EVENT_DOWN);
        SetKeyHandler(fixed_matrix_goto_next_item, KEY_VOL_DOWN, KEY_EVENT_DOWN);
        SetKeyHandler(fixed_matrix_goto_previous_item, KEY_VOL_UP, KEY_EVENT_REPEAT);
        SetKeyHandler(fixed_matrix_goto_next_item, KEY_VOL_DOWN, KEY_EVENT_REPEAT);
        cat_id = MMI_CATEGORY14_MATRIX_ID;

    #ifdef __MMI_MATRIX_MAIN_MENU_OPTIMIZE__
        /* allocate matrix highlight buffer from SCR ASM */      
        MMI_fixed_matrix_menu.buffer.buf_ptr = (U8*)applib_mem_screen_alloc(MMI_MAIN_MENU_MATRIX_HIGHLIGHTED_BUF_SIZE);
        MMI_ASSERT(MMI_fixed_matrix_menu.buffer.buf_ptr != NULL);
    #endif /* __MMI_MATRIX_MAIN_MENU_OPTIMIZE__ */

    gdi_layer_unlock_frame_buffer();

    ExitCategoryFunction = ExitCategory14Screen;
    UI_hide_animation_frame_function = hide_main_menu_animation_frame;
    dm_setup_category_functions(dm_redraw_category_screen, GetCategory14History, GetCategory14HistorySize);
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = cat_id;
    dm_data.s32flags = DM_CLEAR_SCREEN_BACKGROUND;
#ifdef __MMI_UI_MATRIX_MAIN_MENU_SCALING_EFFECT__
    if (MMI_current_menu_type == MATRIX_MENU)
    {
        dm_data.s32flags |= DM_SCR_BG_NO_CACHE;
    }
#endif /* __MMI_UI_MATRIX_MAIN_MENU_SCALING_EFFECT__ */   
    dm_setup_data(&dm_data);
    dm_redraw_category_screen();
}

#endif /* __MMI_MAINMENU_SPREAD_SUPPORT_) */


/*****************************************************************************
 * FUNCTION
 *  ShowCategory14Screen
 * DESCRIPTION
 *  Displays the category14 screen . this is a scrren to show main menu
 * PARAMETERS
 *  title                   [IN]        Title for the screen
 *  title_icon              [IN]        Icon displayed with the title
 *  left_softkey            [IN]        Left softkey label
 *  left_softkey_icon       [IN]        Left softkey icon
 *  right_softkey           [IN]        Right softkey label
 *  right_softkey_icon      [IN]        Right softkey icon
 *  number_of_items         [IN]        Number of items in the menu
 *  list_of_items           [IN]        Array of items
 *  list_of_icons           [IN]        Array of icons
 *  flags                   [IN]        (see explanation below)
 *  highlighted_item        [IN]        Default item to be highlighted (if there is no history)
 *  history_buffer          [IN]        History buffer
 * RETURNS
 *  void
 *****************************************************************************/
void ShowCategory14Screen(
        U16 title,
        U16 title_icon,
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        S32 number_of_items,
        U16 *list_of_items,
        U16 *list_of_icons,
        S32 flags,
        S32 highlighted_item,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;
    S32 i;
#if defined(__MMI_MAINMENU_LIST_SUPPORT__)||defined(__MMI_MAINMENU_PAGE_SUPPORT__)||defined(__MMI_MAINMENU_MATRIX_SUPPORT__)||defined(__MMI_MAINLCD_240X400__)	
	S32 shortcut_width;
#endif
    U8 h_flag;
    S32 ixsize, iysize;
    UI_window_title_theme matrix_title_theme;
    S32 cat_id = -1;
     MMI_MENU_ID mmi_menuitem_list[MAX_MAIN_MENU_ITEMS];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_UI_LIST_HIGHLIGHT_EFFECTS__
    gui_block_list_effect();
#endif 
    gdi_layer_lock_frame_buffer();
    UI_disable_alignment_timers();
    wgui_title_set_menu_shortcut_number(-1);
    dm_add_softkey_id(left_softkey, right_softkey);
    MMI_main_menu_type = flags & 0xf;
    MMI_current_menu_type = flags & 0x0f;
    dm_add_title_id(title, title_icon);
    matrix_title_theme.active_text_color = *current_MMI_theme->main_menu_title_color;
    matrix_title_theme.text_border_color = *current_MMI_theme->main_menu_title_border_color;
    GetSequenceItemIds_Ext(IDLE_SCREEN_MENU_ID, mmi_menuitem_list);
    if (g_wgui_use_thick)
    {
        matrix_title_theme.shortcut_text_color = current_thick_title_theme->shortcut_text_color;
        matrix_title_theme.text_font = current_thick_title_theme->text_font;
        matrix_title_theme.active_filler = current_thick_title_theme->active_filler;
    }
    else
    {
        matrix_title_theme.shortcut_text_color = current_window_title_theme->shortcut_text_color;
        matrix_title_theme.text_font = current_window_title_theme->text_font;
        matrix_title_theme.active_filler = current_window_title_theme->active_filler;
    }
    
    gui_title_set_theme(&g_wgui_title_bar, &matrix_title_theme);
#if defined(__MMI_MAINMENU_PAGE_SUPPORT__) || defined(__MMI_MAINMENU_LIST_SUPPORT__)
    if (((MMI_main_menu_type == LIST_MENU) ||
        (MMI_main_menu_type == PAGE_MENU)))
    {
        wgui_fixed_list_create_icontext_menu(
                number_of_items, 
                -1, 
                0, 
                0, 
                NULL);
    }
#endif
    if ((MMI_main_menu_type == MATRIX_MENU)
#if defined(__MMI_MAINMENU_240X400_SUPPORT_MATRIX_PAGE_MENU__)
             || (MMI_main_menu_type == MATRIX_PAGE_MENU))
#else
    )
#endif 
    {
        wgui_fixed_matrix_create_menu(
                number_of_items, 
                -1, 
                0, 
                0, 
                NULL);
    }

    switch (MMI_main_menu_type)
    {
#ifdef __MMI_MAINMENU_LIST_SUPPORT__
        case LIST_MENU:
            wgui_fixed_list_resize_icontext_menu(MMI_content_width, MMI_content_height + 2);
            resize_fixed_icontext_menuitems(0, MMI_content_height / MMI_UI_LIST_ROW_NUM);
            set_MMI_list_main_menu_theme();
            gui_set_fixed_list_menu_theme(&MMI_fixed_list_menu, current_UI_theme->fixed_list_menu_theme);
            fixed_icontext_menuitem_apply_theme(current_UI_theme->fixed_icontext_menuitem_theme);
            wgui_fixed_list_begin_add_icontext_one_item();
            for (i = 0; i < number_of_items; i++)
            {
                wgui_fixed_list_add_icontext_one_item(
                    i, 
                    (U8*)get_string(list_of_items[i]), 
                    wgui_get_list_menu_icon(i, list_of_icons[i]), 
                    NULL);
            #ifdef __MMI_MERGE_SAT_TO_MAINMENU__
            #ifndef BROWSER_SUPPORT
                if (IsSATPresent() && list_of_items[i] == MAIN_MENU_SERVICES_TEXT)
                {
                    MMI_fixed_icontext_menuitems[(*fixed_icontext_menu_n_items) - 1].item_text =
                        (UI_string_type) GetSATMainMenuAlphaID();
                }
            #endif /* BROWSER_SUPPORT */ 
            #endif /* __MMI_MERGE_SAT_TO_MAINMENU__ */ 
                gMainMenuTitleIcon[i] = mmi_res_get_mainmenu_img(mmi_menuitem_list[i],MMI_RG_MM_IMG_TITLE);
            }
            wgui_fixed_list_end_add_icontext_one_item();
#ifndef __MMI_TITLE_BAR_NO_ICON_SHCT__			
            shortcut_width = set_menu_item_count(number_of_items) + 7;
#else
            shortcut_width = 7;
#endif/*__MMI_TITLE_BAR_NO_ICON_SHCT__*/
            resize_menu_shortcut_handler(shortcut_width, MMI_title_height);
            move_menu_shortcut_handler(UI_device_width - MMI_menu_shortcut_box.width, MMI_title_y);
            gui_measure_image(MMI_fixed_icontext_menuitems[0].item_icon, &ixsize, &iysize);
            set_fixed_icontext_positions(ixsize + 2, 0, 1, 0);
            MMI_current_menu_type = LIST_MENU;
            resize_fixed_list_to_content_height();
            h_flag = set_list_menu_category_history(MMI_CATEGORY14_LIST_ID, history_buffer);
            MMI_fixed_list_menu.flags &= ~UI_LIST_MENU_DISABLE_SCROLLBAR;
            if (h_flag)
            {
                fixed_list_goto_item_no_redraw(MMI_fixed_list_menu.highlighted_item);
            }
            else
            {
                if (history_buffer != NULL && main_menu_index != -1)
                {
                    highlighted_item = main_menu_index;
                }
                fixed_list_goto_item_no_redraw(highlighted_item);
            }
            MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_FOCUSSED_ANIMATE;
            resize_fixed_icontext_menuitems_to_list_width();
            cat_id = MMI_CATEGORY14_LIST_ID;
            break;
#endif /* __MMI_MAINMENU_LIST_SUPPORT__*/
#ifdef __MMI_MAINMENU_PAGE_SUPPORT__
        case PAGE_MENU:
            /* Temporary:  Needs to be enhanced */
            gui_set_fixed_list_menu_theme(&MMI_fixed_list_menu, current_UI_theme->fixed_list_menu_theme);
            fixed_icontext_menuitem_apply_theme(current_UI_theme->fixed_icontext_menuitem_theme);


        #if(TITLE_TRANSITION_STYLE_NON_BLOCKING)
            enable_title_transition();
        #endif 
            wgui_fixed_list_resize_icontext_menu(MMI_content_width, MMI_content_height + 2);
            MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_DISABLE_TEXT_CLIP;
            wgui_fixed_list_begin_add_icontext_one_item();
            for (i = 0; i < number_of_items; i++)
            {
                /* Landscape page MM uses SCR BG images, not menu item icons. */
            #ifdef __MMI_MAINLCD_320X240__
                wgui_fixed_list_add_icontext_one_item(
                    i, 
                    (U8*)get_string(list_of_items[i]), 
                    NULL, 
                    NULL);
                /* save SCR BG image ID */
                gMainMenuAnimation[i] = list_of_icons[i];
            #else /* __MMI_MAINLCD_320X240__ */
                wgui_fixed_list_add_icontext_one_item(
                    i, 
                    (U8*)get_string(list_of_items[i]), 
                    get_image(list_of_icons[i]), 
                    NULL);
            #endif /* __MMI_MAINLCD_320X240__ */            

            #ifdef __MMI_MERGE_SAT_TO_MAINMENU__
            #ifndef BROWSER_SUPPORT
                if (IsSATPresent() && list_of_items[i] == MAIN_MENU_SERVICES_TEXT)
                {
                    MMI_fixed_icontext_menuitems[(*fixed_icontext_menu_n_items) - 1].item_text =
                        (UI_string_type) GetSATMainMenuAlphaID();
                }
            #endif /* BROWSER_SUPPORT */ 
            #endif /* __MMI_MERGE_SAT_TO_MAINMENU__ */ 

                gMainMenuTitleIcon[i] = mmi_res_get_mainmenu_img(mmi_menuitem_list[i],MMI_RG_MM_IMG_TITLE);
            }
            wgui_fixed_list_end_add_icontext_one_item();
        #ifdef __MMI_UI_MM_HORIZONTAL_PAGE_STYLE__
            ClearKeyHandler(KEY_VOL_UP, KEY_EVENT_DOWN);
            ClearKeyHandler(KEY_VOL_DOWN, KEY_EVENT_DOWN);
            ClearKeyHandler(KEY_VOL_UP, KEY_EVENT_REPEAT);
            ClearKeyHandler(KEY_VOL_DOWN, KEY_EVENT_REPEAT);
        #endif 
#ifndef __MMI_TITLE_BAR_NO_ICON_SHCT__		
            shortcut_width = set_menu_item_count(number_of_items) + 7;
#else
            shortcut_width = 7;
#endif
            resize_menu_shortcut_handler(shortcut_width, MMI_title_height);
            move_menu_shortcut_handler(UI_device_width - MMI_menu_shortcut_box.width, MMI_title_y);
            wgui_fixed_list_move_icontext_menu(0, (MMI_title_y + MMI_title_height));
            gui_measure_image(get_image(list_of_icons[0]), &ixsize, &iysize);
            wgui_fixed_list_resize_icontext_menu(MMI_content_width, MMI_content_height);
            register_fixed_list_highlight_handler(category14_main_menu_list_highlight_handler);
            if (MMI_content_height < iysize)
            {
                resize_fixed_icontext_menuitems(MMI_content_width, MMI_content_height);
            }
            else
            {
                resize_fixed_icontext_menuitems(MMI_content_width, MMI_content_height);
            }

        #ifdef __MMI_MAINLCD_240X320__
             #ifdef __MMI_MAINMENU_PAGE_SUPPORT__
            title_bg_id = MAIN_MENU_PAGE_TITLE_BG;
        #endif 
        #endif 

        #ifdef __MMI_WALLPAPER_ON_BOTTOM__
            #ifdef __MMI_MAINMENU_PAGE_SUPPORT__
            title_bg_id = MAIN_MENU_PAGE_TITLE_BG;
            #endif
            wgui_set_wallpaper_on_bottom(MMI_TRUE);
            dm_get_scr_bg_image(&mm_bg_ID, &mm_bg_filename, &mm_bg_x, &mm_bg_y, &mm_bg_opacity);
            #ifdef __MMI_MAINMENU_PAGE_SUPPORT__
            dm_set_scr_bg_image(IMG_MAIN_MENU_PAGE_BG, NULL, -1, -1, 255);
            #endif
            dm_get_scr_bg_flag(&mm_bg_flags);
            dm_set_scr_bg_flag(mm_bg_flags | DM_SCR_BG_FORCE_SHOW);
        #endif

            set_fixed_icontext_positions(0, 0, 0, (MMI_content_height - iysize) >> 1);
            MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_DISABLE_HIGHLIGHT | UI_MENUITEM_DISABLE_TEXT_DISPLAY;
            MMI_current_menu_type = PAGE_MENU;
            h_flag = set_list_menu_category_history(MMI_CATEGORY14_LIST_ID, history_buffer);
            MMI_fixed_list_menu.flags |= UI_LIST_MENU_DISABLE_SCROLLBAR;
            if (h_flag)
            {
                fixed_list_goto_item_no_redraw(MMI_fixed_list_menu.highlighted_item);
            }
            else
            {
                if (history_buffer != NULL && main_menu_index != -1)
                {
                    MMI_fixed_list_menu.highlighted_item = main_menu_index;
                    MMI_fixed_list_menu.first_displayed_item = main_menu_index;
                    MMI_fixed_list_menu.last_displayed_item = main_menu_index;
                    highlighted_item = main_menu_index;
                }
                fixed_list_goto_item_no_redraw(highlighted_item);
            }
            MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_FOCUSSED_ANIMATE;
            resize_fixed_icontext_menuitems_to_list_width();
            cat_id = MMI_CATEGORY14_LIST_ID;

		#ifdef __MMI_MAINLCD_96X64__
		    SetKeyHandler(fixed_list_goto_previous_item, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
    		SetKeyHandler(fixed_list_goto_next_item, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    		SetKeyHandler(fixed_list_goto_previous_item, KEY_LEFT_ARROW, KEY_EVENT_REPEAT);
    		SetKeyHandler(fixed_list_goto_next_item, KEY_RIGHT_ARROW, KEY_EVENT_REPEAT);
		#endif
            break;
#endif /* __MMI_MAINMENU_PAGE_SUPPORT__*/
#ifdef __MMI_MAINMENU_MATRIX_SUPPORT__
        case MATRIX_MENU:
            wgui_fixed_matrix_begin_add_one_item();
            for (i = 0; i < number_of_items; i++)
            {
        #if defined( __MMI_OP12_MENU_12MATRIX__)
            #ifdef __SAT__
                if (IsSATPresent() && srv_mode_switch_is_network_service_available())
                {
                    S32 index;

                    setup_scrolling_title();
                    index = GetChildMenuIDIndexByParentMenuID(IDLE_SCREEN_MENU_ID,MAIN_MENU_SAT_MENUID);
                    if (i == index)
                    {
                        wgui_fixed_matrix_add_one_item(
                            i, 
                            GetSATMainMenuAlphaID(), 
                            get_image(list_of_icons[i]));
                    }
                    else
                    {
                        wgui_fixed_matrix_add_one_item(
                            i, 
                            (U8*)get_string(list_of_items[i]), 
                            get_image(list_of_icons[i]));
                    }                    
                }
                else
            #endif
        #endif
                {
                    wgui_fixed_matrix_add_one_item(
                        i, 
                        (U8*)get_string(list_of_items[i]), 
                        get_image(list_of_icons[i]));
                }
            #ifdef __MMI_MERGE_SAT_TO_MAINMENU__
            #ifndef BROWSER_SUPPORT
                if (IsSATPresent() && list_of_items[i] == MAIN_MENU_SERVICES_TEXT)
                {
                    MMI_fixed_icontext_menuitems[(*fixed_icontext_menu_n_items) - 1].item_text =
                        (UI_string_type) GetSATMainMenuAlphaID();
                }
            #endif /* BROWSER_SUPPORT */ 
            #endif /* __MMI_MERGE_SAT_TO_MAINMENU__ */ 
                gMainMenuTitleIcon[i] = mmi_res_get_mainmenu_img(mmi_menuitem_list[i],MMI_RG_MM_IMG_TITLE);
                gMainMenuAnimation[i] = mmi_res_get_mainmenu_img(mmi_menuitem_list[i],MMI_RG_MM_IMG_MATRIX_HIGHLIGHT);
            }
            MMI_fixed_matrix_menu.flags |= UI_MATRIX_MENU_LOOP | UI_MATRIX_MENU_FOR_MAINMENU;
        #if defined(__MMI_MAINMENU_MATRIX_LOOP__)
            MMI_fixed_matrix_menu.flags |= UI_MATRIX_MENU_VERTICAL_LOOP;
        #else
            MMI_fixed_matrix_menu.flags &= ~UI_MATRIX_MENU_VERTICAL_LOOP;
        #endif /* defined(__MMI_MAINMENU_MATRIX_LOOP__) */ 
            MMI_current_menu_type = MATRIX_MENU;

            set_MMI_matrix_main_menu_theme();
            gui_set_fixed_matrix_menu_theme(&MMI_fixed_matrix_menu, current_UI_theme->fixed_matrix_menu_theme);
            fixed_icontext_menuitem_apply_theme(current_UI_theme->fixed_icontext_menuitem_theme);
            register_fixed_matrix_highlight_handler(standard_animated_matrix_highlight_handler_type2);

        #ifdef __MMI_SCREEN_SWITCH_EFFECT__
            /* register the custom SSE effect handler */
            #if !defined(__MMI_OP11_HOMESCREEN_0301__) && !defined(__MMI_OP11_HOMESCREEN_0302__)
            gui_screen_switch_effect_register_custom_callback(wgui_category_sse_main_menu_custom_handler);
            #endif
            /* save the old matrix menu highlight handler */
            g_wgui_category_sse_matrix_main_menu_old_highlight_hdlr = MMI_fixed_matrix_menu.item_highlighted;
            /* override the matrix menu highlight handler to hook lsk handler */
            register_fixed_matrix_highlight_handler(wgui_category_sse_matrix_main_menu_highlight_hdlr);
        #endif /* __MMI_SCREEN_SWITCH_EFFECT__ */

#ifndef __MMI_MATRIX_MAIN_MENU_NO_TITLEBAR__
            wgui_fixed_matrix_move_menu(0, (MMI_title_y + MMI_title_height));
            wgui_fixed_matrix_resize_menu(MMI_content_width, MMI_content_height);
#endif
            /* use image height as item height */
            gui_measure_image(get_image(list_of_icons[0]), &ixsize, &iysize);
			/*For launcher switch between Fruit launcher and matrix mainmenu, LQVGA(320X480) set 3 column, image size should <= 103*/
		#ifdef __MMI_LAUNCHER_APP_LIST__
			ixsize = (ixsize > 103) ? 103 : ixsize;
		#endif

#ifdef __MMI_MATRIX_MAIN_MENU_NO_TITLEBAR__
            iysize += MAIN_MENU_TEXT_AREA_HEIGHT;
#endif
            
        #ifdef __MMI_MAINLCD_320X240__
            configure_fixed_matrix(ixsize, iysize, 4, 0);
        #else /* __MMI_MAINLCD_320X240__ */
            configure_fixed_matrix(ixsize, iysize, 3, 0);
        #endif /* __MMI_MAINLCD_320X240__ */            
            wgui_fixed_matrix_end_add_one_item();
#ifndef __MMI_TITLE_BAR_NO_ICON_SHCT__		
            shortcut_width = set_menu_item_count(number_of_items) + 7;
#else
            shortcut_width =  7;
#endif/*__MMI_TITLE_BAR_NO_ICON_SHCT__*/
            resize_menu_shortcut_handler(shortcut_width, MMI_title_height);
            move_menu_shortcut_handler(UI_device_width - MMI_menu_shortcut_box.width, MMI_title_y);
#ifdef __MMI_MATRIX_MAIN_MENU_NO_TITLEBAR__
            set_fixed_icontext_positions(1, iysize - MAIN_MENU_TEXT_AREA_HEIGHT + MAIN_MENU_TEXT_GAP, 0, 0);
            MMI_fixed_icontext_menuitem.flags &= ~UI_MENUITEM_CENTER_ICON_Y;
            MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_CENTER_TEXT_X;
#else
            set_fixed_icontext_positions(0, 0, 0, 0);
            MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_DISABLE_TEXT_DISPLAY;
#endif
            wgui_title_disable_menu_shortcut_display(MMI_FALSE);
        #ifdef __MMI_WALLPAPER_ON_BOTTOM__ 
            dm_get_scr_bg_flag(&mm_bg_flags);
            dm_set_scr_bg_flag(mm_bg_flags | DM_SCR_BG_FORCE_SHOW);
        #endif

            h_flag = set_matrix_menu_category_history(MMI_CATEGORY14_MATRIX_ID, history_buffer);
            if (h_flag)
        #ifdef __MMI_WGUI_MINI_TAB_BAR__
                if (wgui_if_mini_tab_bar_in_parent() == MMI_TRUE)
                {
                    S32 idx = (S32) wgui_mini_tab_bar_get_index();

                    fixed_matrix_goto_item_no_redraw(idx);
                }
                else
        #endif /* __MMI_WGUI_MINI_TAB_BAR__ */ 
                    fixed_matrix_goto_item_no_redraw(MMI_fixed_matrix_menu.highlighted_item);
            else
            {
                if (history_buffer != NULL && main_menu_index != -1)
                {
                    highlighted_item = main_menu_index;
                }
                fixed_matrix_goto_item_no_redraw(highlighted_item);
            }
            MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_FOCUSSED_ANIMATE;
            SetKeyHandler(fixed_matrix_goto_previous_item, KEY_VOL_UP, KEY_EVENT_DOWN);
            SetKeyHandler(fixed_matrix_goto_next_item, KEY_VOL_DOWN, KEY_EVENT_DOWN);
            SetKeyHandler(fixed_matrix_goto_previous_item, KEY_VOL_UP, KEY_EVENT_REPEAT);
            SetKeyHandler(fixed_matrix_goto_next_item, KEY_VOL_DOWN, KEY_EVENT_REPEAT);
            cat_id = MMI_CATEGORY14_MATRIX_ID;

        #ifdef __MMI_MATRIX_MAIN_MENU_OPTIMIZE__
            /* allocate matrix highlight buffer from SCR ASM */      
            MMI_fixed_matrix_menu.buffer.buf_ptr = (U8*)applib_mem_screen_alloc(MMI_MAIN_MENU_MATRIX_HIGHLIGHTED_BUF_SIZE);
            MMI_ASSERT(MMI_fixed_matrix_menu.buffer.buf_ptr != NULL);
        #endif /* __MMI_MATRIX_MAIN_MENU_OPTIMIZE__ */
            break;
#endif /* __MMI_MAINMENU_MATRIX_SUPPORT__*/
#if defined(__MMI_MAINMENU_240X400_SUPPORT_MATRIX_PAGE_MENU__)
        case MATRIX_PAGE_MENU:
            wgui_set_disable_shortcut_display();
            wgui_fixed_matrix_begin_add_one_item();
            for (i = 0; i < number_of_items; i++)
            {
                wgui_fixed_matrix_add_one_item(
                    i, 
                    (U8*)get_string(list_of_items[i]), 
                    get_image(list_of_icons[i]));
            #ifdef __MMI_MERGE_SAT_TO_MAINMENU__
            #ifndef BROWSER_SUPPORT
                if (IsSATPresent() && list_of_items[i] == MAIN_MENU_SERVICES_TEXT)
                {
                    MMI_fixed_icontext_menuitems[(*fixed_icontext_menu_n_items) - 1].item_text =
                        (UI_string_type) GetSATMainMenuAlphaID();
                }
            #endif /* BROWSER_SUPPORT */ 
            #endif /* __MMI_MERGE_SAT_TO_MAINMENU__ */ 
                
                gMainMenuTitleIcon[i] = mmi_res_get_mainmenu_img(mmi_menuitem_list[i],MMI_RG_MM_IMG_TITLE);
                gMainMenuAnimation[i] = mmi_res_get_mainmenu_img(mmi_menuitem_list[i],MMI_RG_MM_IMG_MATRIX_HIGHLIGHT); 
            }
            dm_register_category_controlled_callback(category14_redraw_controlarea_callback);
            MMI_fixed_matrix_menu.flags |= UI_MATRIX_MENU_LOOP | UI_MATRIX_MENU_FOR_MAINMENU;
        #if defined(__MMI_MAINMENU_MATRIX_LOOP__)
            MMI_fixed_matrix_menu.flags |= UI_MATRIX_MENU_VERTICAL_LOOP;
        #else
            MMI_fixed_matrix_menu.flags &= ~UI_MATRIX_MENU_VERTICAL_LOOP;
        #endif /* defined(__MMI_MAINMENU_MATRIX_LOOP__) */ 
            MMI_current_menu_type = MATRIX_PAGE_MENU;

            set_MMI_matrix_main_menu_theme();
            gui_set_fixed_matrix_menu_theme(&MMI_fixed_matrix_menu, current_UI_theme->fixed_matrix_menu_theme);
            fixed_icontext_menuitem_apply_theme(current_UI_theme->fixed_icontext_menuitem_theme);
            register_fixed_matrix_highlight_handler(standard_animated_matrix_highlight_handler_type2);

        #ifdef __MMI_SCREEN_SWITCH_EFFECT__
            /* register the custom SSE effect handler */
            #if !defined(__MMI_OP11_HOMESCREEN_0301__) && !defined(__MMI_OP11_HOMESCREEN_0302__)
            gui_screen_switch_effect_register_custom_callback(wgui_category_sse_main_menu_custom_handler);        
            #endif        
            /* save the old matrix menu highlight handler */
            g_wgui_category_sse_matrix_main_menu_old_highlight_hdlr = MMI_fixed_matrix_menu.item_highlighted;
            /* override the matrix menu highlight handler to hook lsk handler */
            register_fixed_matrix_highlight_handler(wgui_category_sse_matrix_main_menu_highlight_hdlr);
        #endif /* __MMI_SCREEN_SWITCH_EFFECT__ */

            wgui_fixed_matrix_move_menu(0, (MMI_title_y + MMI_title_height));
            wgui_fixed_matrix_resize_menu(MMI_content_width, MMI_content_height);
            /* use image height as item height */
            gui_measure_image(get_image(list_of_icons[0]), &ixsize, &iysize);
            
        #ifdef __MMI_MAINLCD_320X240__
            configure_fixed_matrix(ixsize, iysize, 4, 0);
        #else /* __MMI_MAINLCD_320X240__ */
            configure_fixed_matrix(ixsize, iysize, 3, 0);
        #endif /* __MMI_MAINLCD_320X240__ */            
            wgui_fixed_matrix_end_add_one_item();
#ifndef __MMI_TITLE_BAR_NO_ICON_SHCT__		
            shortcut_width = set_menu_item_count(number_of_items) + 7;
#else
            shortcut_width = 7;  
#endif/*__MMI_TITLE_BAR_NO_ICON_SHCT__*/
            resize_menu_shortcut_handler(shortcut_width, MMI_title_height);
            move_menu_shortcut_handler(UI_device_width - MMI_menu_shortcut_box.width, MMI_title_y);
            set_fixed_icontext_positions(0, 0, 0, 0);
            MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_DISABLE_TEXT_DISPLAY;
        #ifdef __MMI_WALLPAPER_ON_BOTTOM__ 
            dm_get_scr_bg_flag(&mm_bg_flags);
            dm_set_scr_bg_flag(mm_bg_flags | DM_SCR_BG_FORCE_SHOW);
        #endif

            h_flag = set_matrix_menu_category_history(MMI_CATEGORY14_MATRIX_PAGE_ID, history_buffer);
            if (h_flag)
        #ifdef __MMI_WGUI_MINI_TAB_BAR__
                if (wgui_if_mini_tab_bar_in_parent() == MMI_TRUE)
                {
                    S32 idx = (S32) wgui_mini_tab_bar_get_index();

                    fixed_matrix_goto_item_no_redraw(idx);
                }
                else
        #endif /* __MMI_WGUI_MINI_TAB_BAR__ */ 
                    fixed_matrix_goto_item_no_redraw(MMI_fixed_matrix_menu.highlighted_item);
            else
            {
                if (history_buffer != NULL && main_menu_index != -1)
                {
                    highlighted_item = main_menu_index;
                }
                fixed_matrix_goto_item_no_redraw(highlighted_item);
            }
            MMI_fixed_icontext_menuitem.flags |= UI_MENUITEM_FOCUSSED_ANIMATE;
            SetKeyHandler(fixed_matrix_goto_previous_item, KEY_VOL_UP, KEY_EVENT_DOWN);
            SetKeyHandler(fixed_matrix_goto_next_item, KEY_VOL_DOWN, KEY_EVENT_DOWN);
            SetKeyHandler(fixed_matrix_goto_previous_item, KEY_VOL_UP, KEY_EVENT_REPEAT);
            SetKeyHandler(fixed_matrix_goto_next_item, KEY_VOL_DOWN, KEY_EVENT_REPEAT);
            cat_id = MMI_CATEGORY14_MATRIX_PAGE_ID;

        #ifdef __MMI_MATRIX_MAIN_MENU_OPTIMIZE__
            /* allocate matrix highlight buffer from SCR ASM */      
            MMI_fixed_matrix_menu.buffer.buf_ptr = (U8*)applib_mem_screen_alloc(MMI_MAIN_MENU_MATRIX_HIGHLIGHTED_BUF_SIZE);
            MMI_ASSERT(MMI_fixed_matrix_menu.buffer.buf_ptr != NULL);
        #endif /* __MMI_MATRIX_MAIN_MENU_OPTIMIZE__ */
            break;
#endif     
    }

    gdi_layer_unlock_frame_buffer();

    ExitCategoryFunction = ExitCategory14Screen;
    UI_hide_animation_frame_function = hide_main_menu_animation_frame;
    dm_setup_category_functions(dm_redraw_category_screen, GetCategory14History, GetCategory14HistorySize);
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = cat_id;
    dm_data.s32flags = DM_CLEAR_SCREEN_BACKGROUND;
#ifdef __MMI_UI_MATRIX_MAIN_MENU_SCALING_EFFECT__
    if (MMI_current_menu_type == MATRIX_MENU)
    {
        dm_data.s32flags |= DM_SCR_BG_NO_CACHE;
    }
#endif /* __MMI_UI_MATRIX_MAIN_MENU_SCALING_EFFECT__ */   
    dm_setup_data(&dm_data);
    dm_redraw_category_screen();
}
#ifdef __MMI_MAINLCD_128X64__

static U16 g_cat9014_highlight_index;
static U16 g_cat9014_menu_num;
static vertical_scrollbar g_cat9014_vbar;
static gdi_handle g_cat9014_anim_handle;

static void wgui_cat9014_down_arrow_key_hdlr(void);
static void wgui_cat9014_up_arrow_key_hdlr(void);
static void wgui_cat9014_draw_menu(U16 index)
{
	MMI_ID_TYPE mm_stringIDs[MAX_MAIN_MENU_ITEMS];
    S32 str_width;
    S32 str_height;
	S32 x, y, w, h;
	S32 iw, ih;
	MMI_MENU_ID mmi_menuitem_list[MAX_MAIN_MENU_ITEMS];
	U16 menu_icon;

	GetSequenceItemIds_Ext(IDLE_SCREEN_MENU_ID, mmi_menuitem_list);
	GetSequenceStringIds_Ext(IDLE_SCREEN_MENU_ID, mm_stringIDs);
	menu_icon = mmi_res_get_mainmenu_img(mmi_menuitem_list[index], MMI_RG_MM_IMG_MATRIX);

	gui_measure_string(get_string(mm_stringIDs[index]), &str_width, &str_height);
	gui_measure_image(get_image(menu_icon), &iw, &ih);

	x = 0;
	y = 0;
	w = UI_device_width;
	h = (UI_device_height - MMI_button_bar_height);
// clear background
	gdi_draw_solid_rect(            
                x, 
                y, 
                x+w,
                y+h,  
                GDI_COLOR_TRANSPARENT);
//draw animation;
	x = (UI_device_width - str_width - iw - 7)>>1;
	if(x < 0)
		x = 0;
	y = (h - ih)>>1;
	gdi_anim_draw(x, y, get_image(menu_icon), &g_cat9014_anim_handle);
//draw text;
	x = x + iw + 7;
	y = (h - str_height)>>1;

	gui_move_text_cursor(x, y);
	gui_print_text(get_string(mm_stringIDs[index]));
//highlight handler
	ExecuteCurrHiliteHandler(index);
//set right scrollbar value
    gui_set_vertical_scrollbar_value(&g_cat9014_vbar, g_cat9014_highlight_index);
	gui_show_vertical_scrollbar(&g_cat9014_vbar);
	gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);
}
static void wgui_cat9014_draw_ctrl_area(dm_coordinates *coordinate)
{
//	g_cat9014_menu_num = GetNumOfChild_Ext(IDLE_SCREEN_MENU_ID);
	gui_create_vertical_scrollbar(
            &g_cat9014_vbar,
            UI_device_width - current_MMI_theme->scrollbar_size,
            (0),
            current_MMI_theme->scrollbar_size,
            MMI_content_height);
	gui_set_vertical_scrollbar_range(&g_cat9014_vbar, g_cat9014_menu_num);
    gui_set_vertical_scrollbar_scale(&g_cat9014_vbar, 1);
	wgui_cat9014_draw_menu(g_cat9014_highlight_index);
}
static void wgui_cat9014_up_arrow_key_hdlr(void)
{
	if(g_cat9014_highlight_index == 0)
		g_cat9014_highlight_index = g_cat9014_menu_num - 1;
	else 
		g_cat9014_highlight_index--;
	gdi_anim_stop(g_cat9014_anim_handle);
	wgui_cat9014_draw_menu(g_cat9014_highlight_index);
}
static void wgui_cat9014_down_arrow_key_hdlr(void)
{
	if(g_cat9014_highlight_index == g_cat9014_menu_num - 1)
		g_cat9014_highlight_index = 0;
	else 
		g_cat9014_highlight_index++;
	gdi_anim_stop(g_cat9014_anim_handle);
	wgui_cat9014_draw_menu(g_cat9014_highlight_index);
}
static void wgui_cat9014_exit(void)
{
	g_cat9014_highlight_index = 0;
	g_cat9014_menu_num = 0;
}
U8 *wgui_cat9014_get_history(U8 *history_buffer)
{
	if (history_buffer != NULL)
	{
		*history_buffer = (U8)g_cat9014_highlight_index;
	}
	return history_buffer;
}
S32 wgui_cat9014_get_history_size(void)
{
	return (sizeof(U8));
}
void wgui_cat9014_show(
        U16 left_softkey,
        U16 right_softkey,
        S32 number_of_items,
        U16 *list_of_items,
        U16 *list_of_icons,
        S32 highlighted_item,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	dm_data_struct dm_data;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	g_cat9014_menu_num = number_of_items;
	g_cat9014_highlight_index = 0;
	if(history_buffer)
		g_cat9014_highlight_index = *history_buffer;
	dm_add_softkey(get_string(left_softkey), 0, get_string(right_softkey), 0);
	dm_register_category_controlled_callback(wgui_cat9014_draw_ctrl_area);
    dm_setup_category_functions(dm_redraw_category_screen, wgui_cat9014_get_history, wgui_cat9014_get_history_size);
    SetKeyHandler(wgui_cat9014_up_arrow_key_hdlr, KEY_UP_ARROW, KEY_EVENT_DOWN);
	SetKeyHandler(wgui_cat9014_down_arrow_key_hdlr, KEY_DOWN_ARROW, KEY_EVENT_DOWN);
	ExitCategoryFunction = wgui_cat9014_exit;
	dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = MMI_CAT9014_ID;
    dm_data.s32flags = DM_NO_TITLE | DM_CLEAR_SCREEN_BACKGROUND;
    dm_setup_data(&dm_data);
    dm_redraw_category_screen();
}
#endif /*__MMI_MAINLCD_128X64__ */
/*****************************************************************************
 * FUNCTION
 *  ExitCategory14Screen
 * DESCRIPTION
 *  Exits the category14 screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void ExitCategory14Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    UI_enable_alignment_timers();
    ClearHighlightHandler();
#ifdef __MMI_UI_LIST_HIGHLIGHT_EFFECTS__
    gui_unblock_list_effect();
#endif 
    UI_hide_animation_frame_function = UI_dummy_function;
    gui_hide_animations();
    switch (MMI_current_menu_type)
    {
#if defined(__MMI_MAINMENU_PAGE_SUPPORT__) || defined(__MMI_MAINMENU_LIST_SUPPORT__)
        case LIST_MENU:
        case PAGE_MENU:
            MMI_fixed_icontext_menuitem.flags &= ~UI_MENUITEM_FOCUSSED_ANIMATE;
            set_MMI_list_sub_menu_theme();
            gui_set_fixed_list_menu_theme(&MMI_fixed_list_menu, current_UI_theme->fixed_list_menu_theme);
            
    #if defined(__MMI_MAINLCD_240X320__) || defined(__MMI_MAINLCD_240X400__) || defined(__MMI_MAINLCD_320X480__)
            title_bg_id = 0;
    #endif 
    #if(TITLE_TRANSITION_STYLE_NON_BLOCKING)
            disable_title_transition();
    #endif 

            if (MMI_current_menu_type == PAGE_MENU)
            {
#ifdef __MMI_WALLPAPER_ON_BOTTOM__
                title_bg_id = 0;
                dm_set_scr_bg_flag(mm_bg_flags);
                dm_set_scr_bg_image_no_draw(mm_bg_ID, mm_bg_filename, mm_bg_x, mm_bg_y, mm_bg_opacity);
                wgui_reset_wallpaper_on_bottom();
#endif 
            }
            break;
#endif
#if defined(__MMI_MAINMENU_MATRIX_SUPPORT__) || defined(__MMI_MAINMENU_SPREAD_SUPPORT__)
        case MATRIX_MENU:
            MMI_fixed_icontext_menuitem.flags &= ~UI_MENUITEM_FOCUSSED_ANIMATE;
            MMI_fixed_matrix_menu.flags &= ~UI_MATRIX_MENU_FOR_MAINMENU;
            set_MMI_matrix_sub_menu_theme();
            gui_set_fixed_matrix_menu_theme(&MMI_fixed_matrix_menu, current_UI_theme->fixed_matrix_menu_theme);
            fixed_icontext_menuitem_apply_theme(
                current_UI_theme->fixed_icontext_menuitem_theme);
        #ifdef __MMI_WALLPAPER_ON_BOTTOM__
            title_bg_id = 0;
            dm_set_scr_bg_flag(mm_bg_flags);
        #endif 
    #if defined(__MMI_MAINLCD_320X480__)
            gui_fixed_icontext_menuitem_stop_scroll();
    #endif

        #ifdef __MMI_MATRIX_MAIN_MENU_OPTIMIZE__
            /* free matrix highlight buffer */
            applib_mem_screen_free(MMI_fixed_matrix_menu.buffer.buf_ptr);
        #endif /* __MMI_MATRIX_MAIN_MENU_OPTIMIZE__ */
            break;
#endif
#if defined(__MMI_MAINMENU_240X400_SUPPORT_MATRIX_PAGE_MENU__)
        case MATRIX_PAGE_MENU:
            MMI_fixed_icontext_menuitem.flags &= ~UI_MENUITEM_FOCUSSED_ANIMATE;
            MMI_fixed_matrix_menu.flags &= ~UI_MATRIX_MENU_FOR_MAINMENU;
            set_MMI_matrix_sub_menu_theme();
            gui_set_fixed_matrix_menu_theme(&MMI_fixed_matrix_menu, current_UI_theme->fixed_matrix_menu_theme);
            fixed_icontext_menuitem_apply_theme(
                current_UI_theme->fixed_icontext_menuitem_theme);
#ifdef __MMI_WALLPAPER_ON_BOTTOM__
            title_bg_id = 0;
            dm_set_scr_bg_flag(mm_bg_flags);
#endif 
            
#ifdef __MMI_MATRIX_MAIN_MENU_OPTIMIZE__
            /* free matrix highlight buffer */
            applib_mem_screen_free(MMI_fixed_matrix_menu.buffer.buf_ptr);
#endif /* __MMI_MATRIX_MAIN_MENU_OPTIMIZE__ */
            break;
#endif
    }
    reset_fixed_list();
    reset_fixed_matrix();
}


/*****************************************************************************
 * FUNCTION
 *  GetCategory14HistorySize
 * DESCRIPTION
 *  Gets the history buffer size for the category14 screen
 * PARAMETERS
 *  void
 * RETURNS
 *  size in U8s of the history buffer
 *****************************************************************************/
S32 GetCategory14HistorySize(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (MMI_current_menu_type)
    {
    #if defined(__MMI_MAINMENU_PAGE_SUPPORT__) || defined(__MMI_MAINMENU_LIST_SUPPORT__)
        case LIST_MENU:
        case PAGE_MENU:
            return ((S32)sizeof(list_menu_category_history));
    #endif
    #if defined(__MMI_MAINMENU_MATRIX_SUPPORT__) || defined(__MMI_MAINMENU_SPREAD_SUPPORT__)
        case MATRIX_MENU:
            return ((S32)sizeof(matrix_menu_category_history));
        case MATRIX_PAGE_MENU:
            return ((S32)sizeof(matrix_menu_category_history));
    #endif
         default:
            MMI_ASSERT(0);
    }
    return (0);
}


/*****************************************************************************
 * FUNCTION
 *  GetCategory14History
 * DESCRIPTION
 *  Gets the history buffer for the category14 screen
 * PARAMETERS
 *  history_buffer      [IN]        Is the buffer into which the history data is stored (pre-allocated)
 * RETURNS
 *  pointer to the history buffer
 *****************************************************************************/
U8 *GetCategory14History(U8 *history_buffer)
{
	

    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_MAINMENU_LIST_SUPPORT__) || defined (__MMI_MAINMENU_PAGE_SUPPORT__) || defined(__MMI_MAINMENU_MATRIX_SUPPORT__)|| defined(__MMI_MAINMENU_SPREAD_SUPPORT__)	
    switch (MMI_current_menu_type)
    {
    #if defined(__MMI_MAINMENU_PAGE_SUPPORT__) || defined(__MMI_MAINMENU_LIST_SUPPORT__)
        case LIST_MENU:
        case PAGE_MENU:
            get_list_menu_category_history(MMI_CATEGORY14_LIST_ID, history_buffer);
            break;
    #endif
    #if defined(__MMI_MAINMENU_MATRIX_SUPPORT__) || defined(__MMI_MAINMENU_SPREAD_SUPPORT__)
        case MATRIX_MENU:
            get_matrix_menu_category_history(MMI_CATEGORY14_MATRIX_ID, history_buffer);
            break;
        case MATRIX_PAGE_MENU:
            get_matrix_menu_category_history(MMI_CATEGORY14_MATRIX_PAGE_ID, history_buffer);
            break;    
    #endif
        defalult:
            MMI_ASSERT(0);
    }
#endif	
    return (history_buffer);

}


#ifdef __MMI_SCREEN_SWITCH_EFFECT__

/*****************************************************************************
 * FUNCTION
 *  wgui_category_sse_matrix_main_menu_select_icon
 * DESCRIPTION
 *  Selecting icon effect callback handler
 * PARAMETERS
 *  effect_type               [IN]  effect type
 *  current_frame_index       [IN]  current frame index
 *  total_frame_num           [IN]  total frame num
 * RETURNS
 *  MMI_FALSE if to stop the effect; otherwise, MMI_TRUE.
 *****************************************************************************/
static MMI_BOOL wgui_category_sse_matrix_main_menu_select_icon(gui_screen_switch_effect_type_enum effect_type, S32 current_frame_index, S32 total_frame_num)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i, x1, y1, x2, y2, iw, ih;
    S32 icon_x, icon_y;
    PU8 image_ptr;
    gui_common_menuitem_base_struct *cm;
    BOOL opacity_enable;
    U8 opacity, icon_opacity;
        
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    UI_UNUSED_PARAMETER(effect_type);
    
    i = MMI_fixed_matrix_menu.highlighted_item;
    image_ptr = matrix_mm_rect[i].image;
    cm = (gui_common_menuitem_base_struct*)MMI_fixed_matrix_menu.common_item_data;
    
    gdi_image_get_dimension(image_ptr, &iw, &ih);
    
    x1 = MMI_fixed_matrix_menu.cache_bmp_x1;
    y1 = MMI_fixed_matrix_menu.cache_bmp_y1;
    x2 = MMI_fixed_matrix_menu.cache_bmp_x2;
    y2 = MMI_fixed_matrix_menu.cache_bmp_y2;

    /* bi-degree main menu matrix or non-optimized matrix main menu (__MMI_MATRIX_MAIN_MENU_OPTIMIZE__) */
    if (!x1 && !y1 && !x2 && !y2)
    {
        /* The following icon alignment code is copied from the gui_fixed_menuitems.c. */
        // TODO: should use query
        // TODO: highlighted icon may be larger, need to fix this case.
        /* get icon position */
        icon_x = cm->icon_x;
        icon_y = cm->icon_y;
        if (cm->flags & UI_MENUITEM_CENTER_ICON_X)
        {
            icon_x = (cm->width >> 1) - (iw >> 1);
        }
        
        /* Bi-degree main menu item height includes the text. */
    #ifndef __MMI_BI_DEGREE_MAIN_MENU_STYLE__
        if (cm->flags & UI_MENUITEM_CENTER_ICON_Y)
        {
            icon_y = (cm->height >> 1) - (ih >> 1);
        }
    #endif /* __MMI_BI_DEGREE_MAIN_MENU_STYLE__ */

        /* get icon rect */
        x1 = matrix_mm_rect[i].rect.x + icon_x;
        y1 = matrix_mm_rect[i].rect.y + icon_y;
        x2 = x1 + iw - 1;
        y2 = y1 + ih - 1;
    }

    /* HVGA matrix main menu got texts under icons. Adjust y2 according to the text y1. */
#if !defined(__MMI_BI_DEGREE_MAIN_MENU_STYLE__) && defined(__MMI_MAINLCD_320X480__)
    y2 = matrix_mm_rect[i].rect_text.y - 1;
#endif

    gdi_layer_push_clip();
    gdi_layer_reset_clip();
    
    /* do icon fading by changing the layer opacity */
    gdi_layer_get_opacity(&opacity_enable, &opacity);
    icon_opacity = 200 - (current_frame_index + 1) * 200 / total_frame_num;
    gdi_layer_set_opacity(TRUE, icon_opacity);   
    gdi_layer_blt_previous(x1, y1, x2, y2);
    gdi_layer_set_opacity(opacity_enable, opacity);

    /* clear the icon for the last frame */
    if (current_frame_index == total_frame_num - 1)
    {
        gdi_draw_solid_rect(x1, y1, x2, y2, GDI_COLOR_TRANSPARENT);
    }
    
    gdi_layer_pop_clip();
    
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_category_sse_main_menu_custom_handler
 * DESCRIPTION
 *  Custom SSE effect handler for main menus
 * PARAMETERS
 *  stage_type       [IN]   SSE stage type
 *  param            [IN]   parameter
 * RETURNS
 *  Custom effect return code
 *****************************************************************************/
static gui_screen_switch_effect_custom_return_code_enum wgui_category_sse_main_menu_custom_handler(gui_screen_switch_effect_stage_enum stage_type, gui_screen_switch_effect_custom_param_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (stage_type)
    {
        case GUI_SSE_STAGE_POST_SETUP:
            // TODO: should identify the screen transition from idle to main menu
            if (param->effect_type == GUI_SCREEN_SWITCH_EFFECT_BLEND_IN)
            {
                /* override SSE effects */
            #ifdef __MMI_BI_DEGREE_MAIN_MENU_STYLE__
                /* bi-degree main menu, use sliding */
                gui_screen_switch_effect_setup_effect(
                    GUI_SCREEN_SWITCH_EFFECT_BI_DEGREE_MAIN_MENU_SLIDING, 
                    GUI_SCREEN_SWITCH_EFFECT_FRAMES, 
                    GUI_SCREEN_SWITCH_EFFECT_TIMER_UNIT);
            #else /* __MMI_BI_DEGREE_MAIN_MENU_STYLE__ */
                /* matrix main menu, use expanding */        
                gui_screen_switch_effect_setup_effect(
                    GUI_SCREEN_SWITCH_EFFECT_MATRIX_MAIN_MENU_ICON_EXPAND, 
                    GUI_SCREEN_SWITCH_EFFECT_FRAMES, 
                    GUI_SCREEN_SWITCH_EFFECT_TIMER_UNIT);        
            #endif /* __MMI_BI_DEGREE_MAIN_MENU_STYLE__ */
            }            
            break;

        default:
            break;
    }

    return GUI_SSE_CUSTOM_RETURN_CODE_DEFAULT;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_category_sse_matrix_main_menu_lsk_pre_hdlr
 * DESCRIPTION
 *  LSK key up handler for matrix main menu SSE
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_category_sse_matrix_main_menu_lsk_pre_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* execute icon selecting effect */
    gui_screen_switch_effect_register_owner_draw_frame_callback(wgui_category_sse_matrix_main_menu_select_icon);
    gui_screen_switch_effect_setup_effect(GUI_SCREEN_SWITCH_EEFECT_OWNER_DRAW1, GUI_SCREEN_SWITCH_EFFECT_FRAMES, GUI_SCREEN_SWITCH_EFFECT_TIMER_UNIT);
    gui_screen_switch_effect_run_effect(GUI_SCREEN_SWITCH_EEFECT_OWNER_DRAW1);

    /* must clear the effect layer which contains the highlight */
    gui_effect_slide_close();

    /* execute the app LSK KEY_UP handler, normally entry a new screen */
    g_wgui_category_sse_matrix_main_menu_old_lsk_hdlr();
}


/*****************************************************************************
 * FUNCTION
 *  wgui_category_sse_matrix_main_menu_highlight_hdlr
 * DESCRIPTION
 *  Highlight handler for matrix main menu SSE
 * PARAMETERS
 *  i       [IN]    highlight item index
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_category_sse_matrix_main_menu_highlight_hdlr(S32 i)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* execute the old highlight handler */
    g_wgui_category_sse_matrix_main_menu_old_highlight_hdlr(i);

    /* override the LSK KEY_UP handler */
    g_wgui_category_sse_matrix_main_menu_old_lsk_hdlr = get_softkey_function(KEY_EVENT_UP, MMI_LEFT_SOFTKEY);
    set_softkey_function(wgui_category_sse_matrix_main_menu_lsk_pre_hdlr, KEY_EVENT_UP, MMI_LEFT_SOFTKEY);
}


#endif /* __MMI_SCREEN_SWITCH_EFFECT__ */



