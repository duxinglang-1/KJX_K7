/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 *  wgui_categories_UCE.c
 *
 * Project:
 * --------
 *  MAUI
 *
 * Description:
 * ------------
 *  Unified Composer Editor related categories. 
 *
 *  [Category280]       MMS/SMS Editor
 *
 * Author: Sukrit K Mehra (PMT0050)
 * -------
 * -------
 * 
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/

#include "MMI_features.h"
//#include "StdC.h"
//#include "mmi_platform.h"

//#ifdef __UI_UNIFIED_COMPOSER_EDITOR_CATEGORY__
/* framework related include */
//#include "mmi_frm_gprot.h"
//#include "WguiCategoryGprot.h"
#include "app_str.h"

/* gui related include */
#if defined(__MMI_AUDIO_PLAYER__) || defined (__MMI_VIDEO_PLAY_SUPPORT__)
#include "mdi_datatype.h"
#endif 
#ifdef __MMI_VIDEO_PLAY_SUPPORT__
#include "mdi_video.h"
#endif 

//#include "FileManagerGProt.h"
#include "Gsm7BitNationalLang.h"
#include "wgui_softkeys.h"

#include "GlobalResDef.h"

//RHR
    #include "wgui_categories_UCE.h"
    #include "MMIDataType.h"
    #include "kal_general_types.h"
    #include "gui_inputs.h"
    #include "wgui.h"
    #include "gui_data_types.h"
    #include "gui_typedef.h"
    #include "kal_public_api.h"
    #include "DebugInitDef_Int.h"
    #include "string.h"
    #include "FileMgrSrvGProt.h"
    #include "Unicodexdcl.h"
    #include "wgui_inputs.h"
    #include "ImeGprot.h"
    #include "wgui_categories_enum.h"
    #include "MMI_fw_trc.h"
    #include "mmi_fw_trc.h"
    #include "kal_trace.h"
    #include "gui.h"
    #include "gui_themes.h"
    #include "PixcomFontEngine.h"
    #include "CustDataRes.h"
    #include "mmi_rp_app_uiframework_def.h"
    #include "gdi_include.h"
    #include "gdi_const.h"
    #include "CustThemesRes.h"
    #include "wgui_categories_util.h"
    #include "gdi_datatype.h"
    #include "wgui_draw_manager.h"
    #include "GlobalConstants.h"
    #include "mmi_frm_input_gprot.h"
    #include "gui_buttons.h"
    #include "lcd_sw_rnd.h"
    #include "lcd_sw_inc.h"
    #include "FileMgrType.h"
    #include "FileMgrGProt.h"
    #include "app_mem.h"
    #include "gui_config.h"
    #include "wgui_categories_inputs.h"
    #include "wgui_include.h"
    #include "mmi_frm_events_gprot.h"
    #include "mdi_include.h"
/***************************************************************************** 
* Define
*****************************************************************************/

/* information bar icon gap */
#define WGUI_CAT280_ICON_X_GAP 4

#if defined(__MMI_MAINLCD_320X240__)
#define WGUI_CAT280_IME_WIDTH (105)
#endif

#if defined(__MMI_MAINLCD_320X480__)
    #define WGUI_CAT280_IME_HEIGHT (36)
#endif


/***************************************************************************** 
* Typedef 
*****************************************************************************/
typedef struct _wgui_cat280_callback_cntx
{
    wgui_uce_text_change_callback text_change;
    wgui_uce_get_message_size_callback get_message_size;
    wgui_uce_get_display_type_callback get_display_type;
    wgui_uce_get_sms_remaining_character_callback get_sms_rm_character;
    wgui_uce_get_sms_segment_callback get_sms_segment;
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    wgui_uce_highlight_handler highlight;
    wgui_uce_change_slide_handler change_slide;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    wgui_uce_highlight_handler_ext highlight_ext;
    wgui_uce_recipient_changed_handler recipient_change_callback;
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
#ifdef __WGUI_CAT280_ENHANCED_UI__
    FuncPtr attach_button_callback;
    wgui_uce_object_highlight_callback object_callback;
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
} wgui_cat280_callback_cntx;

typedef struct _wgui_cat280_history_cntx
{
    wgui_uce_highlight_state_enum highlight_state; 
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    S32 highlight_index;
    MMI_BOOL need_to_set_sl_ime;
    mmi_imc_history sl_ime;
    MMI_BOOL need_to_set_ml_ime;
    mmi_imc_history ml_ime;
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    MMI_BOOL need_to_set_subject_ime;
    mmi_imc_history subject_ime;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
} wgui_cat280_history_cntx;

typedef struct _wgui_cat280_screen_layout_cntx
{
#if defined (__MMI_WALLPAPER_ON_BOTTOM__)
    U8 scr_bg_opacity;
#endif /* defined (__MMI_WALLPAPER_ON_BOTTOM__) */ 

#ifdef __WGUI_CAT280_SUPPORT_MMS__
#ifdef __MMI_VIDEO_PLAY_SUPPORT__
    MMI_BOOL is_got_size;
    U16 video_width;
    U16 video_height;
#endif /* __MMI_VIDEO_PLAY_SUPPORT__ */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    S32 msg_size_x1;
    S32 msg_size_x2;
    S32 msg_size_y1;
    S32 msg_size_y2;
} wgui_cat280_screen_layout_cntx;

/***************************************************************************** 
* Local Variable
*****************************************************************************/
static wgui_cat280_callback_cntx g_wgui_cat280_callback = {0};
static wgui_uce_context_struct g_wgui_uce_cntx;
static wgui_cat280_screen_layout_cntx *g_wgui_cat280_screen_info = NULL;

/***************************************************************************** 
* Extern Variable
*****************************************************************************/
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
extern S16 MMI_current_input_ext_type;
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

#ifdef __WGUI_CAT280_SUPPORT_MMS__
#ifdef __MMI_VIDEO_PLAY_SUPPORT__
extern mdi_video_info_struct wgui_video_info;
#endif /* __MMI_VIDEO_PLAY_SUPPORT__ */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

/***************************************************************************** 
* Local Function
*****************************************************************************/
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
static void wgui_cat280_translate_header_pen_event(S32 x, S32 y, wgui_uce_region_id_enum *region_id, S32 *index);
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
static MMI_BOOL wgui_cat280_editor_change_event_callback(gui_multi_line_input_box_change_event_enum event, U16 C);
static void wgui_cat280_draw_information_bar(S32 x1, S32 y1, S32 x2, S32 y2);
static void wgui_cat280_ml_go_to_last_position(void);
#ifdef __WGUI_CAT280_SUPPORT_MMS__

#ifndef __MMI_FTE_SUPPORT__
static void wgui_cat280_draw_slide_button(S32 bt1_left_x1, S32 bt1_left_y1, S32 bt2_right_x1, S32 bt2_right_y1, S32 bt_width, S32 bt_height);
#endif /*__MMI_FTE_SUPPORT__*/

static void wgui_cat280_resize_and_move_button(U16 index, S32 x, S32 y, S32 w, S32 h);
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
static void wgui_cat280_editor_scroll_down(S32 offset);
static void wgui_cat280_get_header_and_footer_height(U16 *header_height, U16 *footer_height);
static void wgui_cat280_set_highlight_state_and_index(wgui_uce_highlight_state_enum state, S32 index);
static void wgui_cat280_adjust_editor_scroll_bar(void);
static S32 wgui_cat280_get_last_recipient_index(wgui_uce_region_id_enum region_id);
static void wgui_cat280_adjust_single_line_editor_position(void);
static void wgui_cat280_move_to_editor_top(void);
static S32 wgui_cat280_get_first_recipient_index(wgui_uce_region_id_enum region_id);
static MMI_BOOL wgui_cat280_ime_pre_vk_handler(S32 x, S32 y);
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

/*
 * GSM 7BIT EXTENSION CHARACTERS
 * 
 * 0x20AC => Euro Char
 * 0x5E => ^
 * 0x7B => {
 * 0x7D => }
 * 0x5C => \
 * 0x5B => [
 * 0x7E => ~
 * 0x5D => ]
 * 0x7C => |
 * 
 */
/*
#define UCE_TEST_GSM_EXTENDED(c) \
(  (c==0x20AC)                   \
|| (c==0x5E)                     \
|| (c==0x7B)                     \
|| (c==0x7D)                     \
|| (c==0x5C)                     \
|| (c==0x5B)                     \
|| (c==0x7E)                     \
|| (c==0x5D)                     \
|| (c==0x7C)                     \
)
*/

/* For detail description, please refer to wgui_categories_UCE.h */
void wgui_uce_initialize_editor(
        U8 *text_buffer,
        U16 text_buffer_size,
        U8 new_slide_number,
        U8 total_slide_number,
        U8 total_character,
        wgui_uce_get_message_size_callback get_msg_size,
        wgui_uce_text_change_callback text_change,
        wgui_uce_get_display_type_callback get_display_type,
        wgui_uce_get_sms_remaining_character_callback get_sms_rm_character,
        wgui_uce_get_sms_segment_callback get_sms_segment,
        wgui_uce_highlight_handler highlight_handler,
        wgui_uce_change_slide_handler slide_handler)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    MMI_BOOL old_in_change_slide;
    wgui_uce_region_id_enum old_highligh_state;
    S32 old_highlight_index;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Tricky since the category is never uninitialised the callback remain forever active
       if user calls showcateogry w/o initialising, wrong callbacks will be called from showcategory */
    MMI_ASSERT(get_msg_size);
    MMI_ASSERT(text_change);
    MMI_ASSERT(get_sms_rm_character);
    MMI_ASSERT(get_sms_segment);

    /* context */
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    old_in_change_slide = g_wgui_uce_cntx.in_change_slide;
    old_highligh_state = g_wgui_uce_cntx.highligh_state;
    old_highlight_index = g_wgui_uce_cntx.highlight_index;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

    memset(&g_wgui_uce_cntx, 0, sizeof(wgui_uce_context_struct));
    g_wgui_uce_cntx.total_character = total_character;
    g_wgui_uce_cntx.text_buffer = text_buffer;
    g_wgui_uce_cntx.text_buffer_size = text_buffer_size;
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    g_wgui_uce_cntx.current_slide = new_slide_number;
    g_wgui_uce_cntx.total_slides = total_slide_number;
    g_wgui_uce_cntx.thumbnail_buffer = NULL;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    g_wgui_uce_cntx.in_change_slide = old_in_change_slide;
    if (g_wgui_uce_cntx.in_change_slide == MMI_TRUE)
    {
        g_wgui_uce_cntx.highligh_state = old_highligh_state;
        g_wgui_uce_cntx.highlight_index = old_highlight_index;
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

    /* callback function */
    memset(&g_wgui_cat280_callback, 0, sizeof(wgui_cat280_callback_cntx));
    g_wgui_cat280_callback.get_display_type = get_display_type;
    g_wgui_cat280_callback.get_sms_rm_character = get_sms_rm_character;
    g_wgui_cat280_callback.get_sms_segment = get_sms_segment;
    g_wgui_cat280_callback.text_change = text_change;
    g_wgui_cat280_callback.get_message_size = get_msg_size;
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    g_wgui_cat280_callback.highlight = highlight_handler;
    g_wgui_cat280_callback.change_slide = slide_handler;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
}


/* For detail description, please refer to wgui_categories_UCE.h */
void wgui_uce_add_object(
        wgui_uce_object_type_enum object,
        U16 *file_path,
        U16 default_image_id,
        wgui_uce_layout_type_enum alignment_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    switch (object)
    {
        case WGUI_UCE_OBJECT_TYPE_ATTACHMENT:
            g_wgui_uce_cntx.is_attachment = MMI_TRUE;
            break;
        case WGUI_UCE_OBJECT_TYPE_AUDIO:
            g_wgui_uce_cntx.is_audio = MMI_TRUE;
#ifdef __WGUI_CAT280_ENHANCED_UI__
            g_wgui_uce_cntx.audio_layout = alignment_type;
            g_wgui_uce_cntx.audio_image_id = default_image_id;
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
            break;
        case WGUI_UCE_OBJECT_TYPE_IMAGE:
            ASSERT(file_path || default_image_id);
            g_wgui_uce_cntx.is_image = MMI_TRUE;
            g_wgui_uce_cntx.layout = alignment_type;
            if (file_path)
            {
                mmi_ucs2ncpy((PS8) g_wgui_uce_cntx.file_path, (PS8) file_path, SRV_FMGR_PATH_MAX_LEN);
            }
            g_wgui_uce_cntx.default_image_id = default_image_id;
            break;
        case WGUI_UCE_OBJECT_TYPE_VIDEO:
            ASSERT(file_path || default_image_id);            
            g_wgui_uce_cntx.is_video = MMI_TRUE;
            g_wgui_uce_cntx.layout = alignment_type;
            if (file_path)
            {
                mmi_ucs2ncpy((PS8) g_wgui_uce_cntx.file_path, (PS8) file_path, SRV_FMGR_PATH_MAX_LEN);
            }            
            g_wgui_uce_cntx.default_image_id = default_image_id;
            break;
        default:
            ASSERT(0);
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
}


/* For detail description, please refer to wgui_categories_UCE.h */
void wgui_uce_delete_object(wgui_uce_object_type_enum object)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    switch (object)
    {
        case WGUI_UCE_OBJECT_TYPE_ATTACHMENT:
            g_wgui_uce_cntx.is_attachment = MMI_FALSE;
            break;
        case WGUI_UCE_OBJECT_TYPE_AUDIO:
            g_wgui_uce_cntx.is_audio = MMI_FALSE;
            break;
        case WGUI_UCE_OBJECT_TYPE_IMAGE:
            g_wgui_uce_cntx.is_image = MMI_FALSE;
            break;
        case WGUI_UCE_OBJECT_TYPE_VIDEO:
            g_wgui_uce_cntx.is_video = MMI_FALSE;
            break;
        default:
            ASSERT(0);
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
}


/* For detail description, please refer to wgui_categories_UCE.h */
void wgui_uce_insert_text(wgui_uce_text_info_struct *text_info, U8 *text_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Copy into text buffer for current slide */
    mmi_ucs2ncpy((PS8) g_wgui_uce_cntx.text_buffer, (PS8) text_buffer, g_wgui_uce_cntx.text_buffer_size);

    /* Copy text info as current text info */
    memcpy(&g_wgui_uce_cntx.text_info, text_info, sizeof(wgui_uce_text_info_struct));
}


/* For detail description, please refer to wgui_categories_UCE.h */
void wgui_uce_get_current_text_info(wgui_uce_text_info_struct *current_text_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memcpy(current_text_info, &g_wgui_uce_cntx.text_info, sizeof(wgui_uce_text_info_struct));
}


/* For detail description, please refer to wgui_categories_UCE.h */
void wgui_uce_set_current_text_info(wgui_uce_text_info_struct *text_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memcpy(&g_wgui_uce_cntx.text_info, text_info, sizeof(wgui_uce_text_info_struct));
}


/* For detail description, please refer to wgui_categories_UCE.h */
void wgui_uce_get_text_info_for_buffer(wgui_uce_text_info_struct *text_info, U8 *text_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 counter;
    U32 len;
    U16 C;
    mmi_7bit_counter_struct *count_info;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    len = mmi_ucs2strlen((PS8) text_buffer) ;

    /* What if the length of the text is more than the buffer the category has for insertion */
    /* We will update context only upto the limit we allow it to be inserted */

    if ((g_wgui_uce_cntx.text_buffer_size) < len)
    {
        len = g_wgui_uce_cntx.text_buffer_size;
    }

    text_info->char_count = len;
    
    mmi_7bit_counter_init(text_buffer);

    count_info = mmi_7bit_counter_get_info();
    text_info->UCS2_count = count_info->ucs2_count;
    text_info->extension_char_count = count_info->gsm_ext_count;

    for (counter = 0; counter < (len*ENCODING_LENGTH); counter += ENCODING_LENGTH)
    {
        /* text_buffer maybe at odd address so better get into a local */
        C = ((U16) text_buffer[counter + 1] << 8) | ((U8) text_buffer[counter]);
        text_info->utf8_msg_len += app_unicode_to_utf8_len(C); // TODO: Optimize multiple function calls. Replace with one function
    }
}


/* For detail description, please refer to wgui_categories_UCE.h */
U32 wgui_uce_insert_text_template(U8 *string, U16 no_of_char, U8 *guibuffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 char_count_before_insertion = g_wgui_uce_cntx.text_info.char_count;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    /* do not use the singleline history */
    if (g_dm_data.s32CatId != MMI_CATEGORY280_ID)
    {
        g_wgui_uce_cntx.add_content_in_background = MMI_TRUE;
    }
#endif

    wgui_multiline_inputbox_append_string(
        IMM_INPUT_TYPE_SENTENCE,
        g_wgui_uce_cntx.text_buffer,
        g_wgui_uce_cntx.text_buffer_size,
        (U8*) string,
        guibuffer,
        MMI_CATEGORY280_ID,
        wgui_cat280_editor_change_event_callback);

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    if (guibuffer != NULL)
    {
        wgui_cat280_history_cntx *h;
        S32 ml_s = sizeof(multiline_inputbox_category_history);
        S32 sl_s = sizeof(singleline_inputbox_category_history);

        ml_s = (ml_s + 3) / 4;
        ml_s *= 4;
        sl_s = (sl_s + 3) / 4;
        sl_s *= 4;

        h = (wgui_cat280_history_cntx*)(guibuffer + ml_s + sl_s);
        h->highlight_state = WGUI_UCE_HIGHLIGHT_EDITOR;
        h->highlight_index = -1;
    }
#endif
    return (g_wgui_uce_cntx.text_info.char_count - char_count_before_insertion);
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_set_highlight_state
 * DESCRIPTION
 *  set highlight state
 * PARAMETERS
 *  state   [IN]  highlight state
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_set_highlight_state(wgui_uce_highlight_state_enum state)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_wgui_uce_cntx.highligh_state = (wgui_uce_region_id_enum)state;

#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_cat280_callback.highlight != NULL)
    {
        g_wgui_cat280_callback.highlight(state); /* callback APP to set LSK */
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
}


#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
/* For detail description, please refer to wgui_categories_UCE.h */
void wgui_uce_initialize_recipients(
        wgui_uce_recipients_label_struct *to_lab,
        wgui_uce_recipients_label_struct *cc_lab,
        wgui_uce_recipients_label_struct *bcc_lab,
        wgui_uce_subject_struct *subject,
        wgui_uce_recipients_struct recipients_info[],
        S32 max_recipients_num,
        S32 buffer_size,
        U32 input_type,
        wgui_uce_highlight_handler_ext highlight_handler_ext)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    stFontAttribute *subject_f = &MMI_medium_font;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    S32 temp_w = 0, temp_h = 0;
    S32 i = 0;
    MMI_BOOL has_invalid = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __WGUI_CAT280_SUPPORT_MMS__
    UI_UNUSED_PARAMETER(subject);
    UI_UNUSED_PARAMETER(cc_lab);
    UI_UNUSED_PARAMETER(bcc_lab);
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    /* recipients info */
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if ((to_lab != NULL) || (cc_lab != NULL) || (bcc_lab != NULL) || (subject != NULL))
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
    if (to_lab != NULL)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    {
        g_wgui_uce_cntx.inline_recipients = MMI_TRUE;
        g_wgui_uce_cntx.recipient_buffer_size= buffer_size;
        g_wgui_uce_cntx.recipient_input_type= input_type;
    }
    else
    {
        return;
    }
    /* setup max recipients number */
    MMI_ASSERT((max_recipients_num >= 0) && (max_recipients_num <= CAT280_RECIPIENTS_MAX_NUM));
    g_wgui_uce_cntx.max_recipients_num = max_recipients_num;

    /* setup recipients information */
    MMI_ASSERT(recipients_info != NULL);
    //memcpy(&g_wgui_uce_cntx.recipient, recipients_info, (sizeof(wgui_uce_recipients_struct) * CAT280_RECIPIENTS_MAX_NUM));
    g_wgui_uce_cntx.recipient = recipients_info;

    /* check the buffer */
    for (i = 0; i < g_wgui_uce_cntx.max_recipients_num; i++)
    {
        if (g_wgui_uce_cntx.recipient[i].is_valid == MMI_FALSE)
        {
            has_invalid = MMI_TRUE;
        }
        else
        {
            if (has_invalid == MMI_TRUE)
            {
                MMI_ASSERT(0);
            }
        }
    }

    /* setup "to" label */
    if (to_lab != NULL)
    {
        memcpy(&g_wgui_uce_cntx.to_recipients, to_lab, sizeof(wgui_uce_recipients_label_struct));
        g_wgui_uce_cntx.to_recipients_num = wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS);
        MMI_ASSERT(g_wgui_uce_cntx.to_recipients_num >= 0);
        
        gui_measure_image(g_wgui_uce_cntx.to_recipients.label_normal_image, &temp_w, &temp_h);
        if (temp_w > g_wgui_uce_cntx.max_label_width)
        {
            g_wgui_uce_cntx.max_label_width = temp_w;
        }
    }
    
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    /* setup "cc" label */
    if (cc_lab != NULL)
    {
        memcpy(&g_wgui_uce_cntx.cc_recipients, cc_lab, sizeof(wgui_uce_recipients_label_struct));
        g_wgui_uce_cntx.cc_recipients_num = wgui_cat280_get_recipients_num(WGUI_UCE_CC_RECIPIENTS);
        MMI_ASSERT(g_wgui_uce_cntx.cc_recipients_num >= 0);
        
        gui_measure_image(g_wgui_uce_cntx.cc_recipients.label_normal_image, &temp_w, &temp_h);
        if (temp_w > g_wgui_uce_cntx.max_label_width)
        {
            g_wgui_uce_cntx.max_label_width = temp_w;
        }

        //MMI_ASSERT(temp_h < CAT280_INLINE_SL_HEIGHT);
    }
    
    /* setup "bcc" label */
    if (bcc_lab != NULL)
    {
        memcpy(&g_wgui_uce_cntx.bcc_recipients, bcc_lab, sizeof(wgui_uce_recipients_label_struct));
        g_wgui_uce_cntx.bcc_recipients_num = wgui_cat280_get_recipients_num(WGUI_UCE_BCC_RECIPIENTS);
        MMI_ASSERT(g_wgui_uce_cntx.bcc_recipients_num >= 0);
        
        gui_measure_image(g_wgui_uce_cntx.bcc_recipients.label_normal_image, &temp_w, &temp_h);
        if (temp_w > g_wgui_uce_cntx.max_label_width)
        {
            g_wgui_uce_cntx.max_label_width = temp_w;
        }

        //MMI_ASSERT(temp_h < CAT280_INLINE_SL_HEIGHT);
    }

    /* setup subject */
    if (subject != NULL)
    {
        memcpy(&g_wgui_uce_cntx.subject, subject, sizeof(wgui_uce_subject_struct));
        g_wgui_uce_cntx.has_editable_subject= MMI_TRUE;
        if (g_wgui_uce_cntx.subject.label_string != NULL)
        {
            gui_set_font(subject_f);
            gui_measure_string(g_wgui_uce_cntx.subject.label_string, &temp_w, &temp_h);
            if (temp_w > g_wgui_uce_cntx.max_label_width)
            {
                g_wgui_uce_cntx.max_label_width = temp_w;
            }

            //MMI_ASSERT(temp_h < CAT280_INLINE_SL_HEIGHT);
        }
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    /* highlight change callback */
    g_wgui_cat280_callback.highlight_ext = highlight_handler_ext;
}


/* For detail description, please refer to wgui_categories_UCE.h */
MMI_BOOL wgui_cat280_add_recipient(
        wgui_uce_region_id_enum region_id,
        UI_string_type display_text,
        U32 editor_flags,
        MMI_BOOL highlight,
        S32 app_mapping_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i = 0;
    U16 header_height = 0;
    U16 footer_height = 0;
    MMI_BOOL add_to_cur_buf = MMI_FALSE;
    S32 last_recipient_index;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __WGUI_CAT280_SUPPORT_MMS__
    ASSERT(region_id == WGUI_UCE_TO_RECIPIENTS);
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    if (g_dm_data.s32CatId != MMI_CATEGORY280_ID)
    {
        g_wgui_uce_cntx.add_recipient_in_background = MMI_TRUE;
    }

    /* if current highlight editor is empty, then insert to this empty editor */
    if ((g_wgui_uce_cntx.highlight_index >= 0) && 
        (g_wgui_uce_cntx.highlight_index < g_wgui_uce_cntx.max_recipients_num) &&
        (g_wgui_uce_cntx.highligh_state == region_id) &&
        (g_wgui_uce_cntx.recipient[g_wgui_uce_cntx.highlight_index].input_buf[0] == 0) &&
        (g_wgui_uce_cntx.recipient[g_wgui_uce_cntx.highlight_index].input_buf[1] == 0))
    {
        add_to_cur_buf = MMI_TRUE;
        i = g_wgui_uce_cntx.highlight_index;
    }
    else
    {
        /* get the invalid buffer */
        for (i = 0; g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE; i++)
        {
            if (i == g_wgui_uce_cntx.max_recipients_num -1)
            {
                /* the number of recipients over the top-limit */
                if ((g_wgui_uce_cntx.recipient[i].input_buf[0] != 0) ||
                    (g_wgui_uce_cntx.recipient[i].input_buf[1] != 0))
                {
                    return MMI_FALSE;
                }
                else
                {
                    break;
                }
            }
        }
        
        /* if the last recipient is empty, we will insert recipient to this buffer, don't create a new one */
        last_recipient_index = wgui_cat280_get_last_recipient_index(region_id);
        if (last_recipient_index >= 0)
        {
            if ((g_wgui_uce_cntx.recipient[last_recipient_index].input_buf[0] == 0) &&
                (g_wgui_uce_cntx.recipient[last_recipient_index].input_buf[1] == 0))
            {
                add_to_cur_buf = MMI_TRUE;
                i = last_recipient_index;
            }
        }
    }
    
    gdi_layer_lock_frame_buffer();
    
    /* setup new recipient */
    g_wgui_uce_cntx.recipient[i].is_valid = MMI_TRUE;
    g_wgui_uce_cntx.recipient[i].region_id = region_id;
    g_wgui_uce_cntx.recipient[i].editor_flags = editor_flags;
    g_wgui_uce_cntx.recipient[i].app_mapping_index = app_mapping_index;
    
    if (display_text != NULL)
    {
        gui_strcpy((UI_string_type)g_wgui_uce_cntx.recipient[i].input_buf, display_text);
    }
    else
    {
        g_wgui_uce_cntx.recipient[i].input_buf[0] = 0;
        g_wgui_uce_cntx.recipient[i].input_buf[1] = 0;
    }

    if (add_to_cur_buf == MMI_FALSE)
    {
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        /* enlarge header area */
        if (region_id == WGUI_UCE_TO_RECIPIENTS)
        {
            g_wgui_uce_cntx.to_recipients_num += 1;
        }
        else if (region_id == WGUI_UCE_CC_RECIPIENTS)
        {
            g_wgui_uce_cntx.cc_recipients_num += 1;
        }
        else if (region_id == WGUI_UCE_BCC_RECIPIENTS)
        {
            g_wgui_uce_cntx.bcc_recipients_num += 1;
        }
        else
        {
            /* add to undefined region */
            MMI_ASSERT(0);
        }
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
        g_wgui_uce_cntx.to_recipients_num += 1;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

        wgui_cat280_get_header_and_footer_height(&header_height, &footer_height);
        MMI_multiline_inputbox.header_height = header_height;
    }

    /* set highlight */
    if (highlight == MMI_TRUE)
    {
        if (g_dm_data.s32CatId == MMI_CATEGORY280_ID)
        {
            wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)region_id, i);
        }
        else
        {
            g_wgui_uce_cntx.highligh_state = region_id;
            g_wgui_uce_cntx.highlight_index = i;
        }
    }

    wgui_cat280_adjust_editor_scroll_bar();

    gdi_layer_unlock_frame_buffer();
    gdi_lcd_repaint_all();
    return MMI_TRUE;
}


/* For detail description, please refer to wgui_categories_UCE.h */
MMI_BOOL wgui_cat280_insert_new_recipient(
        wgui_uce_region_id_enum region_id,
        S32 insert_index,
        UI_string_type display_text,
        U32 editor_flags,
        MMI_BOOL highlight,
        S32 app_mapping_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i = 0;
    U16 header_height = 0;
    U16 footer_height = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __WGUI_CAT280_SUPPORT_MMS__
    ASSERT(region_id == WGUI_UCE_TO_RECIPIENTS);
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    /* get the invalid buffer */
    for (i = 0; g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE; i++)
    {
        if (i == g_wgui_uce_cntx.max_recipients_num -1)
        {
            /* the number of recipients over the top-limit */
            return MMI_FALSE;
        }
    }
    
    gdi_layer_lock_frame_buffer();

    MMI_ASSERT((insert_index >= 0) && (insert_index <= i ));

    /* if current highlight editor is empty, then insert to this empty editor */
    if ((g_wgui_uce_cntx.recipient[insert_index].region_id == region_id) &&
        (g_wgui_uce_cntx.recipient[insert_index].is_valid == MMI_TRUE) &&
        (g_wgui_uce_cntx.recipient[insert_index].input_buf[0] == 0) &&
        (g_wgui_uce_cntx.recipient[insert_index].input_buf[1] == 0))
    {
        /* setup new recipient */
        g_wgui_uce_cntx.recipient[insert_index].is_valid = MMI_TRUE;
        g_wgui_uce_cntx.recipient[insert_index].region_id = region_id;
        g_wgui_uce_cntx.recipient[insert_index].editor_flags = editor_flags;
        g_wgui_uce_cntx.recipient[insert_index].app_mapping_index = app_mapping_index;

        if (display_text != NULL)
        {
            gui_strcpy((UI_string_type)g_wgui_uce_cntx.recipient[insert_index].input_buf, display_text);
        }
        else
        {
            g_wgui_uce_cntx.recipient[insert_index].input_buf[0] = 0;
            g_wgui_uce_cntx.recipient[insert_index].input_buf[1] = 0;
        }

        if (highlight == MMI_TRUE)
        {
            wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)region_id, insert_index);
        }

        wgui_cat280_adjust_editor_scroll_bar();
    }
    else
    {
        /* move buffer */
        for (; insert_index < i; i--)
        {
            g_wgui_uce_cntx.recipient[i].is_valid = g_wgui_uce_cntx.recipient[i - 1].is_valid;
            g_wgui_uce_cntx.recipient[i].region_id = g_wgui_uce_cntx.recipient[i - 1].region_id;
            g_wgui_uce_cntx.recipient[i].editor_flags = g_wgui_uce_cntx.recipient[i - 1].editor_flags;
            g_wgui_uce_cntx.recipient[i].app_mapping_index = g_wgui_uce_cntx.recipient[i - 1].app_mapping_index;
            gui_strcpy((UI_string_type)g_wgui_uce_cntx.recipient[i].input_buf, (UI_string_type)g_wgui_uce_cntx.recipient[i - 1].input_buf);
        }
            
        /* setup new recipient */
        g_wgui_uce_cntx.recipient[i].is_valid = MMI_TRUE;
        g_wgui_uce_cntx.recipient[i].region_id = region_id;
        g_wgui_uce_cntx.recipient[i].editor_flags = editor_flags;
        g_wgui_uce_cntx.recipient[i].app_mapping_index = app_mapping_index;
            
        if (display_text != NULL)
        {
            gui_strcpy((UI_string_type)g_wgui_uce_cntx.recipient[i].input_buf, display_text);
        }
        else
        {
            g_wgui_uce_cntx.recipient[i].input_buf[0] = 0;
            g_wgui_uce_cntx.recipient[i].input_buf[1] = 0;
        }

#ifdef __WGUI_CAT280_SUPPORT_MMS__
        /* enlarge header area */
        if (region_id == WGUI_UCE_TO_RECIPIENTS)
        {
            g_wgui_uce_cntx.to_recipients_num += 1;
        }
        else if (region_id == WGUI_UCE_CC_RECIPIENTS)
        {
            g_wgui_uce_cntx.cc_recipients_num += 1;
        }
        else if (region_id == WGUI_UCE_BCC_RECIPIENTS)
        {
            g_wgui_uce_cntx.bcc_recipients_num += 1;
        }
        else
        {
            /* add to undefined region */
            MMI_ASSERT(0);
        }
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
        g_wgui_uce_cntx.to_recipients_num += 1;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

        wgui_cat280_get_header_and_footer_height(&header_height, &footer_height);
        MMI_multiline_inputbox.header_height = header_height;

        /* set highlight */
        if (highlight == MMI_TRUE)
        {
            if (g_dm_data.s32CatId == MMI_CATEGORY280_ID)
            {
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)region_id, i);
            }
            else
            {
                g_wgui_uce_cntx.highligh_state = region_id;
                g_wgui_uce_cntx.highlight_index = i;
            }
        }

        wgui_cat280_adjust_editor_scroll_bar();
    }

    gdi_layer_unlock_frame_buffer();
    gdi_lcd_repaint_all();
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_is_recipient_changed
 * DESCRIPTION
 *  Change the recipients by app.
 * PARAMETERS
 *  recipient_changed  :                [IN] (N/A) flags.
 * RETURNS
 *  void
 *****************************************************************************/
void wgui_cat280_is_recipient_changed(MMI_BOOL recipient_changed)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_wgui_uce_cntx.add_recipient_in_background = recipient_changed;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_sl_empty_callback
 * DESCRIPTION
 *  if singleline editor is empty, we need to change RSK
 * PARAMETERS
 *
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_sl_empty_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wgui_uce_region_id_enum highlight_state;
    S32 highlight_region_num;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    highlight_state = wgui_cat280_get_highlight_state();
    highlight_region_num = wgui_cat280_get_recipients_num(highlight_state);
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (highlight_state == WGUI_UCE_SUBJECT)
    {
        return;
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    /* if the old highlight recipient is empty, we need to remove it */
    if (highlight_region_num != 1)
    {
        if (mmi_imc_is_spell_word_state() == MMI_FALSE)
        {
            wgui_cat280_remove_recipient(g_wgui_uce_cntx.highlight_index);
        }
    }
    else
    {
        g_wgui_uce_cntx.recipient[g_wgui_uce_cntx.highlight_index].editor_flags &= ~WGUI_UCE_WRAPPING_DELETE_RECIPIENT;
        MMI_singleline_inputbox.ext_flags &= ~GUI_SINGLE_LINE_INPUT_BOX_RECIPIENT_MODE;
        g_wgui_uce_cntx.recipient[g_wgui_uce_cntx.highlight_index].app_mapping_index = -1;
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_sl_change_callback
 * DESCRIPTION
 *  If there is ";" in recipient, we will add a new recipient.
 * PARAMETERS
 *  new_recipient :                [IN] (N/A) new recipient name or number.
 *  flags         :                [IN] (N/A) flags.
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_sl_change_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i =0;
    MMI_BOOL ret;
    S32 old_highlight_index;
    S32 old_text_offset_y;
    U8 current_inputs[4] = {0};
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* if the single line is out of multiline area, we need to adjust the scroll bar */
    old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
    wgui_cat280_adjust_editor_scroll_bar();
    if (MMI_multiline_inputbox.text_offset_y != old_text_offset_y)
    {
        wgui_inputs_ml_redraw();
    }
    
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_SUBJECT)
    {
        return;
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    /* if no changed, we cannot remove the recipient */
    wgui_inputs_register_empty_func(wgui_cat280_sl_empty_callback);

    /* clear the flags */
    g_wgui_uce_cntx.recipient[g_wgui_uce_cntx.highlight_index].editor_flags &= ~WGUI_UCE_HIGHLIGHT_RECIPIENT;
    old_highlight_index = g_wgui_uce_cntx.highlight_index;

    for (i = (MMI_singleline_inputbox.current_text_p - (MMI_singleline_inputbox.text)); i >= ENCODING_LENGTH; i -= ENCODING_LENGTH)   
    {
        /* if there is a ";" */
        UI_buffer_type text_p;
        UI_character_type current_character;
        text_p = MMI_singleline_inputbox.text + i - ENCODING_LENGTH;
        UI_STRING_GET_NEXT_CHARACTER(text_p, current_character);
        if (UI_TEST_SEMICOLON_CHAR(current_character))
        {
            if (g_wgui_uce_cntx.current_inputs == 0)
            {
                ret = wgui_cat280_insert_new_recipient(
                    wgui_cat280_get_highlight_state(),
                    (g_wgui_uce_cntx.highlight_index + 1), 
                    (UI_string_type)&MMI_singleline_inputbox.text[i], 
                    WGUI_UCE_DEFAULT_FLAGS, 
                    MMI_TRUE,
                    (-1));
                mmi_imc_skip_first_cursor_movement_event(MMI_FALSE);
            }
            else
            {
                current_inputs[0] = (g_wgui_uce_cntx.current_inputs & 0x00FF);
                current_inputs[1] = ((g_wgui_uce_cntx.current_inputs & 0xFF00) >> 8);
                ret = wgui_cat280_insert_new_recipient(
                    wgui_cat280_get_highlight_state(),
                    (g_wgui_uce_cntx.highlight_index + 1), 
                    (UI_string_type)current_inputs, 
                    WGUI_UCE_DEFAULT_FLAGS, 
                    MMI_TRUE,
                    (-1));
                g_wgui_uce_cntx.current_inputs = 0;
            }

            if (ret == MMI_TRUE)
            {
                gdi_layer_lock_frame_buffer();
                mmi_imc_reset_ime_state();
                gdi_layer_unlock_frame_buffer();

                g_wgui_uce_cntx.recipient[old_highlight_index].input_buf[i] = 0;
                g_wgui_uce_cntx.recipient[old_highlight_index].input_buf[i + 1] = 0;
                wgui_inputs_ml_redraw();
                wgui_inputs_set_break_insert(MMI_FALSE);
            }
            
            break;
        }
    }

    g_wgui_uce_cntx.current_inputs = 0;
    
    /* callback to app */
    if (g_wgui_cat280_callback.recipient_change_callback != NULL)
    {
        g_wgui_cat280_callback.recipient_change_callback(old_highlight_index);
    }
    return;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_sl_change_event_callback
 * DESCRIPTION
 *  handler the ";" behaviors.
 * PARAMETERS
 *  event       [IN]        Action performed on insert, delete character or delete all
 *  C           [IN]        Character to insert or delete
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_sl_change_event_callback(gui_multi_line_input_box_change_event_enum event, U16 C)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_TRUE;
    S32 i;
    S32 current_num = wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS) + wgui_cat280_get_recipients_num(WGUI_UCE_CC_RECIPIENTS) + wgui_cat280_get_recipients_num(WGUI_UCE_BCC_RECIPIENTS);
    S32 semicolon_offset = -1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (event)
    {
        case GUI_MULTI_LINE_INPUT_BOX_INSERT_CHAR:
            /* if cannot create a new recipient, user cannot inputs ";" */
            if (current_num == g_wgui_uce_cntx.max_recipients_num)
            {
                for (i = 0; ((MMI_singleline_inputbox.text[i] != 0) || (MMI_singleline_inputbox.text[i + 1] != 0)); i += 2)
                {
                    /* if there is a ";" */
                    UI_buffer_type text_p;
                    UI_character_type current_character;
                    text_p = MMI_singleline_inputbox.text + i;
                    UI_STRING_GET_NEXT_CHARACTER(text_p, current_character);
                    if (UI_TEST_SEMICOLON_CHAR(current_character))
                    {
                        semicolon_offset = i;
                        break;
                    }
                }

                if (semicolon_offset != -1) /* there is a ";" */
                {
                    if (MMI_singleline_inputbox.current_text_p > MMI_singleline_inputbox.text + semicolon_offset)
                    {
                        S32 old_text_offset_y;
                        UI_editor_play_tone_cannot_insert();    /* play error tone */
                        old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
                        wgui_cat280_adjust_editor_scroll_bar();
                        if (MMI_multiline_inputbox.text_offset_y != old_text_offset_y)
                        {
                            wgui_inputs_ml_redraw();
                        }
                        return MMI_FALSE;
                    }
                }

                if (UI_TEST_SEMICOLON_CHAR(C) == MMI_TRUE)
                {
                    S32 old_text_offset_y;
                    UI_editor_play_tone_cannot_insert();    /* play error tone */
                    old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
                    wgui_cat280_adjust_editor_scroll_bar();
                    if (MMI_multiline_inputbox.text_offset_y != old_text_offset_y)
                    {
                        wgui_inputs_ml_redraw();
                    }
                    return MMI_FALSE;
                }
            }

            if (UI_TEST_SEMICOLON_CHAR(C)) /* ";" */
            {
                if (MMI_singleline_inputbox.text_length == MMI_singleline_inputbox.available_length - ENCODING_LENGTH)
                {
                    /* if there is a ";" */
                    UI_buffer_type text_p;
                    UI_character_type current_character;

                    for (i = MMI_singleline_inputbox.text_length; ((&MMI_singleline_inputbox.text[i] > MMI_singleline_inputbox.current_text_p) && (i >= ENCODING_LENGTH)); i--)
                    {
                        MMI_singleline_inputbox.text[i] = MMI_singleline_inputbox.text[i - ENCODING_LENGTH];
                    }

                    text_p = MMI_singleline_inputbox.current_text_p - ENCODING_LENGTH;
                    UI_STRING_GET_NEXT_CHARACTER(text_p, current_character);
                    if (UI_TEST_SEMICOLON_CHAR(current_character))
                    {
                        g_wgui_uce_cntx.current_inputs = C;
                    }
                    else
                    {
                        if (C == 0x003b)
                        {
                            MMI_singleline_inputbox.current_text_p[0] = 0x3b;
                            MMI_singleline_inputbox.current_text_p[1] = 0x00;
                        }
                        else if (C == 0xff1b)
                        {
                            MMI_singleline_inputbox.current_text_p[0] = 0x1b;
                            MMI_singleline_inputbox.current_text_p[1] = 0xff;
                        }

                        MMI_singleline_inputbox.current_text_p += ENCODING_LENGTH;
                    }
                    
                    wgui_cat280_sl_change_callback();
                    result = MMI_FALSE;
                }
                else if (MMI_singleline_inputbox.text_length == MMI_singleline_inputbox.available_length)
                {
                    MMI_BOOL play_tone = MMI_TRUE;
                    for (i = (MMI_singleline_inputbox.current_text_p - (MMI_singleline_inputbox.text)); i >= ENCODING_LENGTH; i -= ENCODING_LENGTH)   
                    {
                        /* if there is a ";" */
                        UI_buffer_type text_p;
                        UI_character_type current_character;
                        text_p = MMI_singleline_inputbox.text + i - ENCODING_LENGTH;
                        UI_STRING_GET_NEXT_CHARACTER(text_p, current_character);
                        if (UI_TEST_SEMICOLON_CHAR(current_character))
                        {
                            play_tone = MMI_FALSE;
                            break;
                        }
                    }

                    if (play_tone)
                    {
                        if (UI_TEST_SEMICOLON_CHAR(C))
                        {
                            MMI_BOOL ret;
                            UI_string_type old_cursor_text_p = (UI_string_type)MMI_singleline_inputbox.current_text_p;

                            ret = wgui_cat280_insert_new_recipient(
                                wgui_cat280_get_highlight_state(),
                                (g_wgui_uce_cntx.highlight_index + 1), 
                                (UI_string_type)MMI_singleline_inputbox.current_text_p, 
                                WGUI_UCE_DEFAULT_FLAGS, 
                                MMI_TRUE,
                                (-1));

                            if (ret == MMI_TRUE)
                            {
                                old_cursor_text_p[0] = C;
                                old_cursor_text_p[1] = 0;
                                gui_show_multi_line_input_box(&MMI_multiline_inputbox);
                                result = MMI_FALSE;
                                wgui_inputs_set_break_insert(MMI_FALSE);
                            }
                            else
                            {
                                UI_editor_play_tone_cannot_insert();    /* play error tone */
                                g_wgui_uce_cntx.current_inputs = C;
                                wgui_cat280_sl_change_callback();
                                result = MMI_FALSE;
                            }
                        }
                        else
                        {
                            UI_editor_play_tone_cannot_insert();    /* play error tone */
                            g_wgui_uce_cntx.current_inputs = C;
                            wgui_cat280_sl_change_callback();
                            result = MMI_FALSE;
                        }
                    }
                    else
                    {
                        g_wgui_uce_cntx.current_inputs = C;
                        wgui_cat280_sl_change_callback();
                        result = MMI_FALSE;
                    }
                }
                else
                {
                    UI_buffer_type text_p;
                    UI_character_type current_character;
                    text_p = MMI_singleline_inputbox.current_text_p - ENCODING_LENGTH;
                    UI_STRING_GET_NEXT_CHARACTER(text_p, current_character);

                    if (UI_TEST_SEMICOLON_CHAR(current_character))
                    {
                        g_wgui_uce_cntx.current_inputs = C;
                        wgui_cat280_sl_change_callback();
                        result = MMI_FALSE;
                    }
                }
            }
            else if (MMI_singleline_inputbox.text_length == (MMI_singleline_inputbox.available_length - ENCODING_LENGTH))
            {
                UI_buffer_type text_p;
                UI_character_type current_character;
                text_p = MMI_singleline_inputbox.text + MMI_singleline_inputbox.text_length - 2 * ENCODING_LENGTH;
                UI_STRING_GET_NEXT_CHARACTER(text_p, current_character);
                if (UI_TEST_SEMICOLON_CHAR(current_character))
                {
                    result = MMI_TRUE;
                }
                else
                {
                    result = MMI_FALSE;
                    UI_editor_play_tone_cannot_insert();    /* play error tone */
                }
            }
            else if (MMI_singleline_inputbox.text_length == MMI_singleline_inputbox.available_length)
            {
                MMI_BOOL play_tone = MMI_TRUE;
                for (i = (MMI_singleline_inputbox.current_text_p - (MMI_singleline_inputbox.text)); i >= ENCODING_LENGTH; i -= ENCODING_LENGTH)   
                {
                    /* if there is a ";" */
                    UI_buffer_type text_p;
                    UI_character_type current_character;
                    text_p = MMI_singleline_inputbox.text + i - ENCODING_LENGTH;
                    UI_STRING_GET_NEXT_CHARACTER(text_p, current_character);
                    if (UI_TEST_SEMICOLON_CHAR(current_character))
                    {
                        play_tone = MMI_FALSE;
                        break;
                    }
                }

                if (play_tone)
                {
                    UI_editor_play_tone_cannot_insert();    /* play error tone */
                }

                g_wgui_uce_cntx.current_inputs = C;
                wgui_cat280_sl_change_callback();
                result = MMI_FALSE;
            }

            break;
            
        case GUI_MULTI_LINE_INPUT_BOX_DELETE_CHAR:

            break;
            
        case GUI_MULTI_LINE_INPUT_BOX_DELETEALL:

            break;
        case GUI_MULTI_LINE_INPUT_BOX_INSERT_STRING:

            break;
    }
    
    return result;
}


/* For detail description, please refer to wgui_categories_UCE.h */
MMI_BOOL wgui_cat280_remove_recipient(S32 buffer_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i = buffer_index;
    U16 header_height = 0;
    U16 footer_height = 0;
    wgui_uce_region_id_enum old_region = g_wgui_uce_cntx.recipient[buffer_index].region_id;
    MMI_BOOL is_remove_highlight = MMI_TRUE;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* check the index */
    MMI_ASSERT((buffer_index >= 0) && (buffer_index < g_wgui_uce_cntx.max_recipients_num));
#ifndef __WGUI_CAT280_SUPPORT_MMS__
    MMI_ASSERT (g_wgui_uce_cntx.recipient[buffer_index].region_id == WGUI_UCE_TO_RECIPIENTS);
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */


    if (g_wgui_uce_cntx.recipient[buffer_index].is_valid == MMI_FALSE)
    {
        return MMI_FALSE;
    }

    if (g_dm_data.s32CatId != MMI_CATEGORY280_ID)
    {
        g_wgui_uce_cntx.add_recipient_in_background = MMI_TRUE;
    }

    gdi_layer_lock_frame_buffer();

    if (g_wgui_uce_cntx.highlight_index == buffer_index)
    {
        is_remove_highlight =MMI_TRUE;
    }

    g_wgui_uce_cntx.recipient[buffer_index].is_valid = MMI_FALSE;
    g_wgui_uce_cntx.recipient[buffer_index].app_mapping_index = -1;

#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.recipient[buffer_index].region_id == WGUI_UCE_TO_RECIPIENTS)
    {
        g_wgui_uce_cntx.to_recipients_num -= 1;
        MMI_ASSERT(g_wgui_uce_cntx.to_recipients_num >= 0);
    }
    else if (g_wgui_uce_cntx.recipient[buffer_index].region_id == WGUI_UCE_CC_RECIPIENTS)
    {
        g_wgui_uce_cntx.cc_recipients_num -= 1;
        MMI_ASSERT(g_wgui_uce_cntx.cc_recipients_num >= 0);
    }
    else if (g_wgui_uce_cntx.recipient[buffer_index].region_id == WGUI_UCE_BCC_RECIPIENTS)
    {
        g_wgui_uce_cntx.bcc_recipients_num -= 1;
        MMI_ASSERT(g_wgui_uce_cntx.bcc_recipients_num >= 0);
    }
    else
    {
        /* remove undefined index */
        MMI_ASSERT(0);
    }
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
    g_wgui_uce_cntx.to_recipients_num -= 1;
    MMI_ASSERT(g_wgui_uce_cntx.to_recipients_num >= 0);
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    /* resize header area */
    wgui_cat280_get_header_and_footer_height(&header_height, &footer_height);
    MMI_multiline_inputbox.header_height = header_height;
    MMI_multiline_inputbox.min_text_height = header_height + footer_height + CAT280_MIN_LINE_HEIGHT * 2;

    /* move the recipients */
    for (i = buffer_index + 1; ((i < g_wgui_uce_cntx.max_recipients_num) && (g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE)); i++)
    {
        g_wgui_uce_cntx.recipient[i - 1].is_valid = g_wgui_uce_cntx.recipient[i].is_valid;
        g_wgui_uce_cntx.recipient[i - 1].app_mapping_index = g_wgui_uce_cntx.recipient[i].app_mapping_index;
        g_wgui_uce_cntx.recipient[i - 1].editor_flags= g_wgui_uce_cntx.recipient[i].editor_flags;
        g_wgui_uce_cntx.recipient[i - 1].region_id= g_wgui_uce_cntx.recipient[i].region_id;
        gui_strcpy((UI_string_type)g_wgui_uce_cntx.recipient[i - 1].input_buf, (UI_string_type)g_wgui_uce_cntx.recipient[i].input_buf);
    }
    g_wgui_uce_cntx.recipient[i - 1].is_valid = MMI_FALSE;
    g_wgui_uce_cntx.recipient[i - 1].app_mapping_index = -1;

    /* set highlight */
    if (is_remove_highlight)
    {
        /* search the recipient in the same region */
        for (i = buffer_index - 1; ((i >= 0) && (g_wgui_uce_cntx.recipient[i].region_id != old_region)); i--);

        if (i < 0)
        {
            i = 0;
        }

        if ((g_wgui_uce_cntx.recipient[i].is_valid == MMI_FALSE) ||
            (g_wgui_uce_cntx.recipient[i].region_id != old_region))
        {
            for (i = buffer_index; ((i < g_wgui_uce_cntx.max_recipients_num) && (g_wgui_uce_cntx.recipient[i].region_id != old_region)); i++);
        }

        MMI_ASSERT(g_wgui_uce_cntx.recipient[i].region_id == old_region);

        /* remove the recipient which in the current highlight region */
        if (old_region == g_wgui_uce_cntx.highligh_state)
        {
            if (g_dm_data.s32CatId == MMI_CATEGORY280_ID)
            {
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)old_region, i);
            }
            else
            {
                g_wgui_uce_cntx.highligh_state = old_region;
                g_wgui_uce_cntx.highlight_index = i;
            }
        }
        else
        {
            S32 recipient_index;
            recipient_index = wgui_cat280_get_first_recipient_index(g_wgui_uce_cntx.highligh_state);
            if (recipient_index >= 0)
            {
                if (g_dm_data.s32CatId == MMI_CATEGORY280_ID)
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)g_wgui_uce_cntx.highligh_state, recipient_index);
                }
                else
                {
                    g_wgui_uce_cntx.highlight_index = recipient_index;
                }
            }
        }
    }
    if (g_dm_data.s32CatId == MMI_CATEGORY280_ID)
    {
        wgui_cat280_adjust_editor_scroll_bar();
        wgui_inputs_ml_redraw();
    }

    gdi_layer_unlock_frame_buffer();
    gdi_lcd_repaint_all();
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_register_recipient_change_callback
 * DESCRIPTION
 *  If single line editor text changed, we will callback to app if necessary.
 * PARAMETERS
 *  func:           [IN] (N/A) the change callback function.     
 * RETURNS
 *  void
 *****************************************************************************/
void wgui_cat280_register_recipient_change_callback(wgui_uce_recipient_changed_handler func)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_wgui_cat280_callback.recipient_change_callback = func;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_highlight_state
 * DESCRIPTION
 *  get current highlight state.
 * PARAMETERS
 *  void
 * RETURNS
 *  wgui_uce_region_id_enum     return the highlight state.
 *****************************************************************************/
wgui_uce_region_id_enum wgui_cat280_get_highlight_state(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return g_wgui_uce_cntx.highligh_state;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_highlight_buffer_index
 * DESCRIPTION
 *  if highlight state on recipients area, return the current buffer index
 *  else return (-1)
 * PARAMETERS
 *  void
 * RETURNS
 *  S32
 *****************************************************************************/
S32 wgui_cat280_get_highlight_buffer_index(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return g_wgui_uce_cntx.highlight_index;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_buffer_index
 * DESCRIPTION
 *  get the buffer index, based on recipients region and index.
 * PARAMETERS
 *  region_id    [IN]    region id
 *  index        [IN]    recipient index
 * RETURNS
 *  S32     return buffer index, if the recipient does not exist, return (-1).
 *****************************************************************************/
S32 wgui_cat280_get_buffer_index(wgui_uce_region_id_enum region_id, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i, counter = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < g_wgui_uce_cntx.max_recipients_num; i++)
    {
        if ((g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE) &&
           (g_wgui_uce_cntx.recipient[i].region_id == region_id))
        {
            if (index == counter)
            {
                return i;
            }
            counter++;
        }
    }

    /* the recipient does not exist */
    ASSERT(0);////only for debug
    return -1;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_recipients_num
 * DESCRIPTION
 *  get the recipients number in the region.
 * PARAMETERS
 *  region_id    [IN]    region id
 * RETURNS
 *  S32   return the recipients number.
 *****************************************************************************/
S32 wgui_cat280_get_recipients_num(wgui_uce_region_id_enum region_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i, counter = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < g_wgui_uce_cntx.max_recipients_num; i++)
    {
        if ((g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE) &&
           (g_wgui_uce_cntx.recipient[i].region_id == region_id))
        {
            counter++;
        }
    }
    return counter;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_highlight_index
 * DESCRIPTION
 *  get the highlight recipients index.
 * PARAMETERS
 *  void
 * RETURNS
 *  S32   return the recipients number.
 *****************************************************************************/
S32 wgui_cat280_get_highlight_index(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; (i < g_wgui_uce_cntx.max_recipients_num); i++)
    {
        if ((g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE) && (g_wgui_uce_cntx.recipient[i].editor_flags & WGUI_UCE_HIGHLIGHT_RECIPIENT))
        {
            return i;
        }
    }
    return -1;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_adjust_with_vk
 * DESCRIPTION
 *  Adjust the multiline inputbox height, 
 *  and move the text offset for keep singleline editor visible.
 * PARAMETERS
 *  imui_x :                [IN] (N/A) X-axis of the input mode ui.
 *  imui_y :                [IN] (N/A) Y-axis of the input mode ui.
 *  imui_w :                [IN] (N/A) Width of the input mode ui.
 *  imui_h :                [IN] (N/A) Height of the input mode ui.
 * RETURNS
 *  U32
 *****************************************************************************/
static void wgui_cat280_adjust_with_vk(S32 imui_x, S32 imui_y, S32 imui_w, S32 imui_h)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 x, y, w, h;
    S32 gap;
    S32 old_text_offset_y;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_cat280_adjust_single_line_editor_position();

    x = g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN - 1;
    y = MMI_singleline_inputbox.y - MMI_multiline_inputbox.text_offset_y - MMI_multiline_inputbox.y;
    w = MMI_content_width - g_wgui_uce_cntx.max_label_width - (CAT280_HMARGIN << 1);
    h = CAT280_INLINE_SL_HEIGHT;
    gap = CAT280_VMARGIN;

    gui_lock_double_buffer();
    
    /* resize the multiline editor and make the singleline editor is visibel */
    old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
    wgui_inputs_ml_resize(WGUI_INPUTS_STYLE_DEFAULT, (imui_y - MMI_multiline_inputbox.y));
    MMI_multiline_inputbox.text_offset_y = old_text_offset_y;    
    wgui_cat280_editor_scroll_down(wgui_inputs_ml_is_area_visible(x, y, w, h, gap));

    /*
    if ((MMI_multiline_inputbox.height - MMI_multiline_inputbox.text_offset_y) > MMI_multiline_inputbox.text_height)
    {
        MMI_multiline_inputbox.text_offset_y = MMI_multiline_inputbox.height - MMI_multiline_inputbox.text_height;
    }
    */

    MMI_multiline_inputbox.ext_flags |= GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR;
    gui_unlock_double_buffer();
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_sl_RSK_up_handler
 * DESCRIPTION
 *  single line eidtor RSK up handler
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_sl_RSK_up_handler(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_inputs_sl_set_RSK();
    set_right_softkey_function(UI_dummy_function, KEY_EVENT_UP);
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_editor_msg_callback
 * DESCRIPTION
 *  Eidtor/IME callback function
 *  
 * PARAMETERS
 *  input_box_handle    [IN]  inputbox handle
 *  msg_ptr             [IN]  message type
 * RETURNS
 *  void
 *****************************************************************************/
static U32 wgui_cat280_editor_msg_callback(void * input_box_handle, mmi_imc_message_struct_p msg_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_imc_rect_p imui_rect_p;
#ifdef __MMI_TOUCH_SCREEN__
    gui_multi_line_input_box_pen_enum input_box_event = GUI_MULTI_LINE_INPUT_BOX_PEN_NONE;
#endif
    U32 lresult = 0;
    static MMI_BOOL is_pen_down_sl = MMI_FALSE;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (msg_ptr->message_id == MMI_IMC_MESSAGE_SET_KEY)
    {
#ifdef __WGUI_CAT280_ENHANCED_UI__
        if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_EDITOR) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_THUMBNAIL) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_AUDIO))
#elif defined(__WGUI_CAT280_SUPPORT_MMS__)
        if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_EDITOR) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_THUMBNAIL))
#else
        if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_EDITOR)
#endif /* __WGUI_CAT280_ENHANCED_UI__ */ 
        {
            wgui_inputs_ml_set_RSK();
        }
        else
        {
            if (!(MMI_softkeys[MMI_RIGHT_SOFTKEY].flags & UI_BUTTON_STATE_CLICKED))
            {
                /* set RSK should not create a new recipien */
                wgui_inputs_register_empty_func(NULL);
                wgui_inputs_sl_set_RSK();
                wgui_inputs_register_empty_func(wgui_cat280_sl_empty_callback);
            }
            else
            {
                set_right_softkey_function(wgui_cat280_sl_RSK_up_handler, KEY_EVENT_UP);
            }
        }
        
        wgui_inputs_ml_register_keys();
        return 0;
    }

    /* default callback */
#ifdef __WGUI_CAT280_ENHANCED_UI__
    if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_EDITOR) ||
        (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_THUMBNAIL) ||
        (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_AUDIO))
#elif defined(__WGUI_CAT280_SUPPORT_MMS__)
    if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_EDITOR) ||
        (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_THUMBNAIL))
#else
    if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_EDITOR)
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
    {
        multi_line_input_box * editor_ptr;
        editor_ptr = (multi_line_input_box *)((mmi_editor_handler_struct *)input_box_handle)->input_box_handler;
        if (editor_ptr == &MMI_multiline_inputbox)
        {
            lresult =  mmi_input_box_msg_call_back_multiline(input_box_handle, msg_ptr);

#ifdef __MMI_TOUCH_SCREEN__
            if ((msg_ptr->message_id == MMI_IMC_MESSAGE_PEN_EVENT) &&
                ((((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event == MMI_PEN_EVENT_MOVE)||
                (((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event == MMI_PEN_EVENT_REPEAT)) &&
                (((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.x > 0) && 
                (((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.y - (MMI_multiline_inputbox.y + MMI_multiline_inputbox.text_offset_y) > 0))
            {
                wgui_uce_region_id_enum temp_pen_region = WGUI_UCE_EMPTY;
                S32 temp_pen_index;

                wgui_cat280_translate_header_pen_event(
                    ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.x,
                    ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.y - (MMI_multiline_inputbox.y + MMI_multiline_inputbox.text_offset_y),
                    &temp_pen_region,
                    &temp_pen_index);
#ifdef __WGUI_CAT280_SUPPORT_MMS__
                if ((temp_pen_region != WGUI_UCE_TO_LABEL) && (temp_pen_region != WGUI_UCE_CC_LABEL) && (temp_pen_region != WGUI_UCE_BCC_LABEL))
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
                if (temp_pen_region != WGUI_UCE_TO_LABEL)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
                {
                    if (g_wgui_uce_cntx.button_down_region != WGUI_UCE_EMPTY)
                    {
                        S32 old_ext_flags;
                        MMI_BOOL set_flag_by_cat = MMI_FALSE;

                        g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;

                        old_ext_flags = MMI_multiline_inputbox.ext_flags;
                        if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_EDITOR)
                        {
                            MMI_multiline_inputbox.ext_flags |= GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR;
                            set_flag_by_cat = MMI_TRUE;
                        }

                        wgui_inputs_ml_redraw();

                        if ((!(old_ext_flags & GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR)) && (set_flag_by_cat == MMI_TRUE))
                        {
                            MMI_multiline_inputbox.ext_flags &= ~GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR;
                        }
                    }
                }
            }
#endif /* __MMI_TOUCH_SCREEN__ */
        }
        
        return lresult;
    }
    else
    {
#ifdef __MMI_TOUCH_SCREEN__
        /* pen on single editor */
        if ((msg_ptr->message_id != MMI_IMC_MESSAGE_PEN_EVENT) ||
            ((PEN_CHECK_BOUND(
                ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.x,
                ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.y, 
                MMI_singleline_inputbox.x, 
                MMI_singleline_inputbox.y, 
                MMI_singleline_inputbox.width, 
                MMI_singleline_inputbox.height)) &&
            (PEN_CHECK_BOUND(
                ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.x,
                ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.y, 
                MMI_multiline_inputbox.x, 
                MMI_multiline_inputbox.y, 
                MMI_multiline_inputbox.width, 
                MMI_multiline_inputbox.height))))
#endif /* __MMI_TOUCH_SCREEN__ */
        {
            single_line_input_box * editor_ptr;
            editor_ptr = (single_line_input_box *)((mmi_editor_handler_struct *)input_box_handle)->input_box_handler;
            if (editor_ptr == &MMI_singleline_inputbox)
            {
                switch (msg_ptr->message_id)
                {
                    case MMI_IMC_MESSAGE_CHECK_INFO_BAR_ENABL:
                        lresult = MMI_TRUE;
                        break;

                    case MMI_IMC_MESSAGE_RESIZE:
                    case MMI_IMC_MESSAGE_MOVE:
                        break;
                            
                    case MMI_IMC_MESSAGE_IMUI_RECTANGLE_IS_UPDATED:
                        imui_rect_p = (mmi_imc_rect_p)(msg_ptr->param_0);
                        wgui_cat280_adjust_with_vk(imui_rect_p->x, imui_rect_p->y, imui_rect_p->width, imui_rect_p->height);
                        MMI_multiline_inputbox.ext_flags |= GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR;
                        break;
        
                    case MMI_IMC_MESSAGE_REDRAW: 
                        if (msg_ptr->param_0 == 1)
                        {
                            dm_imui_window_hide();
                        }
                        else
                        {
                        #if defined(GUI_EDITOR_SHOW_TITLE)
                            if (!(g_dm_data.s32flags & DM_NO_TITLE))
                            {
                                draw_title();
                            }
                        #endif /* !defined(GUI_EDITOR_SHOW_TITLE) */

                        #ifdef __MMI_FTE_SUPPORT__
                            wgui_inputs_ml_redraw_input_information_bar();
                        #endif

                            wgui_inputs_ml_redraw();
                        }
                        break;
                        
                        case MMI_IMC_MESSAGE_DRAW_INFORMATION_BAR:
                            #ifdef __WGUI_CAT280_ENHANCED_UI__
                                if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_EDITOR) ||
                                    (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_THUMBNAIL) ||
                                    (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_AUDIO))
                            #elif defined(__WGUI_CAT280_SUPPORT_MMS__)
                                if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_EDITOR) ||
                                    (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_THUMBNAIL))
                            #else
                                if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_EDITOR)
                            #endif /* __WGUI_CAT280_ENHANCED_UI__ */
                                    {
                                        wgui_inputs_ml_redraw_input_information_bar();
                                    }
                            #ifndef __MMI_FTE_SUPPORT__
                                    else
                                    {
                                        //wgui_inputs_sl_redraw_information_bar();
                                        wgui_inputs_ml_redraw_input_information_bar();
                                    }
                            #endif
                        break;
                            
#ifdef __MMI_TOUCH_SCREEN__
                    case MMI_IMC_MESSAGE_PEN_EVENT:
                        /* if single line editor is out of multiline area, we need to adjust the scrollbar */
                        wgui_cat280_adjust_editor_scroll_bar();

                        if (((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event == MMI_PEN_EVENT_DOWN)
                        {
                            is_pen_down_sl = MMI_TRUE;
                        }

                        if (is_pen_down_sl == MMI_TRUE)
                        {
                            lresult = mmi_input_box_msg_call_back_singleline(input_box_handle, msg_ptr);
                        }
                        else
                        {
                            /* if not pen down on singleline eidtor, the pen event should be handled by multiline editor */
                            lresult = gui_multi_line_input_box_translate_pen_event(
                                        &MMI_multiline_inputbox,
                                        ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event,
                                        ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.x,
                                        ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.y,
                                        &input_box_event);
                            if (((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event == MMI_PEN_EVENT_UP)
                            {
                                g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;
                                if ((g_dm_data.s32CatId == MMI_CATEGORY280_ID) &&
                                    (GUI_MULTI_LINE_INPUT_BOX_PEN_SCROLL_BAR != input_box_event) &&
                                    (GUI_MULTI_LINE_INPUT_BOX_PEN_NONE != input_box_event))
                                {
                                    wgui_inputs_ml_redraw();
                                }
                            }
                            else if (((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event == MMI_PEN_EVENT_MOVE)
                            {
                                if (PEN_CHECK_BOUND(
                                    ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.x,
                                    ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.y, 
                                    g_wgui_uce_cntx.label_x, 
                                    MMI_singleline_inputbox.y, 
                                    g_wgui_uce_cntx.label_w, 
                                    g_wgui_uce_cntx.label_h) == MMI_FALSE)
                                {
                                    if ((GUI_MULTI_LINE_INPUT_BOX_PEN_SCROLL_BAR != input_box_event))
                                    {
                                        if (g_wgui_uce_cntx.button_down_region != WGUI_UCE_EMPTY)
                                        {
                                            g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;
                                            wgui_inputs_ml_redraw();
                                        }
                                    }
                                }
                            }
                        }

                        if ((((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event == MMI_PEN_EVENT_UP) ||
                            (((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event == MMI_PEN_EVENT_ABORT))
                        {
                            is_pen_down_sl = MMI_FALSE;
                        }
                        break;
#endif /* __MMI_TOUCH_SCREEN__ */

                    default:
                        lresult = mmi_input_box_msg_call_back_singleline(input_box_handle, msg_ptr);
                }

#ifdef __MMI_TOUCH_SCREEN__
                /* if pen event on singleline editor, we need to redraw multiline */
                if (msg_ptr->message_id == MMI_IMC_MESSAGE_PEN_EVENT)
                {
                    wgui_uce_region_id_enum old_button_state = g_wgui_uce_cntx.button_down_region;
                    if (((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event == MMI_PEN_EVENT_UP)
                    {
                        g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;
                    }
                    if (old_button_state != g_wgui_uce_cntx.button_down_region)
                    {
                        wgui_inputs_ml_redraw();
                    }

                }
#endif /* __MMI_TOUCH_SCREEN__ */
            }
        }
#ifdef __MMI_TOUCH_SCREEN__
        else
        {
            if ((((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event == MMI_PEN_EVENT_DOWN))
            {
                wgui_cat280_ime_pre_vk_handler(
                    ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.x,
                    ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.y);
            }

            lresult = gui_multi_line_input_box_translate_pen_event(
                        &MMI_multiline_inputbox,
                        ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event,
                        ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.x,
                        ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.y,
                        &input_box_event);
            if (((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event == MMI_PEN_EVENT_UP)
            {
                g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;
                if ((g_dm_data.s32CatId == MMI_CATEGORY280_ID) &&
                    (GUI_MULTI_LINE_INPUT_BOX_PEN_SCROLL_BAR != input_box_event) &&
                    (GUI_MULTI_LINE_INPUT_BOX_PEN_NONE != input_box_event))
                {
                    wgui_inputs_ml_redraw();
                }
            }
            else if (((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->mmi_pen_event == MMI_PEN_EVENT_MOVE)
            {
                if (PEN_CHECK_BOUND(
                    ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.x,
                    ((mmi_imc_editor_pen_event_struct_p)msg_ptr->param_0)->pos.y, 
                    g_wgui_uce_cntx.label_x, 
                    MMI_singleline_inputbox.y, 
                    g_wgui_uce_cntx.label_w, 
                    g_wgui_uce_cntx.label_h) == MMI_FALSE)
                {
                    if ((GUI_MULTI_LINE_INPUT_BOX_PEN_SCROLL_BAR != input_box_event))
                    {
                        if (g_wgui_uce_cntx.button_down_region != WGUI_UCE_EMPTY)
                        {
                            g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;
                            wgui_inputs_ml_redraw();
                        }
                    }
                }
            }
        }
#endif /* __MMI_TOUCH_SCREEN__ */

        return lresult;
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_sl_background
 * DESCRIPTION
 *  Draw the singleline editor background.
 * PARAMETERS
 *  x1      [IN]        start X
 *  y1      [IN]        start Y
 *  x2      [IN]        end X
 *  y2      [IN]        end Y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_sl_background(S32 x1, S32 y1, S32 x2, S32 y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 prev_x1, prev_y1, prev_x2, prev_y2;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_push_clip();
    gui_set_clip_preset(x1, y1, x2, y2);

    gdi_layer_get_clip(&prev_x1, &prev_y1, &prev_x2, &prev_y2);
    if (prev_y1 < prev_y2)
    {
        gui_fill_rectangle(x1, y1, x2, y2, MMI_multiline_inputbox.normal_filler->c);
    }
    gui_pop_clip();
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_set_highlight_state_and_index
 * DESCRIPTION
 *  set highlight state
 * PARAMETERS
 *  state   [IN]  highlight state
 *  index   [IN]  highlight index
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_set_highlight_state_and_index(wgui_uce_highlight_state_enum state, S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UI_buffer_type inputs_buffer = 0;
    S32 inputs_buffer_size = 0;
    U32 inputs_type = 0;
    S32 vbar_w = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (state == WGUI_UCE_TO_RECIPIENTS || state == WGUI_UCE_CC_RECIPIENTS || state == WGUI_UCE_BCC_RECIPIENTS || state == WGUI_UCE_SUBJECT)
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
    MMI_ASSERT ((state != WGUI_UCE_CC_RECIPIENTS) && (state != WGUI_UCE_BCC_RECIPIENTS) && (state != WGUI_UCE_SUBJECT));
    if (state == WGUI_UCE_TO_RECIPIENTS)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    {
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        if (state == WGUI_UCE_SUBJECT)
        {
            ASSERT (index == -1);
        }
        else
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        {
            ASSERT((index >= 0) &&(index < g_wgui_uce_cntx.max_recipients_num));
        }

        MMI_multiline_inputbox.ext_flags |= GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR;
        wgui_inputs_set_current_input_box_type(EDITOR_SINGLE_LINE_INPU_BOX);
#if defined(__WGUI_CAT280_ENHANCED_UI__) && !defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__)
        if ((g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS) && (g_wgui_uce_cntx.is_attachment == MMI_TRUE))
        {
            gui_icontext_button_overwirte_pen_response_area(&g_wgui_uce_cntx.attach_button, 0, 0, 0, 0);
        }
#endif
    }
    else
    {
        ASSERT (index == -1);
        MMI_multiline_inputbox.ext_flags &= ~GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR;
        wgui_inputs_set_current_input_box_type(EDITOR_MULTILINE_INPUT_BOX);
#if defined(__WGUI_CAT280_ENHANCED_UI__) && !defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__)
        if ((g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS) && (g_wgui_uce_cntx.is_attachment == MMI_TRUE))
        {
            gui_icontext_button_overwirte_pen_response_area(
                &g_wgui_uce_cntx.attach_button,
                g_wgui_uce_cntx.attach_button.x,
                g_wgui_uce_cntx.attach_button.y,
                g_wgui_uce_cntx.attach_button.x + g_wgui_uce_cntx.attach_button.width,
                g_wgui_uce_cntx.attach_button.y + g_wgui_uce_cntx.attach_button.height);
        }
#endif
    }

    /* get the ime history */
    if (mmi_imc_is_connected())
    {
        if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_EDITOR)
        {
            mmi_imc_get_input_method_history(&g_wgui_uce_cntx.ml_ime);
            g_wgui_uce_cntx.need_to_set_ml_ime = MMI_TRUE;
        }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        else if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_CC_RECIPIENTS) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_BCC_RECIPIENTS))
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
        else if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        {
            mmi_imc_get_input_method_history(&g_wgui_uce_cntx.sl_ime);
            g_wgui_uce_cntx.need_to_set_sl_ime = MMI_TRUE;
        }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        else if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_SUBJECT)
        {
            mmi_imc_get_input_method_history(&g_wgui_uce_cntx.subject_ime);
            g_wgui_uce_cntx.need_to_set_subject_ime = MMI_TRUE;
        }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        else
        {
            mmi_imc_get_input_method_history(&g_wgui_uce_cntx.ml_ime);
            g_wgui_uce_cntx.need_to_set_ml_ime = MMI_TRUE;
        }
    }

    mmi_imc_reset_ime_state();
    wgui_inputs_register_empty_func(NULL);
#ifdef __WGUI_CAT280_ENHANCED_UI__
    g_wgui_uce_cntx.old_highlight_state = g_wgui_uce_cntx.highligh_state;
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
    g_wgui_uce_cntx.highligh_state = (wgui_uce_region_id_enum)state;
    g_wgui_uce_cntx.highlight_index= index;

    if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_EDITOR)
    {
        wgui_inputs_ml_disable();
    }
    else
    {
        wgui_inputs_ml_enable();
    }
#ifdef __WGUI_CAT280_ENHANCED_UI__
    if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_EDITOR) ||
        (g_wgui_uce_cntx.highligh_state == WGUI_UCE_THUMBNAIL) ||
        (g_wgui_uce_cntx.highligh_state == WGUI_UCE_AUDIO))
#elif defined(__WGUI_CAT280_SUPPORT_MMS__)
    if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_EDITOR) ||
        (g_wgui_uce_cntx.highligh_state == WGUI_UCE_THUMBNAIL))
#else
    if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_EDITOR)
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
    {
        wgui_inputs_disconnect();
        wgui_inputbox_information_flag = MMI_TRUE;

        /* set ime */
#ifdef __MMI_FTE_SUPPORT__
        if (g_wgui_uce_cntx.need_to_set_ml_ime || (g_wgui_uce_cntx.ml_ime.is_vk_on == MMI_TRUE))
#else /* __MMI_FTE_SUPPORT__ */
        if (g_wgui_uce_cntx.need_to_set_ml_ime)
#endif /* __MMI_FTE_SUPPORT__ */
        {
#if defined(__MMI_IME_AUTO_CAPITALIZATION__)
            if  (g_wgui_uce_cntx.add_content_in_background)
            {
                g_wgui_uce_cntx.ml_ime.skip_auto_cap_first_filter = MMI_TRUE;
            }
#endif
            mmi_imc_set_input_method_history(&g_wgui_uce_cntx.ml_ime);
        }

        wgui_inputs_connect(
            g_wgui_uce_cntx.editor_input_type,
            NULL,
            IMM_INPUT_MODE_NONE,
            MMI_EDITOR_MULTILINE_INPUT_BOX,
            MMI_EDITOR_UCE_MULTLINE_INPUT_BOX,
            &MMI_multiline_inputbox,
            wgui_cat280_editor_msg_callback);

        /* enable new line symbol */
        MMI_current_input_ext_type &= ~INPUT_TYPE_EXT_NO_SHOW_NEW_LINE_SYMBOL;

        mmi_imc_redraw_screen_by_state();
        wgui_inputs_ml_redraw_input_information_bar();
    }
    else
    {
        mmi_imc_disconnect();
        
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_CC_RECIPIENTS) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_BCC_RECIPIENTS))
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
        if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        {
            inputs_buffer = g_wgui_uce_cntx.recipient[g_wgui_uce_cntx.highlight_index].input_buf;
            inputs_buffer_size = g_wgui_uce_cntx.recipient_buffer_size;
            inputs_type = g_wgui_uce_cntx.recipient_input_type;
            if ((g_wgui_uce_cntx.sl_history == NULL) && (g_wgui_uce_cntx.need_to_set_sl_ime == MMI_FALSE))
            {
                mmi_imm_set_app_desired_input_mode(IMM_INPUT_MODE_123_SYMBOLS);
            }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
#if !defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__)
            if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS)
            {
                wgui_cat280_resize_and_move_button(g_wgui_uce_cntx.pre_bt, 0, 0, 0, 0);
                wgui_cat280_resize_and_move_button(g_wgui_uce_cntx.next_bt, 0, 0, 0, 0);
            }
#endif /* !defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__) */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        else if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_SUBJECT)
        {
            inputs_buffer = g_wgui_uce_cntx.subject.input_buf;
            inputs_buffer_size = g_wgui_uce_cntx.subject.buffer_size;
            inputs_type = g_wgui_uce_cntx.subject.input_type;
        }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

        mmi_imc_set_fixed_input_box();
        wgui_inputs_sl_disable_up_down_key_register(MMI_TRUE);

        if (MMI_multiline_inputbox.scrollbar_state)
        {
            vbar_w = MMI_multiline_inputbox.vbar.width;
        }

        /* set ime */
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_CC_RECIPIENTS) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_BCC_RECIPIENTS))
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
        if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        {
            if (g_wgui_uce_cntx.need_to_set_sl_ime)
            {
                singleline_inputbox_category_history *sl_h = (singleline_inputbox_category_history*) g_wgui_uce_cntx.sl_history;
                mmi_imc_set_input_method_history(&g_wgui_uce_cntx.sl_ime);
                if (g_wgui_uce_cntx.sl_history != NULL)
                {
                    gui_memcpy(&(sl_h->ime_history), &g_wgui_uce_cntx.sl_ime, sizeof(mmi_imc_history));
                }
            }
        }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        else if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_SUBJECT)
        {
            if (g_wgui_uce_cntx.need_to_set_subject_ime)
            {
                singleline_inputbox_category_history *sl_h = (singleline_inputbox_category_history*) g_wgui_uce_cntx.sl_history;
                mmi_imc_set_input_method_history(&g_wgui_uce_cntx.subject_ime);
                if (g_wgui_uce_cntx.sl_history != NULL)
                {
                    gui_memcpy(&(sl_h->ime_history), &g_wgui_uce_cntx.subject_ime, sizeof(mmi_imc_history));
                }
            }
        }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

        /* singleline inputbox */
        wgui_inputs_sl_setup_ext(
            0,
            0,
            MMI_content_width - g_wgui_uce_cntx.max_label_width - (CAT280_HMARGIN << 1) - vbar_w,
            CAT280_INLINE_SL_HEIGHT,
            inputs_buffer,
            inputs_buffer_size,
            MMI_CATEGORY280_ID,
            get_string(g_wgui_uce_cntx.right_softkey),
            get_image(g_wgui_uce_cntx.right_softkey_icon),
            inputs_type,
            g_wgui_uce_cntx.sl_history,
            0,
            wgui_cat280_editor_msg_callback);

        /* set the RSK function */
        wgui_singleline_inputbox_RSK_function = wgui_inputbox_RSK_function;
        
        /* change callback and empty callback */
        MMI_singleline_inputbox.change_callback = wgui_cat280_sl_change_callback;

        /* set the singleline background */
        gui_inputs_register_redraw_background_filler(wgui_cat280_draw_sl_background);

        /* call the function while the text change (insert/ delete/ delete all) */
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_CC_RECIPIENTS) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_BCC_RECIPIENTS))
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
        if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        {
            wgui_inputs_sl_register_change_event_handler(wgui_cat280_sl_change_event_callback);
        }

        /* set flag */
        MMI_current_input_ext_type |= INPUT_TYPE_EXT_NO_SHOW_NEW_LINE_SYMBOL;
        if ((g_wgui_uce_cntx.highlight_index != -1) && 
            (g_wgui_uce_cntx.recipient[g_wgui_uce_cntx.highlight_index].editor_flags & WGUI_UCE_HIGHLIGHT_RECIPIENT))
        {
            MMI_singleline_inputbox.flags |= UI_SINGLE_LINE_INPUT_BOX_WORD_HIGHLIGHT | UI_SINGLE_LINE_INPUT_BOX_AUTO_CLEAR_HIGHLIGHT_MODE;
            MMI_singleline_inputbox.highlight_start_position = inputs_buffer;
            MMI_singleline_inputbox.highlight_end_position = inputs_buffer + (inputs_buffer_size * ENCODING_LENGTH);
            g_wgui_uce_cntx.recipient[g_wgui_uce_cntx.highlight_index].editor_flags &= ~WGUI_UCE_HIGHLIGHT_RECIPIENT;
        }
        if ((g_wgui_uce_cntx.highlight_index != -1) && 
            (g_wgui_uce_cntx.recipient[g_wgui_uce_cntx.highlight_index].editor_flags & WGUI_UCE_WRAPPING_DELETE_RECIPIENT))
        {
            MMI_singleline_inputbox.ext_flags |= GUI_SINGLE_LINE_INPUT_BOX_RECIPIENT_MODE;
        }
        MMI_singleline_inputbox.flags |= UI_SINGLE_LINE_INPUT_BOX_USE_PRESET_CLIPPING;

        if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_SUBJECT)
        {
            MMI_singleline_inputbox.ext_flags |= GUI_SINGLE_LINE_INPUT_BOX_RECIPIENT_SEMICOLON_MODE;
        }
        
        /* clear singleline history */
        g_wgui_uce_cntx.sl_history = NULL;
        
        /* set vk state */
#ifndef __MMI_FTE_SUPPORT__
        //wgui_inputs_sl_redraw_information_bar();
        wgui_inputs_ml_redraw_input_information_bar();
#endif
        mmi_imc_redraw_screen_by_state();
    }
    
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (state == WGUI_UCE_TO_RECIPIENTS || state == WGUI_UCE_CC_RECIPIENTS || state == WGUI_UCE_BCC_RECIPIENTS || state == WGUI_UCE_SUBJECT)
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
    if (state == WGUI_UCE_TO_RECIPIENTS)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    {
        MMI_multiline_inputbox.ext_flags |= GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR;
    }

    redraw_left_softkey();
    redraw_right_softkey();
    redraw_center_softkey();

    if (g_wgui_cat280_callback.highlight_ext != NULL)
    {
        g_wgui_cat280_callback.highlight_ext(state, index); /* callback APP to set LSK */
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_recipients_num_before_highlight
 * DESCRIPTION
 *  get the recipients number before high light
 * PARAMETERS
 *  region_id    [IN]    region id
 * RETURNS
 *  S32   
 *****************************************************************************/
static S32 wgui_cat280_get_recipients_num_before_highlight(wgui_uce_region_id_enum region_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i, counter = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __WGUI_CAT280_SUPPORT_MMS__
    MMI_ASSERT ((region_id != WGUI_UCE_CC_RECIPIENTS) && (region_id != WGUI_UCE_BCC_RECIPIENTS));
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    for (i = 0; i < g_wgui_uce_cntx.highlight_index; i++)
    {
        if ((g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE) &&
           (g_wgui_uce_cntx.recipient[i].region_id == region_id))
        {
            counter++;
        }
    }

    return counter;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_last_recipient_index
 * DESCRIPTION
 *  get the last recipient index in the region
 * PARAMETERS
 *  region_id    [IN]    region id
 * RETURNS
 *  S32   
 *****************************************************************************/
static S32 wgui_cat280_get_last_recipient_index(wgui_uce_region_id_enum region_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __WGUI_CAT280_SUPPORT_MMS__
    MMI_ASSERT ((region_id != WGUI_UCE_CC_RECIPIENTS) && (region_id != WGUI_UCE_BCC_RECIPIENTS));
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    for (i = (g_wgui_uce_cntx.max_recipients_num - 1); i >= 0; i--)
    {
        if ((g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE) &&
           (g_wgui_uce_cntx.recipient[i].region_id == region_id))
        {
            return i;
        }
    }

    return -1;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_first_recipient_index
 * DESCRIPTION
 *  get the first recipient index in the region
 * PARAMETERS
 *  region_id    [IN]    region id
 * RETURNS
 *  S32   
 *****************************************************************************/
static S32 wgui_cat280_get_first_recipient_index(wgui_uce_region_id_enum region_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __WGUI_CAT280_SUPPORT_MMS__
    MMI_ASSERT ((region_id != WGUI_UCE_CC_RECIPIENTS) && (region_id != WGUI_UCE_BCC_RECIPIENTS));
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    for (i = 0; i < g_wgui_uce_cntx.max_recipients_num; i++)
    {
        if ((g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE) &&
           (g_wgui_uce_cntx.recipient[i].region_id == region_id))
        {
            return i;
        }
    }

    return -1;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_next_recipient_index
 * DESCRIPTION
 *  get the next recipient index in the region
 * PARAMETERS
 *  region_id    [IN]    region id
 * RETURNS
 *  S32   
 *****************************************************************************/
static S32 wgui_cat280_get_next_recipient_index(wgui_uce_region_id_enum region_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __WGUI_CAT280_SUPPORT_MMS__
    MMI_ASSERT ((region_id != WGUI_UCE_CC_RECIPIENTS) && (region_id != WGUI_UCE_BCC_RECIPIENTS));
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    for (i = g_wgui_uce_cntx.highlight_index + 1; i < g_wgui_uce_cntx.max_recipients_num; i++)
    {
        if ((g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE) &&
           (g_wgui_uce_cntx.recipient[i].region_id == region_id))
        {
            return i;
        }
    }

    return -1;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_previous_recipient_index
 * DESCRIPTION
 *  get the previous recipient index in the region
 * PARAMETERS
 *  region_id    [IN]    region id
 * RETURNS
 *  S32   
 *****************************************************************************/
static S32 wgui_cat280_get_previous_recipient_index(wgui_uce_region_id_enum region_id)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __WGUI_CAT280_SUPPORT_MMS__
    MMI_ASSERT ((region_id != WGUI_UCE_CC_RECIPIENTS) && (region_id != WGUI_UCE_BCC_RECIPIENTS));
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    for (i = g_wgui_uce_cntx.highlight_index - 1; i >= 0; i--)
    {
        if ((g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE) &&
           (g_wgui_uce_cntx.recipient[i].region_id == region_id))
        {
            return i;
        }
    }

    return -1;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_adjust_single_line_editor_position
 * DESCRIPTION
 *  adjust the single line editor by the multiline inputbox highlighted state.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_adjust_single_line_editor_position(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 sl_x, sl_y, sl_w, sl_h;
    S32 vbar_w = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/   
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    /* if no single line editor, return */
    if ((wgui_cat280_get_highlight_state() != WGUI_UCE_TO_RECIPIENTS) &&
        (wgui_cat280_get_highlight_state() != WGUI_UCE_CC_RECIPIENTS) &&
        (wgui_cat280_get_highlight_state() != WGUI_UCE_BCC_RECIPIENTS) &&
        (wgui_cat280_get_highlight_state() != WGUI_UCE_SUBJECT))
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
    if (wgui_cat280_get_highlight_state() != WGUI_UCE_TO_RECIPIENTS)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    {
        return;
    }
    
    if (MMI_multiline_inputbox.scrollbar_state)
    {
        vbar_w = MMI_multiline_inputbox.vbar.width;
    }

    sl_x = g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN - 1;
    sl_y = 0;
    sl_w = MMI_content_width - g_wgui_uce_cntx.max_label_width - (CAT280_HMARGIN << 1) - vbar_w,
    sl_h = CAT280_INLINE_SL_HEIGHT;

#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (wgui_cat280_get_highlight_state() != WGUI_UCE_TO_RECIPIENTS)
    {
        sl_y += (CAT280_VMARGIN >> 1) + (CAT280_INLINE_SL_HEIGHT * g_wgui_uce_cntx.to_recipients_num);
    }
    else
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    {
        sl_y += (CAT280_INLINE_SL_HEIGHT * wgui_cat280_get_recipients_num_before_highlight(WGUI_UCE_TO_RECIPIENTS));
        sl_y += MMI_multiline_inputbox.text_offset_y + MMI_multiline_inputbox.y;
        wgui_inputs_sl_move(sl_x, sl_y);
        wgui_inputs_sl_resize(sl_w, sl_h);
        return;
    }

#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (wgui_cat280_get_highlight_state() != WGUI_UCE_CC_RECIPIENTS)
    {
        sl_y += (CAT280_VMARGIN >> 1) + (CAT280_INLINE_SL_HEIGHT * g_wgui_uce_cntx.cc_recipients_num);
    }
    else
    {
        sl_y += (CAT280_INLINE_SL_HEIGHT * wgui_cat280_get_recipients_num_before_highlight(WGUI_UCE_CC_RECIPIENTS));
        sl_y += MMI_multiline_inputbox.text_offset_y + MMI_multiline_inputbox.y;
        wgui_inputs_sl_move(sl_x, sl_y);
        wgui_inputs_sl_resize(sl_w, sl_h);
        return;
    }

    if (wgui_cat280_get_highlight_state() != WGUI_UCE_BCC_RECIPIENTS)
    {
        sl_y += (CAT280_VMARGIN >> 1) + (CAT280_INLINE_SL_HEIGHT * g_wgui_uce_cntx.bcc_recipients_num);
    }
    else
    {
        sl_y += (CAT280_INLINE_SL_HEIGHT * wgui_cat280_get_recipients_num_before_highlight(WGUI_UCE_BCC_RECIPIENTS));
        sl_y += MMI_multiline_inputbox.text_offset_y + MMI_multiline_inputbox.y;
        wgui_inputs_sl_move(sl_x, sl_y);
        wgui_inputs_sl_resize(sl_w, sl_h);
        return;
    }

    if (wgui_cat280_get_highlight_state() != WGUI_UCE_SUBJECT)
    {
        ASSERT(0);
    }
    else
    {
        sl_y += (CAT280_VMARGIN >> 1) + MMI_multiline_inputbox.text_offset_y + MMI_multiline_inputbox.y;
        wgui_inputs_sl_move(sl_x, sl_y);
        wgui_inputs_sl_resize(sl_w, sl_h);
        return;
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_adjust_editor_scroll_bar
 * DESCRIPTION
 *  adjust the scroll to the visible area by the multiline inputbox highlighted state.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_adjust_editor_scroll_bar(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 x, y = (CAT280_VMARGIN >> 1), w, h = 0;
    S32 gap;
    S32 offset = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/ 
    if(!g_dm_data.s32CatId)
      return;    
    x = g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN - 1;
    w = MMI_content_width - g_wgui_uce_cntx.max_label_width - (CAT280_HMARGIN << 1);
    gap = CAT280_VMARGIN;
    
    if (wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS) != 0)
    {
        if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_TO_RECIPIENTS)
        {
            y += CAT280_INLINE_SL_HEIGHT * wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS);
            y += (CAT280_VMARGIN >> 1);
        }
        else
        {
            y = CAT280_INLINE_SL_HEIGHT * wgui_cat280_get_recipients_num_before_highlight(WGUI_UCE_TO_RECIPIENTS);
            h = CAT280_INLINE_SL_HEIGHT;
            wgui_cat280_editor_scroll_down(wgui_inputs_ml_is_area_visible(x, y, w, h, gap));
            return;
        }
    }
    
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (wgui_cat280_get_recipients_num(WGUI_UCE_CC_RECIPIENTS) != 0)
    {
        if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_CC_RECIPIENTS)
        {
            y += CAT280_INLINE_SL_HEIGHT * wgui_cat280_get_recipients_num(WGUI_UCE_CC_RECIPIENTS);
            y += (CAT280_VMARGIN >> 1);
        }
        else
        {
            y = y + CAT280_INLINE_SL_HEIGHT * wgui_cat280_get_recipients_num_before_highlight(WGUI_UCE_CC_RECIPIENTS);
            h = CAT280_INLINE_SL_HEIGHT;
            wgui_cat280_editor_scroll_down(wgui_inputs_ml_is_area_visible(x, y, w, h, gap));
            return;
        }
    }

    if (wgui_cat280_get_recipients_num(WGUI_UCE_BCC_RECIPIENTS) != 0)
    {
        if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_BCC_RECIPIENTS)
        {
            y += CAT280_INLINE_SL_HEIGHT * wgui_cat280_get_recipients_num(WGUI_UCE_BCC_RECIPIENTS);
            y += (CAT280_VMARGIN >> 1);
        }
        else
        {
            y = y + CAT280_INLINE_SL_HEIGHT * wgui_cat280_get_recipients_num_before_highlight(WGUI_UCE_BCC_RECIPIENTS);
            h = CAT280_INLINE_SL_HEIGHT;
            wgui_cat280_editor_scroll_down(wgui_inputs_ml_is_area_visible(x, y, w, h, gap));
            return;
        }
    }

    if (g_wgui_uce_cntx.has_editable_subject == MMI_TRUE)
    {
        if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_HIGHLIGHT_SUBJECT)
        {
            y += CAT280_INLINE_SL_HEIGHT;
            y += (CAT280_VMARGIN >> 1);
        }
        else
        {
            h = CAT280_INLINE_SL_HEIGHT;
            wgui_cat280_editor_scroll_down(wgui_inputs_ml_is_area_visible(x, y, w, h, gap));
            return;
        }
    }

    if ((g_wgui_uce_cntx.has_thumbnail == MMI_TRUE) && 
        (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
    {
        if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_HIGHLIGHT_THUMBNAIL)
        {
            y += CAT280_THUMBNAIL_FRAME_HEIGHT;
            y += (CAT280_VMARGIN >> 1);
        }
        else
        {
            h = CAT280_THUMBNAIL_FRAME_HEIGHT;
            wgui_cat280_editor_scroll_down(wgui_inputs_ml_is_area_visible(x, y, w, h, gap));
            return;
        }
    }
    else if ((g_wgui_uce_cntx.has_thumbnail == MMI_TRUE) && 
        (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
    {
#ifdef __WGUI_CAT280_ENHANCED_UI__
        if ((g_wgui_uce_cntx.is_audio == MMI_TRUE) &&
            (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
        {
            if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_THUMBNAIL)
            {
                offset = wgui_inputs_ml_is_area_visible(
                            g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN - 1,
                            MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.footer_height + (CAT280_VMARGIN >> 1),
                            MMI_content_width - g_wgui_uce_cntx.max_label_width - (CAT280_HMARGIN << 1),
                            CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN << 1),
                            (CAT280_VMARGIN >> 1));
                wgui_cat280_editor_scroll_down(offset); 
                return;
            }
            else if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_AUDIO)
            {
                offset = wgui_inputs_ml_is_area_visible(
                            g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN - 1,
                            MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.footer_height + CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1),
                            MMI_content_width - g_wgui_uce_cntx.max_label_width - (CAT280_HMARGIN << 1),
                            CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN << 1),
                            (CAT280_VMARGIN >> 1));
                wgui_cat280_editor_scroll_down(offset); 
                return;
            }   
        }
        else if ((g_wgui_uce_cntx.is_audio == MMI_TRUE) &&
            (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
        {
            if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_THUMBNAIL)
            {
                offset = wgui_inputs_ml_is_area_visible(
                            g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN - 1,
                            MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.footer_height + (CAT280_VMARGIN >> 1),
                            MMI_content_width - g_wgui_uce_cntx.max_label_width - (CAT280_HMARGIN << 1),
                            CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN << 1),
                            (CAT280_VMARGIN >> 1));
                wgui_cat280_editor_scroll_down(offset); 
                return;
            }
            else if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_AUDIO)
            {
                h = CAT280_THUMBNAIL_FRAME_HEIGHT;
                wgui_cat280_editor_scroll_down(wgui_inputs_ml_is_area_visible(x, y, w, h, gap));
                return;
            }  
        }
        else
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
        {
            wgui_cat280_move_to_editor_top();
            if (MMI_multiline_inputbox.text_height > MMI_multiline_inputbox.height)
            {
                wgui_cat280_editor_scroll_down(MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.height + CAT280_VMARGIN);
            }
            return;
        }
    }

#ifdef __WGUI_CAT280_ENHANCED_UI__
    if ((g_wgui_uce_cntx.is_audio == MMI_TRUE) && 
        (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
    {
        if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_HIGHLIGHT_AUDIO)
        {
            y += CAT280_THUMBNAIL_FRAME_HEIGHT;
            y += (CAT280_VMARGIN >> 1);
        }
        else
        {
            h = CAT280_THUMBNAIL_FRAME_HEIGHT;
            wgui_cat280_editor_scroll_down(wgui_inputs_ml_is_area_visible(x, y, w, h, gap));
            return;
        }
    }
    else if ((g_wgui_uce_cntx.is_audio == MMI_TRUE) && 
        (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
    {
        if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_AUDIO)
        {
            wgui_cat280_move_to_editor_top();
            wgui_cat280_editor_scroll_down(MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.height + CAT280_VMARGIN);
            return;
        }
    }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_EDITOR)
    {
        //wgui_cat280_ml_go_to_last_position();
        return;
    }
    else
    {
        ASSERT(0);
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_header_and_footer_height
 * DESCRIPTION
 *  get editor header and footer height
 * PARAMETERS
 *  header_height       [OUT]
 *  footer_height       [OUT]
 * RETURNS
 *  wgui_uce_layout_type_enum
 *****************************************************************************/
static void wgui_cat280_get_header_and_footer_height(U16 *header_height, U16 *footer_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 header = 0, footer = 0;
    S32 total_num = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    /* MMS has preview object area */
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS)
    {
        if (g_wgui_uce_cntx.is_video || g_wgui_uce_cntx.is_image)
        {
            if (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)
            {
                header = CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1);
            }
            else if (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)
            {
                footer = CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN);
            }
            else
            {
                ASSERT(0);
            }
            g_wgui_uce_cntx.has_thumbnail = MMI_TRUE;
        }
        else
        {
            g_wgui_uce_cntx.has_thumbnail = MMI_FALSE;
        }
        
#ifdef __WGUI_CAT280_ENHANCED_UI__
        if (g_wgui_uce_cntx.is_audio)
        {
            if (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)
            {
                header += CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1);;
            }
            else if (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)
            {
                if (footer == 0)
                {
                    footer += (CAT280_VMARGIN >> 1);
                }
                
                footer += CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1);
            }
            else
            {
                ASSERT(0);
            }
        }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
    }

    /* subject area */
    if (g_wgui_uce_cntx.has_editable_subject == MMI_TRUE)
    {
        header += (CAT280_VMARGIN >> 1) + (CAT280_INLINE_SL_HEIGHT);
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    /* recipients area*/
    if (g_wgui_uce_cntx.to_recipients_num != 0)
    {
        header += (CAT280_VMARGIN >> 1) + (CAT280_INLINE_SL_HEIGHT * g_wgui_uce_cntx.to_recipients_num);
        total_num += g_wgui_uce_cntx.to_recipients_num;
    }
    
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.cc_recipients_num != 0)
    {
        header += (CAT280_VMARGIN >> 1) + (CAT280_INLINE_SL_HEIGHT * g_wgui_uce_cntx.cc_recipients_num);
        total_num += g_wgui_uce_cntx.cc_recipients_num;
    }
    
    if (g_wgui_uce_cntx.bcc_recipients_num != 0)
    {
        header += (CAT280_VMARGIN >> 1) + (CAT280_INLINE_SL_HEIGHT * g_wgui_uce_cntx.bcc_recipients_num);
        total_num += g_wgui_uce_cntx.bcc_recipients_num;
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    /* only one recipient, enlarge the header for TO button */
    if (total_num == 1)
    {
        header += (CAT280_VMARGIN >> 1);
    }

    *header_height = header;
    *footer_height = footer;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat28_ime_pre_vk_handler
 * DESCRIPTION
 *  Create a new recipient editor before IME handler.
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL wgui_cat280_ime_pre_vk_handler(S32 x, S32 y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__    
    S32 i = 0;
#endif /* __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__
    if (!(MMI_singleline_inputbox.flags & UI_SINGLE_LINE_INPUT_BOX_AUTO_CLEAR_HIGHLIGHT_MODE))
    {
        /* check the (x, y) is on VK */
        if (MMI_TRUE == wgui_virtual_keyboard_Check_alphanumeric_vk_0_to_9_key(x, y))
        {
        #ifdef __WGUI_CAT280_SUPPORT_MMS__
            if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS) ||
                (g_wgui_uce_cntx.highligh_state == WGUI_UCE_CC_RECIPIENTS) ||
                (g_wgui_uce_cntx.highligh_state == WGUI_UCE_BCC_RECIPIENTS))
        #else /* __WGUI_CAT280_SUPPORT_MMS__ */
            if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS)
        #endif /* __WGUI_CAT280_SUPPORT_MMS__ */
            {
                if ((MMI_singleline_inputbox.ext_flags & GUI_SINGLE_LINE_INPUT_BOX_RECIPIENT_MODE) &&
                    (MMI_singleline_inputbox.current_text_p != (MMI_singleline_inputbox.last_position_p - ENCODING_LENGTH)))
                {
                    wgui_inputs_sl_move_cursor(WGUI_INPUTS_CURSOR_POS_END);
                }

                for (i = (MMI_singleline_inputbox.current_text_p - (MMI_singleline_inputbox.text)); i >= ENCODING_LENGTH; i -= ENCODING_LENGTH)   
                {
                    i -= ENCODING_LENGTH;
                    /* if there is a ";" */
                    if (((MMI_singleline_inputbox.text[i] == 0x3b) && (MMI_singleline_inputbox.text[i + 1] == 0)) ||
                        ((MMI_singleline_inputbox.text[i] == 0x1b) && (MMI_singleline_inputbox.text[i + 1] == 0xff)))
                    {
                        gdi_layer_lock_frame_buffer();

                        wgui_cat280_insert_new_recipient(
                            wgui_cat280_get_highlight_state(),
                            (g_wgui_uce_cntx.highlight_index + 1), 
                            (UI_string_type)&MMI_singleline_inputbox.text[i + 2], 
                            WGUI_UCE_DEFAULT_FLAGS, 
                            MMI_TRUE,
                            (-1));

                        set_right_softkey_label((UI_string_type) get_string(STR_GLOBAL_CLEAR));
                        set_right_softkey_icon(NULL);
                        redraw_right_softkey();

                        gdi_layer_unlock_frame_buffer();

                        break;
                    }
                }
            }
        #ifdef __WGUI_CAT280_SUPPORT_MMS__
            else if ((g_wgui_uce_cntx.highligh_state != WGUI_UCE_EDITOR) && (g_wgui_uce_cntx.highligh_state != WGUI_UCE_SUBJECT))
        #else /* __WGUI_CAT280_SUPPORT_MMS__ */
            else if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_EDITOR)
        #endif /* __WGUI_CAT280_SUPPORT_MMS__ */
            {
                gdi_layer_lock_frame_buffer();
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_EDITOR, -1);
                wgui_cat280_ml_go_to_last_position();
                gdi_layer_unlock_frame_buffer();
            }
        }
    }
#endif /* __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__ */
    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_translate_header_pen_event
 * DESCRIPTION
 *  get editor header and footer height
 * PARAMETERS
 *  header_height       [OUT]
 *  footer_height       [OUT]
 * RETURNS
 *  wgui_uce_layout_type_enum
 *****************************************************************************/
static void wgui_cat280_translate_header_pen_event(
    S32 x, 
    S32 y, 
    wgui_uce_region_id_enum *region_id,
    S32 *index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 to_h = 0, cc_h = 0, bcc_h = 0, subject_h = 0, thumbnail_h = 0, audio_h =0;
    S32 recipient_index;
    MMI_BOOL is_on_lable = MMI_FALSE;
    MMI_BOOL is_on_empty = MMI_FALSE;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/   
    if ((x > 0) && (x < ((CAT280_HMARGIN << 1) + g_wgui_uce_cntx.max_label_width)))
    {
        is_on_empty  = MMI_TRUE;

        if ((x > g_wgui_uce_cntx.label_x) && (x < (g_wgui_uce_cntx.label_x + g_wgui_uce_cntx.label_w)))
        {
            is_on_lable = MMI_TRUE;
        }
        else
        {
            *region_id = WGUI_UCE_EMPTY;
            *index = -1;
        }
    }
    
    /* recipients area*/
    if (g_wgui_uce_cntx.to_recipients_num != 0)
    {
        to_h = (CAT280_VMARGIN >> 1) + (CAT280_INLINE_SL_HEIGHT * g_wgui_uce_cntx.to_recipients_num);
        if (to_h > y)
        {
            recipient_index = (y - (CAT280_VMARGIN >> 1)) / CAT280_INLINE_SL_HEIGHT;

            MMI_ASSERT(recipient_index < g_wgui_uce_cntx.to_recipients_num);

            if (is_on_lable)
            {
                if (recipient_index == 0)
                {
                    *region_id = WGUI_UCE_TO_LABEL;
                    *index = -1;
                }
                else
                {
                    *region_id = WGUI_UCE_EMPTY;
                    *index = -1;
                }
            }
            else if (is_on_empty == MMI_FALSE)
            {
                *region_id = WGUI_UCE_TO_RECIPIENTS;
                *index = wgui_cat280_get_buffer_index(WGUI_UCE_TO_RECIPIENTS,recipient_index);
            }
            return;
        }
    }

#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.cc_recipients_num != 0)
    {
        cc_h = (CAT280_VMARGIN >> 1) + (CAT280_INLINE_SL_HEIGHT * g_wgui_uce_cntx.cc_recipients_num);
        if ((to_h + cc_h) > y)
        {
            recipient_index = (y - to_h - (CAT280_VMARGIN >> 1)) / CAT280_INLINE_SL_HEIGHT;
            MMI_ASSERT(recipient_index < g_wgui_uce_cntx.cc_recipients_num);

            if (is_on_lable)
            {
                if (recipient_index == 0)
                {
                    *region_id = WGUI_UCE_CC_LABEL;
                    *index = -1;
                }
                else
                {
                    *region_id = WGUI_UCE_EMPTY;
                    *index = -1;
                }
            }
            else if (is_on_empty == MMI_FALSE)
            {
                *region_id = WGUI_UCE_CC_RECIPIENTS;
                *index = wgui_cat280_get_buffer_index(WGUI_UCE_CC_RECIPIENTS,recipient_index);
            }
            return;
        }
    }
    
    if (g_wgui_uce_cntx.bcc_recipients_num != 0)
    {
        bcc_h = (CAT280_VMARGIN >> 1) + (CAT280_INLINE_SL_HEIGHT * g_wgui_uce_cntx.bcc_recipients_num);
        if ((to_h + cc_h + bcc_h) > y)
        {
            recipient_index = (y - to_h - cc_h - (CAT280_VMARGIN >> 1)) / CAT280_INLINE_SL_HEIGHT;
            MMI_ASSERT(recipient_index < g_wgui_uce_cntx.bcc_recipients_num);
 
            if (is_on_lable)
            {
                if (recipient_index == 0)
                {
                    *region_id = WGUI_UCE_BCC_LABEL;
                    *index = -1;
                }
                else
                {
                    *region_id = WGUI_UCE_EMPTY;
                    *index = -1;
                }
            }
            else if (is_on_empty == MMI_FALSE)
            {
                *region_id = WGUI_UCE_BCC_RECIPIENTS;
                *index = wgui_cat280_get_buffer_index(WGUI_UCE_BCC_RECIPIENTS,recipient_index);
            }
            return;
        }
    }
    
    /* subject area */
    if (g_wgui_uce_cntx.has_editable_subject == MMI_TRUE)
    {
        subject_h = (CAT280_VMARGIN >> 1) + (CAT280_INLINE_SL_HEIGHT);
        if ((to_h + cc_h + bcc_h + subject_h) > y)
        {
            if (is_on_lable)
            {
                *region_id = WGUI_UCE_EMPTY;
                *index = -1;
            }
            else if (is_on_empty == MMI_FALSE)
            {
                *region_id = WGUI_UCE_SUBJECT;
                *index = -1;
            }
            return;
        }
    }
    
    /* object area */
    if (g_wgui_uce_cntx.has_thumbnail)
    {
        if (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)
        {
            thumbnail_h = CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1);
            if ((to_h + cc_h + bcc_h + subject_h + thumbnail_h) >= y)
            {
                *region_id = WGUI_UCE_THUMBNAIL;
                *index = -1;
                return;
            }
        }
    }
    
#ifdef __WGUI_CAT280_ENHANCED_UI__
    /* audio area */
    if (g_wgui_uce_cntx.is_audio)
    {
        if (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)
        {
            audio_h = CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1);
            if ((to_h + cc_h + bcc_h + subject_h + thumbnail_h + audio_h) >= y)
            {
                *region_id = WGUI_UCE_AUDIO;
                *index = -1;
                return;
            }
            else
            {
                ASSERT(0);
            }
        }
    }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_change_recipient
 * DESCRIPTION
 *  activate the singleline editor
 * PARAMETERS
 *  draw_x         [IN]    frame x
 *  draw_y         [IN]    frame y
 *  draw_width     [IN]    frame width
 *  draw_height    [IN]    frame height
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_change_recipient(
    S32 draw_x, 
    S32 draw_y, 
    S32 draw_width, 
    S32 draw_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if ((g_wgui_uce_cntx.highligh_state != WGUI_UCE_HIGHLIGHT_EDITOR) &&
        (g_wgui_uce_cntx.highligh_state != WGUI_UCE_HIGHLIGHT_THUMBNAIL))
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
    if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_HIGHLIGHT_EDITOR)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    {
#ifndef __MMI_FTE_SUPPORT__
        draw_y += (CAT280_VMARGIN >> 1) - 1;
        draw_height -= CAT280_VMARGIN;
#endif /* __MMI_FTE_SUPPORT__ */
        wgui_inputs_sl_move(draw_x, draw_y);
        wgui_inputs_sl_resize(draw_width, draw_height); 
        gui_show_single_line_input_box(&MMI_singleline_inputbox);
    }
}

#else /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_highlight_state
 * DESCRIPTION
 *  get highlight state
 * PARAMETERS
 *  void
 * RETURNS
 *  wgui_uce_highlight_state_enum
 *****************************************************************************/
wgui_uce_highlight_state_enum wgui_cat280_get_highlight_state(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return (wgui_uce_highlight_state_enum)g_wgui_uce_cntx.highligh_state;
}
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */


#if defined(__WGUI_CAT280_ENHANCED_UI__)
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_register_attach_button_callback
 * DESCRIPTION
 *  If single line editor text changed, we will callback to app if necessary.
 * PARAMETERS
 *  func:           [IN] (N/A) the change callback function.     
 * RETURNS
 *  void
 *****************************************************************************/
void wgui_cat280_register_attach_button_callback(FuncPtr func)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_wgui_cat280_callback.attach_button_callback = func;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_register_object_callback
 * DESCRIPTION
 *  If tap on highlighted object, we will invoke this callback.
 * PARAMETERS
 *  func:           [IN] (N/A) the change callback function.     
 * RETURNS
 *  void
 *****************************************************************************/
void wgui_cat280_register_object_callback(wgui_uce_object_highlight_callback func)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_wgui_cat280_callback.object_callback = func;
}

#ifdef __WGUI_CAT280_SUPPORT_MMS__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_audio
 * DESCRIPTION
 *  draw audio image
 * PARAMETERS
 *  draw_x         [IN]        region x
 *  draw_y         [IN]        region y
 *  draw_width     [IN]        region width
 *  draw_height    [IN]        region height
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_audio(S32 draw_x, S32 draw_y, S32 draw_width, S32 draw_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 img_width = 0, img_height = 0;
    GDI_HANDLE act_layer = GDI_NULL_HANDLE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_get_active(&act_layer);
    
    if (act_layer != GDI_NULL_HANDLE)
    {
        gdi_push_and_set_alpha_blending_source_layer(act_layer);
    }

    /* draw preview object */
    if (g_wgui_uce_cntx.is_audio)
    {        
        if (g_wgui_uce_cntx.audio_image_id)
        {
            if (GDI_SUCCEED != gdi_image_get_dimension_id(g_wgui_uce_cntx.audio_image_id, &img_width, &img_height))
            {
                MMI_ASSERT(0);
            }
        	
        	/* drawable region larger than image */
        	if ( draw_width > img_width  && draw_height > img_height )
        	{
        		/* align image at the center of preview rectangle */
        		draw_x += ((draw_width - img_width) >> 1);
        		draw_width = img_width;
        		draw_y += ((draw_height - img_height) >> 1);
        		draw_height = img_height;
        	}
        	else
        	{
        		S32 resized_offset_x, resized_offset_y, resized_width, resized_height;

        		gdi_image_util_fit_bbox(
        			draw_width,
        			draw_height,
        			img_width,
        			img_height,
        			&resized_offset_x,
        			&resized_offset_y,
        			&resized_width,
        			&resized_height);
        		draw_width = resized_width;
        		draw_height = resized_height;
        		draw_x += resized_offset_x;
        		draw_y += resized_offset_y;
        	}

            if (GDI_SUCCEED != gdi_image_draw_resized_id(
                                draw_x,
                                draw_y,
                                draw_width,
                                draw_height,
                                g_wgui_uce_cntx.audio_image_id))
            {
                MMI_ASSERT(0);
            }
        }
    }

    if (act_layer != GDI_NULL_HANDLE)
    {
        gdi_pop_and_restore_alpha_blending_source_layer();
    }
}
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
#endif /* __WGUI_CAT280_ENHANCED_UI__ */


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_ml_go_to_last_position
 * DESCRIPTION
 *  set the cursor of multiline inputbox to the last position
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_ml_go_to_last_position(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_multiline_inputbox.flags &= ~(UI_MULTI_LINE_INPUT_BOX_STATE_DISABLED | UI_MULTI_LINE_INPUT_BOX_DISABLE_CURSOR_DRAW);
    MMI_multiline_inputbox.ext_flags &= ~GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR;    

    if (MMI_multiline_inputbox.ext_flags & GUI_MULTI_LINE_INPUT_BOX_INPUT_METHOD_MODE)
	{
		gui_multi_line_input_box_stop_input(&MMI_multiline_inputbox);
		wgui_inputs_ml_move_cursor(WGUI_INPUTS_CURSOR_POS_END);	
    	gui_multi_line_input_box_start_input(&MMI_multiline_inputbox);
	}
	else
	{
        wgui_inputs_ml_move_cursor(WGUI_INPUTS_CURSOR_POS_END);
	}
    wgui_inputs_ml_redraw();
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_editor_scroll_down
 * DESCRIPTION
 *  let multiline inputbox to scroll down
 * PARAMETERS
 *  offset   [IN]   scroll down offset
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_editor_scroll_down(S32 offset)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_multiline_inputbox.text_offset_y -= offset;

    if ((MMI_multiline_inputbox.edit_height - MMI_multiline_inputbox.text_offset_y) > MMI_multiline_inputbox.text_height)
    {
        MMI_multiline_inputbox.text_offset_y = MMI_multiline_inputbox.edit_height - MMI_multiline_inputbox.text_height;
    }
    if (MMI_multiline_inputbox.text_height <= MMI_multiline_inputbox.height)
    {
        MMI_multiline_inputbox.text_offset_y = 0;
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_move_to_editor_top
 * DESCRIPTION
 *  let multiline inputbox scroll to the top
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_move_to_editor_top(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    MMI_multiline_inputbox.text_offset_y = 0;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_editor_change_event_callback
 * DESCRIPTION
 * Used to validate input with application's using callbacks to application layer.
 * This function itself is called on every character insertion/deletion from multiline input. 
 * Always updates the category's text info context. 
 * PARAMETERS
 *  event       [IN]        Event type
 *  C           [IN]        GSM 7BIT EXTENSION CHARACTERS
 * RETURNS
 *  
 *****************************************************************************/
static MMI_BOOL wgui_cat280_editor_change_event_callback(gui_multi_line_input_box_change_event_enum event, U16 C)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wgui_uce_text_info_struct post_change;
    wgui_uce_text_change_result_enum result = WGUI_UCE_TEXT_CHANGE_ALLOWED; /* for compile warning */
    mmi_7bit_counter_struct *count_info;
#if defined(__MMI_FTE_SUPPORT__) && defined(__WGUI_CAT280_SUPPORT_MMS__)
  //  U32 msg_size;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memcpy((void*)&post_change, (void*)&g_wgui_uce_cntx.text_info, sizeof(wgui_uce_text_info_struct));

    /* Wrong Event Type From Multiline Input Box */
    MMI_ASSERT((event == GUI_MULTI_LINE_INPUT_BOX_INSERT_CHAR) || (event == GUI_MULTI_LINE_INPUT_BOX_DELETE_CHAR) ||(event == GUI_MULTI_LINE_INPUT_BOX_DELETEALL));

    MMI_TRACE(MMI_FW_TRC_G3_CAT, MMI_WGUI_TRC_CAT280_TEXT_INPUT_CALLBACK_EDITOR, event, C);
    MMI_TRACE(MMI_FW_TRC_G3_CAT, MMI_WGUI_TRC_CAT280_TEXT_INFO_ORIGINAL, post_change.char_count, post_change.utf8_msg_len, post_change.extension_char_count, post_change.UCS2_count);

    if (event == GUI_MULTI_LINE_INPUT_BOX_DELETEALL)
    {
        memset((void*)&post_change, 0, sizeof(wgui_uce_text_info_struct));
        memset((void*)g_wgui_uce_cntx.text_buffer, 0, sizeof(U16));        /* First two bytes are NULL that means string lenght is zero */
        mmi_7bit_counter_init(g_wgui_uce_cntx.text_buffer);
    }
    else
    {
        if (event == GUI_MULTI_LINE_INPUT_BOX_INSERT_CHAR)
        {
            ++post_change.char_count;
            mmi_7bit_counter_add(g_wgui_uce_cntx.text_buffer, C, 0);
            post_change.utf8_msg_len += app_unicode_to_utf8_len(C);
        }
        else //if (event == GUI_MULTI_LINE_INPUT_BOX_DELETE_CHAR)
        {
            --post_change.char_count;
            mmi_7bit_counter_delete(g_wgui_uce_cntx.text_buffer, C, 0);
            post_change.utf8_msg_len -= app_unicode_to_utf8_len(C); 
        }
        count_info = mmi_7bit_counter_get_info();
        post_change.UCS2_count = count_info->ucs2_count;
        post_change.extension_char_count = count_info->gsm_ext_count;
    }

    MMI_TRACE(MMI_FW_TRC_G3_CAT, MMI_WGUI_TRC_CAT280_TEXT_INFO_NEW, post_change.char_count, post_change.utf8_msg_len, post_change.extension_char_count, post_change.UCS2_count);

    result = g_wgui_cat280_callback.text_change(&post_change);

    MMI_TRACE(MMI_FW_TRC_G3_CAT, MMI_WGUI_TRC_CAT280_TEXT_INFO_APP, result, post_change.char_count, post_change.utf8_msg_len, post_change.extension_char_count, post_change.UCS2_count);

    /* just callback to app */
#if defined(__MMI_FTE_SUPPORT__) && defined(__WGUI_CAT280_SUPPORT_MMS__)
    if (g_wgui_cat280_callback.get_message_size != NULL)
    {
       // msg_size = g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, g_wgui_uce_cntx.msg_type);
       g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, g_wgui_uce_cntx.msg_type);
    }
#endif /* defined(__MMI_FTE_SUPPORT__) && defined(__WGUI_CAT280_SUPPORT_MMS__) */

    switch (result)
    {
        case WGUI_UCE_TEXT_CHANGE_ALLOWED:
            memcpy((void*)&g_wgui_uce_cntx.text_info, (void*)&post_change, sizeof(wgui_uce_text_info_struct));        /* .: post change scenario accepted by UCA */            

#ifdef __WGUI_CAT280_SUPPORT_MMS__
            if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS)
            {
                if (wgui_cat280_get_highlight_state() != WGUI_UCE_HIGHLIGHT_EDITOR)
                {
                    wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_EDITOR);
                    wgui_cat280_ml_go_to_last_position();
                }
            }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
            MMI_TRACE(MMI_FW_TRC_G3_CAT, MMI_WGUI_TRC_CAT280_TEXT_INFO_FINAL, post_change.char_count, post_change.utf8_msg_len, post_change.extension_char_count, post_change.UCS2_count);

            return MMI_TRUE;
        case WGUI_UCE_TEXT_CHANGE_NOT_ALLOWED:
            {
                switch (event)
                {
                case GUI_MULTI_LINE_INPUT_BOX_INSERT_CHAR:
                    /* restore the previouse counter */
                    mmi_7bit_counter_delete(g_wgui_uce_cntx.text_buffer, C, 1);
                    break;

                case GUI_MULTI_LINE_INPUT_BOX_DELETE_CHAR:
                    /* restore the previouse counter */
                    mmi_7bit_counter_add(g_wgui_uce_cntx.text_buffer, C, 1);
                    break;

                default:
                    break;
                }
            }
            MMI_TRACE(MMI_FW_TRC_G3_CAT, MMI_WGUI_TRC_CAT280_TEXT_INFO_FINAL, post_change.char_count, post_change.utf8_msg_len, post_change.extension_char_count, post_change.UCS2_count);

            return MMI_FALSE;
        default:
            ASSERT(0);  /* Wrong Return Type From UCA */
            return MMI_FALSE;
    }

}


#ifdef __WGUI_CAT280_SUPPORT_MMS__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_has_thumbnail
 * DESCRIPTION
 *  get if multiline inputbox has thumbnail
 * PARAMETERS
 *  void
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_has_thumbnail(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    return g_wgui_uce_cntx.has_thumbnail;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_get_thumbnail_layout
 * DESCRIPTION
 *  get thumbnail layout
 * PARAMETERS
 *  void
 * RETURNS
 *  wgui_uce_layout_type_enum
 *****************************************************************************/
static wgui_uce_layout_type_enum wgui_cat280_get_thumbnail_layout(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    return g_wgui_uce_cntx.layout;
}
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

#ifdef __MMI_FTE_SUPPORT__
#ifdef __WGUI_CAT280_SUPPORT_MMS__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_information_bar_msg_size_area
 * DESCRIPTION
 *  draw the page area of information bar 
 * PARAMETERS
 *  x       [IN]        Start x
 *  y       [IN]        Start Y
 *  w       [IN]        Width
 *  h       [IN]        Height
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_information_bar_msg_size_area(S32 x, S32 y, S32 w, S32 h)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    color text_col = gui_color(255, 255, 255);
    U16 str[32];
#ifndef __WGUI_CAT280_ENHANCED_UI__    
    U8 msgtypestr[16];
#endif /* #ifndef __WGUI_CAT280_ENHANCED_UI__ */
    stFontAttribute *f = &MMI_small_font;
    S32 str_w = 0, str_h = 0;
#ifndef __WGUI_CAT280_ENHANCED_UI__
    S32 icon_x1, icon_y1, icon_x2, icon_y2;
    S32 video_width = 0, video_height = 0, pic_width = 0, pic_height = 0, attach_width = 0, audio_width = 0, audio_height = 0;
#endif
    S32 attach_height = 0;
    S32 gap = 0;

    wgui_uce_display_enum type;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* get the display type */
    if (g_wgui_cat280_callback.get_display_type != NULL)
	{
        type = g_wgui_cat280_callback.get_display_type();
    }
    else
    {
        type = WGUI_UCE_DISPLAY_SIZE; /* default for MMS is display size */
    }

    /* setup "str" */
    if (type ==  WGUI_UCE_DISPLAY_SIZE)
    {
        FLOAT size = (FLOAT) g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, g_wgui_uce_cntx.msg_type) / (FLOAT) 1024.0;

        if (size != 0.0)
        {
            if (size < 0.1)
            {
                size = (FLOAT) 0.1;
            }
        }

#ifdef __WGUI_CAT280_ENHANCED_UI__
        gui_sprintf(str, "%.1fKB", size);
#else
        mmi_ucs2_to_asc((S8*)msgtypestr, GetString(WGUI_UCE_MMS_STRING_ID));
        gui_sprintf(str, "%s: %.1fKB", msgtypestr, size);
#endif

    }
    else if (type == WGUI_UCE_DISPLAY_CHARACTER)
    {
#ifdef __WGUI_CAT280_ENHANCED_UI__
        gui_sprintf(str, "%d/%d", g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, g_wgui_uce_cntx.msg_type), g_wgui_uce_cntx.total_character);
#else
        mmi_ucs2_to_asc((S8*)msgtypestr, GetString(WGUI_UCE_MMS_STRING_ID));
        gui_sprintf(str, "%s: %d/%d", msgtypestr, g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, g_wgui_uce_cntx.msg_type), g_wgui_uce_cntx.total_character);
#endif
    }

    gui_set_font(f);
    gui_measure_string(str, &str_w, &str_h);
    
#ifndef __WGUI_CAT280_ENHANCED_UI__
    gui_measure_image((PU8) GetImage(WGUI_UCE_ATTACHFILE_ICON_IMAGE_ID), &attach_width, &attach_height);
    gui_measure_image((PU8) GetImage(WGUI_UCE_AUDIO_ICON_IMAGE_ID), &audio_width, &audio_height);        
    gui_measure_image((PU8) GetImage(WGUI_UCE_VIDEO_ICON_IMAGE_ID), &video_width, &video_height);
    gui_measure_image((PU8) GetImage(WGUI_UCE_PICTURE_ICON_IMAGE_ID), &pic_width, &pic_height);
#endif /* #ifndef __WGUI_CAT280_ENHANCED_UI__ */

    /* for image border */
    h = h - CAT280_INFORMATION_BAR_IMG_BORDER;
    if (h < (str_h + attach_height + CAT280_INFORMATION_BAR_MSG_SIZE_GAP_Y))
    {
        h = str_h + attach_height + CAT280_INFORMATION_BAR_MSG_SIZE_GAP_Y;
        y -= (((str_h + attach_height + CAT280_INFORMATION_BAR_MSG_SIZE_GAP_Y) - h) >> 1);
    }
    else
    {
        gap = ((h - (str_h + attach_height + CAT280_INFORMATION_BAR_MSG_SIZE_GAP_Y)) >> 1);
    }

    /* draw background */
    gdi_layer_push_clip();

#ifdef __WGUI_CAT280_ENHANCED_UI__
    gdi_layer_set_clip(
        x + w - str_w - (CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X << 1) + 1, 
        y + gap, 
        x + w - str_w - (CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X << 1) + str_w, 
        y + gap + str_h);
    gdi_draw_solid_rect(
        x + w - str_w - (CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X << 1) + 1, 
        y + gap, 
        x + w - str_w - (CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X << 1) + str_w, 
        y + gap + str_h,
        GDI_COLOR_WHITE);

    gdi_image_draw_resized_blend2layers(x, y, w, h, current_MMI_theme->inputbox_remaining_counter_bg);

    /* draw msg size */
	if (mmi_fe_get_r2l_state())
	{
        gui_move_text_cursor(x + w - (CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X << 1), y + gap);
	}
	else
	{
        gui_move_text_cursor(x + w - str_w - (CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X << 1) + 1, y + gap);
    }
#else
    gdi_layer_set_clip(
        x + w - str_w -CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X + 1, 
        y + gap, 
        x + w - str_w -CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X + str_w, 
        y + gap + str_h);
    gdi_draw_solid_rect(
        x + w - str_w -CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X + 1, 
        y + gap, 
        x + w - str_w -CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X + str_w, 
        y + gap + str_h,
        GDI_COLOR_WHITE);

    gdi_image_draw_resized_blend2layers(x, y, w, h, current_MMI_theme->inputbox_remaining_counter_bg);

    /* draw msg size */
	if (mmi_fe_get_r2l_state())
	{
		gui_move_text_cursor(x + w - CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X, y + gap+SPECIAL_GAP);
	}
	else
	{
        gui_move_text_cursor(x + w - str_w - CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X + 1, y + gap+SPECIAL_GAP);
    }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */

    gui_set_text_color(text_col);
    gui_print_text((UI_string_type) str);
    gdi_layer_pop_clip();

#ifndef __WGUI_CAT280_ENHANCED_UI__
    /* draw icon */
    icon_x1 = x + w - CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X - attach_width;
    icon_y1 = y + gap + str_h + CAT280_INFORMATION_BAR_MSG_SIZE_GAP_Y;
    icon_x2 = icon_x1 + attach_width;
    icon_y2 = icon_y1 + attach_height;

    gui_show_image(icon_x1, icon_y1, get_image(WGUI_UCE_ATTACHFILE_ICON_IMAGE_ID));

    if (g_wgui_uce_cntx.is_attachment == MMI_FALSE)  /* no attachment */
    {
        gui_greyscale_rectangle(
            icon_x1,
            icon_y1,
            icon_x2,
            icon_y2,
            MMI_BG_GREYSCALE_VALUE,
            MMI_BG_GREYSCALE_BLACK_VALUE);
    }

    /* show audio icon */        
    icon_x1 = icon_x1 - WGUI_CAT280_ICON_X_GAP - audio_width;
    icon_x2 = icon_x1 + audio_width;
    icon_y2 = icon_y1 + audio_height;

    gui_show_image(icon_x1, icon_y1, get_image(WGUI_UCE_AUDIO_ICON_IMAGE_ID));

    if (g_wgui_uce_cntx.is_audio == MMI_FALSE)
    {
        gui_greyscale_rectangle(
            icon_x1,
            icon_y1,
            icon_x2,
            icon_y2,
            MMI_BG_GREYSCALE_VALUE,
            MMI_BG_GREYSCALE_BLACK_VALUE);
    }
    
    /* show icon for video or image */
    if (g_wgui_uce_cntx.is_video == MMI_TRUE)
    {            
        icon_x1 = icon_x1 - WGUI_CAT280_ICON_X_GAP - video_width;
        icon_x2 = icon_x1 + video_width;
        icon_y2 = icon_y1 + video_height;

        gui_show_image(icon_x1, icon_y1, (PU8) GetImage(WGUI_UCE_VIDEO_ICON_IMAGE_ID));
    }
    else
    {            
        icon_x1 = icon_x1 - WGUI_CAT280_ICON_X_GAP - pic_width;
        icon_x2 = icon_x1 + pic_width;
        icon_y2 = icon_y1 + pic_height;

        gui_show_image(icon_x1, icon_y1, (PU8) GetImage(WGUI_UCE_PICTURE_ICON_IMAGE_ID));
    }

    if (g_wgui_uce_cntx.is_image == MMI_FALSE && g_wgui_uce_cntx.is_video == MMI_FALSE)
    {
        gui_greyscale_rectangle(
            icon_x1,
            icon_y1,
            icon_x2,
            icon_y2,
            MMI_BG_GREYSCALE_VALUE,
            MMI_BG_GREYSCALE_BLACK_VALUE);
    }
#endif /* #ifndef __WGUI_CAT280_ENHANCED_UI__ */

}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_information_bar_page_area
 * DESCRIPTION
 *  draw the page area of information bar 
 * PARAMETERS
 *  x       [IN]        Start x
 *  y       [IN]        Start Y
 *  w       [IN]        Width
 *  h       [IN]        Height
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_information_bar_page_area(S32 x, S32 y, S32 w, S32 h)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    stFontAttribute *f = &MMI_small_font;
    U16 str[32];
    S32 pre_button_x, pre_button_y, next_button_x, next_button_y;
    S32 button_w, button_h;
    S32 page_text_x, page_text_y, page_text_w, page_text_h;
    color text_col = gui_color(255, 255, 255);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* draw button */
    gdi_image_get_dimension(get_image(WGUI_UCE_FTE_PRE_BUTTON_DISABLE), &button_w, &button_h);
    pre_button_x = x + CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X;
    pre_button_y = y + ((h - button_h) >> 1) + 1;
    next_button_x = pre_button_x + w - button_w;
    next_button_y = pre_button_y;

    /* draw border and background */
    //gdi_image_draw_resized_blend2layers(x + button_w - 1, y, (w - ((button_w - 1) << 1)), h - 2, current_MMI_theme->inputbox_remaining_counter_bg);
    gdi_image_draw_resized_blend2layers(CAT280_INFORMATION_BAR_GAP_X, y, UI_device_width - (CAT280_INFORMATION_BAR_GAP_X << 1), h, current_MMI_theme->inputbox_remaining_counter_bg);
    gdi_image_draw_resized(pre_button_x + button_w, pre_button_y, (w - ((button_w) << 1)), button_h, get_image(WGUI_UCE_FTE_BUTTON_BG));

    /* left button */
    if (g_wgui_uce_cntx.current_slide == 1) /* at first slide */
    {
        gui_show_image(pre_button_x, pre_button_y, get_image(WGUI_UCE_FTE_PRE_BUTTON_DISABLE));
    }
    else
    {
        wgui_cat280_resize_and_move_button(g_wgui_uce_cntx.pre_bt, pre_button_x, pre_button_y, button_w, button_h);
        dm_redraw_button(g_wgui_uce_cntx.pre_bt);
    }

    /* right button */
    if (g_wgui_uce_cntx.current_slide == g_wgui_uce_cntx.total_slides) /* at last slide */
    {
        gui_show_image(next_button_x, next_button_y, get_image(WGUI_UCE_FTE_NEXT_BUTTON_DISABLE));
    }
    else
    {                    
        wgui_cat280_resize_and_move_button(g_wgui_uce_cntx.next_bt, next_button_x, next_button_y, button_w, button_h);
        dm_redraw_button(g_wgui_uce_cntx.next_bt);
    }

    /* draw text */
    gui_sprintf(str, "%d/%d", g_wgui_uce_cntx.current_slide,g_wgui_uce_cntx.total_slides);
    gui_set_font(f);
    gui_measure_string(str, &page_text_w, &page_text_h);

	if (mmi_fe_get_r2l_state())
	{
		page_text_x = pre_button_x + button_w + ((w - (button_w << 1) - page_text_w) >> 1) + page_text_w;
	}
	else
	{
        page_text_x = pre_button_x + button_w + ((w - (button_w << 1) - page_text_w) >> 1);
	}

    page_text_y = y + ((h - page_text_h) >> 1);
    gui_move_text_cursor(page_text_x, page_text_y);
    gui_set_text_color(text_col);
    gui_print_text((UI_string_type) str);
    
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_clear_icon_bg
 * DESCRIPTION
 *  clear button area
 * PARAMETERS
 *  button   [IN]   button information
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_clear_icon_bg(void *button)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    icontext_button *b = (icontext_button*) button;
    S32 x1 = b->x;
    S32 y1 = b->y;
    S32 x2 = b->x + b->width - 1;
    S32 y2 = b->y + b->height - 1;
    GDI_HANDLE act_layer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* draw information bar background */
    gdi_layer_get_active(&act_layer);

    gdi_layer_push_clip();
    gdi_layer_set_clip(x1, y1, x2, y2);

    gdi_push_and_set_alpha_blending_source_layer(act_layer);

    gdi_draw_solid_rect(x1, y1, x2 + 1, y2 + 1, GDI_COLOR_WHITE);
    gdi_image_draw_resized_blend2layers(
        CAT280_INFORMATION_BAR_GAP_X, 
        y1 - CAT280_INFORMATION_BAR_BUTTON_GAP_Y, 
        UI_device_width - (CAT280_INFORMATION_BAR_GAP_X << 1), 
        y2 + 1 - y1 + (CAT280_INFORMATION_BAR_BUTTON_GAP_Y << 1),
        current_MMI_theme->inputbox_remaining_counter_bg);   

    gdi_pop_and_restore_alpha_blending_source_layer();

    gdi_layer_pop_clip();
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_button_draw_down
 * DESCRIPTION
 *  draw pen down of button
 * PARAMETERS
 *  button_object       [IN]        The target button
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL wgui_cat280_button_draw_down(void *button_object)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    icontext_button *pre_bt, *next_bt, *current_bt;
    GDI_HANDLE act_layer = GDI_NULL_HANDLE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    pre_bt = dm_get_button(g_wgui_uce_cntx.pre_bt);
    next_bt = dm_get_button(g_wgui_uce_cntx.next_bt);

    
    if (button_object == (void*)pre_bt)
    {
        current_bt = pre_bt;
    }
    else if (button_object == (void*)next_bt)
    {
        current_bt = next_bt;
    }
#ifdef __WGUI_CAT280_ENHANCED_UI__
    else if (button_object == (void*)&g_wgui_uce_cntx.attach_button)
    {
        current_bt = &g_wgui_uce_cntx.attach_button;
    }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
    else
    {
        return MMI_TRUE;
    }
    
    gdi_layer_get_active(&act_layer);
    
    if (act_layer != GDI_NULL_HANDLE)
    {
        gdi_push_and_set_alpha_blending_source_layer(act_layer);
    }
    gui_icontext_button_show_down_by_pen((void*)current_bt);
    if (act_layer != GDI_NULL_HANDLE)
    {
        gdi_pop_and_restore_alpha_blending_source_layer();
    }
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_button_draw_up
 * DESCRIPTION
 *  draw pen up of button
 * PARAMETERS
 *  button_object       [IN]        The target button
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL wgui_cat280_button_draw_up(void *button_object)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    icontext_button *pre_bt, *next_bt, *current_bt;
    GDI_HANDLE act_layer = GDI_NULL_HANDLE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    pre_bt = dm_get_button(g_wgui_uce_cntx.pre_bt);
    next_bt = dm_get_button(g_wgui_uce_cntx.next_bt);

    
    if (button_object == (void*)pre_bt)
    {
        current_bt = pre_bt;
    }
    else if (button_object == (void*)next_bt)
    {
        current_bt = next_bt;
    }
#ifdef __WGUI_CAT280_ENHANCED_UI__
    else if (button_object == (void*)&g_wgui_uce_cntx.attach_button)
    {
        current_bt = &g_wgui_uce_cntx.attach_button;
    }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
    else
    {
        return MMI_TRUE;
    }
    
    gdi_layer_get_active(&act_layer);
    
    if (act_layer != GDI_NULL_HANDLE)
    {
        gdi_push_and_set_alpha_blending_source_layer(act_layer);
    }
    gui_icontext_button_show_up_by_pen((void*)current_bt);
    if (act_layer != GDI_NULL_HANDLE)
    {
        gdi_pop_and_restore_alpha_blending_source_layer();
    }
    return MMI_TRUE;

}

#endif /* __WGUI_CAT280_SUPPORT_MMS__ */


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_msg_size
 * DESCRIPTION
 *  draw message size in top right/left corner depending on r2lMMIFlag
 * PARAMETERS
 *  x1      [IN]        Start x
 *  y1      [IN]        Start Y
 *  x2      [IN]        End x
 *  y2      [IN]        End y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_msg_size(S32 x1, S32 y1, S32 x2, S32 y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    stFontAttribute *f = &MMI_medium_font;
    U16 str[32];

    S32 button_w, button_h, bg_w, bg_h;
    S32 page_area_x, page_area_y, page_area_w, page_area_h;
    S32 page_text_w, page_text_h;

    S32 msg_size_area_x, msg_size_area_y, msg_size_area_w, msg_size_area_h;
    GDI_HANDLE act_layer;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* SMS no information bar */
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_SMS)
    {
        wgui_cat280_draw_information_bar(x1, y1, x2, y2);
    }
    else
    {
        gdi_layer_lock_frame_buffer();

        /* get the size of page text */
        gui_sprintf(str, "%d/%d", g_wgui_uce_cntx.current_slide,g_wgui_uce_cntx.total_slides);
        gui_set_font(f);
        gui_measure_string(str, &page_text_w, &page_text_h);
        if(page_text_w < CAT280_INFORMATION_BAR_MMS_PAGE_TEXT_MIX_W)
        {
            page_text_w = CAT280_INFORMATION_BAR_MMS_PAGE_TEXT_MIX_W;
        }

        /* get the size of button and background */
        gdi_image_get_dimension_id((WGUI_UCE_FTE_BUTTON_BG), &bg_w, &bg_h);
        gdi_image_get_dimension_id((WGUI_UCE_FTE_PRE_BUTTON_DISABLE), &button_w, &button_h);

        /* draw the page area */
        page_area_h = (button_h > bg_h) ? button_h : bg_h;
        page_area_x = x1 + CAT280_INFORMATION_BAR_GAP_X;
        page_area_y = y1 + ((CAT280_INFORMATION_BAR_HEIGHT - page_area_h) >> 1);
        page_area_w = (button_w << 1) + page_text_w;
        if (bg_w > page_area_w)
        {
            page_area_w = bg_w;
        }

        /* darw the size area */
        msg_size_area_x = page_area_x + page_area_w + CAT280_INFORMATION_BAR_GAP_MIDDLE;
        msg_size_area_y = page_area_y;
        msg_size_area_w = x2 - msg_size_area_x - CAT280_INFORMATION_BAR_GAP_X;
        msg_size_area_h = page_area_h;

        /* set alpha blending layer  */
        gdi_layer_get_active(&act_layer);
        gdi_push_and_set_alpha_blending_source_layer(act_layer);

        /* clear information bar area */
        //gdi_draw_solid_rect(msg_size_area_x, msg_size_area_y, msg_size_area_x + msg_size_area_w, msg_size_area_y + msg_size_area_h, GDI_COLOR_WHITE);
        
        wgui_cat280_draw_information_bar_msg_size_area(msg_size_area_x, msg_size_area_y, msg_size_area_w, msg_size_area_h);

        gdi_pop_and_restore_alpha_blending_source_layer();
        gdi_layer_unlock_frame_buffer();
        gdi_layer_blt_previous(x1, y1, x2, y2);
    }
#else  /* __WGUI_CAT280_SUPPORT_MMS__ */
    wgui_cat280_draw_information_bar(x1, y1, x2, y2);
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_information_bar
 * DESCRIPTION
 *  draw information bar 
 * PARAMETERS
 *  x1      [IN]        Start x
 *  y1      [IN]        Start Y
 *  x2      [IN]        End x
 *  y2      [IN]        End y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_information_bar(S32 x1, S32 y1, S32 x2, S32 y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    color text_col  = *current_MMI_theme->remaining_length_text_color;
    //stFontAttribute *f = &MMI_medium_font;
    stFontAttribute *sms_f = &MMI_small_font;
    U16 str[32];
    U8 msgtypestr[16];
    S32 str_w = 0, str_h = 0;
    
    S32 button_w, button_h, bg_w, bg_h;
    S32 page_area_x, page_area_y, page_area_w, page_area_h;
    S32 page_text_w, page_text_h;

    S32 msg_size_area_x, msg_size_area_y, msg_size_area_w, msg_size_area_h;
    S32 attach_button_w, attach_button_h;
    GDI_HANDLE act_layer;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_SMS)
#endif
    {
        gdi_layer_lock_frame_buffer();
        
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        mmi_ucs2_to_asc((S8*)msgtypestr, GetString(WGUI_UCE_SMS_STRING_ID));
#if defined(__MMI_MAINLCD_128X128__) || defined(__MMI_MAINLCD_320X240__)
        /* only show  "SMS: 8888" */
        gui_sprintf(str, "%s: %d", msgtypestr, g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, g_wgui_uce_cntx.msg_type));
#else /* defined(__MMI_MAINLCD_128X128__) || defined(__MMI_MAINLCD_320X240__) */
#ifdef __WGUI_CAT280_ENHANCED_UI__
        /* show "8888(88)" */
        gui_sprintf(str, "%d(%d)", 
            g_wgui_cat280_callback.get_sms_rm_character(&g_wgui_uce_cntx.text_info),
            g_wgui_cat280_callback.get_sms_segment(&g_wgui_uce_cntx.text_info));

#else /* __WGUI_CAT280_ENHANCED_UI__ */
        /* show "SMS: 8888(88)" */
        gui_sprintf(str, "%s: %d(%d)", 
            msgtypestr, 
            g_wgui_cat280_callback.get_sms_rm_character(&g_wgui_uce_cntx.text_info),
            g_wgui_cat280_callback.get_sms_segment(&g_wgui_uce_cntx.text_info));
#endif  /* __WGUI_CAT280_ENHANCED_UI__ */
#endif /* defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_320X240__) */
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
#if defined(__MMI_MAINLCD_128X128__) || defined(__MMI_MAINLCD_320X240__)
        /* only show  "SMS: 8888" */
        gui_sprintf(str, "%d", g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, WGUI_UCE_MSG_TYPE_SMS));
#else /* defined(__MMI_MAINLCD_128X128__) || defined(__MMI_MAINLCD_320X240__) */
        /* show "8888(88)" */
        gui_sprintf(str, "%d(%d)", 
            g_wgui_cat280_callback.get_sms_rm_character(&g_wgui_uce_cntx.text_info),
            g_wgui_cat280_callback.get_sms_segment(&g_wgui_uce_cntx.text_info));
#endif /* defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_320X240__) */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

        gui_set_font(sms_f);
        gui_measure_string(str, &str_w, &str_h);

        /* draw background */
        gdi_draw_solid_rect(
            x1, 
            y1, 
            x2, 
            y2,
            GDI_COLOR_WHITE);

        x1 = x1 + CAT280_INFORMATION_BAR_GAP_X_SMS;
        x2 = x2 - CAT280_INFORMATION_BAR_GAP_X_SMS;
        y1 = y1 + CAT280_INFORMATION_BAR_GAP_Y_SMS;
        y2 = y2 - CAT280_INFORMATION_BAR_GAP_Y_SMS;
        gdi_image_draw_resized_blend2layers(x1, y1, (x2 - x1), (y2 - y1), current_MMI_theme->inputbox_remaining_counter_bg);

        /* draw msg size */
        if (mmi_fe_get_r2l_state())
        {
            gui_move_text_cursor(
                x2 - CAT280_INFORMATION_BAR_GAP_X_SMS - 1,
                y1 + ((y2 - y1 - str_h) >> 1)+SPECIAL_GAP);
        }
        else
        {
            gui_move_text_cursor(
                x2 - str_w - CAT280_INFORMATION_BAR_GAP_X_SMS - 1, 
                y1 + ((y2 - y1 - str_h) >> 1)+SPECIAL_GAP);
        }
        gui_set_text_color(text_col);
        gui_print_text((UI_string_type) str);

        gdi_layer_unlock_frame_buffer();
        gdi_layer_blt_previous(x1, y1, x2, y2);
    }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    else
    {
        gdi_layer_lock_frame_buffer();
        
        /* clear information bar area */
        gdi_draw_solid_rect(x1, y1, x2, y2, GDI_COLOR_WHITE);
        
        /* get the size of page text */
        gui_sprintf(str, "%d/%d", g_wgui_uce_cntx.current_slide,g_wgui_uce_cntx.total_slides);
        gui_set_font(sms_f);
        gui_measure_string(str, &page_text_w, &page_text_h);
        page_text_w += CAT280_HMARGIN;

        if(page_text_w < CAT280_INFORMATION_BAR_MMS_PAGE_TEXT_MIX_W)
        {
            page_text_w = CAT280_INFORMATION_BAR_MMS_PAGE_TEXT_MIX_W;
        }
        
        /* get the size of button and background */
        gdi_image_get_dimension_id((WGUI_UCE_FTE_BUTTON_BG), &bg_w, &bg_h);
        gdi_image_get_dimension_id((WGUI_UCE_FTE_PRE_BUTTON_DISABLE), &button_w, &button_h);
        
        /* set alpha blending layer  */
        gdi_layer_get_active(&act_layer);
        gdi_push_and_set_alpha_blending_source_layer(act_layer);
        
        /* draw the page area */
        page_area_h = ((button_h > bg_h) ? button_h : bg_h) + (CAT280_INFORMATION_BAR_BUTTON_GAP_Y << 1);
        page_area_x = x1 + CAT280_INFORMATION_BAR_GAP_X;
        page_area_y = y1 + ((CAT280_INFORMATION_BAR_HEIGHT - page_area_h) >> 1);
        page_area_w = (button_w << 1) + page_text_w + CAT280_INFORMATION_BAR_MSG_SIZE_GAP_X;
        if (bg_w > page_area_w)
        {
            page_area_w = bg_w;
        }
        wgui_cat280_draw_information_bar_page_area(page_area_x, page_area_y, page_area_w, page_area_h);
        
        /* darw the size area */
        msg_size_area_x = page_area_x + page_area_w + CAT280_INFORMATION_BAR_GAP_MIDDLE;
        msg_size_area_y = page_area_y;
        msg_size_area_w = x2 - msg_size_area_x - CAT280_INFORMATION_BAR_GAP_X;
        msg_size_area_h = page_area_h;
        wgui_cat280_draw_information_bar_msg_size_area(msg_size_area_x, msg_size_area_y, msg_size_area_w, msg_size_area_h);

#ifdef __WGUI_CAT280_ENHANCED_UI__
        if (g_wgui_uce_cntx.is_attachment)
        {
            /* draw the attache button */
            gui_measure_image(get_image(WGUI_UCE_FTE_ATTACHE_BUTTON_NORMAL), &attach_button_w, &attach_button_h);
            gui_move_icontext_button(
                &g_wgui_uce_cntx.attach_button, 
                page_area_x + page_area_w + CAT280_INFORMATION_BAR_ATTACH_BUTTON_GAP, 
                (page_area_y + ((page_area_h - attach_button_h) >> 1) + 1));
            gui_resize_icontext_button(&g_wgui_uce_cntx.attach_button, attach_button_w, attach_button_h);
            g_wgui_uce_cntx.attach_button.icon_x = 0;
            g_wgui_uce_cntx.attach_button.icon_y = 0;
            
#ifdef __MMI_TOUCH_SCREEN__
            gui_icontext_button_overwirte_pen_response_area(
                &g_wgui_uce_cntx.attach_button, 
                page_area_x + page_area_w + CAT280_INFORMATION_BAR_ATTACH_BUTTON_GAP, 
                page_area_y + ((page_area_h - attach_button_h) >> 1) + 1,
                page_area_x + page_area_w + CAT280_INFORMATION_BAR_ATTACH_BUTTON_GAP + attach_button_w, 
                page_area_y + ((page_area_h - attach_button_h) >> 1) + 1 + attach_button_h);
#endif /* __MMI_TOUCH_SCREEN__ */

            gui_show_icontext_button(&g_wgui_uce_cntx.attach_button);
        }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */

        gdi_pop_and_restore_alpha_blending_source_layer();
        gdi_layer_unlock_frame_buffer();
        gdi_layer_blt_previous(x1, y1, x2, y2);
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
}
#else /* __MMI_FTE_SUPPORT__ */

/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_information_background
 * DESCRIPTION
 *  draw information bar background
 * PARAMETERS
 *  x1      [IN]        Start x
 *  y1      [IN]        Start Y
 *  x2      [IN]        End x
 *  y2      [IN]        End y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_information_background(S32 x1, S32 y1, S32 x2, S32 y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    GDI_HANDLE scr_bg = dm_get_scr_bg_layer();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (scr_bg == GDI_ERROR_HANDLE)
    {
        gdi_layer_get_active(&scr_bg);
    }

    gdi_push_and_set_alpha_blending_source_layer(scr_bg);
    wgui_inputs_input_information_background(x1, y1, x2, y2);
    gdi_pop_and_restore_alpha_blending_source_layer();
}


#ifdef __WGUI_CAT280_SUPPORT_MMS__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_msg_page
 * DESCRIPTION
 *  draw the message page area: slide button + the text.
 * PARAMETERS
 *  bt1_x1_r2l   [IN]   left button x1 for r2l
 *  bt2_x1_r2l   [IN]   right button x1 for r2l
 *  bt1_x1       [IN]   left button x1
 *  bt2_x1       [IN]   right button x1
 *  bt_y         [IN]   button y
 *  bt_width     [IN]   button width
 *  bt_height    [IN]   button2 height
 *  cur_x_r2l    [IN]   cursor x for r2l
 *  cur_x        [IN]   cursor x
 *  cur_y        [IN]   cursor y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_msg_page(
                S32 bt1_x1_r2l, 
                S32 bt2_x1_r2l, 
                S32 bt1_x1, 
                S32 bt2_x1, 
                S32 bt_y, 
                S32 bt_width, 
                S32 bt_height,
                S32 cur_x_r2l,
                S32 cur_x,
                S32 cur_y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 left_button_x1 = bt1_x1;
    S32 right_button_x1 = bt2_x1;
    S32 cursor_x = cur_x;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_fe_get_r2l_state())
    {
        left_button_x1 = bt1_x1_r2l;
        right_button_x1 = bt2_x1_r2l;
        cursor_x = cur_x_r2l;
    }

    /* draw button */
    wgui_cat280_draw_slide_button(
        left_button_x1,
        bt_y,
        right_button_x1,
        bt_y, 
        bt_width,
        bt_height);

    /* draw slide string */
    gui_move_text_cursor(cursor_x, cur_y);

}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_clear_icon_bg
 * DESCRIPTION
 *  clear button area
 * PARAMETERS
 *  button   [IN]   button information
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_clear_icon_bg(void *button)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    icontext_button *b = (icontext_button*) button;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_cat280_draw_information_background(b->x, b->y, b->x + b->width, b->y + b->height); // pressed button shit 1 pixel
}
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_msg_size
 * DESCRIPTION
 *  draw message size in top right/left corner depending on r2lMMIFlag
 * PARAMETERS
 *  x1      [IN]        Start x
 *  y1      [IN]        Start Y
 *  x2      [IN]        End x
 *  y2      [IN]        End y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_msg_size(S32 x1, S32 y1, S32 x2, S32 y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    color font_color = *current_MMI_theme->remaining_length_text_color;
    U16 str[32];
    U8 msgtypestr[16];

#if defined(__MMI_TOUCH_SCREEN__)
    #if defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_128X128__)
        stFontAttribute *f = &MMI_small_font;
    #elif defined(__MMI_MAINLCD_320X240__) || defined(__MMI_MAINLCD_320X480__)
        stFontAttribute *f = &MMI_small_font;
    #else /* 176x220TP, 240x320TP, 240x400TP */
        stFontAttribute *f = &MMI_medium_font;
    #endif /* defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_128X128__) */
#else 
    stFontAttribute *f = &MMI_small_font;
#endif /* defined(__MMI_TOUCH_SCREEN__) */

    S32 w = 0, h = 0, clear_x1 = 0, clear_y1 = 0, clear_x2 = 0, clear_y2 = 0;

#ifdef __WGUI_CAT280_SUPPORT_MMS__
    wgui_uce_text_change_result_enum type;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    GDI_HANDLE act_layer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_lock_double_buffer();

    /* get message size information */
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS)
    {
    	if (g_wgui_cat280_callback.get_display_type != NULL)
    	{
            type = g_wgui_cat280_callback.get_display_type();
        }
        else
        {
            type = WGUI_UCE_DISPLAY_SIZE; /* default for MMS is display size */
        }
#if 0
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
#endif
        {
            if (type ==  WGUI_UCE_DISPLAY_SIZE)
            {
                FLOAT size = (FLOAT) g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, g_wgui_uce_cntx.msg_type) / (FLOAT) 1024.0;

                if (size != 0.0)
                {
                    if (size < 0.1)
                    {
                        size = (FLOAT) 0.1;
                    }
                }

                mmi_ucs2_to_asc((S8*)msgtypestr, GetString(WGUI_UCE_MMS_STRING_ID));
#if defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_128X128__)
                gui_sprintf(str, "%s:%.1fKB", msgtypestr, size);
#else
                gui_sprintf(str, "%s: %.1f KB", msgtypestr, size);
#endif /* defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_128X128__) */
            }
            else if (type == WGUI_UCE_DISPLAY_CHARACTER)
            {
                mmi_ucs2_to_asc((S8*)msgtypestr, GetString(WGUI_UCE_MMS_STRING_ID));
                gui_sprintf(str, "%s: %d/%d", msgtypestr, g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, g_wgui_uce_cntx.msg_type), g_wgui_uce_cntx.total_character);
            }
        }
        
#if defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_128X128__)
        y1 += ((y2 - y1 + 1) >> 1);
#else
        y2 -= (((y2 - y1 + 1) >> 1) + 2);
#endif /* defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_128X128__) */
    }
    else
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    {
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        mmi_ucs2_to_asc((S8*)msgtypestr, GetString(WGUI_UCE_SMS_STRING_ID));
#if defined(__MMI_MAINLCD_128X128__) || defined(__MMI_MAINLCD_320X240__)
        /* only show  "SMS: 8888" */
        gui_sprintf(str, "%s: %d", msgtypestr, g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, g_wgui_uce_cntx.msg_type));
#else
        /* show "SMS: 8888(88)" */
        gui_sprintf(str, "%s: %d(%d)", 
                    msgtypestr, 
                    g_wgui_cat280_callback.get_sms_rm_character(&g_wgui_uce_cntx.text_info),
                    g_wgui_cat280_callback.get_sms_segment(&g_wgui_uce_cntx.text_info));
#endif /* defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_320X240__) */
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
#if defined(__MMI_MAINLCD_128X128__) || defined(__MMI_MAINLCD_320X240__)
        /* only show  "SMS: 8888" */
        gui_sprintf(str, "%d", g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, WGUI_UCE_MSG_TYPE_SMS));
#else
        /* show "SMS: 8888(88)" */
        gui_sprintf(str, "%d(%d)", 
                    g_wgui_cat280_callback.get_sms_rm_character(&g_wgui_uce_cntx.text_info),
                    g_wgui_cat280_callback.get_sms_segment(&g_wgui_uce_cntx.text_info));
#endif /* defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_320X240__) */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    }

    gui_set_font(f);
    gui_measure_string(str, &w, &h);

    /* set clip region */
    if (mmi_fe_get_r2l_state())
    {
        x2 -= ((x2 - x1 + 1) >> 1);
    }
    else
    {
        x1 += ((x2 - x1 + 1) >> 1);
    }

    /* set clear region */
    if (g_wgui_cat280_screen_info->msg_size_x1 == 0 || g_wgui_cat280_screen_info->msg_size_x2 == 0)
    {
        /* first time, clear default region */
        g_wgui_cat280_screen_info->msg_size_x1 = x1;
        g_wgui_cat280_screen_info->msg_size_x2 = x2;
        g_wgui_cat280_screen_info->msg_size_y1 = y1;
        g_wgui_cat280_screen_info->msg_size_y2 = y2;
    }

    /* clear information bar background */
    wgui_cat280_draw_information_background(
        g_wgui_cat280_screen_info->msg_size_x1, 
        g_wgui_cat280_screen_info->msg_size_y1, 
        g_wgui_cat280_screen_info->msg_size_x2, 
        g_wgui_cat280_screen_info->msg_size_y2);

    /* if string is too long, extend region */
    if ((x2 - x1) < (w + 1 /* gap */))
    {
        if (mmi_fe_get_r2l_state())
        {
            x2 = x1 + (w + 1);
        }
        else
        {
            x1 = x2 - (w + 3);
        }
    }

    gui_push_clip();
    gui_set_clip(x1, y1, x2, y2);
    gui_reset_text_clip();
    gui_set_text_clip(x1, y1, x2, y2);

    /* display text */
    if (mmi_fe_get_r2l_state())
    {
        gui_move_text_cursor(x1 + w, ((y2 + y1 + 1 - h) >> 1) + 1);
    }
    else
    {
        gui_move_text_cursor(x2 - w, ((y2 + y1 + 1 - h) >> 1) + 1);
    }
    gui_set_font(f);
    gui_set_text_color(font_color);

    gdi_layer_get_active(&act_layer);
    gdi_push_and_set_alpha_blending_source_layer(act_layer);
    gui_print_text(str);
    gdi_pop_and_restore_alpha_blending_source_layer();

    /* set new clear region depend on this time region */
    g_wgui_cat280_screen_info->msg_size_x1 = x1;
    g_wgui_cat280_screen_info->msg_size_x2 = x2;
    g_wgui_cat280_screen_info->msg_size_y1 = y1;
    g_wgui_cat280_screen_info->msg_size_y2 = y2;

    gui_pop_clip();
    gui_unlock_double_buffer();
    gdi_lcd_repaint_all();
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_information_bar
 * DESCRIPTION
 *  draw information bar 
 * PARAMETERS
 *  x1      [IN]        Start x
 *  y1      [IN]        Start Y
 *  x2      [IN]        End x
 *  y2      [IN]        End y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_information_bar(S32 x1, S32 y1, S32 x2, S32 y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if defined(__MMI_TOUCH_SCREEN__)
    #if defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_128X128__)
        stFontAttribute *f = &MMI_small_font;
    #elif defined(__MMI_MAINLCD_320X240__) || defined(__MMI_MAINLCD_320X480__)
        stFontAttribute *f = &MMI_small_font;
    #else /* 176x220, 240x320, 240x400 */
        stFontAttribute *f = &MMI_medium_font;
    #endif /* defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_128X128__) */
#else 
    stFontAttribute *f = &MMI_small_font;
#endif /* defined(__MMI_TOUCH_SCREEN__) */

    S32 attach_width = 0, attach_height = 0, audio_width = 0, audio_height = 0, bt_width = 0, bt_height = 0;
    S32 video_width = 0, video_height = 0, pic_width = 0, pic_height = 0;

#ifdef __WGUI_CAT280_SUPPORT_MMS__
    S32 width, height;
    wgui_uce_text_change_result_enum type;
    color font_color = *current_MMI_theme->remaining_length_text_color;
    U16 str[32];
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    GDI_HANDLE act_layer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();

    gui_push_clip();
    gui_set_clip(x1, y1, x2, y2);

    /* draw information bar background */
    wgui_cat280_draw_information_background(x1, y1, x2, y2);

    gdi_layer_get_active(&act_layer);
    gdi_push_and_set_alpha_blending_source_layer(act_layer);
    
    /* draw MMS information bar */
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS)
    {
        S32 icon_x1, icon_x2, icon_y1, icon_y2;
        S32 y_offset = y1 + ((y2 - y1 + 1) >> 1) ;

        /* show input method */
#if defined(__MMI_MAINLCD_320X240__)
        if (mmi_fe_get_r2l_state())
        {
            wgui_multiline_inputbox_show_current_input_method(x2 - WGUI_CAT280_IME_WIDTH + 1, y1, x2, y2 - 1);
        }
        else
        {
            wgui_multiline_inputbox_show_current_input_method(x1, y1, x1 + WGUI_CAT280_IME_WIDTH - 1, y2 - 1);
        }
#elif defined(__MMI_MAINLCD_320X480__)
        if (mmi_fe_get_r2l_state())
        {
            S32 y = y1 + ((y2 - y1 - WGUI_CAT280_IME_HEIGHT) >> 1);
            wgui_multiline_inputbox_show_current_input_method(x2 - ((x2 - x1 + 1) >> 2) + 1, y, x2, y + WGUI_CAT280_IME_HEIGHT - 1);
        }
        else
        {
            S32 y = y1 + ((y2 - y1 - WGUI_CAT280_IME_HEIGHT) >> 1);
            wgui_multiline_inputbox_show_current_input_method(x1, y, x1 + ((x2 - x1) >> 2) - 1, y + WGUI_CAT280_IME_HEIGHT - 1);
        }
#else /* defined(__MMI_MAINLCD_320X240__) || defined(__MMI_MAINLCD_320X480__) */
        if (mmi_fe_get_r2l_state())
        {
            wgui_multiline_inputbox_show_current_input_method(((x2 + x1 + 1) >> 1), y1, x2, ((y2 + y1 - 1) >> 1));
        }
        else
        {
            wgui_multiline_inputbox_show_current_input_method(x1, y1, ((x2 + x1 + 1) >> 1), ((y2 + y1 - 1) >> 1));
        }
#endif  /* defined(__MMI_MAINLCD_320X240__) || defined(__MMI_MAINLCD_320X480__) */

        /* show the touchable attachment icon */
#ifdef __WGUI_CAT280_ENHANCED_UI__
        if (g_wgui_uce_cntx.is_attachment)
        {
            S32 attach_button_w, attach_button_h;

            /* draw the attache button */
            gui_measure_image(get_image(WGUI_UCE_FTE_ATTACHE_BUTTON_NORMAL), &attach_button_w, &attach_button_h);
            gui_move_icontext_button(
                &g_wgui_uce_cntx.attach_button, 
                x1 + ((x2 - x1 + 1) >> 2) + 1 + CAT280_INFORMATION_BAR_ATTACH_BUTTON_GAP, 
                (y1 + (((y2 - y1 + 1) - attach_button_h) >> 1) + 1));
            gui_resize_icontext_button(&g_wgui_uce_cntx.attach_button, attach_button_w, attach_button_h);
            g_wgui_uce_cntx.attach_button.icon_x = 0;
            g_wgui_uce_cntx.attach_button.icon_y = 0;
            
#ifdef __MMI_TOUCH_SCREEN__
#if defined(__WGUI_CAT280_SUPPORT_RECIPIENTS__) && !defined(__MMI_FTE_SUPPORT__)
            if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS || 
                 g_wgui_uce_cntx.highligh_state == WGUI_UCE_CC_RECIPIENTS || 
                 g_wgui_uce_cntx.highligh_state == WGUI_UCE_BCC_RECIPIENTS || 
                 g_wgui_uce_cntx.highligh_state == WGUI_UCE_SUBJECT) &&
                (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS))
            {
                gui_icontext_button_overwirte_pen_response_area(&g_wgui_uce_cntx.attach_button, 0, 0, 0, 0);
            }
            else
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
            {
                gui_icontext_button_overwirte_pen_response_area(
                    &g_wgui_uce_cntx.attach_button, 
                    x1 + ((x2 - x1 + 1) >> 2) + 1 + CAT280_INFORMATION_BAR_ATTACH_BUTTON_GAP, 
                    (y1 + (((y2 - y1 + 1) - attach_button_h) >> 1) + 1),
                    x1 + ((x2 - x1 + 1) >> 2) + 1 + CAT280_INFORMATION_BAR_ATTACH_BUTTON_GAP + attach_button_w, 
                    (y1 + (((y2 - y1 + 1) - attach_button_h) >> 1) + 1) + attach_button_h);
            }
#endif /* __MMI_TOUCH_SCREEN__ */
            gui_show_icontext_button(&g_wgui_uce_cntx.attach_button);
        }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */

        /* get the display type,  size or character*/
        if (g_wgui_cat280_callback.get_display_type != NULL)
		{
            type = g_wgui_cat280_callback.get_display_type();
        }
        else
        {
            type = WGUI_UCE_DISPLAY_SIZE; /* default for MMS is display size */
        }
        
        /* if display character, not display slide number */
        if (type ==  WGUI_UCE_DISPLAY_SIZE)
        {                        
            gui_sprintf(str, "(%d/%d)", g_wgui_uce_cntx.current_slide,g_wgui_uce_cntx.total_slides);
            gui_set_font(f);
            gui_measure_string(str, &width, &height);
            
            /* For MTE tool change image */
#if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__)
            gui_measure_image((PU8)(current_MMI_theme->cascade_menu_submenu_left_arrow_image), &bt_width, &bt_height);
            if ((bt_width == 0) || (bt_height == 0))
            {
                gui_measure_image((PU8)GetImage(LEFT_RED_ARROW), &bt_width, &bt_height);
                if ((bt_width == 0) || (bt_height == 0))
                {
                    gui_measure_image((PU8)(current_MMI_theme->cascade_menu_submenu_right_arrow_image), &bt_width, &bt_height);
                    if ((bt_width == 0) || (bt_height == 0))
                    {
                        gui_measure_image((PU8)GetImage(RIGHT_RED_ARROW), &bt_width, &bt_height);
                    }
                }
            }
#else /* #if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__) */
            gui_measure_image((PU8)(current_MMI_theme->UCE_screen_pre_button_image), &bt_width, &bt_height);
            if ((bt_width == 0) || (bt_height == 0))
            {
                gui_measure_image((PU8)(current_MMI_theme->UCE_screen_pre_button_disabled_image), &bt_width, &bt_height);
                if ((bt_width == 0) || (bt_height == 0))
                {
                    gui_measure_image((PU8)(current_MMI_theme->UCE_screen_next_button_image), &bt_width, &bt_height);
                    if ((bt_width == 0) || (bt_height == 0))
                    {
                        gui_measure_image((PU8)(current_MMI_theme->UCE_screen_next_button_disabled_image), &bt_width, &bt_height);
                    }
                }
            }
#endif /* #if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__) */
            {
#if defined(__MMI_MAINLCD_320X240__) || defined(__MMI_MAINLCD_320X480__)
                S32 bt1_x1_r2l = x1 + 1;
                S32 bt2_x1_r2l = x1 + 1 + width + bt_width;
                S32 bt1_x1 = x2 - width - ((bt_width + 1) << 1);
                S32 bt2_x1 = x2 - bt_width - 1;
                S32 bt_y = ((y2 + y_offset - bt_height - 1) >> 1);
                S32 cur_x_r2l = x1 + width + bt_width;
                S32 cur_x = x2 - 2 - width - bt_width;
                S32 cur_y = ((y2 + y_offset - height - 1) >> 1);
#elif defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_128X128__)
                S32 bt1_x1_r2l = x1 + 1;
                S32 bt2_x1_r2l = x1 + width + bt_width + 1;
                S32 bt1_x1 = x2 - width - bt_width - bt_width - 2;
                S32 bt2_x1 = x2 - bt_width - 1;
                S32 bt_y = ((y_offset + y1 - bt_height - 1) >> 1);
                S32 cur_x_r2l = x1 + width + bt_width;
                S32 cur_x = x2 - 2 - width - bt_width;
                S32 cur_y = ((y_offset + y1 - height - 1) >> 1);
#else
                S32 bt1_x1_r2l = x2 - width - (bt_width << 1);
                S32 bt2_x1_r2l = x2 - bt_width;
                S32 bt1_x1 = x2 - width - (bt_width << 1) - 1;
                S32 bt2_x1 = x2 - bt_width;
                S32 bt_y = ((y2 + y_offset - bt_height - 1) >> 1);
                S32 cur_x_r2l = x2 - bt_width - 1;
                S32 cur_x = x2 - width - bt_width - 1;
                S32 cur_y = ((y2 + y_offset - height - 1) >> 1);
#endif /* defined(__MMI_MAINLCD_320X240__) || defined(__MMI_MAINLCD_320X480__) */

                wgui_cat280_draw_msg_page(
                      bt1_x1_r2l, 
                      bt2_x1_r2l, 
                      bt1_x1, 
                      bt2_x1, 
                      bt_y, 
                      bt_width, 
                      bt_height,
                      cur_x_r2l,
                      cur_x,
                      cur_y);

                gui_set_font(f);
                gui_set_text_color(font_color);
                gui_print_text(str);
            }
        } 

#ifndef __WGUI_CAT280_ENHANCED_UI__
        /* Icons */
        if (type == WGUI_UCE_DISPLAY_CHARACTER)
        {
            gui_measure_image((PU8) GetImage(WGUI_UCE_VIDEO_ICON_IMAGE_ID), &video_width, &video_height);
            gui_measure_image((PU8) GetImage(WGUI_UCE_PICTURE_ICON_IMAGE_ID), &pic_width, &pic_height);
            
            /* Show attachment icon */            
    #if defined(__MMI_MAINLCD_320X240__) 
            icon_x1 = (mmi_fe_get_r2l_state()) ? (x2 - WGUI_CAT280_IME_WIDTH + 1) : (x1 + WGUI_CAT280_IME_WIDTH - 1);
            icon_x2 = icon_x1 + video_width - 1;
            icon_y1 = y1 + ((y2 - y1 + 1 - video_height) >> 1) - 1;
            icon_y2 = icon_y1 + video_height - 1;
    #elif defined(__MMI_MAINLCD_320X480__)
            icon_x1 = (mmi_fe_get_r2l_state()) ? (x2 - ((x2 - x1 + 1) >> 1) + 1) : (x1 + ((x2 - x1 + 1) >> 2) - 1);
            icon_x2 = icon_x1 + video_width - 1;
            icon_y1 = y1 + ((y2 - y1 + 1 - video_height) >> 1) - 1;
            icon_y2 = icon_y1 + video_height - 1;
    #elif defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_128X128__)
            icon_x1 = (mmi_fe_get_r2l_state()) ? (UI_device_width - WGUI_CAT280_ICON_X_GAP - video_width) : WGUI_CAT280_ICON_X_GAP;
            icon_x2 = icon_x1 + video_width - 1;
            icon_y1 = y_offset + ((y2 - y_offset + 1 - video_height) >> 1) - 1;
            icon_y2 = icon_y1 + video_height - 1;
    #else
            icon_x1 = current_MMI_theme->scrollbar_size;
            icon_x2 = icon_x1 + video_width - 1;
            icon_y1 = y_offset + ((y2 - y_offset + 1 - video_height) >> 1) - 1;
            icon_y2 = icon_y1 + video_height - 1;
    #endif /* defined(__MMI_MAINLCD_320X240__) || defined(__MMI_MAINLCD_320X480__) */

            gui_show_image(icon_x1, icon_y1, (PU8) GetImage(WGUI_UCE_ATTACHFILE_ICON_IMAGE_ID));
            
            /* show icon for video or image */
            if (g_wgui_uce_cntx.is_video == MMI_TRUE)
            {            
                gui_show_image(icon_x1, icon_y1, (PU8) GetImage(WGUI_UCE_VIDEO_ICON_IMAGE_ID));
            }
            else
            {            
                gui_show_image(icon_x1, icon_y1, (PU8) GetImage(WGUI_UCE_PICTURE_ICON_IMAGE_ID));
            }

            if (g_wgui_uce_cntx.is_image == MMI_FALSE && g_wgui_uce_cntx.is_video == MMI_FALSE)
            {
                gui_greyscale_rectangle(
                    icon_x1,
                    icon_y1,
                    icon_x2,
                    icon_y2,
                    MMI_BG_GREYSCALE_VALUE,
                    MMI_BG_GREYSCALE_BLACK_VALUE);
            }
            y2 -= ((y2 - y1 + 1) >> 1) ;
        }
        else
        {
            gui_measure_image((PU8) GetImage(WGUI_UCE_ATTACHFILE_ICON_IMAGE_ID), &attach_width, &attach_height);
            gui_measure_image((PU8) GetImage(WGUI_UCE_AUDIO_ICON_IMAGE_ID), &audio_width, &audio_height);        
            gui_measure_image((PU8) GetImage(WGUI_UCE_VIDEO_ICON_IMAGE_ID), &video_width, &video_height);
            gui_measure_image((PU8) GetImage(WGUI_UCE_PICTURE_ICON_IMAGE_ID), &pic_width, &pic_height);
            
            /* Show attachment icon */            
    #if defined(__MMI_MAINLCD_320X240__)
            icon_x1 = (mmi_fe_get_r2l_state()) ?
                      (UI_device_width - WGUI_CAT280_IME_WIDTH - WGUI_CAT280_ICON_X_GAP - video_width - WGUI_CAT280_ICON_X_GAP - audio_width - WGUI_CAT280_ICON_X_GAP - attach_width) :
                      (x1 + WGUI_CAT280_IME_WIDTH - 1);
            icon_x2 = icon_x1 + video_width - 1;
            icon_y1 = y1 + ((y2 - y1 + 1 - video_height) >> 1) - 1;
            icon_y2 = icon_y1 + video_height - 1;
    #elif defined(__MMI_MAINLCD_320X480__)
            icon_x1 = (mmi_fe_get_r2l_state()) ? (x2 - ((x2 - x1 + 1) >> 1) + 1) : (x1 + ((x2 - x1 + 1) >> 2) - 1);
            icon_x2 = icon_x1 + attach_width - 1;
            icon_y1 = y1 + ((y2 - y1 + 1 - attach_height) >> 1) - 1;
            icon_y2 = icon_y1 + attach_height - 1;
    #elif defined(__MMI_MAINLCD_128X160__) || defined(__MMI_MAINLCD_128X128__)
            icon_x1 = (mmi_fe_get_r2l_state()) ? 
                      (UI_device_width - WGUI_CAT280_ICON_X_GAP - video_width - WGUI_CAT280_ICON_X_GAP - audio_width - WGUI_CAT280_ICON_X_GAP - attach_width) :
                      WGUI_CAT280_ICON_X_GAP;
            icon_x2 = icon_x1 + attach_width - 1;
            icon_y1 = y_offset + ((y2 - y_offset + 1 - attach_height) >> 1) - 1;
            icon_y2 = icon_y1 + attach_height - 1;
    #else
            icon_x1 = current_MMI_theme->scrollbar_size;
            icon_x2 = icon_x1 + attach_width - 1;
            icon_y1 = y_offset + ((y2 - y_offset + 1 - attach_height) >> 1) - 1;
            icon_y2 = icon_y1 + attach_height - 1;
    #endif /* defined(__MMI_MAINLCD_320X240__) || defined(__MMI_MAINLCD_320X480__) */

            gui_show_image(icon_x1, icon_y1, (PU8) GetImage(WGUI_UCE_ATTACHFILE_ICON_IMAGE_ID));

            if (g_wgui_uce_cntx.is_attachment == MMI_FALSE)  /* no attachment */
            {
                gui_greyscale_rectangle(
                    icon_x1,
                    icon_y1,
                    icon_x2,
                    icon_y2,
                    MMI_BG_GREYSCALE_VALUE,
                    MMI_BG_GREYSCALE_BLACK_VALUE);
            }

            /* show audio icon */        
            icon_x1 = icon_x2 + WGUI_CAT280_ICON_X_GAP;
            icon_x2 = icon_x1 + audio_width - 1;

            gui_show_image(icon_x1, icon_y1, (PU8) GetImage(WGUI_UCE_AUDIO_ICON_IMAGE_ID));

            if (g_wgui_uce_cntx.is_audio == MMI_FALSE)
            {
                gui_greyscale_rectangle(
                    icon_x1,
                    icon_y1,
                    icon_x2,
                    icon_y2,
                    MMI_BG_GREYSCALE_VALUE,
                    MMI_BG_GREYSCALE_BLACK_VALUE);
            }
            
            /* show icon for video or image */
            if (g_wgui_uce_cntx.is_video == MMI_TRUE)
            {            
                icon_x1 = icon_x2 + WGUI_CAT280_ICON_X_GAP;
                icon_x2 = icon_x1 + video_width - 1;

                gui_show_image(icon_x1, icon_y1, (PU8) GetImage(WGUI_UCE_VIDEO_ICON_IMAGE_ID));
            }
            else
            {            
                icon_x1 = icon_x2 + WGUI_CAT280_ICON_X_GAP;
                icon_x2 = icon_x1 + pic_width - 1;

                gui_show_image(icon_x1, icon_y1, (PU8) GetImage(WGUI_UCE_PICTURE_ICON_IMAGE_ID));
            }

            if (g_wgui_uce_cntx.is_image == MMI_FALSE && g_wgui_uce_cntx.is_video == MMI_FALSE)
            {
                gui_greyscale_rectangle(
                    icon_x1,
                    icon_y1,
                    icon_x2,
                    icon_y2,
                    MMI_BG_GREYSCALE_VALUE,
                    MMI_BG_GREYSCALE_BLACK_VALUE);
            }

            //y2 -= ((y2 - y1 + 1) >> 1) ;
        }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
    }
    else /* SMS */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    {
        S32 ime_icon_x1, ime_icon_x2;
    #if defined(__MMI_MAINLCD_320X240__)
        ime_icon_x1 = (mmi_fe_get_r2l_state()) ? (x2 - WGUI_CAT280_IME_WIDTH + 1) : (x1);
        ime_icon_x2 = (mmi_fe_get_r2l_state()) ? (x2) : (x1 + WGUI_CAT280_IME_WIDTH - 1);
        wgui_multiline_inputbox_show_current_input_method(ime_icon_x1, y1, ime_icon_x2, y2 - 1);
    #else  /* defined(__MMI_MAINLCD_320X240__) */
        ime_icon_x1 = (mmi_fe_get_r2l_state()) ? ((x2 + x1 + 1) >> 1) : (x1);
        ime_icon_x2 = (mmi_fe_get_r2l_state()) ? (x2) : (x2 + ((x2 + x1 + 1) >> 1));
        wgui_multiline_inputbox_show_current_input_method(ime_icon_x1, y1, ime_icon_x2, y2);
    #endif  /* defined(__MMI_MAINLCD_320X240__) */
    }

    gdi_pop_and_restore_alpha_blending_source_layer();
    gui_pop_clip();
    
    wgui_cat280_draw_msg_size(x1, y1, x2, y2);

    gdi_layer_unlock_frame_buffer();
    gdi_layer_blt_previous(x1, y1, x2, y2);
}
#endif /* __MMI_FTE_SUPPORT__ */


#if defined(__WGUI_CAT280_SUPPORT_MMS__) || defined(__WGUI_CAT280_SUPPORT_RECIPIENTS__)
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_string
 * DESCRIPTION
 *  draw string
 * PARAMETERS
 *  string       [IN]        string to draw
 *  x            [IN]        string region x
 *  y            [IN]        string region y
 *  w            [IN]        string region width
 *  color        [IN]        string color
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_string(UI_string_type string, S32 x, S32 y, S32 w, color c)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/    
    /* mmi_mslt_c280_query_function() also use this font, need sync */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_set_text_color(c);
    gui_set_font(&MMI_medium_font);
    
    if (mmi_fe_get_r2l_state())
    {
        gui_print_truncated_text(x + w - 1, y, w, string);
    }
    else
    {
        gui_print_truncated_text(x, y, w, string);
    }
}
#endif /* defined(__WGUI_CAT280_SUPPORT_MMS__) || defined(__WGUI_CAT280_SUPPORT_RECIPIENTS__) */


#ifdef __WGUI_CAT280_SUPPORT_MMS__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_change_slide
 * DESCRIPTION
 *  callback APP to change slide
 * PARAMETERS
 *  key_code      [IN]        key code
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_change_slide(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    if (g_wgui_cat280_callback.change_slide != NULL)
    {
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
        g_wgui_uce_cntx.in_change_slide = MMI_TRUE;
#endif

        mmi_frm_send_incomplete_key_event_to_new_screen(MMI_TRUE);
        if (key_code == KEY_RIGHT_ARROW)
        {
            g_wgui_cat280_callback.change_slide(WGUI_UCE_CHANGE_SLIDE_NEXT);
        }
        else if (key_code == KEY_LEFT_ARROW)
        {
            g_wgui_cat280_callback.change_slide(WGUI_UCE_CHANGE_SLIDE_PREVIOUS);
        }

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
        g_wgui_uce_cntx.in_change_slide = MMI_FALSE;
#endif
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_pre_button_hdlr
 * DESCRIPTION
 *  information bar button handler (previous button)
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_pre_button_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    wgui_cat280_change_slide(KEY_LEFT_ARROW);
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_next_button_hdlr
 * DESCRIPTION
 *  information bar button handler (next button)
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_next_button_hdlr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    wgui_cat280_change_slide(KEY_RIGHT_ARROW);
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_resize_and_move_button
 * DESCRIPTION
 *  resize and move the button on information bar
 * PARAMETERS
 *  index   [IN]   button index
 *  x       [IN]   button position x
 *  y       [IN]   button position y
 *  w       [IN]   button width
 *  h       [IN]   button height
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_resize_and_move_button(U16 index, S32 x, S32 y, S32 w, S32 h)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    icontext_button *button;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    dm_resize_button(index, w, h);
    dm_move_button(index, x, y);
    button = dm_get_button(index);
    button->flags &= ~UI_BUTTON_STATE_DISABLED;
    
#ifdef __MMI_TOUCH_SCREEN__    
    gui_icontext_button_overwirte_pen_response_area(button, x, y, x + w - 1, y + h - 1);
#endif
}

#ifndef __MMI_FTE_SUPPORT__

/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_slide_button
 * DESCRIPTION
 *  draw slide button on information bar
 * PARAMETERS
 *  bt1_left_x1   [IN]   button1 x1
 *  bt1_left_y1   [IN]   button1 y1
 *  bt2_right_x1  [IN]   button2 x1
 *  bt2_right_y1  [IN]   button2 y2
 *  bt_width      [IN]   button width
 *  bt_height     [IN]   button height
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_slide_button
                  (S32 bt1_left_x1, S32 bt1_left_y1, S32 bt2_right_x1, S32 bt2_right_y1, S32 bt_width, S32 bt_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* left button */
    if (g_wgui_uce_cntx.current_slide == 1) /* at first slide */
    {
#if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__)
       // gui_show_image(bt1_left_x1, bt1_left_y1, (PU8)GetImage(IMG_LEFT_DISABLED_ARROW));
        gui_draw_image_with_alpha_transparent(PU8)GetImage(LEFT_RED_ARROW),bt1_left_x1,bt1_left_y1,128);
#else /* #if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__) */
        gui_show_image(bt1_left_x1, bt1_left_y1, (PU8)(current_MMI_theme->UCE_screen_pre_button_disabled_image));
#endif /* #if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__) */
    }
    else
    {
        wgui_cat280_resize_and_move_button(g_wgui_uce_cntx.pre_bt, bt1_left_x1, bt1_left_y1, bt_width, bt_height);
        dm_redraw_button(g_wgui_uce_cntx.pre_bt);
    }

    /* right button */
    if (g_wgui_uce_cntx.current_slide == g_wgui_uce_cntx.total_slides) /* at last slide */
    {
#if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__)
        //gui_show_image(bt2_right_x1, bt2_right_y1, (PU8)GetImage(IMG_RIGHT_DISABLED_ARROW));
        gui_draw_image_with_alpha_transparent(PU8)GetImage(RIGHT_RED_ARROW),bt2_right_x1,bt2_right_y1,128);
#else /* #if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__) */
        gui_show_image(bt2_right_x1, bt2_right_y1, (PU8)(current_MMI_theme->UCE_screen_next_button_disabled_image));
#endif /* #if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__) */
    }
    else
    {                    
        wgui_cat280_resize_and_move_button(g_wgui_uce_cntx.next_bt, bt2_right_x1, bt2_right_y1, bt_width, bt_height);
        dm_redraw_button(g_wgui_uce_cntx.next_bt);
    }
}
#endif /*__MMI_FTE_SUPPORT__*/

/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_thumbnail_frame
 * DESCRIPTION
 *  draw wired frame of thumbnail
 * PARAMETERS
 *  y_start        [IN]        region y
 *  total_height   [IN]        region height
 *  draw_x         [IN/OUT]    frame x
 *  draw_y         [IN/OUT]    frame y
 *  draw_width     [IN/OUT]    frame width
 *  draw_height    [IN/OUT]    frame height
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL wgui_cat280_draw_thumbnail_frame(
         S32 y_start, S32 total_height, 
         S32* draw_x, S32* draw_y, S32* draw_width, S32* draw_height,
         wgui_uce_highlight_state_enum state)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    color frame_color;
    MMI_BOOL result = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_fe_get_r2l_state())
    {
        *draw_x = current_MMI_theme->scrollbar_size + CAT280_HMARGIN - 1;
    }
    else
    {
        *draw_x = CAT280_HMARGIN - 1;
    }
    *draw_width = MMI_content_width - current_MMI_theme->scrollbar_size - (CAT280_HMARGIN << 1);
    *draw_y = y_start  + (CAT280_VMARGIN >> 1);
    *draw_height = CAT280_THUMBNAIL_FRAME_HEIGHT - (CAT280_VMARGIN >> 1); 

    if (wgui_cat280_get_highlight_state() == state)
    {    
        frame_color.alpha = current_MMI_theme->inputbox_selector_color->alpha;
        frame_color.r = current_MMI_theme->inputbox_selector_color->r;
        frame_color.g = current_MMI_theme->inputbox_selector_color->g;
        frame_color.b = current_MMI_theme->inputbox_selector_color->b;
        gui_draw_rectangle(*draw_x, *draw_y, *draw_x + *draw_width, *draw_y + *draw_height, frame_color);
        result = MMI_TRUE;
    }
    *draw_x += 1;
    *draw_width -= 1;

    return result;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_show_preview_from_cached_buffer
 * DESCRIPTION
 *  used to show the contents of thumbnail buffer
 * PARAMETERS
 *  x_offset        [IN]        Start x
 *  y_offset        [IN]        Start Y
 *  width           [IN]        Area width
 *  height          [IN]        Area height
 * RETURNS
 *  Whether able to display conents of thumbnail buffer
 *****************************************************************************/
static void wgui_cat280_show_preview_from_cached_buffer(S32 x_offset, S32 y_offset, S32 width, S32 height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 clip_x1, clip_y1, clip_x2, clip_y2;
    S32 x, y, y_multiple;
    U16 *buf = (U16*) g_wgui_uce_cntx.thumbnail_buffer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_get_clip(&clip_x1, &clip_y1, &clip_x2, &clip_y2);


    if ((clip_x2 < x_offset) || (clip_x1 > x_offset + width - 1) 
        || (clip_y2 < y_offset) || (clip_y1 > y_offset + height - 1))
    {
        /* sometimes mutliline input would want to draw the preview outside clip area */  
        return;
    }


    if (clip_x1 < x_offset)
    {
        clip_x1 = x_offset;
    }

    if (clip_y1 < y_offset)
    {
        clip_y1 = y_offset;
    }

    if (clip_x2 > x_offset + width - 1)
    {
        clip_x2 = x_offset + width - 1;
    }

    if (clip_y2 > y_offset + height - 1)
    {
        clip_y2 = y_offset + height - 1;
    }

    clip_x1 -= x_offset;
    clip_y1 -= y_offset;
    clip_x2 -= x_offset;
    clip_y2 -= y_offset;

    for (y = clip_y1; y <= clip_y2; y++)
    {
        y_multiple = y * width;
        for (x = clip_x1; x <= clip_x2; x++)
        {
            GDI_SET_BUFFER_PIXEL2(x + x_offset, y + y_offset, buf[y_multiple + x]);
        }
    }
    return;
}


#ifdef __MMI_VIDEO_PLAY_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_load_video_first_frame_into_cache
 * DESCRIPTION
 *  loads video first frame into category thumbnail buffer
 * PARAMETERS
 *  video_x             [IN]        Start x
 *  video_y             [IN]        Start Y
 *  video_width         [IN]        Area width
 *  video_height        [IN]        Area height
 * RETURNS
 *  Whether able to load video first frame into buffer
 *****************************************************************************/
static MMI_BOOL wgui_cat280_load_video_first_frame_into_cache(S32 video_x, S32 video_y, S32 video_width, S32 video_height, mdi_video_info_struct* video_clip)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MDI_RESULT mdi_ret;

    gdi_handle cache_layer;
    gdi_handle act_layer;

#ifdef __MDI_DISPLAY_YUYV422_SUPPORT__
    S32 clip_x1, clip_y1, clip_x2, clip_y2;
    S32 x_offset =video_x;
    S32 y_offset = video_y;
    S32 width = video_width;
    S32 height = video_height;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MDI_DISPLAY_YUYV422_SUPPORT__
    gdi_layer_get_clip(&clip_x1, &clip_y1, &clip_x2, &clip_y2);
    if ((clip_x2 < x_offset) || (clip_x1 > x_offset + width - 1) 
        || (clip_y2 < y_offset) || (clip_y1 > y_offset + height - 1))
    {
        /* sometimes mutliline input would want to draw the preview outside clip area */  
        return MMI_TRUE;
    }

    if (clip_x1 < x_offset)
    {
        clip_x1 = x_offset;
    }

    if (clip_y1 < y_offset)
    {
        clip_y1 = y_offset;
    }

    if (clip_x2 > x_offset + width - 1)
    {
        clip_x2 = x_offset + width - 1;
    }

    if (clip_y2 > y_offset + height - 1)
    {
        clip_y2 = y_offset + height - 1;
    }
#endif
    if (gdi_layer_create_using_outside_memory
        (video_x, video_y, video_width, video_height, &cache_layer, (U8*) g_wgui_uce_cntx.thumbnail_buffer,
         CAT280_THUMBNAIL_BUFFER_SIZE) != GDI_LAYER_SUCCEED)
    {
        return MMI_FALSE;
    }
    
#ifdef __MDI_DISPLAY_YUYV422_SUPPORT__
    gdi_layer_push_and_set_active(cache_layer);
    gdi_layer_set_color_format(GDI_COLOR_FORMAT_UYVY422);
    gdi_layer_pop_and_restore_active();
#endif

    mdi_ret = mdi_video_ply_open_clip_file(0, (S8*) g_wgui_uce_cntx.file_path, video_clip);
    if (mdi_ret == MDI_RES_VDOPLY_SUCCEED)
    {
        /* draw the first frame of the video */
        memset((void*)g_wgui_uce_cntx.thumbnail_buffer, 0, CAT280_THUMBNAIL_BUFFER_SIZE);
        mdi_ret = mdi_video_ply_seek_and_get_frame((U64) 0, cache_layer);
        mdi_video_ply_close_clip_file();
        if (mdi_ret < 0)
        {
            gdi_layer_free(cache_layer);
            return MMI_FALSE;
        }
    }
#ifdef __MDI_DISPLAY_YUYV422_SUPPORT__
    gdi_layer_get_active(&act_layer);
    gdi_layer_push_clip();
    //gdi_layer_set_clip(MMI_multiline_inputbox.x, MMI_multiline_inputbox.y, MMI_multiline_inputbox.x + MMI_multiline_inputbox.width - 1, MMI_multiline_inputbox.y + MMI_multiline_inputbox.height - 1);
    gdi_layer_set_clip(clip_x1,clip_y1,clip_x2,clip_y2);
    gdi_layer_flatten_with_clipping(act_layer, cache_layer, 0 ,0);
    gdi_layer_pop_clip();
#endif
    gdi_layer_free(cache_layer);

    return MMI_TRUE;
}
#endif /* __MMI_VIDEO_PLAY_SUPPORT__ */


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_load_image_into_cache
 * DESCRIPTION
 *  Load image into category thumbnail buffer
 * PARAMETERS
 *  img_x           [IN]        Start x
 *  img_y           [IN]        Start Y
 *  img_width       [IN]        Area width
 *  img_height      [IN]        Area height
 * RETURNS
 *  Whether able to load image into category buffer
 *****************************************************************************/
static MMI_BOOL wgui_cat280_load_image_into_cache(S32 img_x, S32 img_y, S32 img_width, S32 img_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    gdi_handle cache_layer;
	MMI_BOOL ret=MMI_TRUE;
    gdi_handle old_act_layer;
    gdi_handle old_alpha_blending_source_layer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* If not enough memory in buffer than layer creation will assert */
    if (gdi_layer_create_using_outside_memory
        (0, 0, img_width, img_height, &cache_layer, (U8*) g_wgui_uce_cntx.thumbnail_buffer,
         CAT280_THUMBNAIL_BUFFER_SIZE) != GDI_LAYER_SUCCEED)
    {
        return MMI_FALSE;
    }

    gdi_layer_get_active(&old_act_layer);
    gdi_layer_push_and_set_active(cache_layer);
    old_alpha_blending_source_layer = gdi_set_alpha_blending_source_layer(old_act_layer);
    gdi_layer_set_source_key(TRUE, GDI_COLOR_TRANSPARENT);
    gdi_layer_set_clip(0, 0, img_width - 1, img_height - 1);
    gdi_layer_set_position(img_x, img_y);
    gdi_draw_solid_rect(0, 0, img_width - 1, img_height - 1, GDI_COLOR_WHITE);
	
	if (gdi_image_draw_resized_file(0, 0, img_width, img_height, (S8*) g_wgui_uce_cntx.file_path) != GDI_SUCCEED)
	{
		ret = MMI_FALSE;
	}

    gdi_layer_pop_and_restore_active();
    gdi_set_alpha_blending_source_layer(old_alpha_blending_source_layer);

    gdi_layer_free(cache_layer);

    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_show_object_preview
 * DESCRIPTION
 *  Show video first frame or image preview:
 * PARAMETERS
 *  preview_x           [IN]        Start x
 *  preview_y           [IN]        Start Y
 *  preview_width       [IN]        Area width
 *  preview_height      [IN]        Area height
 * RETURNS
 *  whether able to display preview
 *****************************************************************************/
static MMI_BOOL wgui_cat280_show_object_preview(S32 preview_x, S32 preview_y, S32 preview_width, S32 preview_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 img_width = 0, img_height = 0;
    MMI_BOOL is_first_load = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_wgui_uce_cntx.is_image)
    {
        UI_string_type err_str_ptr = NULL;

        if (!mmi_fmgr_util_file_limit_check(FMGR_LIMIT_MMS_CATEGORY, (S8*) g_wgui_uce_cntx.file_path, (PS8*)&err_str_ptr))
        {
            return MMI_FALSE;
        }

        if (GDI_SUCCEED != gdi_image_get_dimension_file((S8*) g_wgui_uce_cntx.file_path, &img_width, &img_height))
        {
            return MMI_FALSE;
        }
    }
    else if (g_wgui_uce_cntx.is_video)
    {
    #ifdef __MMI_VIDEO_PLAY_SUPPORT__
        if (g_wgui_cat280_screen_info->is_got_size == MMI_FALSE)
        {
            MDI_RESULT mdi_ret;

            memset(&wgui_video_info, 0, sizeof(mdi_video_info_struct));
            mdi_video_ply_enable_aud_only_video_clip();
            mdi_ret = mdi_video_ply_open_clip_file(0, (S8*) g_wgui_uce_cntx.file_path, &wgui_video_info);
            g_wgui_cat280_screen_info->is_got_size = MMI_TRUE;
            if (mdi_ret == MDI_RES_VDOPLY_SUCCEED)
            {
                img_height = g_wgui_cat280_screen_info->video_height = wgui_video_info.height;
                img_width = g_wgui_cat280_screen_info->video_width = wgui_video_info.width;
                mdi_video_ply_close_clip_file();
            }
            else
            {
                memset(&wgui_video_info, 0, sizeof(mdi_video_info_struct));
                return MMI_FALSE;
            }
        }
        else
        {
            img_width = g_wgui_cat280_screen_info->video_width;
            img_height = g_wgui_cat280_screen_info->video_height;
        }
    #else /* __MMI_VIDEO_PLAY_SUPPORT__ */ 
        return MMI_FALSE;
    #endif /* __MMI_VIDEO_PLAY_SUPPORT__ */ 
    }

    if ((img_width <= 0) || (img_height <= 0))
    {
        return MMI_FALSE;
    }

    /* drawable region larger than image */
    if ( preview_width > img_width  && preview_height > img_height )
    {
        /* align image at the center of preview rectangle */
        preview_x += ((preview_width - img_width) >> 1);
        preview_width = img_width;
        preview_y += ((preview_height - img_height) >> 1);
        preview_height = img_height;
    }
    else
    {
        S32 resized_offset_x, resized_offset_y, resized_width, resized_height;

        gdi_image_util_fit_bbox(
            preview_width - 1,
            preview_height - 1,
            img_width,
            img_height,
            &resized_offset_x,
            &resized_offset_y,
            &resized_width,
            &resized_height);

        /* check resized width and height */
        if (resized_width == 0)
        {
            resized_width = 1;
            resized_offset_x--;
        }
        if (resized_height == 0)
        {
            resized_height = 1;
            resized_offset_y--;
        }
        resized_width = ((resized_width + 1) >> 1);
        resized_width = (resized_width << 1);
        resized_height = ((resized_height + 1) >> 1);
        resized_height = (resized_height << 1);

        preview_width = resized_width;
        preview_height = resized_height;
        preview_x += resized_offset_x;
        preview_y += resized_offset_y;
    }


#ifdef __MDI_DISPLAY_YUYV422_SUPPORT__
    /* Get Memory for thumbnail */
    if (g_wgui_uce_cntx.thumbnail_buffer == NULL)
    {
        /* If object is deleted, then screen has to be exited so the buffer will be deallocated in category exit */
        g_wgui_uce_cntx.thumbnail_buffer = (U8*) applib_mem_screen_alloc_framebuffer(CAT280_THUMBNAIL_BUFFER_SIZE);

        if (NULL == g_wgui_uce_cntx.thumbnail_buffer)
        {
            return MMI_FALSE;
        }
        is_first_load = MMI_TRUE;
    }

    {
        if (g_wgui_uce_cntx.is_image && is_first_load)
        {
            if (MMI_FALSE == wgui_cat280_load_image_into_cache(preview_x, preview_y, preview_width, preview_height))
            {
                return MMI_FALSE;
            }
        }
        else if (g_wgui_uce_cntx.is_video)
        {
            #ifdef __MMI_VIDEO_PLAY_SUPPORT__
            if (MMI_FALSE == wgui_cat280_load_video_first_frame_into_cache(preview_x, preview_y, preview_width, preview_height, &wgui_video_info))
            {
                return MMI_FALSE;
            }
            #else /* __MMI_VIDEO_PLAY_SUPPORT__ */
                return MMI_FALSE;
            #endif /* __MMI_VIDEO_PLAY_SUPPORT__ */
        }
    }

    if (g_wgui_uce_cntx.is_video == MMI_FALSE)
    {
        wgui_cat280_show_preview_from_cached_buffer(preview_x, preview_y, preview_width, preview_height);
    }
#else /* __MDI_DISPLAY_YUYV422_SUPPORT__ */
    /* Get Memory for thumbnail */
    if (g_wgui_uce_cntx.thumbnail_buffer == NULL)
    {
        /* If object is deleted, then screen has to be exited so the buffer will be deallocated in category exit */
        g_wgui_uce_cntx.thumbnail_buffer = (U8*) applib_mem_screen_alloc_framebuffer(CAT280_THUMBNAIL_BUFFER_SIZE);

        if (NULL == g_wgui_uce_cntx.thumbnail_buffer)
        {
            return MMI_FALSE;
        }

        if (g_wgui_uce_cntx.is_image)
        {
            if (MMI_FALSE == wgui_cat280_load_image_into_cache(preview_x, preview_y, preview_width, preview_height))
            {
                return MMI_FALSE;
            }
        }
        else if (g_wgui_uce_cntx.is_video)
        {
            #ifdef __MMI_VIDEO_PLAY_SUPPORT__
            if (MMI_FALSE == wgui_cat280_load_video_first_frame_into_cache(preview_x, preview_y, preview_width, preview_height, &wgui_video_info))
            {
                return MMI_FALSE;
            }
            #else /* __MMI_VIDEO_PLAY_SUPPORT__ */
                return MMI_FALSE;
            #endif /* __MMI_VIDEO_PLAY_SUPPORT__ */
        }
    }
    wgui_cat280_show_preview_from_cached_buffer(preview_x, preview_y, preview_width, preview_height);
#endif /* __MDI_DISPLAY_YUYV422_SUPPORT__ */

    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_default_thumbnail
 * DESCRIPTION
 *  show default preview based on image id
 * PARAMETERS
 *  preview_x           [IN]        Start x
 *  preview_y           [IN]        Start Y
 *  preview_width       [IN]        Area width
 *  preview_height      [IN]        Area height
 * RETURNS
 *  whether able to display preview or not
 *****************************************************************************/
static MMI_BOOL wgui_cat280_draw_default_thumbnail(S32 preview_x, S32 preview_y, S32 preview_width, S32 preview_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 img_width = 0;
    S32 img_height = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (GDI_SUCCEED != gdi_image_get_dimension_id(g_wgui_uce_cntx.default_image_id, &img_width, &img_height))
    {
        return MMI_FALSE;
    }
	
	/* drawable region larger than image */
	if ( preview_width > img_width  && preview_height > img_height )
	{
		/* align image at the center of preview rectangle */
		preview_x += ((preview_width - img_width) >> 1);
		preview_width = img_width;
		preview_y += ((preview_height - img_height) >> 1);
		preview_height = img_height;
	}
	else
	{
		S32 resized_offset_x, resized_offset_y, resized_width, resized_height;

		gdi_image_util_fit_bbox(
			preview_width,
			preview_height,
			img_width,
			img_height,
			&resized_offset_x,
			&resized_offset_y,
			&resized_width,
			&resized_height);
		preview_width = resized_width;
		preview_height = resized_height;
		preview_x += resized_offset_x;
		preview_y += resized_offset_y;
	}

    if (GDI_SUCCEED != gdi_image_draw_resized_id(
                        preview_x,
                        preview_y,
                        preview_width,
                        preview_height,
                        g_wgui_uce_cntx.default_image_id))
    {
        return MMI_FALSE;
    }

    return MMI_TRUE;

}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_thumbnail
 * DESCRIPTION
 *  draw image/video thumbnail
 * PARAMETERS
 *  draw_x         [IN]        region x
 *  draw_y         [IN]        region y
 *  draw_width     [IN]        region width
 *  draw_height    [IN]        region height
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_thumbnail(S32 draw_x, S32 draw_y, S32 draw_width, S32 draw_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL error_code = MMI_TRUE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* draw preview object */
    if (g_wgui_uce_cntx.is_image || g_wgui_uce_cntx.is_video)
    {        
        if ( g_wgui_uce_cntx.default_image_id )
        {
            error_code = wgui_cat280_draw_default_thumbnail(draw_x, draw_y, draw_width, draw_height);
        }
        else
        {
            error_code = wgui_cat280_show_object_preview(draw_x, draw_y, draw_width, draw_height);
        }

        if (error_code == MMI_FALSE)
        {
            S32 img_width, img_height;

            /* Since Draw has failed once */
            g_wgui_uce_cntx.default_image_id = WGUI_DEFAULT_PREVIEW_IMAGE_ID; 

    #if defined(__MMI_VIDEO_PLAY_SUPPORT__)
            if ((g_wgui_uce_cntx.is_video) &&
                (wgui_video_info.track == MDI_VIDEO_TRACK_A_ONLY))
            {
                g_wgui_uce_cntx.default_image_id = WGUI_DEFAULT_PREVIEW_AVIDEO_ID;
            }
    #endif /* defined(__MMI_VIDEO_PLAY_SUPPORT__) */

            /* Draw Defualt Image Owned by UCE */
            if (GDI_SUCCEED != gdi_image_get_dimension_id(g_wgui_uce_cntx.default_image_id, &img_width, &img_height))
            {
                /* Check Resources */
                ASSERT(0);
            }

            if ( draw_width > img_width  && draw_height > img_height )
            {
                /* align image at the center of preview rectangle */
                draw_x += ((draw_width - img_width) >> 1);
                draw_width = img_width;
                draw_y += ((draw_height - img_height) >> 1);
                draw_height = img_height;
            }
            else
            {
                S32 resized_offset_x, resized_offset_y, resized_width, resized_height;

                gdi_image_util_fit_bbox(
    				            draw_width,
    				            draw_height,
    				            img_width,
    				            img_height,
    				            &resized_offset_x,
    				            &resized_offset_y,
    				            &resized_width,
    				            &resized_height);
                draw_width = resized_width;
                draw_height = resized_height;
                draw_x += resized_offset_x;
                draw_y += resized_offset_y;
            }

            if (GDI_SUCCEED != gdi_image_draw_resized_id(draw_x, draw_y, draw_width, draw_height, g_wgui_uce_cntx.default_image_id))
            {
                /* Check Resources: Image ID */
                ASSERT(0);
            }    		
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_subject
 * DESCRIPTION
 *  draw subject in header area
 * PARAMETERS
 *  is_draw         [IN]        if it is legal to draw subject
 *  y_offset        [IN]        region y
 *  height          [IN]        region height
 *  clip_x1         [IN]        start x
 *  clip_y1         [IN]        start y
 *  clip_x2         [IN]        end x
 *  clip_y2         [IN]        end y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_subject(MMI_BOOL is_draw, S32 yoffset, S32 height, S32 clip_x1, S32 clip_y1, S32 clip_x2, S32 clip_y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/    
    color subject_color = *current_MMI_theme->uce_screen_subject_color;
    color frame_color;
    S32 draw_x = 0, draw_y = 0, draw_width = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (is_draw == MMI_FALSE)
    {
        return;
    }
    
    /* draw subjcet */
    if (g_wgui_uce_cntx.subject_firstline != NULL)
    {
        gdi_layer_push_clip();
        gdi_layer_set_clip(clip_x1, clip_y1, clip_x2, clip_y2);

        /* draw frame */
        if (mmi_fe_get_r2l_state())
        {
            draw_x = current_MMI_theme->scrollbar_size + CAT280_HMARGIN - 1;
        }
        else
        {
            draw_x = CAT280_HMARGIN - 1;
        }        
        draw_width = MMI_content_width - current_MMI_theme->scrollbar_size - (CAT280_HMARGIN << 1);

        draw_y = yoffset;
        
        if (wgui_cat280_get_highlight_state() == WGUI_UCE_HIGHLIGHT_SUBJECT)
        {    
            frame_color.alpha = current_MMI_theme->inputbox_selector_color->alpha;
            frame_color.r = current_MMI_theme->inputbox_selector_color->r;
            frame_color.g = current_MMI_theme->inputbox_selector_color->g;
            frame_color.b = current_MMI_theme->inputbox_selector_color->b;
            gui_draw_rectangle(draw_x, draw_y, draw_x + draw_width - 1, draw_y + height - 1, frame_color);
        }

        /* draw first line subject */
        draw_x += CAT280_HMARGIN;
        draw_y += (CAT280_VMARGIN >> 1);        
        draw_width -= (CAT280_HMARGIN << 1);

        wgui_cat280_draw_string(g_wgui_uce_cntx.subject_firstline, draw_x, draw_y, draw_width, subject_color);

        /* draw second line subject */
        draw_y += CAT280_SUBJECT_H;
        if (g_wgui_uce_cntx.subject_secondline != NULL)
        {
            wgui_cat280_draw_string(g_wgui_uce_cntx.subject_secondline, draw_x, draw_y, draw_width, subject_color);
        }
        
        gdi_layer_pop_clip();
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_object
 * DESCRIPTION
 *  draw object in editor footer area
 * PARAMETERS
 *  is_draw     [IN]        if it is legal to draw
 *  yoffset     [IN]        offset Y
 *  clip_x1     [IN]        start X
 *  clip_y1     [IN]        start Y
 *  clip_x2     [IN]        end X
 *  clip_y2     [IN]        end Y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_object(MMI_BOOL is_draw, S32 yoffset, S32 height, S32 clip_x1, S32 clip_y1, S32 clip_x2, S32 clip_y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 draw_x = 0, draw_y = 0, draw_width = 0, draw_height = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (is_draw == MMI_FALSE)
    {
        return ;
    }
    
#ifdef __WGUI_CAT280_ENHANCED_UI__
    MMI_ASSERT(g_wgui_uce_cntx.is_image || g_wgui_uce_cntx.is_video || g_wgui_uce_cntx.is_audio);
    /* No Media still trying to preview ... assert */
#else
    MMI_ASSERT(g_wgui_uce_cntx.is_image || g_wgui_uce_cntx.is_video);
    /* No Media still trying to preview ... assert */
#endif /* __WGUI_CAT280_ENHANCED_UI__ */

    gdi_layer_push_clip();
    gdi_layer_set_clip(clip_x1, clip_y1, clip_x2, clip_y2);
    
    if ((g_wgui_uce_cntx.is_image || g_wgui_uce_cntx.is_video) &&
        (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
    {
        wgui_cat280_draw_thumbnail_frame(yoffset, height, &draw_x, &draw_y, &draw_width, &draw_height, WGUI_UCE_HIGHLIGHT_THUMBNAIL);

        draw_x += CAT280_HMARGIN;
        draw_width -= CAT280_HMARGIN;
        draw_y += (CAT280_VMARGIN);       /* top gap */
        draw_height -= (CAT280_VMARGIN << 1);  /* top & bottom gap */
        
        wgui_cat280_draw_thumbnail(draw_x, draw_y, draw_width, draw_height);
        yoffset += CAT280_THUMBNAIL_FRAME_HEIGHT;
    }

#ifdef __WGUI_CAT280_ENHANCED_UI__
    if ((g_wgui_uce_cntx.is_audio)  &&
        (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
    {
        wgui_cat280_draw_thumbnail_frame(yoffset, height, &draw_x, &draw_y, &draw_width, &draw_height, WGUI_UCE_HIGHLIGHT_AUDIO);

        draw_x += CAT280_HMARGIN;
        draw_width -= CAT280_HMARGIN;
        draw_y += (CAT280_VMARGIN);       /* top gap */
        draw_height -= (CAT280_VMARGIN << 1);  /* top & bottom gap */

        wgui_cat280_draw_audio(draw_x, draw_y, draw_width, draw_height);
    }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */

    gdi_layer_pop_clip();
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_object_and_subject
 * DESCRIPTION
 *  draw object and subject in header area
 * PARAMETERS
 *  yoffset     [IN]        Offset Y
 *  clip_x1     [IN]        Start X
 *  clip_y1     [IN]        Start Y
 *  clip_x2     [IN]        End X
 *  clip_y2     [IN]        End Y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_object_and_subject(MMI_BOOL is_draw, S32 yoffset, S32 height, S32 clip_x1, S32 clip_y1, S32 clip_x2, S32 clip_y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 draw_x = 0, draw_y = 0, draw_width = 0, draw_height = 0;
    color frame_color;
    color subject_color = *current_MMI_theme->uce_screen_subject_color;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (is_draw == MMI_FALSE)
    {
        return ;
    }
#ifdef __WGUI_CAT280_ENHANCED_UI__    
    MMI_ASSERT(g_wgui_uce_cntx.is_image || g_wgui_uce_cntx.is_video || g_wgui_uce_cntx.is_audio || g_wgui_uce_cntx.subject_firstline || g_wgui_uce_cntx.subject_secondline);
    /* No Media or no subject still trying to preview ... assert */ 
#else
    MMI_ASSERT(g_wgui_uce_cntx.is_image || g_wgui_uce_cntx.is_video || g_wgui_uce_cntx.subject_firstline || g_wgui_uce_cntx.subject_secondline);
    /* No Media or no subject still trying to preview ... assert */ 
#endif /* __WGUI_CAT280_ENHANCED_UI__ */

    gdi_layer_push_clip();
    gdi_layer_set_clip(clip_x1, clip_y1, clip_x2, clip_y2);

    draw_y = yoffset;
    draw_height = height;

    /* draw subject */
    if (g_wgui_uce_cntx.subject_firstline != NULL)        
    {
        /* draw frame */
        if (mmi_fe_get_r2l_state())
        {
            draw_x = current_MMI_theme->scrollbar_size + CAT280_HMARGIN - 1;
        }
        else
        {
            draw_x = CAT280_HMARGIN - 1;
        }        
        draw_width = MMI_content_width - current_MMI_theme->scrollbar_size - (CAT280_HMARGIN << 1);
        
        if (wgui_cat280_get_highlight_state() == WGUI_UCE_HIGHLIGHT_SUBJECT)
        {    
            frame_color.alpha = current_MMI_theme->inputbox_selector_color->alpha;
            frame_color.r = current_MMI_theme->inputbox_selector_color->r;
            frame_color.g = current_MMI_theme->inputbox_selector_color->g;
            frame_color.b = current_MMI_theme->inputbox_selector_color->b;
            gui_draw_rectangle(draw_x, draw_y, draw_x + draw_width - 1, draw_y + (CAT280_SUBJECT_H << 1) + CAT280_VMARGIN - 1, frame_color);
        }

        /* draw first line subject */
        draw_y += (CAT280_VMARGIN >> 1);
        draw_height -= (CAT280_VMARGIN >> 1);

        wgui_cat280_draw_string(
                      g_wgui_uce_cntx.subject_firstline, 
                      draw_x + CAT280_HMARGIN, draw_y, draw_width - (CAT280_HMARGIN << 1), 
                      subject_color);
		
        draw_y += CAT280_SUBJECT_H;
        draw_height -= CAT280_SUBJECT_H;

        /* draw seconde line subject */
        if (g_wgui_uce_cntx.subject_secondline != NULL)
        {
            wgui_cat280_draw_string(
                          g_wgui_uce_cntx.subject_secondline, 
                          draw_x + CAT280_HMARGIN, draw_y, draw_width - (CAT280_HMARGIN << 1),
                          subject_color);
            draw_y += CAT280_SUBJECT_H;
            draw_height -= CAT280_SUBJECT_H;
        }
    }

    /* draw frame */
    wgui_cat280_draw_thumbnail_frame(draw_y, draw_height, &draw_x, &draw_y, &draw_width, &draw_height, WGUI_UCE_HIGHLIGHT_THUMBNAIL);

    /* draw thumbnail */    
    draw_y += CAT280_VMARGIN;       /* top gap */
    draw_height -= (CAT280_VMARGIN << 1);  /* top & bottom gap */
    wgui_cat280_draw_thumbnail(draw_x, draw_y, draw_width, draw_height);

    gdi_layer_pop_clip();
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_highligh_on_subject_handler
 * DESCRIPTION
 *  highlight on subject handler
 * PARAMETERS
 *  key_code   [IN]  key code
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_highligh_on_subject_handler(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_TRUE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/       
    switch (key_code)
    {
        case KEY_DOWN_ARROW:
            gdi_layer_lock_frame_buffer();
            
            if ((wgui_cat280_has_thumbnail() == MMI_TRUE) &&   /* has thumbnail */
                (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)) /* thumbnail at top */
            {
                S32 subject_height = CAT280_VMARGIN + (CAT280_SUBJECT_H << 1);
 
                wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_THUMBNAIL);
                wgui_cat280_editor_scroll_down(subject_height);
                wgui_inputs_ml_redraw();
            }
            else /* no thumbnail or thumbnail at the bottom*/
            {
                wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_EDITOR);
                wgui_cat280_ml_go_to_last_position();
            }
            
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;
 
        case KEY_UP_ARROW: 
            gdi_layer_lock_frame_buffer();

            wgui_cat280_move_to_editor_top();
            wgui_inputs_ml_redraw();

            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;

        case KEY_RIGHT_ARROW:            
        case KEY_LEFT_ARROW:
            /* callback APP to change slide */
            wgui_cat280_change_slide(key_code);        
            break;
            
        default:
            result = MMI_FALSE;
            break;
    }
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_highligh_on_thumbnail_handler
 * DESCRIPTION
 *  highlight on thumbnail handler
 * PARAMETERS
 *  key_code   [IN]  key code
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_highligh_on_thumbnail_handler(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_TRUE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    switch (key_code)
    {
        case KEY_UP_ARROW: 
            gdi_layer_lock_frame_buffer();

            if (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP) /* thumbnail at top */
            {     
                if ((g_wgui_uce_cntx.subject_secondline != NULL) || (g_wgui_uce_cntx.subject_firstline != NULL)) /* has subject */
                {
                    wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_SUBJECT);
                }                  

                wgui_cat280_move_to_editor_top();
                wgui_inputs_ml_redraw();
            }
            else if (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM) /* thumbnail at top */
            {    
                wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_EDITOR);
                wgui_cat280_ml_go_to_last_position();
            }   

            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;

        case KEY_DOWN_ARROW:
            if (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP) /* thumbnail at top */
            {
                gdi_layer_lock_frame_buffer();
                
                wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_EDITOR);
                wgui_cat280_ml_go_to_last_position();

                gdi_layer_unlock_frame_buffer();
                gdi_lcd_repaint_all();
            }
            else if (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)
            {
                gdi_layer_lock_frame_buffer();

                wgui_cat280_move_to_editor_top();
                wgui_cat280_editor_scroll_down(MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.height + ((CAT280_VMARGIN - 1) << 1));
                if (MMI_multiline_inputbox.text_offset_y < (MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.height - ((CAT280_VMARGIN - 1) << 1)))
                {
                    MMI_multiline_inputbox.text_offset_y = -(MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.height + ((CAT280_VMARGIN - 1) << 1));
                }
                wgui_inputs_ml_redraw();

                gdi_layer_unlock_frame_buffer();
                gdi_lcd_repaint_all();
            }
            break;

        case KEY_RIGHT_ARROW:            
        case KEY_LEFT_ARROW:
            /* callback APP to change slide */
            wgui_cat280_change_slide(key_code);         
            break;
                        
        default:
            result = MMI_FALSE;
            break;
    }
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_highlight_on_editor_handler
 * DESCRIPTION
 *  highlight on editor handler
 * PARAMETERS
 *  key_code   [IN]  key code
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_highlight_on_editor_handler(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_FALSE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    switch (key_code)
    {
        case KEY_UP_ARROW:       
            if (gui_multi_line_input_box_test_first_line(&MMI_multiline_inputbox))  /* cursor at first line */
            {                        
                if ((wgui_cat280_has_thumbnail() == MMI_TRUE) && /* has thumbnail */
                    (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)) /* thumbnail at top */
                {        
                    gdi_layer_lock_frame_buffer();
                        
                    wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_THUMBNAIL);
                                                
                    if ((g_wgui_uce_cntx.subject_secondline != NULL) || (g_wgui_uce_cntx.subject_firstline != NULL)) /* has subject */
                    {
                        S32 subject_height = CAT280_VMARGIN + (CAT280_SUBJECT_H << 1);
                        S32 text_offset_y = MMI_multiline_inputbox.text_offset_y;
                        if (text_offset_y < 0 && -text_offset_y > subject_height)
                        {
                            wgui_cat280_move_to_editor_top();
                            wgui_cat280_editor_scroll_down(subject_height); /* scroll down to thumbnail top */
                        }
                    }
                    else
                    {
                        wgui_cat280_move_to_editor_top();  /* move to editor top */
                    }

                    wgui_inputs_ml_disable();
                    wgui_inputs_ml_redraw();
                        
                    gdi_layer_unlock_frame_buffer();
                    gdi_lcd_repaint_all();
                    result = MMI_TRUE;
                }
                else  /* no thumbnail or thumbnail at the bottom*/
                {    
                    if ((g_wgui_uce_cntx.subject_secondline != NULL) || (g_wgui_uce_cntx.subject_firstline != NULL)) /* has subject */
                    {
                        gdi_layer_lock_frame_buffer();
                        wgui_cat280_move_to_editor_top();  /* move to editor top */
                        wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_SUBJECT);  
                        wgui_inputs_ml_disable();
                        wgui_inputs_ml_redraw();
     
                        gdi_layer_unlock_frame_buffer();
                        gdi_lcd_repaint_all();
                        result = MMI_TRUE;
                    }
                }
            }       
            break;

        case KEY_DOWN_ARROW:
            if (gui_multi_line_input_box_test_last_line(&MMI_multiline_inputbox))  /* cursor at last line */
            {
                if ((wgui_cat280_has_thumbnail() == MMI_TRUE) && /* has thumbnail */
                    (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)) /* thumbnail at bottom */
                {
                    gdi_layer_lock_frame_buffer();

                    wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_THUMBNAIL);
                    wgui_cat280_editor_scroll_down(CAT280_THUMBNAIL_FRAME_HEIGHT); 
                    if (MMI_multiline_inputbox.text_offset_y < (MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.height - ((CAT280_VMARGIN - 1) << 1)))
                    {
                        MMI_multiline_inputbox.text_offset_y = -(MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.height + ((CAT280_VMARGIN - 1) << 1));
                    }
                    wgui_inputs_ml_disable();
                    wgui_inputs_ml_redraw();

                    gdi_layer_unlock_frame_buffer();
                    gdi_lcd_repaint_all();
                    result = MMI_TRUE; 
                }
                else
                {
                    gdi_layer_lock_frame_buffer();
                    
                    wgui_cat280_move_to_editor_top();
                    wgui_cat280_editor_scroll_down(MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.footer_height);
                    wgui_inputs_ml_show();

                    gdi_layer_unlock_frame_buffer();
                    gdi_lcd_repaint_all();
                }
            }
            break;

        case KEY_RIGHT_ARROW:
            if (gui_multi_line_input_box_test_last_position(&MMI_multiline_inputbox)) /* cursor at last position */
            {
                if (g_wgui_uce_cntx.current_slide != g_wgui_uce_cntx.total_slides)
                {
                    wgui_cat280_next_button_hdlr();
                    result = MMI_TRUE; /* cursor at last position */
                }
            }
            break;
            
        case KEY_LEFT_ARROW:
            if (gui_multi_line_input_box_test_first_position(&MMI_multiline_inputbox)) /* cursor at first position */
            {
                if (g_wgui_uce_cntx.current_slide != 1)
                {
                    wgui_cat280_pre_button_hdlr();
                    result = MMI_TRUE;  /* cursor at first position */
                }
            }
            
            break;
            
        default:
            result = MMI_FALSE;
            break;
    }
    return result;
}
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */


#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_frame
 * DESCRIPTION
 *  draw wired frame of thumbnail
 * PARAMETERS
 *  draw_x         [IN]    frame x
 *  draw_y         [IN]    frame y
 *  draw_width     [IN]    frame width
 *  draw_height    [IN]    frame height
 *  state          [IN]    highlight item
 * RETURNS
 *  MMI_BOOL       If return true, current item is highlighted.
 *****************************************************************************/
static MMI_BOOL wgui_cat280_draw_frame(
    S32 draw_x, 
    S32 draw_y, 
    S32 draw_width, 
    S32 draw_height,
    wgui_uce_highlight_state_enum state)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    color frame_color = *current_MMI_theme->inputbox_selector_color;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (wgui_cat280_get_highlight_state() == state)
    {
    #ifdef __WGUI_CAT280_SUPPORT_MMS__
        if ((state == WGUI_UCE_THUMBNAIL) || (state == WGUI_UCE_AUDIO))
        { 
            gui_draw_rectangle(draw_x, draw_y, draw_x + draw_width, draw_y + draw_height, frame_color);
        }
    #endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        return MMI_TRUE;
    }
    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_recipients
 * DESCRIPTION
 *  draw the inline single-line editor
 * PARAMETERS
 *  label        [IN]        Single-line editors label
 *  sls_id       [IN]        Single-line editors ID
 *  draw_x       [IN]        Start X
 *  draw_y       [IN]        Start Y
 *  draw_width   [IN]        Width
 *  draw_height  [IN]        Height
 *  clip_y1      [IN]        Clip of statt y
 *  clip_y2      [IN]        Clip of end y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_recipients(
    wgui_uce_recipients_label_struct *label,
    wgui_uce_region_id_enum sls_id,
    S32 draw_x, 
    S32 draw_y, 
    S32 draw_width, 
    S32 draw_height, 
    S32 clip_y1, 
    S32 clip_y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 label_x, label_y, label_w, label_h;
    S32 string_w, string_h;
    S32 i = 0;
    S32 recipients_num;
    S32 draw_counter = 0;
    UI_string_type temp_string;
    color string_color = *current_MMI_theme->inputbox_normal_text_color;
    stFontAttribute *f = &UI_DEFAULT_FONT;
    MMI_BOOL is_highlighted;
    PU8 label_image;
    GDI_HANDLE act_layer = GDI_NULL_HANDLE;
    
    //color text_col = gui_color(255, 255, 255);
    color text_col = *current_MMI_theme->editor_recipient_button_text_color;
    U8 str[10];
    S32 str_w = 0, str_h = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_wgui_uce_cntx.button_down_region == sls_id)
    {
        ASSERT(label->label_pressed_image != NULL);
        label_image = label->label_pressed_image;
    }
    else
    {
        ASSERT(label->label_normal_image != NULL);
        label_image = label->label_normal_image;
    }
    
    recipients_num = wgui_cat280_get_recipients_num(sls_id);

    if (((draw_y + CAT280_INLINE_SL_HEIGHT * recipients_num + (CAT280_VMARGIN >> 1)) < clip_y1) ||
        (draw_y > clip_y2))
    {
        /* for move the cursor position, so we cannot return */
        //return;
    }

    
    /* draw highlight frame */
    is_highlighted = wgui_cat280_draw_frame(draw_x, draw_y, draw_width, (CAT280_INLINE_SL_HEIGHT * recipients_num), (wgui_uce_highlight_state_enum)sls_id);

    /* draw label image */
    gui_measure_image(label_image, &label_w ,&label_h);
    label_x = draw_x + ((g_wgui_uce_cntx.max_label_width - label_w) >> 1);
    label_y = draw_y + ((CAT280_INLINE_SL_HEIGHT - label_h) >> 1) + 1;

    gdi_layer_get_active(&act_layer);
    if (act_layer != GDI_NULL_HANDLE)
    {
        gdi_push_and_set_alpha_blending_source_layer(act_layer);
    }
    gdi_image_draw(label_x, label_y, label_image);

#ifdef __MMI_FTE_SUPPORT__
    /* draw label text */
    if (sls_id == WGUI_UCE_TO_RECIPIENTS)
    {
        mmi_asc_to_ucs2((PS8)str, (PS8) "TO");
    }
    else if (sls_id == WGUI_UCE_CC_RECIPIENTS)
    {
        mmi_asc_to_ucs2((PS8)str, (PS8) "CC");
    }
    else if (sls_id == WGUI_UCE_BCC_RECIPIENTS)
    {
        mmi_asc_to_ucs2((PS8)str, (PS8) "BCC");
    }
    else
    {
        MMI_ASSERT(0);
    }
    gui_set_font(f);
    gui_measure_string((UI_string_type)str, &str_w, &str_h);
    if (mmi_fe_get_r2l_state())
    {
        gui_move_text_cursor(label_x + ((label_w - str_w) >> 1) + str_w, label_y + ((label_h - str_h) >> 1) + 1);
    }
    else
    {
        gui_move_text_cursor(label_x + ((label_w - str_w) >> 1), label_y + ((label_h - str_h) >> 1) + 1);
    }
    gui_set_text_color(text_col);
    gui_print_text((UI_string_type) str);
#endif /* __MMI_FTE_SUPPORT__ */

    if (act_layer != GDI_NULL_HANDLE)
    {
        gdi_pop_and_restore_alpha_blending_source_layer();
    }

    /* for pen event */
    g_wgui_uce_cntx.label_x = label_x;
    g_wgui_uce_cntx.label_w = label_w;
    g_wgui_uce_cntx.label_h = label_h;
        
    /* draw recipients */
    for (i = 0; i < g_wgui_uce_cntx.max_recipients_num; i++)
    {
        if (g_wgui_uce_cntx.recipient[i].is_valid && 
           (g_wgui_uce_cntx.recipient[i].region_id == sls_id))
        {
            temp_string = (UI_string_type) g_wgui_uce_cntx.recipient[i].input_buf;
            if (temp_string != NULL)
            {
                gui_set_font(f);
                gui_measure_string(temp_string, &string_w ,&string_h);

                if (string_h == 0)
                {
                    string_h = WGUI_CAT280_INLINE_SL_TEXT_DEFAULT_HEIGHT;
                }

                /* active and draw the highlighted singleline editor */
                if ((is_highlighted == MMI_TRUE) && (i == g_wgui_uce_cntx.highlight_index))
                {
                    wgui_cat280_change_recipient(
                        draw_x + g_wgui_uce_cntx.max_label_width, 
                        draw_y, 
                        draw_width - g_wgui_uce_cntx.max_label_width, 
                        CAT280_INLINE_SL_HEIGHT);
                }
                else
                {
                    /* show string */
                    wgui_cat280_draw_string(
                        temp_string,
                        draw_x + g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN,
                        draw_y + ((CAT280_INLINE_SL_HEIGHT - string_h) >> 1),
                        draw_width - g_wgui_uce_cntx.max_label_width - CAT280_HMARGIN,
                        string_color);
                }
            }

            /* draw the single-line editor base line */
            if ((is_highlighted == MMI_FALSE) || (i != g_wgui_uce_cntx.highlight_index))
            {
                /* show the editor base line */
                gui_draw_horizontal_line(
                    draw_x + g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN - 1,
                    UI_device_width - (CAT280_HMARGIN << 1),
                    draw_y + ((CAT280_INLINE_SL_HEIGHT - string_h) >> 1) + string_h + 1,
                    *(current_MMI_theme->inputbox_base_line_color));
            }

            /* move draw cursor */
            draw_y += CAT280_INLINE_SL_HEIGHT;

            /* just for check */
            draw_counter++;
        }  
    }

    /* all the recipients have been drew */
    ASSERT(draw_counter == recipients_num);
}


#ifdef __WGUI_CAT280_SUPPORT_MMS__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_editable_subject
 * DESCRIPTION
 *  draw the editable subject
 * PARAMETERS
 *  subject      [IN]        A set of single-line editors
 *  sls_id       [IN]        Single-line editors ID
 *  draw_x       [IN]        Start X
 *  draw_y       [IN]        Start Y
 *  draw_width   [IN]        Width
 *  draw_height  [IN]        Height
 *  clip_y1      [IN]        Clip of statt y
 *  clip_y2      [IN]        Clip of end y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_editable_subject(
    wgui_uce_subject_struct* subject, 
    wgui_uce_highlight_state_enum sls_id,
    S32 draw_x, 
    S32 draw_y, 
    S32 draw_width, 
    S32 draw_height, 
    S32 clip_y1, 
    S32 clip_y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 label_x, label_y, label_w, label_h;
    S32 string_w, string_h;
    color string_color = *current_MMI_theme->inputbox_normal_text_color;
    stFontAttribute *f = &UI_DEFAULT_FONT;
    MMI_BOOL is_highlighted;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ASSERT((subject != NULL) && (subject->input_buf != NULL));

    if (((draw_y + CAT280_INLINE_SL_HEIGHT + (CAT280_VMARGIN >> 1)) < clip_y1) ||
        (draw_y > clip_y2))
    {
        //return;
    }
    
    /* draw highlight frame */
    is_highlighted = wgui_cat280_draw_frame(draw_x, draw_y, draw_width, CAT280_INLINE_SL_HEIGHT, sls_id);

    /* active and draw the highlighted singleline editor */
    if (is_highlighted == MMI_TRUE)
    {
        wgui_cat280_change_recipient(
            draw_x + g_wgui_uce_cntx.max_label_width, 
            draw_y - 1, 
            draw_width - g_wgui_uce_cntx.max_label_width, 
            CAT280_INLINE_SL_HEIGHT);
    }

    /* draw label string */
    gui_set_font(f);
    gui_measure_string(subject->label_string, &label_w ,&label_h);
    label_x = draw_x + ((g_wgui_uce_cntx.max_label_width - label_w) >> 1);
    label_y = draw_y + ((CAT280_INLINE_SL_HEIGHT - label_h) >> 1);

    if (mmi_fe_get_r2l_state())
    {
        gui_move_text_cursor(label_x + label_w, label_y);
    }
    else
    {
        gui_move_text_cursor(label_x, label_y);
    }
    gui_set_text_color(string_color);
    gui_print_text(subject->label_string);
    
    /* draw subject */
    if (is_highlighted == MMI_FALSE)
    {
        if (subject->input_buf != NULL)
        {
            mmi_fe_get_string_info_param_struct subject_text1;
            mmi_fe_get_string_info_param_struct subject_text2;
            S32 subject_len1 = 0;
            S32 subject_len2 = 0;
            S32 baseline_gap = 0;

            memset(&subject_text1, 0, sizeof(mmi_fe_get_string_info_param_struct));
            subject_len1 = mmi_ucs2strlen((const char*)subject->label_string);
            subject_text1.String = (UI_buffer_type)subject->label_string;
            subject_text1.n = subject_len1;
            subject_text1.enableTruncated = MMI_FALSE;
            //subject_text1.w = label_w;
            mmi_fe_get_string_widthheight(&subject_text1);

            memset(&subject_text2, 0, sizeof(mmi_fe_get_string_info_param_struct));
            subject_len2 = mmi_ucs2strlen((const char*)subject->input_buf);
            subject_text2.String = subject->input_buf;
            subject_text2.n = subject_len2;
            subject_text2.enableTruncated = MMI_FALSE;
            //subject_text2.w = draw_width - g_wgui_uce_cntx.max_label_width - CAT280_HMARGIN;
            mmi_fe_get_string_widthheight(&subject_text2);

            if ((subject->input_buf[0] != 0) && (subject->input_buf[1] != 0))
            {
                baseline_gap = subject_text2.baseline - subject_text1.baseline;
            }

            gui_set_font(f);
            gui_measure_string((UI_string_type)subject->input_buf, &string_w ,&string_h);

            if (string_h < label_h)
            {
                string_h = label_h;
            }

            if (string_h == 0)
            {
                string_h = WGUI_CAT280_INLINE_SL_TEXT_DEFAULT_HEIGHT;
            }

            wgui_cat280_draw_string(
                (UI_string_type)subject->input_buf,
                draw_x + g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN,
                draw_y + ((CAT280_INLINE_SL_HEIGHT - string_h) >> 1) - baseline_gap,
                draw_width - g_wgui_uce_cntx.max_label_width - CAT280_HMARGIN,
                string_color);

            gui_draw_horizontal_line(
                draw_x + g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN - 1,
                UI_device_width - (CAT280_HMARGIN << 1),
                draw_y + ((CAT280_INLINE_SL_HEIGHT - string_h) >> 1) + string_h + 1 - baseline_gap,
                *(current_MMI_theme->inputbox_base_line_color));
        }
        else
        {
            gui_draw_horizontal_line(
                draw_x + g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN - 1,
                UI_device_width - (CAT280_HMARGIN << 1),
                draw_y + ((CAT280_INLINE_SL_HEIGHT - string_h) >> 1) + string_h + 1,
                *(current_MMI_theme->inputbox_base_line_color));
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_thumbnail_ext
 * DESCRIPTION
 *  draw the thumbnail.
 * PARAMETERS
 *  sls_id       [IN]        Single-line editors ID
 *  draw_x       [IN]        Start X
 *  draw_y       [IN]        Start Y
 *  draw_width   [IN]        Width
 *  draw_height  [IN]        Height
 *  clip_y1      [IN]        Clip of statt y
 *  clip_y2      [IN]        Clip of end y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_thumbnail_ext(
    wgui_uce_highlight_state_enum sls_id,
    S32 draw_x, 
    S32 draw_y, 
    S32 draw_width, 
    S32 draw_height, 
    S32 clip_y1, 
    S32 clip_y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
   // MMI_BOOL is_highlighted;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (((draw_y + CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1)) < clip_y1) ||
        (draw_y > clip_y2))
    {
        return;
    }
    
    /* draw highlight frame */
    //is_highlighted = wgui_cat280_draw_frame(draw_x, draw_y, draw_width, CAT280_THUMBNAIL_FRAME_HEIGHT, sls_id);
    wgui_cat280_draw_frame(draw_x, draw_y, draw_width, CAT280_THUMBNAIL_FRAME_HEIGHT, sls_id);
    draw_x += CAT280_HMARGIN;
    draw_width -= CAT280_HMARGIN;
    draw_y += (CAT280_VMARGIN);       /* top gap */

#ifdef __WGUI_CAT280_ENHANCED_UI__
    if (sls_id == WGUI_UCE_THUMBNAIL)
    {
        wgui_cat280_draw_thumbnail(draw_x, draw_y, draw_width, CAT280_THUMBNAIL_FRAME_HEIGHT - (CAT280_VMARGIN << 1));
    }
    else if (sls_id == WGUI_UCE_AUDIO)
    {
        wgui_cat280_draw_audio(draw_x, draw_y, draw_width, CAT280_THUMBNAIL_FRAME_HEIGHT - (CAT280_VMARGIN << 1));
    }
#else
    wgui_cat280_draw_thumbnail(draw_x, draw_y, draw_width, CAT280_THUMBNAIL_FRAME_HEIGHT - (CAT280_VMARGIN << 1));
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
}
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_draw_object_and_subject_and_recipients
 * DESCRIPTION
 *  draw object and subject and recipients in header area
 * PARAMETERS
 *  yoffset     [IN]        Offset Y
 *  clip_x1     [IN]        Start X
 *  clip_y1     [IN]        Start Y
 *  clip_x2     [IN]        End X
 *  clip_y2     [IN]        End Y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_draw_object_and_subject_and_recipients(MMI_BOOL is_draw, S32 yoffset, S32 height, S32 clip_x1, S32 clip_y1, S32 clip_x2, S32 clip_y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 draw_x = 0, draw_y = 0, draw_width = 0, draw_height = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* No Media or no subject or no recipient still trying to preview ... assert */ 
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    MMI_ASSERT(g_wgui_uce_cntx.is_image || g_wgui_uce_cntx.is_video || g_wgui_uce_cntx.is_audio || g_wgui_uce_cntx.inline_recipients);
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
    MMI_ASSERT(g_wgui_uce_cntx.inline_recipients);
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    gdi_layer_push_clip();
    gdi_layer_set_clip(clip_x1, clip_y1, clip_x2, clip_y2);

    draw_x = clip_x1 + ((CAT280_HMARGIN >> 1));
    draw_y = yoffset + (CAT280_VMARGIN >> 1);
    draw_width = clip_x2 - draw_x - (CAT280_HMARGIN >> 1);
    draw_height = height;

    /* draw recipients */
    if (g_wgui_uce_cntx.to_recipients_num != 0)
    {
        wgui_cat280_draw_recipients(
            &g_wgui_uce_cntx.to_recipients,
            WGUI_UCE_TO_RECIPIENTS, 
            draw_x, 
            draw_y, 
            draw_width, 
            draw_height, 
            clip_y1, 
            clip_y2);
        draw_y += (g_wgui_uce_cntx.to_recipients_num * CAT280_INLINE_SL_HEIGHT + (CAT280_VMARGIN >> 1));
        draw_height -= (g_wgui_uce_cntx.to_recipients_num * CAT280_INLINE_SL_HEIGHT + (CAT280_VMARGIN >> 1));
    }
    
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.cc_recipients_num != 0)
    {
        wgui_cat280_draw_recipients(
            &g_wgui_uce_cntx.cc_recipients,
            WGUI_UCE_CC_RECIPIENTS, 
            draw_x, 
            draw_y, 
            draw_width, 
            draw_height, 
            clip_y1, 
            clip_y2);
        draw_y += (g_wgui_uce_cntx.cc_recipients_num * CAT280_INLINE_SL_HEIGHT + (CAT280_VMARGIN >> 1));
        draw_height -= (g_wgui_uce_cntx.cc_recipients_num * CAT280_INLINE_SL_HEIGHT + (CAT280_VMARGIN >> 1));
    }

    if (g_wgui_uce_cntx.bcc_recipients_num != 0)
    {
        wgui_cat280_draw_recipients(
            &g_wgui_uce_cntx.bcc_recipients,
            WGUI_UCE_BCC_RECIPIENTS, 
            draw_x, 
            draw_y, 
            draw_width, 
            draw_height, 
            clip_y1, 
            clip_y2);
        draw_y += (g_wgui_uce_cntx.bcc_recipients_num * CAT280_INLINE_SL_HEIGHT + (CAT280_VMARGIN >> 1));
        draw_height -= (g_wgui_uce_cntx.bcc_recipients_num * CAT280_INLINE_SL_HEIGHT + (CAT280_VMARGIN >> 1));
    }

    /* draw subject */
    if (g_wgui_uce_cntx.has_editable_subject == MMI_TRUE)
    {
        wgui_cat280_draw_editable_subject(
            &g_wgui_uce_cntx.subject, 
            (wgui_uce_highlight_state_enum)WGUI_UCE_SUBJECT, 
            draw_x, 
            draw_y, 
            draw_width, 
            draw_height, 
            clip_y1, 
            clip_y2);
        draw_y += (CAT280_INLINE_SL_HEIGHT + (CAT280_VMARGIN >> 1));
        draw_height -= (CAT280_INLINE_SL_HEIGHT + (CAT280_VMARGIN >> 1));
    }

    /* draw thumbnail */
    if (g_wgui_uce_cntx.is_image || g_wgui_uce_cntx.is_video)
    {
        if (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)
        {
            wgui_cat280_draw_thumbnail_ext(
                    (wgui_uce_highlight_state_enum)WGUI_UCE_THUMBNAIL, 
                    draw_x, 
                    draw_y, 
                    draw_width, 
                    draw_height, 
                    clip_y1, 
                    clip_y2);
            draw_y += (CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1));
            draw_height -= (CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1));
        }
    }

#ifdef __WGUI_CAT280_ENHANCED_UI__
    /* draw audio image */
    if (g_wgui_uce_cntx.is_audio)
    {
        if (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)
        {
            wgui_cat280_draw_thumbnail_ext(
                    (wgui_uce_highlight_state_enum)WGUI_UCE_AUDIO, 
                    draw_x, 
                    draw_y, 
                    draw_width, 
                    draw_height, 
                    clip_y1, 
                    clip_y2);
            draw_y += (CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1));
            draw_height -= (CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1));
        }
    }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    gdi_layer_pop_clip();
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_key_proc
 * DESCRIPTION
 *  Create a new recipient editor before IME handler.
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static mmi_ret wgui_cat280_key_proc(mmi_event_struct *evt)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_frm_key_evt_struct *key_evt = (mmi_frm_key_evt_struct *)evt;
    U8 key_code = key_evt->key_code;
    S32 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((key_evt->evt_id == EVT_ID_PRE_KEY) && (key_evt->key_type == KEY_EVENT_DOWN) &&
        //(!(MMI_singleline_inputbox.flags & UI_SINGLE_LINE_INPUT_BOX_WORD_HIGHLIGHT)) &&
        (!(MMI_singleline_inputbox.flags & UI_SINGLE_LINE_INPUT_BOX_AUTO_CLEAR_HIGHLIGHT_MODE)))
    {
        if (mmi_imc_key_is_current_symbol_key(key_code))
        {
       #ifdef __WGUI_CAT280_SUPPORT_MMS__
            if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS) ||
                (g_wgui_uce_cntx.highligh_state == WGUI_UCE_CC_RECIPIENTS) ||
                (g_wgui_uce_cntx.highligh_state == WGUI_UCE_BCC_RECIPIENTS))
       #else /* __WGUI_CAT280_SUPPORT_MMS__ */
            if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS)
       #endif /* __WGUI_CAT280_SUPPORT_MMS__ */
            {
                if ((MMI_singleline_inputbox.ext_flags & GUI_SINGLE_LINE_INPUT_BOX_RECIPIENT_MODE) &&
                    (MMI_singleline_inputbox.current_text_p != (MMI_singleline_inputbox.last_position_p - ENCODING_LENGTH)))
                {
                    wgui_inputs_sl_move_cursor(WGUI_INPUTS_CURSOR_POS_END);
                }

                for (i = (MMI_singleline_inputbox.current_text_p - (MMI_singleline_inputbox.text)); i >= ENCODING_LENGTH; i -= ENCODING_LENGTH)   
                {
                    i -= ENCODING_LENGTH;
                    /* if there is a ";" */
                    if (((MMI_singleline_inputbox.text[i] == 0x3b) && (MMI_singleline_inputbox.text[i + 1] == 0)) ||
                        ((MMI_singleline_inputbox.text[i] == 0x1b) && (MMI_singleline_inputbox.text[i + 1] == 0xff)))
                    {
                        gdi_layer_lock_frame_buffer();

                        wgui_cat280_insert_new_recipient(
                            wgui_cat280_get_highlight_state(),
                            (g_wgui_uce_cntx.highlight_index + 1), 
                            (UI_string_type)&MMI_singleline_inputbox.text[i + 2], 
                            WGUI_UCE_DEFAULT_FLAGS, 
                            MMI_TRUE,
                            (-1));

                        set_right_softkey_label((UI_string_type) get_string(STR_GLOBAL_CLEAR));
                        set_right_softkey_icon(NULL);
                        redraw_right_softkey();

                        gdi_layer_unlock_frame_buffer();

                        break;
                    }
                }
            }
        #ifdef __WGUI_CAT280_SUPPORT_MMS__
            else if ((g_wgui_uce_cntx.highligh_state != WGUI_UCE_EDITOR) && (g_wgui_uce_cntx.highligh_state != WGUI_UCE_SUBJECT))
        #else /* __WGUI_CAT280_SUPPORT_MMS__ */
            else if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_EDITOR)
        #endif /* __WGUI_CAT280_SUPPORT_MMS__ */
            {
                gdi_layer_lock_frame_buffer();
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_EDITOR, -1);
                wgui_cat280_ml_go_to_last_position();
                gdi_layer_unlock_frame_buffer();
            }
        }
    }
    return MMI_RET_OK;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_highlight_on_to_key_hdlr
 * DESCRIPTION
 *  highlight on "to" handler
 * PARAMETERS
 *  key_code   [IN]  key code
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_highlight_on_to_key_hdlr(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_TRUE;
    S32 highlight_index;
    S32 old_text_offset_y;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/       
    switch (key_code)
    {
        case KEY_DOWN_ARROW:
            gdi_layer_lock_frame_buffer();

            if (wgui_cat280_get_highlight_buffer_index() == wgui_cat280_get_last_recipient_index(WGUI_UCE_TO_RECIPIENTS))
            {
#ifdef __WGUI_CAT280_SUPPORT_MMS__
                if (wgui_cat280_get_recipients_num(WGUI_UCE_CC_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_CC_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_CC_RECIPIENTS, highlight_index);
                }
                else if (wgui_cat280_get_recipients_num(WGUI_UCE_BCC_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_BCC_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_BCC_RECIPIENTS, highlight_index);
                }
                else if (g_wgui_uce_cntx.has_editable_subject)
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_SUBJECT, -1);
                }
                else if ((wgui_cat280_has_thumbnail() == MMI_TRUE) &&
                        (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_THUMBNAIL, -1);
                }
#ifdef __WGUI_CAT280_ENHANCED_UI__
                else if ((g_wgui_uce_cntx.is_audio== MMI_TRUE) &&
                        (g_wgui_uce_cntx.audio_layout== WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_AUDIO, -1);
                }
#endif
                else
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_EDITOR, -1);
                }
            }
            else
            {
                highlight_index = wgui_cat280_get_next_recipient_index(WGUI_UCE_TO_RECIPIENTS);
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_TO_RECIPIENTS, highlight_index);
            }

            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();

            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;
 
        case KEY_UP_ARROW: 
            gdi_layer_lock_frame_buffer();

            if (wgui_cat280_get_first_recipient_index(WGUI_UCE_TO_RECIPIENTS) != g_wgui_uce_cntx.highlight_index)
            {
                highlight_index = wgui_cat280_get_previous_recipient_index(WGUI_UCE_TO_RECIPIENTS);
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_TO_RECIPIENTS, highlight_index);
            }

            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;

        case KEY_RIGHT_ARROW:
            old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
            wgui_cat280_adjust_editor_scroll_bar();
            if (MMI_multiline_inputbox.text_offset_y != old_text_offset_y)
            {
                wgui_inputs_ml_redraw();
            }

            wgui_inputs_sl_next_character();
            break;
            
        case KEY_LEFT_ARROW:
            old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
            wgui_cat280_adjust_editor_scroll_bar();
            if (MMI_multiline_inputbox.text_offset_y != old_text_offset_y)
            {
                wgui_inputs_ml_redraw();
            }

            wgui_inputs_sl_previous_character(); 
            break;
            
        default:
            result = MMI_FALSE;
            break;
    }
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_highlight_on_editor_key_hdlr
 * DESCRIPTION
 *  highlight on "subject" handler
 * PARAMETERS
 *  key_code   [IN]  key code
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_highlight_on_editor_key_hdlr(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_FALSE;
    S32 highlight_index;
    S32 offset;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/    
    switch (key_code)
    {
        case KEY_UP_ARROW:       
            if (gui_multi_line_input_box_test_first_line(&MMI_multiline_inputbox))  /* cursor at first line */
            {          
                gdi_layer_lock_frame_buffer();
#ifdef __WGUI_CAT280_SUPPORT_MMS__
#ifdef __WGUI_CAT280_ENHANCED_UI__
                if ((g_wgui_uce_cntx.is_audio== MMI_TRUE) &&
                        (g_wgui_uce_cntx.audio_layout== WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_AUDIO, -1);
                    offset = wgui_inputs_ml_is_area_visible(
                                g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN - 1,
                                MMI_multiline_inputbox.header_height - CAT280_THUMBNAIL_FRAME_HEIGHT,
                                MMI_content_width - g_wgui_uce_cntx.max_label_width - (CAT280_HMARGIN << 1),
                                CAT280_THUMBNAIL_FRAME_HEIGHT,
                                (CAT280_VMARGIN >> 1));

                    wgui_cat280_editor_scroll_down(offset); 
                    result = MMI_TRUE;
                }
                else
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
                if ((wgui_cat280_has_thumbnail() == MMI_TRUE) && /* has thumbnail */
                    (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)) /* thumbnail at top */
                {        
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_THUMBNAIL, -1);
                    result = MMI_TRUE;
                }
                else if (g_wgui_uce_cntx.has_editable_subject)
                {    
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_SUBJECT, - 1);
                    result = MMI_TRUE;
                }
                else if (wgui_cat280_get_recipients_num(WGUI_UCE_BCC_RECIPIENTS) != 0)
                {    
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_BCC_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_BCC_RECIPIENTS, highlight_index);
                    result = MMI_TRUE;
                }
                else if (wgui_cat280_get_recipients_num(WGUI_UCE_CC_RECIPIENTS) != 0)
                {    
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_CC_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_CC_RECIPIENTS, highlight_index);
                    result = MMI_TRUE;
                }
                else 
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
                if (wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS) != 0)
                {    
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_TO_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_TO_RECIPIENTS, highlight_index);
                    result = MMI_TRUE;
                }
                
                wgui_cat280_adjust_editor_scroll_bar();
                wgui_inputs_ml_disable();
                wgui_inputs_ml_redraw();
                
                gdi_layer_unlock_frame_buffer();
                gdi_lcd_repaint_all();
            }       
            break;

#ifdef __WGUI_CAT280_SUPPORT_MMS__
        case KEY_DOWN_ARROW:
            if (gui_multi_line_input_box_test_last_line(&MMI_multiline_inputbox))  /* cursor at last line */
            {
                if ((wgui_cat280_has_thumbnail() == MMI_TRUE) && /* has thumbnail */
                    (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)) /* thumbnail at bottom */
                {
                    gdi_layer_lock_frame_buffer();

                    wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_THUMBNAIL);
                    wgui_cat280_adjust_editor_scroll_bar();
                    wgui_inputs_ml_disable();
                    wgui_inputs_ml_redraw();

                    gdi_layer_unlock_frame_buffer();
                    gdi_lcd_repaint_all();
                    result = MMI_TRUE; 
                }
#ifdef __WGUI_CAT280_ENHANCED_UI__
                else if ((g_wgui_uce_cntx.is_audio== MMI_TRUE) &&
                        (g_wgui_uce_cntx.audio_layout== WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
                {
                    gdi_layer_lock_frame_buffer();

                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_AUDIO, -1);
                    wgui_cat280_adjust_editor_scroll_bar();
                    wgui_inputs_ml_disable();
                    wgui_inputs_ml_redraw();

                    gdi_layer_unlock_frame_buffer();
                    gdi_lcd_repaint_all();
                    result = MMI_TRUE; 
                }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
            }
            break;

        case KEY_RIGHT_ARROW:
            if (gui_multi_line_input_box_test_last_position(&MMI_multiline_inputbox)) /* cursor at last position */
            {
                if (g_wgui_uce_cntx.current_slide != g_wgui_uce_cntx.total_slides)
                {
                    wgui_cat280_next_button_hdlr();
                    result = MMI_TRUE; /* cursor at last position */
                }
            }
            break;
            
        case KEY_LEFT_ARROW:
            if (gui_multi_line_input_box_test_first_position(&MMI_multiline_inputbox)) /* cursor at first position */
            {
                if (g_wgui_uce_cntx.current_slide != 1)
                {
                    wgui_cat280_pre_button_hdlr();
                    result = MMI_TRUE;  /* cursor at first position */
                }
            }
            break;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

        default:
            result = MMI_FALSE;
            break;
    }
    return result;

}


#ifdef __WGUI_CAT280_SUPPORT_MMS__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_highlight_on_cc_key_hdlr
 * DESCRIPTION
 *  highlight on "cc" handler
 * PARAMETERS
 *  key_code   [IN]  key code
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_highlight_on_cc_key_hdlr(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_TRUE;
    S32 highlight_index;
    S32 old_text_offset_y;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/       
    switch (key_code)
    {
        case KEY_DOWN_ARROW:
            gdi_layer_lock_frame_buffer();

            if (wgui_cat280_get_highlight_buffer_index() == wgui_cat280_get_last_recipient_index(WGUI_UCE_CC_RECIPIENTS))
            {
                if (wgui_cat280_get_recipients_num(WGUI_UCE_BCC_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_BCC_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_BCC_RECIPIENTS, highlight_index);
                }
                else if (g_wgui_uce_cntx.has_editable_subject)
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_SUBJECT, -1);
                }
                else if ((wgui_cat280_has_thumbnail() == MMI_TRUE) &&
                        (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_THUMBNAIL, -1);
                }
#ifdef __WGUI_CAT280_ENHANCED_UI__
                else if ((g_wgui_uce_cntx.is_audio== MMI_TRUE) &&
                        (g_wgui_uce_cntx.audio_layout== WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_AUDIO, -1);
                }
#endif
                else
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_EDITOR, -1);
                    wgui_cat280_ml_go_to_last_position();
                }
            }
            else
            {
                highlight_index = wgui_cat280_get_next_recipient_index(WGUI_UCE_CC_RECIPIENTS);
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_CC_RECIPIENTS, highlight_index);
            }
            
            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;
 
        case KEY_UP_ARROW: 
            gdi_layer_lock_frame_buffer();

            if (wgui_cat280_get_first_recipient_index(WGUI_UCE_CC_RECIPIENTS) == g_wgui_uce_cntx.highlight_index)
            {
                if (wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_TO_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_TO_RECIPIENTS, highlight_index);
                }
                else
                {
                    wgui_cat280_move_to_editor_top();
                }
            }
            else
            {
                highlight_index = wgui_cat280_get_previous_recipient_index(WGUI_UCE_CC_RECIPIENTS);
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_CC_RECIPIENTS, highlight_index);
            }

            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;

        case KEY_RIGHT_ARROW:
            old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
            wgui_cat280_adjust_editor_scroll_bar();
            if (MMI_multiline_inputbox.text_offset_y != old_text_offset_y)
            {
                wgui_inputs_ml_redraw();
            }

            wgui_inputs_sl_next_character();
            break;
            
        case KEY_LEFT_ARROW:
            old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
            wgui_cat280_adjust_editor_scroll_bar();
            if (MMI_multiline_inputbox.text_offset_y != old_text_offset_y)
            {
                wgui_inputs_ml_redraw();
            }

            wgui_inputs_sl_previous_character(); 
            break;
            
        default:
            result = MMI_FALSE;
            break;
    }
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_highlight_on_bcc_key_hdlr
 * DESCRIPTION
 *  highlight on "bcc" handler
 * PARAMETERS
 *  key_code   [IN]  key code
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_highlight_on_bcc_key_hdlr(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_TRUE;
    S32 highlight_index;
    S32 old_text_offset_y;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/       
    switch (key_code)
    {
        case KEY_DOWN_ARROW:
            gdi_layer_lock_frame_buffer();

            if (wgui_cat280_get_highlight_buffer_index() == wgui_cat280_get_last_recipient_index(WGUI_UCE_BCC_RECIPIENTS))
            {
                if (g_wgui_uce_cntx.has_editable_subject)
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_SUBJECT, -1);
                }
                else if ((wgui_cat280_has_thumbnail() == MMI_TRUE) &&
                        (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_THUMBNAIL, -1);
                }
#ifdef __WGUI_CAT280_ENHANCED_UI__
                else if ((g_wgui_uce_cntx.is_audio== MMI_TRUE) &&
                        (g_wgui_uce_cntx.audio_layout== WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_AUDIO, -1);
                }
#endif
                else
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_EDITOR, -1);
                }
            }
            else
            {
                highlight_index = wgui_cat280_get_next_recipient_index(WGUI_UCE_BCC_RECIPIENTS);
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_BCC_RECIPIENTS, highlight_index);
            }
            
            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;
 
        case KEY_UP_ARROW: 
            gdi_layer_lock_frame_buffer();

            if (wgui_cat280_get_first_recipient_index(WGUI_UCE_BCC_RECIPIENTS) == g_wgui_uce_cntx.highlight_index)
            {
                if (wgui_cat280_get_recipients_num(WGUI_UCE_CC_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_CC_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_CC_RECIPIENTS, highlight_index);
                }
                else if (wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_TO_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_TO_RECIPIENTS, highlight_index);
                }
                else
                {
                    wgui_cat280_move_to_editor_top();
                }
            }
            else
            {
                highlight_index = wgui_cat280_get_previous_recipient_index(WGUI_UCE_BCC_RECIPIENTS);
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_BCC_RECIPIENTS, highlight_index);
            }
            
            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;

        case KEY_RIGHT_ARROW:
            old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
            wgui_cat280_adjust_editor_scroll_bar();
            if (MMI_multiline_inputbox.text_offset_y != old_text_offset_y)
            {
                wgui_inputs_ml_redraw();
            }

            wgui_inputs_sl_next_character();
            break;
            
        case KEY_LEFT_ARROW:
            old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
            wgui_cat280_adjust_editor_scroll_bar();
            if (MMI_multiline_inputbox.text_offset_y != old_text_offset_y)
            {
                wgui_inputs_ml_redraw();
            }

            wgui_inputs_sl_previous_character(); 
            break;
            
        default:
            result = MMI_FALSE;
            break;
    }
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_highlight_on_subject_key_hdlr
 * DESCRIPTION
 *  highlight on "subject" handler
 * PARAMETERS
 *  key_code   [IN]  key code
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_highlight_on_subject_key_hdlr(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_TRUE;
    S32 highlight_index;
    S32 old_text_offset_y;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/       
    switch (key_code)
    {
        case KEY_DOWN_ARROW:
            gdi_layer_lock_frame_buffer();

            if ((wgui_cat280_has_thumbnail() == MMI_TRUE) &&
                (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
            {
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_THUMBNAIL, -1);
            }
#ifdef __WGUI_CAT280_ENHANCED_UI__
            else if ((g_wgui_uce_cntx.is_audio== MMI_TRUE) &&
                    (g_wgui_uce_cntx.audio_layout== WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
            {
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_AUDIO, -1);
            }
#endif
            else
            {
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_EDITOR, -1);
            }
            
            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;
 
        case KEY_UP_ARROW: 
            gdi_layer_lock_frame_buffer();

            if (wgui_cat280_get_recipients_num(WGUI_UCE_BCC_RECIPIENTS) != 0)
            {
                highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_BCC_RECIPIENTS);
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_BCC_RECIPIENTS, highlight_index);
            }
            else if (wgui_cat280_get_recipients_num(WGUI_UCE_CC_RECIPIENTS) != 0)
            {
                highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_CC_RECIPIENTS);
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_CC_RECIPIENTS, highlight_index);
            }
            else if (wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS) != 0)
            {
                highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_TO_RECIPIENTS);
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_TO_RECIPIENTS, highlight_index);
            }
            else
            {
                wgui_cat280_move_to_editor_top();
            }
            
            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;

        case KEY_RIGHT_ARROW:
            old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
            wgui_cat280_adjust_editor_scroll_bar();
            if (MMI_multiline_inputbox.text_offset_y != old_text_offset_y)
            {
                wgui_inputs_ml_redraw();
            }

            wgui_inputs_sl_next_character();
            break;
            
        case KEY_LEFT_ARROW:
            old_text_offset_y = MMI_multiline_inputbox.text_offset_y;
            wgui_cat280_adjust_editor_scroll_bar();
            if (MMI_multiline_inputbox.text_offset_y != old_text_offset_y)
            {
                wgui_inputs_ml_redraw();
            }

            wgui_inputs_sl_previous_character(); 
            break;
            
        default:
            result = MMI_FALSE;
            break;
    }
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_highlight_on_subject_key_hdlr
 * DESCRIPTION
 *  highlight on "subject" handler
 * PARAMETERS
 *  key_code   [IN]  key code
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_highlight_on_thumbnail_key_hdlr(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_TRUE;
    S32 highlight_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/       
    switch (key_code)
    {
        case KEY_DOWN_ARROW:
            gdi_layer_lock_frame_buffer();

            if ((wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
            {
#ifdef __WGUI_CAT280_ENHANCED_UI__
                if ((g_wgui_uce_cntx.is_audio== MMI_TRUE) &&
                        (g_wgui_uce_cntx.audio_layout== WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_AUDIO, -1);
                    /*offset = wgui_inputs_ml_is_area_visible(
                                g_wgui_uce_cntx.max_label_width + CAT280_HMARGIN - 1,
                                MMI_multiline_inputbox.header_height - CAT280_THUMBNAIL_FRAME_HEIGHT,
                                MMI_content_width - g_wgui_uce_cntx.max_label_width - (CAT280_HMARGIN << 1),
                                CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1),
                                (CAT280_VMARGIN >> 1));

                    wgui_cat280_editor_scroll_down(offset); */
                }
                else
#endif
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_EDITOR, -1);
                }
            }
            else if ((wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
            {
#ifdef __WGUI_CAT280_ENHANCED_UI__
                if ((g_wgui_uce_cntx.is_audio== MMI_TRUE) &&
                        (g_wgui_uce_cntx.audio_layout== WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_AUDIO, -1);
                }
#endif
                wgui_cat280_move_to_editor_top();
                wgui_cat280_editor_scroll_down(MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.height + CAT280_VMARGIN);
            }

            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;
 
        case KEY_UP_ARROW: 
            gdi_layer_lock_frame_buffer();
            
            if ((wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP))
            {
                
                if (g_wgui_uce_cntx.has_editable_subject)
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_SUBJECT, - 1);
                }
                else if (wgui_cat280_get_recipients_num(WGUI_UCE_BCC_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_BCC_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_BCC_RECIPIENTS, highlight_index);
                }
                else if (wgui_cat280_get_recipients_num(WGUI_UCE_CC_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_CC_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_CC_RECIPIENTS, highlight_index);
                }
                else if (wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_TO_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_TO_RECIPIENTS, highlight_index);
                }
                else
                {
                    wgui_cat280_move_to_editor_top();
                }
            }
            else if ((wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
            {
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_EDITOR, -1);
            }
            
            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;

        case KEY_RIGHT_ARROW:            
        case KEY_LEFT_ARROW:
            /* callback APP to change slide */
            wgui_cat280_change_slide(key_code);        
            break;
            
        default:
            result = MMI_FALSE;
            break;
    }
    return result;
}


#ifdef __WGUI_CAT280_ENHANCED_UI__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_highlight_on_audio_key_hdlr
 * DESCRIPTION
 *  highlight on "audio" handler
 * PARAMETERS
 *  key_code   [IN]  key code
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
static MMI_BOOL wgui_cat280_highlight_on_audio_key_hdlr(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_TRUE;
    S32 highlight_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/       
    switch (key_code)
    {
        case KEY_DOWN_ARROW:
            gdi_layer_lock_frame_buffer();

            if (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)
            {
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_EDITOR, -1);
            }
            else if (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)
            {
                wgui_cat280_move_to_editor_top();
                wgui_cat280_editor_scroll_down(MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.height + CAT280_VMARGIN);
            }

            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;
 
        case KEY_UP_ARROW: 
            gdi_layer_lock_frame_buffer();
            
            if (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)
            {
                if ((wgui_cat280_has_thumbnail() == MMI_TRUE) && /* has thumbnail */
                    (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)) /* thumbnail at top */
                {        
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_THUMBNAIL, -1);
                }
                else if (g_wgui_uce_cntx.has_editable_subject)
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_SUBJECT, - 1);
                }
                else if (wgui_cat280_get_recipients_num(WGUI_UCE_BCC_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_BCC_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_BCC_RECIPIENTS, highlight_index);
                }
                else if (wgui_cat280_get_recipients_num(WGUI_UCE_CC_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_CC_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_CC_RECIPIENTS, highlight_index);
                }
                else if (wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS) != 0)
                {
                    highlight_index = wgui_cat280_get_last_recipient_index(WGUI_UCE_TO_RECIPIENTS);
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_TO_RECIPIENTS, highlight_index);
                }
                else
                {
                    wgui_cat280_move_to_editor_top();
                }
            }
            else if (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)
            {
                if ((wgui_cat280_has_thumbnail() == MMI_TRUE) && /* has thumbnail */
                    (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)) /* thumbnail at bottom */
                {        
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_THUMBNAIL, -1);
                }
                else 
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_EDITOR, -1);
                }
            }
            
            wgui_cat280_adjust_editor_scroll_bar();
            wgui_inputs_ml_redraw();
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
            break;

        case KEY_RIGHT_ARROW:            
        case KEY_LEFT_ARROW:
            /* callback APP to change slide */
            wgui_cat280_change_slide(key_code);        
            break;
            
        default:
            result = MMI_FALSE;
            break;
    }
    return result;
}
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

#ifdef __MMI_TOUCH_SCREEN__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_editor_header_pen_callback
 * DESCRIPTION
 *  editor header pen event callback function
 *  1. set highlight state
 *  2. disable/enable multiline inputbox
 * PARAMETERS
 *  x          [IN]  pen position x
 *  y          [IN]  pen position y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_editor_header_pen_callback(S32 x, S32 y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wgui_uce_region_id_enum region_id = WGUI_UCE_EMPTY;
    S32 index;
    S32 firset_index;
    S32 old_ext_flags;
    MMI_BOOL set_flag_by_cat = MMI_FALSE;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* get the pen down recipient, subject... */
    wgui_cat280_translate_header_pen_event(x, y, &region_id, &index);

    if (region_id == WGUI_UCE_EMPTY)
    {
        return;
    }

    gdi_layer_lock_frame_buffer();

#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#ifdef __WGUI_CAT280_SUPPORT_MMS__
/* under construction !*/
/* under construction !*/
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
/* under construction !*/
/* under construction !*/
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#ifdef __WGUI_CAT280_SUPPORT_MMS__
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
/* under construction !*/
/* under construction !*/
#ifdef __MMI_FTE_SUPPORT__
/* under construction !*/
#endif /* __MMI_FTE_SUPPORT__ */
/* under construction !*/
/* under construction !*/
#endif /* #if 0*/

    if (region_id == WGUI_UCE_TO_LABEL)
    {
        g_wgui_uce_cntx.button_down_region = WGUI_UCE_TO_RECIPIENTS;
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        firset_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_TO_RECIPIENTS);
        if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_TO_RECIPIENTS)
        {
            wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_TO_RECIPIENTS, firset_index);
        }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    else if (region_id == WGUI_UCE_CC_LABEL)
    {
        g_wgui_uce_cntx.button_down_region = WGUI_UCE_CC_RECIPIENTS;
        firset_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_CC_RECIPIENTS);
        if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_CC_RECIPIENTS)
        {
            wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_CC_RECIPIENTS, firset_index);
        }
    }
    else if (region_id == WGUI_UCE_BCC_LABEL)
    {
        g_wgui_uce_cntx.button_down_region = WGUI_UCE_BCC_RECIPIENTS;
        firset_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_BCC_RECIPIENTS);
        if (g_wgui_uce_cntx.highligh_state != WGUI_UCE_BCC_RECIPIENTS)
        {
            wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_BCC_RECIPIENTS, firset_index);
        }
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    else
    {
#ifdef __MMI_FTE_SUPPORT__
        g_wgui_uce_cntx.sl_ime.is_vk_on = MMI_TRUE;
#endif /* __MMI_FTE_SUPPORT__ */
        wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)region_id, index);
        wgui_cat280_adjust_single_line_editor_position();
        wgui_cat280_adjust_editor_scroll_bar();
    }

    old_ext_flags = MMI_multiline_inputbox.ext_flags;
    if ((region_id == WGUI_UCE_TO_LABEL) && (g_wgui_uce_cntx.highligh_state == WGUI_UCE_EDITOR))
    {
        MMI_multiline_inputbox.ext_flags |= GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR;
        set_flag_by_cat = MMI_TRUE;
    }

    if ((region_id != WGUI_UCE_TO_LABEL) && (region_id != WGUI_UCE_CC_LABEL) && (region_id != WGUI_UCE_BCC_LABEL))
    {
        mmi_imc_redraw_screen_by_state();
    }
    else
    {
        wgui_inputs_ml_redraw();
    }

    if ((!(old_ext_flags & GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR)) && (set_flag_by_cat == MMI_TRUE))
    {
        MMI_multiline_inputbox.ext_flags &= ~GUI_MULTI_LINE_INPUT_BOX_DISABLE_FORCE_CURSOR_APPEAR;
    }

    gdi_layer_unlock_frame_buffer();
    gdi_lcd_repaint_all();
    return;
}

#ifdef __WGUI_CAT280_SUPPORT_MMS__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_editor_footer_pen_callback
 * DESCRIPTION
 *  editor footer pen event callback function
 *  1. set highlight state
 *  2. disable multiline inputbox
 * PARAMETERS
 *  x          [IN]  pen position x
 *  y          [IN]  pen position y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_editor_footer_pen_callback(S32 x, S32 y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();

    if ((g_wgui_uce_cntx.has_thumbnail == MMI_TRUE) && 
        (g_wgui_uce_cntx.is_audio == MMI_TRUE) &&
        (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM) &&
        (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
    {
        if (y > (CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1)))
        {
            wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_AUDIO, -1);
        }
        else
        {
            wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_THUMBNAIL, -1);
        }
    }
    else if ((g_wgui_uce_cntx.has_thumbnail == MMI_TRUE) &&
             (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
    {
        wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_THUMBNAIL, -1);
    }
    else if ((g_wgui_uce_cntx.is_audio == MMI_TRUE) &&
             (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM))
    {
        wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_AUDIO, -1);
    }
    else
    {
        MMI_ASSERT(0);
    }

    wgui_inputs_ml_disable();
    wgui_cat280_adjust_editor_scroll_bar();
    wgui_inputs_ml_redraw();

	gdi_layer_unlock_frame_buffer();
    gdi_lcd_repaint_all();
}
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_editor_context_pen_callback
 * DESCRIPTION
 *  editor context pen event callback function
 *  1. set highlight state
 *  2. enable multiline inputbox
 * PARAMETERS
 *  x          [IN]  pen position x
 *  y          [IN]  pen position y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_editor_context_pen_callback(S32 x, S32 y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();

#ifdef __MMI_FTE_SUPPORT__
    g_wgui_uce_cntx.ml_ime.is_vk_on = MMI_TRUE;
#endif /* __MMI_FTE_SUPPORT__ */
    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_HIGHLIGHT_EDITOR, -1);
    wgui_inputs_ml_enable();
    //wgui_inputs_ml_redraw();
    mmi_imc_redraw_screen_by_state();

    gdi_layer_unlock_frame_buffer();
    gdi_lcd_repaint_all();
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_editor_control_area_pen_down_callback
 * DESCRIPTION
 *  editor pen event callback function
 *  1. set highlight state
 *  2. disable/enable multiline inputbox
 * PARAMETERS
 *  area_type  [IN]  editor area : 1 means header, 2 means footer, 3 means editor content
 *  x          [IN]  pen position x
 *  y          [IN]  pen position y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_editor_control_area_pen_down_callback(U8 area_type, S32 x, S32 y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_CLIPBOARD__
    if (!mmi_imc_is_clipboard_state())
#endif /* __MMI_CLIPBOARD__ */
    {
        if (area_type == 0) /* header */
        {
            if (y > 0)
            {
                wgui_cat280_editor_header_pen_callback(x, y);
            }
        }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        else if (area_type == 1) /* footer */
        {
            wgui_cat280_editor_footer_pen_callback(x, y);
        }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        else if (area_type == 2 && wgui_cat280_get_highlight_state() != WGUI_UCE_HIGHLIGHT_EDITOR) /* editor */
        {
            wgui_cat280_editor_context_pen_callback(x, y);
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_editor_control_area_pen_callback
 * DESCRIPTION
 *  editor pen up callback function
 *  1. set highlight state
 *  2. disable/enable multiline inputbox
 * PARAMETERS
 *  area_type                [IN]  editor area : 1 means header, 2 means footer, 3 means editor content
 *  mmi_pen_event_type_enum  [IN]  pen event type
 *  x                        [IN]  pen position x
 *  y                        [IN]  pen position y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_editor_control_area_pen_callback(gui_input_box_area_enum area_type, mmi_pen_event_type_enum pen_event, S32 x, S32 y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    static gui_input_box_area_enum pen_down_area_type;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (pen_event == MMI_PEN_EVENT_DOWN)
    {
        pen_down_area_type = area_type;
        wgui_cat280_editor_control_area_pen_down_callback((U8)area_type, x, y);
    }

    if ((pen_event == MMI_PEN_EVENT_UP) && (area_type == pen_down_area_type))
    {
        if ((g_wgui_uce_cntx.to_recipients.label_callback != NULL) && 
            (g_wgui_uce_cntx.button_down_region == WGUI_UCE_TO_RECIPIENTS))
        {
            wgui_uce_region_id_enum region_id = WGUI_UCE_EMPTY;
            S32 index;
            wgui_cat280_translate_header_pen_event(x, y, &region_id, &index);
            if (region_id == WGUI_UCE_TO_LABEL)
            {
                S32 old_recipient_num = wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS);
                g_wgui_uce_cntx.to_recipients.label_callback();
                if ((g_dm_data.s32CatId != MMI_CATEGORY280_ID) &&
                    (old_recipient_num != wgui_cat280_get_recipients_num(WGUI_UCE_TO_RECIPIENTS)))
                {
                    g_wgui_uce_cntx.highligh_state = WGUI_UCE_TO_RECIPIENTS;
                    g_wgui_uce_cntx.highlight_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_TO_RECIPIENTS);
                    g_wgui_uce_cntx.add_recipient_in_background = MMI_TRUE;
                }
            }

            if (g_dm_data.s32CatId == MMI_CATEGORY280_ID)
            {
                g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;
                wgui_inputs_ml_redraw(); 
            }
        }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        else if ((g_wgui_uce_cntx.cc_recipients.label_callback != NULL) && 
            (g_wgui_uce_cntx.button_down_region == WGUI_UCE_CC_RECIPIENTS))
        {
            wgui_uce_region_id_enum region_id = WGUI_UCE_EMPTY;
            S32 index;
            wgui_cat280_translate_header_pen_event(x, y, &region_id, &index);
            if (region_id == WGUI_UCE_CC_LABEL)
            {
                g_wgui_uce_cntx.cc_recipients.label_callback();
            }

            if (g_dm_data.s32CatId == MMI_CATEGORY280_ID)
            {
                g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;
                wgui_inputs_ml_redraw(); 
            }
        }
        else if ((g_wgui_uce_cntx.bcc_recipients.label_callback != NULL) && 
            (g_wgui_uce_cntx.button_down_region == WGUI_UCE_BCC_RECIPIENTS))
        {
            wgui_uce_region_id_enum region_id = WGUI_UCE_EMPTY;
            S32 index;
            wgui_cat280_translate_header_pen_event(x, y, &region_id, &index);
            if (region_id == WGUI_UCE_BCC_LABEL)
            {
                g_wgui_uce_cntx.bcc_recipients.label_callback();
            }

            if (g_dm_data.s32CatId == MMI_CATEGORY280_ID)
            {
                g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;
                wgui_inputs_ml_redraw(); 
            }
        }
 #endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        else
        {
            g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;
        }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
#ifdef __WGUI_CAT280_ENHANCED_UI__
        if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_THUMBNAIL) && (g_wgui_uce_cntx.old_highlight_state == g_wgui_uce_cntx.highligh_state))
        {
            if ((g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP) && (area_type == GUI_INPUT_BOX_AREA_HEADER))
            {
                wgui_uce_region_id_enum region_id = WGUI_UCE_EMPTY;
                S32 index;
                wgui_cat280_translate_header_pen_event(x, y, &region_id, &index);

                if ((region_id == g_wgui_uce_cntx.highligh_state) &&
                    (g_wgui_cat280_callback.object_callback != NULL))
                {
                    g_wgui_cat280_callback.object_callback(g_wgui_uce_cntx.highligh_state);
                }
            }
            else if ((g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM) && (area_type == GUI_INPUT_BOX_AREA_FOOTER))
            {
                if (g_wgui_cat280_callback.object_callback != NULL)
                {
                    g_wgui_cat280_callback.object_callback(g_wgui_uce_cntx.highligh_state);
                }
            }
        }

        if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_AUDIO) && (g_wgui_uce_cntx.old_highlight_state == g_wgui_uce_cntx.highligh_state))
        {
            if ((g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP) && (area_type == GUI_INPUT_BOX_AREA_HEADER))
            {
                wgui_uce_region_id_enum region_id = WGUI_UCE_EMPTY;
                S32 index;
                wgui_cat280_translate_header_pen_event(x, y, &region_id, &index);

                if ((region_id == g_wgui_uce_cntx.highligh_state) &&
                    (g_wgui_cat280_callback.object_callback != NULL))
                {
                    g_wgui_cat280_callback.object_callback(g_wgui_uce_cntx.highligh_state);
                }
            }
            else if ((g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM) && (area_type == GUI_INPUT_BOX_AREA_FOOTER))
            {
                if (g_wgui_cat280_callback.object_callback != NULL)
                {
                    g_wgui_cat280_callback.object_callback(g_wgui_uce_cntx.highligh_state);
                }
            }
        }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    }
    else if (pen_event == MMI_PEN_EVENT_LONG_TAP)
    {
        if (area_type == 2 && (area_type == pen_down_area_type) && wgui_cat280_get_highlight_state() != WGUI_UCE_HIGHLIGHT_EDITOR) /* editor */
        {
            gdi_layer_lock_frame_buffer();
            
            wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_EDITOR);
            wgui_inputs_ml_enable();
            wgui_inputs_ml_redraw();
            
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
        }
    }
    else if (pen_event == MMI_PEN_EVENT_UP)
    {
        if (g_dm_data.s32CatId == MMI_CATEGORY280_ID)
        {
            g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;
            wgui_inputs_ml_redraw(); 
        }
    }
}
#endif /* __MMI_TOUCH_SCREEN__ */
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_multiline_inputbox_key_hdlr
 * DESCRIPTION
 *  multiline inputbox pre key handler
 *  1. if navigation key, editor will callback
 *  2. if input key, IME will callback editor, and editor will callback category.
 *  category will have two kinds of layout:
 *  a. thumbnail at top           
 *       subject          
 *       thumbnail        
 *       editor           
 *  b. thumbnail at buttom
 *       subject
 *       editor
 *       thumbnail
 * PARAMETERS
 *  key_code  [IN]  key code
 * RETURNS
 *  MMI_BOOL  return true, editor will not do anything
 *****************************************************************************/
static MMI_BOOL wgui_cat280_multiline_inputbox_key_hdlr(S16 key_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL result = MMI_FALSE;
    wgui_uce_highlight_state_enum highlight_state = (wgui_uce_highlight_state_enum)wgui_cat280_get_highlight_state();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!mmi_imc_is_ime_state())
    {
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    #ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
        if ((g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS) && (g_wgui_uce_cntx.inline_recipients == MMI_FALSE))
    #else /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
        if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS)
    #endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
        {
            switch(highlight_state)
            {
                case WGUI_UCE_HIGHLIGHT_SUBJECT:     /* highlight on subject */
                    result = wgui_cat280_highligh_on_subject_handler(key_code);
                    break;
                case WGUI_UCE_HIGHLIGHT_THUMBNAIL:  /* highlight on attachment */
                    result = wgui_cat280_highligh_on_thumbnail_handler(key_code);
                    break;
                case WGUI_UCE_HIGHLIGHT_EDITOR:      /* highlight on editor */
                    result = wgui_cat280_highlight_on_editor_handler(key_code);
                    break;
                default:
                    break;
            }
        }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
        if (g_wgui_uce_cntx.inline_recipients == MMI_TRUE)
        {
            switch(highlight_state)
            {
                case WGUI_UCE_HIGHLIGHT_TO_RECIPIENTS:     /* highlight on "to" */
                    result = wgui_cat280_highlight_on_to_key_hdlr(key_code);
                    break;
                    
    #ifdef __WGUI_CAT280_SUPPORT_MMS__
                case WGUI_UCE_HIGHLIGHT_CC_RECIPIENTS:     /* highlight on "cc" */
                    result = wgui_cat280_highlight_on_cc_key_hdlr(key_code);
                    break;
                case WGUI_UCE_HIGHLIGHT_BCC_RECIPIENTS:     /* highlight on "bcc" */
                    result = wgui_cat280_highlight_on_bcc_key_hdlr(key_code);
                    break;
                case WGUI_UCE_HIGHLIGHT_SUBJECT:     /* highlight on subject */
                    result = wgui_cat280_highlight_on_subject_key_hdlr(key_code);
                    break;
                case WGUI_UCE_HIGHLIGHT_THUMBNAIL:  /* highlight on thumbnail */
                    result = wgui_cat280_highlight_on_thumbnail_key_hdlr(key_code);
                    break;
                #ifdef __WGUI_CAT280_ENHANCED_UI__
                case WGUI_UCE_HIGHLIGHT_AUDIO:  /* highlight on thumbnail */
                    result = wgui_cat280_highlight_on_audio_key_hdlr(key_code);
                    break;
                #endif /* __WGUI_CAT280_ENHANCED_UI__ */
    #endif /* __WGUI_CAT280_SUPPORT_MMS__ */

                case WGUI_UCE_HIGHLIGHT_EDITOR:      /* highlight on editor */
                    result = wgui_cat280_highlight_on_editor_key_hdlr(key_code);
                    break;
                default:
                    break;
            }
        }
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
    }
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_adjust_cursor_position
 * DESCRIPTION
 *  adjust cursor position before delete character
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void wgui_cat280_adjust_cursor_position(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (wgui_cat280_get_highlight_state() != WGUI_UCE_HIGHLIGHT_EDITOR)
    {
        wgui_cat280_ml_go_to_last_position();
    }
}


#ifdef __MMI_TOUCH_SCREEN__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_editor_pen_down_callback
 * DESCRIPTION
 *  editor pen down callback function
 *  1. set highlight state
 *  2. disable/enable multiline inputbox
 * PARAMETERS
 *  area_type  [IN]  editor area : 0 means header, 1 means footer, 2 means editor content
 *  x          [IN]  pen position x
 *  y          [IN]  pen position y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_editor_pen_down_callback(U8 area_type, S32 x, S32 y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_CLIPBOARD__
    if (!mmi_imc_is_clipboard_state())
#endif /* __MMI_CLIPBOARD__ */
    {
        /* reset ime state */
        if (((area_type == 0) || (area_type == 1)) && (mmi_imc_is_ime_state()))
        {
            mmi_imc_reset_ime_state();
        }

        if (area_type == 0) /* header */
        {
            gdi_layer_lock_frame_buffer();

#ifdef __WGUI_CAT280_SUPPORT_MMS__
            if (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)  /* header has subject and thumbnail */
            {
                S32 subject_height = CAT280_VMARGIN + (CAT280_SUBJECT_H << 1);
                if (((g_wgui_uce_cntx.subject_secondline != NULL) || (g_wgui_uce_cntx.subject_firstline != NULL)) 
                    && (y < subject_height)) /* has subject and pen down on subject */
                {
                    wgui_cat280_move_to_editor_top();
                    wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_SUBJECT);
                }
                else /* no subject or pen down out of subject */
                {
                    if ((g_wgui_uce_cntx.subject_secondline != NULL) || (g_wgui_uce_cntx.subject_firstline != NULL))
                    {
                        if ((MMI_multiline_inputbox.text_offset_y + subject_height) <= 0)
                        {
                            wgui_cat280_move_to_editor_top();
                            wgui_cat280_editor_scroll_down(subject_height);
                        }
                    }
                    else
                    {
                        wgui_cat280_move_to_editor_top();
                    }
                    wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_THUMBNAIL);
                }
            }
            else if (wgui_cat280_get_thumbnail_layout() == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM) /* header only has subject */
            {
                wgui_cat280_move_to_editor_top();
                wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_SUBJECT);
            }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

            wgui_inputs_ml_disable();
            wgui_inputs_ml_redraw();
	        gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
        }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        else if (area_type == 1) /* footer */
        {
		    gdi_layer_lock_frame_buffer();

            wgui_cat280_move_to_editor_top();
            wgui_cat280_editor_scroll_down(MMI_multiline_inputbox.text_height - MMI_multiline_inputbox.height + ((CAT280_VMARGIN - 1) << 1));
            wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_THUMBNAIL);
            wgui_inputs_ml_disable();
            wgui_inputs_ml_redraw();

		    gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
        }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        else if (area_type == 2 && wgui_cat280_get_highlight_state() != WGUI_UCE_HIGHLIGHT_EDITOR) /* editor */
        {
	    	gdi_layer_lock_frame_buffer();

            wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_EDITOR);
            wgui_inputs_ml_enable();
            wgui_inputs_ml_redraw();

            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_editor_pen_up_callback
 * DESCRIPTION
 *  editor pen up callback function
 *  1. set highlight state
 *  2. disable/enable multiline inputbox
 * PARAMETERS
 *  area_type                [IN]  editor area : 1 means header, 2 means footer, 3 means editor content
 *  mmi_pen_event_type_enum  [IN]  pen event type
 *  x                        [IN]  pen position x
 *  y                        [IN]  pen position y
 * RETURNS
 *  void
 *****************************************************************************/
static void wgui_cat280_editor_pen_up_callback(gui_input_box_area_enum area_type, mmi_pen_event_type_enum pen_event, S32 x, S32 y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (pen_event == MMI_PEN_EVENT_UP)
    {
        wgui_cat280_editor_pen_down_callback((U8)area_type, x, y);
    }
    else if (pen_event == MMI_PEN_EVENT_LONG_TAP)
    {
        if (area_type == 2 && wgui_cat280_get_highlight_state() != WGUI_UCE_HIGHLIGHT_EDITOR) /* editor */
        {
            gdi_layer_lock_frame_buffer();
            
            wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_EDITOR);
            wgui_inputs_ml_enable();
            wgui_inputs_ml_redraw();
            
            gdi_layer_unlock_frame_buffer();
            gdi_lcd_repaint_all();
        }
    }
}
#endif /* __MMI_TOUCH_SCREEN__ */


#ifdef __WGUI_CAT280_ENHANCED_UI__
#ifdef __MMI_TOUCH_SCREEN__
/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_pen_down_handler
 * DESCRIPTION
 *  control arae pen down handler
 * PARAMETERS
 *  point    [IN]    pen event position
 * RETURNS
 *  MMI_BOOL   handled or not
 *****************************************************************************/
static MMI_BOOL wgui_cat280_pen_down_handler(mmi_pen_point_struct point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    gui_button_pen_enum attach_button_event;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ret = gui_icontext_button_translate_pen_event(
            &g_wgui_uce_cntx.attach_button,
            MMI_PEN_EVENT_DOWN,
            point.x,
            point.y,
            &attach_button_event);

    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_pen_up_handler
 * DESCRIPTION
 *  control arae pen up handler
 * PARAMETERS
 *  point    [IN]    pen event position
 * RETURNS
 *  MMI_BOOL   handled or not
 *****************************************************************************/
static MMI_BOOL wgui_cat280_pen_up_handler(mmi_pen_point_struct point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    gui_button_pen_enum attach_button_event;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ret = gui_icontext_button_translate_pen_event(
            &g_wgui_uce_cntx.attach_button,
            MMI_PEN_EVENT_UP,
            point.x,
            point.y,
            &attach_button_event);
    
    if (ret)
    {
        /* if enable the button, callback to app */
        if (g_wgui_cat280_callback.attach_button_callback != NULL)
        {
            g_wgui_cat280_callback.attach_button_callback();
        }
    }
    
    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_pen_repeat_handler
 * DESCRIPTION
 *  control arae pen repeat handler
 * PARAMETERS
 *  point    [IN]    pen event position
 * RETURNS
 *  MMI_BOOL   handled or not
 *****************************************************************************/
static MMI_BOOL wgui_cat280_pen_repeat_handler(mmi_pen_point_struct point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    gui_button_pen_enum attach_button_event;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ret = gui_icontext_button_translate_pen_event(
            &g_wgui_uce_cntx.attach_button,
            MMI_PEN_EVENT_REPEAT,
            point.x,
            point.y,
            &attach_button_event);

    return ret;
}


/*****************************************************************************
 * FUNCTION
 *  wgui_cat280_pen_move_handler
 * DESCRIPTION
 *  control arae pen move handler
 * PARAMETERS
 *  point    [IN]    pen event position
 * RETURNS
 *  MMI_BOOL   handled or not
 *****************************************************************************/
static MMI_BOOL wgui_cat280_pen_move_handler(mmi_pen_point_struct point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    gui_button_pen_enum attach_button_event;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ret = gui_icontext_button_translate_pen_event(
            &g_wgui_uce_cntx.attach_button,
            MMI_PEN_EVENT_MOVE,
            point.x,
            point.y,
            &attach_button_event);

    return ret;

}

#endif /* __MMI_TOUCH_SCREEN__ */
#endif /* __WGUI_CAT280_ENHANCED_UI__ */

/*****************************************************************************
 * FUNCTION
 *  ExitCategory280Screen
 * DESCRIPTION
 *  Called on exit category: releases screen based memory
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void ExitCategory280Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_dm_data.s32CatId = 0;
    wgui_close_inputbox();
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    wgui_inputs_sl_close();
    gui_inputs_register_redraw_background_filler(NULL);
    g_wgui_uce_cntx.add_recipient_in_background = MMI_FALSE;
    g_wgui_uce_cntx.add_content_in_background = MMI_FALSE;
#endif
    
    
    /* clear inputbox callback */
    wgui_multiline_inputbox_register_infobar_callback(
        NULL,
        NULL,
        wgui_inputbox_information_bar_height);
    MMI_multiline_inputbox.header_callback = NULL;
    
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    MMI_multiline_inputbox.footer_callback = NULL;
	
    if (g_wgui_uce_cntx.thumbnail_buffer != NULL)
    {
        applib_mem_screen_free(g_wgui_uce_cntx.thumbnail_buffer);
        g_wgui_uce_cntx.thumbnail_buffer = NULL;
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    if (g_wgui_cat280_screen_info != NULL)
    {
#ifdef __MMI_WALLPAPER_ON_BOTTOM__
        dm_set_scr_bg_opacity(g_wgui_cat280_screen_info->scr_bg_opacity);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */ 
        applib_mem_screen_free(g_wgui_cat280_screen_info);
        g_wgui_cat280_screen_info = NULL;
    }
#if defined(__WGUI_CAT280_ENHANCED_UI__) && defined(__WGUI_CAT280_SUPPORT_MMS__)
    wgui_cat280_register_attach_button_callback(NULL);
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
}


/*****************************************************************************
 * FUNCTION
 *  GetCategory280History
 * DESCRIPTION
 *  return pointer to GUI buffer
 * PARAMETERS
 *  history_buffer      [IN]     History buffer
 * RETURNS
 *  pointer to history buffer
 *****************************************************************************/
static U8 *GetCategory280History(U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    wgui_cat280_history_cntx *h;
    S32 ml_s;
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    S32 sl_s;
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    get_multiline_inputbox_category_history(MMI_CATEGORY280_ID, history_buffer);
    ml_s = sizeof(multiline_inputbox_category_history);
    ml_s = (ml_s + 3) / 4;
    ml_s *= 4;

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if ((wgui_cat280_get_highlight_state() == WGUI_UCE_TO_RECIPIENTS) ||
        (wgui_cat280_get_highlight_state() == WGUI_UCE_CC_RECIPIENTS) ||
        (wgui_cat280_get_highlight_state() == WGUI_UCE_BCC_RECIPIENTS) ||
        (wgui_cat280_get_highlight_state() == WGUI_UCE_SUBJECT))
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
    if (wgui_cat280_get_highlight_state() == WGUI_UCE_TO_RECIPIENTS)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    {
        wgui_inputs_sl_get_category_history(MMI_CATEGORY280_ID, history_buffer + ml_s);
    }

    sl_s = sizeof(singleline_inputbox_category_history);
    sl_s = (sl_s + 3) / 4;
    sl_s *= 4;

    h = (wgui_cat280_history_cntx*)(history_buffer + ml_s + sl_s);
    h->highlight_state = (wgui_uce_highlight_state_enum)wgui_cat280_get_highlight_state();
    h->highlight_index = wgui_cat280_get_highlight_buffer_index();

    /* get the ime history */
    if (mmi_imc_is_connected())
    {
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        if ((g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_CC_RECIPIENTS) ||
            (g_wgui_uce_cntx.highligh_state == WGUI_UCE_BCC_RECIPIENTS))
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
        if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_TO_RECIPIENTS)
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        {
            mmi_imc_get_input_method_history(&g_wgui_uce_cntx.sl_ime);
            g_wgui_uce_cntx.need_to_set_sl_ime = MMI_TRUE;
        }
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        else if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_SUBJECT)
        {
            mmi_imc_get_input_method_history(&g_wgui_uce_cntx.subject_ime);
            g_wgui_uce_cntx.need_to_set_subject_ime = MMI_TRUE;
        }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        else
        {
            mmi_imc_get_input_method_history(&g_wgui_uce_cntx.ml_ime);
            g_wgui_uce_cntx.need_to_set_ml_ime = MMI_TRUE;
        }
    }

        h->need_to_set_ml_ime = g_wgui_uce_cntx.need_to_set_ml_ime;
        h->need_to_set_sl_ime = g_wgui_uce_cntx.need_to_set_sl_ime;
    #ifdef __WGUI_CAT280_SUPPORT_MMS__
        h->need_to_set_subject_ime = g_wgui_uce_cntx.need_to_set_subject_ime;
    #endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        gui_memcpy(&(h->ml_ime), &g_wgui_uce_cntx.ml_ime, sizeof(mmi_imc_history));
        gui_memcpy(&(h->sl_ime), &g_wgui_uce_cntx.sl_ime, sizeof(mmi_imc_history));
    #ifdef __WGUI_CAT280_SUPPORT_MMS__
        gui_memcpy(&(h->subject_ime), &g_wgui_uce_cntx.subject_ime, sizeof(mmi_imc_history));
    #endif /* __WGUI_CAT280_SUPPORT_MMS__ */
#else /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
    h = (wgui_cat280_history_cntx*)(history_buffer + ml_s);
    h->highlight_state = wgui_cat280_get_highlight_state();
    g_wgui_uce_cntx.highligh_state = (wgui_uce_region_id_enum)WGUI_UCE_HIGHLIGHT_EDITOR;
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

    return history_buffer;
}


/*****************************************************************************
 * FUNCTION
 *  GetCategory280HistorySize
 * DESCRIPTION
 *  Get history size
 * PARAMETERS
 *  void
 * RETURNS
 *  S32 Category 280 History Size
 *****************************************************************************/
static S32 GetCategory280HistorySize(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    return (((sizeof(multiline_inputbox_category_history) + 3) / 4) * 4 + 
            ((sizeof(singleline_inputbox_category_history) + 3) / 4) * 4 + 
             sizeof(wgui_cat280_history_cntx));
#else /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
    return (((sizeof(multiline_inputbox_category_history) + 3) / 4) * 4 + 
             sizeof(wgui_cat280_history_cntx));
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

}


/* For detail description, please refer to wgui_categories_UCE.h */
void ShowCategory280Screen(
        U16 title,
        U16 title_icon,
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        wgui_uce_msg_type_enum msg_type,
        U32 input_method_type,
        UI_string_type subjcet_firstline,
        UI_string_type subject_secondline,
        U8 *gui_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;
    S32 inputbox_height;
    U16 header_height = 0;
    U16 footer_height = 0;
    MMI_BOOL has_header = MMI_FALSE;
    
#ifdef __WGUI_CAT280_SUPPORT_MMS__
    icontext_button *pre_bt, *next_bt;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

#ifdef __MMI_FTE_SUPPORT__
  //  wgui_uce_display_enum type;
  //  U32 msg_size;
#endif /* __MMI_FTE_SUPPORT__ */

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    S32 recipient_index;
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* malloc memory for screen info */
    if(g_wgui_cat280_screen_info == NULL)
    {
        g_wgui_cat280_screen_info = (wgui_cat280_screen_layout_cntx *)applib_mem_screen_alloc_framebuffer(sizeof(wgui_cat280_screen_layout_cntx));
        ASSERT(g_wgui_cat280_screen_info != NULL);
        memset((void*)g_wgui_cat280_screen_info, 0, sizeof(wgui_cat280_screen_layout_cntx));
    }
    
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    if (g_wgui_uce_cntx.inline_recipients == MMI_TRUE)
    {
        MMI_CAT_SET_KEY_PROC(wgui_cat280_key_proc, NULL);
    }
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

#ifdef __WGUI_CAT280_SUPPORT_MMS__
    g_wgui_uce_cntx.msg_type = msg_type;    /* we need to store it in msg_type because we need to draw info bar. */

    if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_SMS)
    {
        g_wgui_uce_cntx.has_thumbnail = MMI_FALSE;
    }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

    /* reset 7bit counter */
    mmi_7bit_counter_init(g_wgui_uce_cntx.text_buffer);

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    /* support editable recipients */
    if (g_wgui_uce_cntx.inline_recipients == MMI_TRUE)
    {
        wgui_cat280_get_header_and_footer_height(&header_height, &footer_height);
        g_wgui_uce_cntx.button_down_region = WGUI_UCE_EMPTY;
    }
    else
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
    {
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        /* MMS has preview object area */
        if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS)
        {
            if (g_wgui_uce_cntx.is_video || g_wgui_uce_cntx.is_image)
            {
                if (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)
                {
                    header_height = CAT280_THUMBNAIL_FRAME_HEIGHT;
                    has_header = MMI_TRUE;
                }
                else if (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)
                {
                    footer_height = CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN << 1);
                }
                else
                {
                    ASSERT(0);
                }
                g_wgui_uce_cntx.has_thumbnail = MMI_TRUE;
            }
            else
            {
                g_wgui_uce_cntx.has_thumbnail = MMI_FALSE;
            }
            
#ifdef __WGUI_CAT280_ENHANCED_UI__
            if (g_wgui_uce_cntx.is_audio)
            {
                if (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)
                {
                    if (header_height == 0)
                    {
                        header_height += (CAT280_VMARGIN >> 1);
                    }
                                        
                    header_height += CAT280_THUMBNAIL_FRAME_HEIGHT;
                    has_header = MMI_TRUE;
                }
                else if (g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)
                {
                    if (footer_height == 0)
                    {
                        footer_height += (CAT280_VMARGIN >> 1);
                    }
                    
                    footer_height += CAT280_THUMBNAIL_FRAME_HEIGHT + (CAT280_VMARGIN >> 1);
                }
                else
                {
                    ASSERT(0);
                }
            }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
        }

        /* subject area */
        g_wgui_uce_cntx.subject_firstline = subjcet_firstline;
        g_wgui_uce_cntx.subject_secondline = subject_secondline;
        if (g_wgui_uce_cntx.subject_firstline != NULL)
        {
            header_height += (CAT280_VMARGIN >> 1) + CAT280_SUBJECT_H;
            if (g_wgui_uce_cntx.subject_secondline != NULL)
            {
                header_height += CAT280_SUBJECT_H;
            }
            if (has_header == MMI_FALSE)
            {
                header_height += (CAT280_VMARGIN >> 1);
            }
        }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    }

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    g_wgui_uce_cntx.editor_input_type = input_method_type;
    g_wgui_uce_cntx.right_softkey = right_softkey;
    g_wgui_uce_cntx.right_softkey_icon = right_softkey_icon;
    if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_EDITOR)
    {
        g_wgui_uce_cntx.highlight_index = -1;
    }
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

    gui_lock_double_buffer();

    /* Title */
    dm_add_title_id(title, title_icon);

    /* Short Cuts */
    wgui_title_set_menu_shortcut_number(-1);
    wgui_title_disable_menu_shortcut_display(MMI_TRUE);
    
    /* Softkeys */
    dm_add_softkey_id(left_softkey, right_softkey);

    /* button on information bar */
#ifdef __WGUI_CAT280_SUPPORT_MMS__
#ifdef __MMI_FTE_SUPPORT__
    g_wgui_uce_cntx.pre_bt = dm_add_button(
                                     NULL, 
                                     get_image(WGUI_UCE_FTE_PRE_BUTTON_NORMAL),
                                     get_image(WGUI_UCE_FTE_PRE_BUTTON_DOWN),
                                     wgui_cat280_clear_icon_bg);
    g_wgui_uce_cntx.next_bt = dm_add_button(
                                     NULL, 
                                     get_image(WGUI_UCE_FTE_NEXT_BUTTON_NORMAL),
                                     get_image(WGUI_UCE_FTE_NEXT_BUTTON_DOWN),
                                     wgui_cat280_clear_icon_bg);

#else
#if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__)
    g_wgui_uce_cntx.pre_bt = dm_add_button(
                                     NULL, 
                                     (PU8)(current_MMI_theme->cascade_menu_submenu_left_arrow_image),
                                     (PU8)(current_MMI_theme->cascade_menu_submenu_left_arrow_image),
                                     wgui_cat280_clear_icon_bg);
    g_wgui_uce_cntx.next_bt = dm_add_button(
                                     NULL, 
                                     (PU8)(current_MMI_theme->cascade_menu_submenu_right_arrow_image),
                                     (PU8)(current_MMI_theme->cascade_menu_submenu_right_arrow_image),
                                     wgui_cat280_clear_icon_bg);
#else /* #if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__) */
    g_wgui_uce_cntx.pre_bt = dm_add_button(
                                     NULL, 
                                     (PU8)(current_MMI_theme->UCE_screen_pre_button_image),
                                     (PU8)(current_MMI_theme->UCE_screen_pre_button_image),
                                     wgui_cat280_clear_icon_bg);
    g_wgui_uce_cntx.next_bt = dm_add_button(
                                     NULL, 
                                     (PU8)(current_MMI_theme->UCE_screen_next_button_image),
                                     (PU8)(current_MMI_theme->UCE_screen_next_button_image),
                                     wgui_cat280_clear_icon_bg);
#endif /* #if defined (__MMI_BASIC_UI_STYLE__) || defined(__MMI_SLIM_IMG_RES__) */
#endif /*__MMI_FTE_SUPPORT__*/
    pre_bt = dm_get_button(g_wgui_uce_cntx.pre_bt);
    pre_bt->flags |= (UI_BUTTON_NO_SHIFT_BUTTON | UI_BUTTON_STATE_DISABLED);
    
    next_bt = dm_get_button(g_wgui_uce_cntx.next_bt);
    next_bt->flags |= (UI_BUTTON_NO_SHIFT_BUTTON | UI_BUTTON_STATE_DISABLED);

#if defined(__MMI_FTE_SUPPORT__) && defined(__MMI_TOUCH_SCREEN__)
    pre_bt->draw_down_fp = wgui_cat280_button_draw_down;
    pre_bt->draw_up_fp = wgui_cat280_button_draw_up;
    next_bt->draw_down_fp = wgui_cat280_button_draw_down;
    next_bt->draw_up_fp = wgui_cat280_button_draw_up;
#endif

#if defined(__MMI_TOUCH_SCREEN__)
    dm_register_button_functions(g_wgui_uce_cntx.pre_bt, KEY_EVENT_UP, wgui_cat280_pre_button_hdlr);
    dm_register_button_functions(g_wgui_uce_cntx.next_bt, KEY_EVENT_UP, wgui_cat280_next_button_hdlr);
#endif /* defined(__MMI_TOUCH_SCREEN__) */

#ifdef __WGUI_CAT280_ENHANCED_UI__
    if (g_wgui_uce_cntx.is_attachment)
    {
        /* setup the attache button */
        gui_create_icontext_button(&g_wgui_uce_cntx.attach_button, -1, -1, -1, -1, NULL, get_image(WGUI_UCE_FTE_ATTACHE_BUTTON_NORMAL));
        g_wgui_uce_cntx.attach_button.flags |= UI_BUTTON_DISABLE_BACKGND_DISPLAY | UI_BUTTON_NO_SHIFT_BUTTON;
        g_wgui_uce_cntx.attach_button.flags |= UI_BUTTON_CENTER_ICON_X | UI_BUTTON_CENTER_ICON_Y;
        g_wgui_uce_cntx.attach_button.clicked_down_icon = get_image(WGUI_UCE_FTE_ATTACHE_BUTTON_PRESSED);
        g_wgui_uce_cntx.attach_button.clear_background_fp = wgui_cat280_clear_icon_bg;
#ifdef __MMI_TOUCH_SCREEN__
#ifdef __MMI_FTE_SUPPORT__
        g_wgui_uce_cntx.attach_button.draw_down_fp = wgui_cat280_button_draw_down;
        g_wgui_uce_cntx.attach_button.draw_up_fp = wgui_cat280_button_draw_up;
#endif /* __MMI_FTE_SUPPORT__ */
        wgui_register_category_screen_control_area_pen_handlers(wgui_cat280_pen_down_handler, MMI_PEN_EVENT_DOWN);
        wgui_register_category_screen_control_area_pen_handlers(wgui_cat280_pen_up_handler, MMI_PEN_EVENT_UP);
        wgui_register_category_screen_control_area_pen_handlers(wgui_cat280_pen_repeat_handler, MMI_PEN_EVENT_REPEAT);
        wgui_register_category_screen_control_area_pen_handlers(wgui_cat280_pen_move_handler, MMI_PEN_EVENT_MOVE);
#endif /* __MMI_TOUCH_SCREEN__ */ 
    }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    /* multiline inputbox */
    wgui_inputs_ml_setup_ext2(
        0,
        MMI_content_y,
        MMI_content_width,
        MMI_content_height - MMI_multitap_height,
        g_wgui_uce_cntx.text_buffer,
        g_wgui_uce_cntx.text_buffer_size,
        MMI_CATEGORY280_ID,
        get_string(right_softkey),
        get_image(right_softkey_icon),
        input_method_type,
        NULL,
        NULL,
        MMI_TRUE,
        UI_MULTI_LINE_INPUT_BOX_DRAW_UNDERLINE,
        (S16) (footer_height + header_height + CAT280_MIN_LINE_HEIGHT * 2),
        CAT280_MIN_LINE_HEIGHT,
        (S16) header_height,
        (S16) footer_height,
        NULL,
        wgui_cat280_editor_msg_callback,
        MMI_FALSE);
#else /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
    /* multiline inputbox */
    wgui_setup_inputbox_ext(
        0,
        MMI_content_y,
        MMI_content_width,
        MMI_content_height - MMI_multitap_height,
        g_wgui_uce_cntx.text_buffer,
        g_wgui_uce_cntx.text_buffer_size,
        MMI_CATEGORY280_ID,
        get_string(right_softkey),
        get_image(right_softkey_icon),
        input_method_type,
        gui_buffer,
        NULL,
        MMI_TRUE,
        #ifdef __MMI_MAINLCD_96X64__
        NULL,
        #else /*__MMI_MAINLCD_96X64__*/
        UI_MULTI_LINE_INPUT_BOX_DRAW_UNDERLINE,
        #endif
        (S16) (footer_height + header_height + CAT280_MIN_LINE_HEIGHT * 2),
        CAT280_MIN_LINE_HEIGHT,
        (S16) header_height,
        (S16) footer_height,
        NULL);
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

    /* Hide multiline inputbox floating counter */
    gui_inputs_ml_hide_floating_counter(&MMI_multiline_inputbox, MMI_TRUE);

#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS)  /* MMS */
    {
        wgui_multiline_inputbox_register_infobar_callback(
            wgui_cat280_draw_information_bar,
            wgui_cat280_draw_information_bar,
            CAT280_INFORMATION_BAR_HEIGHT);
    }
    else  /* SMS */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    {
        wgui_multiline_inputbox_register_infobar_callback(
            wgui_cat280_draw_information_bar,
            wgui_cat280_draw_msg_size,
            CAT280_INFORMATION_BAR_HEIGHT_SMS);
    }

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    if (gui_buffer != NULL)
    {
        S32 ml_s = sizeof(multiline_inputbox_category_history);
        ml_s = (ml_s + 3) / 4;
        ml_s *= 4;

        if ((g_wgui_uce_cntx.add_recipient_in_background == MMI_FALSE) &&
            (g_wgui_uce_cntx.add_content_in_background == MMI_FALSE))
        {
            g_wgui_uce_cntx.sl_history = gui_buffer + ml_s;
            
            /* check the history buffer is valid or not */ 
            if ((g_wgui_uce_cntx.sl_history[0] == 0) && g_wgui_uce_cntx.sl_history[1] == 0)
            {
                g_wgui_uce_cntx.sl_history = NULL;
            }
        }
    }

    if (gui_buffer == NULL)
    {
        /* default highlight is on editor or recipients */
        if (g_wgui_uce_cntx.inline_recipients == MMI_FALSE)
        {
            wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_EDITOR);
        }
        else
        {
#ifdef __WGUI_CAT280_SUPPORT_MMS__
            if (g_wgui_uce_cntx.in_change_slide == MMI_TRUE)
            {
                if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_THUMBNAIL && g_wgui_uce_cntx.has_thumbnail == MMI_FALSE)
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_EDITOR, -1);
                }
#ifdef __WGUI_CAT280_ENHANCED_UI__
                else if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_AUDIO && g_wgui_uce_cntx.is_audio == MMI_FALSE)
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_EDITOR, -1);
                }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
                else
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)g_wgui_uce_cntx.highligh_state, g_wgui_uce_cntx.highlight_index);
                }
                wgui_cat280_adjust_editor_scroll_bar();
            }
            else
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
            {
                recipient_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_TO_RECIPIENTS);
                if ((recipient_index >= 0) && 
                    (g_wgui_uce_cntx.recipient[recipient_index].input_buf[0] == 0) && 
                    (g_wgui_uce_cntx.recipient[recipient_index].input_buf[1] == 0))
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_TO_RECIPIENTS, recipient_index);
                }
                else
                {
#ifdef __WGUI_CAT280_SUPPORT_MMS__
                    recipient_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_CC_RECIPIENTS);
                    if ((recipient_index >= 0) && 
                        (g_wgui_uce_cntx.recipient[recipient_index].input_buf[0] == 0) && 
                        (g_wgui_uce_cntx.recipient[recipient_index].input_buf[1] == 0))
                    {
                        wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_CC_RECIPIENTS, recipient_index);
                    }
                    else
                    {
                        recipient_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_BCC_RECIPIENTS);
                        if ((recipient_index >= 0) && 
                            (g_wgui_uce_cntx.recipient[recipient_index].input_buf[0] == 0) && 
                            (g_wgui_uce_cntx.recipient[recipient_index].input_buf[1] == 0))
                        {
                            wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_BCC_RECIPIENTS, recipient_index);
                        }
                        else
                        {
                            if ((g_wgui_uce_cntx.has_editable_subject == MMI_TRUE) &&
                                (g_wgui_uce_cntx.subject.input_buf != NULL) &&
                                (g_wgui_uce_cntx.subject.input_buf[0] == 0) &&
                                (g_wgui_uce_cntx.subject.input_buf[1] == 0))
                            {
                                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_SUBJECT, -1);
                            }
                            else
                            {
                                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_EDITOR, -1);
                            }
                        }
                    }
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_EDITOR, -1);
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
                }
            }
        }
    }
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

#if defined(__WGUI_CAT280_SUPPORT_RECIPIENTS__) || defined(__WGUI_CAT280_SUPPORT_MMS__)
    /* setup multiline inputbox pre key handler */
    wgui_inputs_ml_register_pre_key_handler(wgui_cat280_multiline_inputbox_key_hdlr);
#endif /* defined(__WGUI_CAT280_SUPPORT_RECIPIENTS__) || defined(__WGUI_CAT280_SUPPORT_MMS__) */

    inputbox_height = MMI_content_height - MMI_multitap_height - wgui_inputbox_information_bar_height;

    if (MMI_multiline_inputbox.height > inputbox_height)
    {
        wgui_inputs_ml_resize(MMI_multiline_inputbox.width, inputbox_height);
    }

    /* setup multline inputbox change event handler (before change input buffer will callback) */
    wgui_multiline_inputbox_register_change_event_handler(wgui_cat280_editor_change_event_callback);

#ifdef __WGUI_CAT280_SUPPORT_MMS__
    if (g_wgui_uce_cntx.msg_type == WGUI_UCE_MSG_TYPE_MMS)  /* MMS */
    {
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
        if (g_wgui_uce_cntx.inline_recipients == MMI_TRUE)
        {
            MMI_multiline_inputbox.header_callback = wgui_cat280_draw_object_and_subject_and_recipients;
            
            if (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM ||
                g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)
            {
                MMI_multiline_inputbox.footer_callback = wgui_cat280_draw_object;
            }
        }
        else
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
        {
        #ifdef __WGUI_CAT280_ENHANCED_UI__
            if (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP ||
                g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)
            {
                MMI_multiline_inputbox.header_callback = wgui_cat280_draw_object_and_subject;
            }
            else if ((g_wgui_uce_cntx.subject_firstline != NULL) || (g_wgui_uce_cntx.subject_secondline != NULL))
            {
                MMI_multiline_inputbox.header_callback = wgui_cat280_draw_subject;
            }
            
            if (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM ||
                g_wgui_uce_cntx.audio_layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)
            {
                MMI_multiline_inputbox.footer_callback = wgui_cat280_draw_object;

            }
        #else /* __WGUI_CAT280_ENHANCED_UI__ */
            if (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_TOP)
            {
                MMI_multiline_inputbox.header_callback = wgui_cat280_draw_object_and_subject;
            }
            else if (g_wgui_uce_cntx.layout == WGUI_UCE_LAYOUT_TYPE_THUMBNAIL_AT_BOTTOM)
            {
                MMI_multiline_inputbox.footer_callback = wgui_cat280_draw_object;
                if ((g_wgui_uce_cntx.subject_firstline != NULL) || (g_wgui_uce_cntx.subject_secondline != NULL))
                {
                    MMI_multiline_inputbox.header_callback = wgui_cat280_draw_subject;
                }
            }
            
            if (gui_buffer != NULL)
            {
                wgui_cat280_history_cntx *h;
                S32 size = sizeof(multiline_inputbox_category_history);
                size = (size + 3) / 4;
                size *= 4;
                h = (wgui_cat280_history_cntx*)(gui_buffer + size);
                
                if (((h->highlight_state == WGUI_UCE_HIGHLIGHT_SUBJECT) && (g_wgui_uce_cntx.subject_firstline)) ||
                    ((h->highlight_state == WGUI_UCE_HIGHLIGHT_THUMBNAIL) && (g_wgui_uce_cntx.has_thumbnail)) ||
                    ((h->highlight_state == WGUI_UCE_HIGHLIGHT_AUDIO) && (g_wgui_uce_cntx.is_audio)))
                {
                    wgui_cat280_set_highlight_state(h->highlight_state);
                }
                else
                {
                    wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_EDITOR);
                }
            }
            else
            {
                /* default highlight is on editor */
                wgui_cat280_set_highlight_state(WGUI_UCE_HIGHLIGHT_EDITOR);
            }
        #endif /* __WGUI_CAT280_ENHANCED_UI__ */
        }

        /* touch editor callback */
#ifdef __MMI_TOUCH_SCREEN__
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
        if (g_wgui_uce_cntx.inline_recipients == MMI_TRUE)
        {
            gui_inputs_ml_register_pen_control_area_callback(&MMI_multiline_inputbox, wgui_cat280_editor_control_area_pen_callback);
        }
        else
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
        {
        #ifdef __MMI_FTE_SUPPORT__
            gui_inputs_ml_register_pen_control_area_callback(&MMI_multiline_inputbox, wgui_cat280_editor_pen_up_callback);
        #else
            MMI_multiline_inputbox.pen_down_control_area_callback = wgui_cat280_editor_pen_down_callback;
        #endif
        }
#endif /* __MMI_TOUCH_SCREEN__ */

        wgui_inputs_ml_register_pre_delete_callback(wgui_cat280_adjust_cursor_position);
    }
    else  /* SMS */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
    {
#if defined(__MMI_FTE_SUPPORT__) && defined(__WGUI_CAT280_SUPPORT_MMS__)
        /* just for callback to app */
        if (g_wgui_cat280_callback.get_message_size != NULL)
        {
            //msg_size = g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, g_wgui_uce_cntx.msg_type);
            g_wgui_cat280_callback.get_message_size(&g_wgui_uce_cntx.text_info, g_wgui_uce_cntx.msg_type);
        }
        
        if (g_wgui_cat280_callback.get_display_type != NULL)
        {
            //type = g_wgui_cat280_callback.get_display_type();
            g_wgui_cat280_callback.get_display_type();
        }
#endif /* defined(__MMI_FTE_SUPPORT__) && defined(__WGUI_CAT280_SUPPORT_MMS__) */

        /* touch editor callback */
#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
        if (g_wgui_uce_cntx.inline_recipients == MMI_TRUE)
        {
    #ifdef __MMI_TOUCH_SCREEN__
            gui_inputs_ml_register_pen_control_area_callback(&MMI_multiline_inputbox, wgui_cat280_editor_control_area_pen_callback);
    #endif /* __MMI_TOUCH_SCREEN__ */
            MMI_multiline_inputbox.header_callback = wgui_cat280_draw_object_and_subject_and_recipients;
        }
        else
#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
        {
    #ifdef __WGUI_CAT280_SUPPORT_MMS__
            if ((g_wgui_uce_cntx.subject_firstline != NULL) || (g_wgui_uce_cntx.subject_secondline != NULL))
            {
                MMI_multiline_inputbox.header_callback = wgui_cat280_draw_subject;
            }
    #endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        }
    }

#ifdef __WGUI_CAT280_SUPPORT_RECIPIENTS__
    if (gui_buffer != NULL)
    {
        wgui_cat280_history_cntx *h;
        S32 ml_s = sizeof(multiline_inputbox_category_history);
        S32 sl_s = sizeof(singleline_inputbox_category_history);

        ml_s = (ml_s + 3) / 4;
        ml_s *= 4;
        sl_s = (sl_s + 3) / 4;
        sl_s *= 4;

        wgui_inputs_ml_set_category_history(MMI_CATEGORY280_ID, gui_buffer);

        if (g_wgui_uce_cntx.add_recipient_in_background == MMI_FALSE)
        {
            //wgui_inputs_ml_set_category_history(MMI_CATEGORY280_ID, gui_buffer);

            if (g_wgui_uce_cntx.add_content_in_background == MMI_FALSE)
            {
                g_wgui_uce_cntx.sl_history = gui_buffer + ml_s;

                /* check the history buffer is valid or not */ 
                if ((g_wgui_uce_cntx.sl_history[0] == 0) && g_wgui_uce_cntx.sl_history[1] == 0)
                {
                    g_wgui_uce_cntx.sl_history = NULL;
                }
            }
        }

        h = (wgui_cat280_history_cntx*)(gui_buffer + ml_s + sl_s);

#ifdef __WGUI_CAT280_SUPPORT_MMS__
        if (((h->highlight_state == WGUI_UCE_THUMBNAIL) && (g_wgui_uce_cntx.has_thumbnail == MMI_FALSE)))
        {
            h->highlight_state = WGUI_UCE_HIGHLIGHT_EDITOR;
        }
#ifdef __WGUI_CAT280_ENHANCED_UI__
        if (((h->highlight_state == WGUI_UCE_HIGHLIGHT_AUDIO) && (g_wgui_uce_cntx.is_audio == MMI_FALSE)))
        {
            h->highlight_state = WGUI_UCE_HIGHLIGHT_EDITOR;
        }
#endif /* __WGUI_CAT280_ENHANCED_UI__ */
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

        g_wgui_uce_cntx.need_to_set_ml_ime = h->need_to_set_ml_ime;
        g_wgui_uce_cntx.need_to_set_sl_ime = h->need_to_set_sl_ime;
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        g_wgui_uce_cntx.need_to_set_subject_ime = h->need_to_set_subject_ime;
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */
        gui_memcpy(&g_wgui_uce_cntx.ml_ime, &(h->ml_ime), sizeof(mmi_imc_history));
        gui_memcpy(&g_wgui_uce_cntx.sl_ime, &(h->sl_ime), sizeof(mmi_imc_history));
#ifdef __WGUI_CAT280_SUPPORT_MMS__
        gui_memcpy(&g_wgui_uce_cntx.subject_ime, &(h->subject_ime), sizeof(mmi_imc_history));
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

        wgui_inputs_disconnect();
        
        recipient_index = wgui_cat280_get_highlight_index();
        if (recipient_index < 0)
        {
            if ((g_wgui_uce_cntx.add_recipient_in_background == MMI_TRUE) &&
                (g_wgui_uce_cntx.highlight_index != -1))
            {
                wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)g_wgui_uce_cntx.highligh_state, g_wgui_uce_cntx.highlight_index);
            }
            else
            {
#ifdef __WGUI_CAT280_SUPPORT_MMS__
                S32 to_recipient_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_TO_RECIPIENTS);
                S32 cc_recipient_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_CC_RECIPIENTS);
                S32 bcc_recipient_index = wgui_cat280_get_first_recipient_index(WGUI_UCE_BCC_RECIPIENTS);

                if ((h->highlight_state == WGUI_UCE_TO_RECIPIENTS) && (to_recipient_index < 0))
                {
                    h->highlight_state = (wgui_uce_highlight_state_enum)WGUI_UCE_CC_RECIPIENTS;
                    h->highlight_index = cc_recipient_index;
                    g_wgui_uce_cntx.sl_history = NULL;
                }

                if ((h->highlight_state == WGUI_UCE_CC_RECIPIENTS) && (cc_recipient_index < 0))
                {
                    h->highlight_state = (wgui_uce_highlight_state_enum)WGUI_UCE_BCC_RECIPIENTS;
                    h->highlight_index = bcc_recipient_index;
                    g_wgui_uce_cntx.sl_history = NULL;
                }

                if ((h->highlight_state == WGUI_UCE_BCC_RECIPIENTS) && (bcc_recipient_index < 0))
                {
                    h->highlight_state = (wgui_uce_highlight_state_enum)WGUI_UCE_SUBJECT;
                    h->highlight_index = -1;
                    g_wgui_uce_cntx.sl_history = NULL;
                }

                if ((h->highlight_state == WGUI_UCE_SUBJECT) && (g_wgui_uce_cntx.has_editable_subject != MMI_TRUE))
                {
                    h->highlight_state = (wgui_uce_highlight_state_enum)WGUI_UCE_EDITOR;
                    h->highlight_index = -1;
                    g_wgui_uce_cntx.sl_history = NULL;
                }
#else /* __WGUI_CAT280_SUPPORT_MMS__ */
                if ((h->highlight_state == WGUI_UCE_TO_RECIPIENTS) && 
                    (wgui_cat280_get_first_recipient_index(WGUI_UCE_TO_RECIPIENTS) < 0))
                {
                    h->highlight_state = WGUI_UCE_EDITOR;
                    h->highlight_index = -1;
                    g_wgui_uce_cntx.sl_history = NULL;
                }
#endif /* __WGUI_CAT280_SUPPORT_MMS__ */

                if (h->highlight_index < 0)
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)h->highlight_state, h->highlight_index);
                }
                else if (g_wgui_uce_cntx.recipient[h->highlight_index].region_id == h->highlight_state)
                {
                    wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)h->highlight_state, h->highlight_index);
                }
                else
                {
                    MMI_BOOL is_highlighted = MMI_FALSE;
                    S32 i;
                    for (i = h->highlight_index - 1; i >= 0; i--)
                    {
                        if ((g_wgui_uce_cntx.recipient[i].is_valid == MMI_TRUE) &&
                            (g_wgui_uce_cntx.recipient[i].region_id == h->highlight_state) &&
                            (is_highlighted == MMI_FALSE))
                        {
                            wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)h->highlight_state, i);
                            is_highlighted = MMI_TRUE;

                        }
                    }
                    if (is_highlighted == MMI_FALSE)
                    {
                        wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)WGUI_UCE_EDITOR, -1);
                    }
                    wgui_inputs_ml_set_category_history(MMI_CATEGORY280_ID, gui_buffer);
                }
            }
        }
        else
        {
            g_wgui_uce_cntx.sl_history = NULL;
            wgui_cat280_set_highlight_state_and_index((wgui_uce_highlight_state_enum)g_wgui_uce_cntx.recipient[recipient_index].region_id, recipient_index);
        }
    }
#else /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */
    if (g_wgui_uce_cntx.highligh_state == WGUI_UCE_HIGHLIGHT_EDITOR)
    {
        wgui_inputs_ml_enable();
        //wgui_inputs_ml_redraw();
    }

#endif /* __WGUI_CAT280_SUPPORT_RECIPIENTS__ */

#ifdef __MMI_WALLPAPER_ON_BOTTOM__
    MMI_multiline_inputbox.flags |= UI_MULTI_LINE_INPUT_BOX_TRANSPARENT_BACKGROUND;
    dm_get_scr_bg_opacity(&g_wgui_cat280_screen_info->scr_bg_opacity);
    dm_set_scr_bg_opacity((U8)(current_MMI_theme->bg_opacity_low));
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */ 

    gui_unlock_double_buffer();

    /* Setup standard category handler */
    ExitCategoryFunction = ExitCategory280Screen;
    dm_setup_category_functions(dm_redraw_category_screen, GetCategory280History, GetCategory280HistorySize);
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = MMI_CATEGORY280_ID;
    dm_data.s32flags = DM_CLEAR_SCREEN_BACKGROUND | DM_SHOW_VKPAD;
#if !defined(GUI_EDITOR_SHOW_TITLE)
    dm_data.s32flags |= DM_NO_TITLE;
#endif /* !defined(GUI_EDITOR_SHOW_TITLE) */
    dm_setup_data(&dm_data);
    dm_register_vkpad_callback(mmi_imc_redraw_screen_by_state);
    dm_redraw_category_screen();
}

//#endif /* __UI_UNIFIED_COMPOSER_EDITOR_CATEGORY__ */


