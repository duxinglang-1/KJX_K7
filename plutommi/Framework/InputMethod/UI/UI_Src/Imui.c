/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 *    imui_api.c
 *
 * Project:
 * --------
 *   Maui_Software
 *
 * Description:
 * ------------
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/

#include "MMI_features.h"

#include "mmi_include.h"
#include "lcd_sw_rnd.h"
#include "wgui_softkeys.h"
#include "PhoneSetupGprots.h"
#include "gui_virtual_keyboard.h"
#include "wgui_virtual_keyboard.h"
#include "wgui_status_icon_bar.h"
#include "PixcomFontEngine.h"
#include "BIDIDef.h"
#include "ImmProt.h"
#include "imui.h"
#include "Imc.h"

#ifdef __MMI_TOUCH_SCREEN__
#include "Imc_pen.h"
#endif

#if defined(__MMI_INDIC_ALG__)
#include "IndicEngineGprot.h"
#endif /* __MMI_INDIC_ALG__ */

#include "LangModuleGProt.h"

#ifdef __MMI_VUI_ENGINE__
#include "framework\vadp_p2v_uc.h"
#include "ime\vadp_p2v_input_server_interface.h"
#endif

#ifdef __MMI_CLIPBOARD_FLOATING_MENU__
#include "CommonScreensResDef.h"
#include "CommonScreens.h"
#endif

#ifdef __MMI_IME_PLUG_IN__
#include "ImeSDKGprot.h"
#include "ImeSDKProt.h"
#endif

#include "gui_font_size.h"

#include "gui_touch_feedback.h"

/*RHR check in*/
#include "wgui_fixed_menus.h"/*Included after RHR build error*/
#include"TimerEvents.h"/*Included after RHR build error*/
#include "mmi_rp_srv_editor_def.h"
#include "gui_fixed_menuitems.h"
#include "MMIDataType.h"
#include "ImeGprot.h"
#include "gui_data_types.h"
#include "CustThemesRes.h"
#include "gui_theme_struct.h"
#include "gui_themes.h"
//#include "kal_general_types.h"
#include "gdi_const.h"
#include "gdi_datatype.h"
#include "gui_virtual_keyboard_language_type.h"
#include "mmi_frm_input_gprot.h"
#include "wgui_include.h"
#include "wgui.h"
#include "string.h"
#include "wgui_inputs.h"
#include "gdi_include.h"
#include "gdi_image.h"
#include "mmi_frm_mem_gprot.h"
//#include "kal_public_api.h"
#include "DebugInitDef_Int.h"
#include "lcd_sw_inc.h"
#include "gui_inputs.h"
#include "wgui_categories_util.h"
#include "gui.h"
#include "gui_typedef.h"
#include "IMERes.h"
#include "mmi_rp_app_uiframework_def.h"
#include "gui_config.h"
#include "Imc_config.h"
#include "Unicodexdcl.h"
#include "Word_engine.h"
/*RHR check-in*/

#if defined(__COSMOS_MMI__)
#include "mmi_rp_srv_input_method_def.h"
#endif

#include "wgui_draw_manager.h"

/*****************************************************************************
 *  Define
 *****************************************************************************/
#if defined(GDI_2_LAYERS) && !defined(__MMI_IME_FTE_ENHANCE__)
#define MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER
#endif

#if !defined(PEN_CHECK_BOUND)
#define PEN_CHECK_BOUND(x, y, x1, y1, width, height) ((x) >= (x1) && (y) >= (y1) && (x) < ((x1) + (width)) && (y) < ((y1) + (height)))
#endif

#if !defined(MIN)
#define MIN(a, b) (((a) > (b)) ? (b) : (a))
#endif

#if !defined(MAX)
#define MAX(a, b) (((a) > (b)) ? (a) : (b))
#endif

/* Coordinates */
#ifdef __MMI_IME_FTE_ENHANCE__
#define MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP    0
#define MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP       0
#else
#define MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP    1
#define MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP       1
#endif

#if defined(__MMI_MAINLCD_480X800__)
    #define MMI_IMUI_SELECTION_AREA_VER_GAP     5
#else
    #define MMI_IMUI_SELECTION_AREA_VER_GAP     3
#endif
#define MMI_IMUI_INPUT_AREA_VER_GAP             3

#ifdef __MMI_IME_FTE_ENHANCE__
    #if defined(__MMI_MAINLCD_240X320__) || defined(__MMI_MAINLCD_240X400__)
        #define MMI_IMUI_SELECTION_AREA_WIDTH   232 /* Including the frame */
    #elif defined(__MMI_MAINLCD_320X240__)
         #define MMI_IMUI_SELECTION_AREA_WIDTH   232 /* Including the frame */
    #elif defined(__MMI_MAINLCD_320X480__)
        #define MMI_IMUI_SELECTION_AREA_WIDTH   300 /* Including the frame */
    #elif defined(__MMI_MAINLCD_480X800__)
        #define MMI_IMUI_SELECTION_AREA_WIDTH   440 /* Including the frame */
    #else
        #error "This resolution doesn't support FTE" 
    #endif
#endif



#ifdef __MMI_IME_FTE_ENHANCE__
    #if defined(__MMI_MAINLCD_240X320__) || defined(__MMI_MAINLCD_240X400__)
        #define MMI_IMUI_CANDIDATE_BOX_LEFT_GAP     ((240 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
        #define MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP    ((240 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
    #elif defined(__MMI_MAINLCD_320X240__)
        #define MMI_IMUI_CANDIDATE_BOX_LEFT_GAP     ((240 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
        #define MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP    ((240 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
    #elif defined(__MMI_MAINLCD_320X480__)
        #define MMI_IMUI_CANDIDATE_BOX_LEFT_GAP     ((320 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
        #define MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP    ((320 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
    #elif defined(__MMI_MAINLCD_480X800__)
        #define MMI_IMUI_CANDIDATE_BOX_LEFT_GAP     ((480 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
        #define MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP    ((480 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
    #else
        #error "This resolution doesn't support FTE" 
    #endif
	#if defined(__MMI_IME_V3__)
        #undef MMI_IMUI_CANDIDATE_BOX_LEFT_GAP
        #undef MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP
		#define MMI_IMUI_CANDIDATE_BOX_LEFT_GAP      0
        #define MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP    0
	#endif
    #define MMI_IMUI_CANDIDATE_BOX_TOP_GAP      0
    #define MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP   0
#elif defined(__MMI_MAINLCD_128X64__)
#define MMI_IMUI_CANDIDATE_BOX_TOP_GAP          0
#define MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP       0
#define MMI_IMUI_CANDIDATE_BOX_LEFT_GAP         0
#define MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP        0
#else
#define MMI_IMUI_CANDIDATE_BOX_TOP_GAP          1
#define MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP       1
#define MMI_IMUI_CANDIDATE_BOX_LEFT_GAP         1
#define MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP        1
#endif

#if defined(__MMI_MAINLCD_480X800__)
#define MMI_IMUI_FLOATING_INDICATOR_WIDTH 53 
#define MMI_IMUI_FLOATING_INDICATOR_HEIGHT 22
#define MMI_IMUI_FLOATING_INDICATOR_BOTTOM_GAP 2
#define MMI_IMUI_FLOATING_INDICATOR_TEXT_SIZE 18 
#elif defined(__MMI_MAINLCD_320X480__)
#define MMI_IMUI_FLOATING_INDICATOR_WIDTH 36 
#define MMI_IMUI_FLOATING_INDICATOR_HEIGHT 18
#define MMI_IMUI_FLOATING_INDICATOR_BOTTOM_GAP 1
#define MMI_IMUI_FLOATING_INDICATOR_TEXT_SIZE 14
#elif defined(__MMI_MAINLCD_240X320__) || defined(__MMI_MAINLCD_240X400__)
#define MMI_IMUI_FLOATING_INDICATOR_WIDTH 32 
#define MMI_IMUI_FLOATING_INDICATOR_HEIGHT 16
#define MMI_IMUI_FLOATING_INDICATOR_BOTTOM_GAP 1
#define MMI_IMUI_FLOATING_INDICATOR_TEXT_SIZE 12 
#elif defined(__MMI_MAINLCD_320X240__)
#define MMI_IMUI_FLOATING_INDICATOR_WIDTH 32 
#define MMI_IMUI_FLOATING_INDICATOR_HEIGHT 16
#define MMI_IMUI_FLOATING_INDICATOR_BOTTOM_GAP 1
#define MMI_IMUI_FLOATING_INDICATOR_TEXT_SIZE 12 
#else
#define MMI_IMUI_FLOATING_INDICATOR_WIDTH 32 
#define MMI_IMUI_FLOATING_INDICATOR_HEIGHT 16
#define MMI_IMUI_FLOATING_INDICATOR_BOTTOM_GAP 1
#define MMI_IMUI_FLOATING_INDICATOR_TEXT_SIZE 12 
#endif

#ifdef __MMI_IME_FTE_ENHANCE__
#define MMI_IMUI_CANDIDATE_BOX_INTER_BORDER_WIDTH    1  
#define MMI_IMUI_CANDIDATE_BOX_EXTER_BORDER_WIDTH    3  /* The highlight frame */
#elif defined(__MMI_MAINLCD_128X64__)
#define MMI_IMUI_CANDIDATE_BOX_INTER_BORDER_WIDTH    0  
#define MMI_IMUI_CANDIDATE_BOX_EXTER_BORDER_WIDTH    0 
#else
#define MMI_IMUI_CANDIDATE_BOX_INTER_BORDER_WIDTH    1  
#define MMI_IMUI_CANDIDATE_BOX_EXTER_BORDER_WIDTH    0  /* No exter highlight frame */
#endif

#define MMI_IMUI_CANDIDATE_BOX_BORDER_WIDTH (MMI_IMUI_CANDIDATE_BOX_INTER_BORDER_WIDTH + MMI_IMUI_CANDIDATE_BOX_EXTER_BORDER_WIDTH)

#ifdef __MMI_IME_FTE_ENHANCE__
    #if defined(__MMI_MAINLCD_240X320__) || defined(__MMI_MAINLCD_240X400__)
        #define MMI_IMUI_COMPOSITION_BOX_LEFT_GAP     ((240 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
        #define MMI_IMUI_COMPOSITION_BOX_RIGHT_GAP    ((240 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
    #elif defined(__MMI_MAINLCD_320X240__)
        #define MMI_IMUI_COMPOSITION_BOX_LEFT_GAP     ((240 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
        #define MMI_IMUI_COMPOSITION_BOX_RIGHT_GAP    ((240 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
    #elif defined(__MMI_MAINLCD_320X480__)
        #define MMI_IMUI_COMPOSITION_BOX_LEFT_GAP     ((320 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
        #define MMI_IMUI_COMPOSITION_BOX_RIGHT_GAP    ((320 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
    #elif defined(__MMI_MAINLCD_480X800__)
        #define MMI_IMUI_COMPOSITION_BOX_LEFT_GAP     ((480 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
        #define MMI_IMUI_COMPOSITION_BOX_RIGHT_GAP    ((480 - MMI_IMUI_SELECTION_AREA_WIDTH) / 2)
    #else
        #error "This resolution doesn't support FTE" 
    #endif
    #define MMI_IMUI_COMPOSITION_BOX_BOTTOM_GAP     0
    #define MMI_IMUI_COMPOSITION_BOX_TOP_GAP        0
#elif defined(__MMI_MAINLCD_128X64__)
#define MMI_IMUI_COMPOSITION_BOX_BOTTOM_GAP     0
#define MMI_IMUI_COMPOSITION_BOX_TOP_GAP        0
#define MMI_IMUI_COMPOSITION_BOX_LEFT_GAP       0
#define MMI_IMUI_COMPOSITION_BOX_RIGHT_GAP      0
#else
#define MMI_IMUI_COMPOSITION_BOX_BOTTOM_GAP     1
#define MMI_IMUI_COMPOSITION_BOX_TOP_GAP        1
#define MMI_IMUI_COMPOSITION_BOX_LEFT_GAP       1
#define MMI_IMUI_COMPOSITION_BOX_RIGHT_GAP      1
#endif


#define MMI_IMUI_INPUT_BOX_BOTTOM_GAP     0
#define MMI_IMUI_INPUT_BOX_TOP_GAP        0
#define MMI_IMUI_INPUT_BOX_LEFT_GAP       1
#define MMI_IMUI_INPUT_BOX_RIGHT_GAP      1

#define MMI_IMUI_TITLE_BOX_BOTTOM_GAP     0
#define MMI_IMUI_TITLE_BOX_TOP_GAP        0
#define MMI_IMUI_TITLE_BOX_LEFT_GAP       1
#define MMI_IMUI_TITLE_BOX_RIGHT_GAP      1

#define MMI_IMUI_MULTIBLOCK_BOTTOM_GAP          1
#define MMI_IMUI_MULTIBLOCK_TOP_GAP             1
#define MMI_IMUI_MULTIBLOCK_LEFT_GAP            1
#define MMI_IMUI_MULTIBLOCK_RIGHT_GAP           1

#if defined(__MMI_IME_FTE_ENHANCE__)
    #if defined(__MMI_MAINLCD_240X400__) || defined(__MMI_MAINLCD_240X320__)
        #define MMI_IMUI_CANDIDATE_LEFT_SPACING         10
        #define MMI_IMUI_CANDIDATE_RIGHT_SPACING        10
    #elif defined(__MMI_MAINLCD_320X240__)
        #define MMI_IMUI_CANDIDATE_LEFT_SPACING         10
        #define MMI_IMUI_CANDIDATE_RIGHT_SPACING        10
    #elif defined(__MMI_MAINLCD_320X480__)   
        #define MMI_IMUI_CANDIDATE_LEFT_SPACING         15
        #define MMI_IMUI_CANDIDATE_RIGHT_SPACING        15
    #elif defined(__MMI_MAINLCD_480X800__)   
        #define MMI_IMUI_CANDIDATE_LEFT_SPACING         20
        #define MMI_IMUI_CANDIDATE_RIGHT_SPACING        20
    #else
        #error "This resolution doesn't support FTE" 
    #endif
#elif defined(__MMI_TOUCH_SCREEN__)
#define MMI_IMUI_CANDIDATE_LEFT_SPACING         0
#define MMI_IMUI_CANDIDATE_RIGHT_SPACING        0
#elif defined(__MMI_MAINLCD_128X64__)
#define MMI_IMUI_CANDIDATE_LEFT_SPACING         0
#define MMI_IMUI_CANDIDATE_RIGHT_SPACING        0
#else
#define MMI_IMUI_CANDIDATE_LEFT_SPACING         1
#define MMI_IMUI_CANDIDATE_RIGHT_SPACING        1
#endif

#ifdef __MMI_IME_FTE_ENHANCE__
#define MMI_IMUI_SLECTION_AREA_LEFT_SPACING     0
#define MMI_IMUI_SLECTION_AREA_RIGHT_SPACING    0
#elif defined(__MMI_MAINLCD_128X64__)
#define MMI_IMUI_SLECTION_AREA_LEFT_SPACING     0
#define MMI_IMUI_SLECTION_AREA_RIGHT_SPACING    0
#else
#define MMI_IMUI_SLECTION_AREA_LEFT_SPACING     2
#define MMI_IMUI_SLECTION_AREA_RIGHT_SPACING    2
#endif

#define MMI_IMUI_INPUT_AREA_LEFT_SPACING     2
#define MMI_IMUI_INPUT_AREA_RIGHT_SPACING    2

#ifdef __MMI_IME_FTE_ENHANCE__
#define MMI_IMUI_ARROW_LEFT_SPACING             1
#define MMI_IMUI_ARROW_RIGHT_SPACING            0
#elif defined(__MMI_MAINLCD_128X64__)
#define MMI_IMUI_ARROW_LEFT_SPACING             0
#define MMI_IMUI_ARROW_RIGHT_SPACING            0
#else
#define MMI_IMUI_ARROW_LEFT_SPACING             2
#define MMI_IMUI_ARROW_RIGHT_SPACING            2
#endif

#define MMI_IMUI_STAR_LEFT_SPACING              1
#define MMI_IMUI_STAR_RIGHT_SPACING             1
#if defined(__MMI_MAINLCD_128X64__)
#define MMI_IMUI_LABEL_LEFT_SPACING             0
#define MMI_IMUI_LABEL_RIGHT_SPACING            0

#define MMI_IMUI_CANDIDATE_SPACE_WIDTH          0
#else
#define MMI_IMUI_LABEL_LEFT_SPACING             1
#define MMI_IMUI_LABEL_RIGHT_SPACING            1

#define MMI_IMUI_CANDIDATE_SPACE_WIDTH          3
#endif

#if defined(__MMI_MAINLCD_320X240__)
#define MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM    60 /* May be configed by resolution? */
#elif defined(__MMI_MAINLCD_480X800__)
#define MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM    70 /* May be configed by resolution? */
#else
#define MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM    50
#endif

#define MMI_IMUI_CURSOR_WIDTH                   1
#define MMI_IMUI_CURSOR_HEIGHT                  7

#if defined(__MMI_IME_CANDIDATE_GRID__)
#define MMI_IMUI_CAND_GRID_EXPAND_HEIGHT        15      
#define MMI_IMUI_CAND_GRID_BORDER_WIDTH          2
#define MMI_IMUI_CAND_GRID_EXPAND_GAP               3
 #if defined(__MMI_MAINLCD_240X320__) 
 #define MMI_IMUI_CAND_GRID_EXPAND_WIDTH                     38 
 #elif defined(__MMI_MAINLCD_240X400__) 
 #define MMI_IMUI_CAND_GRID_EXPAND_WIDTH                     40 
 #elif defined(__MMI_MAINLCD_320X240__)
 #define MMI_IMUI_CAND_GRID_EXPAND_WIDTH                     52 
 #elif defined(__MMI_MAINLCD_320X480__) 
 #define MMI_IMUI_CAND_GRID_EXPAND_WIDTH                     52 
 #elif defined(__MMI_MAINLCD_480X800__) 
 #define MMI_IMUI_CAND_GRID_EXPAND_WIDTH                     54 
 #endif 

#endif

#if defined(__MMI_TOUCH_SCREEN__)
#define MMI_IMUI_ARROW_WIDTH                    8
#define MMI_IMUI_ARROW_HEIGHT                   14
#else
#define MMI_IMUI_ARROW_WIDTH                    3
#define MMI_IMUI_ARROW_HEIGHT                   6
#endif

#define MMI_IMUI_IME_HINT_LEFT_GAP              2
#define MMI_IMUI_IME_HINT_RIGHT_GAP             2

#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
#define MMI_IMUI_QWERTY_SWITCH_ICON_GAP         5
#endif
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
//need to define as per resolution
#define MMI_IMUI_VERTICAL_COMPOSITION_BOX_BORDER_WIDTH 1
#define MMI_IMUI_VERTICAL_COMPOSITION_BOX_HEIGHT 205
#define MMI_IMUI_VERTICAL_COMPOSITION_BOX_WIDTH 54
#endif

#if defined(__MMI_IME_FLOATING_CAND_BOX__)
#define MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR 2
#if defined(__MMI_IME_FTE_ENHANCE__)
#define MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE 0 /* Should be defined by LCD resolutions */
#else
#define MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE 26
#endif
#define MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH 1 /* Virtiacal list border is out of list component */
#define MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_ITEM_COUNT   3
#define MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_MIN_ITEM_COUNT 2

/* Should be defined by LCD resolutions */
#define MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_HEIGHT (MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_ITEM_COUNT * MMI_MENUITEM_HEIGHT) 
#endif

#if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
#if defined(__MMI_MAINLCD_480X800__)
#define MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_LEFT_SPACEING     9
#define MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_RIGHT_SPACEING    9
#else
#define MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_LEFT_SPACEING     8
#define MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_RIGHT_SPACEING    8
#endif
#define MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT  0
#define MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_VER_GAP           1
#endif

#ifdef __MMI_IME_FTE_ENHANCE__
    #if defined(__MMI_MAINLCD_240X320__)
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_SMALL            28
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_MEDIUM           34
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_LARGE            40
        
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_SMALL      22
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_MEDIUM     28
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_LARGE      34
        
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_WIDTH             28

        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_SMALL  22
        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_MEDIUM 28
        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_LARGE  34

        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_WIDTH         28

        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_SMALL  22
        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_MEDIUM 28
        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_LARGE  34

        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_WIDTH         1

        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_SMALL           28
        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_MEDIUM          34
        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_LARGE           40
    #elif defined(__MMI_MAINLCD_320X240__)
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_SMALL            28
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_MEDIUM           34
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_LARGE            40
        
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_SMALL      22
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_MEDIUM     28
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_LARGE      34
        
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_WIDTH             28

        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_SMALL  22
        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_MEDIUM 28
        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_LARGE  34

        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_WIDTH         28

        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_SMALL  22
        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_MEDIUM 28
        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_LARGE  34

        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_WIDTH         1

        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_SMALL           28
        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_MEDIUM          34
        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_LARGE           40
    #elif defined(__MMI_MAINLCD_240X400__)
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_SMALL            32
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_MEDIUM           38
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_LARGE            46
        
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_SMALL      26
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_MEDIUM     32
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_LARGE      40
        
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_WIDTH             30

        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_SMALL  26
        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_MEDIUM 32
        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_LARGE  40

        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_WIDTH         30

        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_SMALL  26
        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_MEDIUM 32
        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_LARGE  40

        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_WIDTH         1

        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_SMALL           32
        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_MEDIUM          38
        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_LARGE           46
    #elif defined(__MMI_MAINLCD_320X480__)
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_SMALL            32
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_MEDIUM           38
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_LARGE            46
        
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_SMALL      26
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_MEDIUM     32
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_LARGE      40
        
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_WIDTH             32

        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_SMALL  26
        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_MEDIUM 32
        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_LARGE  40

        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_WIDTH         32

        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_SMALL  26
        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_MEDIUM 32
        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_LARGE  40

        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_WIDTH         1

        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_SMALL           32
        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_MEDIUM          38
        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_LARGE           46
    
    #elif defined(__MMI_MAINLCD_480X800__)
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_SMALL            48
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_MEDIUM           63
        #define MMI_IMUI_FTE_CAND_BOX_HEIGHT_LARGE            73
        
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_SMALL      42
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_MEDIUM     57
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_LARGE      67
        
        #define MMI_IMUI_FTE_CAND_BOX_ARROW_WIDTH             44

        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_SMALL  42
        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_MEDIUM 57
        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_HEIGHT_LARGE  67

        #define MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_WIDTH         44

        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_SMALL  42
        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_MEDIUM 57
        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_HEIGHT_LARGE  67

        #define MMI_IMUI_FTE_CAND_BOX_SEPARATOR_WIDTH         1

        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_SMALL           48
        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_MEDIUM          63
        #define MMI_IMUI_FTE_INPUT_BOX_HEIGHT_LARGE           73
    #else
        #error "This resolution doesn't support FTE" 
    #endif
#endif


/* Buffer size */
#define MMI_IMUI_MAX_CANDIDATE_SIZE   (20)
#define MMI_IMUI_MAX_COMPOSITION_SIZE 128

#define MMI_IMUI_VK_MAX_DISABLE_EVENTS  20

#define MMI_IMUI_VK_MAX_SET_CHAR  100

/* Clipboard floating menu */
#ifdef __MMI_CLIPBOARD_FLOATING_MENU__
#ifdef __MMI_MAINLCD_480X800__
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_GAP_FROM_CURSOR  1
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_WIDTH      34
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_HEIGHT     16
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_OVERLAP    5
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_VIS_HEIGHT  (MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_HEIGHT - MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_OVERLAP)
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_BOTTOM_GAP       1
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_TOP_GAP          1
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_LEFT_GAP         1
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_RIGHT_GAP        1
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_HEIGHT           60
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_TOTAL_HEIGHT     (MMI_IMUI_CLIPBOARD_FLOATING_MENU_HEIGHT + MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_VIS_HEIGHT)
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_TEXT_X_GAP       15
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_TEXT_X_GAP_N     5    /* if the menu width large the LCD with, use this gap*/
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_HIGHLIGHT_HEIGHT 25
#else
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_GAP_FROM_CURSOR  1
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_WIDTH      34
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_HEIGHT     16
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_OVERLAP    5
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_VIS_HEIGHT  (MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_HEIGHT - MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_OVERLAP)
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_BOTTOM_GAP       1
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_TOP_GAP          1
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_LEFT_GAP         1
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_RIGHT_GAP        1
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_HEIGHT           37
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_TOTAL_HEIGHT     (MMI_IMUI_CLIPBOARD_FLOATING_MENU_HEIGHT + MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_VIS_HEIGHT)
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_TEXT_X_GAP       10
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_TEXT_X_GAP_N     2    /* if the menu width large the LCD with, use this gap*/
#define MMI_IMUI_CLIPBOARD_FLOATING_MENU_HIGHLIGHT_HEIGHT 25
#endif
#endif

#if defined(__MMI_IME_FTE_ENHANCE__)
#define MMI_IMUI_SINGLE_BLOCK_BOTTOM_GAP          0
#define MMI_IMUI_SINGLE_BLOCK_TOP_GAP             0

#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
#define MMI_IMUI_SINGLE_BLOCK_AND_STROKE_AREA_GAP          2
#endif



#if defined(__MMI_MAINLCD_240X400__)
#if !defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    #define MMI_IMUI_SINGLE_BLOCK_HEIGHT 162
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH 203
	#define MMI_IMUI_SINGLE_BLOCK_LEFT_GAP            1
    #define MMI_IMUI_SINGLE_BLOCK_RIGHT_GAP           1
	#define MMI_IMUI_SINGLE_BLOCK_X    0
	#define MMI_IMUI_SINGLE_BLOCK_Y    0
	#define MMI_IMUI_SINGLE_BLOCK_X_ROTATED    0
	#define MMI_IMUI_SINGLE_BLOCK_Y_ROTATED    0
	#define MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED 116
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED 319
#else
    #define MMI_IMUI_SINGLE_BLOCK_LEFT_GAP            0
    #define MMI_IMUI_SINGLE_BLOCK_RIGHT_GAP          0
	 #define MMI_IMUI_SINGLE_BLOCK_HEIGHT 179
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH 160
	#define MMI_IMUI_SINGLE_BLOCK_X    40
	#define MMI_IMUI_SINGLE_BLOCK_Y    221
	#define MMI_IMUI_SINGLE_BLOCK_X_ROTATED    72
	#define MMI_IMUI_SINGLE_BLOCK_Y_ROTATED    118
	#define MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED 122
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED 255
    
#endif

    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH 85
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT 90
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X 120
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y 77
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X 108
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y 131

    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH_ROTATED 85
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT_ROTATED 86
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X_ROTATED 234
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y_ROTATED 30
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X_ROTATED 222
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y_ROTATED 83
 #elif defined(__MMI_MAINLCD_320X240__)
#if !defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
   #define MMI_IMUI_SINGLE_BLOCK_HEIGHT 116
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH 319
    #define MMI_IMUI_SINGLE_BLOCK_LEFT_GAP            1
    #define MMI_IMUI_SINGLE_BLOCK_RIGHT_GAP           1
    #define MMI_IMUI_SINGLE_BLOCK_X    0
    #define MMI_IMUI_SINGLE_BLOCK_Y    0
    #define MMI_IMUI_SINGLE_BLOCK_X_ROTATED    0
    #define MMI_IMUI_SINGLE_BLOCK_Y_ROTATED    0
    #define MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED 116
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED 271
#else
    #define MMI_IMUI_SINGLE_BLOCK_LEFT_GAP            0
    #define MMI_IMUI_SINGLE_BLOCK_RIGHT_GAP          0
	 #define MMI_IMUI_SINGLE_BLOCK_HEIGHT 160
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH 144
	#define MMI_IMUI_SINGLE_BLOCK_X    48
	#define MMI_IMUI_SINGLE_BLOCK_Y    161
	#define MMI_IMUI_SINGLE_BLOCK_X_ROTATED    64
	#define MMI_IMUI_SINGLE_BLOCK_Y_ROTATED    121
	#define MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED 120
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED 192
#endif
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH 85
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT 86
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X 234
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y 30
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X 222
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y 83

    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH_ROTATED 85
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT_ROTATED 90
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X_ROTATED 120
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y_ROTATED 77
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X_ROTATED 108
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y_ROTATED 131
#elif defined(__MMI_MAINLCD_240X320__)
#if !defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    #define MMI_IMUI_SINGLE_BLOCK_HEIGHT 159
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH 203
	#define MMI_IMUI_SINGLE_BLOCK_LEFT_GAP            1
    #define MMI_IMUI_SINGLE_BLOCK_RIGHT_GAP           1
	#define MMI_IMUI_SINGLE_BLOCK_X    0
	#define MMI_IMUI_SINGLE_BLOCK_Y    0
	#define MMI_IMUI_SINGLE_BLOCK_X_ROTATED    0
	#define MMI_IMUI_SINGLE_BLOCK_Y_ROTATED    0
	#define MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED 116
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED 271
#else
    #define MMI_IMUI_SINGLE_BLOCK_LEFT_GAP            0
    #define MMI_IMUI_SINGLE_BLOCK_RIGHT_GAP          0
	 #define MMI_IMUI_SINGLE_BLOCK_HEIGHT 143
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH 160
	#define MMI_IMUI_SINGLE_BLOCK_X    40
	#define MMI_IMUI_SINGLE_BLOCK_Y    177
	#define MMI_IMUI_SINGLE_BLOCK_X_ROTATED    58
	#define MMI_IMUI_SINGLE_BLOCK_Y_ROTATED    118
	#define MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED 122
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED 204
#endif
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH 80
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT 80
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X 122
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y 76
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X 108
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y 128

    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH_ROTATED 85
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT_ROTATED 86
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X_ROTATED 186
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y_ROTATED 30
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X_ROTATED 174
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y_ROTATED 83

#elif defined(__MMI_MAINLCD_320X480__)   
#if !defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    #define MMI_IMUI_SINGLE_BLOCK_HEIGHT 205
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH 271
	#define MMI_IMUI_SINGLE_BLOCK_LEFT_GAP            1
    #define MMI_IMUI_SINGLE_BLOCK_RIGHT_GAP           1
	#define MMI_IMUI_SINGLE_BLOCK_X    0
	#define MMI_IMUI_SINGLE_BLOCK_Y    0
	#define MMI_IMUI_SINGLE_BLOCK_X_ROTATED    0
	#define MMI_IMUI_SINGLE_BLOCK_Y_ROTATED    0
	#define MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED 150
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED 383
#else
    #define MMI_IMUI_SINGLE_BLOCK_LEFT_GAP            0
    #define MMI_IMUI_SINGLE_BLOCK_RIGHT_GAP          0
	#define MMI_IMUI_SINGLE_BLOCK_HEIGHT 215
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH 214
	#define MMI_IMUI_SINGLE_BLOCK_X    53
	#define MMI_IMUI_SINGLE_BLOCK_Y    265
	#define MMI_IMUI_SINGLE_BLOCK_X_ROTATED    87
	#define MMI_IMUI_SINGLE_BLOCK_Y_ROTATED    157
	#define MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED 163
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED 306
#endif
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH 114
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT 114
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X 158
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y 92
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X 144
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y 169
    
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH_ROTATED 114
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT_ROTATED 114
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X_ROTATED 270
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y_ROTATED 37
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X_ROTATED 255
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y_ROTATED 114
    
#elif defined(__MMI_MAINLCD_480X800__)   
#if !defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    #define MMI_IMUI_SINGLE_BLOCK_HEIGHT 347
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH 408
	#define MMI_IMUI_SINGLE_BLOCK_LEFT_GAP            1
    #define MMI_IMUI_SINGLE_BLOCK_RIGHT_GAP           1
	#define MMI_IMUI_SINGLE_BLOCK_X    0
	#define MMI_IMUI_SINGLE_BLOCK_Y    0
	#define MMI_IMUI_SINGLE_BLOCK_X_ROTATED    0
	#define MMI_IMUI_SINGLE_BLOCK_Y_ROTATED    0
	#define MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED 225
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED 640
#else
    #define MMI_IMUI_SINGLE_BLOCK_LEFT_GAP            0
    #define MMI_IMUI_SINGLE_BLOCK_RIGHT_GAP          0
	#define MMI_IMUI_SINGLE_BLOCK_HEIGHT 358
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH 321
	#define MMI_IMUI_SINGLE_BLOCK_X    80
	#define MMI_IMUI_SINGLE_BLOCK_Y    442
	#define MMI_IMUI_SINGLE_BLOCK_X_ROTATED    145	
	#define MMI_IMUI_SINGLE_BLOCK_Y_ROTATED    236
	#define MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED 244
    #define MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED 510
#endif
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH 168
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT 190
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X 235
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y 153
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X 218
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y 294

    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH_ROTATED 187
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT_ROTATED 187
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X_ROTATED 450
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y_ROTATED 36
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X_ROTATED 445
    #define MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y_ROTATED 172

#else
    #error "This resolution doesn't support FTE" 
#endif



#endif /* defined(__MMI_IME_FTE_ENHANCE__) */


/*
*  bellow this line, all macro is defined for PLUTO SLIM
*/
#if defined(__MMI_IME_PLUTO_SLIM__)
#define __MMI_IME_IMUI_SLIM__
#endif

#ifdef __MMI_IME_IMUI_SLIM__
#undef MMI_IMUI_SELECTION_AREA_CONFIG_CENTER_INDEX
#undef MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL
#undef MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_STAR
#undef MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_INDEX
#undef MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_ALIGN
#undef MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE
#if defined(__MMI_CSTAR_PHRASE_INPUT__) || defined(__MMI_IME_SMART_WITH_INPUT_AREA__) || defined(__MMI_IME_USER_DATABASE__) || defined(__MMI_IME_MAGIC_ONE__)
#define MMI_IMUI_INPUT_AND_TITLE_BOX
#else
#undef MMI_IMUI_INPUT_AND_TITLE_BOX
#endif
#else /*#ifdef __MMI_IME_IMUI_SLIM__*/
#define MMI_IMUI_SELECTION_AREA_CONFIG_CENTER_INDEX
#define MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL
#define MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_STAR
#define MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_INDEX
#define MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_ALIGN
#define MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_SPACE_AFTER_APOSTROPHE
#define MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE
#define MMI_IMUI_INPUT_AND_TITLE_BOX
#endif /*#ifdef __MMI_IME_IMUI_SLIM__*/


/*****************************************************************************
 *  Typedef
 *****************************************************************************/
 
typedef enum
{
    MMI_IMUI_HANDWRITING_STYLE_FULL_SCREEN,
    MMI_IMUI_HANDWRITING_STYLE_MULTI_BLOCK,
    MMI_IMUI_HANDWRITING_STYLE_SINGLE_BLOCK
} mmi_imui_handwriting_style_enum;


typedef enum
{
    MMI_IMUI_ARROW_DIRECTION_UP,
    MMI_IMUI_ARROW_DIRECTION_DOWN,
    MMI_IMUI_ARROW_DIRECTION_LEFT,
    MMI_IMUI_ARROW_DIRECTION_RIGHT
} mmi_imui_arrow_direction_enum;


typedef enum
{
    MMI_IMUI_ARROW_PRESSED,
    MMI_IMUI_ARROW_NORMAL,
    MMI_IMUI_ARROW_DISABLE
} mmi_imui_arrow_state_enum;


typedef enum
{
    MMI_IMUI_ARROW_FOR_CANDIDATE,
    MMI_IMUI_ARROW_FOR_COMPOSITION
} mmi_imui_arrow_type_enum;


typedef struct
{
    U8 number_of_controls;
    U32 showed_flag;
    U32 last_showed_flag;
#if defined(__MMI_IME_FLOATING_CAND_BOX__)
    U32 last_showed_floating_flag;
    mmi_imc_state_enum last_showed_floating_state;
    mmi_imc_rect last_showed_floating_ui_rect;
#endif

#if defined(__MMI_VIRTUAL_KEYBOARD__) || defined(__MMI_IME_FTE_ENHANCE__)
	S16 showed_vk_height;
#endif
    mmi_imui_control_type_enum control_set[MMI_IMUI_CONTROL_MAX];
    S32 control_bottoms[MMI_IMUI_CONTROL_MAX];
} mmi_imui_control_set_struct;

typedef struct
{
    S32 imui_bottom;
    S32 imui_width;
    S32 imui_left;
	S32 imui_bottom_border;

#if defined(__MMI_IME_FLOATING_CAND_BOX__)
    S32 imui_floating_width;
    S32 imui_floating_left;
    S32 imui_floating_bottom;
#endif

    S32 font_chinese_width;
    S32 font_chinese_height;
    
    S32 font_alpha_width;
    S32 font_alpha_height;
    
    S32 font_label_width;
    S32 font_label_height;

    S32 arrow_width;
    S32 arrow_height;
#if defined(__MMI_IME_CANDIDATE_GRID__)
	S32 expand_button_width;
	S32 expand_button_height;
#endif
    S32 cursor_width;
    S32 cursor_height;
#if defined(__MMI_IME_FTE_ENHANCE__)
    S32 single_block_x;
    S32 single_block_y;
    S32 extra_block_x;
    S32 extra_block_y;
#endif
}mmi_imui_ui_param_struct, *mmi_imui_ui_param_struct_p;


typedef struct
{
    UI_font_type font_text;
    UI_font_type font_label;

    color           underline_color;
    color           indicator_color;
    UI_filled_area *focused_background_filler;
    UI_filled_area *background_filler;
#if defined(__MMI_TOUCH_SCREEN__)
    UI_filled_area *information_bar_background_filler;
#endif
    color           focused_border_color;
    color           border_color;
    S32             text_space;
    color           label_color;
    color           cursor_color;
    color           arrow_disable_color;
    color           arrow_down_color;
    color           arrow_up_color;
    color           stroke_color;
    color           highlighted_stroke_color;
    color           stroke_highlight_color;
#if defined(__MMI_IME_FTE_ENHANCE__) || defined(__COSMOS_MMI__)
    PU8             cand_background_small;
    PU8             cand_background_medium;
    PU8             cand_background_large;
    PU8             cand_focus_frame_small;
    PU8             cand_focus_frame_medium;
    PU8             cand_focus_frame_large;
    PU8             cand_separator_small;
    PU8             cand_separator_medium;
    PU8             cand_separator_large;
    PU8             cand_left_arrow_down_small;
    PU8             cand_left_arrow_down_medium;
    PU8             cand_left_arrow_down_large;
    PU8             cand_left_arrow_up_small;
    PU8             cand_left_arrow_up_medium;
    PU8             cand_left_arrow_up_large;
    PU8             cand_left_arrow_disable_small;
    PU8             cand_left_arrow_disable_medium;
    PU8             cand_left_arrow_disable_large;
    PU8             cand_right_arrow_down_small;
    PU8             cand_right_arrow_down_medium;
    PU8             cand_right_arrow_down_large;
    PU8             cand_right_arrow_up_small;
    PU8             cand_right_arrow_up_medium;
    PU8             cand_right_arrow_up_large;
    PU8             cand_right_arrow_disable_small;
    PU8             cand_right_arrow_disable_medium;
    PU8             cand_right_arrow_disable_large;
    PU8             cand_highlight_small;
    PU8             cand_highlight_medium;
    PU8             cand_highlight_large;
    PU8             cand_dull_highlight_small;
    PU8             cand_dull_highlight_medium;
    PU8             cand_dull_highlight_large;
    PU8             input_background_small;
    PU8             input_background_medium;
    PU8             input_background_large;
#if defined(__MMI_IME_CANDIDATE_GRID__)
	PU8			   cand_grid_arrow_down;
	PU8			   cand_grid_arrow_up;
	PU8			   cand_grid_arrow_down_disable;
	PU8			   cand_grid_arrow_up_disable;
	PU8			   cand_grid_back;
	PU8			   cand_grid_backspace;
	PU8			   cand_grid_candidate_background;
	PU8			   cand_grid_candidate_background_highlighted;
	PU8			   cand_grid_expand;
	PU8			   cand_grid_background;
	PU8             cand_grid_background_black;
#endif
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
	PU8			   scrolling_comp_background;
	PU8			   scrolling_comp_cand_background;
	PU8			   scrolling_comp_cand_background_highlighted;
#endif

    color           cand_dull_highlighted_text_color;
#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */
} mmi_imui_ui_theme_struct, *mmi_imui_ui_theme_struct_p;
 

typedef struct
{
    S32             separator_width;
    color           separator_normal_color;
    color           separator_focused_color;
    color           text_color;
    color           highlighted_text_color;
    color           highlight_color;
}mmi_imui_selection_area_theme_struct, *mmi_imui_selection_area_theme_struct_p;

typedef struct
{
    color           text_color;
    color           highlighted_text_color;
    color           highlight_color;
}mmi_imui_input_area_theme_struct, *mmi_imui_input_area_theme_struct_p;

 typedef enum
 {
     MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LEFT_ARROW,
     MMI_IMUI_SELECTION_AREA_ITEM_TYPE_RIGHT_ARROW,
     MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LABEL,
     MMI_IMUI_SELECTION_AREA_ITEM_TYPE_STAR,
     MMI_IMUI_SELECTION_AREA_ITEM_TYPE_WAVE,
     MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR,
     MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE,
	 MMI_IMUI_SELECTION_AREA_ITEM_TYPE_EXPAND,
     MMI_IMUI_SELECTION_AREA_ITEM_TYPE_DELETE,
	 MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_UP,
	 MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_DOWN,
	 MMI_IMUI_SELECTION_AREA_ITEM_TYPE_BACK
 } mmi_imui_selection_area_item_type_enum;

typedef struct
{
    UI_string_type string;
    UI_string_type string_original;
    S32 str_len;
    S32 wave_len;
    S32 x;
    S32 y;
    S32 width;
    S32 height;
    S32 str_width;
    S32 str_height;
}mmi_imui_candidate_struct, *mmi_imui_candidate_struct_p;

typedef struct
{
    UI_character_type char_code;
    S32 x;
    S32 y;
    S32 width;
}mmi_imui_indicator_struct, *mmi_imui_indicators_struct_p;


typedef union
{
    mmi_imui_indicator_struct indicator;
    mmi_imui_candidate_struct candidate;
}mmi_imui_selection_area_item_union, *mmi_imui_selection_area_item_union_p;

typedef struct
{
    S32 x;
    S32 y;
    S32 width;
    S32 height;
    S32 baseline;
    S32 str_height;
    S32 cand_ver_cap;
    S32 highlight_index;
    S32 item_count;
    S32 cand_count;
    U32 style;
    U32 flags;
    UI_font_type font_text;
    mmi_imui_selection_area_theme_struct area_theme;
    mmi_imui_arrow_state_enum left_arrow_state;
    mmi_imui_arrow_state_enum right_arrow_state;
    mmi_imui_selection_area_item_type_enum items_type[MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM];
    mmi_imui_selection_area_item_union items[MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM];
#if defined(__MMI_IME_FTE_ENHANCE__)
    PU8    cand_background;
    PU8    cand_focus_frame;
    PU8    cand_separator;
    PU8    cand_left_arrow_down;
    PU8    cand_left_arrow_up;
    PU8    cand_left_arrow_disable;
    PU8    cand_right_arrow_down;
    PU8    cand_right_arrow_up;
    PU8    cand_right_arrow_disable;
    PU8    cand_highlight;
    PU8    cand_dull_highlight;
#if defined(__MMI_IME_CANDIDATE_GRID__)
	PU8    cand_grid_expand;
	mmi_imui_arrow_state_enum expand_button_state;
#endif
#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

}mmi_imui_selection_area_struct, *mmi_imui_selection_area_struct_p;
#if defined(__MMI_IME_CANDIDATE_GRID__)
typedef struct
{
    S32 x;
    S32 y;
    S32 width;
    S32 height;
	S32 component_height;
	S32 component_width;
    S32 baseline;
    S32 str_height;
    S32 cand_ver_cap;
    S32 highlight_index;
    S32 item_count;
    S32 cand_count;
    U32 style;
    U32 flags;
    UI_font_type font_text;
    mmi_imui_selection_area_theme_struct area_theme;
    mmi_imui_arrow_state_enum up_arrow_state;
    mmi_imui_arrow_state_enum down_arrow_state;
	mmi_imui_arrow_state_enum backspace_button_state;
    mmi_imui_arrow_state_enum back_button_state;
    mmi_imui_selection_area_item_type_enum items_type[MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM];
    mmi_imui_selection_area_item_union items[MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM];

    PU8    cand_background;//candidate background image
    PU8    cand_focus_frame; //highlighted background image
    PU8    cand_separator;
	PU8    cand_horizontal_separator;
    PU8    cand_up_arrow_down;
    PU8    cand_up_arrow_up;
    PU8    cand_up_arrow_disable;
    PU8    cand_down_arrow_down;
    PU8    cand_down_arrow_up;
    PU8    cand_down_arrow_disable;
	PU8    cand_back;
	PU8    cand_backspace;
    PU8    cand_highlight;
    PU8    cand_dull_highlight;
	PU8    cand_grid_background;  //background image of total grid
    PU8    cand_grid_background_black;


}mmi_imui_selection_area_grid_struct, *mmi_imui_selection_area_grid_struct_p;
#endif

#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
typedef struct
{
    S32 x;
    S32 y;
    S32 width;
    S32 height;
    S32 baseline;
    S32 str_height;
    S32 text_x;
    S32 text_y;
    S32 text_width;
    S32 text_area_x;
    S32 highlight_num;
    UI_string_type str_ptr;
    S32 text_base_y;
    mmi_imc_rect highlight_rect;
    S32 wave_x;
    S32 wave_length;
    S32 cursor_x;
    U32 style;
    U32 flags;
    mmi_imui_input_area_theme_struct area_theme;
}mmi_imui_input_area_struct, *mmi_imui_input_area_struct_p;
#endif

#ifdef __MMI_CLIPBOARD_FLOATING_MENU__
typedef enum
{
    MMI_IMUI_CCP_FM_UP,
    MMI_IMUI_CCP_FM_DOWN,
    MMI_IMUI_CCP_FM_END
} mmi_imui_ccp_fm_direction_enum;

typedef struct
{
    S32 x;
    S32 y;
    S32 width;
    S32 height;
    mmi_imui_clipboard_floating_menu_item_struct menu_item[MMI_IMUI_CLIPBOARD_FOLATING_MENU_NUM];
    U8  menu_item_cnt;
    U8  arrow_index;
    S32 highlight_index;
    mmi_imui_ccp_fm_direction_enum direction; 
}mmi_imui_clipboard_floating_menu_struct, *mmi_imui_clipboard_floating_menu_struct_p;
#endif

typedef struct
{
    S16 x, y;
    U16 indicator_id;
} mmi_imui_single_block_hw_area_struct, *mmi_imui_single_block_hw_area_struct_p;


#if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
typedef struct
{
    S32 x, y, width, height, string_x, string_y;
    S32 baseline;
    S32 last_showed_width;
    PU8 background_img_ptr;
    UI_string_type str_ptr;
    MMI_BOOL cursor_stopped;
}mmi_imui_resizable_composition_area_struct, *mmi_imui_resizable_composition_area_struct_p;
#endif
    #if defined (__MMI_MULTITAP_BANGLA_SPEC__)
	MMI_BOOL	check_ra_hal_bangla_for_imui = MMI_FALSE;
#endif
/*****************************************************************************
 * Local variables
 *****************************************************************************/
UI_ime_theme *current_ime_theme = NULL;

#if defined(__MMI_IME_SCROLLING_COMPOSITION__)


static  UI_filled_area  scrolling_box_normal_filler=
{
    UI_FILLED_AREA_TYPE_BITMAP,
    NULL,
    NULL,
    {255, 255, 255, 100},
    {0, 0, 0, 100},
    {0, 0, 0, 100},
    {0, 0, 0, 100},
    0
};
static  UI_filled_area  scrolling_box_selected_filler=
{
    UI_FILLED_AREA_TYPE_BITMAP,
    NULL,
    NULL,
    {255, 255, 255, 100},
    {0, 0, 0, 100},
    {0, 0, 0, 100},
    {0, 0, 0, 100},
    0
};
#endif

#ifdef UI_SMALL_CATEGORY_EDITOR

static UI_ime_theme g_imui_small_editor_theme = 
{
	/* under line color for ime */
	{255,0,0,100},
	/* indicator color for ime */
	{255,0,0,100},
	/* focus background filler for ime */
	NULL,
	/* back ground filler for ime */
	NULL,
#if defined(__MMI_TOUCH_SCREEN__)
    NULL,
#endif
	/* focused border color */
	{255,102,0,100},
	/* border color for ime */
	{217,217,217,100},
	/* seperator width for ime*/
    0,
	/* seperator color for ime */
	{217,217,217,100},
	/* focused seperator color for ime */
	{255,102,0,100},
	/* text space for ime */
	2,
	/* label color for ime */
	{128,128,128,100},
	/* cursor color for ime */
	{253,0,18,100},
	/* arrow disabled color for ime */
	{192,192,192,100},
	/* arrow down color for ime */
	{0,0,0,100},
	/* arrow up color for ime */
	{0,0,0,100},
	/* text font for ime */
	&MMI_medium_font,
	/* label font for ime */
	&MMI_small_font,
	/* cand text color for ime */
	{0,0,0,100},
	/* cand highlight text color for ime */
	{255,255,255,100},
	/* cand highlight color for ime */
	{255,102,0,100},
	/* comp text color for ime */
	{105,105,105,100},
	/* comp highlight text color for ime */
	{255,255,255,100},
	/* comp highlight color for ime */
	{255,102,0,100},
	/* input text color for ime */
	{105,105,105,100},
	/* input highlight text color for ime */
	{255,255,255,100},
	/* input highlight color for ime */
	{255,102,0,100},
	/* stroke color for ime */
	{136,136,136,100},
	/* highlight stroke color for ime */
	{255,255,255,100},
	/* stroke highlight color for ime */
    {255,185,139,100}
};
#endif /* #ifdef UI_SMALL_CATEGORY_EDITOR */


static  mmi_imc_rect g_imui_indicator_rect_floating_backup = {0};
static mmi_imc_rect g_imui_indicator_rect_floating ={0};


static mmi_imui_draw_back_ground_funcptr g_imui_redraw_funcptr = NULL;

static mmi_imui_selection_area_struct g_imui_candidate_box;
#if defined(__MMI_IME_CANDIDATE_GRID__)
static mmi_imui_selection_area_grid_struct g_imui_candidate_box_grid;
static MMI_BOOL g_imui_is_down_in_grid = MMI_FALSE;
#endif
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
static fixed_list_menu g_imui_vertical_composition_list;
static fixed_icontext_menuitem_type g_imui_vertical_composition_list_items[MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN_VER];
static void *g_imui_vertical_composition_list_items_pointers[MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN_VER];
static fixed_icontext_menuitem g_imui_vertical_composition_list_data;
#endif

#if defined(__MMI_IME_VERTICAL_CAND_BOX__)
static fixed_list_menu g_imui_vertical_candidate_list;
static fixed_icontext_menuitem_type g_imui_veritical_candidate_list_items[MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN_VER];
static void *g_imui_veritical_candidate_list_items_pointers[MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN_VER];
static fixed_icontext_menuitem g_imui_vertical_candidate_list_data;
static MMI_BOOL g_imui_vertical_candidate_list_stop_cursor = MMI_FALSE;
#endif

static mmi_imui_selection_area_struct g_imui_composition_box;

#if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
static mmi_imui_resizable_composition_area_struct g_imui_resizable_composition_box;
#endif

#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
static mmi_imui_input_area_struct g_imui_input_box;

static mmi_imui_input_area_struct g_imui_title_box;
#endif

#ifdef __MMI_CLIPBOARD_FLOATING_MENU__
static mmi_imui_clipboard_floating_menu_struct g_imui_clipboard_floating_menu;
#endif

static mmi_imui_ui_param_struct g_imui_ui_param;

static mmi_imui_ui_theme_struct g_imui_ui_theme;

/* Which kind of controls are in the category */
static mmi_imui_control_set_struct g_imui_control_set;

static mmi_imc_rect g_imui_information_bar_rect;

static mmi_imc_rect g_imui_ime_hint_rect;

static mmi_imc_rect g_imui_information_bar_display_rect;

extern mmi_pen_handwriting_area_struct g_imc_stroke_area[]; 
#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)
extern S32 g_active_block;
#endif

#if defined(__MMI_IME_INDICATOR_ON_STATUS_ICON_BAR__)
static mmi_imc_rect g_imui_ime_indicator_rect;
static S32 g_imui_ime_indicator_id = WGUI_STATUS_ICON_BAR_INVALID_ELEMENT_ID;
#endif

#ifdef __MMI_TOUCH_SCREEN__

static mmi_imui_handwriting_style_enum g_imui_hand_writing_style;

//static mmi_pen_handwriting_area_struct g_imui_stroke_area[2];

static MMI_BOOL g_imui_is_there_vk_candidate_box = MMI_FALSE;

#ifdef MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER 

/* Pointer to the GDI handler, used by Draw Manager */
static gdi_handle g_imui_hand_writing_stroke_handle = GDI_ERROR_HANDLE;

/* Original layer 1 before handwriting is started */
static gdi_handle g_imui_hand_writing_GDI_original_handle1;

/* Original layer 2 before handwriting is started */
static gdi_handle g_imui_hand_writing_GDI_original_handle2;

/* Set blt layer to gPenEditorStrokeHandle during handwriting is progressing */
static MMI_BOOL g_imui_hand_writing_blt_layer_switched = MMI_FALSE;

#else 

/* Pointer to the GDI handler, used by Draw Manager */
static gdi_handle g_imui_hand_writing_GDI_handle = GDI_ERROR_HANDLE;

#endif /* MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER */

static U8 *g_imui_stroke_GDI_buffer = NULL;

/* The color of the stroke */
static color g_imui_hand_writing_stroke_color = {0, 0, 0, 100};

#if !defined(__MMI_IME_FTE_ENHANCE__)
extern S32 handwriting_stroke_layer_mem;
#endif

static mmi_imui_control_type_enum g_imui_pen_down_control = MMI_IMUI_CONTROL_MAX;

#if defined(__MMI_VIRTUAL_KEYBOARD__)
static UI_character_type g_imui_vk_characters_list[MMI_IMUI_VK_MAX_SET_CHAR + 1];

static gui_virtual_keyboard_pen_enum g_imui_vk_event_keys_disable_list[MMI_IMUI_VK_MAX_DISABLE_EVENTS + 1];

const UI_character_type g_imui_empty_invalid_characters[] = { '\0' };

const static gui_virtual_keyboard_pen_enum g_imui_empty_invalid_events[] = {GUI_VKBD_PEN_HIDE, GUI_VKBD_PEN_SHOW, 
                                                                            GUI_VKBD_PEN_CAPSLOCK, GUI_VKBD_PEN_SYMBPICKER, 
                                                                            GUI_VKBD_PEN_DISPLAY_CALLBACK, GUI_VKBD_PEN_BAKSPACE, 
                                                                            GUI_VKBD_PEN_NEWLINE, GUI_VKBD_PEN_SPACE, GUI_VKBD_PEN_NONE};

static gui_virtual_keyboard_language_enum g_imui_last_valid_vk_type = GUI_VIRTUAL_KEYBOARD_MAX_LANG;

#if defined(__MMI_IME_FTE_ENHANCE__)

static mmi_imui_single_block_hw_area_struct g_imui_single_block_area;

#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)

static mmi_imui_virtual_keyboard_parameter g_imui_vk_parameter = {GUI_VIRTUAL_KEYBOARD_MAX_LANG, MMI_VK_TYPE_QWERTY,MMI_FALSE, NULL, NULL};

#elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
static mmi_imui_virtual_keyboard_parameter g_imui_vk_parameter = {GUI_VIRTUAL_KEYBOARD_MAX_LANG, MMI_VK_TYPE_QWERTY,MMI_FALSE};
#else
#error do not define the vk version
#endif

#endif /* defined(__MMI_IME_FTE_ENHANCE__) */

static MMI_BOOL g_is_redraw_vk_enabled = MMI_TRUE;
#endif /* #if defined(__MMI_VIRTUAL_KEYBOARD__) */
#if defined(__MMI_VIRTUAL_KEYBOARD__)
static MMI_BOOL g_imui_is_vk_draw_enable = MMI_TRUE;
#endif

#endif /*__MMI_TOUCH_SCREEN__*/

static MMI_BOOL g_imui_floating_indicator_back_ground_redraw = MMI_FALSE;

#if defined(__MMI_IME_USER_DATABASE__)
UI_string_type g_imui_new_word_prompt_ptr = NULL;
#endif
#if defined(__MMI_IME_INDICATOR_ON_STATUS_ICON_BAR__)
static S32 g_imui_indicator_height_backup=0, g_imui_indicator_width_backup=0;
static mmi_imm_input_mode_enum g_imui_input_mode_backup = IMM_INPUT_MODE_NONE;
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
static U16 g_mmi_imui_special_key_icon_backup = 1;
#endif
#endif

/*****************************************************************************
 * Global variables
 *****************************************************************************/
#ifdef __MMI_VIRTUAL_KEYBOARD__
#ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
extern virtual_keyboard MMI_virtual_keyboard;
#else
extern gui_virtual_keyboard_language_enum g_wgui_virtual_keyboard_lang_type;
extern gui_virtual_keyboard_struct g_wgui_virtual_keyboard;
#endif
#endif

#ifdef UI_SMALL_CATEGORY_EDITOR
extern MMI_BOOL g_small_editor_category_present;
#endif

#if defined(__MMI_IME_VERTICAL_CAND_BOX__)
extern S32 MMI_current_menu_type;
#endif
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
extern S32 MMI_current_menu_type;
#endif
/*****************************************************************************
 * Local functions
 *****************************************************************************/
static U32 mmi_imui_init_ui(void);

#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)
static void mmi_imui_draw_ime_indicator_floating(void);
#endif /*#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)*/

static U32 mmi_imui_deinit_ui(void);

static void mmi_imui_update_ui_param(void);

static void mmi_imui_update_ui_theme(void);

static void mmi_imui_create_candidate_box(U32 style);
#if defined(__MMI_IME_CANDIDATE_GRID__)
static void mmi_imui_create_candidate_box_grid(U32 style);
#endif
static void mmi_imui_create_composition_box(U32 style);

static void mmi_imui_create_input_box(U32 style);

static void mmi_imui_create_title_box(U32 style);

static U32 mmi_imui_redraw(U32 redraw_flag);

static U32 mmi_imui_redraw_all(void);

static void mmi_imui_exit_handwriting_on_disconnect(void);

#if defined(__MMI_IME_FLOATING_CAND_BOX__)
static U32 mmi_imui_redraw_all_floating_controls(void);
static S32 mmi_imui_get_floating_ui_height(void);
static U32 mmi_imui_get_floating_control_set(void);
#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)
static MMI_BOOL mmi_imui_check_floating_ui_cover_ime_indicator(void);
static MMI_BOOL mmi_imui_check_floating_ui_contain_point(mmi_imc_point_p point);
#endif /*#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)*/
#endif

#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)
static MMI_BOOL mmi_imui_check_ui_cover_ime_indicator(void);
static MMI_BOOL mmi_imui_check_ui_contain_point(mmi_imc_point_p point);
#endif /*#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)*/
static U32 mmi_imui_redraw_partial_controls(U32 redraw_flag);

static void mmi_imui_draw_back_ground(S32 x1, S32 y1, S32 x2, S32 y2);

static S32 mmi_imui_draw_candidate_box_area(S32 bottom_line);
#if defined(__MMI_IME_CANDIDATE_GRID__)
static S32 mmi_imui_draw_candidate_box_area_grid(S32 bottom_line);
#endif
static S32 mmi_imui_draw_composition_box_area(S32 bottom_line);

static S32 mmi_imui_draw_input_box_area(S32 bottom_line);

static S32 mmi_imui_draw_title_box_area(S32 bottom_line);

static void mmi_imui_draw_information_bar(void);

static U32 mmi_imui_get_ime_infor_width(void);

static void mmi_imui_draw_string(
                S32 x,
                S32 y,
                S32 baseline,
                const UI_character_type *str_ptr,
                S32 str_len,
                UI_font_type type,
                color c);

static void mmi_imui_draw_string_int(
                S32 x,
                S32 y,
                S32 baseline,
                const UI_character_type *str_ptr,
                S32 str_len,
                UI_font_type type,
                color c,
                MMI_BOOL flag_R2l);

#if defined(__MMI_IME_CANDIDATE_GRID__)
static void mmi_imui_draw_string_grid(
                S32 x,
                S32 y,
                S32 baseline,
                const UI_character_type *str_ptr,
                S32 str_len,
                UI_font_type type,
                color c);
#endif

static void mmi_imui_draw_string_r2l(
				S32 x,
				S32 y,
				S32 baseline,
				const UI_character_type *str_ptr,
				S32 str_len,
				UI_font_type type,
                color c);

static void mmi_imui_draw_string_for_selection_area(
                mmi_imui_selection_area_struct_p area_ptr,
                S32 x,
                S32 y,
                S32 baseline,
                const UI_character_type *str_ptr,
                S32 str_len,
                UI_font_type type,
                color c);

static void mmi_imui_draw_char(S32 x, S32 y, S32 baseline, UI_character_type char_code, UI_font_type type, color c);

static U32 mmi_imui_update_selection_area(mmi_imui_selection_area_struct_p area_ptr, mmi_imui_update_selection_area_struct_p update_ptr);
#if defined(__MMI_IME_CANDIDATE_GRID__)
static U32 mmi_imui_update_selection_area_grid(mmi_imui_selection_area_grid_struct_p area_ptr, mmi_imui_update_selection_area_struct_p update_ptr);
#endif
#if defined(__MMI_IME_FTE_ENHANCE__)
static void mmi_imui_update_selection_area_fte_theme(mmi_imui_selection_area_struct_p area_ptr);
#endif

static void mmi_imui_show_selection_area(mmi_imui_selection_area_struct_p area_ptr);
#if defined(__MMI_IME_CANDIDATE_GRID__)
static void mmi_imui_show_selection_area_grid(mmi_imui_selection_area_grid_struct_p area_ptr);
#endif

#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
static void mmi_imui_show_input_area(mmi_imui_input_area_struct_p area_ptr);

static void mmi_imui_update_input_area(mmi_imui_input_area_struct_p area_ptr, mmi_imui_update_input_area_struct_p update_ptr);
#endif

static void mmi_imui_get_char_extent(UI_font_type type, UI_character_type code, S32 *width_ptr, S32 *height_ptr);

static void mmi_imui_get_string_extent(UI_font_type type, UI_string_type string, S32 *width_ptr, S32 *height_ptr);

static void mmi_imui_get_string_extent_for_selection_area(mmi_imui_selection_area_struct_p area_ptr, UI_font_type type, UI_string_type string, S32 *width_ptr, S32 *height_ptr);
#if defined(__MMI_IME_CANDIDATE_GRID__)
static void mmi_imui_get_string_extent_for_selection_area_grid(mmi_imui_selection_area_grid_struct_p area_ptr, UI_font_type type, UI_string_type string, S32 *width_ptr, S32 *height_ptr);
#endif
static void mmi_imui_draw_arrow(
        S32 x, S32 y, mmi_imui_arrow_direction_enum arrow_direction,
        mmi_imui_arrow_state_enum arrow_state);

static void mmi_imui_selection_area_draw_arrow(
        mmi_imui_selection_area_struct_p area_ptr,
        S32 x, S32 y, mmi_imui_arrow_direction_enum arrow_direction,
        mmi_imui_arrow_state_enum arrow_state);

static void mmi_imui_draw_wave_underline(S32 x, S32 y, S32 w, color c);

#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_INDEX)
static void mmi_imui_reorder_candidates_to_center_first(UI_string_type str, S32 count);
#endif

static UI_string_type mmi_imui_get_string_by_index(UI_string_type str, S32 index, S32 count);

static void mmi_imui_get_r2l_coordinate(S32 source_x, S32 width, S32 axis_x, S32 *destination_x);

static U32 mmi_imui_get_max_candidate_width(void);

static S32 mmi_imui_get_imui_height_by_ui_set(U32 ui_set);

static S32 mmi_imui_get_ime_hint_width(void);
static S32 mmi_imui_get_ime_hint_height(void);


static void mmi_imui_get_ime_hint_size(S32 *hint_width, S32 *hint_height);

static void mmi_imui_draw_ime_hint(mmi_imc_rect_p hint_rect);

#if defined(__MMI_IME_INDICATOR_ON_STATUS_ICON_BAR__)
static void mmi_imui_draw_ime_indicator(S32 x1, S32 y1, S32 x2, S32 y2);
#endif

static void mmi_imui_get_imui_parameters(mmi_imui_param_struct *param);

static void mmi_imui_set_imui_parameters(mmi_imui_param_struct *param);

#if defined(__MMI_IME_VERTICAL_CAND_BOX__) 
static S32 mmi_imui_update_vertical_candidate_list(mmi_imui_update_selection_area_struct_p update_ptr);
static S32 mmi_imui_draw_verical_candidate_list(S32 x, S32 bottom_line);
static void mmi_imui_draw_vertical_candidate_list_background(void);
static void mmi_imui_draw_vertical_candidate_list_vbar_background(S32 x1, S32 y1, S32 x2, S32 y2);
#endif
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
static S32 mmi_imui_update_vertical_composition_list(mmi_imui_update_selection_area_struct_p update_ptr);
static S32 mmi_imui_draw_vertical_composition_list(S32 x, S32 bottom_line);
static void mmi_imui_draw_vertical_composition_list_background(void);
static void mmi_imui_draw_vertical_composition_list_vbar_background(S32 x1, S32 y1, S32 x2, S32 y2);
#endif
/* Clipboard floating menu related */
#ifdef __MMI_CLIPBOARD_FLOATING_MENU__

#define IMUI_MIN3(a, b, c)   (((a) < (b) ? (a) : (b)) < (c) ? ((a) < (b) ? (a) : (b)) : (c))

static S32 mmi_imui_get_clipboard_floating_button_arrow_x(S32 x, U8 index);
static void mmi_imui_adjust_clipboard_floating_menu_arrow_index(S32 x, S32 arrow_x);
static void mmi_imui_create_clipboard_floating_menu(void);
static S32 mmi_imui_draw_clipboard_floating_menu(S32 x, S32 bottom_line);
static S32 mmi_imui_update_clipboard_floating_menu(mmi_imui_update_clipboard_floating_menu_struct_p update_ptr);
#if defined(__MMI_TOUCH_SCREEN__)
static MMI_BOOL mmi_imui_clipboard_floating_menu_translate_pen_event(
           mmi_imui_clipboard_floating_menu_struct_p area_ptr, 
           mmi_pen_event_type_enum pen_event,
           S16 x,
           S16 y);
#endif /* __MMI_TOUCH_SCREEN__ */
static void mmi_imui_show_clipboard_floating_menu(mmi_imui_clipboard_floating_menu_struct_p area_ptr);
static void mmi_imui_clipboard_floating_menu_set_highlight(mmi_imui_clipboard_floating_menu_struct_p area_ptr, U8 index);
#endif /* __MMI_CLIPBOARD_FLOATING_MENU__ */

#if defined(__MMI_TOUCH_SCREEN__)

#if defined(__MMI_VIRTUAL_KEYBOARD__)
static void mmi_imui_setup_virtual_keyboard(mmi_imui_message_struct_p msg_ptr);
static void mmi_imui_config_redraw_vk(MMI_BOOL b_show);
#endif

static U32 mmi_imui_set_hand_writing_areas(mmi_pen_handwriting_area_struct *stroke_area, mmi_pen_handwriting_area_struct *ext_stroke);

#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)
static S32 mmi_imui_draw_multi_block_area(S32 bottom_line);
#endif

#if defined(__MMI_VIRTUAL_KEYBOARD__)
static S32 mmi_imui_draw_virtual_keyboard_area_background(S32 bottom_line);
#endif

static U32 mmi_imui_create_hand_writing_layer(void);

static U32 mmi_imui_draw_hand_writing_stroke(mmi_pen_point_struct *previous_point, mmi_pen_point_struct *point);

static U32 mmi_imui_clear_hand_writing_stroke(void);

static U32 mmi_imui_pen_down_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback);
static U32 mmi_imui_pen_up_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback);
static U32 mmi_imui_pen_move_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback);
static U32 mmi_imui_pen_long_tap_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback);
static U32 mmi_imui_pen_repeat_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback);
static U32 mmi_imui_pen_abort_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback);

#if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_VUI_ENGINE__)
static U32 mmi_imui_floating_ui_pen_down_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback);
#endif

static MMI_BOOL mmi_imui_selection_area_translate_pen_event(mmi_imui_selection_area_struct_p area_ptr, 
                                                            mmi_pen_event_type_enum pen_event, S16 x, S16 y,
                                                            mmi_imui_selection_area_pen_event_enum * event);
#if defined(__MMI_IME_CANDIDATE_GRID__)
static MMI_BOOL mmi_imui_candidate_grid_area_translate_pen_event(mmi_imui_selection_area_grid_struct_p area_ptr, 
                                                            mmi_pen_event_type_enum pen_event, S16 x, S16 y,
                                                            mmi_imui_selection_area_grid_pen_event_enum * event);
#endif
#ifdef MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER
static void mmi_imui_backup_and_set_blt_layer(void);
static void mmi_imui_restore_blt_layer(void);
#endif /* MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER */

#if defined(__MMI_VIRTUAL_KEYBOARD__)
static void mmi_imui_set_vk_keys(void);
#endif

#endif /* __MMI_TOUCH_SCREEN__ */

#if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
static S32 mmi_imui_update_resizable_composition_area(mmi_imui_resizable_composition_area_struct_p area_ptr, mmi_imui_update_selection_area_struct_p update_ptr);
static void mmi_imui_show_resizable_composition_area(mmi_imui_resizable_composition_area_struct_p area_ptr);
static S32 mmi_imui_draw_resizable_composition_area(S32 bottom_line);
#endif

static MMI_BOOL mmi_imui_rects_overlap(mmi_imc_rect_p rect1, mmi_imc_rect_p rect2);
/*****************************************************************************
 * Global functions
 *****************************************************************************/
extern void draw_resizeable_arrow(S32 x, S32 y, U8 arrow_type, color c, S32 width, S32 height);
 
 U32 mmi_imui_get_control_showed_flag(void)
{

    return g_imui_control_set.showed_flag;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_set_control_showed_flag
 * DESCRIPTION
 *  To config the showed flag of the controls
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
 void mmi_imui_set_control_showed_flag(U32 control, MMI_BOOL isenable)
{
    if(isenable)
    {
        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK((mmi_imui_control_type_enum)control);
    }
    else
    {
        g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK((mmi_imui_control_type_enum)control);
    }

}

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_is_visible_control
 * DESCRIPTION
 *  To config the showed flag of the controls
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
MMI_BOOL mmi_imui_is_visible_control(U32 control)
{
    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK((mmi_imui_control_type_enum)control))
    {
        return MMI_TRUE;
    }
    else
    {
        return MMI_FALSE; 
    }
}
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_send_message
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
U32  mmi_imui_send_message( mmi_imui_message_struct_p msg_ptr, mmi_imui_command_funcptr command_callback )
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 lresult = MMI_IMUI_RESULT_FALSE;
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    S32 vk_y;
#endif
        
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#if defined(__MMI_VUI_ENGINE__)
    if ((vadp_p2v_uc_is_in_venus() || vadp_p2v_is_venus_ime_connected())
         && !dm_is_activated())
    {
        U32 ret = 0;
        
        if (vadp_p2v_send_imui_message(msg_ptr, &ret))
        {
            return ret;
        }
    }
#endif
        
    switch(msg_ptr->message_id)
    {
    case MMI_IMUI_MESSAGE_CREATE_CANDIDATE_BOX:

        if (!mmi_imui_is_in_control_set(MMI_IMUI_CANDIDATE_AREA))
        {
            mmi_imui_create_candidate_box((U32)msg_ptr->param_0);
            mmi_imui_add_control(MMI_IMUI_CANDIDATE_AREA);
        }
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;
		#if defined(__MMI_IME_CANDIDATE_GRID__)
	case MMI_IMUI_MESSAGE_CREATE_CANDIDATE_BOX_GRID:

        if (!mmi_imui_is_in_control_set(MMI_IMUI_CANDIDATE_GRID_AREA))
        {
            mmi_imui_create_candidate_box_grid((U32)msg_ptr->param_0);
            mmi_imui_add_control(MMI_IMUI_CANDIDATE_GRID_AREA);
        }
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;
		#endif
    case MMI_IMUI_MESSAGE_CREATE_COMPOSITION_BOX:
        
        if (!mmi_imui_is_in_control_set(MMI_IMUI_COMPOSITION_AREA))
        {
            mmi_imui_create_composition_box((U32)msg_ptr->param_0);
            mmi_imui_add_control(MMI_IMUI_COMPOSITION_AREA);
        }
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;
#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)
    case MMI_IMUI_MESSAGE_CREATE_MULTI_BLOCK_AREA:

        if (!mmi_imui_is_in_control_set(MMI_IMUI_MULTI_BLOCK_AREA))
        {
            mmi_imui_add_control(MMI_IMUI_MULTI_BLOCK_AREA);
        }
        break;
#endif /*#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)*/

#if defined(__MMI_IME_FTE_ENHANCE__)        
    case MMI_IMUI_MESSAGE_CREATE_SINGLE_BLOCK_AREA:

        if (!mmi_imui_is_in_control_set(MMI_IMUI_SINGLE_BLOCK_AREA))
        {
            mmi_imui_add_control(MMI_IMUI_SINGLE_BLOCK_AREA);
        }
        break;
    case MMI_IMUI_MESSAGE_IS_STROKE_DOWN_IN_EXTRA_BLOCK:
#if defined(__MMI_VIRTUAL_KEYBOARD__) 
        if (mmi_imc_is_rotated())
        {
            lresult = (MMI_BOOL) PEN_CHECK_BOUND(
                        (S32) msg_ptr->param_0, (S32) msg_ptr->param_1, 
                        g_imui_single_block_area.x + MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X_ROTATED,
                        g_imui_single_block_area.y + MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y_ROTATED,
             		   MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH_ROTATED,
             		   MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT_ROTATED);
        }
		else
		{
	        lresult = (MMI_BOOL) PEN_CHECK_BOUND(
	                        (S32) msg_ptr->param_0, (S32) msg_ptr->param_1, 
	                        g_imui_single_block_area.x + MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_X,
	                        g_imui_single_block_area.y + MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_Y,
	             		   MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_WIDTH,
	             		   MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_HEIGHT);
		}
#endif /* defined(__MMI_VIRTUAL_KEYBOARD__) */
        break;        
#endif /* defined(__MMI_IME_FTE_ENHANCE__) */

#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
    case MMI_IMUI_MESSAGE_CREATE_INPUT_BOX:
        if (!mmi_imui_is_in_control_set(MMI_IMUI_INPUT_AREA))
        {
            mmi_imui_create_input_box((U32)msg_ptr->param_0);
            mmi_imui_add_control(MMI_IMUI_INPUT_AREA);
        }
        break;
        
    case MMI_IMUI_MESSAGE_CREATE_TITLE_BOX:

        if (!mmi_imui_is_in_control_set(MMI_IMUI_TITLE_AREA))
        {
            mmi_imui_create_title_box((U32)msg_ptr->param_0);
            mmi_imui_add_control(MMI_IMUI_TITLE_AREA);
        }
        break;
#endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/
        
    case MMI_IMUI_MESSAGE_CREATE_VITUAL_KEYBOARD:
        
#if defined(__MMI_TOUCH_SCREEN__) 
        if (!mmi_imui_is_in_control_set(MMI_IMUI_VIRTUAL_KEYBOARD))
        {
            mmi_imui_add_control(MMI_IMUI_VIRTUAL_KEYBOARD);
        }
#endif /*defined(__MMI_TOUCH_SCREEN__)*/

        break;

    case MMI_IMUI_MESSAGE_CREATE_INFORMATION_BAR:
        
#if defined(__MMI_TOUCH_SCREEN__)
        if (!mmi_imui_is_in_control_set(MMI_IMUI_INFORMATION_BAR))
        {
            mmi_imui_add_control(MMI_IMUI_INFORMATION_BAR);
            //memcpy(&g_imui_information_bar_rect, (mmi_imc_rect *)msg_ptr->param_0, sizeof(mmi_imc_rect));   
        }
        
#endif /*defined(__MMI_TOUCH_SCREEN__)*/

        break;
#ifdef __MMI_CLIPBOARD_FLOATING_MENU__
    case MMI_IMUI_MESSAGE_CREATE_CLIPBOARD_FLOATING_MENU:
        if (!mmi_imui_is_in_control_set(MMI_IMUI_CLIPBOARD_FLOATING_MENU))
        {
            mmi_imui_create_clipboard_floating_menu();
            mmi_imui_add_control(MMI_IMUI_CLIPBOARD_FLOATING_MENU);
        }
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;

    case MMI_IMUI_MESSAGE_UPDATE_CLIPBOARD_FLOATING_MENU:
        mmi_imui_update_clipboard_floating_menu((mmi_imui_update_clipboard_floating_menu_struct_p)msg_ptr->param_0);
            
        break;
#endif /* __MMI_CLIPBOARD_FLOATING_MENU__ */

    case MMI_IMUI_MESSAGE_CREATE_IME_INDICATOR:
    #if defined(__MMI_IME_INDICATOR_ON_STATUS_ICON_BAR__)
        if (mmi_imui_create_ime_indicator())
        {
            g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA);
        }
    #endif
        break;
    
    case MMI_IMUI_MESSAGE_INIT_UI:
        
        lresult = mmi_imui_init_ui();
        
        break;
        
    case MMI_IMUI_MESSAGE_SET_HAND_WRITING_STYLE:
        
#if defined(__MMI_TOUCH_SCREEN__)

        g_imui_hand_writing_style = (mmi_imui_handwriting_style_enum)msg_ptr->param_0;

#endif /*defined(__MMI_TOUCH_SCREEN__)*/

        break;

    case MMI_IMUI_MESSAGE_SET_HAND_WRITING_AREAS:
        
#if defined(__MMI_TOUCH_SCREEN__)

        lresult = mmi_imui_set_hand_writing_areas((mmi_pen_handwriting_area_struct *)msg_ptr->param_0, (mmi_pen_handwriting_area_struct *)msg_ptr->param_1);

#endif /*defined(__MMI_TOUCH_SCREEN__)*/
        
        break;

    case MMI_IMUI_MESSAGE_SET_VIRTUAL_KEYBOARD:
        
#if defined(__MMI_VIRTUAL_KEYBOARD__)

        mmi_imui_setup_virtual_keyboard(msg_ptr);
        
#endif /*defined(__MMI_VIRTUAL_KEYBOARD__)*/

        break;
    case  MMI_IMUI_MESSAGE_VK_DRAW_DISABLE:
		#if defined(__MMI_VIRTUAL_KEYBOARD__)
		g_imui_is_vk_draw_enable = MMI_FALSE;
       #endif
	    break;

	case MMI_IMUI_MESSAGE_VK_DRAW_ENABLE:
		#if defined(__MMI_VIRTUAL_KEYBOARD__)
		g_imui_is_vk_draw_enable = MMI_TRUE;
        #endif
	    break;
    case MMI_IMUI_MESSAGE_SHOW_INDICATOR_FLOATING:
         g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA_FLOATING);
         g_imui_floating_indicator_back_ground_redraw = (MMI_BOOL) msg_ptr->param_0;
        lresult = MMI_IMUI_RESULT_TRUE;
		break;
	case MMI_IMUI_MESSAGE_HIDE_INDICATOR_FLOATING:
		g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA_FLOATING);
        lresult = MMI_IMUI_RESULT_TRUE;
		break;
    case MMI_IMUI_MESSAGE_SET_ACTIVE_ROW_ID_VK:
        #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__
        wgui_virtual_keyboard_set_active_row(msg_ptr->param_0);
        #endif
        break;

    case MMI_IMUI_MESSAGE_SHOW_CANDIDATE_BOX:
        
        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;

    case MMI_IMUI_MESSAGE_HIDE_CANDIDATE_BOX:
        
        g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;
		#if defined(__MMI_IME_CANDIDATE_GRID__)
	 case MMI_IMUI_MESSAGE_SHOW_CANDIDATE_GRID_BOX:
        
        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_GRID_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;

    case MMI_IMUI_MESSAGE_HIDE_CANDIDATE_GRID_BOX:
        
        g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_GRID_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;
		#endif
		#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
	case MMI_IMUI_MESSAGE_REMOVE_VERTICAL_FLAG:
		g_imui_composition_box.flags &= ~MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL;
		break;
	case MMI_IMUI_MESSAGE_ADD_VERTICAL_FLAG:
		g_imui_composition_box.flags |= MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL;
		break;

		#endif
#ifdef __MMI_CLIPBOARD_FLOATING_MENU__
    case MMI_IMUI_MESSAGE_SHOW_CLIPBOARD_FLOATING_MENU:
        
        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_CLIPBOARD_FLOATING_MENU);
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;

    case MMI_IMUI_MESSAGE_HIDE_CLIPBOARD_FLOATING_MENU:
        
        g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_CLIPBOARD_FLOATING_MENU);
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;
#endif /* __MMI_CLIPBOARD_FLOATING_MENU__ */

    case MMI_IMUI_MESSAGE_CANDIDATE_BOX_CHANGE_INDEX:
    #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
        if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
        {
            if (msg_ptr->param_0 == 0)
            {
                gui_fixed_list_menu_goto_item(&g_imui_vertical_candidate_list, 0);
            }
            else if ((S32)msg_ptr->param_0 == g_imui_vertical_candidate_list.highlighted_item + 1)
            {
                gui_fixed_list_menu_goto_next_item(&g_imui_vertical_candidate_list);
            }
            else if ((S32)msg_ptr->param_0 == g_imui_vertical_candidate_list.highlighted_item - 1)
            {
                gui_fixed_list_menu_goto_previous_item(&g_imui_vertical_candidate_list);
            }
            else if ((S32)msg_ptr->param_0 != g_imui_vertical_candidate_list.highlighted_item)
            {
                gui_fixed_list_menu_goto_item(&g_imui_vertical_candidate_list, (S32)msg_ptr->param_0);
            }
        }
        else
    #endif /* #if defined(__MMI_IME_VERTICAL_CAND_BOX__) */
        {
            g_imui_candidate_box.highlight_index = (S32)msg_ptr->param_0;
			  #if defined(__MMI_IME_CANDIDATE_GRID__)
			//g_imui_candidate_box_grid.highlight_index = (S32)msg_ptr->param_0;
			#endif
        }
        break;

    case MMI_IMUI_MESSAGE_UPDATE_CANDIDATE_BOX:

     #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
        if (((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0)->flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
        {
            g_imui_candidate_box.flags = ((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0)->flags | MMI_IMUI_SELECTION_AREA_FLAG_FLOATING;
            
            lresult = mmi_imui_update_vertical_candidate_list((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0);
        }
        else
    #endif
        {
        #if defined(__MMI_IME_FLOATING_CAND_BOX__)
            g_imui_ui_param.imui_floating_width = g_imui_ui_param.imui_width - MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE * 2; 
            g_imui_ui_param.imui_floating_left = g_imui_ui_param.imui_left + MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE;

            if (((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0)->flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
            {
                g_imui_candidate_box.x = g_imui_ui_param.imui_floating_left + MMI_IMUI_CANDIDATE_BOX_LEFT_GAP;
                g_imui_candidate_box.width = g_imui_ui_param.imui_floating_width - (MMI_IMUI_CANDIDATE_BOX_LEFT_GAP + MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP);
            }
            else
            {
                g_imui_candidate_box.x = g_imui_ui_param.imui_left + MMI_IMUI_CANDIDATE_BOX_LEFT_GAP;
                g_imui_candidate_box.width = g_imui_ui_param.imui_width - (MMI_IMUI_CANDIDATE_BOX_LEFT_GAP + MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP);
            }
        #endif /* #if defined(__MMI_IME_FLOATING_CAND_BOX__) */
                
            lresult = mmi_imui_update_selection_area(&g_imui_candidate_box, (mmi_imui_update_selection_area_struct_p)msg_ptr->param_0);

        #if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_INDEX)
            if ((g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_CENTER_INDEX) && lresult > 0)
            {
                mmi_imui_reorder_candidates_to_center_first(((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0)->str_ptr, (S32)lresult);
                lresult = mmi_imui_update_selection_area(&g_imui_candidate_box, (mmi_imui_update_selection_area_struct_p)msg_ptr->param_0);
            }
        #endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_INDEX)*/
        }
        break;
    #if defined(__MMI_IME_CANDIDATE_GRID__)
	case MMI_IMUI_MESSAGE_UPDATE_CANDIDATE_BOX_GRID:
		   lresult = mmi_imui_update_selection_area(&g_imui_candidate_box, (mmi_imui_update_selection_area_struct_p)msg_ptr->param_0);
           lresult = mmi_imui_update_selection_area_grid(&g_imui_candidate_box_grid, (mmi_imui_update_selection_area_struct_p)msg_ptr->param_0);
		  
           break;
#endif
    case MMI_IMUI_MESSAGE_CANDIDATE_BOX_GET_INDEX:

    #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
        if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
        {
            lresult = g_imui_vertical_candidate_list.highlighted_item;
        }
        else
    #endif
        {
            lresult = g_imui_candidate_box.highlight_index;
        }
        break;
		#if defined(__MMI_IME_CANDIDATE_GRID__)
    case MMI_IMUI_MESSAGE_CANDIDATE_GRID_BOX_GET_INDEX:
            lresult = g_imui_candidate_box_grid.highlight_index;
			break;
		#endif
    case MMI_IMUI_MESSAGE_CANDIDATE_SET_FOCUS:

        g_imui_candidate_box.flags |= MMI_IMUI_SELECTION_AREA_FLAG_FOCUS;
        
        break;
        
    case MMI_IMUI_MESSAGE_CANDIDATE_CANCEL_FOCUS:
 
        g_imui_candidate_box.flags &= ~MMI_IMUI_SELECTION_AREA_FLAG_FOCUS;
        
        break;

    case MMI_IMUI_MESSAGE_RESERVE_CANDIDATE_AREA:
        g_imui_candidate_box.flags |= MMI_IMUI_SELECTION_AREA_FLAG_RESERVE;
        break;
        
    case MMI_IMUI_MESSAGE_SHOW_COMPOSITION_BOX:

        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;

    case MMI_IMUI_MESSAGE_HIDE_COMPOSITION_BOX:
        
        g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA);
        
        break;

    case MMI_IMUI_MESSAGE_UPDATE_COMPOSITION_BOX:

    #if defined(__MMI_IME_FLOATING_CAND_BOX__)
        g_imui_ui_param.imui_floating_width = g_imui_ui_param.imui_width - MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE * 2; 
        g_imui_ui_param.imui_floating_left = g_imui_ui_param.imui_left + MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE;

        if ((((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0)->flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) && 
            !(((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0)->flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE))
        {
            g_imui_composition_box.x = g_imui_ui_param.imui_floating_left + MMI_IMUI_COMPOSITION_BOX_LEFT_GAP;
            g_imui_composition_box.width = g_imui_ui_param.imui_floating_width - (MMI_IMUI_COMPOSITION_BOX_LEFT_GAP + MMI_IMUI_COMPOSITION_BOX_RIGHT_GAP);
        }
        else
        {
            g_imui_composition_box.x = g_imui_ui_param.imui_left + MMI_IMUI_COMPOSITION_BOX_LEFT_GAP;
            g_imui_composition_box.width = g_imui_ui_param.imui_width - (MMI_IMUI_COMPOSITION_BOX_LEFT_GAP + MMI_IMUI_COMPOSITION_BOX_RIGHT_GAP);
        }
    #endif /* #if defined(__MMI_IME_FLOATING_CAND_BOX__) */

#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
        if ((((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0)->flags & MMI_IMUI_SELECTION_AREA_FLAG_SCROLLING_COMPOSITION_BOX) && !(mmi_imc_is_grid_state() || mmi_imc_get_ui_style(MMI_IMC_UI_STYLE_FLOAT_ON)))
        {
            lresult = mmi_imui_update_vertical_composition_list((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0);
        }
        else
#endif
        {
            ((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0)->flags |=  MMI_IMUI_SELECTION_AREA_FLAG_SPACE;

#if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
            if (((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0)->flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE)
            {
                g_imui_composition_box.flags = ((mmi_imui_update_selection_area_struct_p)msg_ptr->param_0)->flags;
                mmi_imui_update_resizable_composition_area(&g_imui_resizable_composition_box, (mmi_imui_update_selection_area_struct_p)msg_ptr->param_0);
                lresult = 1;
            }
            else
#endif
            {
                lresult = mmi_imui_update_selection_area(&g_imui_composition_box, (mmi_imui_update_selection_area_struct_p)msg_ptr->param_0);
            }
        }

        break;

    case MMI_IMUI_MESSAGE_COMPOSITION_BOX_CHANGE_INDEX:
        #if defined(__MMI_IME_SCROLLING_COMPOSITION__)
        if((g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL) && !mmi_imc_is_grid_state())//vertical flag
        {
            g_imui_vertical_composition_list_data.flags &= ~UI_MENUITEM_DISABLE_HIGHLIGHT;
            if ((S32)msg_ptr->param_0 == -1)
            {
                g_imui_vertical_composition_list_data.flags |= UI_MENUITEM_DISABLE_HIGHLIGHT;
            }
            else if (msg_ptr->param_0 == 0)
            {
                gui_fixed_list_menu_goto_item(&g_imui_vertical_composition_list, 0);
            }
            else if ((S32)msg_ptr->param_0 == g_imui_vertical_composition_list.highlighted_item + 1)
            {
                gui_fixed_list_menu_goto_next_item(&g_imui_vertical_composition_list);
            }
            else if ((S32)msg_ptr->param_0 == g_imui_vertical_composition_list.highlighted_item - 1)
            {
                gui_fixed_list_menu_goto_previous_item(&g_imui_vertical_composition_list);
            }
            else if ((S32)msg_ptr->param_0 != g_imui_vertical_composition_list.highlighted_item)
            {
                gui_fixed_list_menu_goto_item(&g_imui_vertical_composition_list, (S32)msg_ptr->param_0);
            }
        }
		
    #endif
		{
        g_imui_composition_box.highlight_index = (S32)msg_ptr->param_0;
		}
        
        
        break;
        
    case MMI_IMUI_MESSAGE_COMPOSITION_BOX_GET_INDEX:
        #if defined(__MMI_IME_SCROLLING_COMPOSITION__)
        if (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)//vertical flag
        {
            lresult = g_imui_vertical_composition_list.highlighted_item;
        }
        else
       #endif
		{
        lresult = g_imui_composition_box.highlight_index;
		}
        
        break;
        
    case MMI_IMUI_MESSAGE_COMPOSITION_SET_FOCUS:

        g_imui_composition_box.flags |= MMI_IMUI_SELECTION_AREA_FLAG_FOCUS;
        
        break;

    case MMI_IMUI_MESSAGE_COMPOSITION_CANCEL_FOCUS:
 
        g_imui_composition_box.flags &= ~MMI_IMUI_SELECTION_AREA_FLAG_FOCUS;
        
        break;
        
    case MMI_IMUI_MESSAGE_SHOW_VIRTUAL_KEYBOARD:
    #if defined(__MMI_VIRTUAL_KEYBOARD__)
        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD);
        lresult = MMI_IMUI_RESULT_TRUE;
    #endif    
        break;
        
    case MMI_IMUI_MESSAGE_SHOW_DISABLED_VIRTUAL_KEYBOARD:
#if defined(__MMI_VIRTUAL_KEYBOARD__)
        if (g_imui_last_valid_vk_type != GUI_VIRTUAL_KEYBOARD_MAX_LANG)
        {
         #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
            vk_y = MMI_virtual_keyboard.y;
            wgui_setup_virtual_keyboard(g_imui_last_valid_vk_type);
            wgui_move_virtual_keyboard(MMI_virtual_keyboard.x, vk_y);
            wgui_set_virtual_keyboard_allowed_characters(g_imui_empty_invalid_characters);

            wgui_set_virtual_keyboard_disabled_list((const UI_character_type *)L"", g_imui_empty_invalid_events);    

            mmi_imui_draw_back_ground(MMI_content_x, 
                                      vk_y - MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP,
                                      MMI_content_x + MMI_content_width - 1,
                                      vk_y + MMI_virtual_keyboard.height + MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP - 1);   
            
            wgui_show_virtual_keyboard();
        #elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)
            vk_y = g_wgui_virtual_keyboard.y;
            g_imui_vk_parameter.vk_type = g_imui_last_valid_vk_type;
            wgui_setup_virtual_keyboard(g_imui_vk_parameter.vk_type, g_imui_vk_parameter.vk_style, g_imui_vk_parameter.event_callback, g_imui_vk_parameter.disp_callback);
            wgui_virtual_keyboard_move(g_wgui_virtual_keyboard.x, vk_y);
            wgui_virtual_keyboard_set_allowed_characters(g_imui_empty_invalid_characters);

            wgui_virtual_keyboard_set_disable_list((const UI_character_type *)L"", g_imui_empty_invalid_events);

            mmi_imui_draw_back_ground(MMI_content_x, 
                                      vk_y - MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP,
                                      MMI_content_x + MMI_content_width - 1,
                                      vk_y + g_wgui_virtual_keyboard.height + MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP - 1);   

            wgui_virtual_keyboard_show();
            
        #elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
                    vk_y = g_wgui_virtual_keyboard.y;
            g_imui_vk_parameter.vk_type = g_imui_last_valid_vk_type;
            wgui_setup_virtual_keyboard(g_imui_vk_parameter.vk_type, g_imui_vk_parameter.vk_style);
            wgui_virtual_keyboard_move(g_wgui_virtual_keyboard.x, vk_y);
            wgui_virtual_keyboard_set_allowed_characters(g_imui_empty_invalid_characters);

            wgui_virtual_keyboard_set_disable_list((const UI_character_type *)L"", g_imui_empty_invalid_events);

            mmi_imui_draw_back_ground(MMI_content_x, 
                                      vk_y - MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP,
                                      MMI_content_x + MMI_content_width - 1,
                                      vk_y + g_wgui_virtual_keyboard.height + MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP - 1);   

            wgui_virtual_keyboard_show();
        #endif
        }
#endif
        break;
        
    case MMI_IMUI_MESSAGE_IS_SYMBOL_VK_TYPE:
        #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__
        lresult = wgui_virtual_keyboard_is_symbol_vk((gui_virtual_keyboard_language_enum) msg_ptr->param_0);
        #endif
        break;

    case MMI_IMUI_MESSAGE_SET_VK_SHIFT_STATE:
        #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__
        wgui_virtual_keyboard_set_shift_state((toggle_state_id_mapping_enum) msg_ptr->param_0);
        #endif
        break;
        
    case MMI_IMUI_MESSAGE_ADD_TOGGLE_STATE_ID_VK:
#ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__
        wgui_virtual_keyboard_add_toggle_state_key((toggle_state_key_index_enum)msg_ptr->param_0,(toggle_state_id_mapping_enum) msg_ptr->param_1);
#endif
        break;

        
    case MMI_IMUI_MESSAGE_HIDE_VIRTUAL_KEYBOARD:
    #if defined(__MMI_VIRTUAL_KEYBOARD__)
        g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD);
        lresult = MMI_IMUI_RESULT_TRUE;
    #endif   
        break;

#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)
    case MMI_IMUI_MESSAGE_SHOW_MULTI_BLOCK:

        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;
#endif /*#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)*/
        
#if defined(__MMI_IME_FTE_ENHANCE__) && !defined(__NO_HANDWRITING__) && defined(__MMI_VIRTUAL_KEYBOARD__)        
    case MMI_IMUI_MESSAGE_SHOW_SINGLE_BLOCK:    
        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;        
        break;
    case MMI_IMUI_MESSAGE_HIDE_SINGLE_BLOCK:
        g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA);        
        mmi_imc_pen_stop_singleblock_handwriting();
        lresult = MMI_IMUI_RESULT_TRUE;
        break;
#endif /* defined(__MMI_IME_FTE_ENHANCE__) && !defined(__NO_HANDWRITING__) && defined(__MMI_VIRTUAL_KEYBOARD__) */
        
#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
    case MMI_IMUI_MESSAGE_UPDATE_INPUT_AREA:
        
        mmi_imui_update_input_area(&g_imui_input_box, (mmi_imui_update_input_area_struct_p)msg_ptr->param_0);
            
        break;

    case MMI_IMUI_MESSAGE_SHOW_INPUT_BOX:
        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;
        break;
        
    case MMI_IMUI_MESSAGE_HIDE_INPUT_BOX:
        g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;
        break;
        
    case MMI_IMUI_MESSAGE_INPUT_SET_FOCUS:
        g_imui_input_box.flags |= MMI_IMUI_INPUT_AREA_FLAG_FOCUS;
        
        break;

    case MMI_IMUI_MESSAGE_INPUT_CANCEL_FOCUS:        
        g_imui_input_box.flags &= (~MMI_IMUI_INPUT_AREA_FLAG_FOCUS);
        break;
    
    case MMI_IMUI_MESSAGE_UPDATE_TITLE_AREA:
        
        mmi_imui_update_input_area(&g_imui_title_box, (mmi_imui_update_input_area_struct_p)msg_ptr->param_0);

        break;
        
    case MMI_IMUI_MESSAGE_SHOW_TITLE_BOX:

        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_TITLE_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;
        break;
        
    case MMI_IMUI_MESSAGE_HIDE_TITLE_BOX:

        g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_TITLE_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;
        break;
#endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/

#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)
    case MMI_IMUI_MESSAGE_SELECT_AREA_DISABLE_LABEL:
        g_imui_candidate_box.flags |= MMI_IMUI_SELECTION_AREA_FLAG_DISABLE_LABEL;
        break;
#endif /*MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL*/

#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)
    case MMI_IMUI_MESSAGE_HIDE_MULTI_BLOCK:
        
        g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA);
        lresult = MMI_IMUI_RESULT_TRUE;
        
        break;
#endif /*#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)*/
        
    case MMI_IMUI_MESSAGE_REDRAW:
        lresult = mmi_imui_redraw(msg_ptr->param_0);
        break;
        
    case MMI_IMUI_MESSAGE_REDRAW_FLOATING_CONTROLS:
        
    #if defined(__MMI_IME_FLOATING_CAND_BOX__)
        lresult = mmi_imui_redraw_all_floating_controls();
    #endif
        
        break;
        
    case MMI_IMUI_MESSAGE_HIDE_ALL:

		if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA))
        {
            g_imui_control_set.showed_flag = MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA);
        }
		else
	    {
	        if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INFORMATION_BAR))
	        {
	            g_imui_control_set.showed_flag = MMI_IMUI_CONTROL_MASK(MMI_IMUI_INFORMATION_BAR);
	        }
	        else if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_HINT_AREA))
	        {
	            g_imui_control_set.showed_flag = MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_HINT_AREA);
	        }
	        else
	        {
	            g_imui_control_set.showed_flag = 0;
	        }    
	    }
        
        break;
        
    case MMI_IMUI_MESSAGE_SET_BACK_GROUND_REDRAW_FUNC:

        g_imui_redraw_funcptr = (mmi_imui_draw_back_ground_funcptr)msg_ptr->param_0;
        
        break;
    case MMI_IMUI_MESSAGE_EXIT:
        
        lresult = mmi_imui_deinit_ui();

        break;
        
    case MMI_IMUI_MESSAGE_DRAW_STROKE:
        
#if defined(__MMI_TOUCH_SCREEN__)

        lresult = mmi_imui_draw_hand_writing_stroke((mmi_pen_point_struct *)msg_ptr->param_0, (mmi_pen_point_struct *)msg_ptr->param_1);

#endif /*defined(__MMI_TOUCH_SCREEN__)*/

        break;

    case MMI_IMUI_MESSAGE_SET_STROKE_COLOR:
        
#if defined(__MMI_TOUCH_SCREEN__)

        memcpy(&g_imui_hand_writing_stroke_color, (color *)msg_ptr->param_0, sizeof(color));
        g_imui_hand_writing_stroke_color.alpha = 0xFF;
#endif /*defined(__MMI_TOUCH_SCREEN__)*/

        break;

    case MMI_IMUI_MESSAGE_CLEAR_STROKE:
        
#if defined(__MMI_TOUCH_SCREEN__)

        lresult = mmi_imui_clear_hand_writing_stroke();
        
#endif /*defined(__MMI_TOUCH_SCREEN__)*/

        break;

    case MMI_IMUI_MESSAGE_PEN_DOWN_EVENT:

#if defined(__MMI_TOUCH_SCREEN__)

        lresult = mmi_imui_pen_down_event((mmi_pen_point_struct*)msg_ptr->param_0, command_callback);

		if (lresult)
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = g_imui_pen_down_control;
		}
		else
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = MMI_IMUI_CONTROL_MAX;
		}	

#endif /*defined(__MMI_TOUCH_SCREEN__)*/

        break;

    case MMI_IMUI_MESSAGE_FLOATING_UI_PEN_DOWN_EVENT: /* Only for Venus input server floating control */
    
#if defined(__MMI_TOUCH_SCREEN__) && defined(__MMI_VUI_ENGINE__) && defined(__MMI_IME_FLOATING_CAND_BOX__)
    
        lresult = mmi_imui_floating_ui_pen_down_event((mmi_pen_point_struct*)msg_ptr->param_0, command_callback);
    
        if (lresult)
        {
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = g_imui_pen_down_control;
        }
        else
        {
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = MMI_IMUI_CONTROL_MAX;
        }   
        
#endif /*defined(__MMI_TOUCH_SCREEN__)*/
    
        break;

    case MMI_IMUI_MESSAGE_PEN_UP_EVENT:

#if defined(__MMI_TOUCH_SCREEN__)

        lresult = mmi_imui_pen_up_event((mmi_pen_point_struct*)msg_ptr->param_0, command_callback);

		if (lresult)
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = g_imui_pen_down_control;
		}
		else
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = MMI_IMUI_CONTROL_MAX;
		}	

#endif /*defined(__MMI_TOUCH_SCREEN__)*/

        break;

    case MMI_IMUI_MESSAGE_PEN_MOVE_EVENT:

#if defined(__MMI_TOUCH_SCREEN__)

        lresult = mmi_imui_pen_move_event((mmi_pen_point_struct*)msg_ptr->param_0, command_callback);

		if (lresult)
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = g_imui_pen_down_control;
		}
		else
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = MMI_IMUI_CONTROL_MAX;
		}	

#endif /*defined(__MMI_TOUCH_SCREEN__)*/

        break;
    case MMI_IMUI_MESSAGE_PEN_REPEAT_EVENT:

#if defined(__MMI_TOUCH_SCREEN__)

        lresult = mmi_imui_pen_repeat_event((mmi_pen_point_struct*)msg_ptr->param_0, command_callback);

		if (lresult)
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = g_imui_pen_down_control;
		}
		else
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = MMI_IMUI_CONTROL_MAX;
		}	

#endif /*defined(__MMI_TOUCH_SCREEN__)*/

        break;
    case MMI_IMUI_MESSAGE_PEN_LONG_TAP_EVENT:

#if defined(__MMI_TOUCH_SCREEN__)

        lresult = mmi_imui_pen_long_tap_event((mmi_pen_point_struct*)msg_ptr->param_0, command_callback);

		if (lresult)
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = g_imui_pen_down_control;
		}
		else
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = MMI_IMUI_CONTROL_MAX;
		}	

#endif /*defined(__MMI_TOUCH_SCREEN__)*/

        break;

    case MMI_IMUI_MESSAGE_PEN_ABORT_EVENT:

#if defined(__MMI_TOUCH_SCREEN__)

        lresult = mmi_imui_pen_abort_event((mmi_pen_point_struct*)msg_ptr->param_0, command_callback);

		if (lresult)
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = g_imui_pen_down_control;
		}
		else
		{
            *((mmi_imui_control_type_enum *)msg_ptr->param_1) = MMI_IMUI_CONTROL_MAX;
		}	

#endif /*defined(__MMI_TOUCH_SCREEN__)*/
        break;

#if defined(__MMI_TOUCH_SCREEN__) && defined(__MMI_HANDWRITING_MULTI_BLOCK__)    
    case MMI_IMUI_MESSAGE_GET_MULTI_BLOCK_AREA:
        
        ((mmi_imc_rect_p)msg_ptr->param_0)->x = g_imui_ui_param.imui_left + MMI_IMUI_MULTIBLOCK_LEFT_GAP + 2 + 1;
        ((mmi_imc_rect_p)msg_ptr->param_0)->y = g_imui_ui_param.imui_bottom - (MMI_IMUI_MULTIBLOCK_BOTTOM_GAP + MMI_IMUI_MULTI_BLOCK_HEIGHT) + 3 + 1;
        ((mmi_imc_rect_p)msg_ptr->param_0)->width = (g_imui_ui_param.imui_width - 1 - MMI_IMUI_MULTIBLOCK_RIGHT_GAP - MMI_IMUI_MULTIBLOCK_LEFT_GAP) / 2 - 4 - 2;
        ((mmi_imc_rect_p)msg_ptr->param_0)->height = MMI_IMUI_MULTI_BLOCK_HEIGHT - 4 - 2;

        ((mmi_imc_rect_p)msg_ptr->param_1)->x = (g_imui_ui_param.imui_width - 1 - MMI_IMUI_MULTIBLOCK_RIGHT_GAP - MMI_IMUI_MULTIBLOCK_LEFT_GAP) / 2 + 2+ 1;
        ((mmi_imc_rect_p)msg_ptr->param_1)->y = g_imui_ui_param.imui_bottom - (MMI_IMUI_MULTIBLOCK_BOTTOM_GAP + MMI_IMUI_MULTI_BLOCK_HEIGHT) + 3+ 1;
        ((mmi_imc_rect_p)msg_ptr->param_1)->width = (g_imui_ui_param.imui_width - 1 - MMI_IMUI_MULTIBLOCK_RIGHT_GAP - MMI_IMUI_MULTIBLOCK_LEFT_GAP) / 2 - 1- 2;
        ((mmi_imc_rect_p)msg_ptr->param_1)->height = MMI_IMUI_MULTI_BLOCK_HEIGHT - 4 - 2;
        
        break;
#endif
#if defined(__MMI_TOUCH_SCREEN__) && defined(__MMI_IME_FTE_ENHANCE__) && defined(__MMI_VIRTUAL_KEYBOARD__) && !defined(__NO_HANDWRITING__)  
    case MMI_IMUI_MESSAGE_GET_SINGLE_BLOCK_AREA:

#if !defined  __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__
        if (mmi_imc_is_rotated())
        {
            ((mmi_imc_rect_p)msg_ptr->param_0)->x = g_imui_ui_param.imui_left + MMI_IMUI_SINGLE_BLOCK_LEFT_GAP;
            /* when virtaul keyboard is on, the buttom line is over softkey area. */
            ((mmi_imc_rect_p)msg_ptr->param_0)->y = UI_device_height - 1 - (MMI_IMUI_SINGLE_BLOCK_BOTTOM_GAP + MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED) + 3;
            ((mmi_imc_rect_p)msg_ptr->param_0)->width = MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED - 1;
            ((mmi_imc_rect_p)msg_ptr->param_0)->height = MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED - 3;     
        }
        else
        {
            ((mmi_imc_rect_p)msg_ptr->param_0)->x = g_imui_ui_param.imui_left + MMI_IMUI_SINGLE_BLOCK_LEFT_GAP;
            /* when virtaul keyboard is on, the buttom line is over softkey area. */
            ((mmi_imc_rect_p)msg_ptr->param_0)->y = UI_device_height - 1 - (MMI_IMUI_SINGLE_BLOCK_BOTTOM_GAP + MMI_IMUI_SINGLE_BLOCK_HEIGHT) + 3;
            ((mmi_imc_rect_p)msg_ptr->param_0)->width = MMI_IMUI_SINGLE_BLOCK_WIDTH - 1;
            ((mmi_imc_rect_p)msg_ptr->param_0)->height = MMI_IMUI_SINGLE_BLOCK_HEIGHT - 3;     
        }
#else
        {
            U8 uWidth = mmi_imm_handwriting_get_stroke_width();
            if (mmi_imc_is_rotated())
            {
                ((mmi_imc_rect_p)msg_ptr->param_0)->x = MMI_IMUI_SINGLE_BLOCK_X_ROTATED + MMI_IMUI_SINGLE_BLOCK_AND_STROKE_AREA_GAP + uWidth/2;
                ((mmi_imc_rect_p)msg_ptr->param_0)->y = MMI_IMUI_SINGLE_BLOCK_Y_ROTATED + MMI_IMUI_SINGLE_BLOCK_AND_STROKE_AREA_GAP + uWidth/2;
                ((mmi_imc_rect_p)msg_ptr->param_0)->width = MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED - MMI_IMUI_SINGLE_BLOCK_AND_STROKE_AREA_GAP * 2 - uWidth;
                ((mmi_imc_rect_p)msg_ptr->param_0)->height = MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED - MMI_IMUI_SINGLE_BLOCK_AND_STROKE_AREA_GAP * 2 - uWidth;  
            }
            else
            {
                ((mmi_imc_rect_p)msg_ptr->param_0)->x = MMI_IMUI_SINGLE_BLOCK_X + MMI_IMUI_SINGLE_BLOCK_AND_STROKE_AREA_GAP + uWidth/2;
                ((mmi_imc_rect_p)msg_ptr->param_0)->y = MMI_IMUI_SINGLE_BLOCK_Y + MMI_IMUI_SINGLE_BLOCK_AND_STROKE_AREA_GAP + uWidth/2;
                ((mmi_imc_rect_p)msg_ptr->param_0)->width = MMI_IMUI_SINGLE_BLOCK_WIDTH - MMI_IMUI_SINGLE_BLOCK_AND_STROKE_AREA_GAP * 2- uWidth;
                ((mmi_imc_rect_p)msg_ptr->param_0)->height = MMI_IMUI_SINGLE_BLOCK_HEIGHT - MMI_IMUI_SINGLE_BLOCK_AND_STROKE_AREA_GAP * 2 - uWidth;  
            }
        }

#endif
            
        break;
#endif
    case MMI_IMUI_MESSAGE_DRAW_INFORMATION_BAR:

        //if (mmi_imui_is_in_control_set(MMI_IMUI_INFORMATION_BAR))
        {
            memcpy(&g_imui_information_bar_rect, (mmi_imc_rect *)msg_ptr->param_0, sizeof(mmi_imc_rect));
            mmi_imui_draw_information_bar();
            g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_INFORMATION_BAR);
        }
        
        break;
        
    case MMI_IMUI_MESSAGE_GET_IME_INFOR_WIDTH:
        lresult = mmi_imui_get_ime_infor_width();
        break;
        
    case MMI_IMUI_MESSAGE_GET_VK_AREA_HEIGHT:
#if defined(__MMI_VIRTUAL_KEYBOARD__)
        #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
        lresult = (U32)(MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + MMI_virtual_keyboard.height);
        #elif defined (__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)
        lresult = (U32)(MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + g_wgui_virtual_keyboard.height);
        #else
        lresult = (U32)(MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + wgui_virtual_keyboard_get_vk_height());
        #endif
#endif
        break;

    case MMI_IMUI_MESSAGE_GET_VK_TYPE:
#if defined(__MMI_VIRTUAL_KEYBOARD__)
        #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
        lresult = (U32)(MMI_virtual_keyboard.lang_type);
        #else
        lresult = (U32)(g_wgui_virtual_keyboard_lang_type);
        #endif
#endif
        break;

    case MMI_IMUI_GET_VK_KEY_POSITION:
#if defined(__MMI_VIRTUAL_KEYBOARD__) && defined(__MMI_IME_FTE_ENHANCE__)
        wgui_virtual_keyboard_get_key_info((gui_virtual_keyboard_key_pos_info_struct_p)msg_ptr->param_0);
#endif
        break;

    case MMI_IMUI_SET_HW_EXTRA_BLOCK_INDICATOR:
#if defined(__MMI_IME_FTE_ENHANCE__) && !defined(__NO_HANDWRITING__) && defined(__MMI_VIRTUAL_KEYBOARD__)
        g_imui_single_block_area.indicator_id = (U16)msg_ptr->param_0;
#endif
        break;
        
    #if defined(__MMI_IME_VK_TYPE_QWERTY__) && defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    case MMI_IMUI_MESSAGE_GET_QWERTY_VK_KEY_MAPPING:
        wgui_virtual_keyboard_get_qwerty_keymapping((UI_character_type*) msg_ptr->param_0, msg_ptr->param_1);
        break;
    #endif
    case MMI_IMUI_MESSAGE_SET_NEW_WORD_PROMPT:
#if defined(__MMI_IME_USER_DATABASE__)
        g_imui_new_word_prompt_ptr = (UI_string_type)msg_ptr->param_0;
#endif
        break;
        
    case MMI_IMUI_MESSAGE_GET_MAX_CANDIDATE_WIDTH:
        lresult = (U32)mmi_imui_get_max_candidate_width();
        break;
        
    case MMI_IMUI_MESSAGE_GET_IME_HINT_WIDTH:
        lresult = (U32)mmi_imui_get_ime_hint_width();
        break;

    case MMI_IMUI_MESSAGE_GET_IME_HINT_HEIGHT:
        lresult = (U32)mmi_imui_get_ime_hint_height();
        break;

    case MMI_IMUI_MESSAGE_DRAW_IME_HINT:
        memcpy(&g_imui_ime_hint_rect, (mmi_imc_rect *)msg_ptr->param_0, sizeof(mmi_imc_rect));
        mmi_imui_draw_ime_hint(&g_imui_ime_hint_rect);
        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_HINT_AREA);
        
        if (!mmi_imui_is_in_control_set(MMI_IMUI_IME_HINT_AREA))
        {
            mmi_imui_add_control(MMI_IMUI_IME_HINT_AREA);
        }
        break;
    
    case MMI_IMUI_MESSAGE_FIXED_IMUI_HEIGHT:
    #if defined(__MMI_IME_FLOATING_CAND_BOX__)
        if ((g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL) || 
             (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING))
        {
            msg_ptr->param_0 &= ~(MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA));
        }

        if ((g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE) || 
             (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING))
        {
            msg_ptr->param_0 &= ~(MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA));
        }

        msg_ptr->param_0 &= ~(MMI_IMUI_CONTROL_MASK(MMI_IMUI_CLIPBOARD_FLOATING_MENU));
    #endif
        lresult = (U32)mmi_imui_get_imui_height_by_ui_set(msg_ptr->param_0);
        break;
        
    case MMI_IMUI_MESSAGE_FLOATING_IMUI_HEIGHT:
    #if defined(__MMI_IME_FLOATING_CAND_BOX__)
        lresult = (U32)mmi_imui_get_floating_ui_height();
    #else
        lresult = 0;
    #endif
        break;

    case MMI_IMUI_MESSAGE_GET_FLOATING_IMUI_SET:
    #if defined(__MMI_IME_FLOATING_CAND_BOX__)
        lresult = (U32)mmi_imui_get_floating_control_set();
    #else
        lresult = 0;
    #endif
        break;

    case MMI_IMUI_MESSAGE_SET_IMUI_PARAMETERS:
        mmi_imui_set_imui_parameters((mmi_imui_param_struct *)msg_ptr->param_0);
        break;
        
	case MMI_IMUI_MESSAGE_GET_IMUI_PARAMETERS:
        mmi_imui_get_imui_parameters((mmi_imui_param_struct *)msg_ptr->param_0);
        break;

    case MMI_IMUI_MESSAGE_GET_LAST_SHOWED_IMUI_SET:
        lresult = g_imui_control_set.last_showed_flag;
        break;

#if defined(__MMI_VIRTUAL_KEYBOARD__)
    case MMI_IMUI_MESSAGE_CONFIG_REDRAW_VK:
        mmi_imui_config_redraw_vk((MMI_BOOL)msg_ptr->param_0);
        break;
#if defined(__MMI_IME_FTE_ENHANCE__)        
    case MMI_IMUI_MESSAGE_SET_VK_STYLE:
        g_imui_vk_parameter.vk_style = (U32)((mmi_imui_param_struct *)msg_ptr->param_0);
        #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)
        wgui_setup_virtual_keyboard(g_imui_vk_parameter.vk_type, g_imui_vk_parameter.vk_style, g_imui_vk_parameter.event_callback, g_imui_vk_parameter.disp_callback);
        #elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
        wgui_setup_virtual_keyboard(g_imui_vk_parameter.vk_type, g_imui_vk_parameter.vk_style);
        #endif
        {
            mmi_imc_message_struct imc_message;
        
            imc_message.message_id = MMI_IMC_MESSAGE_IS_THERE_CURSOR;

            if (mmi_imc_send_message(&imc_message))
            {
                mmi_imc_stop_cursor_funcptr stop_ptr = NULL;
                mmi_imc_start_cursor_funcptr start_ptr = NULL;

                imc_message.message_id = MMI_IMC_MESSAGE_GET_STOP_CURSOR_CALLBACK_FUNCPTR;

                stop_ptr = (mmi_imc_stop_cursor_funcptr)mmi_imc_send_message(&imc_message);

                imc_message.message_id = MMI_IMC_MESSAGE_GET_START_CURSOR_CALLBACK_FUNCPTR;

                start_ptr = (mmi_imc_start_cursor_funcptr)mmi_imc_send_message(&imc_message);

                if (start_ptr && stop_ptr)
                {
                    wgui_virtual_keyboard_register_hide_cursor_callback(stop_ptr);
                    wgui_virtual_keyboard_register_blink_cursor_callback(start_ptr);
                }
                else
                {
                    MMI_ASSERT(!start_ptr && !stop_ptr);
                    wgui_virtual_keyboard_register_hide_cursor_callback(UI_inputbox_stop_cursor);
                    wgui_virtual_keyboard_register_blink_cursor_callback(UI_inputbox_start_cursor);
                }
            }
        }

        break;
        
        case MMI_IMUI_MESSAGE_GET_VK_AREA_RECT:
    #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__
            wgui_virtual_keyboard_get_vk_rect((gui_virtual_keyboard_rect_struct_p)msg_ptr->param_0,(MMI_BOOL) msg_ptr->param_1);
    #endif
        break;

#endif /* defined(__MMI_IME_FTE_ENHANCE__) */
#endif /* defined(__MMI_VIRTUAL_KEYBOARD__) */

#if defined(__MMI_IME_FLOATING_CAND_BOX__)
#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)
    case MMI_IMUI_MESSAGE_CHECK_FLOATING_UI_CONTAIN_POINT:
        lresult = mmi_imui_check_floating_ui_contain_point((mmi_imc_point_p)msg_ptr->param_0);
        break;  
        
    case MMI_IMUI_DOES_FLOATING_UI_COVER_IME_INDICATOR:
        lresult = mmi_imui_check_floating_ui_cover_ime_indicator();
        break;
#endif /*#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)*/
    case MMI_IMUI_SET_FLOATING_CANDIDATE_BOX:
        g_imui_candidate_box.flags |= MMI_IMUI_SELECTION_AREA_FLAG_FLOATING;
        g_imui_composition_box.flags |= MMI_IMUI_SELECTION_AREA_FLAG_FLOATING;
        break;
#endif

#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)
		case MMI_IMUI_DOES_UI_COVER_IME_INDICATOR:
		lresult = mmi_imui_check_ui_cover_ime_indicator();
		break;
#endif /*#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)*/

#if defined(__MMI_IME_FLOATING_CAND_BOX__) 
    case MMI_IMUI_CHECK_OVERLAP_WITH_CURRENT_FLOATING_UI:
        {
			if (g_imui_control_set.last_showed_floating_flag != 0)
			{
				lresult = mmi_imui_rects_overlap((mmi_imc_rect_p)msg_ptr->param_0, &g_imui_control_set.last_showed_floating_ui_rect);
			}
			else
			{
                lresult = MMI_FALSE;
			}
        }
        break;

    case MMI_IMUI_GET_FLOATING_UI_RECT:
        if (g_imui_control_set.last_showed_floating_flag != 0 && mmi_imui_get_floating_control_set())
        {
            memcpy((mmi_imc_rect_p)msg_ptr->param_0, &g_imui_control_set.last_showed_floating_ui_rect, sizeof(mmi_imc_rect));

            lresult = MMI_TRUE; 
        }
        else
        {
            lresult = MMI_FALSE; 
        }    
        break;
#endif /* #if defined(__MMI_IME_FLOATING_CAND_BOX__)  */

#if defined(__MMI_TOUCH_SCREEN__) && !defined(MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER)    
    case MMI_IMUI_MESSAGE_GET_EXTRA_IMUI_LAYER_HANDLER:
        lresult = (U32)g_imui_hand_writing_GDI_handle;
        break;
#endif
	
	case MMI_IMUI_MESSAGE_EXIT_HANDWRITING_ON_DISCONNECT:
		mmi_imui_exit_handwriting_on_disconnect();
		break;

    case MMI_IMUI_MESSAGE_ADD_CONTROL:
        mmi_imui_add_control((mmi_imui_control_type_enum)msg_ptr->param_0);
        break;

    case MMI_IMUI_MESSAGE_IS_IN_CONTROL_SET:
        lresult = (U32)mmi_imui_is_in_control_set((mmi_imui_control_type_enum)msg_ptr->param_0);
        break;        

    case MMI_IMUI_MESSAGE_SET_VISIBLE_CONTROL:
        g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK((mmi_imui_control_type_enum)msg_ptr->param_0);
        break;

    case MMI_IMUI_MESSAGE_SET_HIDDEN_CONTROL:
        g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK((mmi_imui_control_type_enum)msg_ptr->param_0);
        break;

    case MMI_IMUI_MESSAGE_IS_VISIBLE_CONTROL:
        if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK((mmi_imui_control_type_enum)msg_ptr->param_0))
        {
            lresult = MMI_TRUE;
        }
        else
        {
            lresult = MMI_FALSE; 
        }
        break;

    case MMI_IMUI_MESSAGE_IS_PREVIOUS_VISIBLE_CONTROL:
        if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK((mmi_imui_control_type_enum)msg_ptr->param_0))
        {
            lresult = MMI_TRUE;
        }
        else
        {
            lresult = MMI_FALSE; 
        }
        break;
        
#if defined(__MMI_IME_FLOATING_CAND_BOX__)
    case MMI_IMUI_MESSAGE_IS_PREVIOUS_VISIBLE_FLOATING_CONTROL:
        if (g_imui_control_set.last_showed_floating_flag & MMI_IMUI_CONTROL_MASK((mmi_imui_control_type_enum)msg_ptr->param_0))
        {
            lresult = MMI_TRUE;
        }
        else
        {
            lresult = MMI_FALSE; 
        }
        break;
#endif

    case MMI_IMUI_MESSAGE_REDRAW_IMUI_BACKGROUND:
        mmi_imui_draw_back_ground(((mmi_imc_rect_p)msg_ptr->param_0)->x,
                                  ((mmi_imc_rect_p)msg_ptr->param_0)->y,
                                  ((mmi_imc_rect_p)msg_ptr->param_0)->x + ((mmi_imc_rect_p)msg_ptr->param_0)->width,
                                  ((mmi_imc_rect_p)msg_ptr->param_0)->y + ((mmi_imc_rect_p)msg_ptr->param_0)->height);
        break;

    case MMI_IMUI_MESSAGE_IS_VIRTUAL_KEYBOARD_HIDDEN:
        if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
        {
            lresult = MMI_TRUE;
        }
        else
        {
            lresult = MMI_FALSE; 
        }
        break;
        
    default:
        break;
        
    }
    return lresult;
}


/*****************************************************************************
 * Local functions
 *****************************************************************************/
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_init_ui
 * DESCRIPTION
 *  Invoked when conected to IME
 * PARAMETERS
 * RETURNS
 *  Whether it have initalzed the controls successfully
 *****************************************************************************/
static U32 mmi_imui_init_ui(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 lresult = MMI_IMUI_RESULT_TRUE;   
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_imui_update_ui_theme();
    mmi_imui_update_ui_param();

    memset(&g_imui_control_set, 0, sizeof(mmi_imui_control_set_struct));
    
#if defined(__MMI_TOUCH_SCREEN__)

    lresult = mmi_imui_create_hand_writing_layer();

#endif /*defined(__MMI_TOUCH_SCREEN__)*/

    return lresult;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_ui_param
 * DESCRIPTION
 *  Update ui parameters
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_update_ui_param(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    S32 w;
    S32 h;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_imui_get_char_extent(g_imui_ui_theme.font_label, '8', &w, &h);
    g_imui_ui_param.font_label_width = w;
    g_imui_ui_param.font_label_height = h;

    mmi_imui_get_char_extent(g_imui_ui_theme.font_text, 'W', &w, &h);
    g_imui_ui_param.font_alpha_width = w;
    g_imui_ui_param.font_alpha_height = h;

    mmi_imui_get_char_extent(g_imui_ui_theme.font_text, 0x4E00, &w, &h);
    g_imui_ui_param.font_chinese_width = w;
    g_imui_ui_param.font_chinese_height = h;

#ifdef UI_SMALL_CATEGORY_EDITOR
    if (g_small_editor_category_present)
    {
        g_imui_ui_param.imui_bottom = MMI_multitap_y + MMI_multitap_height;
        g_imui_ui_param.imui_left = MMI_multitap_x;
        g_imui_ui_param.imui_width = MMI_multitap_width;
		g_imui_ui_param.imui_bottom_border = 1;
    }
    else
#endif
    {
        g_imui_ui_param.imui_bottom = MMI_content_y + MMI_content_height - 1;
#ifdef __MMI_ICON_BAR_SUPPORT__
#ifdef __MMI_FTE_SUPPORT__
        if (MMI_TRUE == wgui_icon_bar_is_created())
        {
            g_imui_ui_param.imui_bottom -= MMI_ICON_BAR_HEIGHT;
        }
#endif
#endif /*__MMI_ICON_BAR_SUPPORT__*/
        g_imui_ui_param.imui_left = MMI_content_x;
        g_imui_ui_param.imui_width = MMI_content_width;
		g_imui_ui_param.imui_bottom_border = 0;
        
    #if defined(__MMI_SCREEN_ROTATE__) && defined(__MMI_MAINLCD_320X480__)
        if (mmi_frm_is_screen_width_height_swapped())
        {
            g_imui_ui_param.imui_bottom = MMI_ROTATED_CONTENT_Y + MMI_ROTATED_CONTENT_HEIGHT - 1;
            g_imui_ui_param.imui_left =MMI_ROTATED_CONTENT_X;
            g_imui_ui_param.imui_width = MMI_ROTATED_CONTENT_WIDTH;
    		g_imui_ui_param.imui_bottom_border = 0;
        }
    #endif

    }

#if defined(__MMI_IME_FLOATING_CAND_BOX__)
    g_imui_ui_param.imui_floating_width = g_imui_ui_param.imui_width - MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE * 2;
    g_imui_ui_param.imui_floating_left = g_imui_ui_param.imui_left + MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE;
#endif

    g_imui_ui_param.arrow_width = MMI_IMUI_ARROW_WIDTH;
    g_imui_ui_param.arrow_height = MMI_IMUI_ARROW_HEIGHT;

#if defined(__MMI_IME_CANDIDATE_GRID__)
	g_imui_ui_param.expand_button_width = MMI_IMUI_CAND_GRID_EXPAND_WIDTH;
	g_imui_ui_param.expand_button_height = MMI_IMUI_CAND_GRID_EXPAND_HEIGHT;
#endif

    g_imui_ui_param.cursor_width = MMI_IMUI_CURSOR_WIDTH;
    g_imui_ui_param.cursor_height = g_imui_ui_param.font_alpha_height;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_ui_theme
 * DESCRIPTION
 *  Update ui theme
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_update_ui_theme(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	UI_ime_theme * now_using_theme = NULL;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef UI_SMALL_CATEGORY_EDITOR
    if (g_small_editor_category_present)
	{
		now_using_theme = &g_imui_small_editor_theme;
	}
	else
#endif /* UI_SMALL_CATEGORY_EDITOR */	
	{
        now_using_theme = current_ime_theme;
	}

    g_imui_ui_theme.font_text                   = now_using_theme->text_font;
    g_imui_ui_theme.font_label                  = now_using_theme->label_font;
    g_imui_ui_theme.underline_color             = now_using_theme->underline_color;
    g_imui_ui_theme.indicator_color             = now_using_theme->indicator_color;
    g_imui_ui_theme.focused_background_filler   = now_using_theme->focused_background_filler;
    g_imui_ui_theme.background_filler           = now_using_theme->background_filler;
    g_imui_ui_theme.focused_border_color        = now_using_theme->focused_border_color;
    g_imui_ui_theme.border_color                = now_using_theme->border_color;
    g_imui_ui_theme.text_space                  = now_using_theme->text_space;
    g_imui_ui_theme.label_color                 = now_using_theme->label_color;
    g_imui_ui_theme.cursor_color                = now_using_theme->cursor_color;
    g_imui_ui_theme.arrow_disable_color         = now_using_theme->arrow_disable_color;
    g_imui_ui_theme.arrow_down_color            = now_using_theme->arrow_down_color;
    g_imui_ui_theme.arrow_up_color              = now_using_theme->arrow_up_color;
    g_imui_ui_theme.stroke_color                = now_using_theme->stroke_color;
    g_imui_ui_theme.highlighted_stroke_color    = now_using_theme->highlighted_stroke_color;
    g_imui_ui_theme.stroke_highlight_color      = now_using_theme->stroke_highlight_color;

#if defined(__COSMOS_MMI__)
    g_imui_ui_theme.cand_background_small       = (PU8) GetImage(VADP_IMG_IME_CAND_BG_SMALL);
    g_imui_ui_theme.cand_background_medium      = (PU8) GetImage(VADP_IMG_IME_CAND_BG_MEDIUM);
    g_imui_ui_theme.cand_background_large       = (PU8) GetImage(VADP_IMG_IME_CAND_BG_LARGE);
    g_imui_ui_theme.cand_focus_frame_small      = (PU8) GetImage(VADP_IMG_IME_CAND_FOCUS_FRAME_SMALL);
    g_imui_ui_theme.cand_focus_frame_medium     = (PU8) GetImage(VADP_IMG_IME_CAND_FOCUS_FRAME_MEDIUM);
    g_imui_ui_theme.cand_focus_frame_large      = (PU8) GetImage(VADP_IMG_IME_CAND_FOCUS_FRAME_LARGE);
    g_imui_ui_theme.cand_separator_small        = (PU8) GetImage(VADP_IMG_IME_CAND_SEP_SMALL);
    g_imui_ui_theme.cand_separator_medium       = (PU8) GetImage(VADP_IMG_IME_CAND_SEP_MEDIUM);
    g_imui_ui_theme.cand_separator_large        = (PU8) GetImage(VADP_IMG_IME_CAND_SEP_LARGE);
    g_imui_ui_theme.cand_left_arrow_down_small  = (PU8) GetImage(VADP_IMG_IME_CAND_LEFT_ARROW_DOWN_SMALL);
    g_imui_ui_theme.cand_left_arrow_down_medium = (PU8) GetImage(VADP_IMG_IME_CAND_LEFT_ARROW_DOWN_MEDIUM);
    g_imui_ui_theme.cand_left_arrow_down_large  = (PU8) GetImage(VADP_IMG_IME_CAND_LEFT_ARROW_DOWN_LARGE);
    g_imui_ui_theme.cand_left_arrow_up_small    = (PU8) GetImage(VADP_IMG_IME_CAND_LEFT_ARROW_NORMAL_SMALL);
    g_imui_ui_theme.cand_left_arrow_up_medium   = (PU8) GetImage(VADP_IMG_IME_CAND_LEFT_ARROW_NORMAL_MEDIUM);
    g_imui_ui_theme.cand_left_arrow_up_large    = (PU8) GetImage(VADP_IMG_IME_CAND_LEFT_ARROW_NORMAL_LARGE);
    g_imui_ui_theme.cand_left_arrow_disable_small = (PU8) GetImage(VADP_IMG_IME_CAND_LEFT_ARROW_DISABLE_SMALL);
    g_imui_ui_theme.cand_left_arrow_disable_medium = (PU8) GetImage(VADP_IMG_IME_CAND_LEFT_ARROW_DISABLE_MEDIUM);
    g_imui_ui_theme.cand_left_arrow_disable_large = (PU8) GetImage(VADP_IMG_IME_CAND_LEFT_ARROW_DISABLE_LARGE);
    g_imui_ui_theme.cand_right_arrow_down_small   = (PU8) GetImage(VADP_IMG_IME_CAND_RIGHT_ARROW_DOWN_SMALL);
    g_imui_ui_theme.cand_right_arrow_down_medium = (PU8) GetImage(VADP_IMG_IME_CAND_RIGHT_ARROW_DOWN_MEDIUM);
    g_imui_ui_theme.cand_right_arrow_down_large = (PU8) GetImage(VADP_IMG_IME_CAND_RIGHT_ARROW_DOWN_LARGE);
    g_imui_ui_theme.cand_right_arrow_up_small   = (PU8) GetImage(VADP_IMG_IME_CAND_RIGHT_ARROW_NORMAL_SMALL);
    g_imui_ui_theme.cand_right_arrow_up_medium  = (PU8) GetImage(VADP_IMG_IME_CAND_RIGHT_ARROW_NORMAL_MEDIUM);
    g_imui_ui_theme.cand_right_arrow_up_large   = (PU8) GetImage(VADP_IMG_IME_CAND_RIGHT_ARROW_NORMAL_LARGE);
    g_imui_ui_theme.cand_right_arrow_disable_small =  (PU8) GetImage(VADP_IMG_IME_CAND_RIGHT_ARROW_DISABLE_SMALL);
    g_imui_ui_theme.cand_right_arrow_disable_medium = (PU8) GetImage(VADP_IMG_IME_CAND_RIGHT_ARROW_DISABLE_MEDIUM);
    g_imui_ui_theme.cand_right_arrow_disable_large = (PU8) GetImage(VADP_IMG_IME_CAND_RIGHT_ARROW_DISABLE_LARGE);
    g_imui_ui_theme.cand_highlight_small        = (PU8) GetImage(VADP_IMG_IME_CAND_HIGHLIGHT_SMALL);
    g_imui_ui_theme.cand_highlight_medium       = (PU8) GetImage(VADP_IMG_IME_CAND_HIGHLIGHT_MEDIUM);
    g_imui_ui_theme.cand_highlight_large        = (PU8) GetImage(VADP_IMG_IME_CAND_HIGHLIGHT_LARGE);
    g_imui_ui_theme.cand_dull_highlight_small   = (PU8) GetImage(VADP_IMG_IME_CAND_DULL_HIGHLIGHT_SMALL);
    g_imui_ui_theme.cand_dull_highlight_medium  = (PU8) GetImage(VADP_IMG_IME_CAND_DULL_HIGHLIGHT_MEDIUM);
    g_imui_ui_theme.cand_dull_highlight_large   = (PU8) GetImage(VADP_IMG_IME_CAND_DULL_HIGHLIGHT_LARGE);
    g_imui_ui_theme.input_background_small      = (PU8) GetImage(VADP_IMG_IME_INPUT_BG_SMALL);
    g_imui_ui_theme.input_background_medium     = (PU8) GetImage(VADP_IMG_IME_INPUT_BG_MEDIUM);
    g_imui_ui_theme.input_background_large      = (PU8) GetImage(VADP_IMG_IME_INPUT_BG_LARGE);
    #if defined(__MMI_IME_CANDIDATE_GRID__)
	g_imui_ui_theme.cand_grid_arrow_down = (PU8) GetImage(VADP_IMG_IME_CG_ARROWDOWN);
	g_imui_ui_theme.cand_grid_arrow_up = (PU8) GetImage(VADP_IMG_IME_CG_ARROWUP);
	g_imui_ui_theme.cand_grid_arrow_down_disable = (PU8) GetImage(VADP_IMG_IME_CG_ARROWDOWNDIS);
	g_imui_ui_theme.cand_grid_arrow_up_disable = (PU8) GetImage(VADP_IMG_IME_CG_ARROWUPDIS);
    g_imui_ui_theme.cand_grid_back = (PU8) GetImage(VADP_IMG_IME_CG_BACK);
    g_imui_ui_theme.cand_grid_backspace = (PU8) GetImage(VADP_IMG_IME_CG_BACKSPACE);
	g_imui_ui_theme.cand_grid_candidate_background = (PU8) GetImage(VADP_IMG_IME_CG_CAND_BG);
	g_imui_ui_theme.cand_grid_candidate_background_highlighted = (PU8) GetImage(VADP_IMG_IME_CG_CAND_BG_HL);
	g_imui_ui_theme.cand_grid_expand = (PU8) GetImage(VADP_IMG_IME_CG_EXPAND);
	g_imui_ui_theme.cand_grid_background = (PU8) GetImage(VADP_IMG_IME_CG_BG);
	g_imui_ui_theme.cand_grid_background_black = (PU8) GetImage( IMG_ID_FUNCTION_BKG_9SLICE);
    #endif
    #if defined(__MMI_IME_SCROLLING_COMPOSITION__)
	g_imui_ui_theme.scrolling_comp_background = (PU8) GetImage(VADP_IMG_IME_SC_BG);
	g_imui_ui_theme.scrolling_comp_cand_background = (PU8) GetImage(VADP_IMG_IME_SC_CAND_BG);
	g_imui_ui_theme.scrolling_comp_cand_background_highlighted = (PU8) GetImage(VADP_IMG_IME_SC_CAND_BG_HL);
    #endif

    
#elif defined(__MMI_IME_FTE_ENHANCE__)

    g_imui_ui_theme.cand_background_small       = now_using_theme->cand_background_small;
    g_imui_ui_theme.cand_background_medium      = now_using_theme->cand_background_medium;
    g_imui_ui_theme.cand_background_large       = now_using_theme->cand_background_large;
    g_imui_ui_theme.cand_focus_frame_small      = now_using_theme->cand_focus_frame_small;
    g_imui_ui_theme.cand_focus_frame_medium     = now_using_theme->cand_focus_frame_medium;
    g_imui_ui_theme.cand_focus_frame_large      = now_using_theme->cand_focus_frame_large;
    g_imui_ui_theme.cand_separator_small        = now_using_theme->cand_separator_small;
    g_imui_ui_theme.cand_separator_medium       = now_using_theme->cand_separator_medium;
    g_imui_ui_theme.cand_separator_large        = now_using_theme->cand_separator_large;
    g_imui_ui_theme.cand_left_arrow_down_small  = now_using_theme->cand_left_arrow_down_small;
    g_imui_ui_theme.cand_left_arrow_down_medium = now_using_theme->cand_left_arrow_down_medium;
    g_imui_ui_theme.cand_left_arrow_down_large  = now_using_theme->cand_left_arrow_down_large;
    g_imui_ui_theme.cand_left_arrow_up_small    = now_using_theme->cand_left_arrow_up_small;
    g_imui_ui_theme.cand_left_arrow_up_medium   = now_using_theme->cand_left_arrow_up_medium;
    g_imui_ui_theme.cand_left_arrow_up_large    = now_using_theme->cand_left_arrow_up_large;
    g_imui_ui_theme.cand_left_arrow_disable_small = now_using_theme->cand_left_arrow_disable_small;
    g_imui_ui_theme.cand_left_arrow_disable_medium = now_using_theme->cand_left_arrow_disable_medium;
    g_imui_ui_theme.cand_left_arrow_disable_large = now_using_theme->cand_left_arrow_disable_large;
    g_imui_ui_theme.cand_right_arrow_down_small   = now_using_theme->cand_right_arrow_down_small;
    g_imui_ui_theme.cand_right_arrow_down_medium = now_using_theme->cand_right_arrow_down_medium;
    g_imui_ui_theme.cand_right_arrow_down_large = now_using_theme->cand_right_arrow_down_large;
    g_imui_ui_theme.cand_right_arrow_up_small   = now_using_theme->cand_right_arrow_up_small;
    g_imui_ui_theme.cand_right_arrow_up_medium  = now_using_theme->cand_right_arrow_up_medium;
    g_imui_ui_theme.cand_right_arrow_up_large   = now_using_theme->cand_right_arrow_up_large;
    g_imui_ui_theme.cand_right_arrow_disable_small =  now_using_theme->cand_right_arrow_disable_small;
    g_imui_ui_theme.cand_right_arrow_disable_medium = now_using_theme->cand_right_arrow_disable_medium;
    g_imui_ui_theme.cand_right_arrow_disable_large = now_using_theme->cand_right_arrow_disable_large;
    g_imui_ui_theme.cand_highlight_small        = now_using_theme->cand_highlight_small;
    g_imui_ui_theme.cand_highlight_medium       = now_using_theme->cand_highlight_medium;
    g_imui_ui_theme.cand_highlight_large        = now_using_theme->cand_highlight_large;
    g_imui_ui_theme.cand_dull_highlight_small   = now_using_theme->cand_dull_highlight_small;
    g_imui_ui_theme.cand_dull_highlight_medium  = now_using_theme->cand_dull_highlight_medium;
    g_imui_ui_theme.cand_dull_highlight_large   = now_using_theme->cand_dull_highlight_large;
    g_imui_ui_theme.input_background_small      = now_using_theme->input_background_small;
    g_imui_ui_theme.input_background_medium     = now_using_theme->input_background_medium;
    g_imui_ui_theme.input_background_large      = now_using_theme->input_background_large;
	 #if defined(__MMI_IME_CANDIDATE_GRID__)
	g_imui_ui_theme.cand_grid_arrow_down = (PU8) get_image(MMI_IMUI_IMG_IME_CG_ARROWDOWN);
	g_imui_ui_theme.cand_grid_arrow_up = (PU8) get_image(MMI_IMUI_IMG_IME_CG_ARROWUP);
	g_imui_ui_theme.cand_grid_arrow_down_disable = (PU8) get_image(MMI_IMUI_IMG_IME_CG_ARROWDOWNDIS);
	g_imui_ui_theme.cand_grid_arrow_up_disable = (PU8) get_image(MMI_IMUI_IMG_IME_CG_ARROWUPDIS);
    g_imui_ui_theme.cand_grid_back = (PU8) get_image(MMI_IMUI_IMG_IME_CG_BACK);
    g_imui_ui_theme.cand_grid_backspace = (PU8) get_image(MMI_IMUI_IMG_IME_CG_BACKSPACE);
	g_imui_ui_theme.cand_grid_candidate_background = (PU8) get_image(MMI_IMUI_IMG_IME_CG_CAND_BG);
	g_imui_ui_theme.cand_grid_candidate_background_highlighted = (PU8) get_image(MMI_IMUI_IMG_IME_CG_CAND_BG_HL);
	g_imui_ui_theme.cand_grid_expand = (PU8) get_image(MMI_IMUI_IMG_IME_CG_EXPAND);
	g_imui_ui_theme.cand_grid_background = (PU8) get_image(MMI_IMUI_IMG_IME_CG_BG);
	g_imui_ui_theme.cand_grid_background_black = (PU8) get_image(MMI_IMUI_IMG_IME_CG_BG_BLACK);
    #endif
    #if defined(__MMI_IME_SCROLLING_COMPOSITION__)
	g_imui_ui_theme.scrolling_comp_background = (PU8) get_image(MMI_IMUI_IMG_IME_SC_BG);
	g_imui_ui_theme.scrolling_comp_cand_background = (PU8) get_image(MMI_IMUI_IMG_IME_SC_CAND_BG);
	g_imui_ui_theme.scrolling_comp_cand_background_highlighted = (PU8) get_image(MMI_IMUI_IMG_IME_SC_CAND_BG_HL);
    #endif

#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */


#if defined(__MMI_TOUCH_SCREEN__)    
    g_imui_ui_theme.information_bar_background_filler = now_using_theme->information_bar_background_filler;
#endif

    if (now_using_theme->separator_width > 0)
    {
        g_imui_candidate_box.style |= MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR;
        g_imui_candidate_box.area_theme.separator_width = now_using_theme->separator_width;
    }
    else
    {
        g_imui_candidate_box.style &= ~MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR;
        g_imui_candidate_box.area_theme.separator_width = 0;
    }

	g_imui_candidate_box.area_theme.separator_focused_color = now_using_theme->separator_focused_color;
	g_imui_candidate_box.area_theme.separator_normal_color = now_using_theme->separator_normal_color;

    g_imui_candidate_box.area_theme.text_color = now_using_theme->cand_text_color;
    g_imui_candidate_box.area_theme.highlighted_text_color = now_using_theme->cand_highlighted_text_color;
    g_imui_candidate_box.area_theme.highlight_color = now_using_theme->cand_highlight_color;

    g_imui_composition_box.area_theme.text_color = now_using_theme->comp_text_color;
    g_imui_composition_box.area_theme.highlighted_text_color = now_using_theme->comp_highlighted_text_color;
    g_imui_composition_box.area_theme.highlight_color = now_using_theme->comp_highlight_color;

#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
    g_imui_input_box.area_theme.text_color = now_using_theme->input_text_color;
    g_imui_input_box.area_theme.highlighted_text_color = now_using_theme->input_highlighted_text_color;
    g_imui_input_box.area_theme.highlight_color = now_using_theme->input_highlight_color;
    
    g_imui_title_box.area_theme.text_color = now_using_theme->input_text_color;
#endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/
    
}

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_deinit_ui
 * DESCRIPTION
 *  Invoked when exit to IME
 * PARAMETERS
 * RETURNS
 *  Whether it have deinitalzed the controls successfully
 *****************************************************************************/
static U32 mmi_imui_deinit_ui(void)
{    
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 lresult = MMI_IMUI_RESULT_FALSE;
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    S32 vk_y;
#endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    

    g_imui_redraw_funcptr = NULL;
    
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
	/* Keep and resume vk position for currencyconvertor */
	vk_y = g_imui_control_set.control_bottoms[MMI_IMUI_VIRTUAL_KEYBOARD] 
		   - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + MMI_virtual_keyboard.height) + 1;

    g_imui_last_valid_vk_type = MMI_virtual_keyboard.lang_type;
	wgui_setup_virtual_keyboard(GUI_VIRTUAL_KEYBOARD_EMPTY_TRAY);
    wgui_move_virtual_keyboard(MMI_virtual_keyboard.x, vk_y);
    #elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)
	/* Keep and resume vk position for currencyconvertor */
	vk_y = g_imui_control_set.control_bottoms[MMI_IMUI_VIRTUAL_KEYBOARD] 
		   - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + g_wgui_virtual_keyboard.height) + 1;

    g_imui_last_valid_vk_type = g_wgui_virtual_keyboard_lang_type;
    g_imui_vk_parameter.vk_type = GUI_VIRTUAL_KEYBOARD_EMPTY_TRAY;
    wgui_setup_virtual_keyboard(g_imui_vk_parameter.vk_type, g_imui_vk_parameter.vk_style, NULL, NULL);
    wgui_virtual_keyboard_move(g_wgui_virtual_keyboard.x, vk_y);
    #elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            vk_y = g_imui_control_set.control_bottoms[MMI_IMUI_VIRTUAL_KEYBOARD] 
               - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + wgui_virtual_keyboard_get_vk_height()) + 1;

        g_imui_last_valid_vk_type = g_wgui_virtual_keyboard_lang_type;
        g_imui_vk_parameter.vk_type = GUI_VIRTUAL_KEYBOARD_EMPTY_TRAY;
        wgui_setup_virtual_keyboard(g_imui_vk_parameter.vk_type, g_imui_vk_parameter.vk_style);
        wgui_virtual_keyboard_move(g_wgui_virtual_keyboard.x, vk_y);
    #endif
#endif /*defined(__MMI_VIRTUAL_KEYBOARD__)*/

    g_imui_control_set.showed_flag = 0;
    g_imui_control_set.last_showed_flag = 0;
#if defined(__MMI_IME_FLOATING_CAND_BOX__)
    g_imui_control_set.last_showed_floating_flag = 0;
#endif
    
#if defined(__MMI_IME_INDICATOR_ON_STATUS_ICON_BAR__)
    mmi_imui_close_ime_indicator();
#endif /* #if defined(__MMI_IME_INDICATOR_ON_STATUS_ICON_BAR__) */

#if defined(__MMI_IME_VERTICAL_CAND_BOX__)
    gui_fixed_icontext_menuitem_stop_scroll();
    g_imui_vertical_candidate_list_stop_cursor = MMI_FALSE;
#endif
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
    gui_fixed_icontext_menuitem_stop_scroll();
#endif
    return lresult;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_exit_screen
 * DESCRIPTION
 *  Invoked when exit to screen
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
void mmi_imui_exit_screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_imui_exit_handwriting_on_disconnect();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_exit_handwriting_on_disconnect
 * DESCRIPTION
 *  Invoked when exit to screen
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static void mmi_imui_exit_handwriting_on_disconnect(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/  
    S32 i;
#if defined(__MMI_TOUCH_SCREEN__)
	
#ifdef MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER    
    mmi_imui_restore_blt_layer();
    if (g_imui_hand_writing_stroke_handle != GDI_ERROR_HANDLE)
    {
        gdi_layer_free(g_imui_hand_writing_stroke_handle);
        g_imui_hand_writing_stroke_handle = GDI_ERROR_HANDLE;
    }
#else /* MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER */

    if (g_imui_hand_writing_GDI_handle != GDI_ERROR_HANDLE)
    {
        gdi_handle layers[4];
        
        gdi_layer_get_blt_layer(&layers[0], &layers[1], &layers[2], &layers[3]);

#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif     
        for (i = 3; i >= 0; i --)
        {
            if (layers[i] == g_imui_hand_writing_GDI_handle)
            {
                layers[i] = GDI_NULL_HANDLE;
                break;
            }
        }

        gdi_layer_set_blt_layer(layers[0], layers[1], layers[2], layers[3]);

        gdi_layer_free(g_imui_hand_writing_GDI_handle);
	    g_imui_hand_writing_GDI_handle = GDI_ERROR_HANDLE;
    }
	
#endif /* MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER */
	
    if (g_imui_stroke_GDI_buffer)
    {
        mmi_frm_scrmem_free((void*)g_imui_stroke_GDI_buffer);
    }
    
    g_imui_stroke_GDI_buffer = NULL;

#endif /* defined(__MMI_TOUCH_SCREEN__) */
}
#if defined(__MMI_IME_CANDIDATE_GRID__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_create_candidate_box
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static void mmi_imui_create_candidate_box_grid(U32 style)
{
	 
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	S32 height = 0, ascent = 0, descent = 0;
   

	 /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	

    mmi_fe_get_char_info_of_all_lang(g_imui_ui_theme.font_text->size, &height, &ascent, &descent);

    //initialize grid candidate box
	g_imui_candidate_box_grid.style = style;

    if (current_ime_theme->separator_width > 0)
    {
        g_imui_candidate_box_grid.style |= MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR;
		g_imui_candidate_box_grid.area_theme.separator_width = current_ime_theme->separator_width;
    }
	else
	{
        g_imui_candidate_box_grid.style &= ~MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR;
		g_imui_candidate_box_grid.area_theme.separator_width = 0;
	}

    g_imui_candidate_box_grid.x = g_imui_ui_param.imui_left ;
    g_imui_candidate_box_grid.width = g_imui_ui_param.imui_width ;

    g_imui_candidate_box_grid.y = -1; /* Default value */
    g_imui_candidate_box_grid.cand_ver_cap = MMI_IMUI_SELECTION_AREA_VER_GAP + MMI_IMUI_CANDIDATE_BOX_EXTER_BORDER_WIDTH;

	g_imui_candidate_box_grid.cand_back = g_imui_ui_theme.cand_grid_back;
    g_imui_candidate_box_grid.cand_grid_background = g_imui_ui_theme.cand_grid_background;
	g_imui_candidate_box_grid.cand_grid_background_black = g_imui_ui_theme.cand_grid_background_black;
	g_imui_candidate_box_grid.cand_background = g_imui_ui_theme.cand_grid_candidate_background;

	g_imui_candidate_box_grid.cand_up_arrow_down =g_imui_ui_theme.cand_grid_arrow_up;
    //g_imui_candidate_box_grid.cand_up_arrow_up = g_imui_ui_theme.cand_left_arrow_up_large;
    g_imui_candidate_box_grid.cand_up_arrow_disable = g_imui_ui_theme.cand_grid_arrow_up_disable;

    g_imui_candidate_box_grid.cand_down_arrow_down = g_imui_ui_theme.cand_grid_arrow_down;
    //g_imui_candidate_box_grid.cand_down_arrow_up = g_imui_ui_theme.cand_right_arrow_up_large;
    g_imui_candidate_box_grid.cand_down_arrow_disable = g_imui_ui_theme.cand_grid_arrow_down_disable;
        
    g_imui_candidate_box_grid.cand_focus_frame = g_imui_ui_theme.cand_grid_candidate_background_highlighted;
        
	 g_imui_candidate_box_grid.cand_backspace = g_imui_ui_theme.cand_grid_backspace;

        g_imui_candidate_box_grid.cand_separator = g_imui_ui_theme.cand_separator_large;

    g_imui_candidate_box_grid.cand_highlight = g_imui_ui_theme.cand_grid_candidate_background_highlighted;
        
        g_imui_candidate_box_grid.cand_dull_highlight = g_imui_ui_theme.cand_dull_highlight_large;
        
        
        g_imui_candidate_box_grid.cand_ver_cap += (MMI_IMUI_FTE_CAND_BOX_HEIGHT_LARGE - (height + g_imui_candidate_box_grid.cand_ver_cap * 2) + 1) / 2;
        
        
        g_imui_candidate_box_grid.baseline = ascent;
        g_imui_candidate_box_grid.str_height = height;
}
#endif
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_create_candidate_box
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static void mmi_imui_create_candidate_box(U32 style)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 height = 0, ascent = 0, descent = 0;
#if defined(__MMI_IME_VERTICAL_CAND_BOX__)
    S32 i;
#endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_imui_candidate_box.style = style;

    if (current_ime_theme->separator_width > 0)
    {
        g_imui_candidate_box.style |= MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR;
		g_imui_candidate_box.area_theme.separator_width = current_ime_theme->separator_width;
    }
	else
	{
        g_imui_candidate_box.style &= ~MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR;
		g_imui_candidate_box.area_theme.separator_width = 0;
	}
    
    g_imui_candidate_box.x = g_imui_ui_param.imui_left + MMI_IMUI_CANDIDATE_BOX_LEFT_GAP;
    g_imui_candidate_box.width = g_imui_ui_param.imui_width - (MMI_IMUI_CANDIDATE_BOX_LEFT_GAP + MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP);

    g_imui_candidate_box.y = -1; /* Default value */

    
    
#if defined(__MMI_IME_FTE_ENHANCE__)
    mmi_imui_update_selection_area_fte_theme(&g_imui_candidate_box);
#else
    mmi_fe_get_char_info_of_all_lang(g_imui_ui_theme.font_text->size, &height, &ascent, &descent);
    g_imui_candidate_box.cand_ver_cap = MMI_IMUI_SELECTION_AREA_VER_GAP;
    g_imui_candidate_box.height = height + g_imui_candidate_box.cand_ver_cap * 2;
    g_imui_candidate_box.baseline = ascent;
    g_imui_candidate_box.str_height = height;
#endif

#if defined(__MMI_IME_VERTICAL_CAND_BOX__)

    memset(&g_imui_vertical_candidate_list, 0, sizeof(fixed_list_menu));
    memset(&g_imui_veritical_candidate_list_items[0], 0, sizeof(fixed_icontext_menuitem_type) * MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN_VER);
    memset(&g_imui_vertical_candidate_list_data, 0, sizeof(gui_common_menuitem_base_struct));

    gui_create_fixed_list_menu(&g_imui_vertical_candidate_list, 0, 0, g_imui_ui_param.imui_floating_width, MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_HEIGHT);

    MMI_current_menu_type = LIST_MENU;
    
    gui_set_fixed_list_menu_current_theme(&g_imui_vertical_candidate_list);

    gui_create_fixed_icontext_menuitem(&g_imui_vertical_candidate_list_data, 108, MMI_MENUITEM_HEIGHT);
    
    gui_fixed_icontext_menuitem_set_text_position(&g_imui_vertical_candidate_list_data, 2, 0);
    
    g_imui_vertical_candidate_list_data.flags |= UI_MENUITEM_CENTER_TEXT_Y;
    g_imui_vertical_candidate_list_data.flags |= UI_MENUITEM_CENTER_ICON_Y;

    for (i = 0; i < MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN_VER && i < MAX_FIXED_MENU_ITEM_POINTERS; i++)
    {
        g_imui_veritical_candidate_list_items[i].flags = 0;
        g_imui_veritical_candidate_list_items[i].ext_flags = 0;

        g_imui_veritical_candidate_list_items_pointers[i] = &g_imui_veritical_candidate_list_items[i];
        g_imui_veritical_candidate_list_items[i].item_icon_handle = GDI_ERROR_HANDLE;
    }
    
    gui_set_fixed_list_menu_item_functions(
        &g_imui_vertical_candidate_list,
        gui_show_fixed_icontext_menuitem,
        gui_measure_fixed_icontext_menuitem,
        gui_highlight_fixed_icontext_menuitem,
        gui_remove_highlight_fixed_icontext_menuitem,
        gui_hide_fixed_icontext_menuitem,
        UI_fixed_menuitem_dummy_resize_function,
        gui_get_fixed_icontext_menuitem_flag,
        gui_get_fixed_text_length_menuitem);
    
#ifdef __MMI_TOUCH_SCREEN__
    gui_set_fixed_list_menu_item_pen_function(
        &g_imui_vertical_candidate_list,
        gui_fixed_icontext_menuitem_translate_pen_event,
        MMI_FALSE,
        MMI_FALSE);
#endif /* __MMI_TOUCH_SCREEN__ */ 

    //g_imui_vertical_candidate_list.item_highlighted = dummy_highlight_handler;
    
    g_imui_vertical_candidate_list.first_displayed_item = 0;
    g_imui_vertical_candidate_list.highlighted_item = -1;
    g_imui_vertical_candidate_list.flags |= UI_LIST_MENU_DISABLE_BACKGROUND;
	g_imui_vertical_candidate_list.flags |=UI_LIST_MENU_DISABLE_GRID_LINE;
    
    g_imui_vertical_candidate_list_data.parent_list = &g_imui_vertical_candidate_list;
    g_imui_vertical_candidate_list_data.parent_matrix = NULL;

    g_imui_vertical_candidate_list_data.flags |= (UI_MENUITEM_DISABLE_BACKGROUND | UI_MENUITEM_MARQUEE_SCROLL);
    g_imui_vertical_candidate_list_data.ext_flags |= UI_MENUITEM_EXT_DISABLED_POPUPDESCRIPTION;

#ifdef __MMI_TOUCH_SCREEN__
    g_imui_vertical_candidate_list.pen_event_current_selected_callback_function = NULL;
    g_imui_vertical_candidate_list.pen_event_default_selected_callback_function = NULL;
#endif /* __MMI_TOUCH_SCREEN__ */ 

    //set_MMI_current_fixed_icontext_menuitem_theme_list();
    /* use cascade menu theme */
    g_imui_vertical_candidate_list_data.selected_filler = current_MMI_theme->cascade_menu_highlight_filler;
    g_imui_vertical_candidate_list_data.focussed_filler = current_MMI_theme->cascade_menu_highlight_filler;   
    /* for UI_LIST_MENU_DISABLE_SCROLLBAR */
    g_imui_vertical_candidate_list_data.focussed_without_sc_filler = current_MMI_theme->cascade_menu_highlight_filler;
#ifndef __MMI_FTE_SUPPORT__
    g_imui_vertical_candidate_list_data.normal_filler = current_MMI_theme->cascade_menu_background_filler;
#endif
    g_imui_vertical_candidate_list_data.normal_text_color= *current_MMI_theme->cascade_menu_normal_text_color;
    g_imui_vertical_candidate_list_data.disabled_text_color = *current_MMI_theme->cascade_menu_disabled_text_color;
    g_imui_vertical_candidate_list_data.selected_text_color = *current_MMI_theme->cascade_menu_selected_text_color;
    g_imui_vertical_candidate_list_data.focussed_text_color = *current_MMI_theme->cascade_menu_selected_text_color;
    
    g_imui_vertical_candidate_list_data.text_font = (UI_font_type)gui_font_get_type(GUI_FONT_SIZE_LIST);
    
    g_imui_vertical_candidate_list.items = g_imui_veritical_candidate_list_items_pointers;
    g_imui_vertical_candidate_list.common_item_data = &g_imui_vertical_candidate_list_data;
#endif /* #if defined(__MMI_IME_VERTICAL_CAND_BOX__) */

}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_create_composition_box
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static void mmi_imui_create_composition_box(U32 style)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 height = 0, ascent = 0, descent = 0;
	#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
    S32 i;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_imui_composition_box.style = style;

    g_imui_composition_box.x = g_imui_ui_param.imui_left + MMI_IMUI_COMPOSITION_BOX_LEFT_GAP;
    g_imui_composition_box.width = g_imui_ui_param.imui_width - (MMI_IMUI_COMPOSITION_BOX_LEFT_GAP + MMI_IMUI_COMPOSITION_BOX_RIGHT_GAP);
    g_imui_composition_box.y = -1; /* Default value */

#if defined(__MMI_IME_FTE_ENHANCE__)
    mmi_imui_update_selection_area_fte_theme(&g_imui_composition_box);
#else
    mmi_fe_get_char_info_of_all_lang(g_imui_ui_theme.font_text->size, &height, &ascent, &descent);
    g_imui_composition_box.cand_ver_cap = MMI_IMUI_SELECTION_AREA_VER_GAP;
    g_imui_composition_box.height = height + g_imui_composition_box.cand_ver_cap * 2;
    g_imui_composition_box.baseline = ascent;
    g_imui_composition_box.str_height = height;
#endif
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)

    memset(&g_imui_vertical_composition_list, 0, sizeof(fixed_list_menu));
    memset(&g_imui_vertical_composition_list_items[0], 0, sizeof(fixed_icontext_menuitem_type) * MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN_VER);
    memset(&g_imui_vertical_composition_list_data, 0, sizeof(gui_common_menuitem_base_struct));

    gui_create_fixed_list_menu(&g_imui_vertical_composition_list, 0, 0, g_imui_ui_param.imui_floating_width, MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_HEIGHT);
#if defined(__COSMOS_MMI__)
    wgui_fixed_list_create_icontext_menu(g_imui_vertical_composition_list.n_items
                                        ,g_imui_vertical_composition_list.highlighted_item
                                        ,0
                                        ,0
                                        ,NULL);
#endif
    MMI_current_menu_type = LIST_MENU;

    gui_set_fixed_list_menu_current_theme(&g_imui_vertical_composition_list);

    gui_create_fixed_icontext_menuitem(&g_imui_vertical_composition_list_data, 40, MMI_MENUITEM_HEIGHT);
    
    gui_fixed_icontext_menuitem_set_text_position(&g_imui_vertical_composition_list_data, 2, 0);
    
    g_imui_vertical_composition_list_data.flags |= UI_MENUITEM_CENTER_TEXT_Y;
    g_imui_vertical_composition_list_data.flags |= UI_MENUITEM_CENTER_ICON_Y;

    for (i = 0; i < MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN_VER && i < MAX_FIXED_MENU_ITEM_POINTERS; i++)
    {
        g_imui_vertical_composition_list_items[i].flags = 0;
        g_imui_vertical_composition_list_items[i].ext_flags = 0;

        g_imui_vertical_composition_list_items_pointers[i] = &g_imui_vertical_composition_list_items[i];
        g_imui_vertical_composition_list_items[i].item_icon_handle = GDI_ERROR_HANDLE;
    }
    
    gui_set_fixed_list_menu_item_functions(
        &g_imui_vertical_composition_list,
        gui_show_fixed_icontext_menuitem,
        gui_measure_fixed_icontext_menuitem,
        gui_highlight_fixed_icontext_menuitem,
        gui_remove_highlight_fixed_icontext_menuitem,
        gui_hide_fixed_icontext_menuitem,
        UI_fixed_menuitem_dummy_resize_function,
        gui_get_fixed_icontext_menuitem_flag,
        gui_get_fixed_text_length_menuitem);
    
#ifdef __MMI_TOUCH_SCREEN__
    gui_set_fixed_list_menu_item_pen_function(
        &g_imui_vertical_composition_list,
        gui_fixed_icontext_menuitem_translate_pen_event,
        MMI_FALSE,
        MMI_FALSE);
#endif /* __MMI_TOUCH_SCREEN__ */ 

    //g_imui_vertical_candidate_list.item_highlighted = dummy_highlight_handler;
    scrolling_box_normal_filler.b = g_imui_ui_theme.scrolling_comp_cand_background;
	scrolling_box_selected_filler.b = g_imui_ui_theme.scrolling_comp_cand_background_highlighted;
    g_imui_vertical_composition_list.first_displayed_item = 0;
    g_imui_vertical_composition_list.highlighted_item = -1;
	g_imui_vertical_composition_list.normal_filler = &scrolling_box_normal_filler;
	g_imui_vertical_composition_list.focussed_filler = &scrolling_box_selected_filler;
    g_imui_vertical_composition_list.flags &= ~UI_LIST_MENU_DISABLE_BACKGROUND;
    g_imui_vertical_composition_list.flags &= ~UI_LIST_MENU_LOOP;
	g_imui_vertical_composition_list.flags |= UI_LIST_MENU_DISABLE_SCROLLBAR;
	g_imui_vertical_composition_list.flags |= UI_LIST_MENU_DISABLE_BKGRND_IN_LAYER;
	g_imui_vertical_composition_list.flags |=UI_LIST_MENU_DISABLE_GRID_LINE;
	g_imui_vertical_composition_list.flags |= UI_LIST_MENU_DISABLE_MENUITEM_GAP;
    g_imui_vertical_composition_list_data.parent_list = &g_imui_vertical_composition_list;
    g_imui_vertical_composition_list_data.parent_matrix = NULL;
    g_imui_vertical_composition_list_data.flags |= (UI_MENUITEM_MARQUEE_SCROLL);
	//g_imui_vertical_composition_list_data.flags |= UI_MENUITEM_TRUNCATE_CONTENT;
	g_imui_vertical_composition_list_data.flags |=UI_MENUITEM_LEFT_JUSTIFY;

	g_imui_vertical_composition_list_data.ext_flags &= ~UI_MENUITEM_EXT_SHOW_DATA;
    g_imui_vertical_composition_list_data.ext_flags |= UI_MENUITEM_EXT_DISABLED_POPUPDESCRIPTION;

#ifdef __MMI_TOUCH_SCREEN__
    g_imui_vertical_composition_list.pen_event_current_selected_callback_function = NULL;
    g_imui_vertical_composition_list.pen_event_default_selected_callback_function = NULL;
#endif /* __MMI_TOUCH_SCREEN__ */ 

    //set_MMI_current_fixed_icontext_menuitem_theme_list();
    /* use cascade menu theme */
    //g_imui_vertical_composition_list_data.selected_filler = current_MMI_theme->cascade_menu_highlight_filler;
    //g_imui_vertical_composition_list_data.focussed_filler = current_MMI_theme->cascade_menu_highlight_filler; 
	g_imui_vertical_composition_list_data.selected_filler = &scrolling_box_selected_filler;
    g_imui_vertical_composition_list_data.focussed_filler= &scrolling_box_selected_filler;
    /* for UI_LIST_MENU_DISABLE_SCROLLBAR */
    g_imui_vertical_composition_list_data.focussed_without_sc_filler = &scrolling_box_selected_filler;
    //g_imui_vertical_composition_list_data.normal_filler = current_MMI_theme->cascade_menu_background_filler;
	g_imui_vertical_composition_list_data.normal_filler = &scrolling_box_normal_filler;

    g_imui_vertical_composition_list_data.normal_text_color= g_imui_candidate_box.area_theme.text_color;
    g_imui_vertical_composition_list_data.disabled_text_color = *current_MMI_theme->cascade_menu_disabled_text_color;
    g_imui_vertical_composition_list_data.selected_text_color = *current_MMI_theme->cascade_menu_selected_text_color;
    g_imui_vertical_composition_list_data.focussed_text_color = *current_MMI_theme->cascade_menu_selected_text_color;
    
    g_imui_vertical_composition_list_data.text_font = (UI_font_type)gui_font_get_type(GUI_FONT_SIZE_LIST);
    
    g_imui_vertical_composition_list.items = g_imui_vertical_composition_list_items_pointers;
    g_imui_vertical_composition_list.common_item_data = &g_imui_vertical_composition_list_data;
#endif 
}


#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_create_input_box
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static void mmi_imui_create_input_box(U32 style)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 height = 0, ascent = 0, descent = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_imui_input_box.style = style;
    
    g_imui_input_box.x = g_imui_ui_param.imui_left + MMI_IMUI_INPUT_BOX_LEFT_GAP;
    g_imui_input_box.width = g_imui_ui_param.imui_width - (MMI_IMUI_INPUT_BOX_LEFT_GAP + MMI_IMUI_INPUT_BOX_RIGHT_GAP);
    g_imui_input_box.y = -1; /* Default value */
    mmi_fe_get_char_info_of_all_lang(g_imui_ui_theme.font_text->size, &height, &ascent, &descent);
    g_imui_input_box.height = height + MMI_IMUI_SELECTION_AREA_VER_GAP * 2;
    g_imui_input_box.str_height = height;
    g_imui_input_box.baseline = ascent;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_create_title_box
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static void mmi_imui_create_title_box(U32 style)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 height = 0, ascent = 0, descent = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_imui_title_box.style = style;
    
    g_imui_title_box.x = g_imui_ui_param.imui_left + MMI_IMUI_TITLE_BOX_LEFT_GAP;
    g_imui_title_box.width = g_imui_ui_param.imui_width - (MMI_IMUI_TITLE_BOX_LEFT_GAP + MMI_IMUI_TITLE_BOX_RIGHT_GAP);
    g_imui_title_box.y = -1; /* Default value */
    mmi_fe_get_char_info_of_all_lang(g_imui_ui_theme.font_text->size, &height, &ascent, &descent);
    g_imui_title_box.height = height + MMI_IMUI_SELECTION_AREA_VER_GAP * 2;
    g_imui_title_box.str_height = height;
    g_imui_title_box.baseline = ascent;
}
#endif


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_add_cocontrol
 * DESCRIPTION
 *  Add the im ui to the control sets
 * PARAMETERS
 *  imuicontrol        [IN]        The Control to add
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_imui_add_control(mmi_imui_control_type_enum imui_control)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_imui_control_set.control_set[g_imui_control_set.number_of_controls++] = imui_control;
    MMI_ASSERT(g_imui_control_set.number_of_controls <= MMI_IMUI_CONTROL_MAX);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_is_in_control_set
 * DESCRIPTION
 *  Is the control has been in control set
 * PARAMETERS
 *  imuicontrol        [IN]        The Control to add
 * RETURNS
 *  
 *****************************************************************************/
MMI_BOOL mmi_imui_is_in_control_set(mmi_imui_control_type_enum imui_control)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    while(i < g_imui_control_set.number_of_controls )
    {
        if (imui_control == g_imui_control_set.control_set[i])
        {
            return MMI_TRUE;
        }
        i++;
    }

    return MMI_FALSE;
    
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_max_candidate_width
 * DESCRIPTION
 *  Get the max width of candidate which can not be cut
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static U32 mmi_imui_get_max_candidate_width(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 imui_width;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    

#ifdef UI_SMALL_CATEGORY_EDITOR
    imui_width = UI_DEVICE_WIDTH - 2 * (MMI_SMALL_SCREEN_X_OFFSET + 1);
#else
    imui_width = (U32)MMI_content_width;
#endif

    return (U32)(imui_width - (MMI_IMUI_CANDIDATE_BOX_LEFT_GAP + MMI_IMUI_CANDIDATE_BOX_RIGHT_GAP) - (MMI_IMUI_SLECTION_AREA_LEFT_SPACING + MMI_IMUI_SLECTION_AREA_RIGHT_SPACING));

}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_imui_height_by_ui_set
 * DESCRIPTION
 *  Get IMUI height by specific UI control set
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static S32 mmi_imui_get_imui_height_by_ui_set(U32 ui_set)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 height = 0;
#ifdef __MMI_IME_PLUG_IN__
    U32 custom_control;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_VIRTUAL_KEYBOARD__) && defined(__MMI_HANDWRITING_MULTI_BLOCK__)
    if (g_imui_hand_writing_style == MMI_IMUI_HANDWRITING_STYLE_MULTI_BLOCK && !mmi_imc_is_handwriting_disabled())
    {
    #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
        if ((ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)) 
            && mmi_imc_pen_is_multiblock_handwriting_type(MMI_virtual_keyboard.lang_type)
            && !mmi_imc_is_handwriting_disabled())
    #else
        if ((ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)) 
            && mmi_imc_pen_is_multiblock_handwriting_type(g_wgui_virtual_keyboard_lang_type)
            && !mmi_imc_is_handwriting_disabled())
    #endif
        {
            ui_set |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA);
            ui_set |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD);
        }
        else if (!(ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)) && mmi_imc_get_state() == MMI_IMC_STATE_HAND_WRITING_CAND)
        {
            ui_set |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA);
        }
        else if (mmi_imc_get_state() == MMI_IMC_STATE_ASSOC_SELECTING && (ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)))
        {
           
        }
        else
        {
            ui_set &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA);
        }

        if (mmi_imc_get_state() == MMI_IMC_STATE_ASSOC_SELECTING && (ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA)))
        {
            ui_set &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD);
        }
    }
#endif 
	
#if defined(__MMI_TOUCH_SCREEN__) 
#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)
	if (ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA))
	{
        height += (MMI_IMUI_MULTIBLOCK_BOTTOM_GAP + MMI_IMUI_MULTIBLOCK_TOP_GAP + MMI_IMUI_MULTI_BLOCK_HEIGHT);
	}
#endif
#if defined(__MMI_IME_FTE_ENHANCE__)
    ///TODO: define other parameter for single block handwriting
    if (ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA))
    {
        if (mmi_imc_is_rotated())
        {
            height += (MMI_IMUI_SINGLE_BLOCK_BOTTOM_GAP + MMI_IMUI_SINGLE_BLOCK_TOP_GAP + MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED);
        }
		else
		{
            height += (MMI_IMUI_SINGLE_BLOCK_BOTTOM_GAP + MMI_IMUI_SINGLE_BLOCK_TOP_GAP + MMI_IMUI_SINGLE_BLOCK_HEIGHT);
		}
    }
#endif
#if defined(__MMI_VIRTUAL_KEYBOARD__)
	if ((ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)) 
    #if defined(__MMI_IME_FTE_ENHANCE__)    
        && !(ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA))
    #endif
        )
	{
        #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
		height += (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + MMI_virtual_keyboard.height);
	    #elif defined (__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)
        height += (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + g_wgui_virtual_keyboard.height);
        #else
        height += (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + wgui_virtual_keyboard_get_vk_height());
        #endif
	}
#endif
#endif

#ifdef __MMI_IME_PLUG_IN__
    custom_control = ui_set & mmi_ime_sdk_get_custom_control_mask();
    if (custom_control != 0)
    {
        height += mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_GET_UI_CONTROL_HEIGHT, custom_control, 0);
    }
#endif
    if (ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA))
    {
    #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
        if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
        {
            height += g_imui_vertical_candidate_list.height + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH * 2;
        }
        else
    #endif
        {
            height += (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height);
        }
    }
	

    #if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
    if (ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA))
    {
        height += (MMI_IMUI_INPUT_BOX_BOTTOM_GAP + MMI_IMUI_INPUT_BOX_TOP_GAP + g_imui_input_box.height);
    }
    
    if (ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_TITLE_AREA))
    {
        height += (MMI_IMUI_TITLE_BOX_BOTTOM_GAP + MMI_IMUI_TITLE_BOX_TOP_GAP + g_imui_title_box.height);
    }
    #endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/
    
	#if defined(__MMI_IME_CANDIDATE_GRID__)
	if (ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_GRID_AREA))
    {
        height += ( MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box_grid.height);
    }
	#endif
    
    if (ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA) &&
		!(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL))
    {
    #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
        if (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE)
        {
            height += g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT;
        }
        else
    #endif
        {
            height += (MMI_IMUI_COMPOSITION_BOX_BOTTOM_GAP + MMI_IMUI_COMPOSITION_BOX_TOP_GAP + g_imui_composition_box.height);
        }
    }

#ifdef __MMI_CLIPBOARD_FLOATING_MENU__
    if (ui_set & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CLIPBOARD_FLOATING_MENU))
    {
        height += (MMI_IMUI_CLIPBOARD_FLOATING_MENU_BOTTOM_GAP + MMI_IMUI_CLIPBOARD_FLOATING_MENU_TOP_GAP + g_imui_clipboard_floating_menu.height);
    }
#endif /* __MMI_CLIPBOARD_FLOATING_MENU__ */

	return height;
}


#if defined(__MMI_TOUCH_SCREEN__)
#if defined(__MMI_VIRTUAL_KEYBOARD__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_setup_virtual_keyboard
 * DESCRIPTION
 *  Setup virtual keyboard according to current input mode
 * PARAMETERS
 * vk_type    [IN]    Virtual keyboard type
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_setup_virtual_keyboard(mmi_imui_message_struct_p msg_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_imc_message_struct imc_message;
    gui_virtual_keyboard_language_enum vk_type = (gui_virtual_keyboard_language_enum)msg_ptr->param_0;
    S32 bottom_line = g_imui_control_set.control_bottoms[MMI_IMUI_VIRTUAL_KEYBOARD];
    S32 vk_width, vk_height;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
    if (vk_type != MMI_virtual_keyboard.lang_type)
    {
        wgui_setup_virtual_keyboard(vk_type);
    }
    g_imui_is_there_vk_candidate_box = (MMI_BOOL)msg_ptr->param_1;
#elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)
    {
        mmi_imui_virtual_keyboard_parameter_p vk_parameter = (mmi_imui_virtual_keyboard_parameter_p)msg_ptr->param_0;

        if (!vk_parameter)
        {
            return;
        }
    

        if (vk_parameter->vk_type != g_imui_vk_parameter.vk_type ||
            vk_parameter->vk_style != g_imui_vk_parameter.vk_style)
        {
            memcpy(&g_imui_vk_parameter, vk_parameter, sizeof(mmi_imui_virtual_keyboard_parameter));
            wgui_setup_virtual_keyboard(vk_parameter->vk_type, vk_parameter->vk_style, vk_parameter->event_callback, vk_parameter->disp_callback);
        }    
    
        g_imui_is_there_vk_candidate_box = vk_parameter->has_cand_box;
    }
#elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    {
        mmi_imui_virtual_keyboard_parameter_p vk_parameter = (mmi_imui_virtual_keyboard_parameter_p)msg_ptr->param_0;

        if (!vk_parameter)
        {
            return;
        }


        if (vk_parameter->vk_type != g_imui_vk_parameter.vk_type ||
            vk_parameter->vk_style != g_imui_vk_parameter.vk_style)
        {
            memcpy(&g_imui_vk_parameter, vk_parameter, sizeof(mmi_imui_virtual_keyboard_parameter));
            wgui_setup_virtual_keyboard(vk_parameter->vk_type, vk_parameter->vk_style);
        }    

        g_imui_is_there_vk_candidate_box = (MMI_BOOL) vk_parameter->has_cand_box;
    }
#else
    #error vk version is not define
#endif

#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    wgui_virtual_keyboard_get_dimension(&vk_width, &vk_height);
#elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
    wgui_get_virtual_keyboard_size(&vk_width, &vk_height);
#else
#error vk version is not define
#endif

#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    wgui_virtual_keyboard_move(g_imui_ui_param.imui_left + (g_imui_ui_param.imui_width - vk_width) / 2, 
        bottom_line - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + vk_height) + 1);
#elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
    wgui_move_virtual_keyboard(g_imui_ui_param.imui_left + (g_imui_ui_param.imui_width - vk_width) / 2, 
        bottom_line - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + vk_height) + 1);
#else
    #error vk version is not define
#endif

    if (g_imui_redraw_funcptr)
    {
        wgui_virtual_keyboard_register_hide_callback(g_imui_redraw_funcptr);
    }

	imc_message.message_id = MMI_IMC_MESSAGE_IS_THERE_CURSOR;
	
    if (mmi_imc_send_message(&imc_message))
    {
        mmi_imc_stop_cursor_funcptr stop_ptr = NULL;
        mmi_imc_start_cursor_funcptr start_ptr = NULL;

        imc_message.message_id = MMI_IMC_MESSAGE_GET_STOP_CURSOR_CALLBACK_FUNCPTR;

        stop_ptr = (mmi_imc_stop_cursor_funcptr)mmi_imc_send_message(&imc_message);

        imc_message.message_id = MMI_IMC_MESSAGE_GET_START_CURSOR_CALLBACK_FUNCPTR;

        start_ptr = (mmi_imc_start_cursor_funcptr)mmi_imc_send_message(&imc_message);

        if (start_ptr && stop_ptr)
        {
            wgui_virtual_keyboard_register_hide_cursor_callback(stop_ptr);
            wgui_virtual_keyboard_register_blink_cursor_callback(start_ptr);
        }
        else
        {
            MMI_ASSERT(!start_ptr && !stop_ptr);
            wgui_virtual_keyboard_register_hide_cursor_callback(UI_inputbox_stop_cursor);
            wgui_virtual_keyboard_register_blink_cursor_callback(UI_inputbox_start_cursor);
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_config_redraw_vk
 * DESCRIPTION
 *  show/hide VK
 * PARAMETERS
 *  is_show         [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_config_redraw_vk(MMI_BOOL b_show)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_is_redraw_vk_enabled = b_show;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_virtual_keyboard_area_background
 * DESCRIPTION
 *  Draw virtual keyboard
 * PARAMETERS
 *  bottom_line    [IN]    The y of bottom line for virtual keyboard
 * RETURNS
 *  The bottom line for next control
 *****************************************************************************/
static S32 mmi_imui_draw_virtual_keyboard_area_background(S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 temp_bottom_line;
    S32 vk_width, vk_height;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    g_imui_control_set.control_bottoms[MMI_IMUI_VIRTUAL_KEYBOARD] = bottom_line;

#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)
    wgui_virtual_keyboard_get_dimension(&vk_width, &vk_height);
#elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
    wgui_get_virtual_keyboard_size(&vk_width, &vk_height);
#elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    wgui_virtual_keyboard_get_dimension(&vk_width, &vk_height);
#endif

if(g_imui_is_vk_draw_enable)
{
    if (g_imui_redraw_funcptr != NULL)
    {
        g_imui_redraw_funcptr(g_imui_ui_param.imui_left, 
                              bottom_line - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + 
                              MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + vk_height) + 1,
                              g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
                              bottom_line);
    }
    else
    {
        mmi_imui_draw_back_ground(g_imui_ui_param.imui_left, 
                                  bottom_line - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + 
                                  MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + vk_height) + 1,
                                  g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
                                  bottom_line);   

    #if defined(__MMI_WALLPAPER_ON_BOTTOM__)
	    if (!wgui_is_wallpaper_on_bottom())
        {
            gdi_draw_solid_rect(g_imui_ui_param.imui_left, 
                                bottom_line - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + 
                                MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + vk_height) + 1,
                                g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
                                bottom_line, GDI_COLOR_WHITE);
        }
    #endif /*defined(__MMI_WALLPAPER_ON_BOTTOM__)*/

    }
}
    
#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)
    wgui_virtual_keyboard_move(g_imui_ui_param.imui_left + (g_imui_ui_param.imui_width - vk_width) / 2, 
                               bottom_line - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + vk_height) + 1);
#elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
    wgui_move_virtual_keyboard(g_imui_ui_param.imui_left + (g_imui_ui_param.imui_width - vk_width) / 2, 
                               bottom_line - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + vk_height) + 1);
#elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    wgui_virtual_keyboard_move(g_imui_ui_param.imui_left + (g_imui_ui_param.imui_width - vk_width) / 2, 
                               bottom_line - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + vk_height) + 1);
#endif

    mmi_imui_set_vk_keys();

    temp_bottom_line = bottom_line - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + vk_height);

    return temp_bottom_line;
}



/*****************************************************************************
 * FUNCTION
 *  mmi_imui_set_vk_keys
 * DESCRIPTION
 * PARAMETERS
 *  void
 * RETURNS
 *****************************************************************************/
static void mmi_imui_set_vk_keys(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL is_allowed_char, is_set_char;
    MMI_BOOL is_allowed_event, is_set_event;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    is_set_char = mmi_imm_get_allowed_or_disabled_characters(&is_allowed_char, g_imui_vk_characters_list);
   
    is_set_event = mmi_imm_get_allowed_or_disabled_events(&is_allowed_event, g_imui_vk_event_keys_disable_list);

    if (!is_set_char && !is_set_event)
    {
        return;
    }

    if (is_set_char && is_allowed_char)
    {
     #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
        wgui_set_virtual_keyboard_allowed_characters((const UI_character_type *)g_imui_vk_characters_list);
     #else
        wgui_virtual_keyboard_set_allowed_characters((const UI_character_type *)g_imui_vk_characters_list);
     #endif
        if (is_set_event)
        {
            UI_character_type empty_string[1] = {0};
        #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
            wgui_set_virtual_keyboard_disabled_list(empty_string, g_imui_vk_event_keys_disable_list);
        #else
            wgui_virtual_keyboard_set_disable_list(empty_string, g_imui_vk_event_keys_disable_list);
        #endif
        }
    }
    else if (is_set_char && is_set_event && !is_allowed_char && !is_allowed_event)
    {
    #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
        wgui_set_virtual_keyboard_disabled_list((const UI_character_type*)g_imui_vk_characters_list, 
                                                (const gui_virtual_keyboard_pen_enum*)g_imui_vk_event_keys_disable_list);
    #else
        wgui_virtual_keyboard_set_disable_list((const UI_character_type*)g_imui_vk_characters_list, 
                                                (const gui_virtual_keyboard_pen_enum*)g_imui_vk_event_keys_disable_list);
    #endif
    }
    else if (!is_set_char && is_set_event && !is_allowed_event)
    {
        g_imui_vk_characters_list[0] = 0;
    #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
        wgui_set_virtual_keyboard_disabled_list((const UI_character_type*)g_imui_vk_characters_list, 
                                                (const gui_virtual_keyboard_pen_enum*)g_imui_vk_event_keys_disable_list);
    #else
        wgui_virtual_keyboard_set_disable_list((const UI_character_type*)g_imui_vk_characters_list, 
                                                (const gui_virtual_keyboard_pen_enum*)g_imui_vk_event_keys_disable_list);
    #endif
    }
    else if (is_set_char && !is_set_event && !is_allowed_char)
    {
        g_imui_vk_event_keys_disable_list[0] = GUI_VKBD_PEN_NONE;
    #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
        wgui_set_virtual_keyboard_disabled_list((const UI_character_type*)g_imui_vk_characters_list, 
                                                (const gui_virtual_keyboard_pen_enum*)g_imui_vk_event_keys_disable_list);
    #else
        wgui_virtual_keyboard_set_disable_list((const UI_character_type*)g_imui_vk_characters_list, 
                                                (const gui_virtual_keyboard_pen_enum*)g_imui_vk_event_keys_disable_list);
    #endif
    }
    else
    {
        g_imui_vk_event_keys_disable_list[0] = GUI_VKBD_PEN_NONE;
        g_imui_vk_characters_list[0] = 0;
    #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
        wgui_set_virtual_keyboard_disabled_list((const UI_character_type*)g_imui_vk_characters_list, 
                                                (const gui_virtual_keyboard_pen_enum*)g_imui_vk_event_keys_disable_list);
    #else
        wgui_virtual_keyboard_set_disable_list((const UI_character_type*)g_imui_vk_characters_list, 
                                                (const gui_virtual_keyboard_pen_enum*)g_imui_vk_event_keys_disable_list);
    #endif
    }

}

#endif /* defined(__MMI_VIRTUAL_KEYBOARD__) */



/*****************************************************************************
 * FUNCTION
 *  mmi_imui_set_hand_writing_areas
 * DESCRIPTION
 *  Set hand writing areas
 * PARAMETERS
 * stroke_area    [IN]    The first hand writing area
 * ext_stroke     [IN]    The hand writing area after the first stroke
 * RETURNS
 *  void
 *****************************************************************************/
static U32 mmi_imui_set_hand_writing_areas(mmi_pen_handwriting_area_struct *stroke_area, mmi_pen_handwriting_area_struct *ext_stroke)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
    return MMI_IMUI_RESULT_FALSE;
}

#if defined(__MMI_IME_FTE_ENHANCE__)

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_multi_block_area
 * DESCRIPTION
 *  Set hand writing areas
 * PARAMETERS
 *  bottom_line    [IN]    The y of bottom line for multi blocks
 * RETURNS
 *  The bottom line for next control
 *****************************************************************************/
static S32 mmi_imui_draw_single_block_area(S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	S32 block_height, block_width;
	S32 extra_block_icon_x, extra_block_icon_y;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	if (!(mmi_imc_is_rotated()))
	{
	    block_height = MMI_IMUI_SINGLE_BLOCK_HEIGHT;
	    block_width = MMI_IMUI_SINGLE_BLOCK_WIDTH;
	    extra_block_icon_x = MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X;
	    extra_block_icon_y = MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y;
	}
	else
	{
	    block_height = MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED;
	    block_width = MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED;
	    extra_block_icon_x = MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_X_ROTATED;
	    extra_block_icon_y = MMI_IMUI_SINGLE_BLOCK_EXTRA_BLOCK_ICON_Y_ROTATED;
	}
	
#if !defined(__NO_HANDWRITING__) && defined(__MMI_VIRTUAL_KEYBOARD__)
    g_imui_control_set.control_bottoms[MMI_IMUI_SINGLE_BLOCK_AREA] = bottom_line;
    g_imui_single_block_area.x = MMI_IMUI_SINGLE_BLOCK_X;
    g_imui_single_block_area.y = bottom_line - block_height + 1;
#if defined(__MMI_VUI_ENGINE__)
    if (vadp_p2v_uc_is_in_venus())
    {
        gdi_image_draw_blend2layers(
            g_imui_single_block_area.x + extra_block_icon_x, 
            g_imui_single_block_area.y + extra_block_icon_y, 
            (U8*)GetImage(g_imui_single_block_area.indicator_id));
    }
    else
#endif /* defined(__MMI_VUI_ENGINE__) */
    {
        gdi_layer_push_clip();
        gdi_layer_set_clip(
            g_imui_single_block_area.x,
            g_imui_single_block_area.y,
            g_imui_single_block_area.x + block_width - 1,
            g_imui_single_block_area.y + block_height - 1);
        gdi_push_and_set_alpha_blending_source_layer((gdi_handle)gdi_act_layer);
        gui_show_image(
            g_imui_single_block_area.x + extra_block_icon_x, 
            g_imui_single_block_area.y + extra_block_icon_y, 
            (PU8)GetImage(g_imui_single_block_area.indicator_id));         
        gdi_pop_and_restore_alpha_blending_source_layer();
        gdi_layer_pop_clip();
    }
#endif /* !defined(__NO_HANDWRITING__) && defined(__MMI_VIRTUAL_KEYBOARD__) */
    return bottom_line;
}


#endif /* defined(__MMI_IME_FTE_ENHANCE__) */

#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_multi_block_area
 * DESCRIPTION
 *  Set hand writing areas
 * PARAMETERS
 *  bottom_line    [IN]    The y of bottom line for multi blocks
 * RETURNS
 *  The bottom line for next control
 *****************************************************************************/
static S32 mmi_imui_draw_multi_block_area(S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_imui_control_set.control_bottoms[MMI_IMUI_MULTI_BLOCK_AREA] = bottom_line;
    
    mmi_imui_draw_back_ground(g_imui_ui_param.imui_left, 
                              bottom_line - (MMI_IMUI_MULTIBLOCK_BOTTOM_GAP + 
                              MMI_IMUI_MULTIBLOCK_TOP_GAP + MMI_IMUI_MULTI_BLOCK_HEIGHT) + 1,
                              g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
                              bottom_line);
    
	gdi_draw_rect(g_imui_ui_param.imui_left + MMI_IMUI_MULTIBLOCK_LEFT_GAP,
         		  bottom_line - (MMI_IMUI_MULTIBLOCK_BOTTOM_GAP + MMI_IMUI_MULTI_BLOCK_HEIGHT) + 1, 
         		  g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1 - MMI_IMUI_MULTIBLOCK_RIGHT_GAP,
         		  bottom_line - MMI_IMUI_MULTIBLOCK_BOTTOM_GAP,
         		  GDI_COLOR_BLACK);
    
    gdi_draw_rect(g_imui_ui_param.imui_left + MMI_IMUI_MULTIBLOCK_LEFT_GAP + 1,
         		  bottom_line - (MMI_IMUI_MULTIBLOCK_BOTTOM_GAP + MMI_IMUI_MULTI_BLOCK_HEIGHT) + 1 + 1, 
         		  (g_imui_ui_param.imui_width - 1 - MMI_IMUI_MULTIBLOCK_RIGHT_GAP - MMI_IMUI_MULTIBLOCK_LEFT_GAP) / 2 - 1,
         		  bottom_line - MMI_IMUI_MULTIBLOCK_BOTTOM_GAP - 1,
         		  gdi_act_color_from_rgb(255, 150, 150, 150));

    gdi_draw_rect((g_imui_ui_param.imui_width - 1 - MMI_IMUI_MULTIBLOCK_RIGHT_GAP - MMI_IMUI_MULTIBLOCK_LEFT_GAP) / 2 + 1,
         		  bottom_line - (MMI_IMUI_MULTIBLOCK_BOTTOM_GAP + MMI_IMUI_MULTI_BLOCK_HEIGHT) + 1 + 1, 
         		  g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1 - MMI_IMUI_MULTIBLOCK_RIGHT_GAP - 1,
         		  bottom_line - MMI_IMUI_MULTIBLOCK_BOTTOM_GAP - 1,
         		  gdi_act_color_from_rgb(255, 150, 150, 150));
    
	gdi_draw_line(
			(g_imui_ui_param.imui_width - 1 - MMI_IMUI_MULTIBLOCK_RIGHT_GAP - MMI_IMUI_MULTIBLOCK_LEFT_GAP) / 2,
		   	bottom_line - (MMI_IMUI_MULTIBLOCK_BOTTOM_GAP + MMI_IMUI_MULTI_BLOCK_HEIGHT) + 1, 
			(g_imui_ui_param.imui_width - 1 - MMI_IMUI_MULTIBLOCK_RIGHT_GAP - MMI_IMUI_MULTIBLOCK_LEFT_GAP) / 2,
			bottom_line - MMI_IMUI_MULTIBLOCK_BOTTOM_GAP,
			GDI_COLOR_BLACK);
    
    return bottom_line - (MMI_IMUI_MULTIBLOCK_BOTTOM_GAP + MMI_IMUI_MULTIBLOCK_TOP_GAP + MMI_IMUI_MULTI_BLOCK_HEIGHT);
}
#endif


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_create_hand_writing_layer
 * DESCRIPTION
 *  Create hand writing layer
 * PARAMETERS
 *  void
 * RETURNS
 *  Whether have created layer successfully
 *****************************************************************************/
static U32 mmi_imui_create_hand_writing_layer(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    return MMI_IMUI_RESULT_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_hand_writing_stroke_int
 * DESCRIPTION
 *  Draw hand writing stroke
 * PARAMETERS
 *  previous_point     [IN]       The previous point
 *  point              [IN]       The current point
 * RETURNS
 *  Whether have drawn successfully
 *****************************************************************************/
static void mmi_imui_draw_hand_writing_stroke_int(mmi_pen_point_struct *previous_point, mmi_pen_point_struct *point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifndef __MMI_IME_V3__
    int i;
#endif
    S32 offset_x[] = {0,1,0,-1,0}, offset_y[] = {0,0,1,0,-1};// offset_x[i],offset_y[i] is offset with original point, 
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Draw the point of the stroke */
#ifndef __MMI_IME_V3__
    for (i = 0; i < 5; i++)
    {
        gui_line(previous_point->x + offset_x[i], previous_point->y + offset_y[i], point->x + offset_x[i], point->y + offset_y[i], g_imui_hand_writing_stroke_color);
    }
#if defined(__MMI_MAINLCD_480X800__)
    gui_line(previous_point->x + 2, previous_point->y, point->x + 2, point->y, g_imui_hand_writing_stroke_color);
    gui_line(previous_point->x, previous_point->y + 2, point->x, point->y + 2, g_imui_hand_writing_stroke_color);
    gui_line(previous_point->x - 2, previous_point->y, point->x - 2, point->y, g_imui_hand_writing_stroke_color);
    gui_line(previous_point->x, previous_point->y - 2, point->x, point->y - 2, g_imui_hand_writing_stroke_color);
#endif

#else
	//Need to modify for IMEv3 Color
#if !defined(__NO_HANDWRITING__)
	U8 uWidth = mmi_imm_handwriting_get_stroke_width();	
	//color cr = mmi_imm_handwriting_get_current_stroke_color();
	/*
	gdi_draw_solid_circle(previous_point->x, previous_point->y, uWidth, gdi_act_color_from_rgb(
		cr.alpha,
		cr.r,
		cr.g,
		cr.b));
	*/
	gui_wline(previous_point->x, previous_point->y, point->x, point->y,g_imui_hand_writing_stroke_color, uWidth);

	/*
	gdi_draw_solid_circle(point->x, point->y, uWidth, gdi_act_color_from_rgb(
		cr.alpha,
		cr.r,
		cr.g,
		cr.b));
	*/
#endif
#endif
	
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_hand_writing_stroke
 * DESCRIPTION
 *  Draw hand writing stroke
 * PARAMETERS
 *  previous_point     [IN]       The previous point
 *  point              [IN]       The current point
 * RETURNS
 *  Whether have drawn successfully
 *****************************************************************************/
static U32 mmi_imui_draw_hand_writing_stroke(mmi_pen_point_struct *previous_point, mmi_pen_point_struct *point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_VUI_ENGINE__)
    if (vadp_p2v_uc_is_in_venus())
    {

    }
    else        
#endif
    {
        #if defined(__ATV_SMS_SUPPORT__)
        if (!mmi_imc_is_in_atv_editor())
        #endif /* defined(__ATV_SMS_SUPPORT__) */
        {
        #if !defined(__MMI_IME_FTE_ENHANCE__)
        #if !defined(MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER)
            if (g_imui_hand_writing_GDI_handle == GDI_ERROR_HANDLE)
            {
                S32 i;
                gdi_handle layers[4];

            g_imui_stroke_GDI_buffer = (U8*) mmi_frm_scrmem_alloc_framebuffer(handwriting_stroke_layer_mem);
            MMI_ASSERT(g_imui_stroke_GDI_buffer);

            if (GDI_LAYER_SUCCEED != gdi_layer_create_using_outside_memory(
    			0,
    			0,
    			UI_device_width,
    			UI_device_height,
    			&g_imui_hand_writing_GDI_handle,
    			(U8*) g_imui_stroke_GDI_buffer,
        		handwriting_stroke_layer_mem))
            {
                MMI_ASSERT(0);
            }

            gdi_layer_push_and_set_active(g_imui_hand_writing_GDI_handle);
            gdi_layer_set_source_key(TRUE, GDI_COLOR_TRANSPARENT);
            gdi_layer_clear(GDI_COLOR_TRANSPARENT);
            gdi_layer_pop_and_restore_active();

            gdi_layer_get_blt_layer(&layers[0], &layers[1], &layers[2], &layers[3]);

            /* Set the handwriting layer to the top of gdi blt layers */
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
            for ( i = 3; i >= 0; i--)
            {
                if (layers[i] != GDI_NULL_HANDLE)
                {
                    break;
                }
            }

            if (i == 3 || i < 0)
            {
                MMI_ASSERT(0);
            }
            layers[i+1] = g_imui_hand_writing_GDI_handle;
            gdi_layer_set_blt_layer(
                                layers[0],
                                layers[1],
                                layers[2],
                                layers[3]);
        }
    #endif /* MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER */

    #ifdef MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER
        /* Create new stroke layer after editor/virtual keyboard is resized */
        mmi_imui_backup_and_set_blt_layer();
    #endif /* MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER */

        gdi_layer_lock_frame_buffer();

    #ifdef MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER
        gdi_layer_push_and_set_active(g_imui_hand_writing_stroke_handle);
    #else
        gdi_layer_push_and_set_active(g_imui_hand_writing_GDI_handle);
    #endif /* MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER */

        gdi_layer_push_clip();
    #endif /* #if !defined(__MMI_IME_FTE_ENHANCE__) */
    }
    }

	

gui_push_clip();
if(mmi_imc_pen_get_handwriting_style() == MMI_IMC_PEN_HANDWRITING_STYLE_FULL_SCREEN)
{
    gui_set_clip(g_imc_stroke_area[1].x1, g_imc_stroke_area[1].y1, g_imc_stroke_area[1].x2, g_imc_stroke_area[1].y2);
    //set the clip for extended area
}
else
{
    gui_set_clip(g_imc_stroke_area[0].x1, g_imc_stroke_area[0].y1, g_imc_stroke_area[0].x2, g_imc_stroke_area[0].y2);
}
#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)
if(g_active_block == 2)
{
     gui_set_clip(g_imc_stroke_area[1].x1, g_imc_stroke_area[1].y1, g_imc_stroke_area[1].x2, g_imc_stroke_area[1].y2);
}
#endif
mmi_imui_draw_hand_writing_stroke_int(previous_point, point);

gui_pop_clip();

#if defined(__MMI_VUI_ENGINE__)
    if (vadp_p2v_uc_is_in_venus())
    {

    }
    else        
#endif
    {
        #if defined(__ATV_SMS_SUPPORT__)
        if (!mmi_imc_is_in_atv_editor())
        #endif /* defined(__ATV_SMS_SUPPORT__) */
        {
        #if !defined(__MMI_IME_FTE_ENHANCE__) 
            gdi_layer_pop_clip();
            gdi_layer_pop_and_restore_active();
            gdi_layer_unlock_frame_buffer();
        #endif
        }

    #if defined(__MMI_MAINLCD_480X800__)
        gdi_layer_blt_previous(
            PEN_MIN(previous_point->x, point->x) - 2,
            PEN_MIN(previous_point->y, point->y) - 2,
            PEN_MAX(previous_point->x, point->x) + 2,
            PEN_MAX(previous_point->y, point->y) + 2);
    #else
        gdi_layer_blt_previous(
            PEN_MIN(previous_point->x, point->x) - 1,
            PEN_MIN(previous_point->y, point->y) - 1,
            PEN_MAX(previous_point->x, point->x) + 1,
            PEN_MAX(previous_point->y, point->y) + 1);
    #endif
    }
    return MMI_IMUI_RESULT_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_clear_hand_writing_stroke
 * DESCRIPTION
 *  Clear hand writing stroke
 * PARAMETERS
 *  void
 * RETURNS
 *  Whether have cleared successfully
 *****************************************************************************/
static U32 mmi_imui_clear_hand_writing_stroke(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#ifdef MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER
    mmi_imui_restore_blt_layer();
#else
    //clear stroke layer 
#if defined(__MMI_VUI_ENGINE__)
    if (!vadp_p2v_uc_is_in_venus())
#endif 
    {
    #if defined(__MMI_IME_FTE_ENHANCE__)
        if ((g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)) &&
            (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)))
        {
            mmi_imui_redraw_partial_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD));
        }
    #else
    if (g_imui_hand_writing_GDI_handle != GDI_ERROR_HANDLE)
    {
       gdi_layer_push_and_set_active(g_imui_hand_writing_GDI_handle);
       gdi_layer_set_source_key(TRUE, GDI_COLOR_TRANSPARENT);
       gdi_layer_clear(GDI_COLOR_TRANSPARENT);
       gdi_layer_pop_and_restore_active();
    }
    #endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */
    }
#endif /* MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER */
    return MMI_IMUI_RESULT_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_pen_down_event
 * DESCRIPTION
 *  Operation for pen down
 * PARAMETERS
 *  pos     [IN]       Position of pen down
 *  command_callback [IN] Call back function for feedback to caller
 * RETURNS
 *  Whether IMUI have taken over pen down event
 *****************************************************************************/
static U32 mmi_imui_pen_down_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 no_of_control_set = 0;
    MMI_BOOL ret = MMI_FALSE; 
    mmi_imui_message_struct mes_str;
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    gui_pen_event_param_struct vk_para;
    gui_virtual_keyboard_pen_enum vk_event;
#endif
    mmi_imui_selection_area_pen_event_enum selection_event = MMI_IMUI_SELECTION_AREA_PEN_NONE;
	#if defined(__MMI_IME_CANDIDATE_GRID__)
	mmi_imui_selection_area_grid_pen_event_enum selection_grid_event = MMI_IMUI_SELECTION_AREA_GRID_PEN_NONE;
	#endif
     
#if defined(__MMI_IME_VERTICAL_CAND_BOX__)
    gui_list_pen_enum list_event; 
#endif
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
    gui_list_pen_enum list_event; 
#endif
#ifdef __MMI_IME_PLUG_IN__
    mmi_ime_sdk_pen_event_data_struct sdk_pen_evt;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for(; no_of_control_set < g_imui_control_set.number_of_controls; no_of_control_set++)
    {
    #ifdef __MMI_IME_PLUG_IN__
        if (g_imui_control_set.control_set[no_of_control_set] >= MMI_IMUI_CUSTOM_CONTROL_BEGIN &&
            g_imui_control_set.control_set[no_of_control_set] <= MMI_IMUI_CUSTOM_CONTROL_END)
        {
            if (g_imui_control_set.showed_flag &
                MMI_IMUI_CONTROL_MASK(g_imui_control_set.control_set[no_of_control_set]))
            {
                sdk_pen_evt.event_type = MMI_PEN_EVENT_DOWN;
                sdk_pen_evt.pos.x = pos->x;
                sdk_pen_evt.pos.y = pos->y;
                ret = mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_IMUI_CONTROL_TRANSLATE_PEN_EVENT,
                                               (U32)g_imui_control_set.control_set[no_of_control_set],
                                               (U32)&sdk_pen_evt);
                if (ret)
                {
                    g_imui_pen_down_control = g_imui_control_set.control_set[no_of_control_set];
                }
            }
        }
        else
    #endif
        {
            switch(g_imui_control_set.control_set[no_of_control_set])
            {
                case MMI_IMUI_INFORMATION_BAR:
				    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INFORMATION_BAR))
                    {
					    ret = (MMI_BOOL) PEN_CHECK_BOUND(
                            pos->x,
                            pos->y,
                            g_imui_information_bar_display_rect.x,
                            g_imui_information_bar_display_rect.y,
                            g_imui_information_bar_display_rect.width,
                            g_imui_information_bar_display_rect.height);
					    
					    if (ret)
					    {
						    g_imui_pen_down_control = MMI_IMUI_INFORMATION_BAR;
						    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_INFORMATION_BAR;
						    mes_str.param_0 = 0;
						    mes_str.param_1 = 0;
						    command_callback(&mes_str);
					    }
				    }
                    break;
                    
                case MMI_IMUI_IME_HINT_AREA:
                    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_HINT_AREA))
                    {
					    ret = (MMI_BOOL) PEN_CHECK_BOUND(
                            pos->x,
                            pos->y,
                            g_imui_ime_hint_rect.x,
                            g_imui_ime_hint_rect.y,
                            g_imui_ime_hint_rect.width,
                            g_imui_ime_hint_rect.height);
					    
					    if (ret)
					    {
						    g_imui_pen_down_control = MMI_IMUI_IME_HINT_AREA;
						    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_IME_HINT;
						    mes_str.param_0 = 0;
						    mes_str.param_1 = 0;
						    command_callback(&mes_str);
					    }
				    }
                    break;
    
            #if defined(__MMI_VIRTUAL_KEYBOARD__)        
                case MMI_IMUI_VIRTUAL_KEYBOARD:
                    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
                    {
                        {
							/*special handling for MAUI_02657085 for cancelling timer before popup appears*/
							if(mmi_imc_get_state() == MMI_IMC_STATE_PASSWORD_PREVIEW)
							{
								mmi_imc_cancel_timer();
							}
							
							/*#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
							//as scrolling box comes over vk, so need to check if pen down in scrolling box
							if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
								g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
							{
								if ((POINT_CHECK_BOUND(pos->x, pos->y, g_imui_vertical_composition_list.x, g_imui_vertical_composition_list.y, g_imui_vertical_composition_list.width, g_imui_vertical_composition_list.height)))
								{
									break;
								}
							}
							#endif*/
                            ret = wgui_virtual_keyboard_translate_pen_event(
                                        pos->x,
                                        pos->y,
                                        MMI_PEN_EVENT_DOWN,
                                        &vk_event,
                                        &vk_para);
    
                            if (ret)
                            {
                            #if defined(__MMI_VUI_ENGINE__)
                                if (vadp_p2v_uc_is_in_venus())
                                {
                                    vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD));
                                }
                            #endif
    
                                g_imui_pen_down_control = MMI_IMUI_VIRTUAL_KEYBOARD;
                                mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_VIRTUAL_KEYBOARD;
                                mes_str.param_0 = (U32)vk_event;
                                mes_str.param_1 = (U32)&vk_para;
                                command_callback(&mes_str);
                            }
                        }
                    }
                    break;
            #endif /* #if defined(__MMI_VIRTUAL_KEYBOARD__) */
				#if defined(__MMI_IME_CANDIDATE_GRID__)
				case   MMI_IMUI_CANDIDATE_GRID_AREA:
					 if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_GRID_AREA))
                    {
						    ret = mmi_imui_candidate_grid_area_translate_pen_event(&g_imui_candidate_box_grid, MMI_PEN_EVENT_DOWN,
                                                                        pos->x, pos->y, &selection_grid_event);
                            if (ret)
                            {
								g_imui_is_down_in_grid = MMI_TRUE;
								mmi_imui_draw_candidate_box_area_grid(g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_GRID_AREA]);
								g_imui_is_down_in_grid = MMI_FALSE;
                    
                                g_imui_pen_down_control = MMI_IMUI_CANDIDATE_GRID_AREA;
                    
				                if (selection_grid_event != MMI_IMUI_SELECTION_AREA_GRID_PEN_NONE)
                                {
                                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_CANDIDATE_GRID_BOX;
                                    mes_str.param_0 = (U32)selection_grid_event;
                                    mes_str.param_1 = 0;
                                    command_callback(&mes_str);
                                }
							}
					 }
					break;
				#endif
                case MMI_IMUI_CANDIDATE_AREA:
			        if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA))
                    {
					    
                    #if defined(__MMI_VUI_ENGINE__)
                        if (vadp_p2v_uc_is_in_venus())
                        {
                           if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) 
                           {
                               break;
                           }
                        }
                    #endif
                    
					    if (mmi_imc_get_state() == MMI_IMC_STATE_MULTITAP)
					    {
                        #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
                            if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
						    {
							    
						    }
                        #endif
						    {
							    /* 
							     * In MMI_IMC_STATE_MULTITAP, we still have to capture the pen event, 
							     * otherwise, the pen event will be dispatch to the other component
							     */
							    if ((POINT_CHECK_BOUND(pos->x, pos->y, g_imui_candidate_box.x, g_imui_candidate_box.y, g_imui_candidate_box.width, g_imui_candidate_box.height)))
							    {
								    g_imui_pen_down_control = MMI_IMUI_CONTROL_MAX; 
								    ret = MMI_TRUE;
							    }
						    }
						    
						    break;
					    }
                    
                    #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
                        if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
                        {
                            ret = gui_fixed_list_menu_translate_pen_event(
                                      &g_imui_vertical_candidate_list,
                                      MMI_PEN_EVENT_DOWN,
                                      pos->x, pos->y, &list_event);
    
                            if (ret)
                            {
                            #if defined(__MMI_VUI_ENGINE__)
                                if (vadp_p2v_uc_is_in_venus())
                                {
                                    vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA));
                                }
                                else
                            #endif
                                {
                                    mmi_imui_draw_verical_candidate_list(g_imui_vertical_candidate_list.x, g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA]);
                                }
    
                                g_imui_pen_down_control = MMI_IMUI_CANDIDATE_AREA;
    
                                if (list_event == GUI_LIST_PEN_HIGHLIGHT_CHANGED)
                                {
                                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_CANDIDATE_BOX;
                                    mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
                                    mes_str.param_1 = 0;
                                    command_callback(&mes_str);
                                }
                            }
                        }
                        else
                    #endif /* #if defined(__MMI_IME_VERTICAL_CAND_BOX__) */
                        {
                            ret = mmi_imui_selection_area_translate_pen_event(&g_imui_candidate_box, MMI_PEN_EVENT_DOWN,
                                                                        pos->x, pos->y, &selection_event);
                            if (ret)
                            {
                            #if defined(__MMI_VUI_ENGINE__)
                                if (vadp_p2v_uc_is_in_venus())
                                {
                                    vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA));
                                }
                                else
                            #endif
                                {
                                #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
                                    if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
                                    {
                                        mmi_imui_redraw(0);
                                    }
                                    else
                                #endif    
                                    {
                                        mmi_imui_draw_candidate_box_area(g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA]);
                                    }
                                }
                            
                                g_imui_pen_down_control = MMI_IMUI_CANDIDATE_AREA;
    
				                if (selection_event != MMI_IMUI_SELECTION_AREA_PEN_NONE)
                                {
                                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_CANDIDATE_BOX;
                                    mes_str.param_0 = (U32)selection_event;
                                    mes_str.param_1 = 0;
                                    command_callback(&mes_str);
                                }
                            }
                        }
                    }
                    break;
                    
                case MMI_IMUI_COMPOSITION_AREA:
                    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA))
                    {
                    #if defined(__MMI_VUI_ENGINE__)
                        if (vadp_p2v_uc_is_in_venus())
                        {
                           if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) 
                           {
                               break;
                           }
                        }
                    #endif
                    #if defined(__MMI_IME_SCROLLING_COMPOSITION__)
                        if (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
                        {
                            ret = (MMI_BOOL) gui_fixed_list_menu_translate_pen_event(
                                      &g_imui_vertical_composition_list,
                                      MMI_PEN_EVENT_DOWN,
                                      pos->x, pos->y, &list_event);
							ret = (MMI_BOOL) PEN_CHECK_BOUND(
									pos->x,
									pos->y,
									g_imui_vertical_composition_list.x,
									g_imui_vertical_composition_list.y,
									g_imui_vertical_composition_list.width,
									g_imui_vertical_composition_list.height);
    
                            if (ret)
                            {
             
                                mmi_imui_draw_vertical_composition_list(g_imui_vertical_composition_list.x, UI_device_height-1);
                    
                                g_imui_pen_down_control = MMI_IMUI_COMPOSITION_AREA;
                    
                                if (list_event == GUI_LIST_PEN_HIGHLIGHT_CHANGED)
                                {
                                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_COMPOSITION_BOX;
                                    mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
                                    mes_str.param_1 = 1;// 1 means pen down in vertical comp box
                                    command_callback(&mes_str);
                                }
                            }
                        }
                        else
                    #endif 
                    #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
                        if (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE)
                        {
                            ret = (MMI_BOOL) PEN_CHECK_BOUND(
                                    pos->x,
                                    pos->y,
                                    g_imui_resizable_composition_box.x,
                                    g_imui_resizable_composition_box.y,
                                    g_imui_resizable_composition_box.width,
                                    g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT);
    
                            if (ret)
                            {
                                g_imui_pen_down_control = MMI_IMUI_COMPOSITION_AREA;
    
    						    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_COMPOSITION_BOX;
    						    mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
    						    mes_str.param_1 = 0;
    						    command_callback(&mes_str);
                            }
                        }
                        else
                    #endif
                        {
                            ret = mmi_imui_selection_area_translate_pen_event(&g_imui_composition_box, MMI_PEN_EVENT_DOWN,
                                                                        pos->x, pos->y, &selection_event);
                            if (ret)
                            {
                            #if defined(__MMI_VUI_ENGINE__)
                                if (vadp_p2v_uc_is_in_venus())
                                {
                                    vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA));
                                }
                                else
                            #endif
                                {
                                #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
                                    if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
                                    {
                                        mmi_imui_redraw(0);
                                    }
                                    else
                                #endif    
                                    {
                                        mmi_imui_draw_composition_box_area(g_imui_control_set.control_bottoms[MMI_IMUI_COMPOSITION_AREA]);
                                    }
                                }
                            
                                g_imui_pen_down_control = MMI_IMUI_COMPOSITION_AREA;
    
    						    if (selection_event != MMI_IMUI_SELECTION_AREA_PEN_NONE)
                                {
    							    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_COMPOSITION_BOX;
    							    mes_str.param_0 = (U32)selection_event;
    							    mes_str.param_1 = 0;
    							    command_callback(&mes_str);
    						    }
                            }
                        }
                    }
                    break;
            #if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
                case MMI_IMUI_INPUT_AREA:
                    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA))
                    {
                        ret = (MMI_BOOL) PEN_CHECK_BOUND(pos->x,
                                              pos->y,
                                              g_imui_input_box.x,
                                              g_imui_input_box.y,
                                              g_imui_input_box.width,
                                              g_imui_input_box.height);
                        if (ret)
                        {
                            g_imui_pen_down_control = MMI_IMUI_INPUT_AREA;
            #ifdef __MMI_CSTAR_PHRASE_INPUT__
                            mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_INPUT_BOX;
    						mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
    						mes_str.param_1 = 0;
    						command_callback(&mes_str);
            #endif
                        }
                    }
                    break;
            #endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/

            
            #ifdef __MMI_CLIPBOARD_FLOATING_MENU__
                case MMI_IMUI_CLIPBOARD_FLOATING_MENU:
                    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CLIPBOARD_FLOATING_MENU))
                    {
                        ret = mmi_imui_clipboard_floating_menu_translate_pen_event(
                                  &g_imui_clipboard_floating_menu,
                                  MMI_PEN_EVENT_DOWN,
                                  pos->x,
                                  pos->y);
                        if (ret)
                        {
                            g_imui_pen_down_control = MMI_IMUI_CLIPBOARD_FLOATING_MENU;
                        }
                    }
                    break;
            #endif /* __MMI_CLIPBOARD_FLOATING_MENU__ */
            #if defined(__MMI_IME_FTE_ENHANCE__) && defined(__MMI_VIRTUAL_KEYBOARD__)
                case MMI_IMUI_SINGLE_BLOCK_AREA:
                    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA))
                    {
                        if (mmi_imc_is_rotated())
                        {
                            ret = (MMI_BOOL) PEN_CHECK_BOUND(pos->x,
                                          pos->y,
                                          g_imui_single_block_area.x,
                                          g_imui_single_block_area.y,
                                          MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED,
                                          MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED);
                        }
                        else
                        {
                            ret = (MMI_BOOL) PEN_CHECK_BOUND(pos->x,
                                          pos->y,
                                          g_imui_single_block_area.x,
                                          g_imui_single_block_area.y,
                                          MMI_IMUI_SINGLE_BLOCK_WIDTH,
                                          MMI_IMUI_SINGLE_BLOCK_HEIGHT);
                        }
					
                        if (ret)
                        {
                        }
                    }
                    break;
            #endif /* defined(__MMI_IME_FTE_ENHANCE__) && defined(__MMI_VIRTUAL_KEYBOARD__) */
                default:
                    break;
            }
        }
        if (ret)
        {
            break;
        }
        else
        {
            g_imui_pen_down_control = MMI_IMUI_CONTROL_MAX;
        }
    }

    if (ret)
    {
        return MMI_IMUI_RESULT_TRUE;
    }
    else
    {
        return MMI_IMUI_RESULT_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_pen_up_event
 * DESCRIPTION
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static U32 mmi_imui_pen_up_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE; 
    mmi_imui_message_struct mes_str;
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    gui_pen_event_param_struct vk_para;
    gui_virtual_keyboard_pen_enum vk_event;
#endif
    mmi_imui_selection_area_pen_event_enum selection_event = MMI_IMUI_SELECTION_AREA_PEN_NONE;
	#if defined(__MMI_IME_CANDIDATE_GRID__)
	mmi_imui_selection_area_grid_pen_event_enum selection_grid_event = MMI_IMUI_SELECTION_AREA_GRID_PEN_NONE;
	#endif
#if defined(__MMI_IME_VERTICAL_CAND_BOX__)
    gui_list_pen_enum list_event; 
#endif
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
    gui_list_pen_enum list_event; 
#endif
#ifdef __MMI_IME_PLUG_IN__
    mmi_ime_sdk_pen_event_data_struct sdk_pen_evt;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_IME_PLUG_IN__
    if (g_imui_pen_down_control >= MMI_IMUI_CUSTOM_CONTROL_BEGIN &&
        g_imui_pen_down_control <= MMI_IMUI_CUSTOM_CONTROL_END)
    {
        sdk_pen_evt.event_type = MMI_PEN_EVENT_UP;
        sdk_pen_evt.pos.x = pos->x;
        sdk_pen_evt.pos.y = pos->y;
        ret = mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_IMUI_CONTROL_TRANSLATE_PEN_EVENT,
                                       (U32)g_imui_pen_down_control,
                                       (U32)&sdk_pen_evt);
    }
    else
#endif
    {
        switch(g_imui_pen_down_control)
        {
        case MMI_IMUI_INFORMATION_BAR:
            ret = (MMI_BOOL) PEN_CHECK_BOUND(
                    pos->x,
                    pos->y,
                    g_imui_information_bar_display_rect.x,
                    g_imui_information_bar_display_rect.y,
                    g_imui_information_bar_display_rect.width,
                    g_imui_information_bar_display_rect.height);
        
            if (ret)
            {
                mes_str.message_id = MMI_IMUI_MESSAGE_PEN_UP_IN_INFORMATION_BAR;
                mes_str.param_0 = 0;
                mes_str.param_1 = 0;
                command_callback(&mes_str);
            }
            break;
            
        case MMI_IMUI_IME_HINT_AREA:
            ret = (MMI_BOOL) PEN_CHECK_BOUND(
                    pos->x,
                    pos->y,
                    g_imui_ime_hint_rect.x,
                    g_imui_ime_hint_rect.y,
                    g_imui_ime_hint_rect.width,
                    g_imui_ime_hint_rect.height);
        
            if (ret)
            {
                mes_str.message_id = MMI_IMUI_MESSAGE_PEN_UP_IN_IME_HINT;
                mes_str.param_0 = 0;
                mes_str.param_1 = 0;
                command_callback(&mes_str);
            }
            break;
    #if defined(__MMI_VIRTUAL_KEYBOARD__)
        case MMI_IMUI_VIRTUAL_KEYBOARD:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                ret = wgui_virtual_keyboard_translate_pen_event(
                            pos->x,
                            pos->y,
                            MMI_PEN_EVENT_UP,
                            &vk_event,
                            &vk_para);
        
                if (ret)
                {
                #if defined(__MMI_VUI_ENGINE__)
                    if (vadp_p2v_uc_is_in_venus())
                    {
                        vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD));
                    }
                #endif
    
                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_UP_IN_VIRTUAL_KEYBOARD;
                    mes_str.param_0 = (U32)vk_event;
                    mes_str.param_1 = (U32)&vk_para;
                    command_callback(&mes_str);
                }
            }
            break;
    #endif /* #if defined(__MMI_VIRTUAL_KEYBOARD__) */
        case MMI_IMUI_CANDIDATE_AREA:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA))
            {
            #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
                if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
                {
                    ret = gui_fixed_list_menu_translate_pen_event(
                              &g_imui_vertical_candidate_list,
                              MMI_PEN_EVENT_UP,
                              pos->x, pos->y, &list_event);
    
                    if (ret)
                    {
                    #if defined(__MMI_VUI_ENGINE__)
                        if (vadp_p2v_uc_is_in_venus())
                        {
                            vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA));
                        }
                        else
                    #endif
                        {
                            mmi_imui_draw_verical_candidate_list(g_imui_vertical_candidate_list.x, g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA]);
                        }
                        
     
                        g_imui_pen_down_control = MMI_IMUI_CANDIDATE_AREA;
    
                        if (list_event == GUI_LIST_PEN_ITEM_SELECTED || 
                            (list_event == GUI_LIST_PEN_NONE &&
                            !g_imui_vertical_candidate_list.pen_state.pen_on_scrollbar))
                        {
                            mes_str.message_id = MMI_IMUI_MESSAGE_PEN_UP_IN_CANDIDATE_BOX;
                            mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
                            mes_str.param_1 = 0;
                            command_callback(&mes_str);
                        }
                    }
                }
                else
            #endif /* #if defined(__MMI_IME_VERTICAL_CAND_BOX__) */
                {
                    ret = mmi_imui_selection_area_translate_pen_event(&g_imui_candidate_box, MMI_PEN_EVENT_UP,
                                                                    pos->x, pos->y, &selection_event);
                    if (ret)
                    {
                    #if defined(__MMI_VUI_ENGINE__)
                        if (vadp_p2v_uc_is_in_venus())
                        {
                            vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA));
                        }
                        else
                    #endif
                        {
                        #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
                            if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
                            {
                                mmi_imui_redraw(0);
                            }
                            else
                        #endif    
                            {
                                mmi_imui_draw_candidate_box_area(g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA]);
                            }
                        }
                        
                        mes_str.message_id = MMI_IMUI_MESSAGE_PEN_UP_IN_CANDIDATE_BOX;
    
                        if (selection_event != MMI_IMUI_SELECTION_AREA_PEN_NONE)
                        {
                            mes_str.param_0 = (U32)selection_event;
                            mes_str.param_1 = 0;
                            command_callback(&mes_str);
                        }
                    }
                }
            }
            break;
			#if defined(__MMI_IME_CANDIDATE_GRID__)
		case MMI_IMUI_CANDIDATE_GRID_AREA:
             if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_GRID_AREA))
             {
						    ret = mmi_imui_candidate_grid_area_translate_pen_event(&g_imui_candidate_box_grid, MMI_PEN_EVENT_UP,
                                                                        pos->x, pos->y, &selection_grid_event);
                            if (ret)
                            {
								mmi_imui_draw_candidate_box_area_grid(g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_GRID_AREA]);
                            
    
				                if (selection_grid_event != MMI_IMUI_SELECTION_AREA_GRID_PEN_NONE)
                                {
                                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_UP_IN_CANDIDATE_GRID_BOX;
                                    mes_str.param_0 = (U32)selection_grid_event;
                                    mes_str.param_1 = 0;
                                    command_callback(&mes_str);
                                }
							}
			}
			break;
			#endif
        case MMI_IMUI_COMPOSITION_AREA:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA))
            {
				#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
                if (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
                {
                    ret = (MMI_BOOL) gui_fixed_list_menu_translate_pen_event(
                              &g_imui_vertical_composition_list,
                              MMI_PEN_EVENT_UP,
                              pos->x, pos->y, &list_event);
    
                    if (ret)
                    {
                        
                        mmi_imui_draw_vertical_composition_list(g_imui_vertical_composition_list.x, UI_device_height-1);
     
                        g_imui_pen_down_control = MMI_IMUI_COMPOSITION_AREA;
    
                        if (list_event == GUI_LIST_PEN_ITEM_SELECTED || 
                            (list_event == GUI_LIST_PEN_NONE &&
                            !g_imui_vertical_composition_list.pen_state.pen_on_scrollbar))
                        {
                            mes_str.message_id = MMI_IMUI_MESSAGE_PEN_UP_IN_COMPOSITION_BOX;
                            mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
                            mes_str.param_1 = 1;
                            command_callback(&mes_str);
                        }
                    }
                }
                else
            #endif 
            #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
                if (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE)
                {
                    ret = (MMI_BOOL) PEN_CHECK_BOUND(
                            pos->x,
                            pos->y,
                            g_imui_resizable_composition_box.x,
                            g_imui_resizable_composition_box.y,
                            g_imui_resizable_composition_box.width,
                            g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT);
    
                    if (ret)
                    {
    				    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_UP_IN_COMPOSITION_BOX;
    				    mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
    				    mes_str.param_1 = 0;
    				    command_callback(&mes_str);
                    }
                }
                else
            #endif
                {
                    ret = mmi_imui_selection_area_translate_pen_event(&g_imui_composition_box, MMI_PEN_EVENT_UP,
                                                                        pos->x, pos->y, &selection_event);
                    if (ret)
                    {
                    #if defined(__MMI_VUI_ENGINE__)
                        if (vadp_p2v_uc_is_in_venus())
                        {
                            vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA));
                        }
                        else
                    #endif
                        {
                        #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
                            if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
                            {
                                mmi_imui_redraw(0);
                            }
                            else
                        #endif    
                            {
                                mmi_imui_draw_composition_box_area(g_imui_control_set.control_bottoms[MMI_IMUI_COMPOSITION_AREA]);
                            }
                        }
                    
                        mes_str.message_id = MMI_IMUI_MESSAGE_PEN_UP_IN_COMPOSITION_BOX;
    
                        if (selection_event != MMI_IMUI_SELECTION_AREA_PEN_NONE)
                        {
                            mes_str.param_0 = (U32)selection_event;
                            mes_str.param_1 = 0;
                            command_callback(&mes_str);
                        }
                    }
                }
            }
            break;

        #if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
        case MMI_IMUI_INPUT_AREA:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA))
            {
                ret = (MMI_BOOL) PEN_CHECK_BOUND(pos->x,
                                      pos->y,
                                      g_imui_input_box.x,
                                      g_imui_input_box.y,
                                      g_imui_input_box.width,
                                      g_imui_input_box.height);
                if (ret)
                {
    #ifdef __MMI_CSTAR_PHRASE_INPUT__
                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_UP_IN_INPUT_BOX;
					mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
					mes_str.param_1 = 0;
					command_callback(&mes_str);
    #endif
                }
            }
            break;
        #endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/
    #ifdef __MMI_CLIPBOARD_FLOATING_MENU__
        case MMI_IMUI_CLIPBOARD_FLOATING_MENU:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CLIPBOARD_FLOATING_MENU))
            {
                ret = mmi_imui_clipboard_floating_menu_translate_pen_event(
                          &g_imui_clipboard_floating_menu,
                          MMI_PEN_EVENT_UP,
                          pos->x,
                          pos->y);
                if (ret)
                {
                    
                }
            }
            break;
    #endif /* __MMI_CLIPBOARD_FLOATING_MENU__ */
    
    #if defined(__MMI_IME_FTE_ENHANCE__) && defined(__MMI_VIRTUAL_KEYBOARD__)        
        case MMI_IMUI_SINGLE_BLOCK_AREA:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA))
            {
                if (mmi_imc_is_rotated())
                {
                    ret = (MMI_BOOL) PEN_CHECK_BOUND(pos->x,
                                  pos->y,
                                  g_imui_single_block_area.x,
                                  g_imui_single_block_area.y,
                                  MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED,
                                  MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED);
                }
                else
                {
                    ret = (MMI_BOOL) PEN_CHECK_BOUND(pos->x,
                                      pos->y,
                                      g_imui_single_block_area.x,
                                      g_imui_single_block_area.y,
                                      MMI_IMUI_SINGLE_BLOCK_WIDTH,
                                      MMI_IMUI_SINGLE_BLOCK_HEIGHT);
                }
			
                if (ret)
                {
                }
            }
            break;
    #endif /* defined(__MMI_IME_FTE_ENHANCE__) && defined(__MMI_VIRTUAL_KEYBOARD__) */
        default:
            break;
        }
    }

    if (ret)
    {
        return MMI_IMUI_RESULT_TRUE;
    }
    else
    {
        return MMI_IMUI_RESULT_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_pen_move_event
 * DESCRIPTION
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static U32 mmi_imui_pen_move_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE; 
    mmi_imui_message_struct mes_str;
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    gui_pen_event_param_struct vk_para;
    gui_virtual_keyboard_pen_enum vk_event;
#endif
    mmi_imui_selection_area_pen_event_enum selection_event = MMI_IMUI_SELECTION_AREA_PEN_NONE;
	#if defined(__MMI_IME_CANDIDATE_GRID__)
	mmi_imui_selection_area_grid_pen_event_enum selection_grid_event = MMI_IMUI_SELECTION_AREA_GRID_PEN_NONE;
	#endif
#if defined(__MMI_IME_VERTICAL_CAND_BOX__)
    gui_list_pen_enum list_event; 
#endif       
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
    gui_list_pen_enum list_event; 
#endif 
#ifdef __MMI_IME_PLUG_IN__
    mmi_ime_sdk_pen_event_data_struct sdk_pen_evt;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_IME_PLUG_IN__
    if (g_imui_pen_down_control >= MMI_IMUI_CUSTOM_CONTROL_BEGIN &&
        g_imui_pen_down_control <= MMI_IMUI_CUSTOM_CONTROL_END)
    {
        sdk_pen_evt.event_type = MMI_PEN_EVENT_MOVE;
        sdk_pen_evt.pos.x = pos->x;
        sdk_pen_evt.pos.y = pos->y;
        ret = mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_IMUI_CONTROL_TRANSLATE_PEN_EVENT,
                                       (U32)g_imui_pen_down_control,
                                       (U32)&sdk_pen_evt);
    }
    else
#endif
    {
        switch(g_imui_pen_down_control)
        {
        case MMI_IMUI_INFORMATION_BAR:
            ret = (MMI_BOOL) PEN_CHECK_BOUND(
                    pos->x,
                    pos->y,
                    g_imui_information_bar_display_rect.x,
                    g_imui_information_bar_display_rect.y,
                    g_imui_information_bar_display_rect.width,
                    g_imui_information_bar_display_rect.height);
        
            if (ret)
            {
                mes_str.message_id = MMI_IMUI_MESSAGE_PEN_MOVE_IN_INFORMATION_BAR;
                mes_str.param_0 = 0;
                mes_str.param_1 = 0;
                command_callback(&mes_str);
            }
            break;
    
        case MMI_IMUI_IME_HINT_AREA:
            ret = (MMI_BOOL) PEN_CHECK_BOUND(
                    pos->x,
                    pos->y,
                    g_imui_ime_hint_rect.x,
                    g_imui_ime_hint_rect.y,
                    g_imui_ime_hint_rect.width,
                    g_imui_ime_hint_rect.height);
        
            if (ret)
            {
                mes_str.message_id = MMI_IMUI_MESSAGE_PEN_MOVE_IN_IME_HINT;
                mes_str.param_0 = 0;
                mes_str.param_1 = 0;
                command_callback(&mes_str);
            }
            break;
    #if defined(__MMI_VIRTUAL_KEYBOARD__)
        case MMI_IMUI_VIRTUAL_KEYBOARD:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                ret = wgui_virtual_keyboard_translate_pen_event(
                    pos->x,
                    pos->y,
                    MMI_PEN_EVENT_MOVE,
                    &vk_event,
                    &vk_para);
    
                if (ret)
                {
                #if defined(__MMI_VUI_ENGINE__)
                    if (vadp_p2v_uc_is_in_venus())
                    {
                        vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD));
                    }
                #endif
    
                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_MOVE_IN_VIRTUAL_KEYBOARD;
                    mes_str.param_0 = (U32)vk_event;
                    mes_str.param_1 = (U32)&vk_para;
                    command_callback(&mes_str);
                }
            }
            break;
    #endif /* #if defined(__MMI_VIRTUAL_KEYBOARD__) */
        case MMI_IMUI_CANDIDATE_AREA:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA))
            {
            #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
                if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
                {
                    ret = (MMI_BOOL) gui_fixed_list_menu_translate_pen_event(
                              &g_imui_vertical_candidate_list,
                              MMI_PEN_EVENT_MOVE,
                              pos->x, pos->y, &list_event);
    
                    if (ret)
                    {
                    #if defined(__MMI_VUI_ENGINE__)
                        if (vadp_p2v_uc_is_in_venus())
                        {
                            vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA));
                        }
                        else
                    #endif
                        {
                            mmi_imui_draw_verical_candidate_list(g_imui_vertical_candidate_list.x, g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA]);
                        }
    
                        g_imui_pen_down_control = MMI_IMUI_CANDIDATE_AREA;
    
                        if (list_event == GUI_LIST_PEN_HIGHLIGHT_CHANGED)
                        {
                            mes_str.message_id = MMI_IMUI_MESSAGE_PEN_MOVE_IN_CANDIDATE_BOX;
                            mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
                            mes_str.param_1 = 0;
                            command_callback(&mes_str);
                        }
                    }
                }
                else
            #endif /* #if defined(__MMI_IME_VERTICAL_CAND_BOX__) */
                {
                    ret = mmi_imui_selection_area_translate_pen_event(&g_imui_candidate_box, MMI_PEN_EVENT_MOVE,
                                                                    pos->x, pos->y, &selection_event);
                    if (ret)
                    {
                    #if defined(__MMI_VUI_ENGINE__)
                        if (vadp_p2v_uc_is_in_venus())
                        {
                            vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA));
                        }
                        else
                    #endif
                        {
                        #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
                            if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
                            {
                                mmi_imui_redraw(0);
                            }
                            else
                        #endif    
                            {
                                mmi_imui_draw_candidate_box_area(g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA]);
                            }
                        }
                    
                        mes_str.message_id = MMI_IMUI_MESSAGE_PEN_MOVE_IN_CANDIDATE_BOX;
    
                        if (selection_event != MMI_IMUI_SELECTION_AREA_PEN_NONE)
                        {
                            mes_str.param_0 = (U32)selection_event;
                            mes_str.param_1 = 0;
                            command_callback(&mes_str);
                        }
                    }
                }
            }
            break;
			#if defined(__MMI_IME_CANDIDATE_GRID__)
		case   MMI_IMUI_CANDIDATE_GRID_AREA:
					 if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_GRID_AREA))
                    {
						    ret = mmi_imui_candidate_grid_area_translate_pen_event(&g_imui_candidate_box_grid, MMI_PEN_EVENT_MOVE,
                                                                        pos->x, pos->y, &selection_grid_event);
                            if (ret)
                            {
								mmi_imui_draw_candidate_box_area_grid(g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_GRID_AREA]);
                            
                                g_imui_pen_down_control = MMI_IMUI_CANDIDATE_GRID_AREA;
    
				                if (selection_grid_event != MMI_IMUI_SELECTION_AREA_GRID_PEN_NONE)
                                {
                                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_MOVE_IN_CANDIDATE_GRID_BOX;
                                    mes_str.param_0 = (U32)selection_grid_event;
                                    mes_str.param_1 = 0;
                                    command_callback(&mes_str);
                                }
							}
					 }
					 break;
			#endif
        case MMI_IMUI_COMPOSITION_AREA:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA))
            {
				#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
                if (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
                {
                    ret = (MMI_BOOL) gui_fixed_list_menu_translate_pen_event(
                              &g_imui_vertical_composition_list,
                              MMI_PEN_EVENT_MOVE,
                              pos->x, pos->y, &list_event);
    
                    if (ret)
                    {
                    #if defined(__MMI_VUI_ENGINE__)
                        if (vadp_p2v_uc_is_in_venus())
                        {
                            vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA));
                        }
                        else
                    #endif
                        {
                            mmi_imui_draw_vertical_composition_list(g_imui_vertical_composition_list.x, UI_device_height-1);
                        }
    
                        g_imui_pen_down_control = MMI_IMUI_COMPOSITION_AREA;
    
                        /*if (list_event == GUI_LIST_PEN_HIGHLIGHT_CHANGED)
                        {
                            mes_str.message_id = MMI_IMUI_MESSAGE_PEN_MOVE_IN_COMPOSITION_BOX;
                            mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
                            mes_str.param_1 = 0;
                            command_callback(&mes_str);
                        }*/
                    }
                }
                else
            #endif 
            #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
                if (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE)
                {
                    ret = (MMI_BOOL) PEN_CHECK_BOUND(
                            pos->x,
                            pos->y,
                            g_imui_resizable_composition_box.x,
                            g_imui_resizable_composition_box.y,
                            g_imui_resizable_composition_box.width,
                            g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT);
    
                    if (ret)
                    {
    				    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_MOVE_IN_COMPOSITION_BOX;
    				    mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
    				    mes_str.param_1 = 0;
    				    command_callback(&mes_str);
                    }
                }
                else
            #endif
                {
                    ret = mmi_imui_selection_area_translate_pen_event(&g_imui_composition_box, MMI_PEN_EVENT_MOVE,
                                                                        pos->x, pos->y, &selection_event);
                    if (ret)
                    {
                    #if defined(__MMI_VUI_ENGINE__)
                        if (vadp_p2v_uc_is_in_venus())
                        {
                            vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA));
                        }
                        else
                    #endif
                        {
                        #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
                            if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
                            {
                                mmi_imui_redraw(0);
                            }
                            else
                        #endif    
                            {
                                mmi_imui_draw_composition_box_area(g_imui_control_set.control_bottoms[MMI_IMUI_COMPOSITION_AREA]);
                            }
                        }
                    
                        mes_str.message_id = MMI_IMUI_MESSAGE_PEN_MOVE_IN_COMPOSITION_BOX;
    
                        if (selection_event != MMI_IMUI_SELECTION_AREA_PEN_NONE)
                        {
                            mes_str.param_0 = (U32)selection_event;
                            mes_str.param_1 = 0;
                            command_callback(&mes_str);
                        }
                    }
                }
            }
            break;

        #if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
        case MMI_IMUI_INPUT_AREA:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA))
            {
                ret = (MMI_BOOL) PEN_CHECK_BOUND(pos->x,
                                      pos->y,
                                      g_imui_input_box.x,
                                      g_imui_input_box.y,
                                      g_imui_input_box.width,
                                      g_imui_input_box.height);
                if (ret)
                {
                
                }
            }
            break;
        #endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/
    #if defined(__MMI_IME_FTE_ENHANCE__) && defined(__MMI_VIRTUAL_KEYBOARD__)  
        case MMI_IMUI_SINGLE_BLOCK_AREA:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA))
            {
                if (mmi_imc_is_rotated())
                {
                    ret = (MMI_BOOL) PEN_CHECK_BOUND(pos->x,
                                  pos->y,
                                  g_imui_single_block_area.x,
                                  g_imui_single_block_area.y,
                                  MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED,
                                  MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED);
                }
                else
                {
                    ret = (MMI_BOOL) PEN_CHECK_BOUND(
                            pos->x,
                            pos->y,
                            g_imui_single_block_area.x, 
                            g_imui_single_block_area.y, 
                            MMI_IMUI_SINGLE_BLOCK_WIDTH, 
                            MMI_IMUI_SINGLE_BLOCK_HEIGHT);
                }
			
                if (ret)
                {
                }
            }
            break;
    #endif /* defined(__MMI_IME_FTE_ENHANCE__) && defined(__MMI_VIRTUAL_KEYBOARD__)  */      
        }
    }

    if (ret)
    {
        return MMI_IMUI_RESULT_TRUE;
    }
    else
    {
        return MMI_IMUI_RESULT_FALSE;
    }
}

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_pen_long_tap_event
 * DESCRIPTION
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static U32 mmi_imui_pen_long_tap_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    mmi_imui_message_struct mes_str;
	#if defined(__MMI_IME_CANDIDATE_GRID__)
	mmi_imui_selection_area_grid_pen_event_enum selection_grid_event = MMI_IMUI_SELECTION_AREA_GRID_PEN_NONE;
	#endif
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    gui_pen_event_param_struct vk_para;
    gui_virtual_keyboard_pen_enum vk_event;
#endif

#ifdef __MMI_IME_PLUG_IN__
    mmi_ime_sdk_pen_event_data_struct sdk_pen_evt;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_IME_PLUG_IN__
    if (g_imui_pen_down_control >= MMI_IMUI_CUSTOM_CONTROL_BEGIN &&
        g_imui_pen_down_control <= MMI_IMUI_CUSTOM_CONTROL_END)
    {
        sdk_pen_evt.event_type = MMI_PEN_EVENT_LONG_TAP;
        sdk_pen_evt.pos.x = pos->x;
        sdk_pen_evt.pos.y = pos->y;
        ret = mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_IMUI_CONTROL_TRANSLATE_PEN_EVENT,
                                       (U32)g_imui_pen_down_control,
                                       (U32)&sdk_pen_evt);
    }
    else
#endif
    {
        switch(g_imui_pen_down_control)
        {
    #if defined(__MMI_VIRTUAL_KEYBOARD__)
        case MMI_IMUI_VIRTUAL_KEYBOARD:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                ret = wgui_virtual_keyboard_translate_pen_event(
                            pos->x,
                            pos->y,
                            MMI_PEN_EVENT_LONG_TAP,
                            &vk_event,
                            &vk_para);
        
                if (ret)
                {
                #if defined(__MMI_VUI_ENGINE__)
                    if (vadp_p2v_uc_is_in_venus())
                    {
                        vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD));
                    }
                #endif
    
                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_LONGTAP_IN_VIRTUAL_KEYBOARD;
                    mes_str.param_0 = (U32)vk_event;
                    mes_str.param_1 = (U32)&vk_para;
                    command_callback(&mes_str);
                }
            }
            break;
    #endif /* #if defined(__MMI_VIRTUAL_KEYBOARD__) */
			#if defined(__MMI_IME_CANDIDATE_GRID__)
				case   MMI_IMUI_CANDIDATE_GRID_AREA:
					 if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_GRID_AREA))
                    {
						    ret = mmi_imui_candidate_grid_area_translate_pen_event(&g_imui_candidate_box_grid, MMI_PEN_EVENT_DOWN,
                                                                        pos->x, pos->y, &selection_grid_event);
                            if (ret)
                            {
								mmi_imui_draw_candidate_box_area_grid(g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_GRID_AREA]);
                    
                                g_imui_pen_down_control = MMI_IMUI_CANDIDATE_GRID_AREA;
                    
				                if (selection_grid_event != MMI_IMUI_SELECTION_AREA_GRID_PEN_NONE)
                                {
                                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_LONGTAP_IN_CANDIDATE_GRID_BOX;
                                    mes_str.param_0 = (U32)selection_grid_event;
                                    mes_str.param_1 = 0;
                                    command_callback(&mes_str);
                                }
							}
					 }
					break;
				#endif
        default:
            break;
        }
    }

    if (ret)
    {
        return MMI_IMUI_RESULT_TRUE;
    }
    else
    {
        return MMI_IMUI_RESULT_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_pen_repeat_event
 * DESCRIPTION
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static U32 mmi_imui_pen_repeat_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    mmi_imui_message_struct mes_str;
	#if defined(__MMI_IME_CANDIDATE_GRID__)
	mmi_imui_selection_area_grid_pen_event_enum selection_grid_event = MMI_IMUI_SELECTION_AREA_GRID_PEN_NONE;
	#endif
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    gui_pen_event_param_struct vk_para;
    gui_virtual_keyboard_pen_enum vk_event;
#endif

#ifdef __MMI_IME_PLUG_IN__
    mmi_ime_sdk_pen_event_data_struct sdk_pen_evt;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_IME_PLUG_IN__
    if (g_imui_pen_down_control >= MMI_IMUI_CUSTOM_CONTROL_BEGIN &&
        g_imui_pen_down_control <= MMI_IMUI_CUSTOM_CONTROL_END)
    {
        sdk_pen_evt.event_type = MMI_PEN_EVENT_REPEAT;
        sdk_pen_evt.pos.x = pos->x;
        sdk_pen_evt.pos.y = pos->y;
        ret = mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_IMUI_CONTROL_TRANSLATE_PEN_EVENT,
                                       (U32)g_imui_pen_down_control,
                                       (U32)&sdk_pen_evt);
    }
    else
#endif
    {
        switch(g_imui_pen_down_control)
        {
    #if defined(__MMI_VIRTUAL_KEYBOARD__)
        case MMI_IMUI_VIRTUAL_KEYBOARD:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                ret = wgui_virtual_keyboard_translate_pen_event(
                    pos->x,
                    pos->y,
                    MMI_PEN_EVENT_REPEAT,
                    &vk_event,
                    &vk_para);
                
                if (ret)
                {
                #if defined(__MMI_VUI_ENGINE__)
                    if (vadp_p2v_uc_is_in_venus())
                    {
                        vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD));
                    }
                #endif
    
                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_REPEAT_IN_VIRTUAL_KEYBOARD;
                    mes_str.param_0 = (U32)vk_event;
                    mes_str.param_1 = (U32)&vk_para;
                    command_callback(&mes_str);
                }
            }
            break;
    #endif /* #if defined(__MMI_VIRTUAL_KEYBOARD__) */
			#if defined(__MMI_IME_CANDIDATE_GRID__)
				case   MMI_IMUI_CANDIDATE_GRID_AREA:
					 if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_GRID_AREA))
                    {
						    ret = mmi_imui_candidate_grid_area_translate_pen_event(&g_imui_candidate_box_grid, MMI_PEN_EVENT_DOWN,
                                                                        pos->x, pos->y, &selection_grid_event);
                            if (ret)
                            {
								mmi_imui_draw_candidate_box_area_grid(g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_GRID_AREA]);
                    
                                g_imui_pen_down_control = MMI_IMUI_CANDIDATE_GRID_AREA;
                    
				                if (selection_grid_event != MMI_IMUI_SELECTION_AREA_GRID_PEN_NONE)
                                {
                                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_REPEAT_IN_CANDIDATE_GRID_BOX;
                                    mes_str.param_0 = (U32)selection_grid_event;
                                    mes_str.param_1 = 0;
                                    command_callback(&mes_str);
                                }
							}
					 }
					break;
				#endif
        default:
            break;
        }
    }

    if (ret)
    {
        return MMI_IMUI_RESULT_TRUE;
    }
    else
    {
        return MMI_IMUI_RESULT_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_pen_abort_event
 * DESCRIPTION
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static U32 mmi_imui_pen_abort_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    mmi_imui_message_struct mes_str;
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    gui_pen_event_param_struct vk_para;
    gui_virtual_keyboard_pen_enum vk_event;
#endif

#ifdef __MMI_IME_PLUG_IN__
    mmi_ime_sdk_pen_event_data_struct sdk_pen_evt;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_IME_PLUG_IN__
    if (g_imui_pen_down_control >= MMI_IMUI_CUSTOM_CONTROL_BEGIN &&
        g_imui_pen_down_control <= MMI_IMUI_CUSTOM_CONTROL_END)
    {
        sdk_pen_evt.event_type = MMI_PEN_EVENT_ABORT;
        sdk_pen_evt.pos.x = pos->x;
        sdk_pen_evt.pos.y = pos->y;
        ret = mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_IMUI_CONTROL_TRANSLATE_PEN_EVENT,
                                       (U32)g_imui_pen_down_control,
                                       (U32)&sdk_pen_evt);
    }
    else
#endif
    {
        switch(g_imui_pen_down_control)
        {
    #if defined(__MMI_VIRTUAL_KEYBOARD__)
        case MMI_IMUI_VIRTUAL_KEYBOARD:
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                ret = wgui_virtual_keyboard_translate_pen_event(
                    pos->x,
                    pos->y,
                    MMI_PEN_EVENT_ABORT,
                    &vk_event,
                    &vk_para);
                
                if (ret)
                {
                #if defined(__MMI_VUI_ENGINE__)
                    if (vadp_p2v_uc_is_in_venus())
                    {
                        vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD));
                    }
                #endif
    
                    mes_str.message_id = MMI_IMUI_MESSAGE_PEN_ABORT_IN_VIRTUAL_KEYBOARD;
                    mes_str.param_0 = (U32)vk_event;
                    mes_str.param_1 = (U32)&vk_para;
                    command_callback(&mes_str);
                }
            }
            break;
    #endif /* #if defined(__MMI_VIRTUAL_KEYBOARD__) */
        default:
            break;
        }
    }

    if (ret)
    {
        return MMI_IMUI_RESULT_TRUE;
    }
    else
    {
        return MMI_IMUI_RESULT_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_selection_area_translate_pen_event
 * DESCRIPTION
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL mmi_imui_selection_area_translate_pen_event(mmi_imui_selection_area_struct_p area_ptr, 
                                                            mmi_pen_event_type_enum pen_event, S16 x, S16 y,
                                                            mmi_imui_selection_area_pen_event_enum * event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    S32 i = 0;
    S32 candidate_index = 0;
    S32 temp_x;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if ((POINT_CHECK_BOUND(x, y, area_ptr->x, area_ptr->y, area_ptr->width, area_ptr->height) 
        && pen_event == MMI_PEN_EVENT_DOWN) || pen_event != MMI_PEN_EVENT_DOWN)
    {
        ret = MMI_TRUE;
    
        for (i = 0; i < area_ptr->item_count; i++)
        {
            if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE)
            {
                if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                {
                    mmi_imui_get_r2l_coordinate(area_ptr->items[i].candidate.x,
                                                area_ptr->items[i].candidate.width,
                                                area_ptr->width - 1,
                                                &temp_x);
                    
                    if (POINT_CHECK_BOUND(x, y, temp_x + area_ptr->x, 
                                          area_ptr->items[i].candidate.y + area_ptr->y, 
                                          area_ptr->items[i].candidate.width, area_ptr->items[i].candidate.height))
                    {
                        break;
                    }
                }
                else
                {
                    if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].candidate.x + area_ptr->x, 
                                          area_ptr->items[i].candidate.y + area_ptr->y, 
                                          area_ptr->items[i].candidate.width, area_ptr->items[i].candidate.height))
                    {
                        break;
                    }
                }
                candidate_index++;
            }
            else if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L) 
            {
                if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LEFT_ARROW && 
                         (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE
                           || area_ptr->highlight_index < area_ptr->cand_count - 1))
                {
                    if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].indicator.x + area_ptr->x, 
                                          area_ptr->items[i].indicator.y  + area_ptr->y, 
                                          g_imui_ui_param.arrow_width, g_imui_ui_param.arrow_height))
                    {
                        break;
                    }
                }
                else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_RIGHT_ARROW &&
                         (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_PRE_PAGE
                          || area_ptr->highlight_index > 0))
                {
                    if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].indicator.x + area_ptr->x, 
                                          area_ptr->items[i].indicator.y  + area_ptr->y, 
                                          g_imui_ui_param.arrow_width, g_imui_ui_param.arrow_height))
                    {
                        break;
                    }
                }
				#if defined(__MMI_IME_CANDIDATE_GRID__)
                else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_EXPAND)
                {
                    if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].indicator.x + area_ptr->x, 
                                          area_ptr->items[i].indicator.y  + area_ptr->y, 
                                          g_imui_ui_param.expand_button_width, area_ptr->height))
                    {
                        break;
                    }
                }
				#endif
            }
            else
            {
                if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LEFT_ARROW && 
                         (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_PRE_PAGE
                           || area_ptr->highlight_index > 0))
                {
                    if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].indicator.x + area_ptr->x, 
                                          area_ptr->items[i].indicator.y  + area_ptr->y, 
                                          g_imui_ui_param.arrow_width, g_imui_ui_param.arrow_height))
                    {
                        break;
                    }
                }
                else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_RIGHT_ARROW &&
                         (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE
                          || area_ptr->highlight_index < area_ptr->cand_count - 1))
                {
                    if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].indicator.x + area_ptr->x, 
                                          area_ptr->items[i].indicator.y  + area_ptr->y, 
                                          g_imui_ui_param.arrow_width, g_imui_ui_param.arrow_height))
                    {
                        break;
                    }
                }
				#if defined(__MMI_IME_CANDIDATE_GRID__)
                else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_EXPAND)
                {
                    if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].indicator.x + area_ptr->x, 
                                          area_ptr->items[i].indicator.y  + area_ptr->y, 
                                          g_imui_ui_param.expand_button_width, area_ptr->height))
                    {
                        break;
                    }
                }
				#endif
            }
        }

        if (i < area_ptr->item_count)
        {
            if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE)
            {
                area_ptr->highlight_index = candidate_index;
                *event = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
            }
            else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LEFT_ARROW)
            {   
                if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                {
                    *event = MMI_IMUI_SELECTION_AREA_PEN_RIGHT_ARROW;
                }
                else
                {
                    *event = MMI_IMUI_SELECTION_AREA_PEN_LEFT_ARROW;
                }
            }
            else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_RIGHT_ARROW)
            {
                if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                {
                    *event = MMI_IMUI_SELECTION_AREA_PEN_LEFT_ARROW;
                }
                else
                {
                    *event = MMI_IMUI_SELECTION_AREA_PEN_RIGHT_ARROW;
                }
            }
			#if defined(__MMI_IME_CANDIDATE_GRID__)
			else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_EXPAND)
            {
               
                    *event = MMI_IMUI_SELECTION_AREA_PEN_EXPAND;
                
            }
			#endif
            
            switch(pen_event)
            {
                case MMI_PEN_EVENT_DOWN:
                    if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LEFT_ARROW)
                    {
                        /* Providing the touch feedback for down event */
                        gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_DOWN);

                        area_ptr->left_arrow_state = MMI_IMUI_ARROW_PRESSED;
                    }
                    else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_RIGHT_ARROW)
                    {
                        /* Providing the touch feedback for down event */
                        gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_DOWN);

                        area_ptr->right_arrow_state = MMI_IMUI_ARROW_PRESSED;
                    }
					#if defined(__MMI_IME_CANDIDATE_GRID__)
					 if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_EXPAND)
                    {
                        /* Providing the touch feedback for down event */
                        gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_DOWN);

                        area_ptr->expand_button_state = MMI_IMUI_ARROW_PRESSED;
                    }
					#endif
                    break;
                        
                case MMI_PEN_EVENT_UP:
                    if (area_ptr->left_arrow_state == MMI_IMUI_ARROW_PRESSED)
                    {
                        area_ptr->left_arrow_state = MMI_IMUI_ARROW_NORMAL;
                    }
                    else if (area_ptr->right_arrow_state == MMI_IMUI_ARROW_PRESSED)
                    {
                        area_ptr->right_arrow_state = MMI_IMUI_ARROW_NORMAL;
                    }
					#if defined(__MMI_IME_CANDIDATE_GRID__)
					else if (area_ptr->expand_button_state == MMI_IMUI_ARROW_PRESSED)
                    {
                        area_ptr->expand_button_state = MMI_IMUI_ARROW_NORMAL;
                    }
					#endif
                    break;
                    
                case MMI_PEN_EVENT_MOVE:
                    if (area_ptr->left_arrow_state == MMI_IMUI_ARROW_PRESSED
                        && area_ptr->items_type[i] != MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LEFT_ARROW)
                    {
                        area_ptr->left_arrow_state = MMI_IMUI_ARROW_NORMAL;
                    }

                    if (area_ptr->right_arrow_state == MMI_IMUI_ARROW_PRESSED
                        && area_ptr->items_type[i] != MMI_IMUI_SELECTION_AREA_ITEM_TYPE_RIGHT_ARROW)
                    {
                        area_ptr->right_arrow_state = MMI_IMUI_ARROW_NORMAL;
                    }
					#if defined(__MMI_IME_CANDIDATE_GRID__)
                    if (area_ptr->expand_button_state == MMI_IMUI_ARROW_PRESSED
                        && area_ptr->items_type[i] != MMI_IMUI_SELECTION_AREA_ITEM_TYPE_EXPAND)
                    {
                        area_ptr->expand_button_state = MMI_IMUI_ARROW_NORMAL;
                    }
					#endif
                    break;
                    
                case MMI_PEN_EVENT_ABORT:
                    break;

                case MMI_PEN_EVENT_LONG_TAP:
                    break;
                    
                case MMI_PEN_EVENT_REPEAT:
                    break;
            }

        }
        else if (pen_event == MMI_PEN_EVENT_UP)
        {
            if (area_ptr->left_arrow_state == MMI_IMUI_ARROW_PRESSED)
            {
                area_ptr->left_arrow_state = MMI_IMUI_ARROW_NORMAL;
            }
            else if (area_ptr->right_arrow_state == MMI_IMUI_ARROW_PRESSED)
            {
                area_ptr->right_arrow_state = MMI_IMUI_ARROW_NORMAL;
            }
			#if defined(__MMI_IME_CANDIDATE_GRID__)
			else if (area_ptr->expand_button_state == MMI_IMUI_ARROW_PRESSED)
            {
                area_ptr->expand_button_state = MMI_IMUI_ARROW_NORMAL;
            }
			#endif
        }
    }    
    
    return ret;
}
#if defined(__MMI_IME_CANDIDATE_GRID__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_candidate_grid_area_translate_pen_event
 * DESCRIPTION
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL mmi_imui_candidate_grid_area_translate_pen_event(mmi_imui_selection_area_grid_struct_p area_ptr, 
                                                            mmi_pen_event_type_enum pen_event, S16 x, S16 y,
                                                            mmi_imui_selection_area_grid_pen_event_enum * event)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    S32 i = 0;
    S32 candidate_index = 0;
    S32 temp_x;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if ((POINT_CHECK_BOUND(x, y, area_ptr->x, area_ptr->y, area_ptr->width, area_ptr->height) 
        && pen_event == MMI_PEN_EVENT_DOWN) || pen_event != MMI_PEN_EVENT_DOWN)
    {
        ret = MMI_TRUE;

        for (i = 0; i < area_ptr->item_count; i++)
        {
            if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE)
            {
				  if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                 {
                    mmi_imui_get_r2l_coordinate(area_ptr->items[i].candidate.x,
                                                area_ptr->items[i].candidate.width ,
                                                area_ptr->width- area_ptr->component_width - 1,
                                                &temp_x);
                    
                    if (POINT_CHECK_BOUND(x, y, temp_x + area_ptr->x, 
                                          area_ptr->items[i].candidate.y, 
                                          area_ptr->items[i].candidate.width, area_ptr->items[i].candidate.height))
                    {
                        break;
                    }
                }
				else
				{
               
                 if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].candidate.x + area_ptr->x, 
                                          area_ptr->items[i].candidate.y, 
                                          area_ptr->items[i].candidate.width, area_ptr->items[i].candidate.height))
                 {
                        break;
				 }
				 }
                candidate_index++;
            }
            else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_DELETE)
            {
                    if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].indicator.x, 
                                          area_ptr->items[i].indicator.y  , 
                                          area_ptr->items[i].indicator.width, area_ptr->component_height))
                    {
                        break;
                    }
             }
			else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_UP && 
                         area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_PRE_PAGE)
				
            {
                    if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].indicator.x, 
                                          area_ptr->items[i].indicator.y  , 
                                          area_ptr->items[i].indicator.width, area_ptr->component_height))
                    {
                        break;
                    }
             }
			else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_DOWN &&
				area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE)
            {
                    if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].indicator.x, 
                                          area_ptr->items[i].indicator.y  , 
                                          area_ptr->items[i].indicator.width, area_ptr->component_height))
                    {
                        break;
                    }
             }
			else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_BACK)
            {
                    if (POINT_CHECK_BOUND(x, y, area_ptr->items[i].indicator.x, 
                                          area_ptr->items[i].indicator.y  , 
                                          area_ptr->items[i].indicator.width, area_ptr->component_height))
                    {
                        break;
                    }
             }
           }
        }

        if (i < area_ptr->item_count)
        {
            if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE)
            {
                area_ptr->highlight_index = candidate_index;
                *event = MMI_IMUI_SELECTION_AREA_GRID_PEN_TEXT;
            }
            else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_DELETE)
            {   
              
                    *event = MMI_IMUI_SELECTION_AREA_GRID_PEN_DELETE;
                
            }
            else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_UP)
            {
                    *event = MMI_IMUI_SELECTION_AREA_GRID_PEN_NAVIGATION_UP;
            }
			else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_DOWN)
            {
               
                    *event = MMI_IMUI_SELECTION_AREA_GRID_PEN_NAVIGATION_DOWN;
            }
			else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_BACK)
            {

                    *event = MMI_IMUI_SELECTION_AREA_GRID_PEN_BACK;
            }
            
            switch(pen_event)
            {
                case MMI_PEN_EVENT_DOWN:
                    if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_DELETE)
                    {
                        /* Providing the touch feedback for down event */
                        gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_DOWN);
						area_ptr->backspace_button_state = MMI_IMUI_ARROW_PRESSED;

                    }
                    else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_BACK)
                    {
                        /* Providing the touch feedback for down event */
                        gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_DOWN);
						area_ptr->back_button_state = MMI_IMUI_ARROW_PRESSED;
                    }
					else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_DOWN)
                    {
                        /* Providing the touch feedback for down event */
                        gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_DOWN);

                        area_ptr->down_arrow_state = MMI_IMUI_ARROW_PRESSED;
                    }
					else if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_UP)
                    {
                        /* Providing the touch feedback for down event */
                        gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_DOWN);

                        area_ptr->up_arrow_state = MMI_IMUI_ARROW_PRESSED;
                    }
                    break;
                        
                case MMI_PEN_EVENT_UP:
                    if (area_ptr->down_arrow_state == MMI_IMUI_ARROW_PRESSED)
                    {
                        area_ptr->down_arrow_state = MMI_IMUI_ARROW_NORMAL;
                    }
                    else if (area_ptr->up_arrow_state == MMI_IMUI_ARROW_PRESSED)
                    {
                        area_ptr->up_arrow_state = MMI_IMUI_ARROW_NORMAL;
                    }
					else if (area_ptr->backspace_button_state == MMI_IMUI_ARROW_PRESSED)
                    {
                        area_ptr->backspace_button_state = MMI_IMUI_ARROW_NORMAL;
                    }
					else if (area_ptr->back_button_state == MMI_IMUI_ARROW_PRESSED)
                    {
                        area_ptr->back_button_state = MMI_IMUI_ARROW_NORMAL;
                    }
                    break;
                    
                case MMI_PEN_EVENT_MOVE:
                    if (area_ptr->up_arrow_state == MMI_IMUI_ARROW_PRESSED
                        && area_ptr->items_type[i] != MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_UP)
                    {
                        area_ptr->up_arrow_state = MMI_IMUI_ARROW_NORMAL;
                    }

                    if (area_ptr->down_arrow_state == MMI_IMUI_ARROW_PRESSED
                        && area_ptr->items_type[i] != MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_DOWN)
                    {
                        area_ptr->down_arrow_state = MMI_IMUI_ARROW_NORMAL;
                    }

					if (area_ptr->backspace_button_state == MMI_IMUI_ARROW_PRESSED
                        && area_ptr->items_type[i] != MMI_IMUI_SELECTION_AREA_ITEM_TYPE_DELETE)
                    {
                        area_ptr->backspace_button_state = MMI_IMUI_ARROW_NORMAL;
                    }
					if (area_ptr->back_button_state == MMI_IMUI_ARROW_PRESSED
                        && area_ptr->items_type[i] != MMI_IMUI_SELECTION_AREA_ITEM_TYPE_BACK)
                    {
                        area_ptr->back_button_state = MMI_IMUI_ARROW_NORMAL;
                    }
                    
                    break;

                case MMI_PEN_EVENT_ABORT:
                    break;

                case MMI_PEN_EVENT_LONG_TAP:
                    break;
                    
                case MMI_PEN_EVENT_REPEAT:
                    break;
            }

        }
        else if (pen_event == MMI_PEN_EVENT_UP)
        {
            if (area_ptr->down_arrow_state == MMI_IMUI_ARROW_PRESSED)
            {
                area_ptr->down_arrow_state = MMI_IMUI_ARROW_NORMAL;
            }
            else if (area_ptr->up_arrow_state == MMI_IMUI_ARROW_PRESSED)
            {
                area_ptr->up_arrow_state = MMI_IMUI_ARROW_NORMAL;
            }
			else if (area_ptr->backspace_button_state == MMI_IMUI_ARROW_PRESSED)
            {
                area_ptr->backspace_button_state = MMI_IMUI_ARROW_NORMAL;
            }
			else if (area_ptr->back_button_state == MMI_IMUI_ARROW_PRESSED)
            {
                area_ptr->back_button_state = MMI_IMUI_ARROW_NORMAL;
            }
        }


    return ret;
}
#endif
#ifdef __MMI_CLIPBOARD_FLOATING_MENU__

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_clipboard_floating_menu_set_highlight
 * DESCRIPTION
 * 
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_clipboard_floating_menu_set_highlight(mmi_imui_clipboard_floating_menu_struct_p area_ptr, U8 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    area_ptr->highlight_index = index;

    mmi_imc_redraw_screen_by_state();    
    /* Redraw menu */
   // mmi_imui_show_clipboard_floating_menu(&g_imui_clipboard_floating_menu);

    MMI_ASSERT(/*(index >= 0) && */(index <= (area_ptr->menu_item_cnt + 1)));
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_clipboard_floating_menu_handler
 * DESCRIPTION
 * 
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_clipboard_floating_menu_handler(mmi_imui_clipboard_floating_menu_type_enum type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_imc_clipboard_ret_enum clipboard_ret = MMI_IMC_CLIPBOARD_RET_NONE;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if(UI_DOUBLE_BUFFER_SUPPORT)
    gui_lock_double_buffer();
#endif
    switch (type)
    {
    case MMI_IMUI_CLIPBOARD_FLOATING_MENU_ITEM_TYPE_COPY:
        clipboard_ret = mmi_imc_clipboard_copy();
        break;
    case MMI_IMUI_CLIPBOARD_FLOATING_MENU_ITEM_TYPE_COPY_ALL:
        clipboard_ret = mmi_imc_clipboard_copy_all();
        break;
    case MMI_IMUI_CLIPBOARD_FLOATING_MENU_ITEM_TYPE_CUT:
        clipboard_ret = mmi_imc_clipboard_cut();
        break;
    case MMI_IMUI_CLIPBOARD_FLOATING_MENU_ITEM_TYPE_CUT_ALL:
        clipboard_ret = mmi_imc_clipboard_cut_all();
        break;
    case MMI_IMUI_CLIPBOARD_FLOATING_MENU_ITEM_TYPE_PASTE:
        clipboard_ret = mmi_imc_clipboard_paste();
        break;
    default:
        MMI_ASSERT(0);
    }
#if(UI_DOUBLE_BUFFER_SUPPORT)
    gui_unlock_double_buffer();
#endif

    mmi_imc_clipboard_go_back_to_initial();

    /* Popup notification only needed */
    if (clipboard_ret == MMI_IMC_CLIPBOARD_RET_MEMORY_NOT_ENOUGH)
    {
        mmi_popup_display((WCHAR*)GetString(STR_ID_CLIPBOARD_TRUNCATE_FOR_MEMORY), MMI_EVENT_INFO, NULL);
    }
    else if (clipboard_ret == MMI_IMC_CLIPBOARD_RET_CUT_UNSUPPRT_CONTENT)
    {
        mmi_popup_display((WCHAR*)GetString(STR_ID_CLIPBOARD_CUT_UNSUPPORT_CONTENT), MMI_EVENT_INFO, NULL);
    }
    else if (clipboard_ret == MMI_IMC_CLIPBOARD_RET_MEMORY_ERROR)
    {
        mmi_popup_display((WCHAR*)GetString(STR_GLOBAL_NOT_ENOUGH_MEMORY), MMI_EVENT_FAILURE, NULL);
    }

    MMI_TRACE(MMI_FW_TRC_G5_IME, TRC_MMI_CLIPBOARD_CCP_OPTION_HANDLE_END, clipboard_ret);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_clipboard_floating_menu_translate_pen_event
 * DESCRIPTION
 * 
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL mmi_imui_clipboard_floating_menu_translate_pen_event(
           mmi_imui_clipboard_floating_menu_struct_p area_ptr, 
           mmi_pen_event_type_enum pen_event,
           S16 x,
           S16 y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    U8 i = 0;
    gui_button_pen_enum button_event;
    static U8 pen_down_button = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if ((POINT_CHECK_BOUND(x, y, area_ptr->x, area_ptr->y, area_ptr->width, area_ptr->height) 
        && pen_event == MMI_PEN_EVENT_DOWN) || pen_event != MMI_PEN_EVENT_DOWN)
    {
        for (i = 0; i < area_ptr->menu_item_cnt; i++)
        {
            ret = gui_text_button_translate_pen_event(&area_ptr->menu_item[i].button, pen_event, x, y, &button_event);

            if (pen_event == MMI_PEN_EVENT_DOWN)
            {
                /* Response menu item handler */
                if (ret)
                {
                    pen_down_button = i + 1;
                    /* Providing the touch feedback for down event */
                    //gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_DOWN);
                    mmi_imui_clipboard_floating_menu_set_highlight(area_ptr, (U8)(i + 1));
                    break;
                }
            }
            else if (pen_event == MMI_PEN_EVENT_UP)
            {
                /* Response menu item handler */
                if (GUI_BUTTON_PEN_UP_INSIDE == button_event && (pen_down_button == (i + 1)))
                {
                    mmi_imui_clipboard_floating_menu_handler(area_ptr->menu_item[i].button_type);
                    break;
                }
            }
            else if (pen_event == MMI_PEN_EVENT_MOVE)
            {
                /* Response pen move event */
            }
        }
    
        /* If pen up outside button area */
        if ((pen_event == MMI_PEN_EVENT_UP) && 
            ((GUI_BUTTON_PEN_UP_INSIDE != button_event) || (pen_down_button != (i + 1))))
        {
            mmi_imui_clipboard_floating_menu_set_highlight(area_ptr, 0);
        }
    }
    else
    {
        /* Play touch feedback when cancel the clipbaord state */
        //gui_touch_feedback_play(GUI_TOUCH_FEEDBACK_DOWN);
        mmi_imc_clipboard_go_back_to_initial();
    }

    return MMI_TRUE;
}

#endif /* __MMI_CLIPBOARD_FLOATING_MENU__ */

#ifdef MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_backup_and_set_blt_layer
 * DESCRIPTION
 *  Backup the current layer and set stroke layer to limit the maximum layer 
 *  count to 2 (in some platforms such as MT6223)
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_backup_and_set_blt_layer(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    gdi_handle tmp_layer_3, tmp_layer_4;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_imui_hand_writing_stroke_handle == GDI_ERROR_HANDLE)
    {    
        MMI_ASSERT(!g_imui_hand_writing_blt_layer_switched);
    
        g_imui_stroke_GDI_buffer = (U8*) mmi_frm_scrmem_alloc_framebuffer(handwriting_stroke_layer_mem);
        MMI_ASSERT(g_imui_stroke_GDI_buffer);

        /* Use native GDI layer API instead of draw manager API to control blt layers directly */
        if (GDI_LAYER_SUCCEED != gdi_layer_create_using_outside_memory(
                                    0,
                                    0,
                                    UI_device_width,
                                    UI_device_height,
                                    &g_imui_hand_writing_stroke_handle,
                                    (U8*) g_imui_stroke_GDI_buffer,
                                    handwriting_stroke_layer_mem))
        {
            MMI_ASSERT(0);
        }
    }

    if (!g_imui_hand_writing_blt_layer_switched)
    {
        gdi_layer_get_blt_layer(
            &g_imui_hand_writing_GDI_original_handle1, 
            &g_imui_hand_writing_GDI_original_handle2, 
            &tmp_layer_3,
            &tmp_layer_4);

        gdi_layer_push_and_set_active(g_imui_hand_writing_stroke_handle);                        

        /* Set source key for layer flattening */
        gdi_layer_set_source_key(TRUE, GDI_COLOR_TRANSPARENT);

        /* copy the display content from scr_bg & base layer to stroke layer*/        
        gdi_layer_flatten(
            g_imui_hand_writing_GDI_original_handle1, 
            g_imui_hand_writing_GDI_original_handle2,
            tmp_layer_3,
            tmp_layer_4);

        /* Set current active layer to the stroke layer only */
        gdi_layer_set_blt_layer(g_imui_hand_writing_stroke_handle, GDI_ERROR_HANDLE, GDI_ERROR_HANDLE, GDI_ERROR_HANDLE);

        /* Note: active layer != BLT layers because other UI component like softkey 
           may redraw itself in the current active layer. 
           As a result, they are redrawn in the base layer */
        gdi_layer_pop_and_restore_active();

        g_imui_hand_writing_blt_layer_switched = MMI_TRUE;
    }
}

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_restore_blt_layer
 * DESCRIPTION
 *  Restore the original editor layer configurations
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_restore_blt_layer(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_imui_hand_writing_blt_layer_switched)
    {
        gdi_layer_set_blt_layer(g_imui_hand_writing_GDI_original_handle1, g_imui_hand_writing_GDI_original_handle2, GDI_ERROR_HANDLE, GDI_ERROR_HANDLE);
        g_imui_hand_writing_blt_layer_switched = MMI_FALSE;
    }
}

#endif /* MMI_IMUI_HANDWRITING_STROKE_ON_2_LAYER */

#endif /*defined(__MMI_TOUCH_SCREEN__)*/


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_arrow
 * DESCRIPTION
 *  Darw the arrows for the composition box or the candidate box
 * PARAMETERS
 *  x                   [IN]        x coordinate
 *  y                   [IN]        y coordinate
 *  arrow_direction     [IN]        The direction of the arrow. Now we only support MMI_IMUI_ARROW_DIRECTION_RIGHT and MMI_IMUI_ARROW_DIRECTION_LEFT
 *  arrow_state         [IN]        The state of the arrow. MMI_IMUI_ARROW_DISABLE, MMI_IMUI_ARROW_PRESS_DOWN, and MMI_IMUI_ARROW_PRESS_UP
 *  arrow_type          [IN]        The arrow is for the composition box and the candidate box. MMI_IMUI_ARROW_FOR_CANDIDATE and MMI_IMUI_ARROW_FOR_COMPOSITION
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_arrow(
        S32 x, S32 y, mmi_imui_arrow_direction_enum arrow_direction,
        mmi_imui_arrow_state_enum arrow_state)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 direction = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (MMI_IMUI_ARROW_DIRECTION_RIGHT == arrow_direction)
    {
        direction = 1;

        if (MMI_IMUI_ARROW_PRESSED == arrow_state)
        {
            x++;
            y++;
        }
    }
    else if (MMI_IMUI_ARROW_DIRECTION_LEFT == arrow_direction)
    {
        direction = 0;

        if (MMI_IMUI_ARROW_PRESSED == arrow_state)
        {
            x--;
            y++;
        }
    }

    if (arrow_state == MMI_IMUI_ARROW_DISABLE)
    {
        draw_resizeable_arrow(x, y, direction, g_imui_ui_theme.arrow_disable_color, g_imui_ui_param.arrow_width, g_imui_ui_param.arrow_height);
    }
    else if (arrow_state == MMI_IMUI_ARROW_PRESSED)
    {
        draw_resizeable_arrow(x, y, direction, g_imui_ui_theme.arrow_down_color, g_imui_ui_param.arrow_width, g_imui_ui_param.arrow_height);
    }
    else if (arrow_state == MMI_IMUI_ARROW_NORMAL)
    {
        draw_resizeable_arrow(x, y, direction, g_imui_ui_theme.arrow_up_color, g_imui_ui_param.arrow_width, g_imui_ui_param.arrow_height);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_selection_area_draw_arrow
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static void mmi_imui_selection_area_draw_arrow(
        mmi_imui_selection_area_struct_p area_ptr,
        S32 x, S32 y, mmi_imui_arrow_direction_enum arrow_direction,
        mmi_imui_arrow_state_enum arrow_state)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if defined(__MMI_IME_FTE_ENHANCE__)
    PU8 arrow_img_ptr = NULL;
//    gdi_handle old_src_layer,act_layer;
#endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_IME_FTE_ENHANCE__)
    if (MMI_IMUI_ARROW_DIRECTION_RIGHT == arrow_direction)
    {
        if (arrow_state == MMI_IMUI_ARROW_DISABLE)
        {
            arrow_img_ptr = area_ptr->cand_right_arrow_disable;
        }
        else if (arrow_state == MMI_IMUI_ARROW_PRESSED)
        {
            arrow_img_ptr = area_ptr->cand_right_arrow_down;
        }
        else if (arrow_state == MMI_IMUI_ARROW_NORMAL)
        {
            arrow_img_ptr = area_ptr->cand_right_arrow_up;
        }
    }
    else if (MMI_IMUI_ARROW_DIRECTION_LEFT == arrow_direction)
    {
        if (arrow_state == MMI_IMUI_ARROW_DISABLE)
        {
            arrow_img_ptr = area_ptr->cand_left_arrow_disable;
        }
        else if (arrow_state == MMI_IMUI_ARROW_PRESSED)
        {
            arrow_img_ptr = area_ptr->cand_left_arrow_down;
        }
        else if (arrow_state == MMI_IMUI_ARROW_NORMAL)
        {
            arrow_img_ptr = area_ptr->cand_left_arrow_up;
        }
    }

    if (arrow_img_ptr)
    {
        gdi_image_draw_blend2layers(x, y, arrow_img_ptr);
    }
#else

    mmi_imui_draw_arrow(x, y, arrow_direction, arrow_state);

#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */
}
#if defined(__MMI_IME_CANDIDATE_GRID__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_candidate_grid_draw_navigation_keys
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static void mmi_imui_candidate_grid_draw_navigation_up(
        mmi_imui_selection_area_struct_p area_ptr,
        S32 x, S32 y, mmi_imui_arrow_direction_enum arrow_direction,
        mmi_imui_arrow_state_enum arrow_state)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if defined(__MMI_IME_FTE_ENHANCE__)
    PU8 arrow_img_ptr = NULL;
//    gdi_handle old_src_layer,act_layer;
#endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_IME_FTE_ENHANCE__)
    if (MMI_IMUI_ARROW_DIRECTION_RIGHT == arrow_direction)
    {
        if (arrow_state == MMI_IMUI_ARROW_DISABLE)
        {
            arrow_img_ptr = area_ptr->cand_right_arrow_disable;
        }
        else if (arrow_state == MMI_IMUI_ARROW_PRESSED)
        {
            arrow_img_ptr = area_ptr->cand_right_arrow_down;
        }
        else if (arrow_state == MMI_IMUI_ARROW_NORMAL)
        {
            arrow_img_ptr = area_ptr->cand_right_arrow_up;
        }
    }
    else if (MMI_IMUI_ARROW_DIRECTION_LEFT == arrow_direction)
    {
        if (arrow_state == MMI_IMUI_ARROW_DISABLE)
        {
            arrow_img_ptr = area_ptr->cand_left_arrow_disable;
        }
        else if (arrow_state == MMI_IMUI_ARROW_PRESSED)
        {
            arrow_img_ptr = area_ptr->cand_left_arrow_down;
        }
        else if (arrow_state == MMI_IMUI_ARROW_NORMAL)
        {
            arrow_img_ptr = area_ptr->cand_left_arrow_up;
        }
    }

    if (arrow_img_ptr)
    {
        gdi_image_draw_blend2layers(x, y, arrow_img_ptr);
    }
#else

    mmi_imui_draw_arrow(x, y, arrow_direction, arrow_state);

#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */
}
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_candidate_box_area_grid
 * DESCRIPTION
 *  Draw candidate box grid
 * PARAMETERS
 *  bottom_line     [IN]       The y of bottom line for candidate box grid
 * RETURNS
 *  The bottom line for next control
 *****************************************************************************/
static S32 mmi_imui_draw_candidate_box_area_grid(S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    S32 bottom = (bottom_line - (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box_grid.height));
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_GRID_AREA] = bottom_line;
	if(g_imui_is_down_in_grid == MMI_FALSE)
	{
		//optimization to improve performance
    mmi_imui_draw_back_ground(g_imui_ui_param.imui_left, 
                              bottom_line - (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + 
                              MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box_grid.height) + 1,
                              g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
                              bottom_line);
	}

    g_imui_candidate_box_grid.x = g_imui_ui_param.imui_left;
        
    g_imui_candidate_box_grid.y = bottom_line -  g_imui_candidate_box_grid.height + 1;

    mmi_imui_show_selection_area_grid(&g_imui_candidate_box_grid);

    return bottom;
}
#endif
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_candidate_box_area
 * DESCRIPTION
 *  Draw candidate box
 * PARAMETERS
 *  bottom_line     [IN]       The y of bottom line for candidate box
 * RETURNS
 *  The bottom line for next control
 *****************************************************************************/
static S32 mmi_imui_draw_candidate_box_area(S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if defined(__MMI_WALLPAPER_ON_BOTTOM__) && !defined(__MMI_IME_FTE_ENHANCE__)
    gdi_handle old_src_layer,act_layer;
#endif /*defined(__MMI_WALLPAPER_ON_BOTTOM__)*/
#if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
    S32 bk_comp_bottom_y = 0;
    mmi_imui_resizable_composition_area_struct bk_comp;
    mmi_imc_rect clip_rect;
#endif
    S32 bottom = (bottom_line - (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height));
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	
    g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA] = bottom_line;
    
#if defined(__MMI_WALLPAPER_ON_BOTTOM__) && !defined(__MMI_IME_FTE_ENHANCE__)
    if (!wgui_is_wallpaper_on_bottom())
	{
        gdi_image_abm_get_source_layer(&old_src_layer);
        gdi_layer_get_active(&act_layer);
        gdi_image_abm_set_source_layer(act_layer);
	}
#endif /*#if defined(__MMI_WALLPAPER_ON_BOTTOM__) && !defined(__MMI_IME_FTE_ENHANCE__)*/

#if defined(__MMI_IME_FLOATING_CAND_BOX__)
    if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
    {
    
        g_imui_candidate_box.x = g_imui_ui_param.imui_floating_left + MMI_IMUI_CANDIDATE_BOX_LEFT_GAP;
        
        g_imui_candidate_box.y = bottom_line - (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + g_imui_candidate_box.height) + 1;

    #if defined(__MMI_VUI_ENGINE__)
        if (vadp_p2v_uc_is_in_venus())
        {
            mmi_imui_draw_back_ground(g_imui_ui_param.imui_floating_left, 
                                  bottom_line - (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + 
                                  MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height) + 1,
                                  g_imui_ui_param.imui_floating_left + g_imui_ui_param.imui_floating_width - 1,
                                  bottom_line);
        }
    #endif
    
    #if defined(__MMI_IME_FTE_ENHANCE__)
	    clip_rect.x = g_imui_ui_param.imui_floating_left;
        clip_rect.y = bottom_line - (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height) + 1;
        clip_rect.width = g_imui_candidate_box.width;
        clip_rect.height = MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height;
    #endif
    }
    else
#endif /* #if defined(__MMI_IME_FLOATING_CAND_BOX__) */
    {
        mmi_imui_draw_back_ground(g_imui_ui_param.imui_left, 
                              bottom_line - (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + 
                              MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height) + 1,
                              g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
                              bottom_line);
    
        g_imui_candidate_box.x = g_imui_ui_param.imui_left + MMI_IMUI_CANDIDATE_BOX_LEFT_GAP;
        
        g_imui_candidate_box.y = bottom_line - (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + g_imui_candidate_box.height) + 1;

    #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
	    clip_rect.x = g_imui_ui_param.imui_left;
        clip_rect.y = bottom_line - (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height) + 1;
        clip_rect.width = g_imui_ui_param.imui_width;
        clip_rect.height = MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height;
    #endif
    }

#if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
        /* Draw the covered resizable composition area */
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
            (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE))
	    {
            /* 
             * The bottom maybe not the right bottom, because it should be another value in Venus 
             * So we should resume the previous value
             */
            bk_comp_bottom_y = g_imui_control_set.control_bottoms[MMI_IMUI_COMPOSITION_AREA];
        
            memcpy(&bk_comp, &g_imui_resizable_composition_box, sizeof(mmi_imui_resizable_composition_area_struct));

    	    gui_push_clip();
	        gui_set_clip(clip_rect.x, 
                clip_rect.y, 
                clip_rect.x + clip_rect.width - 1, 
                clip_rect.y + clip_rect.height - 1);
            
            mmi_imui_draw_resizable_composition_area(bottom);

            gui_pop_clip();

            memcpy(&g_imui_resizable_composition_box, &bk_comp, sizeof(mmi_imui_resizable_composition_area_struct));
        
            g_imui_control_set.control_bottoms[MMI_IMUI_COMPOSITION_AREA] = bk_comp_bottom_y;
        }
#endif  /* #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__) */

	if (!(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_RESERVE))
	{
        mmi_imui_show_selection_area(&g_imui_candidate_box);
	}

#if defined(__MMI_WALLPAPER_ON_BOTTOM__) && !defined(__MMI_IME_FTE_ENHANCE__)
    if (!wgui_is_wallpaper_on_bottom())
	{
        gdi_image_abm_set_source_layer(old_src_layer);
	}
#endif /*#if defined(__MMI_WALLPAPER_ON_BOTTOM__) && !defined(__MMI_IME_FTE_ENHANCE__)*/
	
    return bottom;
}


#ifdef __MMI_CLIPBOARD_FLOATING_MENU__

#define MMI_IMUI_CCP_MAX_THEME_BG            8

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_clipboard_floating_menu_background
 * DESCRIPTION
 *  draw clipboard floating menu background
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_clipboard_floating_menu_background(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 x = 0;
    U32 arrow_offset_to_x = 0;
    U8 i;
    U16 image_id_n, image_id_h;
    U8 cnt = 0;
	PU8 ccp_fm_bg[MMI_IMUI_CCP_MAX_THEME_BG];
    S32 arrowImgWidth, arrowImgHeight;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_push_clip();
    gui_set_clip(
        g_imui_clipboard_floating_menu.x,
        g_imui_clipboard_floating_menu.y,
        g_imui_clipboard_floating_menu.x + g_imui_clipboard_floating_menu.width - 1,
        g_imui_clipboard_floating_menu.y + g_imui_clipboard_floating_menu.height - 1);

    /* Prepare bg theme array */
    ccp_fm_bg[cnt++] = current_MMI_theme->clipboard_floating_menu_2_menu_left_button_pressed_bg;
    ccp_fm_bg[cnt++] = current_MMI_theme->clipboard_floating_menu_2_menu_left_button_normal_bg;
    ccp_fm_bg[cnt++] = current_MMI_theme->clipboard_floating_menu_3_menu_middle_button_pressed_bg;
    ccp_fm_bg[cnt++] = current_MMI_theme->clipboard_floating_menu_3_menu_middle_button_normal_bg;
    ccp_fm_bg[cnt++] = current_MMI_theme->clipboard_floating_menu_2_menu_right_button_pressed_bg;
    ccp_fm_bg[cnt++] = current_MMI_theme->clipboard_floating_menu_2_menu_right_button_normal_bg;
    ccp_fm_bg[cnt++] = current_MMI_theme->clipboard_floating_menu_1_menu_button_pressed_bg;
    ccp_fm_bg[cnt++] = current_MMI_theme->clipboard_floating_menu_1_menu_button_normal_bg;
    
    MMI_ASSERT(cnt <= MMI_IMUI_CCP_MAX_THEME_BG);

    /* Draw Button background */
    x = g_imui_clipboard_floating_menu.x;
    if (g_imui_clipboard_floating_menu.menu_item_cnt == 1)
    {
        image_id_h = 6;
        image_id_n = 7;
    }
    else
    {
        image_id_h = 0;
        image_id_n = 1;
    }
    for (i = 0; i < g_imui_clipboard_floating_menu.menu_item_cnt; i++)
    {
        if (g_imui_clipboard_floating_menu.highlight_index == (i + 1))
        {
            gdi_image_draw_resized_blend2layers(
                x,
                g_imui_clipboard_floating_menu.y,
                g_imui_clipboard_floating_menu.menu_item[i].button.width,
                g_imui_clipboard_floating_menu.menu_item[i].button.height,
                ccp_fm_bg[image_id_h]);
        }
        else
        {
            gdi_image_draw_resized_blend2layers(
                x,
                g_imui_clipboard_floating_menu.y,
                g_imui_clipboard_floating_menu.menu_item[i].button.width,
                g_imui_clipboard_floating_menu.menu_item[i].button.height,
                ccp_fm_bg[image_id_n]);
        }
        x += g_imui_clipboard_floating_menu.menu_item[i].button.width;
        if (g_imui_clipboard_floating_menu.menu_item_cnt == 2)
        {
            image_id_n += 4;
            image_id_h += 4;
        }
        else
        {
            image_id_n += 2;
            image_id_h += 2;
        }
    }

    gui_pop_clip();

    /* Draw arrow */
    gui_push_clip();
    if (g_imui_clipboard_floating_menu.direction == MMI_IMUI_CCP_FM_UP)
    {
        gui_set_clip(
            g_imui_clipboard_floating_menu.x,
            g_imui_clipboard_floating_menu.y,
            g_imui_clipboard_floating_menu.x + g_imui_clipboard_floating_menu.width - 1,
            g_imui_clipboard_floating_menu.y + g_imui_clipboard_floating_menu.height - 1 + MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_VIS_HEIGHT);
    }
    else
    {
        gui_set_clip(
            g_imui_clipboard_floating_menu.x,
            g_imui_clipboard_floating_menu.y - MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_VIS_HEIGHT,
            g_imui_clipboard_floating_menu.x + g_imui_clipboard_floating_menu.width - 1,
            g_imui_clipboard_floating_menu.y + g_imui_clipboard_floating_menu.height - 1);
    }

    switch (g_imui_clipboard_floating_menu.menu_item_cnt)
    {
    case 1:
        arrow_offset_to_x = g_imui_clipboard_floating_menu.menu_item[0].button.width / 2;
        break;
    case 2:
        if (g_imui_clipboard_floating_menu.arrow_index == 0)
        {
            arrow_offset_to_x = g_imui_clipboard_floating_menu.menu_item[0].button.width / 2;
        }
        else
        {
            arrow_offset_to_x = g_imui_clipboard_floating_menu.menu_item[0].button.width + g_imui_clipboard_floating_menu.menu_item[1].button.width / 2;
        }
        break;
    case 3:
        if (g_imui_clipboard_floating_menu.arrow_index == 0)
        {
            arrow_offset_to_x = g_imui_clipboard_floating_menu.menu_item[0].button.width / 2;
        }
        else if (g_imui_clipboard_floating_menu.arrow_index == 1)
        {
            arrow_offset_to_x = g_imui_clipboard_floating_menu.menu_item[0].button.width + g_imui_clipboard_floating_menu.menu_item[1].button.width / 2;
        }
        else
        {
            arrow_offset_to_x = g_imui_clipboard_floating_menu.width - (g_imui_clipboard_floating_menu.menu_item[2].button.width / 2);
        }
        break;
    default:
        MMI_ASSERT(0);
        break;
    }

    gdi_image_get_dimension(
        //GDI_IMAGE_TYPE_PNG,
        current_MMI_theme->clipboard_floating_menu_down_arrow_button_pressed_bg_image,
        //0,
        &arrowImgWidth,
        &arrowImgHeight);
    if (g_imui_clipboard_floating_menu.highlight_index == (g_imui_clipboard_floating_menu.arrow_index + 1))
    {
        if (g_imui_clipboard_floating_menu.direction == MMI_IMUI_CCP_FM_UP)
        {
            gdi_image_draw_blend2layers(
                g_imui_clipboard_floating_menu.x + arrow_offset_to_x - arrowImgWidth / 2,
                g_imui_clipboard_floating_menu.y + MMI_IMUI_CLIPBOARD_FLOATING_MENU_HEIGHT - MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_OVERLAP,
                current_MMI_theme->clipboard_floating_menu_down_arrow_button_pressed_bg_image);
        }
        else
        {
            gdi_image_draw_blend2layers(
                g_imui_clipboard_floating_menu.x + arrow_offset_to_x - arrowImgWidth / 2,
                g_imui_clipboard_floating_menu.y - MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_HEIGHT + MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_OVERLAP,
                current_MMI_theme->clipboard_floating_menu_up_arrow_button_pressed_bg_image);
        }
    }
    else
    {
        if (g_imui_clipboard_floating_menu.direction == MMI_IMUI_CCP_FM_UP)
        {
            gdi_image_draw_blend2layers(
                g_imui_clipboard_floating_menu.x + arrow_offset_to_x - arrowImgWidth / 2,
                g_imui_clipboard_floating_menu.y + MMI_IMUI_CLIPBOARD_FLOATING_MENU_HEIGHT - MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_OVERLAP,
                current_MMI_theme->clipboard_floating_menu_down_arrow_button_normal_bg_image);
        }
        else
        {
            gdi_image_draw_blend2layers(
                g_imui_clipboard_floating_menu.x + arrow_offset_to_x - arrowImgWidth / 2,
                g_imui_clipboard_floating_menu.y - MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_HEIGHT + MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_OVERLAP,
                current_MMI_theme->clipboard_floating_menu_up_arrow_button_normal_bg_image);
        }
    }

    gui_pop_clip();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_show_clipboard_floating_menu
 * DESCRIPTION
 *  Draw floating menu
 * PARAMETERS
 *  area_ptr       [IN]     Pointer to clipboard floating menu structure
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_show_clipboard_floating_menu(mmi_imui_clipboard_floating_menu_struct_p area_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Draw background */
    mmi_imui_draw_clipboard_floating_menu_background();

    /* Draw menu item */
    for (i = 0; i < area_ptr->menu_item_cnt; i++)
    {
        gui_show_text_button(&(area_ptr->menu_item[i].button));
    }

#if defined(__MMI_VUI_ENGINE__)
    if (!vadp_p2v_uc_is_in_venus())
#endif
    {
        gdi_lcd_repaint_all();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_clipboard_floating_button_arrow_x
 * DESCRIPTION
 *  Get button arrow x position. The position is the middle x of button
 * PARAMETERS
 *  x            [IN]       menu x
 *  index        [IN]       button index
 * RETURNS
 *  S32
 *****************************************************************************/
static S32 mmi_imui_get_clipboard_floating_button_arrow_x(S32 x, U8 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i = 0;
    S32 arrow_x = x;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < index; i++)
    {
        arrow_x += g_imui_clipboard_floating_menu.menu_item[i].button.width;
    }

    arrow_x += g_imui_clipboard_floating_menu.menu_item[i].button.width / 2;

    return arrow_x;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_adjust_clipboard_floating_menu_arrow_index
 * DESCRIPTION
 *  Adjust arrow index by x position, make sure the arrow point to nearest button
 * PARAMETERS
 *  x            [IN]       menu x
 *  arrow_x      [IN]       arrow x position
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_adjust_clipboard_floating_menu_arrow_index(S32 x, S32 arrow_x)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 i = 0;
    S32 btn_arrow_x[MMI_IMUI_CLIPBOARD_FOLATING_MENU_NUM];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < g_imui_clipboard_floating_menu.menu_item_cnt; i++)
    {
        btn_arrow_x[i] = mmi_imui_get_clipboard_floating_button_arrow_x(x, i);
    }

    switch (g_imui_clipboard_floating_menu.menu_item_cnt)
    {
    case 1:
        g_imui_clipboard_floating_menu.arrow_index = 0;
        break;
    case 2:
        if (abs(arrow_x - btn_arrow_x[0]) < abs(arrow_x - btn_arrow_x[1]))
        {
            g_imui_clipboard_floating_menu.arrow_index = 0;
        }
        else
        {
            g_imui_clipboard_floating_menu.arrow_index = 1;
        }
        break;
    case 3:
        if (IMUI_MIN3(abs(arrow_x - btn_arrow_x[0]), abs(arrow_x - btn_arrow_x[1]), abs(arrow_x - btn_arrow_x[2])) == abs(arrow_x - btn_arrow_x[0]))
        {
            g_imui_clipboard_floating_menu.arrow_index = 0;
        }
        else if (IMUI_MIN3(abs(arrow_x - btn_arrow_x[0]), abs(arrow_x - btn_arrow_x[1]), abs(arrow_x - btn_arrow_x[2])) == abs(arrow_x - btn_arrow_x[1]))
        {
            g_imui_clipboard_floating_menu.arrow_index = 1;
        }
        else
        {
            g_imui_clipboard_floating_menu.arrow_index = 2;
        }
        break;
    default:
        break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_clipboard_floating_menu
 * DESCRIPTION
 *  Draw candidate box
 * PARAMETERS
 *  bottom_line     [IN]       The y of bottom line for candidate box
 * RETURNS
 *  The bottom line for next control
 *****************************************************************************/
static S32 mmi_imui_draw_clipboard_floating_menu(S32 x, S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 bottom = (bottom_line - (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height));

    S32 x1, y1, i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    StopTimer(BLINKING_CURSOR);

    g_imui_control_set.control_bottoms[MMI_IMUI_CLIPBOARD_FLOATING_MENU] = bottom_line;

    x1 = x;
    if (g_imui_clipboard_floating_menu.direction == MMI_IMUI_CCP_FM_UP)
    {
        y1 = bottom_line - (MMI_IMUI_CLIPBOARD_FLOATING_MENU_HEIGHT + MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_HEIGHT - MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_OVERLAP);
    }
    else
    {
        y1 = bottom_line + MMI_IMUI_CLIPBOARD_FLOATING_MENU_HIGHLIGHT_HEIGHT + MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_HEIGHT - MMI_IMUI_CLIPBOARD_FLOATING_MENU_ARROW_OVERLAP;
    }

    g_imui_clipboard_floating_menu.x = x1;
    g_imui_clipboard_floating_menu.y = y1;

    /* Move menu */
    for (i = 0; i < g_imui_clipboard_floating_menu.menu_item_cnt; i++)
    {
        g_imui_clipboard_floating_menu.menu_item[i].button.x = x1;
        g_imui_clipboard_floating_menu.menu_item[i].button.y = y1;
        x1 += g_imui_clipboard_floating_menu.menu_item[i].button.width;
    }
    mmi_imui_show_clipboard_floating_menu(&g_imui_clipboard_floating_menu);
	
    return bottom;
}

#ifdef __MMI_VECTOR_FONT_SUPPORT__
static stFontAttribute s_ccp_fm_btnFont;
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_clipboard_floating_menu
 * DESCRIPTION
 * 
 * PARAMETERS
 * 
 * RETURNS
 *  void
 *****************************************************************************/
S32 mmi_imui_create_clipboard_floating_menu_item(mmi_imui_update_clipboard_floating_menu_struct_p menu, S32 count, S32 x, S32 y)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 i;
    U16 item_string_id = 0;
    S32 offset = 0, width, height;
    U8 text_gap = 0;
    U8 btn_text_width[MMI_IMUI_CLIPBOARD_FOLATING_MENU_NUM];
    U8 btn_width;

    UI_text_button_theme clipboard_floating_menu_button_t = {
        {255, 255, 255, 100},
        {255, 255, 255, 100},
        {255, 255, 255, 100},
        {255, 255, 255, 100},
        {255, 255, 255, 100},
        {255, 255, 255, 100},
        {255, 255, 255, 100},
        {255, 255, 255, 100},
#ifdef __MMI_MAINLCD_480X800__
        &MMI_medium_font,
#else
        &MMI_small_font,
#endif
        (UI_BUTTON_CENTER_TEXT_X | UI_BUTTON_CENTER_TEXT_Y)
    };
    
    UI_button_theme clipboard_floating_menu_button_bg_t = {
        NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
    };

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    clipboard_floating_menu_button_t.normal_up_text_color = *(current_MMI_theme->clipboard_floating_menu_text_color);
    clipboard_floating_menu_button_t.normal_down_text_color = *(current_MMI_theme->clipboard_floating_menu_text_color);
    clipboard_floating_menu_button_t.disabled_up_text_color = *(current_MMI_theme->clipboard_floating_menu_text_color);
    clipboard_floating_menu_button_t.disabled_down_text_color = *(current_MMI_theme->clipboard_floating_menu_text_color);
    clipboard_floating_menu_button_t.focussed_up_text_color = *(current_MMI_theme->clipboard_floating_menu_text_color);
    clipboard_floating_menu_button_t.focussed_down_text_color = *(current_MMI_theme->clipboard_floating_menu_text_color);
    clipboard_floating_menu_button_t.clicked_up_text_color = *(current_MMI_theme->clipboard_floating_menu_text_color);
    clipboard_floating_menu_button_t.clicked_down_text_color = *(current_MMI_theme->clipboard_floating_menu_text_color);

    for (i = 0; i < count; i++)
    {
        switch (menu->menu_item[i].button_type)
        {
            case MMI_IMUI_CLIPBOARD_FLOATING_MENU_ITEM_TYPE_COPY:
                item_string_id = STR_ID_CLIPBOARD_COPY;
                break;
            case MMI_IMUI_CLIPBOARD_FLOATING_MENU_ITEM_TYPE_COPY_ALL:
                item_string_id = STR_ID_CLIPBOARD_COPY_ALL;
                break;
            case MMI_IMUI_CLIPBOARD_FLOATING_MENU_ITEM_TYPE_CUT:
                item_string_id = STR_ID_CLIPBOARD_CUT;
                break;
            case MMI_IMUI_CLIPBOARD_FLOATING_MENU_ITEM_TYPE_CUT_ALL:
                item_string_id = STR_ID_CLIPBOARD_CUT_ALL;
                break;
            case MMI_IMUI_CLIPBOARD_FLOATING_MENU_ITEM_TYPE_PASTE:
                item_string_id = STR_ID_CLIPBOARD_PASTE;
                break;
            default:
                MMI_ASSERT(0);
                break;
        }

    #ifdef __MMI_MAINLCD_480X800__
        gui_set_font(&MMI_medium_font);
    #else
        gui_set_font(&MMI_small_font);
    #endif
        menu->menu_item[i].button.flags |= (UI_BUTTON_CENTER_TEXT_X | UI_BUTTON_CENTER_TEXT_Y);
        Get_StringWidthHeight((U8*)GetString(item_string_id), &width, &height);
        btn_text_width[i] = width;
        gui_create_text_button(
            &(menu->menu_item[i].button),
            x + offset,
            y,
            width + MMI_IMUI_CLIPBOARD_FLOATING_MENU_TEXT_X_GAP * 2,
            MMI_IMUI_CLIPBOARD_FLOATING_MENU_HEIGHT,
            (UI_string_type)GetString(item_string_id));
        gui_set_text_button_theme(&(menu->menu_item[i].button), &clipboard_floating_menu_button_t);
        gui_set_text_button_BG_theme(&(menu->menu_item[i].button), &clipboard_floating_menu_button_bg_t);
        offset += (width + MMI_IMUI_CLIPBOARD_FLOATING_MENU_TEXT_X_GAP * 2);
    }

    /* Adjust the button text gap and resize button */
    if (offset >= UI_device_width)
    {
        text_gap = MMI_IMUI_CLIPBOARD_FLOATING_MENU_TEXT_X_GAP - 1;
        while (text_gap >= MMI_IMUI_CLIPBOARD_FLOATING_MENU_TEXT_X_GAP_N )
        {
            offset = 0;
            for (i = 0; i < count; i++)
            {
                btn_width = btn_text_width[i] + text_gap * 2;
                menu->menu_item[i].button.width = btn_width;
                offset += btn_width;
            }

            if (offset < UI_device_width)
            {
                break;
            }

            text_gap--;
        }
    
        /* Adjust x position */
        x = UI_device_width - offset;
    }

#ifdef __MMI_VECTOR_FONT_SUPPORT__
    // decrease button font size if the menu still exceed the lcd width
    if (offset > UI_device_width)
    {
    #ifdef __MMI_MAINLCD_480X800__
        s_ccp_fm_btnFont = MMI_medium_font;
    #else
        s_ccp_fm_btnFont = MMI_small_font;
    #endif
        s_ccp_fm_btnFont.size = FONT_PIXEL_SIZE(mmi_fe_size_to_pixel(s_ccp_fm_btnFont.size));
        text_gap = MMI_IMUI_CLIPBOARD_FLOATING_MENU_TEXT_X_GAP_N;
        while (offset > UI_device_width)
        {
           s_ccp_fm_btnFont.size--;
           offset = 0;
           gui_set_font(&s_ccp_fm_btnFont);
           for (i = 0; i < count; i++)
           {
                Get_StringWidthHeight((U8*)menu->menu_item[i].button.text, &width, &height);
                offset += (width + text_gap * 2);
           }
        }

        clipboard_floating_menu_button_t.text_font = &s_ccp_fm_btnFont;
        for (i = 0; i < count; i++)
        {
            gui_set_font(&s_ccp_fm_btnFont);
            menu->menu_item[i].button.flags |= (UI_BUTTON_CENTER_TEXT_X | UI_BUTTON_CENTER_TEXT_Y);
            Get_StringWidthHeight((U8*)menu->menu_item[i].button.text, &width, &height);
            btn_text_width[i] = width;
            gui_create_text_button(
                &(menu->menu_item[i].button),
                x + offset,
                y,
                width + text_gap * 2,
                MMI_IMUI_CLIPBOARD_FLOATING_MENU_HEIGHT,
                (UI_string_type)menu->menu_item[i].button.text);
            gui_set_text_button_theme(&(menu->menu_item[i].button), &clipboard_floating_menu_button_t);
            gui_set_text_button_BG_theme(&(menu->menu_item[i].button), &clipboard_floating_menu_button_bg_t);
            offset += (width + text_gap * 2);
        }
        /* Adjust x position */
        x = UI_device_width - offset;
    }
#endif

    g_imui_clipboard_floating_menu.x = x;
    g_imui_clipboard_floating_menu.y = y;
    g_imui_clipboard_floating_menu.width = offset;
    g_imui_clipboard_floating_menu.height = MMI_IMUI_CLIPBOARD_FLOATING_MENU_HEIGHT;
    g_imui_clipboard_floating_menu.highlight_index = 0;

    return i;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_clipboard_floating_menu
 * DESCRIPTION
 * 
 * PARAMETERS
 * 
 * RETURNS
 *  void
 *****************************************************************************/
static S32 mmi_imui_update_clipboard_floating_menu(mmi_imui_update_clipboard_floating_menu_struct_p update_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_ASSERT(update_ptr->count <= MMI_IMUI_CLIPBOARD_FOLATING_MENU_NUM);

    memcpy(&g_imui_clipboard_floating_menu.menu_item, &update_ptr->menu_item, sizeof(mmi_imui_clipboard_floating_menu_item_struct) * MMI_IMUI_CLIPBOARD_FOLATING_MENU_NUM);
    g_imui_clipboard_floating_menu.menu_item_cnt = update_ptr->count;
    g_imui_clipboard_floating_menu.highlight_index = update_ptr->highlight_index;

    return update_ptr->count;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_create_clipboard_floating_menu
 * DESCRIPTION
 * Create clipboard floating menu
 * PARAMETERS
 * style           [IN]
 * RETURNS
 * void
 *****************************************************************************/
static void mmi_imui_create_clipboard_floating_menu(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 height = 0, ascent = 0, descent = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_imui_clipboard_floating_menu.x = g_imui_ui_param.imui_left + MMI_IMUI_COMPOSITION_BOX_LEFT_GAP;
    g_imui_clipboard_floating_menu.width = g_imui_ui_param.imui_width - (MMI_IMUI_COMPOSITION_BOX_LEFT_GAP + MMI_IMUI_COMPOSITION_BOX_RIGHT_GAP);
    

    g_imui_clipboard_floating_menu.y = -1; /* Default value */
    mmi_fe_get_char_info_of_all_lang(g_imui_ui_theme.font_text->size, &height, &ascent, &descent);
    g_imui_clipboard_floating_menu.height = height + MMI_IMUI_SELECTION_AREA_VER_GAP * 2;
}

#endif /* __MMI_CLIPBOARD_FLOATING_MENU__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_composition_box_area
 * DESCRIPTION
 *  Draw composition box
 * PARAMETERS
 *  bottom_line     [IN]       The y of bottom line for composition box
 * RETURNS
 *  The bottom line for next control
 *****************************************************************************/
static S32 mmi_imui_draw_composition_box_area(S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if defined(__MMI_WALLPAPER_ON_BOTTOM__) && !defined(__MMI_IME_FTE_ENHANCE__)
    gdi_handle old_src_layer,act_layer;
#endif /*defined(__MMI_WALLPAPER_ON_BOTTOM__)*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    g_imui_control_set.control_bottoms[MMI_IMUI_COMPOSITION_AREA] = bottom_line;
    
	
#if defined(__MMI_WALLPAPER_ON_BOTTOM__) && !defined(__MMI_IME_FTE_ENHANCE__)
	if (!wgui_is_wallpaper_on_bottom())
	{
        gdi_image_abm_get_source_layer(&old_src_layer);
        gdi_layer_get_active(&act_layer);
        gdi_image_abm_set_source_layer(act_layer);
	}
#endif /* #if defined(__MMI_WALLPAPER_ON_BOTTOM__) && !defined(__MMI_IME_FTE_ENHANCE__) */

#if defined(__MMI_IME_FLOATING_CAND_BOX__)
    if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
    {
        g_imui_composition_box.x = g_imui_ui_param.imui_floating_left + MMI_IMUI_COMPOSITION_BOX_LEFT_GAP;
        
        g_imui_composition_box.y = bottom_line - (MMI_IMUI_COMPOSITION_BOX_BOTTOM_GAP + g_imui_composition_box.height) + 1;
    
    #if defined(__MMI_VUI_ENGINE__)
        if (vadp_p2v_uc_is_in_venus())
        {
            mmi_imui_draw_back_ground(g_imui_ui_param.imui_floating_left, 
                                  bottom_line - (MMI_IMUI_COMPOSITION_BOX_BOTTOM_GAP + 
                                  MMI_IMUI_COMPOSITION_BOX_TOP_GAP + g_imui_composition_box.height) + 1,
                                  g_imui_ui_param.imui_floating_left + g_imui_ui_param.imui_floating_width - 1,
                                  bottom_line);
        }
    #endif
    }
    else
#endif /* #if defined(__MMI_IME_FLOATING_CAND_BOX__) */
    {
        mmi_imui_draw_back_ground(g_imui_ui_param.imui_left,  
                              bottom_line - (MMI_IMUI_COMPOSITION_BOX_BOTTOM_GAP + 
                              MMI_IMUI_COMPOSITION_BOX_TOP_GAP + g_imui_composition_box.height) + 1,
                              g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
                              bottom_line);
    
        g_imui_composition_box.x = g_imui_ui_param.imui_left + MMI_IMUI_COMPOSITION_BOX_LEFT_GAP;

        g_imui_composition_box.y = bottom_line - (MMI_IMUI_COMPOSITION_BOX_BOTTOM_GAP + g_imui_composition_box.height) + 1;
    }

    mmi_imui_show_selection_area(&g_imui_composition_box);

#if defined(__MMI_WALLPAPER_ON_BOTTOM__) && !defined(__MMI_IME_FTE_ENHANCE__)
	if (!wgui_is_wallpaper_on_bottom())
	{
        gdi_image_abm_set_source_layer(old_src_layer);
	}
#endif /* #if defined(__MMI_WALLPAPER_ON_BOTTOM__) && !defined(__MMI_IME_FTE_ENHANCE__) */

    return (bottom_line - (MMI_IMUI_COMPOSITION_BOX_BOTTOM_GAP + 
            MMI_IMUI_COMPOSITION_BOX_TOP_GAP + g_imui_composition_box.height));
}


#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_input_box_area
 * DESCRIPTION
 *  Draw input box
 * PARAMETERS
 *  bottom_line     [IN]       The y of bottom line for composition box
 * RETURNS
 *  The bottom line for next control
 *****************************************************************************/
static S32 mmi_imui_draw_input_box_area(S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if defined(__MMI_WALLPAPER_ON_BOTTOM__)
    gdi_handle old_src_layer,act_layer;
#endif /*defined(__MMI_WALLPAPER_ON_BOTTOM__)*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    g_imui_control_set.control_bottoms[MMI_IMUI_INPUT_AREA] = bottom_line;
    
#if defined(__MMI_WALLPAPER_ON_BOTTOM__)
	if (!wgui_is_wallpaper_on_bottom())
	{
        gdi_image_abm_get_source_layer(&old_src_layer);
        gdi_layer_get_active(&act_layer);
        gdi_image_abm_set_source_layer(act_layer);
	}
#endif /*defined(__MMI_WALLPAPER_ON_BOTTOM__)*/

#if defined(__MMI_IME_FLOATING_CAND_BOX__)
    if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
    {
        g_imui_input_box.x = g_imui_ui_param.imui_floating_left + MMI_IMUI_INPUT_BOX_LEFT_GAP;
            
        g_imui_input_box.y = bottom_line - (MMI_IMUI_INPUT_BOX_BOTTOM_GAP + g_imui_input_box.height) + 1;
        
    #if defined(__MMI_VUI_ENGINE__)
        if (vadp_p2v_uc_is_in_venus())
        {
            mmi_imui_draw_back_ground(g_imui_ui_param.imui_floating_left, 
                                  bottom_line - (MMI_IMUI_INPUT_BOX_BOTTOM_GAP + 
                                  MMI_IMUI_INPUT_BOX_TOP_GAP + g_imui_input_box.height) + 1,
                                  g_imui_ui_param.imui_floating_left + g_imui_ui_param.imui_floating_width - 1,
                                  bottom_line);
        }
    #endif
    }
        else
#endif /* #if defined(__MMI_IME_FLOATING_CAND_BOX__) */
        {

            mmi_imui_draw_back_ground(g_imui_ui_param.imui_left,  
                              bottom_line - (MMI_IMUI_INPUT_BOX_BOTTOM_GAP + 
                              MMI_IMUI_INPUT_BOX_TOP_GAP + g_imui_input_box.height) + 1,
                              g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
                              bottom_line);
    
            g_imui_input_box.x = g_imui_ui_param.imui_left + MMI_IMUI_INPUT_BOX_LEFT_GAP;
    
            g_imui_input_box.y = bottom_line - (MMI_IMUI_INPUT_BOX_BOTTOM_GAP + g_imui_input_box.height) + 1;
        }

    mmi_imui_show_input_area(&g_imui_input_box);

#if defined(__MMI_WALLPAPER_ON_BOTTOM__)
	if (!wgui_is_wallpaper_on_bottom())
	{
        gdi_image_abm_set_source_layer(old_src_layer);
	}
#endif /*defined(__MMI_WALLPAPER_ON_BOTTOM__)*/

    return (bottom_line - (MMI_IMUI_INPUT_BOX_BOTTOM_GAP + 
            MMI_IMUI_INPUT_BOX_TOP_GAP + g_imui_input_box.height));
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_title_box_area
 * DESCRIPTION
 *  Draw title box
 * PARAMETERS
 *  bottom_line     [IN]       The y of bottom line for composition box
 * RETURNS
 *  The bottom line for next control
 *****************************************************************************/
static S32 mmi_imui_draw_title_box_area(S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if defined(__MMI_WALLPAPER_ON_BOTTOM__)
    gdi_handle old_src_layer,act_layer;
#endif /*defined(__MMI_WALLPAPER_ON_BOTTOM__)*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    g_imui_control_set.control_bottoms[MMI_IMUI_TITLE_AREA] = bottom_line;
    
#if defined(__MMI_WALLPAPER_ON_BOTTOM__)
	if (!wgui_is_wallpaper_on_bottom())
	{
        gdi_image_abm_get_source_layer(&old_src_layer);
        gdi_layer_get_active(&act_layer);
        gdi_image_abm_set_source_layer(act_layer);
	}
#endif /*defined(__MMI_WALLPAPER_ON_BOTTOM__)*/

    mmi_imui_draw_back_ground(g_imui_ui_param.imui_left,  
                              bottom_line - (MMI_IMUI_TITLE_BOX_BOTTOM_GAP + 
                              MMI_IMUI_TITLE_BOX_TOP_GAP + g_imui_title_box.height) + 1,
                              g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
                              bottom_line);
    
    g_imui_title_box.x = g_imui_ui_param.imui_left + MMI_IMUI_TITLE_BOX_LEFT_GAP;
    
    g_imui_title_box.y = bottom_line - (MMI_IMUI_TITLE_BOX_BOTTOM_GAP + g_imui_title_box.height) + 1;

    mmi_imui_show_input_area(&g_imui_title_box);

#if defined(__MMI_WALLPAPER_ON_BOTTOM__)
	if (!wgui_is_wallpaper_on_bottom())
{
        gdi_image_abm_set_source_layer(old_src_layer);
	}
#endif /*defined(__MMI_WALLPAPER_ON_BOTTOM__)*/

    return (bottom_line - (MMI_IMUI_TITLE_BOX_BOTTOM_GAP + 
            MMI_IMUI_TITLE_BOX_TOP_GAP + g_imui_title_box.height));
}
#endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/


#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_ime_indicator_floating
 * DESCRIPTION
 *  
 * PARAMETERS
 * 
 * RETURNS
 *  
 *****************************************************************************/
void mmi_imui_draw_ime_indicator_floating(void)
{
	/*----------------------------------------------------------------*/
	/* Local Variables												 */
	/*----------------------------------------------------------------*/


   mmi_imc_message_struct imc_message;
   UI_string_type inputmode_string = NULL;
   UI_character_type g_imui_input_mode_str[15];
   color c = {255,255,255,255};//*current_MMI_theme->input_method_text_color;
   color background_color = {0,0,0,80};//background color black, transparency 80
    stFontAttribute *f = &MMI_small_font;
   MMI_BOOL is_smart_mode;
    S32 width = 0, height = 0;
//	mmi_imc_rect cursor_rect;
     /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	g_imui_input_mode_str[0] = 0;

    //g_imui_indicator_rect_floating is already updated
    if (g_imui_floating_indicator_back_ground_redraw)
    {
        imc_message.message_id = MMI_IMC_MESSAGE_REDRAW; 
        imc_message.param_0 = 1;
        imc_message.param_1 = (U32)&g_imui_indicator_rect_floating_backup;
        mmi_imc_send_message(&imc_message); 
    }

	inputmode_string = mmi_imui_get_inputmode_string(&is_smart_mode);
	if (is_smart_mode)
    {
        mmi_ucs2cpy((S8*)g_imui_input_mode_str, (S8*)L"s");
    }
    mmi_ucs2cat((S8*)g_imui_input_mode_str, (S8*)inputmode_string);
	if (NULL != inputmode_string)
    {
        mmi_imui_get_string_extent(f, g_imui_input_mode_str, &width, &height);
    }
	 if (width > 0 && height > 0)
    {
        gdi_layer_lock_frame_buffer();
        gui_push_clip();
		gui_set_clip_preset(g_imui_indicator_rect_floating.x, 
                     g_imui_indicator_rect_floating.y, 
                     g_imui_indicator_rect_floating.x + g_imui_indicator_rect_floating.width - 1, 
                     g_imui_indicator_rect_floating.y + g_imui_indicator_rect_floating.height - 1);
        gui_fill_rectangle(g_imui_indicator_rect_floating.x, 
                            g_imui_indicator_rect_floating.y, 
                            g_imui_indicator_rect_floating.x + g_imui_indicator_rect_floating.width - 1,
                            g_imui_indicator_rect_floating.y + g_imui_indicator_rect_floating.height - 1, 
                            background_color);
		gui_move_text_cursor(g_imui_indicator_rect_floating.x + ((g_imui_indicator_rect_floating.width - width)/2) , g_imui_indicator_rect_floating.y + (g_imui_indicator_rect_floating.height - height) / 2 + 1);
		gui_set_font(f);
        gui_set_text_color(c);

        gui_print_text(g_imui_input_mode_str);
		gui_pop_clip();
    
        gdi_layer_unlock_frame_buffer();

        gdi_layer_blt_previous(g_imui_indicator_rect_floating.x, 
                g_imui_indicator_rect_floating.y, 
                g_imui_indicator_rect_floating.x + g_imui_indicator_rect_floating.width - 1, 
                g_imui_indicator_rect_floating.y + g_imui_indicator_rect_floating.height - 1);
            
		mmi_imc_repaint_screen();
		g_imui_indicator_rect_floating_backup = g_imui_indicator_rect_floating;
	}
}
#endif /*#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)*/

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_information_bar
 * DESCRIPTION
 *  Draw composition box
 * PARAMETERS
 *  bottom_line     [IN]       The y of bottom line for composition box
 * RETURNS
 *  The bottom line for next control
 *****************************************************************************/
static void mmi_imui_draw_information_bar(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_imm_input_mode_info_struct_p hint_info = NULL;
    color c = *current_MMI_theme->input_method_text_color;
    
#if !defined(__MMI_TOUCH_SCREEN__) || defined(__MMI_IME_FTE_ENHANCE__)
    stFontAttribute *f = &MMI_small_font;
#else /* !defined(__MMI_TOUCH_SCREEN__) */ 
#if defined(__MMI_MAINLCD_240X320__) || defined(__MMI_MAINLCD_240X400__)
    stFontAttribute *f = &MMI_small_font;//MMI_small_font
#else
    stFontAttribute *f = &MMI_medium_font;//MMI_medium_font
#endif
#endif /* !defined(__MMI_TOUCH_SCREEN__) */ 
    S32 width, height, img_width, img_height;
    UI_string_type inputmode_string = NULL;
    PU8 inputmode_icon = NULL;
    const sIMEModeDetails * inputmode_detail = NULL;
    S32 x1, x2;
	S32 img_y = 0;
    mmi_imm_input_mode_hint_item_struct_p hint_item = NULL;
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    PU8 switch_icon = NULL;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_IME_PLUG_IN__
    if (mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_DRAW_CURRENT_IME_INDICATOR, (U32)&g_imui_information_bar_rect, 0) == 1)
    {
        return;
    }
#endif

    hint_info = (mmi_imm_input_mode_info_struct_p)mmi_imm_get_curr_input_mode_hint_info();

    if (hint_info == NULL)
    {
        return;
    }

    hint_item = hint_info->hint_item_ptr;
    
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    while ((hint_item->display_flag != MMI_IME_HINT_FLAG_NONE))
    {
        if ((hint_item->display_flag & MMI_IME_HINT_FLAG_INFO_BAR)
            && (hint_item->display_flag & mmi_imm_get_current_input_case()))
        {
            break;
        }
        hint_item ++;
    }

    if (hint_item->display_flag == MMI_IME_HINT_FLAG_NONE)
    {
        hint_item = hint_info->hint_item_ptr;
    }
#endif /* #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__) */


    if (!(hint_item->display_flag & MMI_IME_HINT_FLAG_INFO_BAR))
    {
        return;
    }
    
    if (hint_item->hint_type == MMI_IME_HINT_TYPE_STRING)
    {
        inputmode_string = (UI_string_type)get_string(hint_item->hint_id);
    }

    if (hint_item->hint_type == MMI_IME_HINT_TYPE_IMAGE)
    {
        inputmode_icon = get_image(hint_item->hint_id);
    }

    if (inputmode_string == NULL && inputmode_icon == NULL)
    {
        return;
    }
    
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    if (mmi_imm_get_special_key_icon() != 0)
    {
        switch_icon = get_image(mmi_imm_get_special_key_icon());

        if (hint_item->display_flag & mmi_imm_get_current_input_case()
            && (mmi_imm_get_special_key_icon() == IMG_IME_QWERTY_SHIFT || mmi_imm_get_special_key_icon() == IMG_IME_QWERTY_SHIFT_LOCK))
        {
            switch_icon = NULL;
        }
    }
#endif

    
    gdi_layer_lock_frame_buffer();
    gui_push_clip();
    gui_set_clip(g_imui_information_bar_rect.x, 
                 g_imui_information_bar_rect.y, 
                 g_imui_information_bar_rect.x + g_imui_information_bar_rect.width - 1, 
                 g_imui_information_bar_rect.y + g_imui_information_bar_rect.height - 1);

    x1 = g_imui_information_bar_rect.x;
    x2 = g_imui_information_bar_rect.x + g_imui_information_bar_rect.width - 1;
    
    gui_set_font(f);
    gui_set_text_color(c);

    inputmode_detail = mmi_imm_get_input_mode_array_item(mmi_imm_get_curr_input_mode());

    if (!inputmode_detail)
    {
        MMI_ASSERT(0);
    }

    if (!mmi_fe_get_r2l_state())//pluto slim
    {

#ifdef __MMI_ZI__ /* Zi style */
    #if defined(__MMI_IME_FTE_ENHANCE__)
    #if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
        if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
        {
            gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);
            
            gui_show_transparent_image(x1 + 1, 
                g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                get_image(WGUI_IME_SMART_ENGLISH_IMG),
                0);
            
            x1 += (width + 1);
        }
        else
     #endif
        {
            gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);
            
            gui_show_transparent_image(x1 + 1, 
                g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                get_image(WGUI_INPUT_INFORMATION_ICON1),
                0);
            
            x1 += (width + 1);
        }    
    #else

        gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);

        gui_show_transparent_image(x1 + 1, 
                                   g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                   get_image(WGUI_INPUT_INFORMATION_ICON1),
                                   0);

        x1 += (width + 1);

        if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
        {
            gui_measure_image(get_image(WGUI_ZI_EZITEXT_LOGO), &width, &height);

            gui_show_transparent_image(x1 + 1, 
                                       g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                       get_image(WGUI_ZI_EZITEXT_LOGO),
                                       0);

            x1 += (width + 1);
        }
    #endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

        if (inputmode_string != NULL)
        {
            Get_StringWidthHeight((U8 *)inputmode_string, &width, &height);
        #ifdef __MMI_TOUCH_SCREEN__    

        #if defined(__MMI_IME_FTE_ENHANCE__)
            gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
			img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
            gdi_image_draw_resized(x1 + 2, 
                img_y, 
                width + 3,
                img_height, 
                get_image(IMG_ID_IME_INDICATOR_BG));
        #else
            gui_draw_filled_area(x1 + 2, 
                g_imui_information_bar_rect.y + 1, 
                x1 + 2 + width + 2,
                g_imui_information_bar_rect.y + g_imui_information_bar_rect.height - 1, 
                g_imui_ui_theme.information_bar_background_filler);
        #endif
        
			#if defined(__MMI_IME_FTE_ENHANCE__)
            gui_move_text_cursor(x1 + 3, img_y+ (img_height - height) / 2 + 1);
			#else
			gui_move_text_cursor(x1 + 3, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
			#endif
            gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);

            gui_print_text(inputmode_string);
            gdi_pop_and_restore_alpha_blending_source_layer();
            
            x1 += (width + 4);
        #else        
            gui_move_text_cursor(x1 + 2, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
            gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);

            gui_print_text(inputmode_string);
            gdi_pop_and_restore_alpha_blending_source_layer();

            x1 += (width + 2);
        #endif
        }

        if (inputmode_icon != NULL)
        {
            gui_measure_image(inputmode_icon, &width, &height);
        
        #ifdef __MMI_TOUCH_SCREEN__    
        
        #if defined(__MMI_IME_FTE_ENHANCE__)
            gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
			img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
            gdi_image_draw_resized(x1 + 2, 
                img_y, 
                width + 3,
                img_height, 
                get_image(IMG_ID_IME_INDICATOR_BG));
        #else
            gui_draw_filled_area(x1 + 2, 
                g_imui_information_bar_rect.y + 1, 
                x1 + 2 + width + 2,
                g_imui_information_bar_rect.y + g_imui_information_bar_rect.height - 1, 
                g_imui_ui_theme.information_bar_background_filler);
        #endif
        
			#if defined(__MMI_IME_FTE_ENHANCE__)
            gui_show_transparent_image(x1 + 3, 
                                       img_y + (img_height - height) / 2,
                                       inputmode_icon,
                                       0);
			#else
			gui_show_transparent_image(x1 + 3, 
                                       g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                       inputmode_icon,
                                       0);
			#endif
        
        
            x1 += (width + 4);
        #else     
            
            gui_show_transparent_image(x1 + 2, 
                                       g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                       inputmode_icon,
                                       0);

            x1 += (width + 2);
        #endif
        }
        
        g_imui_information_bar_display_rect.x = g_imui_information_bar_rect.x;
        g_imui_information_bar_display_rect.width = x1 - g_imui_information_bar_display_rect.x;
        g_imui_information_bar_display_rect.y = g_imui_information_bar_rect.y;
        g_imui_information_bar_display_rect.height = g_imui_information_bar_rect.height;
        
    #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
        if (switch_icon != NULL)
        {
            gui_measure_image(switch_icon, &width, &height);

            gui_show_transparent_image(x1 + MMI_IMUI_QWERTY_SWITCH_ICON_GAP, 
                                       g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                       switch_icon,
                                       0);

            x1 += (width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP);
        }
    #endif
        
    #else /* defined (__MMI_T9__) || defined(__MMI_CSTAR__) */

    #if defined(__MMI_IME_FTE_ENHANCE__)
    #if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
        if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
        {
            gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);
            
            gui_show_transparent_image(x1 + 1, 
                g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                get_image(WGUI_IME_SMART_ENGLISH_IMG),
                0);
            
            x1 += (width + 1);
        }
        else
    #endif
        {
            gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);
            
            gui_show_transparent_image(x1 + 1, 
                g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                get_image(WGUI_INPUT_INFORMATION_ICON1),
                0);
            
            x1 += (width + 1);
        }    
    #else
        if ((((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_MULTITAP))
            || ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_NUMBERIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_DIRECT)))
			 && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_PINYIN && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_BOPOMO) 
        {
            gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);

            gui_show_transparent_image(x1 + 1, 
                                   g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                   get_image(WGUI_INPUT_INFORMATION_ICON1),
                                   0);

            x1 += (width + 1);
        }
		#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
        else if ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART))
        {
            gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);

            gui_show_transparent_image(x1 + 1, 
                                   g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                   get_image(WGUI_IME_SMART_ENGLISH_IMG),
                                   0);

            x1 += (width + 1);
        }
        #endif
    #endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

        if (inputmode_string != NULL)
        {
            Get_StringWidthHeight((U8 *)inputmode_string, &width, &height);
            
            
        #ifdef __MMI_TOUCH_SCREEN__    

            if (((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_MULTITAP))
                || ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_NUMBERIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_DIRECT)))
            {
            #if defined(__MMI_IME_FTE_ENHANCE__)
                gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
				img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
                gdi_image_draw_resized(x1 + 2, 
                    img_y, 
                    width + 3,
                    img_height, 
                    get_image(IMG_ID_IME_INDICATOR_BG));
            #else
                gui_draw_filled_area(x1 + 2, 
                                 g_imui_information_bar_rect.y + 1, 
                                 x1 + 2 + width + 2,
                                 g_imui_information_bar_rect.y + g_imui_information_bar_rect.height - 1, 
                                 g_imui_ui_theme.information_bar_background_filler);
            #endif
            
                #if defined(__MMI_IME_FTE_ENHANCE__)
				gui_move_text_cursor(x1 + 3, img_y + (img_height - height) / 2 );
				#else
				gui_move_text_cursor(x1 + 3, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
				#endif /* defined(__MMI_IME_FTE_ENHANCE__) */
                gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);

                gui_print_text(inputmode_string);
            
                gdi_pop_and_restore_alpha_blending_source_layer();
                x1 += (width + 4);
            }
            else
            {
            #if defined(__MMI_IME_FTE_ENHANCE__)
                gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
                img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
                gdi_image_draw_resized(x1 + 2, 
                    img_y, 
                    width + 3,
                    img_height, 
                    get_image(IMG_ID_IME_INDICATOR_BG));

                x1 += 2;
            #endif

				 #if defined(__MMI_IME_FTE_ENHANCE__)
                gui_move_text_cursor(x1 + 2, img_y + (img_height - height) / 2);
				#else
				gui_move_text_cursor(x1 + 3, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
				 #endif /* defined(__MMI_IME_FTE_ENHANCE__) */
                
                gui_print_text(inputmode_string);
                
                x1 += (width + 2);
            }    
        #else 
			#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
			#endif
			#if defined(__MMI_IME_FTE_ENHANCE__)   // FTE2.0 MAUI_03124805
				if (((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_MULTITAP))
                || ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_NUMBERIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_DIRECT)))
            {
            #if defined(__MMI_IME_FTE_ENHANCE__)
                gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
				img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
                gdi_image_draw_resized(x1 + 2, 
                    img_y, 
                    width + 5,
                    img_height+3, 
                    get_image(IMG_ID_IME_INDICATOR_BG));
            #else
                gui_draw_filled_area(x1 + 2, 
                                 g_imui_information_bar_rect.y + 1, 
                                 x1 + 2 + width + 2,
                                 g_imui_information_bar_rect.y + g_imui_information_bar_rect.height - 1, 
                                 g_imui_ui_theme.information_bar_background_filler);
            #endif
            
                #if defined(__MMI_IME_FTE_ENHANCE__)
				gui_move_text_cursor(x1 + 3, img_y + (img_height - height) / 2 + 1);
				#else
				gui_move_text_cursor(x1 + 3, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
				#endif /* defined(__MMI_IME_FTE_ENHANCE__) */
                gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);

                gui_print_text(inputmode_string);
            
                gdi_pop_and_restore_alpha_blending_source_layer();
                x1 += (width + 4);
            }
            else
            {
            #if defined(__MMI_IME_FTE_ENHANCE__)
                gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
                img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
                gdi_image_draw_resized(x1 + 2, 
                    img_y, 
                    width + 5,
                    img_height+3, 
                    get_image(IMG_ID_IME_INDICATOR_BG));

                x1 += 2;
            #endif

				 #if defined(__MMI_IME_FTE_ENHANCE__)
                gui_move_text_cursor(x1 + 2, img_y + (img_height - height) / 2 + 1);
				#else
				gui_move_text_cursor(x1 + 3, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
				 #endif /* defined(__MMI_IME_FTE_ENHANCE__) */
                
                gui_print_text(inputmode_string);
                
                x1 += (width + 2);
            }    
			#else
            gui_move_text_cursor(x1 + 2, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
            gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);

            gui_print_text(inputmode_string);
        
            gdi_pop_and_restore_alpha_blending_source_layer();
            x1 += (width + 2);
			#endif
        #endif
        }

        if (inputmode_icon != NULL)
        {
            gui_measure_image(inputmode_icon, &width, &height);

       #if defined(__MMI_IME_FTE_ENHANCE__)
           gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
			img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
           gdi_image_draw_resized(x1 + 2, 
               img_y, 
               width + 3,
               img_height, 
               get_image(IMG_ID_IME_INDICATOR_BG));

           x1 += 2;
       #endif
   
			#if defined(__MMI_IME_FTE_ENHANCE__)
       	   gui_show_transparent_image(x1 + 2, 
                                      img_y + (img_height - height) / 2,
                                      inputmode_icon,
                                      0);
			#else
		   gui_show_transparent_image(x1 + 2, 
                                      g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                      inputmode_icon,
                                      0);
			#endif

            x1 += (width + 2);
        }

        g_imui_information_bar_display_rect.x = g_imui_information_bar_rect.x;
        g_imui_information_bar_display_rect.width = x1 - g_imui_information_bar_display_rect.x;
        g_imui_information_bar_display_rect.y = g_imui_information_bar_rect.y;
        g_imui_information_bar_display_rect.height = g_imui_information_bar_rect.height;

    #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
        if (switch_icon != NULL)
        {
            gui_measure_image(switch_icon, &width, &height);

            gui_show_transparent_image(x1 + MMI_IMUI_QWERTY_SWITCH_ICON_GAP, 
                                       g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                       switch_icon,
                                       0);

            x1 += (width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP);
        }
    #endif
    #endif
    }
    else
    {
    
#ifdef __MMI_ZI__ /* Zi style */
    #if defined(__MMI_IME_FTE_ENHANCE__)
	#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
        if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
        {
            gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);
            
            gui_show_transparent_image(x2 - 1 - width, 
                g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                get_image(WGUI_IME_SMART_ENGLISH_IMG),
                0);
            
            x2 -= (width + 1);
        }
        else
    #endif
        {
            gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);
            
            gui_show_transparent_image(x2 - 1 - width, 
                g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                get_image(WGUI_INPUT_INFORMATION_ICON1),
                0);
            
            x2 -= (width + 1);
        }    
    #else

        gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);

        gui_show_transparent_image(x2 - 1 - width, 
                                   g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                   get_image(WGUI_INPUT_INFORMATION_ICON1),
                                   0);

        x2 -= (width + 1);

        if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
        {
            gui_measure_image(get_image(WGUI_ZI_EZITEXT_LOGO), &width, &height);

            gui_show_transparent_image(x2 - 1 - width, 
                                       g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                       get_image(WGUI_ZI_EZITEXT_LOGO),
                                       0);

            x2 -= (width + 1);
        }
    #endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */
    
        if (inputmode_string != NULL)
        {
            Get_StringWidthHeight((U8 *)inputmode_string, &width, &height);
            
        #ifdef __MMI_TOUCH_SCREEN__    

        #if defined(__MMI_IME_FTE_ENHANCE__)
           gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
			img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
           gdi_image_draw_resized(x2 - 2 - width - 2, 
               img_y, 
               width + 3,
               img_height, 
               get_image(IMG_ID_IME_INDICATOR_BG));
        #else
            gui_draw_filled_area(x2 - 2 - width - 2, 
                                 g_imui_information_bar_rect.y + 1, 
                                 x2 - 2,
                                 g_imui_information_bar_rect.y + g_imui_information_bar_rect.height - 1, 
                                 g_imui_ui_theme.information_bar_background_filler);
        #endif
        
            #if defined(__MMI_IME_FTE_ENHANCE__)
			gui_move_text_cursor(x2 - 4, img_y + (img_height - height) / 2 + 1);
			#else
			gui_move_text_cursor(x2 - 4, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
			#endif
            gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);

            gui_print_text(inputmode_string);
            
            gdi_pop_and_restore_alpha_blending_source_layer();
            x2 -= (width + 4);
        #else       
            
            gui_move_text_cursor(x2 - 2, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
            gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);

            gui_print_text(inputmode_string);
            gdi_pop_and_restore_alpha_blending_source_layer();
            
            x2 -= (width + 2);
        #endif
        }

        if (inputmode_icon != NULL)
        {
            gui_measure_image(inputmode_icon, &width, &height);

        #ifdef __MMI_TOUCH_SCREEN__    

        #if defined(__MMI_IME_FTE_ENHANCE__)
           gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
			img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
           gdi_image_draw_resized(x2 - 2 - width - 2, 
               img_y, 
               width + 3,
               img_height, 
               get_image(IMG_ID_IME_INDICATOR_BG));
        #else
            gui_draw_filled_area(x2 - 2 - width - 2, 
                                 g_imui_information_bar_rect.y + 1, 
                                 x2 - 2,
                                 g_imui_information_bar_rect.y + g_imui_information_bar_rect.height - 1, 
                                 g_imui_ui_theme.information_bar_background_filler);
        #endif
        
			#if defined(__MMI_IME_FTE_ENHANCE__)
			gui_show_transparent_image(x2 - 3 - width, 
                                       img_y + (img_height - height) / 2,
                                       inputmode_icon,
                                       0);
			#else
            gui_show_transparent_image(x2 - 3 - width, 
                                       g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                       inputmode_icon,
                                       0);
			#endif
            x2 -= (width + 4);
        #else     
            gui_show_transparent_image(x2 - 2 - width, 
                                       g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                       inputmode_icon,
                                       0);

            x2 -= (width + 2);
        #endif
        }
        
        g_imui_information_bar_display_rect.x = x2;
        g_imui_information_bar_display_rect.width = g_imui_information_bar_rect.x + g_imui_information_bar_rect.width - 1 - x2;
        g_imui_information_bar_display_rect.y = g_imui_information_bar_rect.y;
        g_imui_information_bar_display_rect.height = g_imui_information_bar_rect.height;
    
    #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
        if (switch_icon != NULL)
        {
            gui_measure_image(switch_icon, &width, &height);

            gui_show_transparent_image(x2 - MMI_IMUI_QWERTY_SWITCH_ICON_GAP - width, 
                                       g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                       switch_icon,
                                       0);

            x2 -= (width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP);
        }
    #endif
    
#else /* defined (__MMI_T9__) || defined(__MMI_CSTAR__) */

    #if defined(__MMI_IME_FTE_ENHANCE__)
    #if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
        if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
        {
            gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);
            
            gui_show_transparent_image(x2 - 1 - width, 
                g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                get_image(WGUI_IME_SMART_ENGLISH_IMG),
                0);
            
            x2 -= (width + 1);
        }
        else
    #endif
        {
            gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);
            
            gui_show_transparent_image(x2 - 1 - width, 
                g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                get_image(WGUI_INPUT_INFORMATION_ICON1),
                0);
            
            x2 -= (width + 1);
        }    
    #else
        if ((((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_MULTITAP))
            || ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_NUMBERIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_DIRECT)))
            && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_PINYIN && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_BOPOMO) 
        {
            gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);

            gui_show_transparent_image(x2 - 1 - width, 
                                   g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                   get_image(WGUI_INPUT_INFORMATION_ICON1),
                                   0);

            x2 -= (width + 1);
        }
		#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
        else if ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART))
        {
            gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);

            gui_show_transparent_image(x2 - 1 - width, 
                                   g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                   get_image(WGUI_IME_SMART_ENGLISH_IMG),
                                   0);

            x2 -= (width + 1);
        }
        #endif
    #endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

        if (inputmode_string != NULL)
        {
            Get_StringWidthHeight((U8 *)inputmode_string, &width, &height);
            
        #ifdef __MMI_TOUCH_SCREEN__    
            if (((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_MULTITAP))
                || ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_NUMBERIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_DIRECT)))
            {
            #if defined(__MMI_IME_FTE_ENHANCE__)
               gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
				img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
               gdi_image_draw_resized(x2 - 2 - width - 2, 
                   img_y, 
                   width + 3,
                   img_height, 
                   get_image(IMG_ID_IME_INDICATOR_BG));
            #else
                gui_draw_filled_area(x2 - 1 - width - 2, 
                    g_imui_information_bar_rect.y + 1, 
                    x2 - 2 ,
                    g_imui_information_bar_rect.y + g_imui_information_bar_rect.height - 1, 
                    g_imui_ui_theme.information_bar_background_filler);
            #endif
            
				#if defined(__MMI_IME_FTE_ENHANCE__)
				gui_move_text_cursor(x2 - 4, img_y + (img_height - height) / 2 + 1);
				#else
                gui_move_text_cursor(x2 - 4, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
				#endif
                gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);
                
                gui_print_text(inputmode_string);
                
                gdi_pop_and_restore_alpha_blending_source_layer();
                x2 -= (width + 4);
            }
            else
            {
            #if defined(__MMI_IME_FTE_ENHANCE__)
                gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
                img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
                gdi_image_draw_resized(x2 - 2 - width - 2, 
                    img_y, 
                    width + 3,
                    img_height, 
                    get_image(IMG_ID_IME_INDICATOR_BG));

                x2 -= 2;
            #endif

				#if defined(__MMI_IME_FTE_ENHANCE__)
                gui_move_text_cursor(x2 - 2, img_y + (img_height - height) / 2 + 1);
				#else
				gui_move_text_cursor(x2 - 2, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
				#endif
                
                gui_print_text(inputmode_string);
                
                x2 -= (width + 2);
            }
        #else               
        #if defined(__MMI_IME_FTE_ENHANCE__) && !defined(__MMI_TOUCH_SCREEN__)
            gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
			img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
            gdi_image_draw_resized(x2 - 2 - width - 2, 
                img_y, 
                width + 3,
                img_height, 
                get_image(IMG_ID_IME_INDICATOR_BG));
        #endif
            gui_move_text_cursor(x2 - 2, g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2 + 1);
            gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);

            gui_print_text(inputmode_string);
            
            gdi_pop_and_restore_alpha_blending_source_layer();
            x2 -= (width + 2);
#endif
        }

        if (inputmode_icon != NULL)
        {
            gui_measure_image(inputmode_icon, &width, &height);
            
        #if defined(__MMI_IME_FTE_ENHANCE__)
            gui_measure_image(get_image(IMG_ID_IME_INDICATOR_BG), &img_width, &img_height);
			img_y = g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - img_height) / 2;
            gdi_image_draw_resized(x2 - 2 - width - 2, 
                img_y, 
                width + 3,
                img_height, 
                get_image(IMG_ID_IME_INDICATOR_BG));
        #endif

			#if defined(__MMI_IME_FTE_ENHANCE__)
			gui_show_transparent_image(x2 - 2 - width, 
                                       img_y + (img_height - height) / 2,
                                       inputmode_icon,
                                       0);
			#else
            gui_show_transparent_image(x2 - 2 - width, 
                                       g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                       inputmode_icon,
                                       0);
			#endif

            x2 -= (width + 2);
        }

        g_imui_information_bar_display_rect.x = x2;
        g_imui_information_bar_display_rect.width = g_imui_information_bar_rect.x + g_imui_information_bar_rect.width - 1 - x2;
        g_imui_information_bar_display_rect.y = g_imui_information_bar_rect.y;
        g_imui_information_bar_display_rect.height = g_imui_information_bar_rect.height;

    #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
        if (switch_icon != NULL)
        {
            gui_measure_image(switch_icon, &width, &height);

            gui_show_transparent_image(x2 - MMI_IMUI_QWERTY_SWITCH_ICON_GAP - width, 
                                       g_imui_information_bar_rect.y + (g_imui_information_bar_rect.height - height) / 2,
                                       switch_icon,
                                       0);

            x2 -= (width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP);
        }
    #endif
    #endif
    }
    
    gui_pop_clip();
    
    gdi_layer_unlock_frame_buffer();
    mmi_imc_repaint_screen();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_ime_infor_width
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static U32 mmi_imui_get_ime_infor_width(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_imm_input_mode_info_struct_p hint_info = NULL;
    
#if !defined(__MMI_TOUCH_SCREEN__) || defined(__MMI_IME_FTE_ENHANCE__)
    stFontAttribute *f = &MMI_small_font;
#else /* !defined(__MMI_TOUCH_SCREEN__) */ 
    stFontAttribute *f = &MMI_medium_font;//MMI_medium_font
#endif /* !defined(__MMI_TOUCH_SCREEN__) */ 
    S32 width, height;
    UI_string_type inputmode_string = NULL;
    PU8 inputmode_icon = NULL;
    const sIMEModeDetails * inputmode_detail = NULL;
    mmi_imm_input_mode_hint_item_struct_p hint_item = NULL;
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    PU8 switch_icon = NULL;
#endif
    U32 ime_infor_width = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_IME_PLUG_IN__
    if (mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_GET_CURRENT_IME_INDICATOR_SIZE, (U32)&width, (U32)&height) == 1)
    {
        return (U32)width;
    }
#endif

    hint_info = (mmi_imm_input_mode_info_struct_p)
    mmi_imm_get_curr_input_mode_hint_info();

    if (hint_info == NULL)
    {
        return 0;
    }

    hint_item = hint_info->hint_item_ptr;
    
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    while ((hint_item->display_flag != MMI_IME_HINT_FLAG_NONE))
    {
        if ((hint_item->display_flag & MMI_IME_HINT_FLAG_INFO_BAR)
            && (hint_item->display_flag & mmi_imm_get_current_input_case()))
        {
            break;
        }
        hint_item ++;
    }

    if (hint_item->display_flag == MMI_IME_HINT_FLAG_NONE)
    {
        hint_item = hint_info->hint_item_ptr;
    }
#endif /* #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__) */


    if (!(hint_item->display_flag & MMI_IME_HINT_FLAG_INFO_BAR))
    {
        return 0;
    }
    
    if (hint_item->hint_type == MMI_IME_HINT_TYPE_STRING)
    {
        inputmode_string = (UI_string_type)get_string(hint_item->hint_id);
    }

    if (hint_item->hint_type == MMI_IME_HINT_TYPE_IMAGE)
    {
        inputmode_icon = get_image(hint_item->hint_id);
    }

    if (inputmode_string == NULL && inputmode_icon == NULL)
    {
        return 0;
    }
    
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    if (mmi_imm_get_special_key_icon() != 0)
    {
        switch_icon = get_image(mmi_imm_get_special_key_icon());

        if (hint_item->display_flag & mmi_imm_get_current_input_case()
            && (mmi_imm_get_special_key_icon() == IMG_IME_QWERTY_SHIFT || 
                mmi_imm_get_special_key_icon() == IMG_IME_QWERTY_SHIFT_LOCK))
        {
            switch_icon = NULL;
        }
    }
#endif

    gui_set_font(f);

    inputmode_detail = mmi_imm_get_input_mode_array_item(mmi_imm_get_curr_input_mode());

    if (!inputmode_detail)
    {
        MMI_ASSERT(0);
    }

#if defined(__MMI_ZI__) /* Zi style */

#if defined(__MMI_IME_FTE_ENHANCE__)
    #if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
    if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
    {
        gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);
        
        ime_infor_width += (width + 1);
    }
    else
   #endif
    {
        gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);
    
        ime_infor_width += (width + 1);
    }  
    
#else

    gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);

    ime_infor_width += (width + 1);

    if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
    {
        gui_measure_image(get_image(WGUI_ZI_EZITEXT_LOGO), &width, &height);

        ime_infor_width += (width + 1);
    }
#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

    if (inputmode_string != NULL)
    {
        Get_StringWidthHeight((U8 *)inputmode_string, &width, &height);
    #ifdef __MMI_TOUCH_SCREEN__    
        ime_infor_width += (width + 4);
    #else        
        ime_infor_width += (width + 2);
    #endif
    }

    if (inputmode_icon != NULL)
    {
        gui_measure_image(inputmode_icon, &width, &height);
    
    #ifdef __MMI_TOUCH_SCREEN__    
        ime_infor_width += (width + 4);
    #else     
        ime_infor_width += (width + 2);
    #endif
    }
    
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    if (switch_icon != NULL)
    {
        gui_measure_image(switch_icon, &width, &height);
        
        ime_infor_width += (width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP);
    }
#endif
    
#else /* defined (__MMI_T9__) || defined(__MMI_CSTAR__) */

#if defined(__MMI_IME_FTE_ENHANCE__)
     #if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
    if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
    {
        gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);
        
        ime_infor_width += (width + 1);
    }
    else
   #endif
    {
        gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);
    
        ime_infor_width += (width + 1);
    }  
    
#else

    if ((((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_MULTITAP))
        || ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_NUMBERIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_DIRECT)))
		 && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_PINYIN && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_BOPOMO) 
    {
        gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);
        
        ime_infor_width += (width + 1);
    }
	#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
    else if ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART))
    {
        gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);

        ime_infor_width += (width + 1);
    }
    #endif
#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

    if (inputmode_string != NULL)
    {
        Get_StringWidthHeight((U8 *)inputmode_string, &width, &height);

    #ifdef __MMI_TOUCH_SCREEN__    

        if (((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_MULTITAP))
            || ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_NUMBERIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_DIRECT)))
        {
            ime_infor_width += (width + 4);
        }
        else
        {
        #if defined(__MMI_IME_FTE_ENHANCE__)
            ime_infor_width += 2;
        #endif
            ime_infor_width += (width + 2);
        }    
    #else            
		 #if defined(__MMI_IME_FTE_ENHANCE__)
			 ime_infor_width += (width + 4);
		#else
        ime_infor_width += (width + 2);
    #endif
       
    #endif
    }

    if (inputmode_icon != NULL)
    {
        gui_measure_image(inputmode_icon, &width, &height);

    #if defined(__MMI_IME_FTE_ENHANCE__)
        ime_infor_width += 2;
    #endif

        ime_infor_width += (width + 2);
    }

#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    if (switch_icon != NULL)
    {
        gui_measure_image(switch_icon, &width, &height);
        
        ime_infor_width += (width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP);
    }
#endif
#endif

    return ime_infor_width;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_redraw
 * DESCRIPTION
 *  Redraw UI
 * PARAMETERS
 *  redraw_flag [IN] Mark the controls need to be redraw, 0 for redrawing all controls
 * RETURNS
 *  Whether the function has redrawed any control
 *****************************************************************************/
static U32 mmi_imui_redraw(U32 redraw_flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
    if (redraw_flag !=0 && 
        (redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
        (g_imui_control_set.last_showed_floating_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
        (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
        (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE) &&
        g_imui_resizable_composition_box.last_showed_width > g_imui_resizable_composition_box.width)
    {
        redraw_flag = 0;
    }
#endif

    if (redraw_flag == 0)
    {
    #if defined(__MMI_IME_FLOATING_CAND_BOX__)
        #if defined(__MMI_VUI_ENGINE__)
            if (!vadp_p2v_uc_is_in_venus())
        #endif
            {
                gdi_layer_lock_frame_buffer();
            }
    #endif
    
        mmi_imui_redraw_all();
        
    #if defined(__MMI_IME_FLOATING_CAND_BOX__)
        #if defined(__MMI_VUI_ENGINE__)
            if (!vadp_p2v_uc_is_in_venus()) /* In Venus, floating controls should only be drawn by MMI_IMUI_MESSAGE_REDRAW_FLOATING_CONTROLS */
        #endif
            {
                #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
                if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
                {
                    wgui_virtual_keyboard_draw_from_cache();
                }
                #endif
                
                mmi_imui_redraw_all_floating_controls();

                #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
                if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
                {
                    wgui_virtual_keyboard_recache();
                }
                #endif
                
                gdi_layer_unlock_frame_buffer();
                mmi_imc_repaint_screen();
            }
    #endif

        return MMI_IMUI_RESULT_TRUE;
    }
    else
    {
        return mmi_imui_redraw_partial_controls(redraw_flag);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_redraw_all
 * DESCRIPTION
 *  Redraw UI
 * PARAMETERS
 *  void
 * RETURNS
 *  Whether the function has redrawed all controls
 *****************************************************************************/
static U32 mmi_imui_redraw_all(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 bottom_y;
    mmi_imc_message_struct imc_message;
    mmi_imc_rect input_box_rect, imui_rect;
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    static MMI_BOOL vk_showed = MMI_FALSE;
    S32 temp_bottom_y = 0;
    #if defined (__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
    MMI_BOOL refresh_floating_area = MMI_FALSE;
    #endif /* defined (__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__) */
#endif

#ifdef __MMI_IME_PLUG_IN__
    U32 custom_control;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    bottom_y = g_imui_ui_param.imui_bottom;
    
    gdi_layer_lock_frame_buffer();
    gui_push_clip();
    
#if defined(__MMI_VUI_ENGINE__)
    if (vadp_p2v_uc_is_in_venus())
    {
        gui_set_clip(0, 0, g_imui_ui_param.imui_width - 1, mmi_imc_get_current_imui_height_skip_fixed_editor() - 1);
    }
    else
#endif
    {
        gui_set_clip(MMI_content_x, MMI_content_y, MMI_content_x + MMI_content_width - 1, MMI_content_y + MMI_content_height - 1);
    }

#if defined(__MMI_VIRTUAL_KEYBOARD__) && defined(__MMI_HANDWRITING_MULTI_BLOCK__)
    if (g_imui_hand_writing_style == MMI_IMUI_HANDWRITING_STYLE_MULTI_BLOCK && !mmi_imc_is_handwriting_disabled())
    {
    #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)) 
            && mmi_imc_pen_is_multiblock_handwriting_type(MMI_virtual_keyboard.lang_type)
            && !mmi_imc_is_handwriting_disabled())
    #else
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)) 
            && mmi_imc_pen_is_multiblock_handwriting_type(g_wgui_virtual_keyboard_lang_type)
            && !mmi_imc_is_handwriting_disabled())
    #endif
        {
            g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA);
            g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD);
            mmi_imc_pen_enable_multiblock_handwriting();
        }
        else if (!(g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)) && mmi_imc_get_state() == MMI_IMC_STATE_HAND_WRITING_CAND)
        {
            g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA);
            mmi_imc_pen_enable_multiblock_handwriting();
        }
        else
        {
			g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA);
            mmi_imc_pen_disable_multiblock_handwriting();
        }

        if (mmi_imc_get_state() == MMI_IMC_STATE_ASSOC_SELECTING && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA)))
        {
            g_imui_control_set.showed_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD);
        }
    }
#endif 

#if defined(__MMI_VIRTUAL_KEYBOARD__)
    if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
    {
	    wgui_virtual_keyboard_recover_covered_area();
		vk_showed = MMI_FALSE;
	}
#endif


#if defined(__MMI_VUI_ENGINE__)
    if (!vadp_p2v_uc_is_in_venus())
#endif
    {
    	/* Clear previous IMUI */
    #if defined(__MMI_TOUCH_SCREEN__)
    #if defined(__MMI_HANDWRITING_MULTI_BLOCK__)
        if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA))
        {
            mmi_imui_draw_back_ground(g_imui_ui_param.imui_left, 
    			g_imui_control_set.control_bottoms[MMI_IMUI_MULTI_BLOCK_AREA] - (MMI_IMUI_MULTIBLOCK_BOTTOM_GAP + 
    			MMI_IMUI_MULTIBLOCK_TOP_GAP + MMI_IMUI_MULTI_BLOCK_HEIGHT) + 1,
    			g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
    			g_imui_control_set.control_bottoms[MMI_IMUI_MULTI_BLOCK_AREA]);
        }
    #endif /* defined(__MMI_HANDWRITING_MULTI_BLOCK__) */
    #if defined(__MMI_VIRTUAL_KEYBOARD__)
        if ((g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)) && g_imui_is_vk_draw_enable)
        {
            if (g_imui_redraw_funcptr != NULL)
            {
                g_imui_redraw_funcptr(g_imui_ui_param.imui_left, 
    				g_imui_control_set.control_bottoms[MMI_IMUI_VIRTUAL_KEYBOARD] - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + 
    				MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + g_imui_control_set.showed_vk_height) + 1,
    				g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
    				g_imui_control_set.control_bottoms[MMI_IMUI_VIRTUAL_KEYBOARD]);
            }
            else
            {
                mmi_imui_draw_back_ground(g_imui_ui_param.imui_left, 
    				g_imui_control_set.control_bottoms[MMI_IMUI_VIRTUAL_KEYBOARD] - (MMI_IMUI_VIRTUAL_KEYBOARD_BOTTOM_GAP + 
    				MMI_IMUI_VIRTUAL_KEYBOARD_TOP_GAP + g_imui_control_set.showed_vk_height) + 1,
    				g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
    				g_imui_control_set.control_bottoms[MMI_IMUI_VIRTUAL_KEYBOARD]);   
            }
        }
    #endif /* #if defined(__MMI_VIRTUAL_KEYBOARD__) */
    
   #if defined(__MMI_IME_FTE_ENHANCE__) && !defined(__NO_HANDWRITING__) && defined(__MMI_VIRTUAL_KEYBOARD__) 
        if ((g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA))  && g_imui_is_vk_draw_enable)
        {
            mmi_imui_draw_back_ground(g_imui_ui_param.imui_left, 
    			g_imui_control_set.control_bottoms[MMI_IMUI_SINGLE_BLOCK_AREA] - (MMI_IMUI_SINGLE_BLOCK_TOP_GAP + 
    			MMI_IMUI_SINGLE_BLOCK_BOTTOM_GAP + g_imui_control_set.showed_vk_height) + 1,
    			g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
    			g_imui_control_set.control_bottoms[MMI_IMUI_SINGLE_BLOCK_AREA]);
        }
    #endif /* defined(__MMI_HANDWRITING_MULTI_BLOCK__) */
    #endif /* defined(__MMI_TOUCH_SCREEN__) */

    #ifdef __MMI_IME_PLUG_IN__
        custom_control = g_imui_control_set.last_showed_flag & mmi_ime_sdk_get_custom_control_mask();
        
        if (custom_control != 0)
        {
            mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_CLEAR_LAST_FIXED_UI_CONTROLS, custom_control, 0);
        }
        else
    #endif
        {
    	    if ((g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)) &&
                 !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING))
            {
                mmi_imui_draw_back_ground(g_imui_ui_param.imui_left, 
    			    g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA] - (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + 
    			    MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height) + 1,
    			    g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
    			    g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA]);
            }

        #if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
            if ((g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA)) &&
                 !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING))
            {
                mmi_imui_draw_back_ground(g_imui_ui_param.imui_left,  
    			    g_imui_control_set.control_bottoms[MMI_IMUI_INPUT_AREA] - (MMI_IMUI_INPUT_BOX_BOTTOM_GAP + 
    			    MMI_IMUI_INPUT_BOX_TOP_GAP + g_imui_input_box.height) + 1,
    			    g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
    			    g_imui_control_set.control_bottoms[MMI_IMUI_INPUT_AREA]);
            }
    
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_TITLE_AREA))
            {
                mmi_imui_draw_back_ground(g_imui_ui_param.imui_left,  
    			    g_imui_control_set.control_bottoms[MMI_IMUI_TITLE_AREA] - (MMI_IMUI_TITLE_BOX_BOTTOM_GAP + 
    			    MMI_IMUI_TITLE_BOX_TOP_GAP + g_imui_title_box.height) + 1,
    			    g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
    			    g_imui_control_set.control_bottoms[MMI_IMUI_TITLE_AREA]);
            }
        #endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/
    
            if ((g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
                 !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) &&
                 !(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE) &&
                 !(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL))
            {
                mmi_imui_draw_back_ground(g_imui_ui_param.imui_left,  
    			    g_imui_control_set.control_bottoms[MMI_IMUI_COMPOSITION_AREA] - (MMI_IMUI_COMPOSITION_BOX_BOTTOM_GAP + 
    			    MMI_IMUI_COMPOSITION_BOX_TOP_GAP + g_imui_composition_box.height) + 1,
    			    g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1,
    			    g_imui_control_set.control_bottoms[MMI_IMUI_COMPOSITION_AREA]);
            }
        }
    }

    /*Resize input box*/
    {
        S32 input_box_bottom_y;

        input_box_bottom_y = bottom_y - mmi_imui_get_imui_height_by_ui_set(g_imui_control_set.showed_flag);
        
    #if defined(__MMI_IME_FLOATING_CAND_BOX__)
        input_box_bottom_y += mmi_imui_get_floating_ui_height();
    #endif
    
        imc_message.message_id = MMI_IMC_MESSAGE_GET_INPUT_BOX_RECT;
        imc_message.param_0 = (U32)&input_box_rect;
        imc_message.param_1 = 0;
        
        mmi_imc_send_message(&imc_message);/*Get current input box size*/

        if (input_box_rect.y < input_box_bottom_y && !mmi_imc_is_fixed_input_box())
        {
            imc_message.message_id = MMI_IMC_MESSAGE_RESIZE;
            imc_message.param_0 = (U32)(input_box_rect.width);

            if (input_box_bottom_y == g_imui_ui_param.imui_bottom)
            {
                imc_message.param_1 = (U32)(input_box_bottom_y - input_box_rect.y + 1 + g_imui_ui_param.imui_bottom_border);
            }
            else
            {
                imc_message.param_1 = (U32)(input_box_bottom_y - input_box_rect.y + 1);
            }
            
            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_lock_double_buffer();
            #endif
            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_draw_from_cache();
            }
            #endif

            mmi_imc_send_message(&imc_message);

            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_recache();
            }
            #endif

            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_unlock_double_buffer();
            #endif
        }
        else if (!mmi_imc_is_fixed_input_box())
        {
            imc_message.message_id = MMI_IMC_MESSAGE_MOVE;
            imc_message.param_0 = (U32)(input_box_rect.x);
            imc_message.param_1 = (U32)(input_box_bottom_y - input_box_rect.height + 1);
            
            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_lock_double_buffer();
            #endif
            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_draw_from_cache();
            }
            #endif

            mmi_imc_send_message(&imc_message);

            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_recache();
            }
            #endif

            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_unlock_double_buffer();
            #endif
        }
        
        imui_rect.height = g_imui_ui_param.imui_bottom - input_box_bottom_y;
        imui_rect.width = g_imui_ui_param.imui_width;
        imui_rect.x = g_imui_ui_param.imui_left;
        imui_rect.y = input_box_bottom_y + 1;
            
    #if(UI_DOUBLE_BUFFER_SUPPORT)
        gui_lock_double_buffer();
    #endif
    #if defined(__MMI_VIRTUAL_KEYBOARD__)
        if ((g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)))
        {
            wgui_virtual_keyboard_draw_from_cache();
        }
    #endif
            
        imc_message.message_id = MMI_IMC_MESSAGE_IMUI_RECTANGLE_IS_UPDATED;
        imc_message.param_0 = (U32)&imui_rect;
        mmi_imc_send_message(&imc_message);
        
    #if defined(__MMI_VIRTUAL_KEYBOARD__)
        if ((g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)))
        {
            wgui_virtual_keyboard_recache();
        }
    #endif
        
    #if(UI_DOUBLE_BUFFER_SUPPORT)
        gui_unlock_double_buffer();
    #endif
        
        #ifdef __MMI_TOUCH_SCREEN__
            mmi_imc_pen_change_handwriting_area(); /* Update the first handwriting area */
        #endif /* __MMI_TOUCH_SCREEN__ */
        
        imc_message.message_id = MMI_IMC_MESSAGE_REDRAW;
        imc_message.param_0 = 0;
        imc_message.param_1 = 0;

    #if defined(__MMI_IME_FLOATING_CAND_BOX__)
    #if defined(__MMI_VUI_ENGINE__)
        if (!vadp_p2v_uc_is_in_venus())
    #endif
        {
            MMI_BOOL overlap = MMI_FALSE;

            /* To get if the floating UI overlaps with the editor and it's not contained by editor */
            if (g_imui_control_set.last_showed_floating_flag != 0 &&
                mmi_imui_rects_overlap(&g_imui_control_set.last_showed_floating_ui_rect, &input_box_rect))
            {
                S32 x1, y1, x2, y2, squ_max, squ_measure1, squ_measure2;

                x1 = MIN(g_imui_control_set.last_showed_floating_ui_rect.x, input_box_rect.x);
                y1 = MIN(g_imui_control_set.last_showed_floating_ui_rect.y, input_box_rect.y);
                
                x2 = MAX(g_imui_control_set.last_showed_floating_ui_rect.x + g_imui_control_set.last_showed_floating_ui_rect.width - 1, 
                         input_box_rect.x + input_box_rect.width - 1);
                
                y2 = MAX(g_imui_control_set.last_showed_floating_ui_rect.y + g_imui_control_set.last_showed_floating_ui_rect.height - 1, 
                         input_box_rect.y + input_box_rect.height - 1);

                squ_max = (x2 - x1 + 1) * (y2 - y1 + 1);

                squ_measure1 = g_imui_control_set.last_showed_floating_ui_rect.width * g_imui_control_set.last_showed_floating_ui_rect.height;

                squ_measure2 = input_box_rect.width * input_box_rect.height;
                
                if (squ_max != squ_measure1 && squ_max != squ_measure2)
                {
                    overlap = MMI_TRUE;
                }    
            }

            if (g_imui_control_set.last_showed_floating_flag != 0 &&
                ((g_imui_control_set.last_showed_floating_flag != mmi_imui_get_floating_control_set()) ||
                (g_imui_control_set.last_showed_floating_flag == mmi_imui_get_floating_control_set() &&
                 g_imui_control_set.last_showed_floating_state != mmi_imc_get_state()) ||
                ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
                  (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE)) || 
                  ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)) &&
                  (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)) ||
                  (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CLIPBOARD_FLOATING_MENU)) || overlap))
            {
                #if defined (__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
                refresh_floating_area = MMI_TRUE;
                #endif /* defined (__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__) */
                /* 
                 * Refresh the whole screen, because we can't redraw inline editor 
                 * directly (we must keep the editor status before redrawing list 
                 * menu, and resume them after that), so we will call dm_imui_window_hide()
                 * in every editor call back functions by processing MMI_IMC_MESSAGE_REDRAW
                 */
                imc_message.param_0 = 1; 
                imc_message.param_1 = (U32)&g_imui_control_set.last_showed_floating_ui_rect;
                
            #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
				if (!((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)) &&
                      (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)))
                {
                    gui_fixed_icontext_menuitem_stop_scroll();
                }

                if (g_imui_vertical_candidate_list_stop_cursor)
                {
                    UI_inputbox_start_cursor();
                    g_imui_vertical_candidate_list_stop_cursor = MMI_FALSE;
                }
            #endif
				
            }
        }
    #endif /* #if defined(__MMI_IME_FLOATING_CAND_BOX__) */
				#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
				if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
					!(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL))
                {
					//vertical flag
                    gui_fixed_icontext_menuitem_stop_scroll();
                }

            #endif
        #if(UI_DOUBLE_BUFFER_SUPPORT)
        gui_lock_double_buffer();
        #endif
        #if defined(__MMI_VIRTUAL_KEYBOARD__)
        if ((g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            //#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
            //&& refresh_floating_area
            //#endif /*defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)*/
            )
        {
            wgui_virtual_keyboard_draw_from_cache();
        }
        if(!g_imui_is_vk_draw_enable)
		{
			if(imc_message.param_0 ==1)
			{
                   g_imui_is_vk_draw_enable = MMI_TRUE;
				   //parameter equal to 1 means inline will draw whole screen and we need to draw vk in that case
			}
		}
        #endif
	
        mmi_imc_send_message(&imc_message);
		

        #if defined(__MMI_VIRTUAL_KEYBOARD__)
        if ((g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            //#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
            //&& refresh_floating_area
            //#endif /*defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)*/
            )
        {
            wgui_virtual_keyboard_recache();
        }
        #endif

        #if(UI_DOUBLE_BUFFER_SUPPORT)
        gui_unlock_double_buffer();
        #endif
    
    #if defined(__MMI_IME_FLOATING_CAND_BOX__)
    #if defined(__MMI_VUI_ENGINE__)
        if (!vadp_p2v_uc_is_in_venus())
    #endif
        {
            if (mmi_imui_get_floating_control_set() != 0)
            {
                mmi_imc_message_struct imc_msg;
                
                imc_msg.message_id = MMI_IMC_MESSAGE_FLOATING_UI_APPEAR_INDICATION;
                imc_msg.param_0 = 0;
                imc_msg.param_1 = 0;
                
                mmi_imc_send_message(&imc_msg);
            }
        }
    #endif /* #if defined(__MMI_IME_FLOATING_CAND_BOX__) */
    }


	/* Draw all IMUI */
    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INFORMATION_BAR))
    {
	    imc_message.message_id = MMI_IMC_MESSAGE_DRAW_INFORMATION_BAR;
        /*#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
        if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
        {
            wgui_virtual_keyboard_draw_from_cache();
        }
        #endif*/

        mmi_imc_send_message(&imc_message);

        /*#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
        if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
        {
            wgui_virtual_keyboard_recache();
        }
        #endif*/
    }

    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_HINT_AREA))
    {
	    imc_message.message_id = MMI_IMC_MESSAGE_DRAW_IME_HINT;
      
        mmi_imc_send_message(&imc_message);
    }
    
#if defined(__MMI_IME_INDICATOR_ON_STATUS_ICON_BAR__)
    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA))
    {
        mmi_imui_update_ime_indicator();
    }
#endif
#if defined(__MMI_TOUCH_SCREEN__)
#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)
    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA))/*Draw multi-block area*/
    {
        bottom_y = mmi_imui_draw_multi_block_area(bottom_y);
    }
#endif
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))/*Draw virtual keyboard area*/
    {
        temp_bottom_y = bottom_y;
        bottom_y = mmi_imui_draw_virtual_keyboard_area_background(bottom_y);
    #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
		g_imui_control_set.showed_vk_height = MMI_virtual_keyboard.height;
    #elif defined (__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)
        g_imui_control_set.showed_vk_height = g_wgui_virtual_keyboard.height;
    #else
        g_imui_control_set.showed_vk_height = wgui_virtual_keyboard_get_vk_height();
    #endif
    }
#endif



#endif /*defined(__MMI_TOUCH_SCREEN__)*/

#ifdef __MMI_IME_PLUG_IN__
    custom_control = g_imui_control_set.showed_flag & mmi_ime_sdk_get_custom_control_mask();
                        
    if (custom_control != 0)
    {
        mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_DRAW_CURRENT_FIXED_UI_CONTROLS, custom_control, (U32)bottom_y);
    }
    else
#endif
    {
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)) && 
            !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING))    /*Draw candidate box area*/
        {
            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_lock_double_buffer();
            #endif
            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_draw_from_cache();
            }
            #endif
            bottom_y = mmi_imui_draw_candidate_box_area(bottom_y);
            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)|| defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_recache();
            }
            #endif
            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_unlock_double_buffer();
            #endif
        }
  #if defined(__MMI_IME_CANDIDATE_GRID__)
		//draw grid area of candidate box on top of vk, then composition box over it depending on state
         if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_GRID_AREA))    /*Draw candidate box GRID area*/
        {
             #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_lock_double_buffer();
            #endif
			#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_draw_from_cache();
            }
            #endif
            bottom_y = mmi_imui_draw_candidate_box_area_grid(bottom_y);
            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_recache();
            }
            #endif
            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_unlock_double_buffer();
            #endif
        }
		#endif  
        
        #if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
        if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_TITLE_AREA))/*Draw title box area*/
        {
            bottom_y = mmi_imui_draw_title_box_area(bottom_y);
        }
        #endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/
        
    #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
        #if defined(__MMI_VUI_ENGINE__)
            if (!vadp_p2v_uc_is_in_venus())
        #endif
            {
                if (g_imui_resizable_composition_box.cursor_stopped)
                {
                    UI_inputbox_start_cursor();
                    g_imui_resizable_composition_box.cursor_stopped = MMI_FALSE;
                }
            }
    #endif /* #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__) */
        
       #if defined(__MMI_IME_SCROLLING_COMPOSITION__)
				if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
					g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
				{
					  #if(UI_DOUBLE_BUFFER_SUPPORT)
						gui_lock_double_buffer();
						#endif
					mmi_imui_draw_vertical_composition_list(g_imui_vertical_composition_list.x, UI_device_height-1);
					  #if(UI_DOUBLE_BUFFER_SUPPORT)
						gui_unlock_double_buffer();
						#endif
				}
				else
        #endif
				{
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) && 
            !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) && 
            !(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE))    /*Draw composition box area*/
        {
            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_lock_double_buffer();
            #endif
            
            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_draw_from_cache();
	        }
            #endif
            bottom_y = mmi_imui_draw_composition_box_area(bottom_y);
            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_recache();
	        }
            #endif
    
            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_unlock_double_buffer();
            #endif
        }
    }
    }

#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
    #ifdef __MMI_CSTAR_PHRASE_INPUT__
    /* Move input area draw after composition here */
    if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA)) &&
                 !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING))/*Draw input box area*/
    {
        bottom_y = mmi_imui_draw_input_box_area(bottom_y);
    }
    #endif

#ifndef __MMI_CSTAR_PHRASE_INPUT__
    /* Move input area draw after composition */
    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA) && 
        !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING))/*Draw input box area*/
    {
    bottom_y = mmi_imui_draw_input_box_area(bottom_y);
    }
#endif
#endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/
    
    g_imui_control_set.last_showed_flag = g_imui_control_set.showed_flag;
    #if defined(__MMI_IME_SCROLLING_COMPOSITION__)
    if(!mmi_imui_is_scrolling_box_shown())
	{
         gui_fixed_icontext_menuitem_stop_scroll();
	}
	#endif

	/* Show virtual keyboard after redrawing editor, because VK popup hint would be covered by editor */
#if defined(__MMI_VIRTUAL_KEYBOARD__)
	if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
        && g_is_redraw_vk_enabled && g_imui_is_vk_draw_enable)/*Draw virtual keyboard area*/
    {
        if (vk_showed)
        {
            wgui_virtual_keyboard_recover_covered_area();
        }

    #if defined (__MMI_INDIC_ALG__)
        ire_vk_grey_disable();
    #endif 
    #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
        #if defined (__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
        if (refresh_floating_area)
        {
            wgui_virtual_keyboard_draw_from_cache();                
        }
        #endif
        wgui_show_virtual_keyboard();
        #if defined (__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
        if (refresh_floating_area)
        {
            wgui_virtual_keyboard_recache();
        }
        #endif
    #else
        wgui_virtual_keyboard_draw_from_cache();                
        wgui_virtual_keyboard_show();
        wgui_virtual_keyboard_recache();
    #endif

    #if defined (__MMI_INDIC_ALG__)
        ire_vk_grey_enable();
    #endif 
	vk_showed = MMI_TRUE;
    #if defined(__MMI_IME_FTE_ENHANCE__) && !defined(__NO_HANDWRITING__)   
        if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA))/*Draw single-block handwriting area*/
        {
            mmi_imui_draw_single_block_area(temp_bottom_y);
            mmi_imc_pen_start_singleblock_handwriting();        
        }
    #endif /* defined(__MMI_IME_FTE_ENHANCE__) && !defined(__NO_HANDWRITING__) */
		
	    
	
	}
    
    
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
	if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
		g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
	{
		  #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_lock_double_buffer();
            #endif
		mmi_imui_draw_vertical_composition_list(g_imui_vertical_composition_list.x, UI_device_height-1);
		  #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_unlock_double_buffer();
            #endif
	}
#endif
#endif /*defined(__MMI_TOUCH_SCREEN__)*/

    gui_pop_clip();
    
    gdi_layer_unlock_frame_buffer();

#if defined(__MMI_VUI_ENGINE__)
    if (!vadp_p2v_uc_is_in_venus())
#endif
    {
        gdi_lcd_repaint_all();
    }

    return MMI_IMUI_RESULT_TRUE;
}



/*****************************************************************************
 * FUNCTION
 *  mmi_imui_redraw_partial_controls
 * DESCRIPTION
 *  Redraw partial UI, this function only be called after the first drawing
 * PARAMETERS
 *  void
 * RETURNS
 *  Whether the function has redrawed the controls
 *****************************************************************************/

static U32 mmi_imui_redraw_partial_controls(U32 redraw_flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_imc_message_struct imc_message;
#ifdef __MMI_IME_PLUG_IN__
    U32 redraw_custom_control;
    U32 current_custom_control;
    U32 custom_control;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#if defined(__MMI_VIRTUAL_KEYBOARD__)
    /*  VK should not be updated during the MUltitap state */
   if (mmi_imc_get_state() == MMI_IMC_STATE_MULTITAP) 
   {
        redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD);

        // Return back if no other componenet to be redrawn
        if (!redraw_flag)
          return MMI_IMUI_RESULT_TRUE;
   }
#endif /* defined(__MMI_VIRTUAL_KEYBOARD__) */

    gdi_layer_lock_frame_buffer();   

    if ((redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INFORMATION_BAR))
        && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INFORMATION_BAR)))
    {
        imc_message.message_id = MMI_IMC_MESSAGE_DRAW_INFORMATION_BAR;
		
        mmi_imc_send_message(&imc_message);
        redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_INFORMATION_BAR);
    }
    
    if ((redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_HINT_AREA))
        && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_HINT_AREA)))
    {
        imc_message.message_id = MMI_IMC_MESSAGE_DRAW_IME_HINT;
		
        mmi_imc_send_message(&imc_message);

        redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_HINT_AREA);
    }
    
    
#if defined(__MMI_IME_INDICATOR_ON_STATUS_ICON_BAR__)
	if ((redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA))
        && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA)))
    {
        mmi_imui_update_ime_indicator();
        
        redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA);
    }
#endif

#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)
	if ((redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA_FLOATING))
        && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA_FLOATING)))
    {
        mmi_imui_draw_ime_indicator_floating();
        
        redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA_FLOATING);
    }
#endif /*#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)*/


#if defined(__MMI_TOUCH_SCREEN__)
#if defined(__MMI_HANDWRITING_MULTI_BLOCK__)
    if ((redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA)) 
         && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA)))/*Draw multi-block area*/
    {
        mmi_imui_draw_multi_block_area(g_imui_control_set.control_bottoms[MMI_IMUI_MULTI_BLOCK_AREA]);
        redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_MULTI_BLOCK_AREA);
    }
#endif /* defined(__MMI_HANDWRITING_MULTI_BLOCK__) */

#if defined(__MMI_VIRTUAL_KEYBOARD__)
    if ((redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)) 
        && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD)))/*Draw virtual keyboard area*/
    {
		wgui_virtual_keyboard_recover_covered_area();

        mmi_imui_draw_virtual_keyboard_area_background(g_imui_control_set.control_bottoms[MMI_IMUI_VIRTUAL_KEYBOARD]);

#if defined (__MMI_INDIC_ALG__)
		ire_vk_grey_disable();
#endif 
	    #ifdef __MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__
		wgui_show_virtual_keyboard();
            #else
                wgui_virtual_keyboard_draw_from_cache();                
                wgui_virtual_keyboard_show();
                wgui_virtual_keyboard_recache();
            #endif
		
#if defined (__MMI_INDIC_ALG__)
		ire_vk_grey_enable();
#endif 

    #if defined(__MMI_IME_FTE_ENHANCE__) && !defined(__NO_HANDWRITING__)   
        if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA))/*Draw single-block handwriting area*/
        {
            mmi_imui_draw_single_block_area(g_imui_control_set.control_bottoms[MMI_IMUI_SINGLE_BLOCK_AREA]);
            redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA);
        }
    #endif /* defined(__MMI_IME_FTE_ENHANCE__) */

        redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD);
    }
#endif /* #if defined(__MMI_VIRTUAL_KEYBOARD__) */

#if defined(__MMI_IME_FTE_ENHANCE__) && !defined(__NO_HANDWRITING__) 
    if ((redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA)) 
         && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA)))/*Draw single-block handwriting area*/
    {
        mmi_imui_draw_single_block_area(g_imui_control_set.control_bottoms[MMI_IMUI_SINGLE_BLOCK_AREA]);
        redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_SINGLE_BLOCK_AREA);
    }
#endif /* defined(__MMI_IME_FTE_ENHANCE__) */


#endif /*defined(__MMI_TOUCH_SCREEN__)*/

#ifdef __MMI_IME_PLUG_IN__
    redraw_custom_control = redraw_flag & mmi_ime_sdk_get_custom_control_mask();
    current_custom_control = g_imui_control_set.showed_flag & mmi_ime_sdk_get_custom_control_mask();
    custom_control = redraw_custom_control & current_custom_control;
    
    if (custom_control != 0)
    {
        mmi_imc_rect rect;

        mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_REDRAW_UI_CONTROLS, custom_control, 0);
    #ifdef __MMI_IME_FLOATING_CAND_BOX__
        memset(&g_imui_control_set.last_showed_floating_ui_rect, 0, sizeof(mmi_imc_rect));
        mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_GET_CURRENT_FLOATING_UI_RECT,
                                 current_custom_control,
                                 (U32)&rect);
        g_imui_control_set.last_showed_floating_ui_rect.x = rect.x;
        g_imui_control_set.last_showed_floating_ui_rect.y = rect.y;
        g_imui_control_set.last_showed_floating_ui_rect.width = rect.width;
        g_imui_control_set.last_showed_floating_ui_rect.height = rect.height;  
    #endif
        redraw_flag &= ~ mmi_ime_sdk_get_custom_control_mask();
    }
    else
#endif
    {
        if ((redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)) 
            && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)))/*Draw candidate box area*/
        {
            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_lock_double_buffer();
            #endif
            
            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_draw_from_cache();
            }
            #endif
            
         #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
            if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
            {
                mmi_imui_draw_verical_candidate_list(g_imui_vertical_candidate_list.x, g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA]);
    
                g_imui_control_set.last_showed_floating_ui_rect.x = g_imui_vertical_candidate_list.x - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH;
                g_imui_control_set.last_showed_floating_ui_rect.y = g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA] - g_imui_vertical_candidate_list.height - 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH + 1;
                g_imui_control_set.last_showed_floating_ui_rect.width = g_imui_vertical_candidate_list.width + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH;
                g_imui_control_set.last_showed_floating_ui_rect.height = g_imui_vertical_candidate_list.height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH;
            }
            else
        #endif
            {
                mmi_imui_draw_candidate_box_area(g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA]);
    
            #if defined(__MMI_IME_FLOATING_CAND_BOX__)
                if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
                {
                    g_imui_control_set.last_showed_floating_ui_rect.x = g_imui_candidate_box.x;
                    g_imui_control_set.last_showed_floating_ui_rect.y = g_imui_candidate_box.y;
                    g_imui_control_set.last_showed_floating_ui_rect.width = g_imui_candidate_box.width;
                    g_imui_control_set.last_showed_floating_ui_rect.height = g_imui_candidate_box.height;
                }
            #endif
            }
            
            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_recache();
            }
            #endif
    
            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_unlock_double_buffer();
            #endif
    
            redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA);
        }

    #if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
        if ((redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA)) 
            && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA)))/*Draw input box area*/
        {
            mmi_imui_draw_input_box_area(g_imui_control_set.control_bottoms[MMI_IMUI_INPUT_AREA]);
            /*MAUI_03154534*/
		 #if defined(__MMI_IME_FLOATING_CAND_BOX__)
            if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
            {
				g_imui_control_set.last_showed_floating_ui_rect.x = g_imui_input_box.x;
				g_imui_control_set.last_showed_floating_ui_rect.y = g_imui_input_box.y;
				g_imui_control_set.last_showed_floating_ui_rect.width = g_imui_input_box.width;
				g_imui_control_set.last_showed_floating_ui_rect.height += g_imui_input_box.height;
			}
		#endif
			
			redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA);
        }
        
        if ((redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_TITLE_AREA)) 
            && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_TITLE_AREA)))/*Draw title box area*/
        {
            mmi_imui_draw_title_box_area(g_imui_control_set.control_bottoms[MMI_IMUI_TITLE_AREA]);
            redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_TITLE_AREA);
        }
    #endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/
        
        if ((redraw_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) 
            && (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)))/*Draw composition box area*/
        {
            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_lock_double_buffer();
            #endif
            
            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__) || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_draw_from_cache();
            }
            #endif
    
        #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
            if (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE)
            {
			    gui_push_clip();
			    gui_set_clip(g_imui_resizable_composition_box.x, 
				             g_imui_resizable_composition_box.y,
						     g_imui_resizable_composition_box.x + g_imui_resizable_composition_box.width - 1,
						     g_imui_resizable_composition_box.y + g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT - 1);
			    
			    mmi_imui_draw_resizable_composition_area(g_imui_control_set.control_bottoms[MMI_IMUI_COMPOSITION_AREA]);
			    
			    gui_pop_clip();
            
                redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA);
    
                if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)) && 
                    (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) &&
                    !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_RESERVE))   
                {
                    g_imui_control_set.last_showed_floating_ui_rect.x = MIN(g_imui_resizable_composition_box.x, g_imui_candidate_box.x);
                    g_imui_control_set.last_showed_floating_ui_rect.y = MIN(g_imui_resizable_composition_box.y, g_imui_candidate_box.y);
                    g_imui_control_set.last_showed_floating_ui_rect.width = MAX(g_imui_resizable_composition_box.width, g_imui_candidate_box.width);
                    g_imui_control_set.last_showed_floating_ui_rect.height = g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT + g_imui_candidate_box.height;
                }
                else
                {
                    g_imui_control_set.last_showed_floating_ui_rect.x = g_imui_resizable_composition_box.x;
                    g_imui_control_set.last_showed_floating_ui_rect.y = g_imui_resizable_composition_box.y;
                    g_imui_control_set.last_showed_floating_ui_rect.width = g_imui_resizable_composition_box.width;
                    g_imui_control_set.last_showed_floating_ui_rect.height = g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT;
                }
            }
            else
        #endif /* #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__) */
            {
                mmi_imui_draw_composition_box_area(g_imui_control_set.control_bottoms[MMI_IMUI_COMPOSITION_AREA]);
    
            #if defined(__MMI_IME_FLOATING_CAND_BOX__)
                if ((g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) &&
                    !(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_RESERVE))
                {
                    g_imui_control_set.last_showed_floating_ui_rect.y = g_imui_composition_box.y;
                    g_imui_control_set.last_showed_floating_ui_rect.height = g_imui_candidate_box.y + g_imui_candidate_box.height - g_imui_composition_box.y;
                }
            #endif
    
                redraw_flag &= ~ MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA);
            }
    
            #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)  || defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
            if (g_imui_control_set.last_showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                wgui_virtual_keyboard_recache();
            }
            #endif
    
            #if(UI_DOUBLE_BUFFER_SUPPORT)
            gui_unlock_double_buffer();
            #endif
        }
    }
    gdi_layer_unlock_frame_buffer();
    
#if defined(__MMI_VUI_ENGINE__)
    if (!vadp_p2v_uc_is_in_venus())
#endif
    {
       gdi_lcd_repaint_all();
    }

    
    if (redraw_flag == 0)
        return MMI_IMUI_RESULT_TRUE;
    else
        return MMI_IMUI_RESULT_FALSE;
}

#if defined(__MMI_IME_FLOATING_CAND_BOX__)

#ifdef __MMI_CLIPBOARD_FLOATING_MENU__
extern mmi_editor_handler_struct g_mmi_editor_hanler;
#endif /* __MMI_CLIPBOARD_FLOATING_MENU__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_redraw_all_floating_controls
 * DESCRIPTION
 *  Redraw floating controls
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static U32 mmi_imui_redraw_all_floating_controls(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    S32 ui_height = 0;
    mmi_imc_rect input_box_rect, cursor_rect;
#ifdef __MMI_CLIPBOARD_FLOATING_MENU__
    mmi_imc_clipboard_hilite_rect input_box_hilite_rect;
#endif /* __MMI_CLIPBOARD_FLOATING_MENU__ */
    mmi_imc_message_struct imc_message;
    S32 bottom_y = 0, scroll_bar_width = 0, reduced_height = 0;
    S32 cursor_x1 = 0, cursor_y1 = 0, cursor_x2 = 0, cursor_y2 = 0;
	S32 line_ascent, line_dscent,red_height=0;
#ifdef __MMI_IME_PLUG_IN__
    U32 custom_control;
    MMI_BOOL is_vendor_handled = MMI_FALSE;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_IME_PLUG_IN__
    custom_control = g_imui_control_set.showed_flag & mmi_ime_sdk_get_custom_control_mask();
                        
    if (custom_control != 0)
    {
        if (mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_DRAW_CURRENT_FLOATING_UI_CONTROLS, custom_control, 0) == 1)
        {
            mmi_imc_rect rect;
            memset(&g_imui_control_set.last_showed_floating_ui_rect, 0, sizeof(mmi_imc_rect));
            mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_GET_CURRENT_FLOATING_UI_RECT,
                                     custom_control,
                                     (U32)&rect);
            g_imui_control_set.last_showed_floating_ui_rect.x = rect.x;
            g_imui_control_set.last_showed_floating_ui_rect.y = rect.y;
            g_imui_control_set.last_showed_floating_ui_rect.width = rect.width;
            g_imui_control_set.last_showed_floating_ui_rect.height = rect.height;
            is_vendor_handled = MMI_TRUE;
        }
        else
        {
            g_imui_control_set.last_showed_floating_flag = 0;
            return MMI_IMUI_RESULT_FALSE;
        }
    }
#endif
    
    imc_message.message_id = MMI_IMC_MESSAGE_GET_CURSOR_RECT; 
    imc_message.param_0 = (U32)&cursor_rect;
    imc_message.param_1 = 0;
    
    mmi_imc_send_message(&imc_message); 

    cursor_x1 = cursor_rect.x;
    cursor_y1 = cursor_rect.y;
    cursor_x2 = cursor_rect.x + cursor_rect.width - 1;
    cursor_y2 = cursor_rect.y + cursor_rect.height - 1;
    
    ui_height = mmi_imui_get_floating_ui_height();

    if (ui_height <= 0)
    {
        g_imui_control_set.last_showed_floating_flag = 0;
        return MMI_IMUI_RESULT_FALSE;
    }
    
#if defined(__MMI_VUI_ENGINE__)
    if (vadp_p2v_uc_is_in_venus())
    {
        bottom_y = g_imui_ui_param.imui_floating_bottom;
    }
    else
#endif
    {
        imc_message.message_id = MMI_IMC_MESSAGE_GET_INPUT_BOX_RECT; 
        imc_message.param_0 = (U32)&input_box_rect;
        imc_message.param_1 = 0;
        
        mmi_imc_send_message(&imc_message); /*Get current input box size*/

        if (cursor_y2 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR + ui_height - 1 
            >= g_imui_ui_param.imui_bottom - mmi_imc_get_current_imui_height_skip_fixed_editor() + 1)
        {
            bottom_y = cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR;

            if (bottom_y - ui_height <= input_box_rect.y)
            {
                bottom_y = g_imui_ui_param.imui_bottom - mmi_imc_get_current_imui_height_skip_fixed_editor();

                reduced_height = ui_height - (g_imui_ui_param.imui_bottom - mmi_imc_get_current_imui_height_skip_fixed_editor() 
                                 - (cursor_y2 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR) + 1);

                MMI_ASSERT(reduced_height >= 0);
            }
        }
        else
        {
            bottom_y = cursor_y2 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR + ui_height - 1;
        }
    }

    memset(&g_imui_control_set.last_showed_floating_ui_rect, 0, sizeof(mmi_imc_rect));
    
    gdi_layer_lock_frame_buffer();

#ifdef __MMI_IME_PLUG_IN__
    if (is_vendor_handled == MMI_FALSE)
#endif
    {
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)) && 
            (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) &&
            !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_RESERVE))    /*Draw candidate box area*/
        {
        #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
            if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
            {
                S32 x;
                S32 fixed_ui_height = mmi_imc_get_current_imui_height_skip_fixed_editor();
                S32 list_height = MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_HEIGHT;
                S32 reduced_height_below = 0, reduced_height_above = 0;
            #if defined(__MMI_TOUCH_SCREEN__)
                kal_bool is_enabled, is_pen_down;
            #endif
            
            #if defined(__MMI_TOUCH_SCREEN__)
                mmi_pen_get_state(&is_enabled, &is_pen_down);
                
                if (is_enabled && is_pen_down && g_imui_pen_down_control == MMI_IMUI_CANDIDATE_AREA)
                {
                    x = g_imui_vertical_candidate_list.x;
                    bottom_y = g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA];
                }
                else
            #endif    
                {
                #if defined(__MMI_VUI_ENGINE__)
                    if (vadp_p2v_uc_is_in_venus())
                    {
                        x = MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH;
                    }
                    else
                #endif
                    {
                        imc_message.message_id = MMI_IMC_MESSAGE_GET_INPUT_BOX_RECT; 
                        imc_message.param_0 = (U32)&input_box_rect;
                        imc_message.param_1 = 0;
                    
                        mmi_imc_send_message(&imc_message); /*Get current input box size*/ 
    
                        imc_message.message_id = MMI_IMC_MESSAGE_GET_EDITOR_SCROLL_BAR_WIDTH; 
    
                        scroll_bar_width = (S32)mmi_imc_send_message(&imc_message);
            
                        if (cursor_x1 + (g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH * 2) 
                            < input_box_rect.x + input_box_rect.width - scroll_bar_width)
                        {
                            x = cursor_x1;
                        }
                        else
                        {
                            x = input_box_rect.x + input_box_rect.width - scroll_bar_width - 1 - (g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH * 2);
    
                            if (x < 0)
                            {
                                x = input_box_rect.x + input_box_rect.width - scroll_bar_width - 1;
    
                                if (x + g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH * 2 > UI_device_width)
                                {
                                    x = UI_device_width - (g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH * 2);
                                }
                            }
                        }
                    }
    
                    do 
                    {
                        if (cursor_y2 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR + list_height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1 
                            <= g_imui_ui_param.imui_bottom - fixed_ui_height)
                        {
                            bottom_y = cursor_y2 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR + list_height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1;
                            break;
                        }    
                        else 
                        {
                            reduced_height_below = list_height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - (g_imui_ui_param.imui_bottom - fixed_ui_height 
                                - (cursor_y2 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR) + 1);
                        
                            if (cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR - list_height - 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH + 1
                                >= input_box_rect.y)
                            {
                                bottom_y = cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR;
                                break;
                            }
                            else
                            {
                                reduced_height_above = list_height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - ((cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR) - input_box_rect.y + 1);
                            }    
                        }
                    
                        if (reduced_height_above < reduced_height_below)
                        {
                            reduced_height = reduced_height_above;
                        }
                        else
                        {
                            reduced_height = reduced_height_below;
                        }    
                    
                        if (list_height - reduced_height >= g_imui_vertical_candidate_list_data.height * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_MIN_ITEM_COUNT)
                        {
                            list_height -= reduced_height;
                        }
                        else 
                        {
                            bottom_y = cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR;
    
                            list_height = MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_HEIGHT;
                        
                            if (bottom_y - (list_height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH) + 1
                                >= MMI_status_bar_height)
                            {
                                break;
                            }
                            else
                            {
                                list_height = bottom_y - MMI_status_bar_height - 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH + 1;
                            }    
    
                            break;
                        }    
                    
                    } while(list_height);
    
                
                    if (list_height > 0 && 
                        g_imui_vertical_candidate_list.height != list_height)
                    {
                        gui_resize_fixed_list_menu(
                            &g_imui_vertical_candidate_list, 
                            g_imui_vertical_candidate_list.width,
                            list_height);
    
                        gui_fixed_list_menu_locate_highlighted_item(&g_imui_vertical_candidate_list);
                    }
                }
    
                g_imui_control_set.last_showed_floating_ui_rect.x = x - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH;
                g_imui_control_set.last_showed_floating_ui_rect.y = bottom_y - g_imui_vertical_candidate_list.height - 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH + 1;
                g_imui_control_set.last_showed_floating_ui_rect.width = g_imui_vertical_candidate_list.width + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH;
                g_imui_control_set.last_showed_floating_ui_rect.height = g_imui_vertical_candidate_list.height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH;
                    
                bottom_y = mmi_imui_draw_verical_candidate_list(x, bottom_y);
            }
            else
        #endif /* #if defined(__MMI_IME_VERTICAL_CAND_BOX__) */
            {
                if (reduced_height > 0)
                {
                    bottom_y = cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR;
                }
			    /* 
	    Need to check an abnormal case when cursor lies down but the character displayed are printed above 
	    in order to avoid that we need to move the candidate window one above level*/
			    /* This is a very special case and happens only when cursor lies below while the character is printed above*/
			    if(bottom_y<cursor_y1)
			    {
			    red_height=(gui_inputs_get_char_info_for_all_lang(MEDIUM_FONT, &line_ascent, &line_dscent)-1);
			    bottom_y=bottom_y-red_height;
			    
			    }
                bottom_y = mmi_imui_draw_candidate_box_area(bottom_y);
    
                g_imui_control_set.last_showed_floating_ui_rect.x = g_imui_candidate_box.x;
                g_imui_control_set.last_showed_floating_ui_rect.y = g_imui_candidate_box.y;
                g_imui_control_set.last_showed_floating_ui_rect.width = g_imui_candidate_box.width;
                g_imui_control_set.last_showed_floating_ui_rect.height = g_imui_candidate_box.height;
            }
        }
    
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) && 
            (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) &&
            !(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_RESERVE) && 
            !(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE))    
        {
            bottom_y = mmi_imui_draw_composition_box_area(bottom_y);
    
            g_imui_control_set.last_showed_floating_ui_rect.y = g_imui_composition_box.y;
            g_imui_control_set.last_showed_floating_ui_rect.height = g_imui_candidate_box.y + g_imui_candidate_box.height - g_imui_composition_box.y;
        }
/* MAUI_03137718 */
   // #ifdef __MMI_CSTAR_PHRASE_INPUT__
        /* Move input area draw after composition here */    
    #if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA)) && /*Draw input box area*/
            (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING))

        {
	    if (reduced_height > 0)
            {
			if(bottom_y > cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR)
			{
				red_height=(gui_inputs_get_char_info_for_all_lang(MEDIUM_FONT, &line_ascent, &line_dscent)-1);
				bottom_y = cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR - red_height;
			}
            }
            bottom_y = mmi_imui_draw_input_box_area(bottom_y);
			
			g_imui_control_set.last_showed_floating_ui_rect.x = g_imui_input_box.x;
            g_imui_control_set.last_showed_floating_ui_rect.y = g_imui_input_box.y;
            //g_imui_control_set.last_showed_floating_ui_rect.height = g_imui_composition_box.y + g_imui_composition_box.height - g_imui_input_box.y;
			g_imui_control_set.last_showed_floating_ui_rect.height += g_imui_input_box.height;
			g_imui_control_set.last_showed_floating_ui_rect.width = g_imui_input_box.width;
        }
    #endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/
   // #endif
    }

#ifdef __MMI_CLIPBOARD_FLOATING_MENU__
    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CLIPBOARD_FLOATING_MENU))    /*Draw clipboard floating menu area*/
    {
        S32 x, arrow_x;

        imc_message.message_id = MMI_IMC_MESSAGE_CLIPBOARD_GET_HILITE_RECT; 
        imc_message.param_0 = (U32)&input_box_hilite_rect;
        imc_message.param_1 = 0;

        mmi_imc_send_message(&imc_message); /*Get current input box hilite rect coordinate */

        if ((input_box_hilite_rect.s_x == 0) && (input_box_hilite_rect.s_y == 0))
        {
            /* If no highlight, locate the menu near the cursor position */
            arrow_x = x = cursor_x1;
            bottom_y = cursor_y1 - MMI_IMUI_CLIPBOARD_FLOATING_MENU_GAP_FROM_CURSOR;

            bottom_y = (bottom_y > input_box_rect.y) ? bottom_y : input_box_rect.y;
        }
        else
        {
            if (input_box_hilite_rect.s_y != input_box_hilite_rect.e_y)
            {
                /* highlight more than a line*/
                arrow_x = x = input_box_rect.x + (input_box_rect.width / 2);
            }
            else
            {
                /* highlight a line */
                arrow_x = x = (input_box_hilite_rect.s_x + input_box_hilite_rect.e_x)/2;
            }

            bottom_y = (input_box_hilite_rect.s_y > input_box_rect.y) ? input_box_hilite_rect.s_y : input_box_rect.y;
        }

        if (((bottom_y - MMI_IMUI_CLIPBOARD_FLOATING_MENU_TOTAL_HEIGHT > input_box_rect.y) ||
            (g_mmi_editor_hanler.input_box_type == MMI_EDITOR_SINGLE_LINE_INPU_BOX) ||
            ((g_mmi_editor_hanler.input_box_type == MMI_EDITOR_INLINE_INPUT_BOX) &&
             (g_mmi_editor_hanler.input_box_sub_type == MMI_EDITOR_NORMAL_INPUT_BOX))) &&
             (bottom_y - MMI_status_bar_height - MMI_IMUI_CLIPBOARD_FLOATING_MENU_TOTAL_HEIGHT >= 0))
        {
            g_imui_clipboard_floating_menu.direction = MMI_IMUI_CCP_FM_UP;
        }
        else
        {
            g_imui_clipboard_floating_menu.direction = MMI_IMUI_CCP_FM_DOWN;
        }

        /* If overlap VK, show the menu upwards */
        if (g_imui_clipboard_floating_menu.direction == MMI_IMUI_CCP_FM_DOWN)
        {
            if ((bottom_y + MMI_IMUI_CLIPBOARD_FLOATING_MENU_HIGHLIGHT_HEIGHT + MMI_IMUI_CLIPBOARD_FLOATING_MENU_TOTAL_HEIGHT) > (g_imui_ui_param.imui_bottom - mmi_imc_get_current_imui_height_skip_fixed_editor()))
            {
                g_imui_clipboard_floating_menu.direction = MMI_IMUI_CCP_FM_UP;
            }
        }

        switch (g_imui_clipboard_floating_menu.menu_item_cnt)
        {
        case 1:
            x -= (g_imui_clipboard_floating_menu.menu_item[0].button.width / 2);
            g_imui_clipboard_floating_menu.arrow_index = 0;
            break;
        case 2:
            if (x <= (input_box_rect.x + (input_box_rect.width / 2)))
            {
                x -= (g_imui_clipboard_floating_menu.menu_item[0].button.width / 2);
                g_imui_clipboard_floating_menu.arrow_index = 0;
            }
            else
            {
                x -= g_imui_clipboard_floating_menu.menu_item[0].button.width + (g_imui_clipboard_floating_menu.menu_item[1].button.width / 2);
                g_imui_clipboard_floating_menu.arrow_index = 1;
            }
            break;
        case 3:
            if (x <= (input_box_rect.x + (input_box_rect.width / 3)))
            {
                x -= (g_imui_clipboard_floating_menu.menu_item[0].button.width / 2);
                g_imui_clipboard_floating_menu.arrow_index = 0;
            }
            else if ((x <= (input_box_rect.x + (2 * input_box_rect.width / 3))) &&
                     (x > (input_box_rect.x + (input_box_rect.width / 3))))
            {
                x -= g_imui_clipboard_floating_menu.menu_item[0].button.width + (g_imui_clipboard_floating_menu.menu_item[1].button.width / 2);
                g_imui_clipboard_floating_menu.arrow_index = 1;
            }
            else
            {
                x -= (g_imui_clipboard_floating_menu.width - (g_imui_clipboard_floating_menu.menu_item[2].button.width / 2));
                g_imui_clipboard_floating_menu.arrow_index = 2;
            }
            break;
        default:
            MMI_ASSERT(0);
            break;
        }

        if ((x + g_imui_clipboard_floating_menu.width) > UI_device_width)
        {
            x = UI_device_width - g_imui_clipboard_floating_menu.width - MMI_IMUI_CLIPBOARD_FLOATING_MENU_RIGHT_GAP;
        }

        if (x <= 0)
        {
            x = MMI_IMUI_CLIPBOARD_FLOATING_MENU_LEFT_GAP;
        }

        mmi_imui_adjust_clipboard_floating_menu_arrow_index(x, arrow_x);
    
        bottom_y = mmi_imui_draw_clipboard_floating_menu(x, bottom_y);
    }
#endif

#ifdef __MMI_IME_PLUG_IN__
    if (is_vendor_handled == MMI_FALSE)
#endif
    {
    #if defined(__MMI_IME_FTE_ENHANCE__)
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
            (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE)
			)
        {
           // MMI_ASSERT((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)));
			#if defined(__MMI_IME_CANDIDATE_GRID__)
			if(!mmi_imc_is_grid_state())
			#endif
			{
    if(((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)))==0)
            	{
            	g_imui_control_set.showed_flag |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA);
            	}
			}
    
        #if defined(__MMI_VUI_ENGINE__)
            if (vadp_p2v_uc_is_in_venus())
            {
                if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
                {
                    g_imui_resizable_composition_box.x = g_imui_ui_param.imui_floating_left + MMI_IMUI_CANDIDATE_BOX_LEFT_GAP;
                }
                else
                {
                    g_imui_resizable_composition_box.x = g_imui_ui_param.imui_left + MMI_IMUI_CANDIDATE_BOX_LEFT_GAP;
                }
    
                gui_push_clip();
        	    gui_set_clip(g_imui_resizable_composition_box.x,
                    0,
                    g_imui_resizable_composition_box.x + g_imui_resizable_composition_box.width - 1,
                    g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT - 1);
                
                mmi_imui_draw_resizable_composition_area(g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT - 1);
    
                gui_pop_clip();
            }
            else
        #endif
            {
				#if defined(__MMI_IME_CANDIDATE_GRID__)
				if(mmi_imc_is_grid_state())
				{
					
	                
					mmi_imui_draw_resizable_composition_area((g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_GRID_AREA] - 
									   (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box_grid.height)));
	     
					
				}
				else
				#endif
				{
                gui_push_clip();
        	    gui_set_clip(g_imui_candidate_box.x - 1, 
                             (g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA] - 
                             (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + 
                             g_imui_candidate_box.height)) - g_imui_resizable_composition_box.height + MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT + 1,
                             g_imui_candidate_box.x + g_imui_resizable_composition_box.width - 1,
                             (g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA] - 
                             (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height)));
                
                mmi_imui_draw_resizable_composition_area((g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA] - 
                                   (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height)));
     
                gui_pop_clip();
            }
            }
    
            if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)) && 
                (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) &&
                !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_RESERVE))   
            {
                g_imui_control_set.last_showed_floating_ui_rect.x = MIN(g_imui_resizable_composition_box.x, g_imui_candidate_box.x);
                g_imui_control_set.last_showed_floating_ui_rect.y = MIN(g_imui_resizable_composition_box.y, g_imui_candidate_box.y);
                g_imui_control_set.last_showed_floating_ui_rect.width = MAX(g_imui_resizable_composition_box.width, g_imui_candidate_box.width);
                g_imui_control_set.last_showed_floating_ui_rect.height = g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT + g_imui_candidate_box.height;
            }
            else
            {
                g_imui_control_set.last_showed_floating_ui_rect.x = g_imui_resizable_composition_box.x;
                g_imui_control_set.last_showed_floating_ui_rect.y = g_imui_resizable_composition_box.y;
                g_imui_control_set.last_showed_floating_ui_rect.width = g_imui_resizable_composition_box.width;
                g_imui_control_set.last_showed_floating_ui_rect.height = g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT;
            }
        }
    #endif
    }

    gdi_layer_unlock_frame_buffer();

#if defined(__MMI_VUI_ENGINE__)
    if (!vadp_p2v_uc_is_in_venus())
#endif
    {
       gdi_lcd_repaint_all();
    }
    
    g_imui_control_set.last_showed_floating_flag = mmi_imui_get_floating_control_set();

    g_imui_control_set.last_showed_floating_state = mmi_imc_get_state();
    
    return MMI_IMUI_RESULT_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_floating_ui_height
 * DESCRIPTION
 *  Get the height of floating UI controls
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static S32 mmi_imui_get_floating_ui_height(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 ui_set = mmi_imui_get_floating_control_set();
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    if (!ui_set)
    {
        return 0;
    }

    return mmi_imui_get_imui_height_by_ui_set(ui_set);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_floating_control_set
 * DESCRIPTION
 *  Get current floating control set
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static U32 mmi_imui_get_floating_control_set(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U32 ui_set = 0;
#ifdef __MMI_IME_PLUG_IN__
    U32 custom_control;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_IME_PLUG_IN__
    custom_control = g_imui_control_set.showed_flag & mmi_ime_sdk_get_custom_control_mask();
    custom_control = mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_GET_CURRENT_FLOATING_CONTROL_SET,
                                              custom_control,
                                              0);
    custom_control &= mmi_ime_sdk_get_custom_control_mask();
    if (custom_control != 0)
    {
        ui_set |= custom_control;
    }
    else
#endif
    {
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)) && 
            (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) &&
            !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_RESERVE))
        {
            ui_set |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA);
        }
    
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) && 
            (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) &&
            !(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_RESERVE) && 
            !(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE))
        {
            ui_set |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA);
        }


    #if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA)) &&
            (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING))
        {
            ui_set |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_INPUT_AREA);    
        }
    #endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/
  
    
    #if defined(__MMI_IME_FTE_ENHANCE__)
        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) && 
            (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE))
        {
            ui_set |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA);
        }
    #endif
    
    #ifdef __MMI_CLIPBOARD_FLOATING_MENU__
        if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CLIPBOARD_FLOATING_MENU))
        {
            ui_set |= MMI_IMUI_CONTROL_MASK(MMI_IMUI_CLIPBOARD_FLOATING_MENU);
        }
    #endif /* __MMI_CLIPBOARD_FLOATING_MENU__ */
    }

    return ui_set;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_floating_ui_position
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_imui_get_floating_ui_position(mmi_imc_rect_p editor_rect, mmi_imc_rect_p cursor_rect, mmi_imc_point_p pos)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
        
    S32 ui_height = 0;
    #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
    mmi_imc_message_struct imc_message;
    #endif
    S32 bottom_y = 0, scroll_bar_width = 0, reduced_height = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    ui_height = mmi_imui_get_floating_ui_height();

    if (ui_height <= 0)
    {
        return MMI_FALSE;
    }
    
    if (cursor_rect->y + cursor_rect->height - 1 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR + ui_height - 1 
        >= g_imui_ui_param.imui_bottom - mmi_imc_get_current_imui_height_skip_fixed_editor() + 1)
    {
        bottom_y = cursor_rect->y - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR;

        if (bottom_y - ui_height <= editor_rect->y)
        {
            bottom_y = g_imui_ui_param.imui_bottom - mmi_imc_get_current_imui_height_skip_fixed_editor();

            reduced_height = ui_height - (g_imui_ui_param.imui_bottom - mmi_imc_get_current_imui_height_skip_fixed_editor() 
                             - (cursor_rect->y + cursor_rect->height - 1 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR) + 1);

            MMI_ASSERT(reduced_height >= 0);
        }
    }
    else
    {
        bottom_y = cursor_rect->y + cursor_rect->height - 1 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR + ui_height - 1;
    }

    pos->x = 0;
    pos->y = 0;
    
    if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)) && 
        (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) &&
        !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_RESERVE))    /*Draw candidate box area*/
    {
    #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
        if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
        {
            S32 x;
            S32 fixed_ui_height = mmi_imc_get_current_imui_height_skip_fixed_editor();
            S32 list_height = MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_HEIGHT;
            S32 reduced_height_below = 0, reduced_height_above = 0;
            S32 cursor_x1 = cursor_rect->x, cursor_y1 = cursor_rect->y;
            S32 cursor_x2 = cursor_rect->x + cursor_rect->width - 1, cursor_y2 = cursor_rect->y + cursor_rect->height - 1;
        #if defined(__MMI_TOUCH_SCREEN__)
            kal_bool is_enabled, is_pen_down;
        #endif
            
            imc_message.message_id = MMI_IMC_MESSAGE_GET_EDITOR_SCROLL_BAR_WIDTH; 

            scroll_bar_width = (S32)mmi_imc_send_message(&imc_message);
        
        #if defined(__MMI_TOUCH_SCREEN__)
            mmi_pen_get_state(&is_enabled, &is_pen_down);

            if (is_enabled && is_pen_down && g_imui_pen_down_control == MMI_IMUI_CANDIDATE_AREA)
            {
                x = g_imui_vertical_candidate_list.x;
                bottom_y = g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA];
            }
            else
        #endif    
            {
                if (cursor_rect->x + (g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH * 2) 
                    < editor_rect->x + editor_rect->width - scroll_bar_width)
                {
                    x = cursor_rect->x;
                }
                else
                {
                    x = editor_rect->x + editor_rect->width - scroll_bar_width - 1 - (g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH * 2);
                
                    if (x < 0)
                    {
                        x = editor_rect->x + editor_rect->width - scroll_bar_width - 1;

                        if (x + g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH * 2 > UI_device_width)
                        {
                            x = UI_device_width - (g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH * 2);
                        }
                    }
                }

                do 
                {
                    if (cursor_y2 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR + list_height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1 
                        <= g_imui_ui_param.imui_bottom - fixed_ui_height)
                    {
                        bottom_y = cursor_y2 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR + list_height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1;
                        break;
                    }    
                    else 
                    {
                        reduced_height_below = list_height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - (g_imui_ui_param.imui_bottom - fixed_ui_height 
                            - (cursor_y2 + MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR) + 1);
                    
                        if (cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR - list_height - 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH + 1
                            >= editor_rect->y)
                        {
                            bottom_y = cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR;
                            break;
                        }
                        else
                        {
                            reduced_height_above = list_height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - ((cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR) - editor_rect->y + 1);
                        }    
                    }
                
                    if (reduced_height_above < reduced_height_below)
                    {
                        reduced_height = reduced_height_above;
                    }
                    else
                    {
                        reduced_height = reduced_height_below;
                    }    
                
                    if (list_height - reduced_height >= g_imui_vertical_candidate_list_data.height * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_MIN_ITEM_COUNT)
                    {
                        list_height -= reduced_height;
                    }
                    else 
                    {
                        bottom_y = cursor_y1 - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR;
                    
                        list_height = MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_HEIGHT;
                    
                        if (bottom_y - (list_height + 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH) + 1
                            >= MMI_status_bar_height)
                        {
                            break;
                        }
                        else
                        {
                            list_height = bottom_y - MMI_status_bar_height - 2 * MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH + 1;
                        }    
                    
                        break;
                    }    
                
                } while(list_height);
            }    

            pos->x = x;
        }
        else
    #endif /* #if defined(__MMI_IME_VERTICAL_CAND_BOX__) */
        {
            if (reduced_height > 0)
            {
                bottom_y = cursor_rect->y - MMI_IMUI_FLOATING_CANDIDATE_BOX_GAP_FROM_CURSOR;
            }

            bottom_y -= (MMI_IMUI_CANDIDATE_BOX_BOTTOM_GAP + MMI_IMUI_CANDIDATE_BOX_TOP_GAP + g_imui_candidate_box.height);

            pos->x = g_imui_ui_param.imui_left + MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE + MMI_IMUI_CANDIDATE_BOX_LEFT_GAP;
        }
    }

    if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) && 
        (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) &&
        !(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_RESERVE) && 
        !(g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE))    
    {
        bottom_y -= (MMI_IMUI_COMPOSITION_BOX_BOTTOM_GAP + MMI_IMUI_COMPOSITION_BOX_TOP_GAP + g_imui_composition_box.height);

        pos->x = g_imui_ui_param.imui_left + MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE + MMI_IMUI_COMPOSITION_BOX_LEFT_GAP;
    }

#if defined(__MMI_IME_FTE_ENHANCE__)
    if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
        (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE))
    {
        MMI_ASSERT((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)));

        if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA)) && 
            (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING) &&
            !(g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_RESERVE))
        {
            bottom_y = bottom_y - g_imui_resizable_composition_box.height + MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT;
            pos->x = g_imui_ui_param.imui_left + MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE + MMI_IMUI_CANDIDATE_BOX_LEFT_GAP;
        }
        else
        {
            bottom_y = UI_device_height - 1 - mmi_imc_get_current_imui_height_skip_fixed_editor() - g_imui_resizable_composition_box.height + MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT;
            pos->x = g_imui_ui_param.imui_left;
        }
    }
#endif

    pos->y = bottom_y + 1;

    return MMI_TRUE;
}


#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_check_floating_ui_cover_ime_indicator
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL mmi_imui_check_floating_ui_cover_ime_indicator(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_imc_rect_p indicator_rect = NULL;
    mmi_imc_point point;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_INFORMATION_BAR))
    {
        indicator_rect = &g_imui_information_bar_rect;
    }
    else if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_HINT_AREA))
    {
        indicator_rect = &g_imui_ime_hint_rect;
    }
	else if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_IME_INDICATOR_AREA_FLOATING))
    {
        indicator_rect = &g_imui_indicator_rect_floating;
    }
    else 
    {
        return MMI_FALSE;
    }

    point.x = indicator_rect->x;
    point.y = indicator_rect->y;
    
    if (mmi_imui_check_floating_ui_contain_point(&point))
    {
        return MMI_TRUE;
    }

    point.x = indicator_rect->x;
    point.y = indicator_rect->y + indicator_rect->height - 1;
    
    if (mmi_imui_check_floating_ui_contain_point(&point))
    {
        return MMI_TRUE;
    }

    point.x = indicator_rect->x + indicator_rect->width - 1;
    point.y = indicator_rect->y;
    
    if (mmi_imui_check_floating_ui_contain_point(&point))
    {
        return MMI_TRUE;
    }

    point.x = indicator_rect->x + indicator_rect->width - 1;
    point.y = indicator_rect->y + indicator_rect->height - 1;
    
    if (mmi_imui_check_floating_ui_contain_point(&point))
    {
        return MMI_TRUE;
    }

    return MMI_FALSE;
}
#endif /*#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)*/


#if defined(__MMI_TOUCH_SCREEN__) && defined(__MMI_VUI_ENGINE__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_floating_ui_pen_down_event
 * DESCRIPTION
 *  Floating IMUI pen down handler
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static U32 mmi_imui_floating_ui_pen_down_event(mmi_pen_point_struct *pos, mmi_imui_command_funcptr command_callback)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 no_of_control_set = 0;
    MMI_BOOL ret = MMI_FALSE; 
    mmi_imui_message_struct mes_str;
    mmi_imui_selection_area_pen_event_enum selection_event = MMI_IMUI_SELECTION_AREA_PEN_NONE;
    #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
    gui_list_pen_enum list_event;  
    #endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for(; no_of_control_set < g_imui_control_set.number_of_controls; no_of_control_set++)
    {
        switch(g_imui_control_set.control_set[no_of_control_set])
        {
            case MMI_IMUI_CANDIDATE_AREA:
                if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA))
                     && mmi_imc_get_state() != MMI_IMC_STATE_MULTITAP 
                     && (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING))
                {
                #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
                    if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
                    {
                        ret = gui_fixed_list_menu_translate_pen_event(
                                  &g_imui_vertical_candidate_list,
                                  MMI_PEN_EVENT_DOWN,
                                  pos->x, pos->y, &list_event);

                        if (ret)
                        {
                            vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA));
                            
                            g_imui_pen_down_control = MMI_IMUI_CANDIDATE_AREA;

                            if (list_event == GUI_LIST_PEN_HIGHLIGHT_CHANGED)
                            {
                                mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_CANDIDATE_BOX;
                                mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
                                mes_str.param_1 = 0;
                                command_callback(&mes_str);
                            }
                        }
                    }
                    else
                 #endif /* #if defined(__MMI_IME_VERTICAL_CAND_BOX__) */    
                    {
                        ret = mmi_imui_selection_area_translate_pen_event(&g_imui_candidate_box, MMI_PEN_EVENT_DOWN,
                                                                    pos->x, pos->y, &selection_event);
                        if (ret)
                        {
                            vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA));
                        
                            g_imui_pen_down_control = MMI_IMUI_CANDIDATE_AREA;
        
                            if (selection_event != MMI_IMUI_SELECTION_AREA_PEN_NONE)
                            {
                                mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_CANDIDATE_BOX;
                                mes_str.param_0 = (U32)selection_event;
                                mes_str.param_1 = 0;
                                command_callback(&mes_str);
                            }
                        }
                    }
                }
                break;
                
            case MMI_IMUI_COMPOSITION_AREA:
                if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA))
                    && ((g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
                        || (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE)))
                {
                #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
                    if (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE)
                    {
                        ret = (MMI_BOOL) PEN_CHECK_BOUND(
                                pos->x,
                                pos->y,
                                g_imui_resizable_composition_box.x,
                                g_imui_resizable_composition_box.y,
                                g_imui_resizable_composition_box.width,
                                g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT);

                        if (ret)
                        {
                            g_imui_pen_down_control = MMI_IMUI_COMPOSITION_AREA;

    						mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_COMPOSITION_BOX;
    						mes_str.param_0 = MMI_IMUI_SELECTION_AREA_PEN_TEXT;
    						mes_str.param_1 = 0;
    						command_callback(&mes_str);
                        }
                    }
                    else
                #endif
                    {
                        ret = mmi_imui_selection_area_translate_pen_event(&g_imui_composition_box, MMI_PEN_EVENT_DOWN,
                                                                    pos->x, pos->y, &selection_event);
                        if (ret)
                        {
                            vadp_p2v_redraw_imui_controls(MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA));
                        
                            g_imui_pen_down_control = MMI_IMUI_COMPOSITION_AREA;
        
                            if (selection_event != MMI_IMUI_SELECTION_AREA_PEN_NONE)
                            {
                                mes_str.message_id = MMI_IMUI_MESSAGE_PEN_DOWN_IN_COMPOSITION_BOX;
                                mes_str.param_0 = (U32)selection_event;
                                mes_str.param_1 = 0;
                                command_callback(&mes_str);
                            }
                        }
                    }
                }
                break;
                
            default:
                break;
        }
        
        if (ret)
        {
            break;
        }
        else
        {
            g_imui_pen_down_control = MMI_IMUI_CONTROL_MAX;
        }
    }
    
    if (ret)
    {
        return MMI_IMUI_RESULT_TRUE;
    }
    else
    {
        return MMI_IMUI_RESULT_FALSE;
    }
        
}
#endif /* #if defined(__MMI_TOUCH_SCREEN__) */


#if defined(__MMI_IME_VERTICAL_CAND_BOX__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_vertical_candidate_list
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static S32 mmi_imui_update_vertical_candidate_list(mmi_imui_update_selection_area_struct_p update_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i, str_len = 0;
    UI_string_type temp_ptr = NULL;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_ASSERT(update_ptr->count <= MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN_VER);

    temp_ptr = update_ptr->str_ptr;
   
    for (i = 0; i < update_ptr->count; i++)
    {
    #if defined(__MMI_IME_USER_DATABASE__)
        if (*temp_ptr == MMI_IME_USER_DATABASE_NEW_WORD)
        {
            //MMI_ASSERT(update_ptr->count == 1);

            g_imui_veritical_candidate_list_items[i].item_text = g_imui_new_word_prompt_ptr;
            g_imui_veritical_candidate_list_items[i].flags &= ~UI_LIST_MENU_STATE_FOCUSSED;
            
            str_len = mmi_ucs2strlen((const S8 *)g_imui_new_word_prompt_ptr);
        }
        else
    #endif
        {
            g_imui_veritical_candidate_list_items[i].item_text = temp_ptr;
            g_imui_veritical_candidate_list_items[i].flags &= ~UI_LIST_MENU_STATE_FOCUSSED;
            
            str_len = mmi_ucs2strlen((const S8 *)temp_ptr);
        }
    
        temp_ptr += (str_len + 1);
    }

    g_imui_vertical_candidate_list.n_items = update_ptr->count;

    g_imui_vertical_candidate_list.highlighted_item = -1;

    gui_set_font(g_imui_vertical_candidate_list_data.text_font);

    gui_auto_resize_fixed_list_menu(&g_imui_vertical_candidate_list, 
                                   g_imui_ui_param.imui_width - MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE * 2, 
                                   g_imui_vertical_candidate_list.height);

    gui_resize_fixed_list_menu(&g_imui_vertical_candidate_list, g_imui_vertical_candidate_list.width, MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_HEIGHT);

    /* imui_floating_width should be updated to be same with vertical candidate list width in Venus */
    g_imui_ui_param.imui_floating_width = g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH * 2; 
    g_imui_ui_param.imui_floating_left = g_imui_ui_param.imui_left + MMI_IMUI_FLOATING_CANDIDATE_BOX_OFFSET_FROM_EDITOR_LEFT_EDGE - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH;
    
    gui_fixed_list_menu_goto_item(&g_imui_vertical_candidate_list, update_ptr->highlight_index);

    return update_ptr->count;
}

 

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_verical_candidate_list
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static S32 mmi_imui_draw_verical_candidate_list(S32 x, S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA] = bottom_line;

    gui_move_fixed_list_menu(
        &g_imui_vertical_candidate_list, 
        x, 
        bottom_line - g_imui_vertical_candidate_list.height - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH + 1);

    gdi_layer_lock_frame_buffer();

#if defined(__MMI_VUI_ENGINE__)
    if (!vadp_p2v_uc_is_in_venus())
#endif
    {
        if (g_imui_vertical_candidate_list_stop_cursor)
        {
            UI_inputbox_start_cursor();
            
            g_imui_vertical_candidate_list_stop_cursor = UI_inputbox_stop_cursor(g_imui_vertical_candidate_list.x - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH, 
                                                             g_imui_vertical_candidate_list.y - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH, 
                                                             g_imui_vertical_candidate_list.x + g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1, 
                                                             g_imui_vertical_candidate_list.y + g_imui_vertical_candidate_list.height + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1);
            
            if (!g_imui_vertical_candidate_list_stop_cursor)
            {
                UI_inputbox_start_cursor();
            }
        }
        else
        {
            g_imui_vertical_candidate_list_stop_cursor = UI_inputbox_stop_cursor(g_imui_vertical_candidate_list.x - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH, 
                                                             g_imui_vertical_candidate_list.y - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH, 
                                                             g_imui_vertical_candidate_list.x + g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1, 
                                                             g_imui_vertical_candidate_list.y + g_imui_vertical_candidate_list.height + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1);
        }    
    }

    mmi_imui_draw_vertical_candidate_list_background();

    g_imui_vertical_candidate_list.act_lcd_handle = GDI_LCD_MAIN_LCD_HANDLE;
    gdi_layer_get_active(&g_imui_vertical_candidate_list.act_layer_handle);
    g_imui_vertical_candidate_list.alpha_blend_layer_handle = g_imui_vertical_candidate_list.act_layer_handle;
    
    
    gui_vertical_scrollbar_set_target_layer(&g_imui_vertical_candidate_list.vbar, g_imui_vertical_candidate_list.act_layer_handle);
    gui_vertical_scrollbar_set_alpha_blend_layer(&g_imui_vertical_candidate_list.vbar, g_imui_vertical_candidate_list.alpha_blend_layer_handle);
    gui_vertical_scrollbar_register_hide_callback(&g_imui_vertical_candidate_list.vbar, mmi_imui_draw_vertical_candidate_list_vbar_background);



    gui_show_fixed_list_menu(&g_imui_vertical_candidate_list);

    gdi_layer_unlock_frame_buffer();

    gdi_layer_blt_previous(
        g_imui_vertical_candidate_list.x - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH, 
        g_imui_vertical_candidate_list.y - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH, 
        g_imui_vertical_candidate_list.x + g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1, 
        g_imui_vertical_candidate_list.y + g_imui_vertical_candidate_list.height + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1);

    return bottom_line - (g_imui_vertical_candidate_list.height + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH * 2);
}



/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_vertical_candidate_list_background
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_vertical_candidate_list_background(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i = 0;
    gdi_color border_color;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    gui_draw_filled_area(
        g_imui_vertical_candidate_list.x - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH, 
        g_imui_vertical_candidate_list.y - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH, 
        g_imui_vertical_candidate_list.x + g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1, 
        g_imui_vertical_candidate_list.y + g_imui_vertical_candidate_list.height + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1,
        current_MMI_theme->cascade_menu_background_filler);

    border_color = gdi_act_color_from_rgb(100, 
        255 - current_MMI_theme->cascade_menu_background_filler->c.r, 
        255 - current_MMI_theme->cascade_menu_background_filler->c.g, 
        255 - current_MMI_theme->cascade_menu_background_filler->c.b);
    

    for (i = MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH; i > 0; i--)
    {
        gdi_draw_rect(
            g_imui_vertical_candidate_list.x - i, 
            g_imui_vertical_candidate_list.y - i, 
            g_imui_vertical_candidate_list.x + g_imui_vertical_candidate_list.width + i - 1, 
            g_imui_vertical_candidate_list.y + g_imui_vertical_candidate_list.height + i - 1,
            border_color);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_vertical_candidate_list_vbar_background
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_vertical_candidate_list_vbar_background(S32 x1, S32 y1, S32 x2, S32 y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	gui_push_clip();

	gui_set_clip(x1, y1, x2, y2);

	gui_draw_filled_area(
        g_imui_vertical_candidate_list.x - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH, 
        g_imui_vertical_candidate_list.y - MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH, 
        g_imui_vertical_candidate_list.x + g_imui_vertical_candidate_list.width + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1, 
        g_imui_vertical_candidate_list.y + g_imui_vertical_candidate_list.height + MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH - 1,
        current_MMI_theme->cascade_menu_background_filler);

	gui_pop_clip();

}
#endif /* #if defined(__MMI_IME_VERTICAL_CAND_BOX__) */
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_vertical_composition_list
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static S32 mmi_imui_update_vertical_composition_list(mmi_imui_update_selection_area_struct_p update_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i, str_len = 0;
    UI_string_type temp_ptr = NULL;
    S32 vk_width=0, vk_height =0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    // MMI_ASSERT(update_ptr->count <= MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN_VER);

    temp_ptr = update_ptr->str_ptr;
#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    wgui_virtual_keyboard_get_dimension(&vk_width, &vk_height);
#endif

    for (i = 0; i < update_ptr->count; i++)
    {
        g_imui_vertical_composition_list_items[i].item_text = temp_ptr;
        g_imui_vertical_composition_list_items[i].flags &= ~UI_LIST_MENU_STATE_FOCUSSED;
        g_imui_vertical_composition_list_items[i].flags &= ~UI_LIST_MENU_DISABLE_SCROLLBAR;
        g_imui_vertical_composition_list_items[i].text_width = 0;
        g_imui_vertical_composition_list_items[i].text_height = 0;
        str_len = mmi_ucs2strlen((const S8 *)temp_ptr);
        temp_ptr += (str_len + 1);
    }
    g_imui_composition_box.flags = update_ptr->flags;
    g_imui_vertical_composition_list.y = g_imui_ui_param.imui_bottom - (vk_height/4);
    g_imui_vertical_composition_list.height = vk_height - (vk_height/4);
    g_imui_vertical_composition_list.width =wgui_virtual_keyboard_return_floating_composition_box_width();
    //g_imui_vertical_composition_list_data.width = wgui_virtual_keyboard_return_floating_composition_box_width();
    g_imui_vertical_composition_list.n_items = update_ptr->count;

    g_imui_vertical_composition_list.highlighted_item = -1;

    gui_set_font(g_imui_vertical_composition_list_data.text_font);

    /*gui_auto_resize_fixed_list_menu(&g_imui_vertical_composition_list, 
    vk_width/5, 
    g_imui_vertical_composition_list.height);*/


    //gui_resize_fixed_list_menu(&g_imui_vertical_composition_list, g_imui_vertical_composition_list.width, MMI_IMUI_VERTICAL_COMPOSITION_BOX_HEIGHT);
    gui_resize_fixed_icontext_menuitem(&g_imui_vertical_composition_list_data, wgui_virtual_keyboard_return_floating_composition_box_width(),vk_height/5);
    gui_fixed_list_menu_goto_item(&g_imui_vertical_composition_list, update_ptr->highlight_index);

    return update_ptr->count;
}

 

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_verical_composition_list
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static S32 mmi_imui_draw_vertical_composition_list(S32 x, S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	S32 vk_width=0, vk_height =0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	#if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
    wgui_virtual_keyboard_get_dimension(&vk_width, &vk_height);
	#endif
    //g_imui_control_set.control_bottoms[MMI_IMUI_CANDIDATE_AREA] = bottom_line;

    gui_move_fixed_list_menu(
        &g_imui_vertical_composition_list, 
        x, 
        bottom_line - (vk_height/4)  - g_imui_vertical_composition_list.height + 1);    // it moved the list to wrong y...

    gdi_layer_lock_frame_buffer();

    mmi_imui_draw_vertical_composition_list_background();

    g_imui_vertical_composition_list.act_lcd_handle = GDI_LCD_MAIN_LCD_HANDLE;
    gdi_layer_get_active(&g_imui_vertical_composition_list.act_layer_handle);
    g_imui_vertical_composition_list.alpha_blend_layer_handle = g_imui_vertical_composition_list.act_layer_handle;
    g_imui_vertical_composition_list_data.flags |= UI_MENUITEM_CENTER_TEXT_X;
    
    gui_vertical_scrollbar_set_target_layer(&g_imui_vertical_composition_list.vbar, g_imui_vertical_composition_list.act_layer_handle);
    gui_vertical_scrollbar_set_alpha_blend_layer(&g_imui_vertical_composition_list.vbar, g_imui_vertical_composition_list.alpha_blend_layer_handle);
    gui_vertical_scrollbar_register_hide_callback(&g_imui_vertical_composition_list.vbar, mmi_imui_draw_vertical_composition_list_vbar_background);

	gui_fixed_icontext_menuitem_start_scroll();
    gui_show_fixed_list_menu(&g_imui_vertical_composition_list);

    gdi_layer_unlock_frame_buffer();

    gdi_layer_blt_previous(
        g_imui_vertical_composition_list.x , 
        g_imui_vertical_composition_list.y , 
        g_imui_vertical_composition_list.x + g_imui_vertical_composition_list.width - 1, 
        g_imui_vertical_composition_list.y + g_imui_vertical_composition_list.height - 1);

    return bottom_line - (g_imui_vertical_composition_list.height );
}



/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_vertical_composition_list_background
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_vertical_composition_list_background(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i = 0;
    //gdi_color border_color;
	gdi_handle layer, old_layer;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
   gdi_layer_get_active(&layer);
	old_layer = gdi_set_alpha_blending_source_layer(layer);
    gui_draw_filled_area(
        g_imui_vertical_composition_list.x , 
        g_imui_vertical_composition_list.y , 
        g_imui_vertical_composition_list.x + g_imui_vertical_composition_list.width - 1, 
        g_imui_vertical_composition_list.y + g_imui_vertical_composition_list.height - 1,
         &scrolling_box_normal_filler);

	gdi_set_alpha_blending_source_layer(old_layer);
    /*border_color = gdi_act_color_from_rgb(100, 
        255 - current_MMI_theme->cascade_menu_background_filler->c.r, 
        255 - current_MMI_theme->cascade_menu_background_filler->c.g, 
        255 - current_MMI_theme->cascade_menu_background_filler->c.b);*/
    

    /*for (i = MMI_IMUI_FLOATING_VERTICAL_CANDIDATE_BOX_BORDER_WIDTH; i > 0; i--)
    {
        gdi_draw_rect(
            g_imui_vertical_composition_list.x - i, 
            g_imui_vertical_composition_list.y - i, 
            g_imui_vertical_composition_list.x + g_imui_vertical_composition_list.width + i - 1, 
            g_imui_vertical_composition_list.y + g_imui_vertical_composition_list.height + i - 1,
            border_color);
    }*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_vertical_composition_list_vbar_background
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_vertical_composition_list_vbar_background(S32 x1, S32 y1, S32 x2, S32 y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	gui_push_clip();

	gui_set_clip(x1, y1, x2, y2);

	gui_draw_filled_area(
        g_imui_vertical_composition_list.x , 
        g_imui_vertical_composition_list.y , 
        g_imui_vertical_composition_list.x + g_imui_vertical_composition_list.width - 1, 
        g_imui_vertical_composition_list.y + g_imui_vertical_composition_list.height - 1,
        &scrolling_box_normal_filler);

	gui_pop_clip();

}
#endif 


#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_check_floating_ui_contain_point
 * DESCRIPTION
 * 
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL mmi_imui_check_floating_ui_contain_point(mmi_imc_point_p point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 no_of_control_set = 0;
    MMI_BOOL ret = MMI_FALSE; 
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for(; no_of_control_set < g_imui_control_set.number_of_controls; no_of_control_set++)
    {
        switch(g_imui_control_set.control_set[no_of_control_set])
        {
            case MMI_IMUI_CANDIDATE_AREA:
                if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA))
                {
                #if defined(__MMI_IME_VERTICAL_CAND_BOX__)
                    if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
                    {
                        ret = (MMI_BOOL) PEN_CHECK_BOUND(
                                point->x,
                                point->y,
                                g_imui_vertical_candidate_list.x,
                                g_imui_vertical_candidate_list.y,
                                g_imui_vertical_candidate_list.width,
                                g_imui_vertical_candidate_list.height);
                    }
                    else
                #endif /* #if defined(__MMI_IME_VERTICAL_CAND_BOX__) */
                    {
                        if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
                        {
                            ret = (MMI_BOOL) PEN_CHECK_BOUND(
                                    point->x,
                                    point->y,
                                    g_imui_candidate_box.x,
                                    g_imui_candidate_box.y,
                                    g_imui_candidate_box.width,
                                    g_imui_candidate_box.height);
                        }
                    }
                }
                break;
                
            case MMI_IMUI_COMPOSITION_AREA:
                if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA))
                {
                #if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
                    if (g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_AUTO_RESIZABLE)
                    {
                        ret = (MMI_BOOL) PEN_CHECK_BOUND(
                                    point->x,
                                    point->y,
                                    g_imui_resizable_composition_box.x,
                                    g_imui_resizable_composition_box.y,
                                    g_imui_resizable_composition_box.width,
                                    g_imui_resizable_composition_box.height);
                    }
                    else
                #endif
                    {
                        if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
                        {
                            ret = (MMI_BOOL) PEN_CHECK_BOUND(
                                        point->x,
                                        point->y,
                                        g_imui_composition_box.x,
                                        g_imui_composition_box.y,
                                        g_imui_composition_box.width,
                                        g_imui_composition_box.height);
                        }
                    }
                }
                break;
                
            default:
                break;
        }
        
        if (ret)
        {
            return MMI_TRUE;
        }
    }

    return MMI_FALSE;
}
#endif /*#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)*/
#endif /* #if defined(__MMI_IME_FLOATING_CAND_BOX__) */


#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_check_ui_contain_point
 * DESCRIPTION
 * 
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL mmi_imui_check_ui_contain_point(mmi_imc_point_p point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 no_of_control_set = 0;
    MMI_BOOL ret = MMI_FALSE; 
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for(; no_of_control_set < g_imui_control_set.number_of_controls; no_of_control_set++)
    {
        switch(g_imui_control_set.control_set[no_of_control_set])
        {
            case MMI_IMUI_CANDIDATE_AREA:
                if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_CANDIDATE_AREA))
                {

                            ret = (MMI_BOOL) PEN_CHECK_BOUND(
                                    point->x,
                                    point->y,
                                    g_imui_candidate_box.x,
                                    g_imui_candidate_box.y,
                                    g_imui_candidate_box.width,
                                    g_imui_candidate_box.height);
                    
                }
                break;
                
            case MMI_IMUI_COMPOSITION_AREA:
                if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA))
                {
                            ret = (MMI_BOOL) PEN_CHECK_BOUND(
                                        point->x,
                                        point->y,
                                        g_imui_composition_box.x,
                                        g_imui_composition_box.y,
                                        g_imui_composition_box.width,
                                        g_imui_composition_box.height);
                }
                break;
            default:
                break;
        }

        if (ret)
        {
            return MMI_TRUE;
        }
    }

    return MMI_FALSE;
}
#endif /*#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)*/


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_back_ground
 * DESCRIPTION
 *  Redraw back ground for specified rectangle
 * PARAMETERS
 *  x1        [IN]     Left top x
 *  y1        [IN]     Left top y
 *  x2        [IN]     Right bottom x
 *  y2        [IN]     Right bottom y
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_back_ground(S32 x1, S32 y1, S32 x2, S32 y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
	gui_push_clip();

	gui_set_clip(x1, y1, x2, y2);

	if (g_imui_redraw_funcptr != NULL)
	{
		g_imui_redraw_funcptr(x1, y1, x2, y2);
	}
	else
	{
		gdi_draw_solid_rect(x1, y1, x2, y2, GDI_COLOR_TRANSPARENT);
	}
	gui_pop_clip();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_string
 * DESCRIPTION
 *  Draw string function for imui
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_string(
                S32 x,
                S32 y,
                S32 baseline,
                const UI_character_type *str_ptr,
                S32 str_len,
                UI_font_type type,
                color c)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_imui_draw_string_int(x, y, baseline, str_ptr, str_len, type, c, MMI_FALSE);
}

#if defined(__MMI_IME_CANDIDATE_GRID__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_string_grid
 * DESCRIPTION
 *  Draw string function for imui
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_string_grid(
                S32 x,
                S32 y,
                S32 baseline,
                const UI_character_type *str_ptr,
                S32 str_len,
                UI_font_type type,
                color c)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    UI_font_type font_backup;
    S32 w = 0, h = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (str_len <= 0)
        return;

    font_backup = UI_font;
    gui_set_font(type);
    if (mmi_fe_get_r2l_state())
    {
        gui_measure_string_n((UI_string_type) str_ptr, (int)str_len, &w, &h);
        x += (w - 1);
    }
    gui_set_text_color(c);
    gui_move_text_cursor(x, y);

    gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);
	if (baseline == -1)
	{
        gui_print_text_n((UI_string_type) str_ptr, (int)str_len);
	}
	else
	{
        ShowString_n(x, y, *type, 0, (U8*)str_ptr, str_len, baseline);
	}	
	gdi_pop_and_restore_alpha_blending_source_layer();
    gui_set_font(font_backup);
}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_string_r2l
 * DESCRIPTION
 *  Draw string function for imui
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_string_r2l(
                S32 x,
                S32 y,
                S32 baseline,
                const UI_character_type *str_ptr,
                S32 str_len,
                UI_font_type type,
                color c)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_imui_draw_string_int(x, y, baseline, str_ptr, str_len, type, c, MMI_TRUE);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_string_r2l
 * DESCRIPTION
 *  Draw string function for imui
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_string_int(
                S32 x,
                S32 y,
                S32 baseline,
                const UI_character_type *str_ptr,
                S32 str_len,
                UI_font_type type,
                color c,
                MMI_BOOL flag_R2l)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    UI_font_type font_backup;
    S32 w = 0, h = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (str_len <= 0)
        return;

    font_backup = UI_font;
    gui_set_font(type);
    if (mmi_fe_get_r2l_state())
    {
        gui_measure_string_n((UI_string_type) str_ptr, (int)str_len, &w, &h);
        x += (w - 1);
    }
    gui_set_text_color(c);
    gui_move_text_cursor(x, y);

    gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);
	if (baseline == -1)
	{
        gui_print_text_n((UI_string_type) str_ptr, (int)str_len);
	}
	else
	{
	    if (flag_R2l)
        {
            mmi_fe_show_string_baseline(x, y, (U8*)str_ptr, baseline, BIDI_R);
        }
        else
        {
            ShowString_n_baseline(x, y, *type, 0, (U8*)str_ptr, str_len, baseline);
        }
	}	
	gdi_pop_and_restore_alpha_blending_source_layer();
    gui_set_font(font_backup);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_string_for_selection_area
 * DESCRIPTION
 *  Draw string function for selection area
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_string_for_selection_area(
                mmi_imui_selection_area_struct_p area_ptr,
                S32 x,
                S32 y,
                S32 baseline,
                const UI_character_type *str_ptr,
                S32 str_len,
                UI_font_type type,
                color c)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UI_character_type temp_string[MMI_IMC_MAX_INPUT_SYMBOL_BUFFSIZE * 2 + 1];
    S32 i = 0, j = 0;
        #if defined (__MMI_MULTITAP_BANGLA_SPEC__) && defined(__MMI_VECTOR_FONT_SUPPORT__)
    const UI_character_type string1[] = {0xA42f,'\0'}; 
    const UI_character_type string2[] = {0xA430,'\0'};
    const UI_character_type string3[] = {0xA431,'\0'};
#endif
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_SPACE_AFTER_APOSTROPHE)
    if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_SPACE_AFTER_APOSTROPHE)
    {
        while(str_ptr[i] != 0)
        {
            if (str_ptr[i] == 0x0027)
            {
                temp_string[j++] = str_ptr[i++];
                temp_string[j++] = 0x0020;
            }
            else
            {
                temp_string[j++] = str_ptr[i++];
            }
        }
    
        MMI_ASSERT(j <= MMI_IMC_MAX_INPUT_SYMBOL_BUFFSIZE * 2);
    
        temp_string[j] = 0;
        
        mmi_imui_draw_string(x, y, baseline, &temp_string[0], j, type, c);
    }
    else
#endif /*MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_SPACE_AFTER_APOSTROPHE*/
    {
        #if defined (__MMI_MULTITAP_BANGLA_SPEC__)
#if defined(__MMI_VECTOR_FONT_SUPPORT__)
    if(str_ptr[0] == 0x09b0 && str_ptr[1] == 0x09cd )
	{
		str_ptr = string1;
	}
	else if(str_ptr[0] == 0x09cd && str_ptr[1]== 0x09b0 )
	{
		str_ptr = string3;
        }
	 else if(str_ptr[0] == 0x09cd && str_ptr[1] == 0x09af )
	{
		str_ptr = string2;
        }
#else
		if(str_ptr[0] == 0x09b0 && str_ptr[1]== 0x09cd)
			check_ra_hal_bangla_for_imui = MMI_TRUE;
#endif
#endif
        mmi_imui_draw_string(x, y, baseline, str_ptr, str_len, type, c);
		    #if defined (__MMI_MULTITAP_BANGLA_SPEC__)
		check_ra_hal_bangla_for_imui = MMI_FALSE;
#endif
    }
}
#if defined(__MMI_IME_CANDIDATE_GRID__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_string_for_selection_area_grid
 * DESCRIPTION
 *  Draw string function for selection area
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_string_for_selection_area_grid(
                mmi_imui_selection_area_grid_struct_p area_ptr,
                S32 x,
                S32 y,
                S32 baseline,
                const UI_character_type *str_ptr,
                S32 str_len,
                UI_font_type type,
                color c)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //UI_character_type temp_string[MMI_IMC_MAX_INPUT_SYMBOL_BUFFSIZE * 2 + 1];
    //S32 i = 0, j = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

        mmi_imui_draw_string_grid(x, y, baseline, str_ptr, str_len, type, c);

}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_char
 * DESCRIPTION
 *  Draw character
 * PARAMETERS
 *  x               [IN]        
 *  y               [IN]        
 *  char_code       [IN]        UCS2 code
 *  type            [IN]        font type
 *  c               [IN]        text color
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_char(S32 x, S32 y, S32 baseline, UI_character_type char_code, UI_font_type type, color c)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    UI_character_type temp[2];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    temp[0] = char_code;
    temp[1] = '\0';
    mmi_imui_draw_string(x, y, baseline, &temp[0], 1, type, c);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_selection_area
 * DESCRIPTION
 *  Draw character
 * PARAMETERS
 *  area_ptr       [IN]     Pointer of selection area structure
 *  update_ptr     [IN]     Pointer of new data
 * RETURNS
 *  How many candidate items have been included in this page
 *****************************************************************************/
static U32 mmi_imui_update_selection_area(mmi_imui_selection_area_struct_p area_ptr, mmi_imui_update_selection_area_struct_p update_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UI_string_type temp_str, temp_str_original;
    S32 temp_width, grid_width = 0, width, str_width, str_height;
    S32 temp_x;
    S32 i;
    S32 temp_index;
    S32 w, h;
    S32 candidate_count = 0;
    S32 num_of_one_more_pixel = 0;
    S32 num_pixel, added_pixels, offset_x, max_str_width = 0;
	mmi_lm_cluster_info cur_cluster;
    S32 left_arrow_separator_index = -1, right_arrow_separator_index = -1;
#if defined(__MMI_IME_FTE_ENHANCE__) 
    S32 img_width = 0, img_height = 0;
#endif
    S32 border_width = MMI_IMUI_CANDIDATE_BOX_BORDER_WIDTH;
    S32 min_candidate_width = 0, separator_y = MMI_IMUI_CANDIDATE_BOX_BORDER_WIDTH;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
   #if defined(__MMI_MULTITAP_BANGLA_SPEC__)	
	mmi_fe_enable_proprietary_symbol_display();
	#endif
    area_ptr->flags = update_ptr->flags;

    if (update_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_LARGE_FONT) 
    {
        area_ptr->font_text = &MMI_large_font;
    }
    else
    {
        area_ptr->font_text = g_imui_ui_theme.font_text;
    }

    area_ptr->baseline = 0;
    area_ptr->str_height = 0;

#if defined(__MMI_IME_FTE_ENHANCE__)    
    area_ptr->area_theme.separator_width = MMI_IMUI_FTE_CAND_BOX_SEPARATOR_WIDTH;
    separator_y = border_width;

    min_candidate_width = MMI_IMUI_FTE_CAND_BOX_HIGHLIGHT_WIDTH;

        /* The Arrow picture should overlap with the inter-border by 1 pixel */
    g_imui_ui_param.arrow_width = MMI_IMUI_FTE_CAND_BOX_ARROW_WIDTH - MMI_IMUI_CANDIDATE_BOX_INTER_BORDER_WIDTH;
    
#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

    temp_width = area_ptr->width;
    
    temp_x = 0;

    area_ptr->item_count = 0;
    temp_index = 0;
    
    temp_x += MMI_IMUI_SLECTION_AREA_LEFT_SPACING;
    temp_width -= (MMI_IMUI_SLECTION_AREA_LEFT_SPACING + MMI_IMUI_SLECTION_AREA_RIGHT_SPACING);

#if defined(__MMI_IME_FTE_ENHANCE__)
    /* For border */
    temp_width -= 2 * border_width;
    temp_x += border_width;
#else
    if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_BORDER)
    {
       temp_width -= 2 * border_width;
       temp_x += border_width;
    }
#endif  /* #if defined(__MMI_IME_FTE_ENHANCE__) */
    
    if ((area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_SHOW_ARROW) && (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_ARROW)) 
    {
        /* Left arrow */
        area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LEFT_ARROW;
        area_ptr->items[temp_index].indicator.x = temp_x + MMI_IMUI_ARROW_LEFT_SPACING;
        
    #if defined(__MMI_IME_FTE_ENHANCE__)
        /* The Arrow picture should overlap with the inter-border by 1 pixel */
        area_ptr->items[temp_index].indicator.x -= MMI_IMUI_CANDIDATE_BOX_INTER_BORDER_WIDTH;
    #endif
    
        area_ptr->items[temp_index].indicator.y = (area_ptr->height - g_imui_ui_param.arrow_height) / 2;

        area_ptr->items[temp_index].indicator.width = g_imui_ui_param.arrow_width;
        
        area_ptr->left_arrow_state = MMI_IMUI_ARROW_NORMAL;
        
        temp_x += (MMI_IMUI_ARROW_LEFT_SPACING + g_imui_ui_param.arrow_width + MMI_IMUI_ARROW_RIGHT_SPACING);
        temp_index++;
        temp_width -= (MMI_IMUI_ARROW_LEFT_SPACING + g_imui_ui_param.arrow_width + MMI_IMUI_ARROW_RIGHT_SPACING);

    //#if defined(__MMI_IME_FTE_ENHANCE__)
        if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR) /* The separator on the right side on left arrow */
        {
            area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR;
            left_arrow_separator_index = temp_index;
                        
            area_ptr->items[temp_index].indicator.x = temp_x;
            area_ptr->items[temp_index].indicator.y = separator_y;
            area_ptr->items[temp_index].indicator.width = area_ptr->area_theme.separator_width;
            
            temp_x += area_ptr->area_theme.separator_width;
            temp_index++;
            
            temp_width -= area_ptr->area_theme.separator_width;
        }
    //#endif

        /* Right arrow */
        area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_RIGHT_ARROW;
        area_ptr->items[temp_index].indicator.x = area_ptr->width - MMI_IMUI_SLECTION_AREA_RIGHT_SPACING - MMI_IMUI_ARROW_LEFT_SPACING - g_imui_ui_param.arrow_width;

    //#if defined(__MMI_IME_FTE_ENHANCE__)
        area_ptr->items[temp_index].indicator.x -= border_width;
    //#endif
    
        area_ptr->items[temp_index].indicator.y = (area_ptr->height - g_imui_ui_param.arrow_height) / 2;
        area_ptr->items[temp_index].indicator.width = g_imui_ui_param.arrow_width;

        area_ptr->right_arrow_state = MMI_IMUI_ARROW_NORMAL;
        
        temp_index++;

        temp_width -= (MMI_IMUI_ARROW_LEFT_SPACING + g_imui_ui_param.arrow_width + MMI_IMUI_ARROW_RIGHT_SPACING);

    //#if defined(__MMI_IME_FTE_ENHANCE__)
        if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR) /* The separator on the left side on right arrow */
        {
            area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR;
            right_arrow_separator_index = temp_index;
                        
            area_ptr->items[temp_index].indicator.x = area_ptr->width - MMI_IMUI_SLECTION_AREA_RIGHT_SPACING - 
                                                      MMI_IMUI_ARROW_LEFT_SPACING - g_imui_ui_param.arrow_width - 
                                                      MMI_IMUI_ARROW_RIGHT_SPACING - area_ptr->area_theme.separator_width;

            area_ptr->items[temp_index].indicator.x -= border_width;
            
            area_ptr->items[temp_index].indicator.y = separator_y;
            area_ptr->items[temp_index].indicator.width = area_ptr->area_theme.separator_width;
            
            temp_index++;
            
            temp_width -= area_ptr->area_theme.separator_width;
        }
    //#endif
    }

	#if defined(__MMI_IME_CANDIDATE_GRID__)
	if(area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_SHOW_EXPAND_BUTTON)
	{
		if(area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
		{
				area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_EXPAND;
				area_ptr->items[temp_index].indicator.x = area_ptr->x + MMI_IMUI_CAND_GRID_EXPAND_GAP;
				//area_ptr->items[temp_index].indicator.x -= border_width;
				area_ptr->items[temp_index].indicator.y = 0;
				area_ptr->items[temp_index].indicator.width = g_imui_ui_param.expand_button_width; 
				temp_index++;

				temp_width -=  (g_imui_ui_param.expand_button_width +  MMI_IMUI_CAND_GRID_EXPAND_GAP);
				area_ptr->expand_button_state = MMI_IMUI_ARROW_NORMAL;
		}
		else
		{
      area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_EXPAND;
        area_ptr->items[temp_index].indicator.x = area_ptr->x + area_ptr->width -  g_imui_ui_param.expand_button_width -  MMI_IMUI_CAND_GRID_EXPAND_GAP;
        //area_ptr->items[temp_index].indicator.x -= border_width;
        area_ptr->items[temp_index].indicator.y = 0;
        area_ptr->items[temp_index].indicator.width = g_imui_ui_param.expand_button_width; 
        temp_index++;

        temp_width -=  (g_imui_ui_param.expand_button_width + MMI_IMUI_CAND_GRID_EXPAND_GAP);
		area_ptr->expand_button_state = MMI_IMUI_ARROW_NORMAL;

				area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR;
	                        
				area_ptr->items[temp_index].indicator.x =  area_ptr->width -  g_imui_ui_param.expand_button_width -  MMI_IMUI_CAND_GRID_EXPAND_GAP - area_ptr->area_theme.separator_width;

				area_ptr->items[temp_index].indicator.y = separator_y;
				area_ptr->items[temp_index].indicator.width = area_ptr->area_theme.separator_width;
	            
				temp_index++;
	            
				temp_width -= area_ptr->area_theme.separator_width;
		}

	}
	#endif
    
#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_STAR)
    if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_STAR || area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_SHOW_STAR) /* Star */
    {
        area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_STAR;
        area_ptr->items[temp_index].indicator.x = temp_x + MMI_IMUI_STAR_LEFT_SPACING;
        
        mmi_imui_get_char_extent(area_ptr->font_text, '*', &w, &h);
        
        area_ptr->items[temp_index].indicator.char_code = '*';
        area_ptr->items[temp_index].indicator.y = (area_ptr->height - h) / 2;
        area_ptr->items[temp_index].indicator.width = w;
        
        temp_x += (MMI_IMUI_STAR_LEFT_SPACING + w + MMI_IMUI_STAR_RIGHT_SPACING);
        temp_index++;
        temp_width -= MMI_IMUI_STAR_LEFT_SPACING + w + MMI_IMUI_STAR_RIGHT_SPACING;
    }

    if (update_ptr->separator != 0)
    {
        temp_str = update_ptr->str_ptr;
        
        for (i = 0; i < update_ptr->count; i++) /* Replace every separator by 0 */
        {
            if (temp_str)
            {
                temp_str = (UI_string_type)mmi_ucs2chr((const S8 *)temp_str, update_ptr->separator);

                if (temp_str != NULL)
                {
                    (*temp_str) = 0;
                    (*(temp_str+1)) = 0;

                    temp_str += 2;
                }
            }
            else
            {
                MMI_ASSERT(0);
            }
        }
    }
#endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_STAR)*/

#if !defined(__MMI_IME_FTE_ENHANCE__)
    if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_BORDER)
    {
       //temp_width -= 2 * border_width;
       //temp_x += border_width;
    }
#endif
    
    if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_FIX_GRID) /* For only one character in a candidate item */
    {
        if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR)
        {
            width = temp_width + area_ptr->area_theme.separator_width; 
        }
		else
		{
		    width = temp_width;
        }
        
		temp_str = update_ptr->str_ptr;
        
		for (i = 0; i < update_ptr->count; i++)
		{
            mmi_imui_get_string_extent_for_selection_area(area_ptr, area_ptr->font_text, temp_str, &w, &h);
			
			if (w > max_str_width)
			{
                max_str_width = w;
			}

            temp_str += mmi_ucs2strlen((const S8 *)temp_str) + 1;
		}
		
		i = 0;

        do 
        {
			grid_width = width / (update_ptr->count - i);
			

			if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR)
			{
				num_of_one_more_pixel = width - area_ptr->area_theme.separator_width - grid_width * (update_ptr->count - i - 1) - (grid_width - area_ptr->area_theme.separator_width);
				
				while (num_of_one_more_pixel < 0)
				{
					grid_width--;
					num_of_one_more_pixel = width - area_ptr->area_theme.separator_width - grid_width * (update_ptr->count - i - 1) - (grid_width - area_ptr->area_theme.separator_width);
				}
			}
			else
			{
				num_of_one_more_pixel = width - grid_width * (update_ptr->count - i);
			}	

			i++;
        
            if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR)
            {
                grid_width = grid_width - area_ptr->area_theme.separator_width; 
            }
			
		}while(grid_width < max_str_width && i < update_ptr->count);
    }

    temp_str = update_ptr->str_ptr;
    
    while (!UI_STRING_END_OF_STRING_CHARACTER(*temp_str) && temp_width > 0 
		   && candidate_count < update_ptr->count && temp_index < MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM)
    {
		if (
            #if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)
            (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_LABEL) && 
            #endif
            candidate_count + 1 > 9)
		{
			break;
		}

        candidate_count++;
        
        if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR && candidate_count != 1
            && temp_index < MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM) /* Separator */
        {
            
            area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR;
                        
            area_ptr->items[temp_index].indicator.x = temp_x;
            area_ptr->items[temp_index].indicator.y = separator_y;
            area_ptr->items[temp_index].indicator.width = area_ptr->area_theme.separator_width;
            
            temp_x += area_ptr->area_theme.separator_width;
            temp_index++;
            
            temp_width -= area_ptr->area_theme.separator_width;
        }

#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)
        if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_LABEL
            && temp_index < MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM) /* Label */
        {
			if (0 < temp_width - (MMI_IMUI_LABEL_LEFT_SPACING + g_imui_ui_param.font_label_width + MMI_IMUI_LABEL_RIGHT_SPACING))
            {
				area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LABEL;
            
				mmi_imui_get_char_extent(g_imui_ui_theme.font_label, (UI_character_type)('0' + candidate_count), &w, &h);

				area_ptr->items[temp_index].indicator.x = temp_x + MMI_IMUI_LABEL_LEFT_SPACING;
				area_ptr->items[temp_index].indicator.y = (area_ptr->height - g_imui_ui_param.font_label_height) / 2;
				area_ptr->items[temp_index].indicator.width = w;

				area_ptr->items[temp_index].indicator.char_code = '0' + candidate_count;

				temp_x += (MMI_IMUI_LABEL_LEFT_SPACING + w + MMI_IMUI_LABEL_RIGHT_SPACING);
				temp_index++;
            
				temp_width -= (MMI_IMUI_LABEL_LEFT_SPACING + w + MMI_IMUI_LABEL_RIGHT_SPACING);
            }
			else 
			{
				if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR && candidate_count != 1)
				{
                    if (area_ptr->items_type[temp_index - 1] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR)
					{
						temp_x -= area_ptr->area_theme.separator_width;
						temp_index--;
						temp_width += area_ptr->area_theme.separator_width;
					}
				}
 
                candidate_count--;
                break;
			}
        }
#endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)*/

    #if defined(__MMI_IME_USER_DATABASE__)
        if (*temp_str == MMI_IME_USER_DATABASE_NEW_WORD)
        {
            mmi_imui_get_string_extent_for_selection_area(area_ptr, area_ptr->font_text, g_imui_new_word_prompt_ptr, &w, &h);
        }
        else
    #endif
        { 
            mmi_imui_get_string_extent_for_selection_area(area_ptr, area_ptr->font_text, temp_str, &w, &h);
        }
        
        str_width = w;
        str_height = h;
            
        if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_FIX_GRID) /* For only one character in a candidate item */
        {
            w = grid_width;
            
            if (num_of_one_more_pixel > 0)
            {
                w++;
                num_of_one_more_pixel--;
            }
            
            w -= (MMI_IMUI_CANDIDATE_LEFT_SPACING + MMI_IMUI_CANDIDATE_RIGHT_SPACING);
        }
        else
        {
            w += 2; /* The gaps between string and the edges of highlight rectangle */
        }
        
		temp_str_original = temp_str;
#if defined(__MMI_IME_USER_DATABASE__)
        if (*temp_str == MMI_IME_USER_DATABASE_NEW_WORD)
        {
            temp_str = g_imui_new_word_prompt_ptr;
        }
#endif
        /* Only for the first candidate, we will cut some characters to fit the remaining space */
        while ( !UI_STRING_END_OF_STRING_CHARACTER(*temp_str)  
            && temp_width < (MMI_IMUI_CANDIDATE_LEFT_SPACING + w + MMI_IMUI_CANDIDATE_RIGHT_SPACING)  
            && candidate_count == 1)
        {
            mmi_lm_get_next_cluster((PU8)temp_str, (PU8)(temp_str + mmi_ucs2strlen((const S8 *)temp_str)), (PU8)temp_str, MMI_TRUE, &cur_cluster);
            temp_str = (UI_string_type)cur_cluster.data_ptr;
            mmi_imui_get_string_extent_for_selection_area(area_ptr, area_ptr->font_text, temp_str, &w, &h);
            str_width = w;
            str_height = h;

            w += 2; /* The gaps between string and the edges of highlight rectangle */
        }
#if defined(__MMI_IME_USER_DATABASE__)
        if (*temp_str_original == MMI_IME_USER_DATABASE_NEW_WORD)
        {
            g_imui_new_word_prompt_ptr = temp_str;
            temp_str = temp_str_original;
        }
#endif
        #ifdef __MMI_TOUCH_SCREEN__
        #ifdef __MMI_IME_FTE_ENHANCE__
            h = area_ptr->height - 2 * (border_width - MMI_IMUI_CANDIDATE_BOX_INTER_BORDER_WIDTH); 
        #else
            h = area_ptr->height - 2 * border_width;
        #endif
        #else
			h = area_ptr->height - 2 * border_width;// - 2; /* 2 is the two gaps in the top and the bottom */
        #endif
       #if defined(__MMI_IME_V3__) 
			 h = area_ptr->height - 2 * border_width;
		#endif
 
        if ((MMI_IMUI_CANDIDATE_LEFT_SPACING + w + MMI_IMUI_CANDIDATE_RIGHT_SPACING) < min_candidate_width) /* Mini candidate width for FTE */
        {
            w = min_candidate_width - (MMI_IMUI_CANDIDATE_LEFT_SPACING + MMI_IMUI_CANDIDATE_RIGHT_SPACING);
        }

        if (temp_width >= (MMI_IMUI_CANDIDATE_LEFT_SPACING + w + MMI_IMUI_CANDIDATE_RIGHT_SPACING) 
            && temp_index < MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM)
        {
            area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE;
        
        #if defined(__MMI_IME_FTE_ENHANCE__)
            area_ptr->items[temp_index].candidate.x = temp_x;
        #else
            area_ptr->items[temp_index].candidate.x = temp_x + MMI_IMUI_CANDIDATE_LEFT_SPACING;
        #endif
        
            area_ptr->items[temp_index].candidate.y = (area_ptr->height - h) / 2;
            
        #if defined(__MMI_IME_FTE_ENHANCE__)
            area_ptr->items[temp_index].candidate.width = (MMI_IMUI_CANDIDATE_LEFT_SPACING + w + MMI_IMUI_CANDIDATE_RIGHT_SPACING);
        #else
            area_ptr->items[temp_index].candidate.width = w;
        #endif
        
            area_ptr->items[temp_index].candidate.height = h;
            
            area_ptr->items[temp_index].candidate.str_width = str_width;
            area_ptr->items[temp_index].candidate.str_height = str_height;
            
            area_ptr->items[temp_index].candidate.string = temp_str;
			area_ptr->items[temp_index].candidate.string_original = temp_str_original;

        #if defined(__MMI_IME_USER_DATABASE__)
            if (*temp_str == MMI_IME_USER_DATABASE_NEW_WORD)
            {
                area_ptr->items[temp_index].candidate.str_len = mmi_ucs2strlen((const S8 *)g_imui_new_word_prompt_ptr);
            }
            else
        #endif
            {
                area_ptr->items[temp_index].candidate.str_len = mmi_ucs2strlen((const S8 *)temp_str);
            }

            if (update_ptr->str_ptr)
            {
                S32 height, temp, baseline;
                gui_set_font(area_ptr->font_text);
                mmi_fe_get_char_info(temp_str[0], &temp, &temp, &height, &baseline, &temp);
                if (baseline > area_ptr->baseline)
                {
                    area_ptr->baseline = baseline;
                }
                if (height > area_ptr->str_height)
                {
                    area_ptr->str_height = height;
                    area_ptr->cand_ver_cap = (area_ptr->height - area_ptr->str_height) / 2 + (area_ptr->height - area_ptr->str_height) % 2;
                }
            }

            temp_str += (area_ptr->items[temp_index].candidate.str_len + 1); 
            
            temp_x += (MMI_IMUI_CANDIDATE_LEFT_SPACING + w + MMI_IMUI_CANDIDATE_RIGHT_SPACING);
            
            temp_index++;
            
            temp_width -= (MMI_IMUI_CANDIDATE_LEFT_SPACING + w + MMI_IMUI_CANDIDATE_RIGHT_SPACING);

            if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_SPACE)
            {
                temp_x += g_imui_ui_theme.text_space; 
                temp_width -= g_imui_ui_theme.text_space;
            }
        }
        else /* Not enough sapce for string */
        {
        
#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)
            if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_LABEL
                && temp_index - 1 < MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM) /* Clear previous label */
            {
				if (area_ptr->items_type[temp_index - 1] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LABEL)
                {
					temp_x -= (MMI_IMUI_LABEL_LEFT_SPACING + g_imui_ui_param.font_label_width + MMI_IMUI_LABEL_RIGHT_SPACING);
                    temp_index--;
                    temp_width += (MMI_IMUI_LABEL_LEFT_SPACING + g_imui_ui_param.font_label_width + MMI_IMUI_LABEL_RIGHT_SPACING);
				}
			}
#endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)*/
            if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_SEPARATOR
                && temp_index - 1 < MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM) /* Clear previous separator */
            {
                if (area_ptr->items_type[temp_index - 1] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR)
                {
                    temp_x -= area_ptr->area_theme.separator_width;
                    temp_index--;
                    temp_width += area_ptr->area_theme.separator_width;
                }
            }
            candidate_count--;
            break;
        }

    }

	MMI_ASSERT(temp_index < MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM);

    /* Add the remaining pixels to included candidate items */
    if ((!UI_STRING_END_OF_STRING_CHARACTER(*temp_str) && candidate_count < update_ptr->count 
		 || (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE)) && temp_width > 0 && temp_index < MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM)
    {
        num_pixel = 1;
        
        while ((temp_width / (candidate_count * num_pixel)) != 0)
        {
            num_pixel++;
        }

        added_pixels = 0;
        
        for (i = 0; i < temp_index; i++)
        {
            while (added_pixels + num_pixel > temp_width && num_pixel > 0)
            {
                num_pixel--;
            }
            
            switch(area_ptr->items_type[i])
            {
            #if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)
            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LABEL:
                area_ptr->items[i].indicator.x += added_pixels;
                break;
            #endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)*/
            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE:
                area_ptr->items[i].candidate.x += added_pixels;
                area_ptr->items[i].candidate.width += num_pixel;
                added_pixels += num_pixel;
                break;
                    
            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR:
                if (i != right_arrow_separator_index && i != left_arrow_separator_index)
                {
                    area_ptr->items[i].indicator.x += added_pixels;
                }
                break;
                
            default:
                break;
            }    
        } 
        
    }
    #if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_ALIGN)
    else if (area_ptr->style & MMI_IMUI_INPUT_AREA_STYLE_CENTER_ALIGN)
    {
        if (temp_width > 0 && candidate_count <= update_ptr->count && temp_index < MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM)
		{
			offset_x = temp_width / 2;
        
			for (i = 0; i < temp_index; i++)
			{
				switch(area_ptr->items_type[i])
				{
				#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)
				case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LABEL:
					area_ptr->items[i].indicator.x += offset_x;
					break;
                #endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)*/
                
				case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE:
					area_ptr->items[i].candidate.x += offset_x;
					break;
                    
				case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR:
                    if (i != right_arrow_separator_index && i != left_arrow_separator_index)
					{
					    area_ptr->items[i].indicator.x += offset_x;
                    }
					break;
                    
                #if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_STAR)
                case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_STAR:
                    area_ptr->items[i].indicator.x += offset_x;
                    break;
                #endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_STAR)*/
				default:
					break;
				}    
			} 
		}
    }
    #endif /*    #if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_ALIGN)*/
    #if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_INDEX)
    else if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_CENTER_INDEX)
	{
		if (UI_STRING_END_OF_STRING_CHARACTER(*temp_str) && temp_width > 0 
		     && candidate_count <= update_ptr->count && temp_index < MMI_IMUI_SELECTION_AREA_MAX_ITEM_NUM)
		{
			offset_x = temp_width / 2;
        
			for (i = 0; i < temp_index; i++)
			{
				switch(area_ptr->items_type[i])
				{
				#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)
				case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LABEL:
					area_ptr->items[i].indicator.x += offset_x;
					break;
                #endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)*/
				case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE:
					area_ptr->items[i].candidate.x += offset_x;
					break;
                    
				case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR:
                    if (i != right_arrow_separator_index && i != left_arrow_separator_index)
					{
					    area_ptr->items[i].indicator.x += offset_x;
                    }
					break;
                
				default:
					break;
				}    
			} 
		}
	}
    #endif /*    #if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_INDEX)*/
    area_ptr->item_count = temp_index;
    area_ptr->highlight_index = update_ptr->highlight_index;
    area_ptr->cand_count = candidate_count;

    if (candidate_count < update_ptr->count && !(area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE))
    {
        area_ptr->flags |= MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE;         
    }

    if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_LAST_PAGE)
    {
        area_ptr->flags &= ~MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE;         
    }

    return candidate_count;
}

#if defined(__MMI_IME_CANDIDATE_GRID__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_selection_area_grid
 * DESCRIPTION
 *  Draw character
 * PARAMETERS
 *  area_ptr       [IN]     Pointer of selection area structure
 *  update_ptr     [IN]     Pointer of new data
 * RETURNS
 *  How many candidate items have been included in this page
 *****************************************************************************/
static U32 mmi_imui_update_selection_area_grid(mmi_imui_selection_area_grid_struct_p area_ptr, mmi_imui_update_selection_area_struct_p update_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UI_string_type temp_str, temp_str_original;
    S32 temp_width, grid_width = 0, str_width, str_height;
    S32 temp_x,temp_y;
    S32 i,j;
	S32 style=0;
    S32 temp_index;
    S32 w, h;
    S32 candidate_count = 0;
    S32 num_of_one_more_pixel = 0;
    S32 max_str_width = 0;
	mmi_lm_cluster_info cur_cluster;
    S32 left_arrow_separator_index = -1, right_arrow_separator_index = -1;
	S32 width_multiplier=0, temp_i=0;
	S32 vk_width, vk_height =205;
#if defined(__MMI_IME_FTE_ENHANCE__) 
    S32 img_width = 0, img_height = 0;
#endif
    S32 border_width = MMI_IMUI_CAND_GRID_BORDER_WIDTH;
    S32 min_candidate_width = 0,min_candidate_height =0,  separator_y = MMI_IMUI_CAND_GRID_BORDER_WIDTH;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
  #if defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_2__)
    wgui_virtual_keyboard_get_dimension(&vk_width, &vk_height);
#elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_1__)
    wgui_get_virtual_keyboard_size(&vk_width, &vk_height);
#elif defined(__MMI_UI_VIRTUAL_KEYBOARD_DEFAULT_VERSION_3__)
 wgui_virtual_keyboard_get_dimension(&vk_width, &vk_height);
#endif
    area_ptr->flags = update_ptr->flags;
    area_ptr->width = vk_width;
    if (update_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_LARGE_FONT) 
    {
        area_ptr->font_text = &MMI_large_font;
    }
    else
    {
        area_ptr->font_text = g_imui_ui_theme.font_text;
    }
    area_ptr->height = vk_height;
	
    area_ptr->area_theme.separator_width = MMI_IMUI_FTE_CAND_BOX_SEPARATOR_WIDTH;
    separator_y = border_width;
    min_candidate_width = (area_ptr->width/5) ;
	min_candidate_height = (area_ptr->height/4);
	area_ptr->component_height = min_candidate_height;
	area_ptr->component_width = min_candidate_width;
    temp_width = area_ptr->width;
    temp_x = 0;
	temp_y = UI_device_height - area_ptr->height - 1;  //devide height - component height
    area_ptr->item_count = 0;
    temp_index = 0;
    temp_str = update_ptr->str_ptr;

    while (!UI_STRING_END_OF_STRING_CHARACTER(*temp_str)  
		   && candidate_count < update_ptr->count && temp_y< (UI_device_height-1))
    {
        temp_width = area_ptr->width;
		temp_width -= (min_candidate_width);      //  width of control
        temp_x = 0;
		if(temp_y + area_ptr->component_height > UI_device_height -1)
		{
			break;//no more candidates can come
		}
		// we have 4x4 grid for candidate fixed, 4X1 for extra buttons
		
	    while(temp_width>0 && candidate_count < update_ptr->count)
		{
               candidate_count++;
			  // if ((temp_width+min_candidate_width + MMI_IMUI_FTE_CAND_BOX_SEPARATOR_WIDTH)  != area_ptr->width) /* Separator, not needed for first column, first candidate */
               /*{
            
						area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR;            
						area_ptr->items[temp_index].indicator.x = temp_x;
						area_ptr->items[temp_index].indicator.y = separator_y + temp_y;
						area_ptr->items[temp_index].indicator.width = area_ptr->area_theme.separator_width;
						temp_x += area_ptr->area_theme.separator_width;
						temp_index++;
			            
						temp_width -= area_ptr->area_theme.separator_width;
               }*/
				 #if defined(__MMI_IME_USER_DATABASE__)
					if (*temp_str == MMI_IME_USER_DATABASE_NEW_WORD)
					{
						mmi_imui_get_string_extent_for_selection_area_grid(area_ptr, area_ptr->font_text, g_imui_new_word_prompt_ptr, &w, &h);
					}
					else
				#endif
					{ 
						mmi_imui_get_string_extent_for_selection_area_grid(area_ptr, area_ptr->font_text, temp_str, &w, &h);
					}
					str_width = w;
					str_height = h;
			            
			      
					temp_str_original = temp_str;
					/* Only for the first candidate, we will cut some characters to fit the remaining space */
					while ( !UI_STRING_END_OF_STRING_CHARACTER(*temp_str)  
							&& temp_width < (MMI_IMUI_CANDIDATE_LEFT_SPACING + w + MMI_IMUI_CANDIDATE_RIGHT_SPACING)  
							&& candidate_count == 1)
					{
						mmi_lm_get_next_cluster((PU8)temp_str, (PU8)(temp_str + mmi_ucs2strlen((const S8 *)temp_str)), (PU8)temp_str, MMI_TRUE, &cur_cluster);
						temp_str = (UI_string_type)cur_cluster.data_ptr;
						mmi_imui_get_string_extent_for_selection_area_grid(area_ptr, area_ptr->font_text, temp_str, &w, &h);
						str_width = w;
						str_height = h;
					}
                    h = min_candidate_height ;
                     
					width_multiplier = ((MMI_IMUI_CANDIDATE_LEFT_SPACING + w + MMI_IMUI_CANDIDATE_RIGHT_SPACING)/(area_ptr->width/5)) + 1;
     
					 //if (temp_width >= (MMI_IMUI_CANDIDATE_LEFT_SPACING + w + MMI_IMUI_CANDIDATE_RIGHT_SPACING) )
					if(width_multiplier > 0 && temp_width >= width_multiplier*((area_ptr->width/5)))
					{
						area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE;
						area_ptr->items[temp_index].candidate.x = temp_x + border_width;
						area_ptr->items[temp_index].candidate.y =temp_y + border_width;  
						area_ptr->items[temp_index].candidate.width = (width_multiplier * (area_ptr->width/5)) - border_width ;
						area_ptr->items[temp_index].candidate.height = h - border_width;
						area_ptr->items[temp_index].candidate.str_width = str_width;
						area_ptr->items[temp_index].candidate.str_height = str_height;
						area_ptr->items[temp_index].candidate.string = temp_str;
						area_ptr->items[temp_index].candidate.string_original = temp_str_original;

					#if defined(__MMI_IME_USER_DATABASE__)
						if (*temp_str == MMI_IME_USER_DATABASE_NEW_WORD)
						{
							area_ptr->items[temp_index].candidate.str_len = mmi_ucs2strlen((const S8 *)g_imui_new_word_prompt_ptr);
						}
						else
					#endif
						{
							area_ptr->items[temp_index].candidate.str_len = mmi_ucs2strlen((const S8 *)temp_str);
						}

						temp_str += (area_ptr->items[temp_index].candidate.str_len + 1); 
			            
						temp_x += ((width_multiplier * (area_ptr->width/5)) );
			            
						temp_index++;
			            
						temp_width -= ((width_multiplier * (area_ptr->width/5)) );

						
						
					}
					else /* Not enough sapce for string */
					{
						if(width_multiplier>0)
						{
							//adjust the previous candidate width
							for(j=1;j<4 && ( (area_ptr->items[temp_index-1].candidate.width +area_ptr->items[temp_index-1].candidate.x) < (4*area_ptr->width)/5);j++ )
							{
							    area_ptr->items[temp_index-1].candidate.width += (area_ptr->width/5) ;
							}
						}

						candidate_count--;
						break;
					}

		}
		temp_x = 4 * (area_ptr->width/5);
		
        temp_y +=min_candidate_height;

 }
 temp_x = 4 * (area_ptr->width/5);
 temp_y= UI_device_height - area_ptr->height - 1; 
for(i=1;i<=4;i++)
		{
               switch(style)
			   {
			   case MMI_IMUI_CANDIDATE_GRID_DELETE:
                   area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_DELETE;
		   area_ptr->items[temp_index].indicator.x = temp_x ;
			area_ptr->items[temp_index].indicator.y = temp_y ;
			area_ptr->items[temp_index].indicator.width = min_candidate_width;
			area_ptr->backspace_button_state = MMI_IMUI_ARROW_NORMAL;
					temp_index++;
					temp_width =0;
				   break;
			   case MMI_IMUI_CANDIDATE_GRID_NAVIGATION_UP:
				  
					area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_UP;
			area_ptr->items[temp_index].indicator.x = temp_x;
			area_ptr->items[temp_index].indicator.y = temp_y ;
			area_ptr->items[temp_index].indicator.width = min_candidate_width;
			area_ptr->up_arrow_state = MMI_IMUI_ARROW_NORMAL;
					temp_index++;
					temp_width =0;
	
				   break;
			   case MMI_IMUI_CANDIDATE_GRID_NAVIGATION_DOWN:
				   area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_DOWN;
			area_ptr->items[temp_index].indicator.x = temp_x ;
			area_ptr->items[temp_index].indicator.y = temp_y;
			area_ptr->items[temp_index].indicator.width = min_candidate_width;
			area_ptr->down_arrow_state = MMI_IMUI_ARROW_NORMAL;
					temp_index++;
					temp_width =0;
				   break;
			   case MMI_IMUI_CANDIDATE_GRID_BACK:
				   area_ptr->items_type[temp_index] = MMI_IMUI_SELECTION_AREA_ITEM_TYPE_BACK;
			area_ptr->items[temp_index].indicator.x = temp_x;
			area_ptr->items[temp_index].indicator.y = temp_y;
			area_ptr->items[temp_index].indicator.width = min_candidate_width;
			area_ptr->back_button_state = MMI_IMUI_ARROW_NORMAL;
					temp_index++;
					temp_width =0;
				   break;
			   default:
				   break;
			   }
		style++;
	   temp_y +=min_candidate_height;

 }


    area_ptr->item_count = temp_index;
    area_ptr->highlight_index = -1;
    area_ptr->cand_count = candidate_count;

    if (candidate_count < update_ptr->count && !(area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE))
    {
        area_ptr->flags |= MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE;         
    }

    if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_LAST_PAGE)
    {
        area_ptr->flags &= ~MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE;         
    }

    return candidate_count;
}
#endif

#if defined(__MMI_IME_FTE_ENHANCE__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_selection_area_fte_theme
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *****************************************************************************/
static void mmi_imui_update_selection_area_fte_theme(mmi_imui_selection_area_struct_p area_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 height = 0, ascent = 0, descent = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_fe_get_char_info_of_all_lang(g_imui_ui_theme.font_text->size, &height, &ascent, &descent);

    area_ptr->cand_ver_cap = MMI_IMUI_SELECTION_AREA_VER_GAP + MMI_IMUI_CANDIDATE_BOX_EXTER_BORDER_WIDTH;
    #if defined(__MMI_MAINLCD_320X240__) || defined(__MMI_MAINLCD_240X320__)
	   area_ptr->cand_background = g_imui_ui_theme.cand_background_medium;

        area_ptr->cand_focus_frame = g_imui_ui_theme.cand_focus_frame_medium;

        area_ptr->cand_separator = g_imui_ui_theme.cand_separator_medium;

        area_ptr->cand_highlight = g_imui_ui_theme.cand_highlight_medium;

        area_ptr->cand_dull_highlight = g_imui_ui_theme.cand_dull_highlight_medium;
#if defined(__MMI_IME_CANDIDATE_GRID__)
		area_ptr->cand_grid_expand = g_imui_ui_theme.cand_grid_expand;
#endif
        area_ptr->cand_left_arrow_down = g_imui_ui_theme.cand_left_arrow_down_medium;
        area_ptr->cand_left_arrow_up = g_imui_ui_theme.cand_left_arrow_up_medium;
        area_ptr->cand_left_arrow_disable = g_imui_ui_theme.cand_left_arrow_disable_medium;
        area_ptr->cand_right_arrow_down = g_imui_ui_theme.cand_right_arrow_down_medium;
        area_ptr->cand_right_arrow_up = g_imui_ui_theme.cand_right_arrow_up_medium;
        area_ptr->cand_right_arrow_disable = g_imui_ui_theme.cand_right_arrow_disable_medium;

        area_ptr->cand_ver_cap += (MMI_IMUI_FTE_CAND_BOX_HEIGHT_MEDIUM - (height + area_ptr->cand_ver_cap * 2)) / 2 + (MMI_IMUI_FTE_CAND_BOX_HEIGHT_MEDIUM - (height + area_ptr->cand_ver_cap * 2)) % 2;

        area_ptr->height = MMI_IMUI_FTE_CAND_BOX_HEIGHT_MEDIUM;
        area_ptr->baseline = ascent;
        area_ptr->str_height = height;

        g_imui_ui_param.arrow_height = MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_MEDIUM;
    #else

    if (MMI_IMUI_FTE_CAND_BOX_HEIGHT_LARGE >= height + area_ptr->cand_ver_cap * 2)
    {
        area_ptr->cand_background = g_imui_ui_theme.cand_background_large;
        
        area_ptr->cand_focus_frame = g_imui_ui_theme.cand_focus_frame_large;
        
        area_ptr->cand_separator = g_imui_ui_theme.cand_separator_large;
        
        area_ptr->cand_highlight = g_imui_ui_theme.cand_highlight_large;
        
        area_ptr->cand_dull_highlight = g_imui_ui_theme.cand_dull_highlight_large;
#if defined(__MMI_IME_CANDIDATE_GRID__)
        area_ptr->cand_grid_expand = g_imui_ui_theme.cand_grid_expand;
#endif
        area_ptr->cand_left_arrow_down = g_imui_ui_theme.cand_left_arrow_down_large;
        area_ptr->cand_left_arrow_up = g_imui_ui_theme.cand_left_arrow_up_large;
        area_ptr->cand_left_arrow_disable = g_imui_ui_theme.cand_left_arrow_disable_large;
        area_ptr->cand_right_arrow_down = g_imui_ui_theme.cand_right_arrow_down_large;
        area_ptr->cand_right_arrow_up = g_imui_ui_theme.cand_right_arrow_up_large;
        area_ptr->cand_right_arrow_disable = g_imui_ui_theme.cand_right_arrow_disable_large;
        
        area_ptr->cand_ver_cap += (MMI_IMUI_FTE_CAND_BOX_HEIGHT_LARGE - (height + area_ptr->cand_ver_cap * 2) + 1) / 2;
        
        area_ptr->height = MMI_IMUI_FTE_CAND_BOX_HEIGHT_LARGE;
        area_ptr->baseline = ascent;
        area_ptr->str_height = height;

        g_imui_ui_param.arrow_height = MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_LARGE;
    }
    
    else if (MMI_IMUI_FTE_CAND_BOX_HEIGHT_MEDIUM > height + area_ptr->cand_ver_cap * 2)
    {
        area_ptr->cand_background = g_imui_ui_theme.cand_background_medium;

        area_ptr->cand_focus_frame = g_imui_ui_theme.cand_focus_frame_medium;

        area_ptr->cand_separator = g_imui_ui_theme.cand_separator_medium;

        area_ptr->cand_highlight = g_imui_ui_theme.cand_highlight_medium;

        area_ptr->cand_dull_highlight = g_imui_ui_theme.cand_dull_highlight_medium;
#if defined(__MMI_IME_CANDIDATE_GRID__)
       area_ptr->cand_grid_expand = g_imui_ui_theme.cand_grid_expand;
#endif
        area_ptr->cand_left_arrow_down = g_imui_ui_theme.cand_left_arrow_down_medium;
        area_ptr->cand_left_arrow_up = g_imui_ui_theme.cand_left_arrow_up_medium;
        area_ptr->cand_left_arrow_disable = g_imui_ui_theme.cand_left_arrow_disable_medium;
        area_ptr->cand_right_arrow_down = g_imui_ui_theme.cand_right_arrow_down_medium;
        area_ptr->cand_right_arrow_up = g_imui_ui_theme.cand_right_arrow_up_medium;
        area_ptr->cand_right_arrow_disable = g_imui_ui_theme.cand_right_arrow_disable_medium;

        area_ptr->cand_ver_cap += (MMI_IMUI_FTE_CAND_BOX_HEIGHT_MEDIUM - (height + area_ptr->cand_ver_cap * 2) + 1) / 2;

        area_ptr->height = MMI_IMUI_FTE_CAND_BOX_HEIGHT_MEDIUM;
        area_ptr->baseline = ascent;
        area_ptr->str_height = height;

        g_imui_ui_param.arrow_height = MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_MEDIUM;
    }
    else if (MMI_IMUI_FTE_CAND_BOX_HEIGHT_SMALL > height + area_ptr->cand_ver_cap * 2)
    {
        area_ptr->cand_background = g_imui_ui_theme.cand_background_small;

        area_ptr->cand_focus_frame = g_imui_ui_theme.cand_focus_frame_small;

        area_ptr->cand_separator = g_imui_ui_theme.cand_separator_small;

        area_ptr->cand_highlight = g_imui_ui_theme.cand_highlight_small;

        area_ptr->cand_dull_highlight = g_imui_ui_theme.cand_dull_highlight_small;
#if defined(__MMI_IME_CANDIDATE_GRID__)
		area_ptr->cand_grid_expand = g_imui_ui_theme.cand_grid_expand;
#endif
        area_ptr->cand_left_arrow_down = g_imui_ui_theme.cand_left_arrow_down_small;
        area_ptr->cand_left_arrow_up = g_imui_ui_theme.cand_left_arrow_up_small;
        area_ptr->cand_left_arrow_disable = g_imui_ui_theme.cand_left_arrow_disable_small;
        area_ptr->cand_right_arrow_down = g_imui_ui_theme.cand_right_arrow_down_small;
        area_ptr->cand_right_arrow_up = g_imui_ui_theme.cand_right_arrow_up_small;
        area_ptr->cand_right_arrow_disable = g_imui_ui_theme.cand_right_arrow_disable_small;

        area_ptr->cand_ver_cap += (MMI_IMUI_FTE_CAND_BOX_HEIGHT_SMALL - (height + area_ptr->cand_ver_cap * 2) + 1) / 2;

        area_ptr->height = MMI_IMUI_FTE_CAND_BOX_HEIGHT_SMALL;
        area_ptr->baseline = ascent;
        area_ptr->str_height = height;

        g_imui_ui_param.arrow_height = MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_SMALL;
    }
    else
    {
       //font does not fit even in large box, so taking large box as case and let font cut
            area_ptr->cand_background = g_imui_ui_theme.cand_background_large;
        
            area_ptr->cand_focus_frame = g_imui_ui_theme.cand_focus_frame_large;
            
            area_ptr->cand_separator = g_imui_ui_theme.cand_separator_large;
            
            area_ptr->cand_highlight = g_imui_ui_theme.cand_highlight_large;
            
            area_ptr->cand_dull_highlight = g_imui_ui_theme.cand_dull_highlight_large;
            
            area_ptr->cand_left_arrow_down = g_imui_ui_theme.cand_left_arrow_down_large;
            area_ptr->cand_left_arrow_up = g_imui_ui_theme.cand_left_arrow_up_large;
            area_ptr->cand_left_arrow_disable = g_imui_ui_theme.cand_left_arrow_disable_large;
            area_ptr->cand_right_arrow_down = g_imui_ui_theme.cand_right_arrow_down_large;
            area_ptr->cand_right_arrow_up = g_imui_ui_theme.cand_right_arrow_up_large;
            area_ptr->cand_right_arrow_disable = g_imui_ui_theme.cand_right_arrow_disable_large;
            
            area_ptr->cand_ver_cap += (MMI_IMUI_FTE_CAND_BOX_HEIGHT_LARGE - (height + area_ptr->cand_ver_cap * 2) + 1) / 2;
            
            area_ptr->height = MMI_IMUI_FTE_CAND_BOX_HEIGHT_LARGE;
            area_ptr->baseline = ascent;
            area_ptr->str_height = height;

            g_imui_ui_param.arrow_height = MMI_IMUI_FTE_CAND_BOX_ARROW_HEIGHT_LARGE;
        
    }
	#endif

}
#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */
#if defined(__MMI_IME_SCROLLING_COMPOSITION__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_is_scrolling_box_shown
 * DESCRIPTION
 *  
 * PARAMETERS
 *  
 * RETURNS
 *  
 *****************************************************************************/
MMI_BOOL mmi_imui_is_scrolling_box_shown(void)
{
			if ((g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_COMPOSITION_AREA)) &&
					g_imui_composition_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_VERTICAL)
			{
				return MMI_TRUE;
			}
			else
			{
				return MMI_FALSE;
			}
}
#endif
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_show_selection_area
 * DESCRIPTION
 *  Draw character
 * PARAMETERS
 *  area_ptr       [IN]     Pointer to selection area structure
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_show_selection_area(mmi_imui_selection_area_struct_p area_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;
    S32 candidate_index = 0;
    S32 bg_x, bg_width, offset_x;
    color text_color, bd_color, highlight_color;
    UI_filled_area *bg_filler;
    S32 last_x, temp_x;
    S32 border_width = 0;
	#if defined(__MMI_IME_CANDIDATE_GRID__)
	S32 img_width, img_height;
	PU8 temp_img_ptr_background = NULL;
	#endif
#if defined(__MMI_IME_FTE_ENHANCE__)
    PU8 temp_img_ptr = NULL;
#endif
	#if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)
    MMI_BOOL is_dither;
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    gdi_layer_lock_frame_buffer();

	gui_push_clip();

	gui_set_clip(area_ptr->x, area_ptr->y, area_ptr->x + area_ptr->width - 1, area_ptr->y + area_ptr->height - 1);
    
    bg_x = area_ptr->x + MMI_IMUI_SLECTION_AREA_LEFT_SPACING;
    bg_width = area_ptr->width - (MMI_IMUI_SLECTION_AREA_LEFT_SPACING + MMI_IMUI_SLECTION_AREA_RIGHT_SPACING);

    last_x = area_ptr->width - 1;
        
#if defined(__MMI_TOUCH_SCREEN__) && !defined(__MMI_IME_FTE_ENHANCE__)
    for (i = 0; i < area_ptr->item_count; i++)
    {
        if (area_ptr->items_type[i] == MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LEFT_ARROW)
        {
            //bg_x = area_ptr->items[i].indicator.x + g_imui_ui_param.arrow_width + MMI_IMUI_ARROW_RIGHT_SPACING;
            //bg_width = area_ptr->width - 2 * bg_x;
            //bg_x += area_ptr->x;
            break;
        }    
    }    
#endif /* #if defined(__MMI_TOUCH_SCREEN__) && !defined(__MMI_IME_FTE_ENHANCE__) */

#if defined(__MMI_IME_FTE_ENHANCE__)
    /* For border */
    border_width = MMI_IMUI_CANDIDATE_BOX_BORDER_WIDTH;
#else
    if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_BORDER)
    {
        border_width = MMI_IMUI_CANDIDATE_BOX_BORDER_WIDTH;
    }
#endif  /* #if defined(__MMI_IME_FTE_ENHANCE__) */



    /* Draw  border and background */
    if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_FOCUS) 
    {
        bd_color = g_imui_ui_theme.focused_border_color;
        bg_filler = g_imui_ui_theme.focused_background_filler;
    }
    else 
    {
        bd_color = g_imui_ui_theme.border_color;
        bg_filler = g_imui_ui_theme.background_filler;
    }
    
#if defined(__MMI_IME_FTE_ENHANCE__) 

    if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_FOCUS)
    {
        temp_img_ptr = area_ptr->cand_focus_frame;
    }
    else
    {
        temp_img_ptr = area_ptr->cand_background;
    }
#if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)
    is_dither = gdi_image_9slice_get_dither();
    gdi_image_9slice_set_dither(MMI_FALSE);
#endif  

    
    gdi_image_draw_resized_blend2layers(area_ptr->x, 
                           area_ptr->y, 
                           area_ptr->width, 
                           area_ptr->height,
                           temp_img_ptr);

#if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)  
    gdi_image_9slice_set_dither(is_dither);
#endif


#else    
    if (g_imui_redraw_funcptr)
	{
    #if !defined(__MMI_IME_FTE_ENHANCE__)    
        g_imui_redraw_funcptr(bg_x + 1, area_ptr->y + 1, 
                        bg_x + bg_width - 2, area_ptr->y + area_ptr->height - 2);
    #endif    
    }
    else
	{
	    gdi_draw_solid_rect(bg_x + 1, area_ptr->y + 1, 
                        bg_x + bg_width - 2, area_ptr->y + area_ptr->height - 2, GDI_COLOR_WHITE);
    }

    if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_BORDER)
    {
        gui_draw_filled_area(bg_x + 1, area_ptr->y + 1, 
                             bg_x + bg_width - 2, area_ptr->y + area_ptr->height - 2, 
                             bg_filler);
        
        gdi_draw_line(bg_x + 1, 
            area_ptr->y, 
            bg_x + bg_width - 2, 
            area_ptr->y, 
            gdi_act_color_from_rgb(255, bd_color.r, bd_color.g, bd_color.b));
        
        gdi_draw_line(bg_x + 1, 
            area_ptr->y + area_ptr->height - 1, 
            bg_x + bg_width - 2, 
            area_ptr->y + area_ptr->height - 1, 
            gdi_act_color_from_rgb(255, bd_color.r, bd_color.g, bd_color.b));

        gdi_draw_line(bg_x, 
            area_ptr->y + 1, 
            bg_x, 
            area_ptr->y + area_ptr->height - 2, 
            gdi_act_color_from_rgb(255, bd_color.r, bd_color.g, bd_color.b));

        gdi_draw_line(bg_x + bg_width - 1, 
            area_ptr->y + 1, 
            bg_x + bg_width - 1, 
            area_ptr->y + area_ptr->height - 2, 
            gdi_act_color_from_rgb(255, bd_color.r, bd_color.g, bd_color.b));     
    }
    else
    {
        gui_draw_filled_area(bg_x, area_ptr->y, 
                             bg_x + bg_width - 1, area_ptr->y + area_ptr->height - 1, 
                             bg_filler);
    }
#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

    /* Draw selection area UI items */
    for (i = 0; i < area_ptr->item_count; i++)
    {
        switch (area_ptr->items_type[i])
        {
            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LEFT_ARROW:
                if ((area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_PRE_PAGE || area_ptr->highlight_index > 0)
                    && !(area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L))
                {
                    mmi_imui_selection_area_draw_arrow(area_ptr,
                                        area_ptr->items[i].indicator.x + area_ptr->x, 
                                        area_ptr->items[i].indicator.y + area_ptr->y,
                                        MMI_IMUI_ARROW_DIRECTION_LEFT,
                                        area_ptr->left_arrow_state);
                }
                else if ((area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE || area_ptr->highlight_index < area_ptr->cand_count - 1)
                         && (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L))
                {
                    mmi_imui_selection_area_draw_arrow(area_ptr,
                                        area_ptr->items[i].indicator.x + area_ptr->x, 
                                        area_ptr->items[i].indicator.y + area_ptr->y,
                                        MMI_IMUI_ARROW_DIRECTION_LEFT,
                                        area_ptr->left_arrow_state);
                }
                else
                {
                    mmi_imui_selection_area_draw_arrow(area_ptr,
                                        area_ptr->items[i].indicator.x + area_ptr->x, 
                                        area_ptr->items[i].indicator.y + area_ptr->y,
                                        MMI_IMUI_ARROW_DIRECTION_LEFT,
                                        MMI_IMUI_ARROW_DISABLE);
                }
                break;
                
            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_RIGHT_ARROW:
                if ((area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE || (area_ptr->highlight_index >= 0 && area_ptr->highlight_index < area_ptr->cand_count - 1))
                    && !(area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L))
                {
                    mmi_imui_selection_area_draw_arrow(area_ptr,
                                        area_ptr->items[i].indicator.x + area_ptr->x, 
                                        area_ptr->items[i].indicator.y + area_ptr->y,
                                        MMI_IMUI_ARROW_DIRECTION_RIGHT,
                                        area_ptr->right_arrow_state);
                }
                else if ((area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_PRE_PAGE || area_ptr->highlight_index > 0)
                         && (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L))
                {
                    mmi_imui_selection_area_draw_arrow(area_ptr,
                                        area_ptr->items[i].indicator.x + area_ptr->x, 
                                        area_ptr->items[i].indicator.y + area_ptr->y,
                                        MMI_IMUI_ARROW_DIRECTION_RIGHT,
                                        area_ptr->right_arrow_state);
                }
                else
                {
                    mmi_imui_selection_area_draw_arrow(area_ptr,
                                        area_ptr->items[i].indicator.x + area_ptr->x, 
                                        area_ptr->items[i].indicator.y + area_ptr->y,
                                        MMI_IMUI_ARROW_DIRECTION_RIGHT,
                                        MMI_IMUI_ARROW_DISABLE);
                }
                break;
			#if defined(__MMI_IME_CANDIDATE_GRID__)
            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_EXPAND:
					if(area_ptr->expand_button_state == MMI_IMUI_ARROW_PRESSED)
					{
						temp_img_ptr_background = area_ptr->cand_highlight;
					}
					else
					{
                     //temp_img_ptr_background = g_imui_candidate_box_grid.cand_background;
					}
               
                     gui_measure_image(area_ptr->cand_grid_expand, &img_width, &img_height);
					if(area_ptr->expand_button_state == MMI_IMUI_ARROW_PRESSED)
					{
#if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)
            is_dither = gdi_image_9slice_get_dither();
            gdi_image_9slice_set_dither(MMI_FALSE);
#endif  

                    gdi_image_draw_resized_blend2layers(area_ptr->items[i].indicator.x, 
                               area_ptr->items[i].indicator.y + area_ptr->y + MMI_IMUI_CANDIDATE_BOX_BORDER_WIDTH,
                               area_ptr->items[i].indicator.width, 
                               area_ptr->height - 2*MMI_IMUI_CANDIDATE_BOX_BORDER_WIDTH, 
                               temp_img_ptr_background);

#if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)  
            gdi_image_9slice_set_dither(is_dither);
#endif

				   }
                    gdi_image_draw_blend2layers(area_ptr->items[i].indicator.x + ((area_ptr->items[i].indicator.width-img_width)/2) , 
                        area_ptr->items[i].indicator.y + area_ptr->y  + ((area_ptr->height - img_height)/2), 
                        area_ptr->cand_grid_expand);

                break;    
				#endif
                
#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)
            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_LABEL:
                if ((area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_FOCUS) && !(area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_DISABLE_LABEL))
                {
                    if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                    {

                        mmi_imui_get_r2l_coordinate(area_ptr->items[i].indicator.x, 
                                                    area_ptr->items[i].indicator.width,
                                                    last_x,
                                                    &temp_x);
                        
                        /* 2 is fine tune value, due to it will be 2 pixels spaces in the left of label */
                        mmi_imui_draw_char(temp_x + area_ptr->x - 1, 
                                           area_ptr->items[i].indicator.y + area_ptr->y,
                                           -1,
                                           area_ptr->items[i].indicator.char_code,
                                           g_imui_ui_theme.font_label,
                                           g_imui_ui_theme.label_color);
                    }
                    else
                    {
                        mmi_imui_draw_char(area_ptr->items[i].indicator.x + area_ptr->x, 
                                           area_ptr->items[i].indicator.y + area_ptr->y,
                                           -1,
                                           area_ptr->items[i].indicator.char_code,
                                           g_imui_ui_theme.font_label,
                                           g_imui_ui_theme.label_color);
                    }
                }
                break;
#endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_LABEL)*/
                
#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_STAR)
            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_STAR:

                if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                {
                    mmi_imui_get_r2l_coordinate(area_ptr->items[i].indicator.x,
                                                g_imui_ui_param.font_label_width,
                                                last_x,
                                                &temp_x);

                    mmi_imui_draw_char(temp_x + area_ptr->x, 
                                       area_ptr->items[i].indicator.y + area_ptr->y,
                                       area_ptr->baseline,
                                       area_ptr->items[i].indicator.char_code,
                                       g_imui_ui_theme.font_label,
                                       g_imui_ui_theme.indicator_color);
                }
                else
                {
                    mmi_imui_draw_char(area_ptr->items[i].indicator.x + area_ptr->x, 
                                       area_ptr->items[i].indicator.y + area_ptr->y,
                                       area_ptr->baseline,
                                       area_ptr->items[i].indicator.char_code,
                                       g_imui_ui_theme.font_label,
                                       g_imui_ui_theme.indicator_color);
                }
                break;
#endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_STAR)*/

            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_WAVE:
                break;
                
            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_SEPARATOR:
                if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_FOCUS)
                {
                    bd_color = area_ptr->area_theme.separator_focused_color;
                }
                else 
                {
                    bd_color = area_ptr->area_theme.separator_normal_color;
                }
                
                if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                {
                    mmi_imui_get_r2l_coordinate(area_ptr->items[i].indicator.x,
                                                1,
                                                last_x,
                                                &temp_x);
                #if defined(__MMI_IME_FTE_ENHANCE__) 
                    gui_push_clip();

	                gui_set_clip(temp_x + area_ptr->x + (area_ptr->area_theme.separator_width - 1) / 2,
                        area_ptr->items[i].indicator.y + area_ptr->y, 
                        temp_x + area_ptr->x + (area_ptr->area_theme.separator_width - 1) / 2 + area_ptr->area_theme.separator_width - 1,
                        area_ptr->items[i].indicator.y + area_ptr->y + (area_ptr->height - 2 * border_width) - 1);
                        
                    gdi_image_draw(temp_x + area_ptr->x + (area_ptr->area_theme.separator_width - 1) / 2,
                        area_ptr->items[i].indicator.y + area_ptr->y,
                        area_ptr->cand_separator);

                    gui_pop_clip();
                #else    
                    gdi_draw_solid_rect(temp_x + area_ptr->x + (area_ptr->area_theme.separator_width - 1) / 2, 
                        area_ptr->items[i].indicator.y + area_ptr->y, 
                        temp_x + area_ptr->x + (area_ptr->area_theme.separator_width - 1) / 2 + area_ptr->area_theme.separator_width - 1, 
                        area_ptr->items[i].indicator.y + area_ptr->y + (area_ptr->height - border_width * 2) - 1, 
                        gdi_act_color_from_rgb(255, bd_color.r, bd_color.g, bd_color.b));
                #endif
                }
                else
                {
                #if defined(__MMI_IME_FTE_ENHANCE__) 
                    gui_push_clip();

	                gui_set_clip(area_ptr->items[i].indicator.x + area_ptr->x + (area_ptr->area_theme.separator_width - 1) / 2, 
                        area_ptr->items[i].indicator.y + area_ptr->y, 
                        area_ptr->items[i].indicator.x + area_ptr->x + (area_ptr->area_theme.separator_width - 1) / 2 + area_ptr->area_theme.separator_width - 1,
                        area_ptr->items[i].indicator.y + area_ptr->y + (area_ptr->height - 2 * border_width) - 1);
                    
                    gdi_image_draw(area_ptr->items[i].indicator.x + area_ptr->x + (area_ptr->area_theme.separator_width - 1) / 2, 
                        area_ptr->items[i].indicator.y + area_ptr->y, 
                        area_ptr->cand_separator);

                    gui_pop_clip();
                #else
                    gdi_draw_solid_rect(area_ptr->items[i].indicator.x + area_ptr->x + (area_ptr->area_theme.separator_width - 1) / 2, 
                        area_ptr->items[i].indicator.y + area_ptr->y, 
                        area_ptr->items[i].indicator.x + area_ptr->x + (area_ptr->area_theme.separator_width - 1) / 2 + area_ptr->area_theme.separator_width - 1, 
                        area_ptr->items[i].indicator.y + area_ptr->y + (area_ptr->height - border_width * 2) - 1, 
                        gdi_act_color_from_rgb(255, bd_color.r, bd_color.g, bd_color.b));
                #endif
                }
            
                break;
                
            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE:
                mmi_fe_enable_ucs2_proprietary_display();
                offset_x = (area_ptr->items[i].candidate.width - area_ptr->items[i].candidate.str_width) / 2;
                
                if (candidate_index == area_ptr->highlight_index)
                {
                    if (mmi_ime_word_is_redicals(area_ptr->items[i].candidate.string_original[0]))
                    {
                        highlight_color = g_imui_ui_theme.stroke_highlight_color;
                        text_color = g_imui_ui_theme.highlighted_stroke_color;
                    }
                    else
                    {
                        highlight_color = area_ptr->area_theme.highlight_color;
                        text_color =  area_ptr->area_theme.highlighted_text_color;
                    }
                    
                #if defined(__MMI_IME_FTE_ENHANCE__)
                    if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_FOCUS)
                    {
                        temp_img_ptr = area_ptr->cand_highlight;
                    }
                    else
                    {
                        temp_img_ptr = area_ptr->cand_dull_highlight;
                    }
                    
                    if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                    {
                        mmi_imui_get_r2l_coordinate(area_ptr->items[i].candidate.x,
                                                    area_ptr->items[i].candidate.width,
                                                    last_x,
                                                    &temp_x);
#if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)
                    is_dither = gdi_image_9slice_get_dither();
                    gdi_image_9slice_set_dither(MMI_FALSE);
#endif  


                        
						gdi_image_draw_resized_blend2layers(temp_x + area_ptr->x, 
                               area_ptr->items[i].candidate.y + area_ptr->y,
                               area_ptr->items[i].candidate.width, 
                               area_ptr->items[i].candidate.height, 
                               temp_img_ptr);

#if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)  
                    gdi_image_9slice_set_dither(is_dither);
#endif

                    }
                    else
                    {

#if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)
                    is_dither = gdi_image_9slice_get_dither();
                    gdi_image_9slice_set_dither(MMI_FALSE);
#endif  



						gdi_image_draw_resized_blend2layers(area_ptr->items[i].candidate.x + area_ptr->x, 
                               area_ptr->items[i].candidate.y + area_ptr->y,
                               area_ptr->items[i].candidate.width, 
                               area_ptr->items[i].candidate.height, 
                               temp_img_ptr);
#if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)  
                    gdi_image_9slice_set_dither(is_dither);
#endif

                    }
                #else
                    if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                    {
                        mmi_imui_get_r2l_coordinate(area_ptr->items[i].candidate.x,
                                                    area_ptr->items[i].candidate.width,
                                                    last_x,
                                                    &temp_x);

                        gui_fill_rectangle(temp_x + area_ptr->x, area_ptr->items[i].candidate.y + area_ptr->y, 
                               temp_x + area_ptr->items[i].candidate.width - 1 + area_ptr->x, 
                               area_ptr->items[i].candidate.y + area_ptr->items[i].candidate.height - 1 + area_ptr->y, 
                           highlight_color);
                    }
                    else
                    {
                        gui_fill_rectangle(area_ptr->items[i].candidate.x + area_ptr->x, area_ptr->items[i].candidate.y + area_ptr->y, 
                               area_ptr->items[i].candidate.x + area_ptr->items[i].candidate.width - 1 + area_ptr->x, 
                               area_ptr->items[i].candidate.y + area_ptr->items[i].candidate.height - 1 + area_ptr->y, 
                               highlight_color);
                    }
                #endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */
                }
                else
                {
                    if (mmi_ime_word_is_redicals(area_ptr->items[i].candidate.string_original[0]))
                    {
                        text_color = g_imui_ui_theme.stroke_color;
                    }
                    else
                    {
                        text_color =  area_ptr->area_theme.text_color;
                    }
                }

                if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                {
                    mmi_imui_get_r2l_coordinate(area_ptr->items[i].candidate.x + offset_x,
                                                area_ptr->items[i].candidate.str_width,
                                                last_x,
                                                &temp_x);
                #if defined(__MMI_IME_USER_DATABASE__)
                    if (*(area_ptr->items[i].candidate.string) == MMI_IME_USER_DATABASE_NEW_WORD)
                    {
                        mmi_imui_draw_string_for_selection_area(
                            area_ptr,
                            temp_x + area_ptr->x, 
                            area_ptr->cand_ver_cap + area_ptr->y,
                            area_ptr->baseline, 
                            g_imui_new_word_prompt_ptr, 
                            area_ptr->items[i].candidate.str_len,
                            area_ptr->font_text,
                            text_color);
                    }
                    else
                #endif
                    {
                        mmi_imui_draw_string_for_selection_area(
                            area_ptr,
                            temp_x + area_ptr->x, 
                            area_ptr->cand_ver_cap + area_ptr->y, 
                            area_ptr->baseline, 
                            area_ptr->items[i].candidate.string, 
                            area_ptr->items[i].candidate.str_len,
                            area_ptr->font_text,
                            text_color);
                    }
                }
                else
                {
                #if defined(__MMI_IME_USER_DATABASE__)
                    if (*(area_ptr->items[i].candidate.string) == MMI_IME_USER_DATABASE_NEW_WORD)
                    {
                        mmi_imui_draw_string_for_selection_area(
                            area_ptr,
                            area_ptr->items[i].candidate.x + area_ptr->x + offset_x, 
                            area_ptr->cand_ver_cap + area_ptr->y,
                            area_ptr->baseline, 
                            g_imui_new_word_prompt_ptr, area_ptr->items[i].candidate.str_len,
                            area_ptr->font_text,
                            text_color);
                    }
                    else
                #endif
                    {
                        mmi_imui_draw_string_for_selection_area(
                            area_ptr,
                            area_ptr->items[i].candidate.x + area_ptr->x + offset_x, 
                            area_ptr->cand_ver_cap + area_ptr->y, 
                            area_ptr->baseline, 
                            area_ptr->items[i].candidate.string, 
                            area_ptr->items[i].candidate.str_len,
                            area_ptr->font_text,
                            text_color);
                    }
                }
                mmi_fe_disable_ucs2_proprietary_display();

                candidate_index++;
                break;
                
            default:
                break;
        }
    }
    gui_pop_clip();
    gdi_layer_unlock_frame_buffer();
    gdi_layer_blt_previous(area_ptr->x, area_ptr->y, area_ptr->x + area_ptr->width - 1, area_ptr->y + area_ptr->height - 1);
    
}
#if defined(__MMI_IME_CANDIDATE_GRID__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_show_selection_area_grid
 * DESCRIPTION
 *  Draw grid candidate box
 * PARAMETERS
 *  area_ptr       [IN]     Pointer to selection area structure
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_show_selection_area_grid(mmi_imui_selection_area_grid_struct_p area_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i,j;
    S32 candidate_index = 0;
    S32 bg_x, bg_width, offset_x, offset_y;
    color text_color, bd_color, highlight_color;
    UI_filled_area *bg_filler;
	S32 temp_x1 =0, temp_y1=0;
    S32 last_x, temp_x;
    S32 border_width = 0;
    PU8 temp_img_ptr = NULL;
	PU8 temp_img_ptr_control_bar = NULL;
	S32 img_width, img_height;
#if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)
    MMI_BOOL is_dither;
#endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    gdi_layer_lock_frame_buffer();

	gui_push_clip();

	gui_set_clip(area_ptr->x, area_ptr->y, area_ptr->x + area_ptr->width - 1, area_ptr->y + area_ptr->height - 1);
    
    bg_x = area_ptr->x + MMI_IMUI_SLECTION_AREA_LEFT_SPACING;
    bg_width = area_ptr->width - (MMI_IMUI_SLECTION_AREA_LEFT_SPACING + MMI_IMUI_SLECTION_AREA_RIGHT_SPACING);

    last_x = area_ptr->width - area_ptr->component_width - 1 +  2*border_width ;
 
    /* For border */
    border_width = MMI_IMUI_CAND_GRID_BORDER_WIDTH;



    /* Draw  border and background */
    if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_FOCUS) 
    {
        bd_color = g_imui_ui_theme.focused_border_color;
        bg_filler = g_imui_ui_theme.focused_background_filler;
    }
    else 
    {
        bd_color = g_imui_ui_theme.border_color;
        bg_filler = g_imui_ui_theme.background_filler;
    }
    
#if defined(__MMI_IME_FTE_ENHANCE__) 
	if(g_imui_is_down_in_grid == MMI_FALSE)
	{

        temp_img_ptr = area_ptr->cand_grid_background;
    
    #if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)
    is_dither = gdi_image_9slice_get_dither();
    gdi_image_9slice_set_dither(MMI_FALSE);
#endif  

    gdi_image_draw_resized_blend2layers(area_ptr->x, 
                           area_ptr->y, 
                           area_ptr->width, 
                           area_ptr->height,
                           temp_img_ptr);

#if !defined(GDI_9SLICE_USING_LINEAR_TRANSFORM)  
    gdi_image_9slice_set_dither(is_dither);
#endif

	}
    #endif    
	/* draw the 4x4 boxes*/
	if(g_imui_is_down_in_grid == MMI_FALSE)
	{
		//optimization, no need to draw on down event
 for(i=0; i<4; i++)
 {
	 for(j=0; j<4; j++)
	 {
		 if(temp_y1 + area_ptr->component_height > UI_device_height -1)
		 {
			 break;
		 }
         gdi_image_draw_resized_blend2layers(area_ptr->x + temp_x1 + border_width, 
                               area_ptr->y + temp_y1 + border_width ,
                               area_ptr->component_width - border_width, 
                               area_ptr->component_height - border_width, 
                               area_ptr->cand_background);
		 temp_x1 += area_ptr->component_width;
	 }
	 temp_y1 += area_ptr->component_height;
	 temp_x1 = 0;
 }
	}
    /* Draw selection area UI items */
    for (i = 0; i < area_ptr->item_count; i++)
    {
        switch (area_ptr->items_type[i])
        {
            
			case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_DELETE:
				if(area_ptr->backspace_button_state == MMI_IMUI_ARROW_PRESSED)
				{
					temp_img_ptr_control_bar = area_ptr->cand_highlight;
				}
				else
				{
					temp_img_ptr_control_bar = area_ptr->cand_grid_background_black;
				}
				gui_measure_image(area_ptr->cand_backspace, &img_width, &img_height);
				gdi_image_draw_resized_blend2layers(area_ptr->items[i].indicator.x + border_width, 
                               area_ptr->items[i].indicator.y + border_width,
                               area_ptr->items[i].indicator.width - border_width, 
                               area_ptr->component_height - border_width, 
                               temp_img_ptr_control_bar);
				gdi_image_draw_blend2layers(area_ptr->items[i].indicator.x +((area_ptr->items[i].indicator.width-img_width)/2) , area_ptr->items[i].indicator.y + ((area_ptr->component_height - img_height)/2), area_ptr->cand_backspace);
              
				break;
			case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_UP:
				if(area_ptr->up_arrow_state == MMI_IMUI_ARROW_PRESSED && area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_PRE_PAGE)
				{
					temp_img_ptr_control_bar = area_ptr->cand_highlight;
				}
				else
				{
					temp_img_ptr_control_bar = area_ptr->cand_grid_background_black;
				}
				gui_measure_image(area_ptr->cand_up_arrow_down, &img_width, &img_height);
				gdi_image_draw_resized_blend2layers(area_ptr->items[i].indicator.x + border_width, 
                               area_ptr->items[i].indicator.y + border_width,
                               area_ptr->items[i].indicator.width - border_width, 
                               area_ptr->component_height - border_width, 
                               temp_img_ptr_control_bar);
				if(area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_PRE_PAGE)
				{
					gdi_image_draw_blend2layers(area_ptr->items[i].indicator.x+((area_ptr->items[i].indicator.width-img_width)/2), area_ptr->items[i].indicator.y +  ((area_ptr->component_height - img_height)/2), area_ptr->cand_up_arrow_down);
				}
				else
				{
					gdi_image_draw_blend2layers(area_ptr->items[i].indicator.x +((area_ptr->items[i].indicator.width-img_width)/2) , area_ptr->items[i].indicator.y +  ((area_ptr->component_height - img_height)/2), area_ptr->cand_up_arrow_disable);
				}
				break;
			case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_NAVIGATION_DOWN:
				if(area_ptr->down_arrow_state == MMI_IMUI_ARROW_PRESSED && area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE)
				{
					temp_img_ptr_control_bar = area_ptr->cand_highlight;
				}
				else
				{
					temp_img_ptr_control_bar = area_ptr->cand_grid_background_black;
				}
				gui_measure_image(area_ptr->cand_down_arrow_down, &img_width, &img_height);
				gdi_image_draw_resized_blend2layers(area_ptr->items[i].indicator.x + border_width, 
                               area_ptr->items[i].indicator.y + border_width,
                               area_ptr->items[i].indicator.width - border_width, 
                               area_ptr->component_height - border_width, 
                               temp_img_ptr_control_bar);
				if(area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_NEXT_PAGE)
				{
						gdi_image_draw_blend2layers(area_ptr->items[i].indicator.x +((area_ptr->items[i].indicator.width-img_width)/2) , area_ptr->items[i].indicator.y  + ((area_ptr->component_height - img_height)/2), area_ptr->cand_down_arrow_down);
				}
				else
				{
						gdi_image_draw_blend2layers(area_ptr->items[i].indicator.x +((area_ptr->items[i].indicator.width-img_width)/2) , area_ptr->items[i].indicator.y  + ((area_ptr->component_height - img_height)/2), area_ptr->cand_down_arrow_disable);
				}
				break;
			case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_BACK:
				if(area_ptr->back_button_state == MMI_IMUI_ARROW_PRESSED)
				{
					temp_img_ptr_control_bar = area_ptr->cand_highlight;
				}
				else
				{
					temp_img_ptr_control_bar = area_ptr->cand_grid_background_black;
				}
				gui_measure_image(area_ptr->cand_back, &img_width, &img_height);
				gdi_image_draw_resized_blend2layers(area_ptr->items[i].indicator.x + border_width, 
                               area_ptr->items[i].indicator.y + border_width,
                               area_ptr->items[i].indicator.width - border_width, 
                               area_ptr->component_height - border_width, 
                               temp_img_ptr_control_bar);
				gdi_image_draw_blend2layers(area_ptr->items[i].indicator.x +((area_ptr->items[i].indicator.width-img_width)/2) , area_ptr->items[i].indicator.y + ((area_ptr->component_height - img_height)/2)  , area_ptr->cand_back);
				break;

                
            case MMI_IMUI_SELECTION_AREA_ITEM_TYPE_CANDIDATE:
				if(g_imui_is_down_in_grid == MMI_FALSE)
				{
                mmi_fe_enable_ucs2_proprietary_display();
                offset_x = (area_ptr->items[i].candidate.width - area_ptr->items[i].candidate.str_width) / 2;
                offset_y = (area_ptr->items[i].candidate.height - area_ptr->items[i].candidate.str_height) / 2;
                if (candidate_index == area_ptr->highlight_index)
                {
                    if (mmi_ime_word_is_redicals(area_ptr->items[i].candidate.string_original[0]))
                    {
                        highlight_color = g_imui_ui_theme.stroke_highlight_color;
                        text_color = g_imui_ui_theme.highlighted_stroke_color;
						temp_img_ptr = area_ptr->cand_highlight;
                    }
                    else
                    {
                        highlight_color = area_ptr->area_theme.highlight_color;
                        text_color =  area_ptr->area_theme.highlighted_text_color;
						temp_img_ptr = area_ptr->cand_highlight;
                    }
                    
           
                   
               
                }
                else
                {
                    if (mmi_ime_word_is_redicals(area_ptr->items[i].candidate.string_original[0]))
                    {
						 temp_img_ptr = area_ptr->cand_background;
                        text_color = g_imui_ui_theme.stroke_color;
                    }
                    else
                    {
						 temp_img_ptr = area_ptr->cand_background;
                        text_color =  area_ptr->area_theme.text_color;
                    }
                }
				 /*if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_FOCUS)
                    {
                        temp_img_ptr = area_ptr->cand_highlight;
                    }
                    else
                    {
                        temp_img_ptr = area_ptr->cand_background;
                    }*/

                    if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                    {
                        mmi_imui_get_r2l_coordinate(area_ptr->items[i].candidate.x,
                                                    area_ptr->items[i].candidate.width,
                                                    last_x,
                                                    &temp_x);
                        
						gdi_image_draw_resized_blend2layers(temp_x + area_ptr->x + border_width, 
                               area_ptr->items[i].candidate.y ,
                               area_ptr->items[i].candidate.width, 
                               area_ptr->items[i].candidate.height, 
                               temp_img_ptr);
                    }
                    else
                    {
						gdi_image_draw_resized_blend2layers(area_ptr->items[i].candidate.x + area_ptr->x, 
                               area_ptr->items[i].candidate.y ,
                               area_ptr->items[i].candidate.width, 
                               area_ptr->items[i].candidate.height, 
                               temp_img_ptr);
                    }
                if (area_ptr->flags & MMI_IMUI_SELECTION_AREA_FLAG_R2L)
                {
                    mmi_imui_get_r2l_coordinate(area_ptr->items[i].candidate.x + offset_x,
                                                area_ptr->items[i].candidate.str_width,
                                                last_x,
                                                &temp_x);
                #if defined(__MMI_IME_USER_DATABASE__)
                    if (*(area_ptr->items[i].candidate.string) == MMI_IME_USER_DATABASE_NEW_WORD)
                    {
                        mmi_imui_draw_string_for_selection_area_grid(
                            area_ptr,
                            temp_x + area_ptr->x, 
                            offset_y + area_ptr->items[i].candidate.y,
                            area_ptr->baseline, 
                            g_imui_new_word_prompt_ptr, 
                            area_ptr->items[i].candidate.str_len,
                            area_ptr->font_text,
                            text_color);
                    }
                    else
                #endif
                    {
                        mmi_imui_draw_string_for_selection_area_grid(
                            area_ptr,
                            temp_x + area_ptr->x, 
                            offset_y + area_ptr->items[i].candidate.y, 
                            area_ptr->baseline, 
                            area_ptr->items[i].candidate.string, 
                            area_ptr->items[i].candidate.str_len,
                            area_ptr->font_text,
                            text_color);
                    }
                }
                else
                {
                #if defined(__MMI_IME_USER_DATABASE__)
                    if (*(area_ptr->items[i].candidate.string) == MMI_IME_USER_DATABASE_NEW_WORD)
                    {
                        mmi_imui_draw_string_for_selection_area_grid(
                            area_ptr,
                            area_ptr->items[i].candidate.x + area_ptr->x + offset_x, 
                            offset_y + area_ptr->items[i].candidate.y,
                            area_ptr->baseline, 
                            g_imui_new_word_prompt_ptr, area_ptr->items[i].candidate.str_len,
                            area_ptr->font_text,
                            text_color);
                    }
                    else
                #endif
                    {
                        mmi_imui_draw_string_for_selection_area_grid(
                            area_ptr,
                            area_ptr->items[i].candidate.x + area_ptr->x + offset_x, 
                            offset_y + area_ptr->items[i].candidate.y, 
                            area_ptr->baseline, 
                            area_ptr->items[i].candidate.string, 
                            area_ptr->items[i].candidate.str_len,
                            area_ptr->font_text,
                            text_color);
                    }
                }
                mmi_fe_disable_ucs2_proprietary_display();
				}
                candidate_index++;
                break;
                
            default:
                break;
        }
    }
    gui_pop_clip();
    gdi_layer_unlock_frame_buffer();
    gdi_layer_blt_previous(area_ptr->x, area_ptr->y, area_ptr->x + area_ptr->width - 1, area_ptr->y + area_ptr->height - 1);

}
#endif


#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_input_area
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_update_input_area(mmi_imui_input_area_struct_p area_ptr, mmi_imui_update_input_area_struct_p update_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 width = 0, height = 0, width_1 = 0;
    UI_character_type temp_code;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    area_ptr->flags = update_ptr->flags;
    area_ptr->str_ptr = update_ptr->str_ptr;
    area_ptr->highlight_num = update_ptr->highlight_num;

    area_ptr->text_width = area_ptr->width;
    area_ptr->text_area_x = 0;

    area_ptr->text_area_x += MMI_IMUI_INPUT_AREA_LEFT_SPACING;
    area_ptr->text_width -= (MMI_IMUI_INPUT_AREA_LEFT_SPACING + MMI_IMUI_INPUT_AREA_RIGHT_SPACING);

	if (area_ptr->style & MMI_IMUI_INPUT_AREA_STYLE_BORDER)
	{
        area_ptr->text_area_x++;
        area_ptr->text_width -= 2;
	}

    area_ptr->text_area_x++; /* One pixel space between text and border or edge */
    area_ptr->text_width -= 2;

    mmi_imui_get_string_extent(g_imui_ui_theme.font_text, area_ptr->str_ptr, &width, &height);

    area_ptr->text_base_y = (area_ptr->height - height) / 2 + height;
    area_ptr->text_y = MMI_IMUI_INPUT_AREA_VER_GAP;
        
    if (area_ptr->style & MMI_IMUI_INPUT_AREA_STYLE_CURSOR)
    {
        width += g_imui_ui_param.cursor_width;
    }

    if (width > area_ptr->text_width)
    {
        area_ptr->text_x = area_ptr->text_area_x + area_ptr->text_width - width;
    }
    else
    {
        area_ptr->text_x = area_ptr->text_area_x;
    }
    
    if (area_ptr->style & MMI_IMUI_INPUT_AREA_STYLE_CURSOR)
    {
        area_ptr->text_x += g_imui_ui_param.cursor_width;
        area_ptr->cursor_x = area_ptr->text_x;
        
        if (update_ptr->cursor_index > 0)
        {
            temp_code = area_ptr->str_ptr[update_ptr->cursor_index];
            area_ptr->str_ptr[update_ptr->cursor_index] = 0;
            mmi_imui_get_string_extent(g_imui_ui_theme.font_text, area_ptr->str_ptr, &width, &height);
            area_ptr->str_ptr[update_ptr->cursor_index] = temp_code;

            area_ptr->cursor_x += width;
        }
    
		while (area_ptr->cursor_x + g_imui_ui_param.cursor_width > area_ptr->text_width - 1)
        {
            area_ptr->text_x--;
            area_ptr->cursor_x--;
		}
        
        while (area_ptr->cursor_x < area_ptr->text_area_x)
        {
            area_ptr->text_x++;
            area_ptr->cursor_x++;
        }
    }


    if (area_ptr->style & MMI_IMUI_INPUT_AREA_STYLE_WAVE)
    {
        temp_code = area_ptr->str_ptr[update_ptr->wave_start_index + update_ptr->wave_num];
        area_ptr->str_ptr[update_ptr->wave_start_index + update_ptr->wave_num] = 0;
        mmi_imui_get_string_extent(g_imui_ui_theme.font_text, &area_ptr->str_ptr[update_ptr->wave_start_index], &width, &height);
        area_ptr->str_ptr[update_ptr->wave_start_index + update_ptr->wave_num] = temp_code;
                area_ptr->wave_length = width;

        temp_code = area_ptr->str_ptr[update_ptr->wave_start_index];
        area_ptr->str_ptr[update_ptr->wave_start_index] = 0;
        mmi_imui_get_string_extent(g_imui_ui_theme.font_text, area_ptr->str_ptr, &width, &height);
        area_ptr->str_ptr[update_ptr->wave_start_index] = temp_code;
        area_ptr->wave_x= area_ptr->text_x + width;
    }
}
#endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/


#if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_resizable_composition_area
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static S32 mmi_imui_update_resizable_composition_area(mmi_imui_resizable_composition_area_struct_p area_ptr, 
                                                      mmi_imui_update_selection_area_struct_p update_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 width = 0, height = 0;
    S32 ascent = 0, descent = 0;
    S32 img_width = 0, img_height = 0;
    S32 max_width = UI_device_width * 2 / 3;
    S32 text_offset = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    MMI_ASSERT(update_ptr->str_ptr);
    
    mmi_fe_enable_ucs2_proprietary_display();
    
    mmi_imui_get_string_extent(g_imui_ui_theme.font_text, update_ptr->str_ptr, &width, &height);

    mmi_fe_disable_ucs2_proprietary_display();

    if (width)
    {
        area_ptr->width = width + MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_LEFT_SPACEING + MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_RIGHT_SPACEING;

        if (area_ptr->width > max_width)
        {
            text_offset = area_ptr->width - max_width;

            area_ptr->width = max_width;
        }
    }
    else
    {
        MMI_ASSERT(0);
    }

    area_ptr->str_ptr = update_ptr->str_ptr;

    area_ptr->string_x = MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_LEFT_SPACEING - text_offset;

    mmi_fe_get_char_info_of_all_lang(g_imui_ui_theme.font_text->size, &height, &ascent, &descent);
    
    if (MMI_IMUI_FTE_INPUT_BOX_HEIGHT_SMALL - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT - height - MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_VER_GAP >= 0)
    {
        area_ptr->height = MMI_IMUI_FTE_INPUT_BOX_HEIGHT_SMALL;
        area_ptr->background_img_ptr = g_imui_ui_theme.input_background_small;
    }
    else if (MMI_IMUI_FTE_INPUT_BOX_HEIGHT_MEDIUM - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT - height - MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_VER_GAP >= 0)
    {
        area_ptr->height = MMI_IMUI_FTE_INPUT_BOX_HEIGHT_MEDIUM;
        area_ptr->background_img_ptr = g_imui_ui_theme.input_background_medium;
    }
    else if (MMI_IMUI_FTE_INPUT_BOX_HEIGHT_LARGE - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT - height - MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_VER_GAP >= 0)
    {
        area_ptr->height = MMI_IMUI_FTE_INPUT_BOX_HEIGHT_LARGE;
        area_ptr->background_img_ptr = g_imui_ui_theme.input_background_large;
    }
    else
    {
        MMI_ASSERT(0);
    }

    area_ptr->string_y = (area_ptr->height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT - height - MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_VER_GAP) / 2 + MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_VER_GAP;

    area_ptr->baseline = ascent;

    return 0;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_show_resizable_composition_area
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_show_resizable_composition_area(mmi_imui_resizable_composition_area_struct_p area_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 x1, y1, x2, y2;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	gdi_layer_lock_frame_buffer();

	gui_push_clip();

	gui_set_clip(area_ptr->x, area_ptr->y, area_ptr->x + area_ptr->width - 1, area_ptr->y + area_ptr->height - 1);

#if defined(__MMI_VUI_ENGINE__)
    if (!vadp_p2v_uc_is_in_venus())
#endif
    {
        area_ptr->cursor_stopped = UI_inputbox_stop_cursor(area_ptr->x,
                                       area_ptr->y,
                                       area_ptr->x + area_ptr->width - 1,
                                       area_ptr->y + area_ptr->height - 1);
    }

    gdi_image_draw_resized_blend2layers(area_ptr->x, 
                           area_ptr->y, 
                           area_ptr->width, 
                           area_ptr->height,
                           area_ptr->background_img_ptr);

    gdi_layer_get_clip(&x1, &y1, &x2, &y2);

    mmi_fe_enable_ucs2_proprietary_display();

    if (!(x1 > area_ptr->x + area_ptr->width - 1 - MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_RIGHT_SPACEING || 
          y1 > area_ptr->y + area_ptr->height - 1 - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT ||
          x2 < area_ptr->x + MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_LEFT_SPACEING || 
          y2 < area_ptr->y))
    {
        gdi_layer_push_clip();
        
        gdi_layer_set_clip(area_ptr->x + MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_LEFT_SPACEING,
            area_ptr->y,
            area_ptr->x + area_ptr->width - 1 - MMI_IMUI_RESIZEABLE_COMP_AREA_TEXT_RIGHT_SPACEING,
            area_ptr->y + area_ptr->height - 1 - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT);
        
        mmi_imui_draw_string(area_ptr->x + area_ptr->string_x, 
            area_ptr->y + area_ptr->string_y,
            area_ptr->baseline,
            area_ptr->str_ptr,
            mmi_ucs2strlen((const S8 *)area_ptr->str_ptr),
            g_imui_ui_theme.font_text,
            g_imui_candidate_box.area_theme.text_color);
        
        gdi_layer_pop_clip();
    }  
    else
    {
        mmi_imui_draw_string(area_ptr->x + area_ptr->string_x, 
            area_ptr->y + area_ptr->string_y,
            area_ptr->baseline,
            area_ptr->str_ptr,
            mmi_ucs2strlen((const S8 *)area_ptr->str_ptr),
            g_imui_ui_theme.font_text,
            g_imui_candidate_box.area_theme.text_color);
    }    
    gui_pop_clip();
    gdi_layer_unlock_frame_buffer();
    gdi_layer_blt_previous(area_ptr->x, area_ptr->y, area_ptr->x + area_ptr->width - 1, area_ptr->y + area_ptr->height - 1);
    mmi_fe_disable_ucs2_proprietary_display();
    
    area_ptr->last_showed_width = area_ptr->width;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_resizable_composition_area
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static S32 mmi_imui_draw_resizable_composition_area(S32 bottom_line)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    g_imui_control_set.control_bottoms[MMI_IMUI_COMPOSITION_AREA] = bottom_line;

    if (g_imui_candidate_box.flags & MMI_IMUI_SELECTION_AREA_FLAG_FLOATING)
    {
        g_imui_resizable_composition_box.x = g_imui_ui_param.imui_floating_left + MMI_IMUI_CANDIDATE_BOX_LEFT_GAP;
    }
    else
    {
        g_imui_resizable_composition_box.x = g_imui_ui_param.imui_left + MMI_IMUI_CANDIDATE_BOX_LEFT_GAP;
    }
	//g_imui_resizable_composition_box.y = bottom_line - g_imui_resizable_composition_box.height  + 1;
    
    g_imui_resizable_composition_box.y = bottom_line - g_imui_resizable_composition_box.height + MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT + 1;


#if defined(__MMI_VUI_ENGINE__)
    if (vadp_p2v_uc_is_in_venus())
    {
        mmi_imui_draw_back_ground(0, 
            g_imui_resizable_composition_box.y, 
            g_imui_ui_param.imui_floating_width - 1,
            g_imui_resizable_composition_box.y + g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT - 1);
    }
#endif

    mmi_imui_show_resizable_composition_area(&g_imui_resizable_composition_box);

    return (bottom_line - (MMI_IMUI_COMPOSITION_BOX_TOP_GAP + 
            g_imui_resizable_composition_box.height - MMI_IMUI_RESIZEABLE_COMP_AREA_COVERED_BOTTOM_HEIGHT));
}
#endif /*#if defined(__MMI_IME_FLOATING_CAND_BOX__) && defined(__MMI_IME_FTE_ENHANCE__)*/


#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_show_input_area
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_show_input_area(mmi_imui_input_area_struct_p area_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 bg_x, bg_width;
	color bd_color;
    UI_filled_area *bg_filler;
    //S32 x1, x2;
    S32 cursor_height = g_imui_ui_param.cursor_height;
    S32 temp_x = 0, temp_x1 = 0, temp_x2 = 0;
    S32 last_x = 0;
    S32   width;
    S32	  height;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();

    bg_x = area_ptr->x + MMI_IMUI_INPUT_AREA_LEFT_SPACING;
    
    bg_width = area_ptr->width - (MMI_IMUI_INPUT_AREA_LEFT_SPACING + MMI_IMUI_INPUT_AREA_RIGHT_SPACING);

        /* Draw  border and background */
    if (area_ptr->flags & MMI_IMUI_INPUT_AREA_FLAG_FOCUS) 
    {
        bd_color = g_imui_ui_theme.focused_border_color;
        bg_filler = g_imui_ui_theme.focused_background_filler;
    }
    else 
    {
        bd_color = g_imui_ui_theme.border_color;
        bg_filler = g_imui_ui_theme.background_filler;
    }

#ifdef __MMI_CSTAR_PHRASE_INPUT__
    if (area_ptr == &g_imui_input_box)
    {
        gui_push_clip();
        
	    gui_set_clip(area_ptr->x, area_ptr->y, area_ptr->x + area_ptr->width - 1, area_ptr->y + area_ptr->height - 1);        

        gdi_image_draw_resized_blend2layers(area_ptr->x, 
                               area_ptr->y, 
                               area_ptr->width, 
                               area_ptr->height,
                               g_imui_composition_box.cand_background);
                               
        mmi_imui_draw_string(area_ptr->text_x + area_ptr->x, 
						     MMI_IMUI_INPUT_AREA_VER_GAP + area_ptr->y,
						     area_ptr->baseline,
						     area_ptr->str_ptr, 
						     mmi_ucs2strlen((const S8 *)area_ptr->str_ptr), 
						     g_imui_ui_theme.font_text,
						     area_ptr->area_theme.text_color);

        gui_pop_clip();                              
    }
    else
    {
#endif    
	gui_push_clip();
	gui_set_clip(bg_x, area_ptr->y, bg_x + bg_width - 1, area_ptr->y + area_ptr->height - 1);
    
	gdi_draw_solid_rect(bg_x + 1, area_ptr->y + 1, 
                        bg_x + bg_width - 2, area_ptr->y + area_ptr->height - 2, GDI_COLOR_WHITE);

    if (area_ptr->style & MMI_IMUI_INPUT_AREA_STYLE_BORDER)
    {
        gui_draw_filled_area(bg_x + 1, area_ptr->y + 1, 
                             bg_x + bg_width - 2, area_ptr->y + area_ptr->height - 2, 
                             bg_filler);
        
        gdi_draw_line(bg_x + 1, 
            area_ptr->y, 
            bg_x + bg_width - 2, 
            area_ptr->y, 
            gdi_act_color_from_rgb(255, bd_color.r, bd_color.g, bd_color.b));
        
        gdi_draw_line(bg_x + 1, 
            area_ptr->y + area_ptr->height - 1, 
            bg_x + bg_width - 2, 
            area_ptr->y + area_ptr->height - 1, 
            gdi_act_color_from_rgb(255, bd_color.r, bd_color.g, bd_color.b));

        gdi_draw_line(bg_x, 
            area_ptr->y + 1, 
            bg_x, 
            area_ptr->y + area_ptr->height - 2, 
            gdi_act_color_from_rgb(255, bd_color.r, bd_color.g, bd_color.b));

        gdi_draw_line(bg_x + bg_width - 1, 
            area_ptr->y + 1, 
            bg_x + bg_width - 1, 
            area_ptr->y + area_ptr->height - 2, 
            gdi_act_color_from_rgb(255, bd_color.r, bd_color.g, bd_color.b));     
    }
    else
    {
        gui_draw_filled_area(bg_x, area_ptr->y, 
                             bg_x + bg_width - 1, area_ptr->y + area_ptr->height - 1, 
                             bg_filler);
    }

	gui_pop_clip();


    gui_push_clip();
    gui_set_clip(area_ptr->text_area_x + area_ptr->x, area_ptr->y, area_ptr->x + area_ptr->text_area_x + area_ptr->text_width - 1, area_ptr->y + area_ptr->height - 1);
    
#ifdef __MMI_TOUCH_SCREEN__
	cursor_height = area_ptr->height - 2; /* 2 is border width */
#else
	cursor_height = area_ptr->height - 4; /* 2 is border width, 2 is the two gaps in the top and the bottom */
#endif

    if ((area_ptr->height - cursor_height) % 2)
    {
        cursor_height++;
    }

    if (area_ptr->flags & MMI_IMUI_INPUT_AREA_FLAG_R2L)
    {
        mmi_imui_get_string_extent(g_imui_ui_theme.font_text, area_ptr->str_ptr, &width, &height);

	    last_x = area_ptr->width - 1;
		
        mmi_imui_get_r2l_coordinate(area_ptr->text_x,
        width,
        last_x,
        &temp_x);
    
        mmi_imui_draw_string_r2l(temp_x + area_ptr->x, 
								 MMI_IMUI_INPUT_AREA_VER_GAP + area_ptr->y,
							     area_ptr->baseline,
							     area_ptr->str_ptr, 
								 mmi_ucs2strlen((const S8 *)area_ptr->str_ptr), 
							     g_imui_ui_theme.font_text,
							     area_ptr->area_theme.text_color);
 	}

    else
    {
        mmi_imui_draw_string(area_ptr->text_x + area_ptr->x, 
							 MMI_IMUI_INPUT_AREA_VER_GAP + area_ptr->y,
							 area_ptr->baseline,
							 area_ptr->str_ptr, 
							 mmi_ucs2strlen((const S8 *)area_ptr->str_ptr), 
							 g_imui_ui_theme.font_text,
							 area_ptr->area_theme.text_color);
    }


    if (area_ptr->style & MMI_IMUI_INPUT_AREA_STYLE_CURSOR)
    {
        if (area_ptr->flags & MMI_IMUI_INPUT_AREA_FLAG_R2L)
        {
	        mmi_imui_get_r2l_coordinate(area_ptr->cursor_x,
            g_imui_ui_param.cursor_width,
            last_x,
            &temp_x);

		    gui_fill_rectangle(temp_x + area_ptr->x, 
                           area_ptr->y + (area_ptr->height - cursor_height) / 2, 
                           area_ptr->x + temp_x + g_imui_ui_param.cursor_width - 1 , 
                           area_ptr->y + (area_ptr->height - cursor_height) / 2 + cursor_height - 1, 
                           g_imui_ui_theme.cursor_color);    
         }
		 else
	     {
        gui_fill_rectangle(area_ptr->cursor_x + area_ptr->x, 
                           area_ptr->y + (area_ptr->height - cursor_height) / 2, 
                           area_ptr->cursor_x + area_ptr->x + (g_imui_ui_param.cursor_width - 1), 
                           area_ptr->y + (area_ptr->height - cursor_height) / 2 + cursor_height - 1, 
                           g_imui_ui_theme.cursor_color);    
    }
	  }
        
    if (area_ptr->style & MMI_IMUI_INPUT_AREA_STYLE_WAVE && area_ptr->wave_length > 0)
    {
        mmi_imui_draw_wave_underline(area_ptr->x + area_ptr->wave_x, 
                                     area_ptr->y + area_ptr->text_base_y, 
                                     area_ptr->wave_length,
                                     g_imui_ui_theme.underline_color);
    }
    
    gui_pop_clip();

#ifdef __MMI_CSTAR_PHRASE_INPUT__
    }
#endif    

    gdi_layer_unlock_frame_buffer();
    gdi_layer_blt_previous(area_ptr->x, area_ptr->y, area_ptr->x + area_ptr->width - 1, area_ptr->y + area_ptr->height - 1);
}
#endif /*#if defined(MMI_IMUI_INPUT_AND_TITLE_BOX)*/


/*****************************************************************************
 * FUNCTION
 *  mmi_cstar_draw_wave_underline
 * DESCRIPTION
 *  draw wave underline
 * PARAMETERS
 *  x       [IN]        
 *  y       [IN]        
 *  w       [IN]        width
 *  c       [IN]        color
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_wave_underline(S32 x, S32 y, S32 w, color c)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    S32 x_pos;
    S32 x_end;
    S32 y_off;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (w == 0)
        return;

    for (x_pos = x, x_end = x + w, y_off = 0; x_pos < x_end; x_pos += 2)
    {
        gui_putpixel(x_pos, y + y_off, c);
        gui_putpixel(x_pos + 1, y + y_off, c);
        y_off = ((y_off + 1) & 1);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_char_extent
 * DESCRIPTION
 *  Fetch character extent
 * PARAMETERS
 *  type            [IN]        font type
 *  code            [IN]        UCS2 code
 *  width_ptr       [OUT]       variable for retrieving width
 *  height_ptr      [OUT]       variable for retrieving height
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_get_char_extent(UI_font_type type, UI_character_type code, S32 *width_ptr, S32 *height_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //UI_font_type font_backup;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    /*UI_font always pointes to the static font attribute in this function. 
	 * Hence, the backup and resuming are useless. So we are commenting the 
	 * code, because it would waste time to set font
	 */

    //font_backup = UI_font;
    gui_set_font(type);
    gui_measure_character(code, width_ptr, height_ptr);
    //gui_set_font(font_backup);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_string_extent
 * DESCRIPTION
 *  Fetch character extent
 * PARAMETERS
 *  type            [IN]        font type
 *  string          [IN]        string pointer
 *  width_ptr       [?]         variable for retrieving width
 *  height_ptr      [?]         variable for retrieving height
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_get_string_extent(UI_font_type type, UI_string_type string, S32 *width_ptr, S32 *height_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UI_font_type font_backup;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    font_backup = UI_font;
    gui_set_font(type);
    Get_StringWidthHeight((U8 *)string, width_ptr, height_ptr);
    gui_set_font(font_backup);
}
#if defined(__MMI_IME_CANDIDATE_GRID__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_string_extent_for_selection_area_grid
 * DESCRIPTION
 *  Fetch character extent for selection area_grid
 * PARAMETERS
 *  area_ptr        [IN]        selection area pointer
 *  type            [IN]        font type
 *  string          [IN]        string pointer
 *  width_ptr       [?]         variable for retrieving width
 *  height_ptr      [?]         variable for retrieving height
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_get_string_extent_for_selection_area_grid(mmi_imui_selection_area_grid_struct_p area_ptr, UI_font_type type, UI_string_type string, S32 *width_ptr, S32 *height_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UI_character_type temp_string[MMI_IMC_MAX_INPUT_SYMBOL_BUFFSIZE * 2 + 1];
    S32 i = 0, j = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_fe_enable_ucs2_proprietary_display();
#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_SPACE_AFTER_APOSTROPHE)
    if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_SPACE_AFTER_APOSTROPHE)
    {
        while(string[i] != 0)
        {
            if (string[i] == 0x0027)
            {
                temp_string[j++] = string[i++];
                temp_string[j++] = 0x0020;
            }
            else
            {
                temp_string[j++] = string[i++];
            }
        }

        MMI_ASSERT(j <= MMI_IMC_MAX_INPUT_SYMBOL_BUFFSIZE * 2);

        temp_string[j] = 0;
        
        mmi_imui_get_string_extent(type, &temp_string[0], width_ptr, height_ptr);
    }
    else
#endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_SPACE_AFTER_APOSTROPHE)*/
    {
        mmi_imui_get_string_extent(type, string, width_ptr, height_ptr);
    }
    mmi_fe_disable_ucs2_proprietary_display();



}
#endif

/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_string_extent_for_selection_area
 * DESCRIPTION
 *  Fetch character extent for selection area
 * PARAMETERS
 *  area_ptr        [IN]        selection area pointer
 *  type            [IN]        font type
 *  string          [IN]        string pointer
 *  width_ptr       [?]         variable for retrieving width
 *  height_ptr      [?]         variable for retrieving height
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_get_string_extent_for_selection_area(mmi_imui_selection_area_struct_p area_ptr, UI_font_type type, UI_string_type string, S32 *width_ptr, S32 *height_ptr)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UI_character_type temp_string[MMI_IMC_MAX_INPUT_SYMBOL_BUFFSIZE * 2 + 1];
    S32 i = 0, j = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    mmi_fe_enable_ucs2_proprietary_display();
#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_SPACE_AFTER_APOSTROPHE)
    if (area_ptr->style & MMI_IMUI_SELECTION_AREA_STYLE_SPACE_AFTER_APOSTROPHE)
    {
        while(string[i] != 0)
        {
            if (string[i] == 0x0027)
            {
                temp_string[j++] = string[i++];
                temp_string[j++] = 0x0020;
            }
            else
            {
                temp_string[j++] = string[i++];
            }
        }

        MMI_ASSERT(j <= MMI_IMC_MAX_INPUT_SYMBOL_BUFFSIZE * 2);

        temp_string[j] = 0;
        
        mmi_imui_get_string_extent(type, &temp_string[0], width_ptr, height_ptr);
    }
    else
#endif
    {
#if defined (__MMI_MULTITAP_BANGLA_SPEC__)
		#if defined(__MMI_VECTOR_FONT_SUPPORT__)
    /*if(string[0] == 0x09b0 && string[1] == 0x09cd )
	{
		string[0] = 0xA42f;
                string[1] = 0x0000;
	}
	else if(string[0] == 0x09cd && string[1]== 0x09b0 )
	{
		string[0] = 0xA431;
                string[1] = 0x0000;
	}
	 else if(string[0] == 0x09cd && string[1] == 0x09af )
	{
		string[0] = 0xA430;
                string[1] = 0x0000;
	}
#else*/
		if(string[0] == 0x09b0 && string[1]== 0x09cd)
			check_ra_hal_bangla_for_imui = MMI_TRUE;
#endif
#endif
        mmi_imui_get_string_extent(type, string, width_ptr, height_ptr);
    #if defined (__MMI_MULTITAP_BANGLA_SPEC__)
		check_ra_hal_bangla_for_imui = MMI_FALSE;
#endif
    }
    mmi_fe_disable_ucs2_proprietary_display();
    

    
}


#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_INDEX)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_reorder_candidates_to_center_first
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_reorder_candidates_to_center_first(UI_string_type str, S32 count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 new_index[(MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_CHINESE > MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN ? MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_CHINESE : MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_LATIN)] = {0};
    UI_string_type temp_str;
    S32 index = 0;    
    S32 index_0 = (count - 1)/2;
    S32 i = 1;
    S32 mux = 1;    
    S32 len = 0;
    S32 j = 0;
    ///TODO: currently, only Chinese input mode need this function and all candidate is one character. Hence, set buffer size as MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_CHINESE * 2
    UI_character_type temp_candidates[MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_CHINESE * 2];
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    memcpy(temp_candidates, str, 2 * MMI_IMC_MAX_CANDIDATE_IN_ONE_PAGE_CHINESE * sizeof(UI_character_type));

    /* reorder the sequence */
    for (i = 1; i < count; i ++)
    {
        if ((i & 1) == 0)
        {
            mux = -1;
        }
        else
        {
            mux = 1;
        }
        
        index = (index_0) + (mux * ((i + 1)/2));
        new_index[index] = i;
    }

    for (i = 0; i < count; i ++)
    {
        temp_str = mmi_imui_get_string_by_index(temp_candidates, new_index[i], count);
        
        if (temp_str)
        {
            len = mmi_ucs2strlen((const S8 *)temp_str);
            
            memcpy(&str[j], temp_str, sizeof(UI_character_type) * (len + 1));
            j += (len + 1);
        }
        else
        {
            str[j] = 0;
            j++;
        }
    }

}
#endif /*#if defined(MMI_IMUI_SELECTION_AREA_CONFIG_STYLE_CENTER_INDEX)*/


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_string_by_index
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static UI_string_type mmi_imui_get_string_by_index(UI_string_type str, S32 index, S32 count)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UI_string_type temp_str;
    S32 len, i = 0;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    if (!str[0] || index >= count)
    {
        return NULL;
    }

    temp_str = str;
    
    while(i < index)
    {
        len = mmi_ucs2strlen((const S8 *)temp_str);

        temp_str += (len + 1);
        i++;
    }

    return temp_str;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_r2l_coordinate
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_get_r2l_coordinate(S32 source_x, S32 width, S32 last_x, S32 *destination_x)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    *destination_x = (last_x - source_x) - width + 1;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_ime_hint_width
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static S32 mmi_imui_get_ime_hint_width(void)
{
	/*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	S32 width, height;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	mmi_imui_get_ime_hint_size(&width, &height);

	return width;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_ime_hint_height
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static S32 mmi_imui_get_ime_hint_height(void)
{
	/*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	S32 width, height;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

	mmi_imui_get_ime_hint_size(&width, &height);

	return height;
}



/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_ime_hint_size
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_get_ime_hint_size(S32 *hint_width, S32 *hint_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_imm_input_mode_info_struct_p hint_info = NULL;
    UI_string_type inputmode_string = NULL;
    PU8 inputmode_icon = NULL;
	mmi_imm_input_mode_hint_item_struct_p hint_item = NULL;
#if !defined(__MMI_TOUCH_SCREEN__) || defined(__MMI_IME_FTE_ENHANCE__)
    stFontAttribute *f = &MMI_small_font;
#else /* !defined(__MMI_TOUCH_SCREEN__) */ 
    stFontAttribute *f = &MMI_medium_font;//MMI_medium_font
#endif /* !defined(__MMI_TOUCH_SCREEN__) */ 
    S32 width = 0, height = 0, ret_width = 0;
    const sIMEModeDetails * inputmode_detail = NULL;
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    PU8 switch_icon = NULL;
#endif
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    *hint_width = 0;
    
    *hint_height = 0;

#ifdef __MMI_IME_PLUG_IN__
    if (mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_GET_CURRENT_IME_INDICATOR_SIZE, (U32)hint_width, (U32)hint_height) == 1)
    {
        return;
    }
#endif
    
    hint_info = (mmi_imm_input_mode_info_struct_p)mmi_imm_get_curr_input_mode_hint_info();

    if (hint_info == NULL)
    {
        return;
    }

	hint_item = hint_info->hint_item_ptr;

    while ((hint_item->display_flag != MMI_IME_HINT_FLAG_NONE))
    {
        if ((hint_item->display_flag & MMI_IME_HINT_FLAG_CSK)
        #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
            && (hint_item->display_flag & mmi_imm_get_current_input_case())
        #endif
            )
        {
            if (hint_item->hint_type == MMI_IME_HINT_TYPE_STRING)
            {
                inputmode_string = (UI_string_type)get_string(hint_item->hint_id);
            }
        
            if (hint_item->hint_type == MMI_IME_HINT_TYPE_IMAGE)
            {
                inputmode_icon = get_image(hint_item->hint_id);
            }
            break;
		}
		hint_item ++;
    }
	
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    if (hint_item->display_flag == MMI_IME_HINT_FLAG_NONE)
    {
		hint_item = hint_info-> hint_item_ptr;
		
        while ((hint_item->display_flag != MMI_IME_HINT_FLAG_NONE))
		{
			if ((hint_item->display_flag & MMI_IME_HINT_FLAG_CSK))
			{
				if (hint_item->hint_type == MMI_IME_HINT_TYPE_STRING)
				{
					inputmode_string = (UI_string_type)get_string(hint_item->hint_id);
				}
				
				if (hint_item->hint_type == MMI_IME_HINT_TYPE_IMAGE)
				{
					inputmode_icon = get_image(hint_item->hint_id);
				}
				break;
			}
			hint_item ++;
		}
    }
#endif

    if (inputmode_string == NULL && inputmode_icon == NULL)
    {
        return;
    }

#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    if (mmi_imm_get_special_key_icon() != 0)
    {
        switch_icon = get_image(mmi_imm_get_special_key_icon());
    
        if (hint_item->display_flag & mmi_imm_get_current_input_case()
            && (mmi_imm_get_special_key_icon() == IMG_IME_QWERTY_SHIFT || mmi_imm_get_special_key_icon() == IMG_IME_QWERTY_SHIFT_LOCK))
        {
            switch_icon = NULL;
        }
    }
#endif
	
    inputmode_detail = mmi_imm_get_input_mode_array_item(mmi_imm_get_curr_input_mode());

    MMI_ASSERT(inputmode_detail);
    
#if defined(__MMI_IME_FTE_ENHANCE__)
	#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
    if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
    {
        gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);
        
        *hint_width += (width + 3);

        *hint_height = (height > *hint_height) ? height : (*hint_height);
    }
    else
    #endif
    {
        gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);
        
        *hint_width += (width + 3);

        *hint_height = (height > *hint_height) ? height : (*hint_height);
    }    
#else    
    if ((((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_MULTITAP))
        || ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_NUMBERIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_DIRECT)))
         && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_PINYIN && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_BOPOMO) 
    {
        gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &width, &height);
    
        *hint_width += (width + 3);

        *hint_height = (height > *hint_height) ? height : (*hint_height);
    }
	#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
    else if ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART))
    {
        gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);
        
        *hint_width += (width + 3);

        *hint_height = (height > *hint_height) ? height : (*hint_height);
    }
#if defined(__MMI_ZI__)
    else if ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_PHONETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART))
    {
        gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &width, &height);
        
        *hint_width += (width + 3);

        *hint_height = (height > *hint_height) ? height : (*hint_height);
    }
#endif
    #endif//#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */
	
    if (NULL != inputmode_string)
    {
        mmi_imui_get_string_extent(f, inputmode_string, &width, &height);
        *hint_width += (width + MMI_IMUI_IME_HINT_LEFT_GAP + MMI_IMUI_IME_HINT_RIGHT_GAP);

        *hint_height = (height > *hint_height) ? height : (*hint_height);
    }
    else if (NULL != inputmode_icon)
    {
        gui_measure_image(inputmode_icon, &width, &height);
        *hint_width += (width + MMI_IMUI_IME_HINT_LEFT_GAP + MMI_IMUI_IME_HINT_RIGHT_GAP);

        *hint_height = (height > *hint_height) ? height : (*hint_height);
    }

#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
	if (switch_icon != NULL)
	{
		gui_measure_image(switch_icon, &width, &height);
		
	    *hint_width += (width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP);

	    *hint_height = (height > *hint_height) ? height : (*hint_height);
	}
#endif
	
    if (*hint_height > 0)
    {
        *hint_height += 2; /* for the vertical gaps of top and bottom */
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_ime_hint
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_ime_hint(mmi_imc_rect_p hint_rect)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_imm_input_mode_info_struct_p hint_info = NULL;
	U32 old_value;
    UI_string_type inputmode_string = NULL;
    PU8 inputmode_icon = NULL;
	mmi_imm_input_mode_hint_item_struct_p hint_item = NULL;
	color c = *current_MMI_theme->input_method_text_color;
#if !defined(__MMI_TOUCH_SCREEN__) || defined(__MMI_IME_FTE_ENHANCE__)
    stFontAttribute *f = &MMI_small_font;
#else /* !defined(__MMI_TOUCH_SCREEN__) */ 
    stFontAttribute *f = &MMI_medium_font;//MMI_medium_font
#endif /* !defined(__MMI_TOUCH_SCREEN__) */ 
    S32 width = 0, height = 0, x;
    S32 img_width = 0, img_height = 0;
    const sIMEModeDetails * inputmode_detail = NULL;
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    PU8 switch_icon = NULL;
	S32 switch_icon_width = 0, switch_icon_height = 0;
#endif
    gdi_handle old_src_layer,act_layer;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_IME_PLUG_IN__
    if (mmi_ime_sdk_send_sdk_msg(MMI_IME_SDK_MSG_DRAW_CURRENT_IME_INDICATOR, (U32)hint_rect, 0) == 1)
    {
        return;
    }
#endif

    hint_info = (mmi_imm_input_mode_info_struct_p)mmi_imm_get_curr_input_mode_hint_info();

    if (hint_info == NULL)
    {
        return;
    }

	hint_item = hint_info->hint_item_ptr;


    while ((hint_item->display_flag != MMI_IME_HINT_FLAG_NONE))
    {
        if ((hint_item->display_flag & MMI_IME_HINT_FLAG_CSK)
        #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
            && (hint_item->display_flag & mmi_imm_get_current_input_case())
        #endif
            )
        {
            if (hint_item->hint_type == MMI_IME_HINT_TYPE_STRING)
            {
                inputmode_string = (UI_string_type)get_string(hint_item->hint_id);
            }
        
            if (hint_item->hint_type == MMI_IME_HINT_TYPE_IMAGE)
            {
                inputmode_icon = get_image(hint_item->hint_id);
            }
            break;
		}
		hint_item ++;
    }
	
#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    if (hint_item->display_flag == MMI_IME_HINT_FLAG_NONE)
    {
		hint_item = hint_info-> hint_item_ptr;
		
        while ((hint_item->display_flag != MMI_IME_HINT_FLAG_NONE))
		{
			if ((hint_item->display_flag & MMI_IME_HINT_FLAG_CSK))
			{
				if (hint_item->hint_type == MMI_IME_HINT_TYPE_STRING)
				{
					inputmode_string = (UI_string_type)get_string(hint_item->hint_id);
				}
				
				if (hint_item->hint_type == MMI_IME_HINT_TYPE_IMAGE)
				{
					inputmode_icon = get_image(hint_item->hint_id);
				}
				break;
			}
			hint_item ++;
		}
    }
#endif

	
    if (inputmode_string == NULL && inputmode_icon == NULL)
    {
        return;
    }

#if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
    if (mmi_imm_get_special_key_icon() != 0)
    {
        switch_icon = get_image(mmi_imm_get_special_key_icon());
    
        if (hint_item->display_flag & mmi_imm_get_current_input_case()
            && (mmi_imm_get_special_key_icon() == IMG_IME_QWERTY_SHIFT || mmi_imm_get_special_key_icon() == IMG_IME_QWERTY_SHIFT_LOCK))
        {
            switch_icon = NULL;
        }
    }
#endif
	
	
    if (NULL != inputmode_string)
    {
        mmi_imui_get_string_extent(f, inputmode_string, &width, &height);
    }
    else if (NULL != inputmode_icon)
    {
        gui_measure_image(inputmode_icon, &width, &height);
    }

    inputmode_detail = mmi_imm_get_input_mode_array_item(mmi_imm_get_curr_input_mode());

    MMI_ASSERT(inputmode_detail);

#if defined(__MMI_IME_FTE_ENHANCE__)
	#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
    if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
    {
        gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &img_width, &img_height);
        
        width += (img_width + 1);
    }
    else
    #endif
    {
        gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &img_width, &img_height);

        width += (img_width + 1);
    }    
#else
    if ((((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_MULTITAP))
        || ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_NUMBERIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_DIRECT)))
         && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_PINYIN && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_BOPOMO) 
    {
        gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &img_width, &img_height);
    
        width += (img_width + 1);
    }
	#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
    else if ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART))
    {
        gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &img_width, &img_height);
        
        width += (img_width + 1);
    }

#if defined(__MMI_ZI__)
    else if ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_PHONETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART))
    {
        gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &img_width, &img_height);
        
        width += (img_width + 1);
    }
#endif
    #endif //#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

    if (width > 0 && height > 0)
    {
    #if defined(__MMI_VUI_ENGINE__)
        if (!vadp_p2v_uc_is_in_venus())
    #endif
        {
            gdi_image_abm_get_source_layer(&old_src_layer);
            gdi_layer_get_active(&act_layer);
            gdi_image_abm_set_source_layer(act_layer);
        }    
        
        gdi_layer_lock_frame_buffer();
        gui_push_clip();
        gui_set_clip(hint_rect->x, 
                     hint_rect->y, 
                     hint_rect->x + hint_rect->width - 1, 
                     hint_rect->y + hint_rect->height - 1);

    #if !defined(__MMI_IME_FTE_ENHANCE__)
        wgui_inputs_input_information_background(hint_rect->x, 
                           hint_rect->y, 
                           hint_rect->x + hint_rect->width - 1,
                           hint_rect->y + hint_rect->height - 1);

    #if defined(__MMI_TOUCH_SCREEN__)
        gui_fill_rectangle(hint_rect->x, 
                            hint_rect->y, 
                            hint_rect->x + hint_rect->width - 1,
                            hint_rect->y + hint_rect->height - 1, 
                            g_imui_ui_theme.information_bar_background_filler->c);
    #endif
    #endif

        if (!mmi_fe_get_r2l_state())
        {
        #if defined(__MMI_IME_FTE_ENHANCE__)
            x = hint_rect->x;
        #else
        #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
            if (switch_icon != NULL)
            {
                gui_measure_image(switch_icon, &switch_icon_width, &switch_icon_height);

                x = hint_rect->x + (hint_rect->width - (width + switch_icon_width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP)) / 2;
		    }
		    else
        #endif
		    {
                x = hint_rect->x + (hint_rect->width - width) / 2;
		    }
        #endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

        #if defined(__MMI_IME_FTE_ENHANCE__)
			#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
            if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
            {
                gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &img_width, &img_height);
                
                gdi_image_draw_blend2layers(x + 1, 
                    hint_rect->y + (hint_rect->height - img_height) / 2,
                    get_image(WGUI_IME_SMART_ENGLISH_IMG));
                
                x += (img_width + 3);
            }
            else
           #endif
            {
                gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &img_width, &img_height);
                
                gdi_image_draw_blend2layers(x + 1, 
                    hint_rect->y + (hint_rect->height - img_height) / 2,
                    get_image(WGUI_INPUT_INFORMATION_ICON1));
                
                x += (img_width + 3);
            }    
        #else
            if ((((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_MULTITAP))
                || ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_NUMBERIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_DIRECT)))
    			 && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_PINYIN && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_BOPOMO) 
            {
                gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &img_width, &img_height);

                gdi_image_draw_blend2layers(x + 1, 
					hint_rect->y + (hint_rect->height - img_height) / 2,
                    get_image(WGUI_INPUT_INFORMATION_ICON1));

                x += (img_width + 3);
            }
			#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
            else if ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART))
            {
                gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &img_width, &img_height);

                gdi_image_draw_blend2layers(x + 1, 
					hint_rect->y + (hint_rect->height - img_height) / 2,
                    get_image(WGUI_IME_SMART_ENGLISH_IMG));

                x += (img_width + 3);
            }
        #if defined(__MMI_ZI__)
            else if ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_PHONETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART))
            {
                gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &img_width, &img_height);
                
                gdi_image_draw_blend2layers(x + 1, 
                    hint_rect->y + (hint_rect->height - img_height) / 2,
                    get_image(WGUI_IME_SMART_ENGLISH_IMG));
                
                x += (img_width + 3);
            }
        #endif
        #endif//#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
        #endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

            if (NULL != inputmode_string)
            {
				old_value = gdi_image_codec_get_flag(); 
				//need to set force flag due to 9slice image require force alpha blending, due to decode mechanism change
				gdi_image_codec_set_flag(GDI_IMAGE_CODEC_FLAG_FORCE_9SLICE_ALPHA_BLEND);
                mmi_imui_get_string_extent(f, inputmode_string, &width, &height);
                
            #if defined(__MMI_IME_FTE_ENHANCE__)
                gdi_image_draw_resized_blend2layers(x - 1, 
                    hint_rect->y, 
                    width + 2,
                    hint_rect->height, 
                    get_image(IMG_ID_IME_INDICATOR_BG));
            #endif
				gdi_image_codec_set_flag(old_value);
                
                gui_move_text_cursor(x, hint_rect->y + (hint_rect->height - height) / 2 + 1);
                gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);

			    gui_set_font(f);
                gui_set_text_color(c);

                gui_print_text(inputmode_string);
            
                gdi_pop_and_restore_alpha_blending_source_layer();

			    x += width;
            }
            else if (NULL != inputmode_icon)
            {
				old_value = gdi_image_codec_get_flag(); 
				//need to set force flag due to 9slice image require force alpha blending, due to decode mechanism change
				gdi_image_codec_set_flag(GDI_IMAGE_CODEC_FLAG_FORCE_9SLICE_ALPHA_BLEND);
                gui_measure_image(inputmode_icon, &width, &height);
                
            #if defined(__MMI_IME_FTE_ENHANCE__)
                gdi_image_draw_resized_blend2layers(x - 1, 
                    hint_rect->y, 
                    width + 2,
                    hint_rect->height, 
                    get_image(IMG_ID_IME_INDICATOR_BG));
            #endif
            gdi_image_codec_set_flag(old_value); 
                gdi_image_draw_blend2layers(x, 
					hint_rect->y + (hint_rect->height - height) / 2,
                    inputmode_icon);

			    x += width;
            }

        #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
            if (switch_icon != NULL)
            {
				gui_measure_image(switch_icon, &width, &height);
                gdi_image_draw_blend2layers(x + MMI_IMUI_QWERTY_SWITCH_ICON_GAP, 
					hint_rect->y + (hint_rect->height - height) / 2,
				    switch_icon);
			    
                x += (switch_icon_width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP);
            }
        #endif
        }
        else
        {
        #if defined(__MMI_IME_FTE_ENHANCE__)
            x = hint_rect->x + hint_rect->width - 1;
            #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
            if (switch_icon != NULL)
            {
                gui_measure_image(switch_icon, &switch_icon_width, &switch_icon_height);

                x = hint_rect->x + hint_rect->width - 1 - (hint_rect->width - (width + switch_icon_width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP)) / 2;
		    }
          #endif
        #else
        #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
            if (switch_icon != NULL)
            {
                gui_measure_image(switch_icon, &switch_icon_width, &switch_icon_height);

                x = hint_rect->x + hint_rect->width - 1 - (hint_rect->width - (width + switch_icon_width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP)) / 2;
		    }
		    else
        #endif
		    {
                x = hint_rect->x + hint_rect->width - 1 - (hint_rect->width - width) / 2;
		    }
        #endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */
        
        #if defined(__MMI_IME_FTE_ENHANCE__)
		#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
            if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
            {
                gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &img_width, &img_height);
                
                gdi_image_draw_blend2layers(x - 1 - img_width, 
                    hint_rect->y + (hint_rect->height - img_height) / 2,
                    get_image(WGUI_IME_SMART_ENGLISH_IMG));
                
                x -= (img_width + 3);
            }
            else
        #endif
            {
                gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &img_width, &img_height);

                gdi_image_draw_blend2layers(x - 1 - img_width, 
                    hint_rect->y + (hint_rect->height - img_height) / 2,
                    get_image(WGUI_INPUT_INFORMATION_ICON1));
                
                x -= (img_width + 3);
            }    
        #else
            if ((((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_MULTITAP))
                || ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_NUMBERIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_DIRECT)))
    			 && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_PINYIN && inputmode_detail->imm_mode_id != IMM_INPUT_MODE_QUICK_SEARCH_BOPOMO) 
            {
                gui_measure_image(get_image(WGUI_INPUT_INFORMATION_ICON1), &img_width, &img_height);

                gdi_image_draw_blend2layers(x - 1 - img_width, 
                                       hint_rect->y + (hint_rect->height - img_height) / 2,
                                       get_image(WGUI_INPUT_INFORMATION_ICON1));

                x -= (img_width + 3);
            }
			#if defined(__MMI_SMART_ALPHABETIC_INPUT_METHODS__)
            else if ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_ALPHABETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART))
            {
                gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &img_width, &img_height);

                gdi_image_draw_blend2layers(x - 1 - img_width, 
                                       hint_rect->y + (hint_rect->height - img_height) / 2,
                                       get_image(WGUI_IME_SMART_ENGLISH_IMG));

                x -= (img_width + 3);
            }
        #if defined(__MMI_ZI__)
            else if ((inputmode_detail->Lang_Special_Attrib & IME_LANG_ATTR_PHONETIC) && (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART))
            {
                gui_measure_image(get_image(WGUI_IME_SMART_ENGLISH_IMG), &img_width, &img_height);
                
                gdi_image_draw_blend2layers(x - 1 - img_width, 
                    hint_rect->y + (hint_rect->height - img_height) / 2,
                    get_image(WGUI_IME_SMART_ENGLISH_IMG));
                
                x -= (img_width + 3);
            }
        #endif
        #endif
        #endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

            if (NULL != inputmode_string)
            {
				old_value = gdi_image_codec_get_flag(); 
				//need to set force flag due to 9slice image require force alpha blending, due to decode mechanism change
				gdi_image_codec_set_flag(GDI_IMAGE_CODEC_FLAG_FORCE_9SLICE_ALPHA_BLEND);
                mmi_imui_get_string_extent(f, inputmode_string, &width, &height);
                
            #if defined(__MMI_IME_FTE_ENHANCE__)
                gdi_image_draw_resized_blend2layers(x  - width, 
                    hint_rect->y, 
                    width + 2,
                    hint_rect->height, 
                    get_image(IMG_ID_IME_INDICATOR_BG));
            #endif
                gdi_image_codec_set_flag(old_value);
                gui_move_text_cursor(x , hint_rect->y + (hint_rect->height - height) / 2 + 1);
                gdi_push_and_set_alpha_blending_source_layer((gdi_handle) gdi_act_layer);

			    gui_set_font(f);
                gui_set_text_color(c);

                gui_print_text(inputmode_string);
            
                gdi_pop_and_restore_alpha_blending_source_layer();

			    x -= width;
            }
            else if (NULL != inputmode_icon)
            {
				old_value = gdi_image_codec_get_flag(); 
				//need to set force flag due to 9slice image require force alpha blending, due to decode mechanism change
				gdi_image_codec_set_flag(GDI_IMAGE_CODEC_FLAG_FORCE_9SLICE_ALPHA_BLEND);
                gui_measure_image(inputmode_icon, &width, &height);
                
            #if defined(__MMI_IME_FTE_ENHANCE__)
                gdi_image_draw_resized_blend2layers(x  - width - 1, 
                    hint_rect->y, 
                    width + 2,
                    hint_rect->height, 
                    get_image(IMG_ID_IME_INDICATOR_BG));
            #endif
                gdi_image_codec_set_flag(old_value);
                gdi_image_draw_blend2layers(x - width, 
                                           hint_rect->y + (hint_rect->height - height) / 2,
                                           inputmode_icon);

			    x -= width;
            }

        #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
            if (switch_icon != NULL)
            {
                gdi_image_draw_blend2layers(x - MMI_IMUI_QWERTY_SWITCH_ICON_GAP - switch_icon_width, 
				    hint_rect->y + (hint_rect->height - height) / 2,
				    switch_icon);
			    
                x -= (switch_icon_width + MMI_IMUI_QWERTY_SWITCH_ICON_GAP);
            }
        #endif
        }

        gui_pop_clip();
    
        gdi_layer_unlock_frame_buffer();

    #if defined(__MMI_VUI_ENGINE__)
        if (!vadp_p2v_uc_is_in_venus())
    #endif
        {
            gdi_layer_blt_previous(hint_rect->x, 
                hint_rect->y, 
                hint_rect->x + hint_rect->width - 1, 
                               hint_rect->y + hint_rect->height - 1);
            gdi_image_abm_set_source_layer(old_src_layer);
        }
    }
}


#if defined(__MMI_IME_INDICATOR_ON_STATUS_ICON_BAR__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_create_ime_indicator
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_imui_create_ime_indicator(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/


#if defined(__MMI_VUI_ENGINE__)
    if (vadp_p2v_uc_is_in_venus())
	{
		mmi_imui_update_ui_theme(); // In Venus mmi_imui_update_ui_theme() in not called
	}
#endif

    g_imui_ime_indicator_id = wgui_status_icon_bar_create_element(0, 0, mmi_imui_draw_ime_indicator, WGUI_STATUS_ICON_BAR_ELEMENT_FLOAT|WGUI_STATUS_ICON_BAR_ELEMENT_HIDE_WITH_NCENTER);

    if (g_imui_ime_indicator_id == WGUI_STATUS_ICON_BAR_INVALID_ELEMENT_ID)
    {
        return MMI_FALSE;
    }
    else
    {
        return MMI_TRUE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_close_ime_indicator
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_imui_close_ime_indicator(void)
{
    if (g_imui_ime_indicator_id != WGUI_STATUS_ICON_BAR_INVALID_ELEMENT_ID)
    {
        wgui_status_icon_bar_close_element(g_imui_ime_indicator_id);
        
        g_imui_ime_indicator_id = WGUI_STATUS_ICON_BAR_INVALID_ELEMENT_ID;
        g_imui_indicator_width_backup = 0;
         g_imui_indicator_height_backup =0;
		 g_imui_input_mode_backup = IMM_INPUT_MODE_NONE;
		 #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
        g_mmi_imui_special_key_icon_backup = 1;
        #endif
        if (!mmi_frm_in_exit_hdlr_proc())
        {
            wgui_status_icon_bar_update();
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_update_ime_indicator
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_imui_update_ime_indicator(void)
{
    if (g_imui_ime_indicator_id != WGUI_STATUS_ICON_BAR_INVALID_ELEMENT_ID)
    {
       if(g_imui_indicator_height_backup !=MMI_status_bar_height || g_imui_indicator_width_backup !=mmi_imui_get_ime_hint_width() || g_imui_input_mode_backup != mmi_imm_get_curr_input_mode()
		   #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
		   || g_mmi_imui_special_key_icon_backup!=mmi_imm_get_special_key_icon()
			#endif
		 )
       {
        wgui_status_icon_bar_resize_element(g_imui_ime_indicator_id, (S32)mmi_imui_get_ime_hint_width(), MMI_status_bar_height);
         g_imui_indicator_height_backup = MMI_status_bar_height;
         g_imui_indicator_width_backup = mmi_imui_get_ime_hint_width();
		 g_imui_input_mode_backup = mmi_imm_get_curr_input_mode();
		 #if defined(__MMI_QWERTY_KEYPAD_SUPPORT__)
		 g_mmi_imui_special_key_icon_backup = mmi_imm_get_special_key_icon();
		#endif
        wgui_status_icon_bar_update();
    }
     
       
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_draw_ime_indicator
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_draw_ime_indicator(S32 x1, S32 y1, S32 x2, S32 y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	gdi_handle old_src_layer,act_layer;
#if !defined(__MMI_IME_FTE_ENHANCE__)
    S32 width = 0, height = 0;
#endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

#if defined(__MMI_IME_FTE_ENHANCE__)
    g_imui_ime_indicator_rect.x = x1;
    g_imui_ime_indicator_rect.y = y1;
    g_imui_ime_indicator_rect.width = x2 - x1 + 1;
	g_imui_ime_indicator_rect.height = y2 - y1 + 1;
#else
	mmi_imui_get_ime_hint_size(&width, &height);

	if (width == 0 || height == 0)
	{
		return;
	}

	g_imui_ime_indicator_rect.x = x1;
	g_imui_ime_indicator_rect.y = y1 + (y2 - y1 + 1 - height) / 2;
	g_imui_ime_indicator_rect.width = x2 - x1 + 1;
	g_imui_ime_indicator_rect.height = height;
#endif /* #if defined(__MMI_IME_FTE_ENHANCE__) */

    gdi_image_abm_get_source_layer(&old_src_layer);
    gdi_layer_get_active(&act_layer);
    gdi_image_abm_set_source_layer(act_layer);

	mmi_imui_draw_ime_hint(&g_imui_ime_indicator_rect);

    gdi_image_abm_set_source_layer(old_src_layer);
}
#endif /* #if defined(__MMI_IME_INDICATOR_ON_STATUS_ICON_BAR__) */


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_imui_parameters
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_get_imui_parameters(mmi_imui_param_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    param->imui_bottom = g_imui_ui_param.imui_bottom;
    param->imui_x = g_imui_ui_param.imui_left;
    param->imui_width = g_imui_ui_param.imui_width;
	param->imui_bottom_border = g_imui_ui_param.imui_bottom_border;
#if defined(__MMI_IME_FLOATING_CAND_BOX__)
    param->imui_floating_bottom = g_imui_ui_param.imui_floating_bottom;
    param->imui_floating_width = g_imui_ui_param.imui_floating_width;
    param->imui_floating_x = g_imui_ui_param.imui_floating_left;
#endif

}


/*****************************************************************************
 * FUNCTION
 *  mmi_imui_set_imui_parameters
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_imui_set_imui_parameters(mmi_imui_param_struct *param)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    g_imui_ui_param.imui_bottom = param->imui_bottom;
    g_imui_ui_param.imui_left = param->imui_x;
    g_imui_ui_param.imui_width = param->imui_width;
	g_imui_ui_param.imui_bottom_border = param->imui_bottom_border;
	#if defined(__MMI_IME_CANDIDATE_GRID__)
     if(mmi_imc_is_grid_state() && g_imc_enter_grid_state)
	{
		//only cand selecting state is state where there is no vk and its candidate area without icon bar/floating UI, need to move to redraw_all based on imui component
		 g_imui_ui_param.imui_bottom = UI_device_height - 1;
	}
	#endif
#if defined(__MMI_IME_FLOATING_CAND_BOX__)
    g_imui_ui_param.imui_floating_bottom = param->imui_floating_bottom;
    g_imui_ui_param.imui_floating_width = param->imui_floating_width;
    g_imui_ui_param.imui_floating_left = param->imui_floating_x;
#endif

}



/*****************************************************************************
 * FUNCTION
 *  mmi_imui_rects_overlap
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL mmi_imui_rects_overlap(mmi_imc_rect_p rect1, mmi_imc_rect_p rect2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 max_width, max_height, x1, y1, x2, y2;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    
    max_width = rect1->width + rect2->width;
    
    max_height = rect1->height + rect2->height;
    
    x1 = MIN(rect1->x, rect2->x);
    y1 = MIN(rect1->y, rect2->y);
    
    x2 = MAX(rect1->x + rect1->width - 1, rect2->x + rect2->width - 1);
    
    y2 = MAX(rect1->y + rect1->height - 1, rect2->y + rect2->height - 1);
    
    if (x2 - x1 + 1 < max_width && y2 - y1 + 1 < max_height)
    {
        return MMI_TRUE; 
    }
    else
    {
        return MMI_FALSE; 
    }
}

#ifdef __MMI_CSTAR_PHRASE_INPUT__
static mmi_imui_control_type_enum g_imui_active_control;

void mmi_imui_set_active_control(mmi_imui_control_type_enum control)
{
    g_imui_active_control = control;
}

mmi_imui_control_type_enum mmi_imui_get_active_control(void)
{
    return g_imui_active_control;
}

#define MMI_IMUI_MESSAGE_PEN_EVENT_BEGIN MMI_IMUI_MESSAGE_PEN_DOWN_IN_INFORMATION_BAR
#define MMI_IMUI_MESSAGE_PEN_EVENT_END MMI_IMUI_MESSAGE_PEN_REPEAT_IN_VIRTUAL_KEYBOARD

void mmi_imui_set_active_control_by_ui_msg(mmi_imui_message_struct_p msg_ptr)
{
    /* get this from imui! */
    mmi_imui_control_type_enum control = MMI_IMUI_CONTROL_MAX;
    
    if (msg_ptr->message_id < MMI_IMUI_MESSAGE_PEN_EVENT_BEGIN || msg_ptr->message_id > MMI_IMUI_MESSAGE_PEN_EVENT_END)
        return;
    
    switch(msg_ptr->message_id)
    {
        case MMI_IMUI_MESSAGE_PEN_DOWN_IN_CANDIDATE_BOX:
        case MMI_IMUI_MESSAGE_PEN_MOVE_IN_CANDIDATE_BOX:
        case MMI_IMUI_MESSAGE_PEN_UP_IN_CANDIDATE_BOX:
            control = MMI_IMUI_CANDIDATE_AREA;
            break;
        case MMI_IMUI_MESSAGE_PEN_DOWN_IN_COMPOSITION_BOX:
        case MMI_IMUI_MESSAGE_PEN_MOVE_IN_COMPOSITION_BOX:
        case MMI_IMUI_MESSAGE_PEN_UP_IN_COMPOSITION_BOX:                
            control = MMI_IMUI_COMPOSITION_AREA;
            break;
        case MMI_IMUI_MESSAGE_PEN_DOWN_IN_INFORMATION_BAR:
        case MMI_IMUI_MESSAGE_PEN_MOVE_IN_INFORMATION_BAR:
        case MMI_IMUI_MESSAGE_PEN_UP_IN_INFORMATION_BAR:                
            control = MMI_IMUI_INFORMATION_BAR;
            break;
        case MMI_IMUI_MESSAGE_PEN_DOWN_IN_VIRTUAL_KEYBOARD:
        case MMI_IMUI_MESSAGE_PEN_UP_IN_VIRTUAL_KEYBOARD:
        case MMI_IMUI_MESSAGE_PEN_MOVE_IN_VIRTUAL_KEYBOARD:      
        case MMI_IMUI_MESSAGE_PEN_LONGTAP_IN_VIRTUAL_KEYBOARD:
        case MMI_IMUI_MESSAGE_PEN_ABORT_IN_VIRTUAL_KEYBOARD:
        case MMI_IMUI_MESSAGE_PEN_REPEAT_IN_VIRTUAL_KEYBOARD:
            control = MMI_IMUI_VIRTUAL_KEYBOARD;
            break;
        case MMI_IMUI_MESSAGE_PEN_DOWN_IN_IME_HINT:
        case MMI_IMUI_MESSAGE_PEN_UP_IN_IME_HINT:
        case MMI_IMUI_MESSAGE_PEN_MOVE_IN_IME_HINT:
            control = MMI_IMUI_IME_HINT_AREA;
            break;    
    }
    mmi_imui_set_active_control(control);
}
#endif



/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_inputmode_string
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
UI_string_type mmi_imui_get_inputmode_string(MMI_BOOL *is_smart)
{
	  /*----------------------------------------------------------------*/
      /* Local Variables                                                */
      /*----------------------------------------------------------------*/
      mmi_imm_input_mode_info_struct_p hint_info = NULL;
	  UI_string_type inputmode_string = NULL;
	  mmi_imm_input_mode_hint_item_struct_p hint_item = NULL;
	  const sIMEModeDetails * inputmode_detail = NULL;
	  *is_smart = MMI_FALSE;
      /*----------------------------------------------------------------*/
      /* Code Body                                                      */
      /*----------------------------------------------------------------*/
	  hint_info = (mmi_imm_input_mode_info_struct_p)mmi_imm_get_curr_input_mode_hint_info();
	  if (hint_info == NULL)
      {
		 return NULL;
      }
     hint_item = hint_info->hint_item_ptr;
	 inputmode_detail = mmi_imm_get_input_mode_array_item(mmi_imm_get_curr_input_mode());
	 if (inputmode_detail->Mode_Special_Attrib & IME_MODE_ATTR_SMART)
	 {
			*is_smart = MMI_TRUE;
	 }
	 if (hint_item->hint_type == MMI_IME_HINT_TYPE_STRING)
     {
            inputmode_string = (UI_string_type)get_string(hint_item->hint_id);
			
			//printf("String = %s\n", inputmode_string);
			return inputmode_string;
     }
	 else if(hint_item->hint_type == MMI_IME_HINT_TYPE_IMAGE) 
	 {
		 
	 		if(inputmode_detail->imm_mode_id == IMM_INPUT_MODE_SM_PINYIN)
			{
                inputmode_string = (UI_string_type)get_string(STR_ID_INPUT_MODE_PINYIN);
			}
			else if (inputmode_detail->imm_mode_id == IMM_INPUT_MODE_SM_STROKE)
			{
				inputmode_string = (UI_string_type)get_string(STR_ID_INPUT_MODE_BIHUA);
			}
		    //IMM_INPUT_MODE_TR_STROKE
		    //to do item for image type(pinyin/bopomo) etc
			//IMM_INPUT_MODE_TR_MULTITAP_BOPOMO
			return inputmode_string;
	 }
	 else
	 {
             return NULL;
	 }
}


#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_check_ui_cover_ime_indicator
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
static MMI_BOOL mmi_imui_check_ui_cover_ime_indicator(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_imc_rect_p indicator_rect = NULL;
    mmi_imc_point point;
    mmi_imc_rect cursor_rect;
    MMI_BOOL is_covered_with_vk = MMI_FALSE;
    mmi_imc_message_struct imc_message;
    S32 no_of_control_set = 0;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    imc_message.message_id = MMI_IMC_MESSAGE_GET_CURSOR_RECT; 
    imc_message.param_0 = (U32)&cursor_rect;
    imc_message.param_1 = 0;
    mmi_imc_send_message(&imc_message); 

    indicator_rect = &g_imui_indicator_rect_floating;

    indicator_rect->x = cursor_rect.x;
    indicator_rect->y = cursor_rect.y + cursor_rect.height + MMI_IMUI_FLOATING_INDICATOR_BOTTOM_GAP;
    indicator_rect->width =  MMI_IMUI_FLOATING_INDICATOR_WIDTH;
    indicator_rect->height =  MMI_IMUI_FLOATING_INDICATOR_HEIGHT;

    if(g_imui_ui_param.imui_left + g_imui_ui_param.imui_width - 1 < indicator_rect->x + indicator_rect->width)
    {
        indicator_rect->x -= (indicator_rect->x + indicator_rect->width - g_imui_ui_param.imui_left - g_imui_ui_param.imui_width);
    } 

#if defined(__MMI_IME_FTE_ENHANCE__)
#if defined(__MMI_VIRTUAL_KEYBOARD__)
    for(; no_of_control_set < g_imui_control_set.number_of_controls; no_of_control_set++)
    {
        if (g_imui_control_set.control_set[no_of_control_set] == MMI_IMUI_VIRTUAL_KEYBOARD)
        {
            if (g_imui_control_set.showed_flag & MMI_IMUI_CONTROL_MASK(MMI_IMUI_VIRTUAL_KEYBOARD))
            {
                is_covered_with_vk = (MMI_BOOL) PEN_CHECK_BOUND(
                    indicator_rect->x,
                    indicator_rect->y + indicator_rect->height,
                    g_imui_ui_param.imui_left,
                    g_imui_ui_param.imui_bottom - g_wgui_virtual_keyboard.height,
                    g_imui_ui_param.imui_width,
                    g_wgui_virtual_keyboard.height);   
            }
        }
    }
    if (is_covered_with_vk)
    {
        indicator_rect->y = cursor_rect.y - indicator_rect->height - MMI_IMUI_FLOATING_INDICATOR_BOTTOM_GAP;
    }
#endif
#endif

    point.x = indicator_rect->x;
    point.y = indicator_rect->y;

    if (mmi_imui_check_ui_contain_point(&point))
    {
        return MMI_TRUE;
    }

    point.x = indicator_rect->x;
    point.y = indicator_rect->y + indicator_rect->height - 1;

    if (mmi_imui_check_ui_contain_point(&point))
    {
        return MMI_TRUE;
    }

    point.x = indicator_rect->x + indicator_rect->width - 1;
    point.y = indicator_rect->y;

    if (mmi_imui_check_ui_contain_point(&point))
    {
        return MMI_TRUE;
    }

    point.x = indicator_rect->x + indicator_rect->width - 1;
    point.y = indicator_rect->y + indicator_rect->height - 1;

    if (mmi_imui_check_ui_contain_point(&point))
    {
        return MMI_TRUE;
    }

    return MMI_FALSE;
}
#endif /*#if defined(MMI_IMUI_FLOATING_IME_INDICATOR_UI_STYLE)*/


#if defined(__MMI_IME_V3__) && !defined(__NO_HANDWRITING__)
/*****************************************************************************
 * FUNCTION
 *  mmi_imui_get_handwriting_area
 * DESCRIPTION
 * PARAMETERS
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_imui_get_handwriting_area(mmi_pen_handwriting_area_struct *rect)
{
    if(mmi_imc_is_rotated())
    {
        rect->x1 = MMI_IMUI_SINGLE_BLOCK_X_ROTATED;
        rect->y1 = MMI_IMUI_SINGLE_BLOCK_Y_ROTATED;
        rect->x2 = MMI_IMUI_SINGLE_BLOCK_X_ROTATED + MMI_IMUI_SINGLE_BLOCK_WIDTH_ROTATED - 1;
        rect->y2 = MMI_IMUI_SINGLE_BLOCK_Y_ROTATED + MMI_IMUI_SINGLE_BLOCK_HEIGHT_ROTATED - 1;
    }
    else
    {
        rect->x1 = MMI_IMUI_SINGLE_BLOCK_X;
        rect->y1 = MMI_IMUI_SINGLE_BLOCK_Y;
        rect->x2 = MMI_IMUI_SINGLE_BLOCK_X + MMI_IMUI_SINGLE_BLOCK_WIDTH - 1;
        rect->y2 = MMI_IMUI_SINGLE_BLOCK_Y + MMI_IMUI_SINGLE_BLOCK_HEIGHT - 1;
    }
}
#endif
